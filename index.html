<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Farm LOL - Pet Daily Reward</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root { 
    /* Palette m√†u t∆∞∆°i s√°ng */
    --bg-gradient: linear-gradient(180deg, #a1ffce 0%, #faffd1 100%);
    --primary: #4CAF50; 
    --primary-dark: #388E3C;
    --accent: #FF9800;
    --accent-dark: #F57C00;
    --text-main: #3e2723;
    --text-muted: #795548;
    
    /* UI Variables */
    --card-bg: rgba(255, 255, 255, 0.95);
    --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
    --btn-shadow: 0 4px 0px;
    --radius-lg: 20px;
    --radius-md: 12px;
    --radius-sm: 8px;
    
    /* Dark Mode Palette */
    --dark-bg-gradient: linear-gradient(180deg, #1a237e 0%, #311b92 100%);
    --dark-card-bg: rgba(30, 30, 40, 0.95);
    --dark-text: #e0e0e0;
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; 
    font-family: 'Fredoka', sans-serif; 
    background: #333; 
    color: var(--text-main); 
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    overflow: hidden;
    transition: background 0.3s;
  }

  /* --- APP CONTAINER (FIXED RATIO SCALING) --- */
  .app-wrapper {
    width: 400px; 
    height: 750px; 
    background: var(--bg-gradient);
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 50px rgba(0,0,0,0.5); 
    position: relative; 
    text-align: left; 
    
    /* Quan tr·ªçng cho vi·ªác Scale */
    transform-origin: top center; 
    transform: scale(1); 
    transition: transform 0.1s ease-out, background 0.3s;
    flex-shrink: 0;
    overflow: hidden; /* C·∫Øt ph·∫ßn th·ª´a n·∫øu c√≥ */
  }

  /* --- DARK MODE --- */
  body.dark-mode .app-wrapper {
    background: var(--dark-bg-gradient);
    color: var(--dark-text);
  }
  body.dark-mode .card-panel, 
  body.dark-mode #shop-box, 
  body.dark-mode #online-box, 
  body.dark-mode #pet-house-box, 
  body.dark-mode #interaction-popup, 
  body.dark-mode #seed-box {
      background: var(--dark-card-bg);
      color: var(--dark-text);
      border: 1px solid rgba(255,255,255,0.1);
  }

  /* --- MENU TOGGLE BTN --- */
  #menu-btn {
      position: absolute;
      top: 15px; left: 15px;
      width: 46px; height: 46px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-dark);
      font-size: 20px;
      cursor: pointer;
      z-index: 101; 
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  #menu-btn:active { transform: scale(0.9); }
  body.dark-mode #menu-btn { background: #311b92; color: white; border-color: #5c6bc0; }

  /* --- HEADER --- */
  header { 
      position: absolute;
      top: 15px; 
      left: 70px; 
      right: 15px;
      display: flex; 
      flex-direction: column; 
      align-items: center;    
      padding: 8px 15px; 
      background: rgba(255, 255, 255, 0.65); 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 20px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      z-index: 100; 
      border: 1px solid rgba(255,255,255,0.4);
      
      /* Animation */
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      transform-origin: left center;
      opacity: 1;
      transform: scaleX(1);
  }

  header.collapsed {
      opacity: 0;
      transform: scaleX(0) translateX(-20px);
      pointer-events: none;
  }

  .dark-mode header {
      background: rgba(20, 20, 30, 0.7);
      border-color: rgba(255,255,255,0.1);
      color: white;
  }

  .brand {
      display: flex; 
      flex-direction: column; 
      align-items: center;
      width: 100%;
      cursor: pointer;
      margin-bottom: 5px;
  }
  
  #player-level-display {
      font-size: 15px; font-weight: 700; color: var(--primary-dark);
      text-shadow: 0 1px 0 rgba(255,255,255,0.5);
  }
  .dark-mode #player-level-display { color: #81c784; text-shadow: none; }

  /* EXP BAR */
  #exp-bar-container {
      width: 120px; 
      height: 6px; 
      background: rgba(0,0,0,0.1); 
      border-radius: 10px; margin-top: 4px; overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
  }
  #exp-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #66bb6a, #43a047);
      border-radius: 10px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* --- BUTTONS --- */
  button { font-family: 'Fredoka', sans-serif; }
  
  .controls { 
      display: flex; 
      flex-wrap: nowrap; 
      justify-content: center;
      width: 100%;
      gap: 6px;
  } 
  
  .controls button {
      font-size: 10px; font-weight: 700;
      padding: 5px 10px;
      margin: 0;
      border: none; border-radius: 20px;
      cursor: pointer;
      color: white;
      text-transform: uppercase;
      transition: transform 0.1s;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      white-space: nowrap;
  }
  
  .controls button:active { transform: translateY(2px); box-shadow: none; }

  #btn-new { background: #29b6f6; box-shadow: 0 2px 0 #0288d1; }
  #btn-save { background: #66bb6a; box-shadow: 0 2px 0 #388e3c; }
  #btn-delete { background: #ef5350; box-shadow: 0 2px 0 #d32f2f; }
  
  button:disabled { background: #bdbdbd !important; box-shadow: none !important; color: #757575 !important; cursor: not-allowed; transform: none !important; }

  /* --- MAIN GAME AREA --- */
  main { 
        flex: 1; display:flex; justify-content:center; 
        align-items:flex-start; 
        padding:0; 
        overflow: hidden;
        position: relative;
  }
  
  #beanstalk-bg {
    position: absolute; 
    top: 0; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 100%; 
    height: 100%;
    z-index: 3; 
    object-fit: cover;
  }

  /* UI Game Object Animations */
  @keyframes float { 0% { transform: translate(-50%, 0px); } 50% { transform: translate(-50%, -10px); } 100% { transform: translate(-50%, 0px); } }
  
  /* --- ANIMATION TH·ªû CHO PET (SQUASH & STRETCH) --- */
  @keyframes pet-breathing {
      0%, 100% { 
          /* Tr·∫°ng th√°i b√¨nh th∆∞·ªùng */
          transform: scale(1, 1); 
      }
      50% { 
          /* Hi·ªáu ·ª©ng x·∫πp ph·ªìng: B√® ngang (1.06) v√† th·∫•p xu·ªëng (0.94) */
          transform: scale(1.06, 0.94); 
      } 
  }

  /* --- ANIMATION THI√äN TH·∫¶N / TH·∫¶N CH·∫æT BAY THU HO·∫†CH --- */
  @keyframes angel-fly-harvest {
      0% { transform: translateX(0) scaleX(1); }
      45% { transform: translateX(340px) scaleX(1); } /* Bay sang ph·∫£i */
      50% { transform: translateX(340px) scaleX(-1); } /* Quay ƒë·∫ßu */
      95% { transform: translateX(0) scaleX(-1); } /* Bay v·ªÅ */
      100% { transform: translateX(0) scaleX(1); } /* Quay l·∫°i */
  }

  .angel-harvesting {
      animation: angel-fly-harvest 2s ease-in-out forwards;
      z-index: 100 !important;
      position: relative; 
  }

  /* --- CLASS M·ªöI ƒê·ªÇ K√çCH HO·∫†T HI·ªÜU ·ª®NG TH·ªû --- */
  .pet-breathing-effect {
      animation: pet-breathing 2s ease-in-out infinite;
  }

  #kinto-cloud {
      position: absolute; top: 30px; left: calc(60% + 15px); transform: translateX(-50%); 
      width: 30px; height: 30px; z-index: 10; cursor: pointer; 
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
  }
  
  #light-bulb {
      position: absolute; 
      top: 15px; 
      left: calc(30% - 10px); 
      transform: translateX(-50%);
      z-index: 8; 
      cursor: pointer; 
      width: 60px; 
      height: auto;
      filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
  }

  #pet-house {
      position: absolute; bottom: 210px; left: 50%; transform: translateX(calc(-50% + 100px)); 
      width: 150px; height: auto; z-index: 7; cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #chaos-blacksmith {
      position: absolute; bottom: 260px; left: 50%; transform: translateX(calc(-50% - 130px));
      width: 90px; height: auto; z-index: 7; cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #chaos-blacksmith-working {
      position: absolute; 
      bottom: 270px; 
      left: 50%; 
      transform: translateX(calc(-50% - 130px));
      width: 60px; 
      height: auto; 
      z-index: 7; 
      cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }
  
  #pug-pet {
      position: absolute; 
      bottom: 35px; 
      left: 50%; 
      transform: translateX(calc(-50% - 50px)); 
      width: 120px; 
      height: auto; 
      z-index: 7; 
      cursor: pointer;
      transform-origin: bottom center; 
      will-change: transform;
  }
  
  #bone-bowl {
      position: absolute; bottom: 130px; left: 50%; transform: translateX(calc(-50% + 110px)); 
      width: 50px; height: auto; z-index: 7; cursor: pointer; 
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #pot-container {
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 100%; height: 100%; z-index: 5; display: flex; justify-content: center; pointer-events: none; 
  }

  .pot-slot {
      position: absolute; width: 50px; height: 50px; background: transparent; border: none; 
      display: flex; align-items: center; justify-content: center; 
      cursor: pointer; transition: transform 0.1s; pointer-events: auto; 
  }
  .pot-slot:hover { transform: scale(1.1); filter: brightness(1.1); }
  .pot-slot:active { transform: scale(0.95); }

  .pot-slot img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
  }
  
  .pot-base-img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
      transition: opacity 0.3s;
  }

  /* --- SLOT POSITIONS --- */
  #slot-1 { width: 50px; height: 50px; top: 140px; left: calc(50% - 160px); }
  #slot-1 img { width: 120%; height: 120%; top: -10px; left: -10px; }
  
  #slot-6 { width: 50px; height: 35px; top: 335px; left: calc(50% - 30px + 10px + 15px); }
  #slot-6 img { width: 130%; height: 130%; top: -15px; left: -10px; }
  
  #slot-2, #slot-3, #slot-4, #slot-5, #slot-7 { width: 35px; height: 35px; }
  #slot-2 img, #slot-3 img, #slot-4 img, #slot-5 img, #slot-7 img { width: 130%; height: 130%; top: -5px; left: -5px; }
  
  .seed-image {
      width: 140% !important; 
      height: auto !important; 
      max-height: 120px !important; 
      object-fit: contain; 
      position: absolute; 
      bottom: 27px !important;  
      top: auto !important;     
      left: 50% !important;
      transform: translateX(-50%) !important; 
      z-index: 6;
      pointer-events: none;
      transition: all 0.3s ease; 
  }

  /* --- V·ªä TR√ç C√ÅC √î ƒê·∫§T --- */
  #slot-2 { top: 155px; left: calc(50% - 90px - 10px); }
  #slot-3 { top: 155px; left: calc(50% - 30px - 10px); } 
  #slot-4 { top: 155px; left: calc(50% + 30px - 10px); }
  #slot-5 { top: 155px; left: calc(50% + 90px - 10px); }
  #slot-7 { top: 155px; left: calc(50% + 150px - 10px); }


  /* --- POPUPS (MODALS) --- */
  .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); backdrop-filter: blur(3px);
      z-index: 990; display: none;
  }

  #shop-box, #online-box, #pet-house-box, #interaction-popup, #seed-box, #name-box { 
    position: fixed; top: 50%; left: 50%; 
    transform: translate(-50%, -50%) scale(0.9); 
    background: var(--card-bg);
    width: 90%; max-width: 320px;
    padding: 20px; 
    border-radius: var(--radius-lg); 
    box-shadow: var(--card-shadow); 
    z-index: 1000; 
    text-align: center; 
    border: 4px solid white;
    opacity: 0; pointer-events: none; 
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .popup-active {
      transform: translate(-50%, -50%) scale(1) !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      display: block !important;
  }

  h3 { 
      margin: 0 0 15px 0; color: var(--primary-dark); font-size: 1.2em; 
      text-transform: uppercase; letter-spacing: 1px;
  }
  .dark-mode h3 { color: #81c784; }

  hr { border: 0; border-top: 2px dashed #ddd; margin: 15px 0; }

  .btn-close, button[onclick*="none"] {
      margin-top: 15px;
      padding: 8px 25px;
      background: #f44336;
      color: white;
      border: none; border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 3px 0 #d32f2f;
      cursor: pointer;
      width: 100%;
      font-size: 0.9em;
  }
  .btn-close:active, button[onclick*="none"]:active { transform: translateY(4px); box-shadow: none; }

  /* --- SHOP ITEMS (GRID) --- */
  .shop-item, .pet-shop-item {
      background: white;
      border: 1px solid #eee;
      border-radius: var(--radius-md);
      padding: 10px;
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;
  }
  .dark-mode .shop-item, .dark-mode .pet-shop-item { background: #2c2c35; border-color: #444; }

  .shop-item:hover, .pet-shop-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

  .btn-buy, .btn-buy-pet, .btn-plant-now, .btn-equip-pot, .btn-crafting {
      width: 100%; border: none; border-radius: 8px;
      padding: 6px; margin-top: 8px;
      font-weight: 700; font-size: 11px;
      color: white; cursor: pointer;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      transition: all 0.1s;
  }
  .btn-buy:active, .btn-plant-now:active { transform: translateY(2px); box-shadow: none; }
  
  .btn-buy, .btn-plant-now { background: var(--accent); box-shadow: 0 2px 0 var(--accent-dark); }
  /* Override btn-plant-now specific color if needed, but keeping accent is fine */

  /* --- TABS --- */
  .tab-container {
      background: #f5f5f5; padding: 4px; border-radius: 12px;
      display: flex; gap: 5px; margin-bottom: 15px; border: none;
  }
  .dark-mode .tab-container { background: #2a2a35; }

  .tab-btn {
      flex: 1; padding: 8px; border-radius: 8px; border: none;
      background: transparent; color: #777; font-weight: 600; font-size: 0.9em;
      transition: all 0.2s; cursor: pointer;
  }
  .tab-btn.active {
      background: white; color: var(--primary);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .dark-mode .tab-btn.active { background: #4caf50; color: white; }

  /* --- BLACKSMITH TABLE --- */
  .blacksmith-table { display: block; width: 100%; }
  .blacksmith-table thead { display: none; } 
  .blacksmith-table tbody { display: flex; flex-direction: column; gap: 10px; }
  .blacksmith-table tr {
      display: flex; align-items: center; justify-content: space-between;
      background: #fff; padding: 8px; border-radius: 12px;
      border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .dark-mode .blacksmith-table tr { background: #2c2c35; border-color: #444; }

  .blacksmith-table td { border: none !important; padding: 0 5px !important; display: block; }
  
  .blacksmith-table td:first-child { flex: 1; }
  .blacksmith-recipe { display: flex; align-items: center; gap: 10px; }
  
  .blacksmith-table td:nth-child(2) { flex: 2; font-size: 0.8em; }
  
  .blacksmith-table td:last-child { flex: 1; text-align: right; }

  .req-status-ok { color: var(--primary); font-weight: 700; }
  .req-status-fail { color: #f44336; }

  /* --- INPUT NAME BOX --- */
  #name-box input {
      width: 100%; padding: 10px; margin: 15px 0;
      border: 2px solid #ddd; border-radius: 10px;
      font-family: inherit; font-size: 14px; text-align: center;
      outline: none; transition: border 0.3s;
  }
  #name-box input:focus { border-color: var(--primary); }
  #btn-next {
      background: var(--primary); color: white;
      padding: 10px 30px; border-radius: 30px;
      font-size: 14px; font-weight: bold; border: none;
      box-shadow: 0 3px 0 var(--primary-dark);
  }
  #btn-next:active { transform: translateY(3px); box-shadow: none; }

  /* --- SCROLLBAR --- */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: #aaa; }

    /* --- CSS CHO C√ÇY TO --- */
  .seed-image.big-plant {
      width: 220% !important;        
      max-height: 250px !important;  
      bottom: 27px !important;       
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); 
      z-index: 10;                   
  }

  /* --- CSS CHO QU√Ä T·∫∂NG H√ÄNG NG√ÄY (Daily Reward) --- */
  .daily-reward-bubble {
    position: absolute;
    width: 60px; /* K√≠ch th∆∞·ªõc ·∫£nh qu·∫£ ƒë√†o */
    height: 60px;
    z-index: 90; /* Cao h∆°n pet, th·∫•p h∆°n popup */
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: popInReward 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); /* Hi·ªáu ·ª©ng ph√°t s√°ng nh·∫π */
}

/* Hi·ªáu ·ª©ng xu·∫•t hi·ªán */
@keyframes popInReward {
    0% { transform: scale(0) translateY(20px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

/* Hi·ªáu ·ª©ng bay l√™n khi nh·∫≠n xong */
@keyframes flyUpReward {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
}
/* --- CSS CHO ICON ·∫§P TR·ª®NG (ü¶¢) --- */
  #incubator-icon {
      position: absolute;
      
      /* CƒÉn ch·ªânh v·ªã tr√≠: ƒê·∫∑t l·∫°i top cho ph√π h·ª£p v·ªõi k√≠ch th∆∞·ªõc m·ªõi */
      top: -18px;                   /* ƒê√£ s·ª≠a: ƒê·∫©y th·∫•p xu·ªëng m·ªôt ch√∫t cho g·∫ßn tr·ª©ng h∆°n (c≈© l√† -35px) */
      left: 40%;
      transform: translateX(-50%);  /* CƒÉn gi·ªØa ngang */
      
      /* Giao di·ªán: K√≠ch th∆∞·ªõc nh·ªè l·∫°i */
      font-size: 10px;              /* ƒê√£ s·ª≠a: Nh·ªè l·∫°i (c≈© l√† 40px) */
      z-index: 20;
      
      /* Hi·ªáu ·ª©ng: C·ªë ƒë·ªãnh (B·ªè animation float) */
      /* animation: float 2s ease-in-out infinite; */ /* <-- ƒê√£ comment d√≤ng n√†y ƒë·ªÉ t·∫Øt hi·ªáu ·ª©ng bay */
      
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
      pointer-events: none;
  }
</style>
</head>
<body>
<div class="modal-overlay" id="global-overlay"></div> 

<div class="app-wrapper"> 

<button id="menu-btn" onclick="toggleHeader()">‚óÄ</button>

<header id="main-header">
  <div class="brand">
    <div id="player-level-display">üåæ Farm LOL üåæ</div>
    <div id="exp-bar-container">
        <div id="exp-fill"></div>
    </div>
  </div>
  <div class="controls">
    <button id="btn-new">üÜï T·∫°o</button>
    <button id="btn-save" disabled>üíæ L∆∞u</button>
    <button id="btn-delete" disabled>üóëÔ∏è Xo√°</button>
  </div>
</header>

<main>
  <img id="beanstalk-bg" src="1000000105.png" alt="Khu v∆∞·ªùn b√™n h·ªì" />
  
  <img id="light-bulb" src="1000000123.gif" alt="B√≥ng ƒë√®n" />
  
  <div id="pot-container">
        <div class="pot-slot" id="slot-1" data-slot="1">
        <img id="ice-egg-img" src="" alt="Tr·ª©ng Ng≈© S·∫Øc" style="display:none;" />
        
        <div id="incubator-icon" style="display:none;">ü¶¢</div>
    </div>
    
    <div class="pot-slot" id="slot-2" data-slot="2">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" /> 
        <img id="seed-img-2" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-3" data-slot="3">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-3" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-6" data-slot="6">
        <img src="1000000116.gif" alt="Em b√© c√¢u c√°" />
    </div>
    
    <div class="pot-slot" id="slot-4" data-slot="4">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-4" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-5" data-slot="5">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-5" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-7" data-slot="7">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-7" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    
  </div>
  
  <img id="kinto-cloud" src="1000000103.png" alt="C√¢n ƒê·∫©u V√¢n" data-slot="0" />
  <img id="pet-house" src="1000000100.png" alt="Nh√† Pet" />
  
  <img id="chaos-blacksmith" src="1000000107.png" alt="Th·ª£ R√®n Chaos" />
  <img id="chaos-blacksmith-working" src="1000000101.gif" alt="Th·ª£ R√®n ƒêang L√†m" style="display:none;" />
  
  <img id="pug-pet" src="" alt="Ch√∫ ch√≥ Pug" style="display:none;" />
  <img id="bone-bowl" src="1000000115.png" alt="B√°t ƒë·ª±ng x∆∞∆°ng" />
</main>

</div> 

<div id="name-box" style="display:none;">
    <h3>Xin ch√†o n√¥ng d√¢n!</h3>
    <p style="color:var(--text-muted);">H√£y ƒë·∫∑t m·ªôt c√°i t√™n th·∫≠t ng·∫ßu nh√©:</p>
    <input type="text" id="player-name" placeholder="V√≠ d·ª•: Alice" maxlength="12"/>
    <button id="btn-next">B·∫Øt ƒë·∫ßu ngay &rarr;</button>
</div>

<div id="shop-box">
  <h3>‚òÅÔ∏è Shop M√¢y</h3> 
  <div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
    <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-shop">0</b> &nbsp;|&nbsp; 
    <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-shop">0</b>
  </div>
  
  <div id="shop-tab-container-wrapper"></div>
  
  <button onclick="hidePopup('shop-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="seed-box">
<h3>üå± Shop H·∫°t Gi·ªëng</h3> 
<div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
  <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-seed">0</b> &nbsp;|&nbsp; 
  <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-seed">0</b>
</div>

<div id="seed-items" style="display:grid; grid-template-columns: 1fr; gap:10px; max-height: 400px; overflow-y: auto;"></div>
<button onclick="hidePopup('seed-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="online-box">
<h3>üåê Online</h3>
<div style="margin:20px 0; color: #777;">Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...<br>Quay l·∫°i sau nh√©!</div>
<button onclick="hidePopup('online-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="pet-house-box">
  <h3 id="pet-house-title">üêæ Nh√† Pet</h3> 
  <div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
      <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-pet">0</b> &nbsp;|&nbsp; 
      <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-pet">0</b>
  </div>
  <div id="pet-shop-items"></div>
  <button onclick="hidePopup('pet-house-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="interaction-popup">
    <h3 id="interaction-title"></h3> 
    <div id="interaction-text" style="min-height: 50px; font-size: 0.95em; line-height: 1.5;"></div>
    <div id="interaction-controls" style="margin-top: 15px;"></div>
    <button onclick="closeInteractionPopup()" class="btn-close" style="margin-top: 20px;">ƒê√≥ng</button>
</div>

<script>
// --- LOGIC SCALING (GI·ªÆ NGUY√äN) ---
function adjustAppWrapperScale() {
    const appWrapper = document.querySelector(".app-wrapper");
    if (!appWrapper) return;
    const designWidth = 400; const designHeight = 750; 
    const viewportWidth = window.innerWidth; const viewportHeight = window.innerHeight;
    
    const scaleX = viewportWidth / designWidth; 
    const scaleY = viewportHeight / designHeight;
    let scale = Math.min(scaleX, scaleY);
    const MAX_SCALE = 1.1; 
    scale = Math.min(scale, MAX_SCALE);
    
    appWrapper.style.transform = `scale(${scale})`;
    
    if (viewportHeight > designHeight * scale) { 
        const scaledHeight = designHeight * scale;
        const marginTop = (viewportHeight - scaledHeight) / 2;
        appWrapper.style.marginTop = `${marginTop}px`; appWrapper.style.marginBottom = `${marginTop}px`;
    } else { appWrapper.style.marginTop = '0'; appWrapper.style.marginBottom = '0'; }
}
window.addEventListener('resize', adjustAppWrapperScale);

function toggleHeader() {
    const header = document.getElementById('main-header');
    const btn = document.getElementById('menu-btn');
    header.classList.toggle('collapsed');
    if (header.classList.contains('collapsed')) { btn.innerHTML = '‚öôÔ∏è'; } else { btn.innerHTML = '‚óÄ'; }
}

let playerName = "N√¥ng d√¢n";
let farmIcon = "üåæ";
let level = 0;
let exp = 0;
let dau = 0; 
let la = 0;  
let tool = { name: "X·∫ªng G·ªó", power: 1, maxHP: 100, currentHP: 100 };
let hasIceEgg = false; 
let isIceDragonHatched = false; 
let isIceDragonEvolved = false; 
let hatchedPetType = "thien_than"; // BI·∫æN M·ªöI: L∆ØU LO·∫†I PET ƒê√É ·∫§P (thien_than HO·∫∂C than_chet)
let activePet = null;
let incubationFinishTime = 0; // Th·ªùi gian k·∫øt th√∫c ·∫•p tr·ª©ng
let ownedPets = []; 
let ownedSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0 }; 
let globalPetAge = 0; 
let lastFedTime = 0; 
let activePopupInterval = null;

// --- 1. C·∫¨P NH·∫¨T DANH S√ÅCH CH·∫¨U ---
let ownedPots = { 
    'so_dua': 0, 'chau_dong': 0, 
    'chau_bac': 0, 'chau_vang': 0, 
    'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 
}; 
let craftingQueue = []; 

const POT_DEFINITIONS = {
    'so_dua': { name: "S·ªç D·ª´a", img: "1000000112.png", expBonus: 0 },
    'chau_dong': { name: "Ch·∫≠u ƒê·ªìng", img: "1000000117.png", expBonus: 1 },
    'chau_bac': { name: "Ch·∫≠u B·∫°c", img: "1000000118.png", expBonus: 2 },
    'chau_vang': { name: "Ch·∫≠u V√†ng", img: "1000000119.png", expBonus: 3 },
    'chau_bach_kim': { name: "Ch·∫≠u B·∫°ch Kim", img: "1000000120.png", expBonus: 4 },
    'chau_kim_cuong': { name: "Ch·∫≠u Kim C∆∞∆°ng", img: "1000000121.png", expBonus: 5 },
    'chau_kim_cuong_do': { name: "Ch·∫≠u K.C∆∞∆°ng ƒê·ªè", img: "1000000122.png", expBonus: 6 }
};

// --- 2. C·∫¨P NH·∫¨T C√îNG TH·ª®C R√àN (ƒê√É CH·ªàNH S·ª¨A) ---
const CRAFTING_RECIPES = [
    {
        id: 'craft_so_dua',
        output: 'so_dua',
        name: 'S·ªç D·ª´a',
        icon: '1000000112.png',
        duration: 0,
        cost: { dau: 1000 }, // Gi√° m·ªõi: 1000 ƒê·∫≠u
        materials: {} 
    },
    {
        id: 'craft_chau_dong',
        output: 'chau_dong',
        name: 'Ch·∫≠u ƒê·ªìng',
        icon: '1000000117.png',
        duration: 2 * 60 * 60 * 1000, // 2 gi·ªù
        cost: { dau: 2000 },
        materials: { 'so_dua': 1, 'hat_kim_loai': 20 }
    },
    {
        id: 'craft_chau_bac',
        output: 'chau_bac',
        name: 'Ch·∫≠u B·∫°c',
        icon: '1000000118.png',
        duration: 3 * 60 * 60 * 1000, // 3 gi·ªù
        cost: { dau: 3000 },
        materials: { 'chau_dong': 1, 'hat_kim_loai': 30 }
    },
    {
        id: 'craft_chau_vang',
        output: 'chau_vang',
        name: 'Ch·∫≠u V√†ng',
        icon: '1000000119.png',
        duration: 4 * 60 * 60 * 1000, // 4 gi·ªù
        cost: { dau: 4000 },
        materials: { 'chau_bac': 1, 'hat_kim_loai': 40 }
    },
    {
        id: 'craft_chau_bach_kim',
        output: 'chau_bach_kim',
        name: 'Ch·∫≠u B·∫°ch Kim',
        icon: '1000000120.png',
        duration: 5 * 60 * 60 * 1000, // 5 gi·ªù
        cost: { dau: 5000 },
        materials: { 'chau_vang': 1, 'hat_kim_loai': 50 }
    },
    {
        id: 'craft_chau_kim_cuong',
        output: 'chau_kim_cuong',
        name: 'Ch·∫≠u Kim C∆∞∆°ng',
        icon: '1000000121.png',
        duration: 6 * 60 * 60 * 1000, // 6 gi·ªù
        cost: { dau: 6000 },
        materials: { 'chau_bach_kim': 1, 'hat_kim_loai': 60 }
    },
    {
        id: 'craft_chau_kim_cuong_do',
        output: 'chau_kim_cuong_do',
        name: 'Ch·∫≠u K.C∆∞∆°ng ƒê·ªè',
        icon: '1000000122.png',
        duration: 7 * 60 * 60 * 1000, // 7 gi·ªù
        cost: { dau: 7000 },
        materials: { 'chau_kim_cuong': 1, 'hat_kim_loai': 70 }
    }
];

const FARM_IDS = [2, 3, 4, 5, 7]; 
let farmSlots = Array(5).fill(null); 
let equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua']; 

// --- ƒê√É CH·ªàNH S·ª¨A V·ªä TR√ç PET ---
let petShopItems = [
    // --- S·ª¨A L·∫†I CHOCO: TH√äM SIZE V√Ä CƒÇN L·∫†I V·ªä TR√ç ---
    { 
        id: 100, 
        name: "Choco", 
        price: 0, 
        currency: "dau", 
        type: "pet", 
        icon: "1000000128.gif", 
        value: "1000000128.gif", 
        // Gi·∫£m chi·ªÅu r·ªông c√≤n 60px (m·∫∑c ƒë·ªãnh l√† 120px)
        // Ch·ªânh left th√†nh -30px (m·ªôt n·ª≠a c·ªßa 60px) ƒë·ªÉ cƒÉn gi·ªØa chu·∫©n
        customWidth: "60px", 
        position: { bottom: '70px', left: 'calc(50% - 30px)' }, 
    },
    // --------------------------------------------------
    { 
        id: 101, name: "Pug P√©o", price: 100, currency: "la", type: "pet", 
        icon: "1000000106.png", value: "1000000106.png", position: { bottom: '70px', left: 'calc(50% - 50px)' }, 
    },
        { 
        id: 102, name: "Mr. Gold", price: 100, currency: "la", type: "pet", 
        icon: "1000000108.gif", value: "1000000108.gif", 
        // --- S·ª¨A SIZE ·ªû ƒê√ÇY ---
        customWidth: "150px", // Ch·ªânh to l√™n 150px (M·∫∑c ƒë·ªãnh l√† 120px)
        position: { bottom: '50px', left: 'calc(50% - 75px)' }, // Ch·ªânh l·∫°i t√¢m (-75px v√¨ width l√† 150)
    },
];

let shopItems = [
    { id: 201, name: "Tr·ª©ng Ng≈© S·∫Øc", price: 100, currency: "la", type: "item", icon: "1000000102.png", value: "trung_bang_tuyet", category: "pet_may" },
    { id: 202, name: "Thi√™n Th·∫ßn", price: 0, currency: "dau", type: "pet", icon: "1000000127.gif", value: "1000000127.gif" },
    // --- TH√äM TH·∫¶N CH·∫æT V√ÄO DANH S√ÅCH ---
    { id: 203, name: "Th·∫ßn Ch·∫øt", price: 0, currency: "dau", type: "pet", icon: "1000000104.gif", value: "1000000104.gif" },
    // ------------------------------------
    { id: 204, name: "H·∫°t Nguy√™n T·ªë", price: 100, currency: "dau", type: "seed", icon: "1000000125.png", value: "hat_nguyen_to", category: "hat_may" }, 
    { id: 205, name: "H·∫°t Kim Lo·∫°i", price: 100, currency: "dau", type: "seed", icon: "1000000126.png", value: "hat_kim_loai", category: "hat_may" },
];

const PLANT_STAGES = [
    { 
        name: "M·∫ßm Nh·ªè", 
        icon: "1000000110.gif", 
        duration: 0, // B·∫Øt ƒë·∫ßu ngay l·∫≠p t·ª©c
        next: 6 * 60 * 60 * 1000 // (Kh√¥ng ·∫£nh h∆∞·ªüng logic ch√≠nh nh∆∞ng gi·ªØ ƒë·ªÉ tham kh·∫£o)
    }, 
    { 
        name: "C√¢y Tr∆∞·ªüng Th√†nh", 
        icon: "1000000130.gif", 
        // 6 gi·ªù = 6 * 60 * 60 * 1000 ms
        duration: 6 * 60 * 60 * 1000, 
        next: 6 * 60 * 60 * 1000 
    }, 
    { 
        name: "S·∫µn S√†ng Thu Ho·∫°ch", 
        icon: "1000000130.gif", 
        // 12 gi·ªù (t·ªïng th·ªùi gian t·ª´ l√∫c gieo h·∫°t) = 12 * 60 * 60 * 1000 ms
        duration: 12 * 60 * 60 * 1000, 
        next: 0 
    }, 
];

function showPopup(id) {
    document.getElementById('global-overlay').style.display = 'block';
    const el = document.getElementById(id);
    if(el) el.classList.add('popup-active');
}
function hidePopup(id) {
    const el = document.getElementById(id);
    if(el) el.classList.remove('popup-active');
    setTimeout(() => {
        if(!document.querySelector('.popup-active')) {
            document.getElementById('global-overlay').style.display = 'none';
        }
    }, 100); 
}

// --- H√ÄM C·∫¨P NH·∫¨T H√åNH ·∫¢NH TH·ª¢ R√àN (M·ªöI) ---
function updateBlacksmithVisuals() {
    const idleImg = document.getElementById('chaos-blacksmith');
    const workingImg = document.getElementById('chaos-blacksmith-working');
    
    // N·∫øu h√†ng ch·ªù c√≥ ƒë·ªì (ƒëang r√®n) -> Hi·ªán GIF, ·∫®n PNG
    if (craftingQueue.length > 0) {
        if(idleImg) idleImg.style.display = 'none';
        if(workingImg) workingImg.style.display = 'block';
    } else {
        // N·∫øu r·∫£nh -> Hi·ªán PNG, ·∫®n GIF
        if(idleImg) idleImg.style.display = 'block';
        if(workingImg) workingImg.style.display = 'none';
    }
}

const body = document.body; 
const btnNew = document.getElementById("btn-new");
const btnDelete = document.getElementById("btn-delete"); 
const btnSave = document.getElementById("btn-save");  
const lightBulb = document.getElementById("light-bulb"); 
const nameBox = document.getElementById("name-box");
const btnNext = document.getElementById("btn-next");
const nameInput = document.getElementById("player-name");
const shopBox = document.getElementById("shop-box");
const playerLevelDisplay = document.getElementById("player-level-display");
const expBarContainer = document.getElementById("exp-bar-container");
const expFill = document.getElementById("exp-fill");
const coinDauShop = document.getElementById("coin-dau-shop"); 
const coinLaShop = document.getElementById("coin-la-shop");   
const coinDauPet = document.getElementById("coin-dau-pet");   
const coinLaPet = document.getElementById("coin-la-pet");     
const seedBox = document.getElementById("seed-box"); 
const coinDauSeed = document.getElementById("coin-dau-seed"); 
const coinLaSeed = document.getElementById("coin-la-seed");   
const seedItemsContainer = document.getElementById("seed-items"); 
const onlineBox = document.getElementById("online-box");
const petHouseBox = document.getElementById("pet-house-box");
const petHouseTitle = document.getElementById("pet-house-title"); 
const petShopItemsContainer = document.getElementById("pet-shop-items"); 
const interactionPopup = document.getElementById("interaction-popup"); 
const interactionTitle = document.getElementById("interaction-title"); 
const interactionText = document.getElementById("interaction-text"); 
const interactionControls = document.getElementById("interaction-controls"); 
const pugPetImg = document.getElementById("pug-pet"); 
const iceEggImg = document.getElementById("ice-egg-img"); 

let currentShopTab = 'pet_may';

function expNeeded(lv){ return lv * 100; }

function checkLevelUp() {
    let leveledUp = false;
    while (level > 0 && exp >= expNeeded(level)) {
        exp -= expNeeded(level);
        level += 1;
        leveledUp = true;
    }
    if (leveledUp) { updateDisplay(); updateControlButtons(); }
}

function updateControlButtons(){
    const gameCreated = level > 0;
    btnNew.disabled = gameCreated;
    btnDelete.disabled = !gameCreated;
    btnSave.disabled = !gameCreated;
    
    if (playerLevelDisplay) playerLevelDisplay.innerHTML = gameCreated ? `${playerName} <span style="font-size:0.8em; color:#888;">|</span> Lv.${level}` : `üåæ Farm LOL üåæ`;
    if (expBarContainer) expBarContainer.style.visibility = gameCreated ? 'visible' : 'hidden';
}

function isPetOwned(petValue) { return ownedPets.includes(petValue); }

function activatePet(petValue) {
    const angelData = shopItems.find(i => i.name === "Thi√™n Th·∫ßn");
    const reaperData = shopItems.find(i => i.name === "Th·∫ßn Ch·∫øt");

    if((angelData && petValue === angelData.value) || (reaperData && petValue === reaperData.value)) {
        alert("Pet n√†y kh√¥ng th·ªÉ l√†m Pet ch√≠nh. N√≥ s·∫Ω ·ªü l·∫°i √î s·ªë 1 ƒë·ªÉ b·∫£o v·ªá n√¥ng tr·∫°i!");
        return;
    }
    activePet = petValue; updateDisplay(); alert(`ƒê√£ k√≠ch ho·∫°t Pet m·ªõi!`);
}

function updateDisplay(){
  if(level > 0 && expFill){
      const needed = expNeeded(level);
      const percent = Math.min(100, (exp / needed) * 100);
      expFill.style.width = percent + "%";
  }
// --- TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ HI·ªÜN/·∫®N THI√äN NGA ---
  const incubatorIcon = document.getElementById("incubator-icon");
  if (incubatorIcon) {
      // Ch·ªâ hi·ªán khi th·ªùi gian k·∫øt th√∫c ·∫•p > 0 (t·ª©c l√† ƒëang ·∫•p)
      if (incubationFinishTime > 0) {
          incubatorIcon.style.display = 'block';
      } else {
          incubatorIcon.style.display = 'none';
      }
  }
  const dauStr = dau.toLocaleString('vi-VN');
  const laStr = la.toLocaleString('vi-VN');

  if (coinDauShop) coinDauShop.textContent = dauStr;
  if (coinLaShop) coinLaShop.textContent = laStr;
  if (coinDauPet) coinDauPet.textContent = dauStr;
  if (coinLaPet) coinLaPet.textContent = laStr;
  if (coinDauSeed) coinDauSeed.textContent = dauStr;
  if (coinLaSeed) coinLaSeed.textContent = laStr;
  
  const angelData = shopItems.find(i => i.name === "Thi√™n Th·∫ßn");
  const reaperData = shopItems.find(i => i.name === "Th·∫ßn Ch·∫øt");
  
  // LOGIC HI·ªÇN TH·ªä H√åNH ·∫¢NH ·ªû SLOT 1
  if (iceEggImg) {
      if (isIceDragonHatched) {
          // ƒê√£ n·ªü -> Ki·ªÉm tra xem l√† Thi√™n Th·∫ßn hay Th·∫ßn Ch·∫øt
          if (hatchedPetType === 'than_chet' && reaperData) {
              iceEggImg.src = reaperData.icon;
              iceEggImg.alt = reaperData.name;
              
              // --- S·ª¨A: PH√ìNG TO TH·∫¶N CH·∫æT ---
              iceEggImg.style.width = "220%";
              iceEggImg.style.height = "220%";
              iceEggImg.style.top = "-35px";
              iceEggImg.style.left = "-35px";

          } else if (angelData) {
              iceEggImg.src = angelData.icon; 
              iceEggImg.alt = angelData.name;

              // --- RESET SIZE CHO THI√äN TH·∫¶N ---
              iceEggImg.style.width = "120%"; 
              iceEggImg.style.height = "120%";
              iceEggImg.style.top = "-10px";
              iceEggImg.style.left = "-10px";
          }
          iceEggImg.style.display = 'block'; 
      } else if (hasIceEgg) {
          // Ch∆∞a n·ªü -> Tr·ª©ng
          iceEggImg.src = "1000000102.png"; 
          iceEggImg.alt = "Tr·ª©ng Ng≈© S·∫Øc"; 
          iceEggImg.style.display = 'block'; 

          // --- RESET SIZE CHO TR·ª®NG ---
          iceEggImg.style.width = "120%"; 
          iceEggImg.style.height = "120%";
          iceEggImg.style.top = "-10px";
          iceEggImg.style.left = "-10px";

      } else {
          iceEggImg.src = ""; 
          iceEggImg.alt = ""; 
          iceEggImg.style.display = 'none'; 
      }
  }
  
    if (pugPetImg) {
      if (activePet && !(angelData && activePet === angelData.value) && !(reaperData && activePet === reaperData.value)) { 
          pugPetImg.src = activePet;
          pugPetImg.style.display = 'block'; 
          
          // --- LOGIC ADD CLASS ANIMATION ---
          if (activePet.includes("1000000106.png")) {
              pugPetImg.classList.add("pet-breathing-effect");
          } else {
              pugPetImg.classList.remove("pet-breathing-effect");
          }

          let petData = petShopItems.find(p => p.value === activePet);
          if (!petData) petData = shopItems.find(p => p.value === activePet);
          
          // --- S·ª¨A: LOGIC √ÅP D·ª§NG K√çCH TH∆Ø·ªöC T√ôY CH·ªàNH ---
          if (petData && petData.customWidth) {
              pugPetImg.style.width = petData.customWidth; // √Åp d·ª•ng size nh·ªè cho Choco
          } else {
              pugPetImg.style.width = "120px"; // Size m·∫∑c ƒë·ªãnh cho c√°c pet kh√°c
          }
          // -----------------------------------------------

          if (petData && petData.position) {
              pugPetImg.style.bottom = petData.position.bottom;
              pugPetImg.style.left = petData.position.left;
              pugPetImg.style.transform = 'none'; 
          } else {
              pugPetImg.style.bottom = '35px'; 
              pugPetImg.style.left = '50%';
              pugPetImg.style.transform = 'translateX(calc(-50% - 50px))';
          }
      } else {
          pugPetImg.src = "";
          pugPetImg.style.display = 'none';
          pugPetImg.classList.remove("pet-breathing-effect"); 
      }
  }

  FARM_IDS.forEach((slotId, index) => {
      const seedImg = document.getElementById(`seed-img-${slotId}`);
      const baseImg = document.querySelector(`#slot-${slotId} .pot-base-img`);
      const slotData = farmSlots[index];

      let potType = equippedPots[index] || 'so_dua';
      let potImgSrc = POT_DEFINITIONS[potType] ? POT_DEFINITIONS[potType].img : "1000000112.png";
      
      if (baseImg) baseImg.src = potImgSrc;

      if(seedImg && baseImg) {
          if(slotData) {
              let currentStage = PLANT_STAGES[slotData.stage];
              let useIcon = currentStage.icon; 
              
              if (slotData.stage === 1) { 
                  if (slotData.value === 'hat_kim_loai') useIcon = "1000000111.gif"; 
                  else if (slotData.value === 'hat_nguyen_to') useIcon = "1000000113.gif"; 
              }
              else if (slotData.stage === 2) {
                   if (slotData.value === 'hat_kim_loai') useIcon = "1000000124.gif"; 
                   else if (slotData.value === 'hat_nguyen_to') useIcon = "1000000114.gif"; 
              }

              if (slotData.stage >= 1) {
                  seedImg.classList.add('big-plant'); 
              } else {
                  seedImg.classList.remove('big-plant');
              }

              seedImg.src = useIcon;
              seedImg.alt = slotData.name;
              seedImg.style.display = 'block';
              baseImg.style.opacity = '1';
          } else {
              seedImg.style.display = 'none';
              seedImg.src = "";
              seedImg.classList.remove('big-plant');
              baseImg.style.opacity = '1';
          }
      }
  });
}

function showShopPopup() {
    const wrapper = document.getElementById('shop-tab-container-wrapper');
    if (!wrapper) return;
    wrapper.innerHTML = '';
    
    const tabs = document.createElement('div');
    tabs.className = 'tab-container';
    tabs.innerHTML = `
        <button class="tab-btn ${currentShopTab==='pet_may'?'active':''}" onclick="switchShopTab('pet_may')">üêæ Pet M√¢y</button>
        <button class="tab-btn ${currentShopTab==='hat_may'?'active':''}" onclick="switchShopTab('hat_may')">ü´ò H·∫°t M√¢y</button>
    `;
    wrapper.appendChild(tabs);

    const contentContainer = document.createElement('div');
    contentContainer.id = 'shop-content-grid';
    contentContainer.style.cssText = 'max-height: 300px; overflow-y: auto; padding-right:5px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';
    wrapper.appendChild(contentContainer);

    renderShopItems(contentContainer);
    showPopup('shop-box');
}

function switchShopTab(tabName) {
    currentShopTab = tabName;
    showShopPopup();
}

function renderShopItems(container) {
  container.innerHTML = "";
  const itemsToRender = shopItems.filter(item => item.category === currentShopTab);

  function createShopItemHTML(item) {
    if (item.type === "pet" && (item.name === "Thi√™n Th·∫ßn" || item.name === "Th·∫ßn Ch·∫øt")) return ''; 
    
    const isOwned = (item.value === "trung_bang_tuyet" && (hasIceEgg || isIceDragonHatched));
    
    let buttonHTML = `<button class="btn-buy" data-id="${item.id}" data-type="general">Mua</button>`;
    
    if (isOwned) { 
        buttonHTML = `<button disabled class="btn-buy" style="background:#bdbdbd; box-shadow:none;">ƒê√£ C√≥</button>`;
    }

    const currencyIcon = item.currency === "dau" ? 'ü´ò' : 'üçÇ';
    const currencyColor = item.currency === "dau" ? '#795548' : '#E65100'; 
    
    return `
      <div class="shop-item">
        <img src="${item.icon}" alt="${item.name}" style="width:50px; height:50px; object-fit:contain; margin-bottom:5px;" />
        <div style="font-weight:700; font-size:0.9em; color: var(--text-main); margin-bottom: 2px;">${item.name}</div>
        <div style="font-size:0.8em; color:var(--text-muted); margin-bottom: 5px;">
          <span style="color:${currencyColor};">${currencyIcon}</span> <b>${item.price.toLocaleString('vi-VN')}</b>
        </div>
        ${buttonHTML}
      </div>
    `;
  }
  
  itemsToRender.forEach(item => { container.insertAdjacentHTML('beforeend', createShopItemHTML(item)); });
  
  document.querySelectorAll(".btn-buy[data-type='general']").forEach(btn => { btn.addEventListener("click", handleBuy); });
  updateDisplay();
}

function updateShop(){
    if(document.getElementById('shop-box').classList.contains('popup-active')) {
        const container = document.getElementById('shop-content-grid');
        if(container) renderShopItems(container);
    }
}

function updatePetShop() {
    if (!petShopItemsContainer) return;
    petShopItemsContainer.innerHTML = "";
    petShopItemsContainer.style.cssText = "display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;";

    const allPets = petShopItems;
    allPets.forEach(item => {
        const owned = isPetOwned(item.value); 
        const isActive = item.value === activePet; 
        const itemDiv = document.createElement("div");
        itemDiv.className = "pet-shop-item";
        
        const currencyIcon = item.currency === "la" ? 'üçÇ' : 'ü´ò';
        const currencyColor = item.currency === "la" ? '#E65100' : '#795548';
        const currencyDisplay = `<span style="font-size:0.8em; color:${currencyColor};">${currencyIcon}</span> ${item.price.toLocaleString('vi-VN')}`; 
        
        let buttonHTML = '';
        if (!owned) buttonHTML = `<button class="btn-buy-pet" data-id="${item.id}" data-type="pet-shop-internal" style="background:var(--primary);">Mua</button>`;
        else if (isActive) buttonHTML = `<button disabled style="background:#4CAF50; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%;">ƒêang D√πng</button>`;
        else buttonHTML = `<button class="btn-activate-pet" data-value="${item.value}" style="background:#2196F3; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%; cursor:pointer;">Ch·ªçn</button>`;

        itemDiv.innerHTML = `
            <img src="${item.icon}" alt="${item.name}" style="width:40px;height:40px;object-fit:contain;" />
            <div style="font-weight:600; font-size:0.85em; margin: 4px 0;">${item.name}</div>
            <div style="font-size:0.8em;">${currencyDisplay}</div>
            <div style="width:100%; margin-top:5px;">${buttonHTML}</div>
        `;
        petShopItemsContainer.appendChild(itemDiv);
    });
    
    document.querySelectorAll(".btn-buy-pet[data-type='pet-shop-internal']").forEach(btn => { btn.addEventListener("click", handleBuy); });
    document.querySelectorAll(".btn-activate-pet").forEach(btn => {
        btn.addEventListener("click", (e) => { activatePet(e.target.getAttribute("data-value")); updatePetShop(); });
    });
    updateDisplay();
}

function updateSeedShop() {
    if (!seedItemsContainer) return;
    seedItemsContainer.innerHTML = "";
    const seedShopMap = new Map();
    shopItems.filter(item => item.type === 'seed').forEach(item => seedShopMap.set(item.value, item));
    const ownedSeedValues = Object.keys(ownedSeeds).filter(key => seedShopMap.has(key));

    if(ownedSeedValues.length === 0 || Object.values(ownedSeeds).every(v => v === 0)) {
        seedItemsContainer.innerHTML = `<div style="text-align: center; color: var(--text-muted); margin: 20px 0;">Kho h·∫°t gi·ªëng tr·ªëng.</div>`;
    }
    ownedSeedValues.forEach(seedValue => {
        const item = seedShopMap.get(seedValue);
        const ownedAmount = ownedSeeds[seedValue] || 0;
        if(ownedAmount === 0) return;
        
        const itemDiv = document.createElement("div");
        itemDiv.className = "shop-item";
        itemDiv.style.flexDirection = "row"; 
        
        const priceDisplay = `<span style="font-size:1em; color:#795548;">ü´ò</span> ${item.price}`;
        
        itemDiv.innerHTML = `
            <div style="display:flex; align-items:center;">
                <img src="${item.icon}" style="width:50px; height:50px; margin-right:10px;" />
                <div style="text-align:left;">
                    <div style="font-weight:700;">${item.name}</div>
                    <div style="font-size:0.85em; color:var(--text-muted);">ƒêang c√≥: <b>${ownedAmount}</b></div>
                </div>
            </div>
            <div style="text-align:right;">
                <button class="btn-buy" data-id="${item.id}" data-type="seed-shop-internal" style="width:auto; padding:6px 15px;">Mua th√™m</button>
            </div>
        `;
        seedItemsContainer.appendChild(itemDiv);
    });
    document.querySelectorAll(".btn-buy[data-type='seed-shop-internal']").forEach(btn => { btn.addEventListener("click", handleBuy); });
    updateDisplay();
}

function handleBuy(event) {
  const itemId = parseInt(event.target.getAttribute("data-id"));
  const itemType = event.target.getAttribute("data-type");
  let item = null;
  
  if (itemType === "general") item = shopItems.find(i => i.id === itemId);
  if (!item && itemType === "pet-shop-internal") item = petShopItems.find(i => i.id === itemId);
  if (!item && itemType === "seed-shop-internal") {
      item = shopItems.find(i => i.id === itemId && i.type === 'seed');
  }
  
  if (!item) return;
  
  if (item.value === 'hat_nguyen_to' || item.value === 'hat_kim_loai') {
      let quantityStr = prompt(`B·∫°n mu·ªën mua bao nhi√™u ${item.name}?\n(Gi√°: ${item.price} ƒê·∫≠u/h·∫°t)`, "1");
      if (quantityStr === null) return;
      let quantity = parseInt(quantityStr);
      
      if (isNaN(quantity) || quantity <= 0) {
          alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!");
          return;
      }
      
      let totalCost = item.price * quantity;
      
      if (dau >= totalCost) {
          if (confirm(`T·ªïng ti·ªÅn l√† ${totalCost.toLocaleString('vi-VN')} ƒê·∫≠u. B·∫°n ch·∫Øc ch·∫Øn mu·ªën mua ${quantity} h·∫°t ch·ª©?`)) {
              dau -= totalCost;
              if (ownedSeeds[item.value] !== undefined) ownedSeeds[item.value] += quantity;
              else ownedSeeds[item.value] = quantity;
              alert(`ƒê√£ mua th√†nh c√¥ng ${quantity}x ${item.name}!`);
              updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
          }
      } else {
          alert(`B·∫°n kh√¥ng ƒë·ªß ƒê·∫≠u! C·∫ßn ${totalCost.toLocaleString('vi-VN')} ƒê·∫≠u.`);
      }
      return; 
  }
  
  if (item.type === "item" && item.value === "trung_bang_tuyet" && (hasIceEgg || isIceDragonHatched)) {
      alert(`${item.name} ƒë√£ ƒë∆∞·ª£c s·ªü h·ªØu!`); 
      return; 
  }
  
  if (item.type === "pet" && isPetOwned(item.value)) { alert(`${item.name} ƒë√£ ƒë∆∞·ª£c s·ªü h·ªØu!`); return; }

  let canBuy = false;
  if (item.currency === "dau" && dau >= item.price) { dau -= item.price; canBuy = true; } 
  else if (item.currency === "la" && la >= item.price) { la -= item.price; canBuy = true; }

  if (canBuy) {
    if (item.type === "tool") { tool = item.value; alert(`B·∫°n ƒë√£ trang b·ªã ${item.name}!`); } 
    else if (item.type === "pet") { 
        ownedPets.push(item.value); activePet = item.value;
        alert(`B·∫°n ƒë√£ mua Pet ${item.name}! Pet ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!`);
        if(itemType === "general") hidePopup('shop-box');
    } else if (item.type === "item") { 
        if (item.value === "trung_bang_tuyet") { hasIceEgg = true; alert(`B·∫°n ƒë√£ mua th√†nh c√¥ng ${item.name}!.`); } 
        else { alert(`B·∫°n ƒë√£ mua th√†nh c√¥ng ${item.name}!`); }
    } else if (item.type === "seed") { 
        if (ownedSeeds[item.value] !== undefined) ownedSeeds[item.value] += 1;
        else ownedSeeds[item.value] = 1;
        alert(`B·∫°n ƒë√£ mua 1x ${item.name}!`);
    } 
    else if (item.type === "pot_base") {
        if (ownedPots[item.value] !== undefined) ownedPots[item.value] += 1;
        else ownedPots[item.value] = 1;
        alert(`B·∫°n ƒë√£ mua 1x ${item.name}!`);
    }

    updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
  } else { alert("Kh√¥ng ƒë·ªß ƒê·∫≠u ho·∫∑c L√°!"); }
}

function handleNewGame(){
    showPopup('name-box');
    hidePopup('shop-box');
    hidePopup('online-box');
    hidePopup('pet-house-box'); 
    hidePopup('interaction-popup'); 
    hidePopup('seed-box'); 
}
btnNew.addEventListener('click', handleNewGame);

btnNext.addEventListener('click', () => {
    let inputName = nameInput.value.trim();
    const nameRegex = new RegExp(/^[\p{L}\p{N}]{2,12}$/u); 
    
    if (inputName.length < 2 || inputName.length > 12) {
        alert("T√™n ng∆∞·ªùi ch∆°i ph·∫£i t·ª´ 2 ƒë·∫øn 12 k√Ω t·ª±!"); return;
    }
    if (!nameRegex.test(inputName)) {
        alert("T√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i v√† s·ªë!"); return;
    }
    
        playerName = inputName;
    hidePopup('name-box');
    farmIcon = "üè†"; 
    level = 1; exp = 0; 
    dau = 1000; la = 100; 
    
    // --- S·ª¨A: M·∫∂C ƒê·ªäNH L√Ä CHOCO ---
    activePet = "1000000128.gif"; 
    ownedPets = ["1000000128.gif"]; 
    // ------------------------------

    hasIceEgg = false; isIceDragonHatched = false; isIceDragonEvolved = false; hatchedPetType = "thien_than";
    ownedSeeds = { 'hat_nguyen_to': 1, 'hat_kim_loai': 1 }; 
    ownedPots = { 'so_dua': 0, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 }; 
    equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua']; 
    lastFedTime = 0; 
    farmSlots = Array(5).fill(null); 
    globalPetAge = 0; 
    alert(`Ch√†o m·ª´ng ${playerName} ƒë·∫øn v·ªõi Farm LOL!`);
    updateDisplay(); updateControlButtons();
});

function loadGame(){
    const savedGame = localStorage.getItem('farmLolGame');
    if(savedGame){
        const gameData = JSON.parse(savedGame);
        playerName = gameData.playerName; farmIcon = gameData.farmIcon; level = gameData.level; exp = gameData.exp;
        dau = gameData.dau !== undefined ? gameData.dau : (gameData.xu !== undefined ? gameData.xu : 0);
        la = gameData.la !== undefined ? gameData.la : (gameData.usd !== undefined ? gameData.usd : 0);
        tool = gameData.tool;
        farmSlots = gameData.farmSlots ? (Array.isArray(gameData.farmSlots) ? gameData.farmSlots : Array(5).fill(null)) : Array(5).fill(null);
        if (farmSlots.length < 5) { while(farmSlots.length < 5) farmSlots.push(null); }
        activePet = gameData.activePet || null; ownedPets = gameData.ownedPets || []; 
        hasIceEgg = gameData.hasIceEgg || false; isIceDragonHatched = gameData.isIceDragonHatched || false; isIceDragonEvolved = gameData.isIceDragonEvolved || false;
        hatchedPetType = gameData.hatchedPetType || "thien_than"; // LOAD LO·∫†I PET ƒê√É ·∫§P
        const savedSeeds = gameData.ownedSeeds || {};
        ownedSeeds = { 'hat_nguyen_to': savedSeeds['hat_nguyen_to'] || 0, 'hat_kim_loai': savedSeeds['hat_kim_loai'] || 0 };
        ownedPots = Object.assign({ 'so_dua': 5, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 }, gameData.ownedPots || {});
        craftingQueue = gameData.craftingQueue || [];
        equippedPots = gameData.equippedPots || ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua'];
        farmSlots.forEach((slot, idx) => { if(slot && slot.potType) { equippedPots[idx] = slot.potType; } });
        lastFedTime = gameData.lastFedTime || 0;
        globalPetAge = gameData.globalPetAge || 0;

        // --- D√íNG M·ªöI ƒê∆Ø·ª¢C TH√äM V√ÄO ƒê√ÇY ---
        incubationFinishTime = gameData.incubationFinishTime || 0;
        // ----------------------------------
    }
}

function _saveGame(showAlert = false){
    const gameData = { 
        playerName, farmIcon, level, exp, dau, la, tool, farmSlots, 
        activePet, ownedPets, hasIceEgg, isIceDragonHatched, isIceDragonEvolved, 
        hatchedPetType, // L∆ØU LO·∫†I PET ƒê√É ·∫§P
        ownedSeeds, lastFedTime, globalPetAge,
        ownedPots, craftingQueue, equippedPots,

        // --- TH√äM D√íNG N√ÄY ---
        incubationFinishTime 
        // ---------------------
    }; 
    localStorage.setItem('farmLolGame', JSON.stringify(gameData));
    if(showAlert) alert("ƒê√£ l∆∞u tr√≤ ch∆°i!");
}
function saveGame(){ _saveGame(true); }
btnSave.addEventListener('click', saveGame);
function autoSave() { if (level > 0) { _saveGame(false); } }

function deleteGame(){
    if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a n√¥ng tr·∫°i hi·ªán t·∫°i?")){
        localStorage.removeItem('farmLolGame');
        playerName = "N√¥ng d√¢n"; farmIcon = "üåæ"; level = 0; exp = 0; 
        
        // Reset ti·ªÅn v·ªÅ 0 (c·ª•c v√†ng bi·∫øn m·∫•t)
        dau = 0; 
        la = 0; 
        
        farmSlots = Array(5).fill(null); 
        activePet = null; ownedPets = []; 
        hasIceEgg = false; isIceDragonHatched = false; isIceDragonEvolved = false; hatchedPetType = "thien_than";
        ownedSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0 };
        ownedPots = { 'so_dua': 0, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 };
        equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua'];
        craftingQueue = [];
        lastFedTime = 0; globalPetAge = 0; 

        // X√≥a lu√¥n qu·∫£ ƒë√†o n·∫øu n√≥ ƒëang hi·ªán
        const rewardIcon = document.getElementById('daily-reward-icon');
        if(rewardIcon) rewardIcon.remove();

        alert("ƒê√£ x√≥a n√¥ng tr·∫°i!");
        updateDisplay(); updateControlButtons();
    }
}
btnDelete.addEventListener('click', deleteGame);

const kintoCloud = document.getElementById("kinto-cloud");
if (kintoCloud) {
    kintoCloud.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showShopPopup();
    });
}
if (lightBulb) {
    lightBulb.addEventListener("click", () => {
        body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', body.classList.contains('dark-mode'));
    });
}

function closeInteractionPopup() {
    if (activePopupInterval) { clearInterval(activePopupInterval); activePopupInterval = null; }
    if (window.feedInterval) { clearInterval(window.feedInterval); window.feedInterval = null; }
    hidePopup('interaction-popup');
    const iText = document.getElementById('interaction-text');
    const iControls = document.getElementById('interaction-controls');
    if(iText) { iText.style.display = 'block'; iText.innerHTML = ''; }
    if(iControls) { iControls.innerHTML = ''; }
}

// --- H√ÄM X·ª¨ L√ù ·∫§P TR·ª®NG M·ªöI (C√ì H·∫∏N GI·ªú 24H) ---
function handleIceDragonInteraction(action, selectedType = 'thien_than') {
        // 24 gi·ªù = 24 * 60 ph√∫t * 60 gi√¢y * 1000 mili gi√¢y
    const HATCH_DURATION = 24 * 60 * 60 * 1000; 
    
    // M·∫∏O: Mu·ªën test nhanh 10 gi√¢y th√¨ ƒë·ªïi d√≤ng tr√™n th√†nh:
    // const HATCH_DURATION = 10 * 1000;

    const petName = selectedType === 'than_chet' ? "Th·∫ßn Ch·∫øt" : "Thi√™n Th·∫ßn";

    if (action === 'hatch') {
        if(confirm(`Qu√° tr√¨nh ·∫•p ${petName} s·∫Ω m·∫•t 24 gi·ªù.\nB·∫°n ch·∫Øc ch·∫Øn ch·ª©?`)) {
            // 1. L∆∞u lo·∫°i pet ng∆∞·ªùi ch∆°i ch·ªçn
            hatchedPetType = selectedType; 
            
            // 2. T√≠nh th·ªùi gian k·∫øt th√∫c (Hi·ªán t·∫°i + 24h)
            incubationFinishTime = Date.now() + HATCH_DURATION;
            
            // 3. ƒê√≥ng popup v√† th√¥ng b√°o
            interactionControls.innerHTML = ''; 
            closeInteractionPopup();
            alert(`ƒê√£ b·∫Øt ƒë·∫ßu ·∫•p tr·ª©ng! Quay l·∫°i sau 24 gi·ªù nh√©.`);
            
            updateDisplay();
            saveGame(); // L∆∞u game ngay ƒë·ªÉ kh√¥ng b·ªã m·∫•t gi·ªù n·∫øu reload
        }
    } 
}

let currentSeedTab = 'seeds';
function showSeedSelectionPopup(slotNum, slotIndex) {
    interactionTitle.innerHTML = `üì¶ Kho ƒê·ªì`; 
    interactionText.style.display = 'none'; 
    interactionControls.innerHTML = '';

    const tabs = document.createElement('div');
    tabs.className = 'tab-container';
    tabs.innerHTML = `
        <button class="tab-btn ${currentSeedTab==='seeds'?'active':''}" onclick="switchTab('seeds', ${slotNum}, ${slotIndex})">üå± H·∫°t Gi·ªëng</button>
        <button class="tab-btn ${currentSeedTab==='pots'?'active':''}" onclick="switchTab('pots', ${slotNum}, ${slotIndex})">üè∫ Ch·∫≠u</button>
    `;
    interactionControls.appendChild(tabs);

    const contentContainer = document.createElement('div');
    contentContainer.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 250px; overflow-y: auto; padding: 5px;';
    interactionControls.appendChild(contentContainer);

    if (currentSeedTab === 'seeds') {
        renderSeedList(contentContainer, slotNum, slotIndex);
    } else {
        renderPotList(contentContainer, slotNum, slotIndex);
    }

    showPopup('interaction-popup');
}

function switchTab(tabName, slotNum, slotIndex) {
    currentSeedTab = tabName;
    showSeedSelectionPopup(slotNum, slotIndex);
}

// --- 3. C·∫¨P NH·∫¨T RENDER POT LIST (C√ì B√ÅN S·ªå D·ª™A) ---
function renderPotList(container, slotNum, slotIndex) {
    let hasItem = false;
    const currentSlotPot = equippedPots[slotIndex] || 'so_dua';

    Object.keys(ownedPots).forEach(potKey => {
        const amount = ownedPots[potKey] || 0;
        const potDef = POT_DEFINITIONS[potKey];
        
        // Ch·ªâ hi·ªán n·∫øu c√≥ s·ªë l∆∞·ª£ng > 0
        if (amount > 0 && potDef) {
            hasItem = true;
            const card = document.createElement('div');
            card.className = "shop-item";
            
            const isEquipped = (currentSlotPot === potKey); 
            
            // --- HI·ªÇN TH·ªä EXP BONUS ---
            let bonusText = "";
            if (potDef.expBonus > 0) {
                bonusText = `<div style="color:#4CAF50; font-size:0.8em; font-weight:bold;">+${potDef.expBonus} Exp/l·∫ßn</div>`;
            }

            // HTML c∆° b·∫£n cho ph·∫ßn th√¥ng tin
            let htmlContent = `
                <img src="${potDef.img}" style="width: 40px; height: 40px; object-fit: contain;">
                <div style="font-weight: bold; font-size: 0.9em; margin-top:5px;">${potDef.name}</div>
                ${bonusText}
                <div style="color: var(--text-muted); font-size: 0.8em; margin:3px 0 5px 0;">C√≥: ${amount}</div>
            `;

            // --- X·ª¨ L√ù N√öT B·∫§M ---
            // N√∫t "Thay Ch·∫≠u/ƒêang D√πng" m·∫∑c ƒë·ªãnh
            const btnEquipHTML = `
                <button class="btn-equip-pot" style="background:${isEquipped ? 'grey' : '#2196F3'}; border-radius:6px; cursor:${isEquipped ? 'default' : 'pointer'}; width: 100%;">
                    ${isEquipped ? 'ƒêang d√πng' : 'Thay Ch·∫≠u'}
                </button>
            `;

            // N·∫æU L√Ä S·ªå D·ª™A -> HI·ªÜN TH√äM N√öT B√ÅN
            if (potKey === 'so_dua') {
                htmlContent += `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%; margin-top:5px;">
                        ${btnEquipHTML}
                        <button class="btn-sell-pot" style="
                            width:100%; border:none; border-radius:6px; 
                            padding:6px; font-weight:700; font-size:11px; 
                            color:white; cursor:pointer; 
                            background:#FF5722; box-shadow: 0 2px 0 #E64A19;
                        ">üí∞ B√°n</button>
                    </div>
                `;
            } else {
                // C√°c ch·∫≠u kh√°c ch·ªâ hi·ªán n√∫t Thay Ch·∫≠u
                htmlContent += `<div style="width:100%; margin-top:5px;">${btnEquipHTML}</div>`;
            }

            card.innerHTML = htmlContent;
            
            // --- S·ª∞ KI·ªÜN N√öT THAY CH·∫¨U ---
            const btnEquip = card.querySelector('.btn-equip-pot');
            if(btnEquip) {
                btnEquip.onclick = () => {
                    if (isEquipped) return;
                    if (farmSlots[slotIndex]) { alert("H√£y thu ho·∫°ch c√¢y tr∆∞·ªõc!"); return; }
                    const oldPot = currentSlotPot;
                    const newPot = potKey;
                    ownedPots[newPot]--;
                    ownedPots[oldPot] = (ownedPots[oldPot] || 0) + 1;
                    equippedPots[slotIndex] = newPot;
                    alert(`ƒê√£ thay sang ${potDef.name} (Bonus +${potDef.expBonus} Exp)!`);
                    updateDisplay();
                    closeInteractionPopup();
                };
            }

            // --- S·ª∞ KI·ªÜN N√öT B√ÅN (CH·ªà S·ªå D·ª™A) ---
            const btnSell = card.querySelector('.btn-sell-pot');
            if (btnSell && potKey === 'so_dua') {
                btnSell.onclick = () => {
                    // T√≠nh s·ªë l∆∞·ª£ng S·ªç D·ª´a ƒëang ƒë∆∞·ª£c d√πng ·ªü c√°c √¥ ƒë·∫•t
                    const currentlyUsedCount = equippedPots.filter(p => p === 'so_dua').length;
                    
                    // S·ªë l∆∞·ª£ng c√≥ th·ªÉ b√°n = T·ªïng c√≥ - S·ªë ƒëang d√πng
                    const sellableAmount = amount - currentlyUsedCount;

                    if (sellableAmount <= 0) {
                        alert(`B·∫°n c√≥ ${amount} S·ªç D·ª´a nh∆∞ng t·∫•t c·∫£ ƒëang ƒë∆∞·ª£c d√πng ƒë·ªÉ tr·ªìng c√¢y!\nH√£y thay ch·∫≠u kh√°c tr∆∞·ªõc khi b√°n.`);
                        return;
                    }

                    const sellPrice = 1000; // Gi√° mua 1000 -> B√°n 1000
                    let sellQtyStr = prompt(`Gi√° b√°n l·∫°i: ${sellPrice.toLocaleString()} ƒê·∫≠u/ch·∫≠u.\nB·∫°n c√≥ th·ªÉ b√°n t·ªëi ƒëa: ${sellableAmount} c√°i.\nNh·∫≠p s·ªë l∆∞·ª£ng mu·ªën b√°n:`, "1");
                    
                    if (sellQtyStr === null) return;
                    let sellQty = parseInt(sellQtyStr);

                    if (isNaN(sellQty) || sellQty <= 0) {
                        alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!");
                        return;
                    }
                    if (sellQty > sellableAmount) {
                        alert(`B·∫°n ch·ªâ c√≥ th·ªÉ b√°n t·ªëi ƒëa ${sellableAmount} c√°i (nh·ªØng c√°i kh√°c ƒëang ƒë∆∞·ª£c d√πng)!`);
                        return;
                    }

                    const totalValue = sellQty * sellPrice;
                    if(confirm(`B√°n ${sellQty}x S·ªç D·ª´a ƒë·ªÉ nh·∫≠n ${totalValue.toLocaleString()} ƒê·∫≠u?`)) {
                        ownedPots['so_dua'] -= sellQty;
                        dau += totalValue;
                        alert(`ƒê√£ b√°n th√†nh c√¥ng! Nh·∫≠n ƒë∆∞·ª£c ${totalValue.toLocaleString()} ƒê·∫≠u.`);
                        
                        updateDisplay();
                        // Render l·∫°i danh s√°ch ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ngay l·∫≠p t·ª©c
                        container.innerHTML = "";
                        renderPotList(container, slotNum, slotIndex);
                    }
                };
            }

            container.appendChild(card);
        }
    });
    
    // Ph·∫ßn th√¥ng b√°o cu·ªëi danh s√°ch
    if (farmSlots[slotIndex]) {
        container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding:10px; color:#ef5350; font-weight:bold;">‚ö†Ô∏è Thu ho·∫°ch c√¢y tr∆∞·ªõc khi thay ch·∫≠u!</div>` + container.innerHTML;
    } else if (!hasItem) {
        container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding:10px; color:var(--text-muted);">Kh√¥ng c√≥ ch·∫≠u n√†o kh√°c!</div>`;
    }
}

function renderSeedList(container, slotNum, slotIndex) {
    const seedMap = new Map();
    // L·∫•y th√¥ng tin h·∫°t gi·ªëng t·ª´ shopItems ƒë·ªÉ bi·∫øt gi√°
    shopItems.filter(item => item.type === 'seed').forEach(item => seedMap.set(item.value, item));
    let seedFound = false;
    
    seedMap.forEach((seedData, seedValue) => {
        const amount = ownedSeeds[seedValue] || 0;
        
        // Ch·ªâ hi·ªán n·∫øu c√≥ s·ªë l∆∞·ª£ng > 0 v√† d·ªØ li·ªáu h·ª£p l·ªá
        if (amount > 0 && seedData) {
            seedFound = true;
            const card = document.createElement('div');
            card.className = "shop-item";
            
            // C·∫≠p nh·∫≠t HTML: Th√™m n√∫t B√°n b√™n c·∫°nh n√∫t Tr·ªìng
            card.innerHTML = `
                <img src="${seedData.icon}" style="width: 40px; height: 40px; object-fit: contain;" />
                <div style="font-size: 0.85em; font-weight: 700; margin:5px 0;">${seedData.name}</div>
                <div style="font-size: 0.75em; color: var(--text-muted);">SL: <b>${amount}</b></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%; margin-top:5px;">
                    <button class="btn-plant-now" style="width:100%; margin-top:0;">üå± Tr·ªìng</button>
                    <button class="btn-sell-seed" style="
                        width:100%; border:none; border-radius:8px; 
                        padding:6px; font-weight:700; font-size:11px; 
                        color:white; cursor:pointer; 
                        background:#FF5722; box-shadow: 0 2px 0 #E64A19;
                        transition: all 0.1s;
                    ">üí∞ B√°n</button>
                </div>
            `;
            
            // --- Logic N√∫t Tr·ªìng ---
            card.querySelector('.btn-plant-now').onclick = () => {
                ownedSeeds[seedValue] -= 1;
                const currentPot = equippedPots[slotIndex] || 'so_dua';
                farmSlots[slotIndex] = { 
                    name: seedData.name, icon: PLANT_STAGES[0].icon, value: seedValue, 
                    stage: 0, plantedAt: Date.now(), potType: currentPot 
                };
                updateDisplay(); updateSeedShop(); closeInteractionPopup();
            };

            // --- Logic N√∫t B√°n (M·ªöI) ---
            card.querySelector('.btn-sell-seed').onclick = () => {
                // H·ªèi ng∆∞·ªùi ch∆°i s·ªë l∆∞·ª£ng mu·ªën b√°n
                let sellQtyStr = prompt(`Gi√° b√°n l·∫°i: ${seedData.price} ƒê·∫≠u/h·∫°t.\nB·∫°n mu·ªën b√°n bao nhi√™u ${seedData.name}?`, "1");
                if (sellQtyStr === null) return; // Ng∆∞·ªùi ch∆°i ·∫•n H·ªßy

                let sellQty = parseInt(sellQtyStr);
                
                // Ki·ªÉm tra t√≠nh h·ª£p l·ªá
                if (isNaN(sellQty) || sellQty <= 0) {
                    alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!");
                    return;
                }
                if (sellQty > amount) {
                    alert(`B·∫°n ch·ªâ c√≥ ${amount} h·∫°t, kh√¥ng th·ªÉ b√°n ${sellQty}!`);
                    return;
                }

                // Th·ª±c hi·ªán giao d·ªãch
                const totalValue = sellQty * seedData.price;
                
                if(confirm(`B√°n ${sellQty}x ${seedData.name} ƒë·ªÉ nh·∫≠n ${totalValue.toLocaleString()} ƒê·∫≠u?`)) {
                    ownedSeeds[seedValue] -= sellQty;
                    dau += totalValue;
                    
                    alert(`ƒê√£ b√°n th√†nh c√¥ng! Nh·∫≠n ƒë∆∞·ª£c ${totalValue.toLocaleString()} ƒê·∫≠u.`);
                    
                    // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
                    updateDisplay();
                    updateSeedShop();
                    
                    // Render l·∫°i danh s√°ch n√†y ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
                    container.innerHTML = ""; 
                    renderSeedList(container, slotNum, slotIndex);
                }
            };

            container.appendChild(card);
        }
    });

    if (!seedFound) {
         container.innerHTML = `<div style="grid-column: span 2; text-align: center; margin: 15px 0; color: #666;">H·∫øt h·∫°t gi·ªëng.</div>`;
    }
}

function updateFarmState() {
    const now = Date.now();
    let changed = false; 
    farmSlots.forEach((slotData, index) => {
        if (slotData && slotData.stage < PLANT_STAGES.length - 1) { 
            const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
            if (now >= slotData.plantedAt + nextStageInfo.duration) { slotData.stage += 1; changed = true; }
        }
    });
    if (changed) updateDisplay();
}

function getCountdownTimePlant(timeToNext) {
    if (timeToNext <= 0) return "0s";
    
    // Logic t√≠nh to√°n gi·ªëng h·ªát Th·ª£ R√®n (renderCraftingQueue)
    let seconds = Math.floor((timeToNext / 1000) % 60);
    let minutes = Math.floor((timeToNext / (1000 * 60)) % 60);
    let hours = Math.floor((timeToNext / (1000 * 60 * 60)));
    
    let timeString = "";
    if(hours > 0) timeString += `${hours}h `;
    if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
    timeString += `${seconds}s`;
    
    return timeString;
}

const potSlots = document.querySelectorAll(".pot-slot");
potSlots.forEach(slot => {
    slot.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        interactionText.style.display = 'block';
        if (activePopupInterval) clearInterval(activePopupInterval);

        const slotNum = slot.getAttribute('data-slot');
        const slotNumInt = parseInt(slotNum);

        const renderSlotStatus = () => {
            interactionControls.innerHTML = '';
            
                        if (slotNum === "1") {
                // TR∆Ø·ªúNG H·ª¢P 1: ƒêANG TRONG QU√Å TR√åNH ·∫§P (C√ì ƒê·ªíNG H·ªí)
                if (incubationFinishTime > 0) {
                    interactionTitle.innerHTML = `‚è≥ ƒêang ·∫§p Tr·ª©ng`;
                    
                    // H√†m con ƒë·ªÉ v·∫Ω ƒë·ªìng h·ªì
                    const updateTimer = () => {
                        const now = Date.now();
                        const timeLeft = incubationFinishTime - now;
                        
                        if (timeLeft <= 0) {
                            interactionText.innerHTML = "ƒêang ho√†n t·∫•t qu√° tr√¨nh n·ªü...";
                            return;
                        }

                        // T√≠nh to√°n Gi·ªù : Ph√∫t : Gi√¢y
                        let seconds = Math.floor((timeLeft / 1000) % 60);
                        let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
                        let hours = Math.floor((timeLeft / (1000 * 60 * 60)));
                        
                        let timeString = "";
                        if(hours > 0) timeString += `${hours}h `;
                        if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
                        timeString += `${seconds}s`;

                        interactionText.innerHTML = `
    <div style="text-align:center;">
        <img src="1000000102.png" style="width:80px; display:block; margin: 0 auto 15px auto;">
        
        <div style="font-size:0.95em; color: #555;">ƒêang h·∫•p th·ª• linh kh√≠...</div>
        
        <div style="margin-top:10px; font-size:1.2em; color:#E65100; font-weight:bold; background:rgba(0,0,0,0.05); padding:10px; border-radius:10px;">
            üê£ N·ªü sau: ${timeString}
        </div>
    </div>
`;
                    };

                    updateTimer(); // Ch·∫°y ngay l·∫≠p t·ª©c 1 l·∫ßn
                    
                    // C√†i ƒë·∫∑t ch·∫°y m·ªói gi√¢y ƒë·ªÉ s·ªë nh·∫£y
                    if(activePopupInterval) clearInterval(activePopupInterval);
                    activePopupInterval = setInterval(updateTimer, 1000);
                    
                    interactionControls.innerHTML = ''; // ·∫®n n√∫t b·∫•m
                } 
                
                // TR∆Ø·ªúNG H·ª¢P 2: CH∆ØA ·∫§P HO·∫∂C ƒê√É N·ªû XONG
                else {
                    let petTitle = `üêæ Pet M√¢y`;
                    let description = '';

                                        // N·∫øu ƒë√£ n·ªü r·ªìi
                    if (isIceDragonHatched) {
                        petTitle = (hatchedPetType === 'than_chet') ? `üíÄ Th·∫ßn Ch·∫øt` : `üëº Thi√™n Th·∫ßn`;
                        description = `<span style="color:#2196F3;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span><br>‚ö° Hi·ªáu ·ª©ng: Auto Thu ho·∫°ch (Pet s·∫Ω t·ª± bay ƒëi thu ho·∫°ch khi c√¢y ch√≠n)`;
                        
                        // --- T√çNH NƒÇNG ƒê·ªîI PET M·ªöI ---
                        interactionControls.innerHTML = ''; 
                        
                        // X√°c ƒë·ªãnh Pet mu·ªën ƒë·ªïi sang
                        const targetType = (hatchedPetType === 'thien_than') ? 'than_chet' : 'thien_than';
                        const targetName = (targetType === 'thien_than') ? 'üëº Thi√™n Th·∫ßn' : 'üíÄ Th·∫ßn Ch·∫øt';
                        
                        const btnSwitch = document.createElement('button');
                        btnSwitch.className = "btn-buy";
                        btnSwitch.style.background = "#673AB7"; // M√†u t√≠m huy·ªÅn b√≠
                        btnSwitch.style.marginTop = "15px";
                        btnSwitch.style.padding = "10px";
                        btnSwitch.style.height = "auto";
                        
                        btnSwitch.innerHTML = `
                            ƒê·ªïi sang ${targetName}
                            <div style="font-size:0.8em; font-weight:normal; margin-top:4px; color:#E1BEE7;">
                                Y√™u c·∫ßu: 10.000 ü´ò + 100 H·∫°t Nguy√™n T·ªë
                            </div>
                        `;
                        
                        btnSwitch.onclick = () => {
                            const costDau = 10000;
                            const costSeed = 100;
                            const currentSeeds = ownedSeeds['hat_nguyen_to'] || 0;
                            
                            if (dau >= costDau && currentSeeds >= costSeed) {
                                if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªïi sang ${targetName}?\nChi ph√≠: ${costDau.toLocaleString()} ƒê·∫≠u v√† ${costSeed} H·∫°t Nguy√™n T·ªë.`)) {
                                    // Tr·ª´ t√†i nguy√™n
                                    dau -= costDau;
                                    ownedSeeds['hat_nguyen_to'] -= costSeed;
                                    
                                    // ƒê·ªïi lo·∫°i Pet
                                    hatchedPetType = targetType;
                                    
                                    // L∆∞u v√† c·∫≠p nh·∫≠t
                                    saveGame();
                                    updateDisplay();
                                    
                                    // Th√¥ng b√°o v√† ƒë√≥ng popup ƒë·ªÉ refresh h√¨nh ·∫£nh
                                    alert(`Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng sang ${targetName}!`);
                                    closeInteractionPopup();
                                }
                            } else {
                                alert(`B·∫°n kh√¥ng ƒë·ªß t√†i nguy√™n!\n\nC·∫ßn: ${costDau.toLocaleString()} ƒê·∫≠u & ${costSeed} H·∫°t Nguy√™n T·ªë.\nHi·ªán c√≥: ${dau.toLocaleString()} ƒê·∫≠u & ${currentSeeds} H·∫°t Nguy√™n T·ªë.`);
                            }
                        };
                        
                        interactionControls.appendChild(btnSwitch);
                        // -----------------------------
                    }
                    // N·∫øu ch∆∞a n·ªü (ƒëang l√† tr·ª©ng)
                    else if (hasIceEgg) {
                        petTitle = `Tr·ª©ng Ng≈© S·∫Øc`;
                        description = `Kiu ü¶¢ ·∫•p tr·ª©ng (Th·ªùi gian: 24 gi·ªù)!`;
                        
                        // T·∫°o Menu ch·ªçn Pet
                        const selectionDiv = document.createElement('div');
                        selectionDiv.style.margin = "15px 0";
                        selectionDiv.style.textAlign = "left";
                        selectionDiv.style.background = "rgba(0,0,0,0.05)";
                        selectionDiv.style.padding = "10px";
                        selectionDiv.style.borderRadius = "8px";

                        selectionDiv.innerHTML = `
                            <div style="font-size:0.9em; margin-bottom:8px; font-weight:bold;">B·∫°n mu·ªën ·∫•p ra Pet n√†o?</div>
                            <label style="display:flex; align-items:center; margin-bottom:8px; cursor:pointer;">
                                <input type="radio" name="hatch_choice" value="thien_than" checked style="margin-right:8px; transform:scale(1.2);"> 
                                <span>üëº Thi√™n Th·∫ßn (Cute)</span>
                            </label>
                            <label style="display:flex; align-items:center; cursor:pointer;">
                                <input type="radio" name="hatch_choice" value="than_chet" style="margin-right:8px; transform:scale(1.2);"> 
                                <span>üíÄ Th·∫ßn Ch·∫øt (Ng·∫ßu)</span>
                            </label>
                        `;
                        interactionControls.innerHTML = ''; 
                        interactionControls.appendChild(selectionDiv);
                        
                        const btnHatch = document.createElement('button');
                        btnHatch.textContent = `B·∫Øt ƒë·∫ßu ·∫§p (24h)`;
                        btnHatch.className = "btn-buy";
                        btnHatch.style.background = 'orange';
                        
                        btnHatch.onclick = () => {
                            const choices = document.getElementsByName('hatch_choice');
                            let selected = 'thien_than';
                            for(const c of choices) { if(c.checked) selected = c.value; }
                            handleIceDragonInteraction('hatch', selected); 
                        };
                        
                        interactionControls.appendChild(btnHatch);
                    } 
                    // N·∫øu ch∆∞a c√≥ g√¨
                    else { 
                        description = `Ch∆∞a c√≥ pet n√†o ·ªü ƒë√¢y! H√£y v√†o Shop mua Tr·ª©ng Ng≈© S·∫Øc.`; 
                        interactionControls.innerHTML = '';
                    }
                    
                    interactionTitle.innerHTML = petTitle;
                    interactionText.innerHTML = description;
                }
            }
            else if (FARM_IDS.includes(slotNumInt)) {
                 if (interactionTitle) interactionTitle.innerHTML = "üå± Tr·ªìng Tr·ªçt"; 
                 const slotIndex = FARM_IDS.indexOf(slotNumInt); 
                 const slotData = farmSlots[slotIndex];
                 
                 if (slotData === null) {
                     if(activePopupInterval) clearInterval(activePopupInterval);
                     showSeedSelectionPopup(slotNum, slotIndex); 
                     return; 
                 } else {
                     updateFarmState(); 
                     const currentStage = PLANT_STAGES[slotData.stage];
                     const isReadyForHarvest = slotData.stage === PLANT_STAGES.length - 1;
                     let statusMessage = `B·∫°n ƒëang tr·ªìng <b>${slotData.name}</b>.<br>`;
                     
                     if (isReadyForHarvest) { 
                         if(activePopupInterval) clearInterval(activePopupInterval);
                         statusMessage += `<br><span style="color:#4caf50; font-weight:bold; font-size:1.1em;">‚ú® S·∫¥N S√ÄNG THU HO·∫†CH!</span>`; 
                     } else {
                         const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
                         const timeToNext = (slotData.plantedAt + nextStageInfo.duration) - Date.now();
                         statusMessage += `Giai ƒëo·∫°n: ${currentStage.name}.<br>`;
                         statusMessage += `<div style="margin-top:8px;">‚è≥ L·ªõn sau: <b id="plant-timer" style="color:#d32f2f;">${getCountdownTimePlant(timeToNext)}</b></div>`;
                         
                         if(document.getElementById('interaction-popup').classList.contains('popup-active')) { 
                             if (activePopupInterval) clearInterval(activePopupInterval);
                             activePopupInterval = setInterval(() => {
                                 const timerEl = document.getElementById("plant-timer");
                                 if (timerEl) {
                                     const newTimeToNext = (slotData.plantedAt + nextStageInfo.duration) - Date.now();
                                     if (newTimeToNext <= 0) {
                                         clearInterval(activePopupInterval); activePopupInterval = null; renderSlotStatus(); 
                                     } else { timerEl.textContent = getCountdownTimePlant(newTimeToNext); }
                                 } else { clearInterval(activePopupInterval); activePopupInterval = null; }
                             }, 1000);
                         }
                     }
                     interactionText.innerHTML = statusMessage;
                     
                     // --- 4. C·∫¨P NH·∫¨T LOGIC THU HO·∫†CH V·ªöI EXP BONUS ---
                     if (isReadyForHarvest) {
                         const btnHarvest = document.createElement('button');
                         
                         const currentPotType = slotData.potType || 'so_dua';
                         const potDef = POT_DEFINITIONS[currentPotType];
                         const potBonus = potDef ? (potDef.expBonus || 0) : 0;

                         // N·∫øu ƒë√£ n·ªü Thi√™n Th·∫ßn (ƒë∆∞·ª£c t√≠nh l√† Evolved = true khi n·ªü)
                         if (isIceDragonEvolved) {
                             const harvesterName = (hatchedPetType === 'than_chet') ? "üíÄ Th·∫ßn Ch·∫øt" : "üëº Thi√™n Th·∫ßn";
                             btnHarvest.innerHTML = `${harvesterName} Thu Ho·∫°ch (Auto)`;
                             btnHarvest.className = "btn-buy";
                             btnHarvest.style.background = 'linear-gradient(45deg, #2196F3, #00BCD4)';
                             
                             // --- LOGIC M·ªöI: THI√äN TH·∫¶N BAY THU HO·∫†CH ---
                             btnHarvest.onclick = () => {
                                 closeInteractionPopup(); 
                                 const angelImg = document.getElementById('ice-egg-img');
                                 if (angelImg) { angelImg.classList.add('angel-harvesting'); }

                                 setTimeout(() => {
                                     let totalExpReceived = 0; let hasHarvested = false;
                                     farmSlots.forEach((sData, sIdx) => {
                                         if (sData && sData.stage === PLANT_STAGES.length - 1) {
                                             const hSeedValue = sData.value;
                                             const hReturnAmount = 2; 
                                             
                                             const sPotType = sData.potType || 'so_dua';
                                             const sPotDef = POT_DEFINITIONS[sPotType];
                                             const sBonus = sPotDef ? (sPotDef.expBonus || 0) : 0;
                                             
                                             // --- THAY ƒê·ªîI: EXP THI√äN TH·∫¶N V·ªÄ 10 (XO√Å X2) ---
                                             const hExp = 10 + sBonus; 

                                             exp += hExp; totalExpReceived += hExp;
                                             if (ownedSeeds[hSeedValue] !== undefined) ownedSeeds[hSeedValue] += hReturnAmount;
                                             else ownedSeeds[hSeedValue] = hReturnAmount;
                                             farmSlots[sIdx] = null; hasHarvested = true;
                                         }
                                     });

                                     if (angelImg) { angelImg.classList.remove('angel-harvesting'); }

                                     if (hasHarvested) {
                                         alert(`${harvesterName} ƒë√£ bay m·ªôt v√≤ng v√† thu ho·∫°ch xong!\n\nT·ªïng nh·∫≠n: ${totalExpReceived} EXP!`);
                                         updateDisplay(); checkLevelUp(); updateSeedShop();
                                     } else {
                                         alert(`${harvesterName} bay v·ªÅ tay tr·∫Øng: Kh√¥ng c√≥ c√¢y n√†o ch√≠n c·∫£!`);
                                     }
                                 }, 2000); 
                             };
                         } else {
                             // Thu ho·∫°ch th·ªß c√¥ng
                             const harvestedSeedValue = slotData.value; const returnAmount = 2; 
                             
                             // --- X√ÅC NH·∫¨N EXP C∆† B·∫¢N L√Ä 10 (KH√îNG X2) ---
                             let baseExp = 10;
                             
                             let finalExp = baseExp + potBonus;
                             
                             let msgButton = `üåæ Thu ho·∫°ch (Nh·∫≠n ${returnAmount} H·∫°t + ${finalExp} Exp)`;
                             if(potBonus > 0) msgButton = `üåæ Thu ho·∫°ch (+${finalExp} Exp <span style='font-size:0.8em'>g·ªìm +${potBonus} ch·∫≠u</span>)`;

                             btnHarvest.innerHTML = msgButton;
                             btnHarvest.className = "btn-buy";
                             btnHarvest.style.background = '#FF9800';
                             
                             btnHarvest.onclick = () => {
                                 exp += finalExp; 
                                 if (ownedSeeds[harvestedSeedValue] !== undefined) ownedSeeds[harvestedSeedValue] += returnAmount;
                                 else ownedSeeds[harvestedSeedValue] = returnAmount;
                                 farmSlots[slotIndex] = null; 
                                 
                                 let alertMsg = `Thu ho·∫°ch th√†nh c√¥ng!\nB·∫°n nh·∫≠n ƒë∆∞·ª£c ${finalExp} EXP.`;
                                 if(potBonus > 0) alertMsg += `\n(ƒê√£ bao g·ªìm +${potBonus} EXP t·ª´ ${potDef.name})`;
                                 
                                 alert(alertMsg);
                                 closeInteractionPopup(); updateDisplay(); checkLevelUp(); updateSeedShop(); 
                             };
                         }
                         interactionControls.appendChild(btnHarvest);
                     }
                 }
            } else { 
                if (interactionTitle) interactionTitle.innerHTML = "Th√¥ng B√°o"; 
                interactionText.innerHTML = `√î ƒë·∫•t n√†y ch∆∞a m·ªü kh√≥a!`; 
            }
        };
        renderSlotStatus();
        showPopup('interaction-popup');
    });
});

const petHouse = document.getElementById("pet-house");
if (petHouse) {
    petHouse.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        updatePetShop(); showPopup('pet-house-box'); 
    });
}

const pugPet = document.getElementById("pug-pet");
if (pugPet) {
    pugPet.addEventListener("click", () => {
        if (level === 0) return;
        interactionControls.innerHTML = '';
        if (!activePet) return;
        
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet")); 
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet";
        
        interactionTitle.innerHTML = `üêæ ${petName}`; 
        interactionText.innerHTML = `
            ${petName} ƒëang r·∫•t vui v·∫ª.<br>
            üéÇ Tu·ªïi: <b>${globalPetAge} ng√†y</b>
        `;
        showPopup('interaction-popup');
    });
}

// --- T√åM ƒêO·∫†N N√ÄY V√Ä THAY TH·∫æ TO√ÄN B·ªò (ƒê√É S·ª¨A ƒê·ªÇ T·∫†O HI·ªÜU ·ª®NG QU√Ä) ---
const boneBowl = document.getElementById("bone-bowl");
if (boneBowl) {
    boneBowl.addEventListener("click", () => {
        if (level === 0) return;
        
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet";
        
        interactionControls.innerHTML = ''; 
        interactionTitle.innerHTML = `ü¶¥ Cho ƒÉn`; 
        
        if (!activePet) { interactionText.innerHTML = `Ch∆∞a c√≥ Pet n√†o!`; } 
        else if(petData && (petData.name.includes("Th·∫ßn Ch·∫øt") || petData.name.includes("Thi√™n Th·∫ßn"))) {
            interactionText.innerHTML = `${petName} t·ª± ki·∫øm ƒÉn, kh√¥ng ƒÉn x∆∞∆°ng!`;
        } else {
            const now = new Date(); const last = new Date(lastFedTime);
            const isSameDay = now.getDate() === last.getDate() && now.getMonth() === last.getMonth() && now.getFullYear() === last.getFullYear();
            
            if (!isSameDay) {
                interactionText.innerHTML = `Pet ƒëang ƒë√≥i b·ª•ng...`;
                const btnFeed = document.createElement('button');
                btnFeed.innerHTML = "ü¶¥ Cho ƒÉn ngay (Mi·ªÖn ph√≠)"; // ƒê√£ s·ª≠a text cho kh·ªõp y√™u c·∫ßu
                btnFeed.className = "btn-buy";
                
                // --- S·ª∞ KI·ªÜN CLICK CHO ƒÇN ---
                btnFeed.onclick = () => {
                    lastFedTime = Date.now(); 
                    globalPetAge += 1; 
                    
                    // 1. L∆∞u game
                    saveGame(); 
                    
                    // 2. ƒê√≥ng popup ngay ƒë·ªÉ th·∫•y qu√† bay ra
                    hidePopup('interaction-popup');
                    
                    // 3. G·ªçi h√†m hi·ªÉn th·ªã qu√†
                    spawnDailyReward();
                };
                interactionControls.appendChild(btnFeed);
            } else {
                interactionText.innerHTML = `${petName} ƒë√£ no r·ªìi! üê∂`;
            }
        }
        showPopup('interaction-popup');
    });
}

// --- H√ÄM M·ªöI: HI·ªÇN TH·ªä QU√Ä (ƒê√É S·ª¨A L·∫§Y ƒê√öNG T√äN PET) ---
function spawnDailyReward() {
    // X√≥a qu√† c≈© n·∫øu ch∆∞a nh·∫≠n (tr√°nh tr√πng l·∫∑p)
    const existingReward = document.getElementById('daily-reward-icon');
    if(existingReward) existingReward.remove();

    const petImg = document.getElementById('pug-pet');
    if(!petImg || petImg.style.display === 'none') return;

    // T·∫°o container qu√†
    const wrapper = document.createElement('div');
    wrapper.id = 'daily-reward-icon';
    wrapper.className = 'daily-reward-bubble';

    // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa Pet ƒë·ªÉ ƒë·∫∑t qu√† ngay tr√™n ƒë·∫ßu
    wrapper.style.left = petImg.style.left;
    wrapper.style.transform = petImg.style.transform; 
    
    // T√≠nh to√°n v·ªã tr√≠ bottom: L·∫•y bottom c·ªßa pet + chi·ªÅu cao pet
    let currentBottom = parseInt(petImg.style.bottom || '35'); 
    wrapper.style.bottom = (currentBottom + 90) + 'px'; // Bay cao h∆°n pet 90px

    // 1. Ch·ªâ t·∫°o ·∫¢nh Qu·∫£ ƒê√†o (1000000109.png)
    const img = document.createElement('img');
    img.src = '1000000109.png';
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'contain';

    wrapper.appendChild(img);

    // --- S·ª∞ KI·ªÜN NH·∫¨N QU√Ä ---
    wrapper.onclick = () => {
        la += 5; // C·ªông 5 l√°
        
        // --- ƒêO·∫†N CODE M·ªöI: T√åM T√äN PET HI·ªÜN T·∫†I ---
        let petName = "Pet";
        // G·ªôp danh s√°ch pet shop v√† shop th∆∞·ªùng ƒë·ªÉ t√¨m t√™n
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const currentPetData = allPets.find(p => p.value === activePet);
        
        if (currentPetData) {
            petName = currentPetData.name; // L·∫•y t√™n th·∫≠t (V√≠ d·ª•: Choco, Pug P√©o...)
        }
        // -------------------------------------------

        alert(`B·∫°n nh·∫≠n ƒë∆∞·ª£c 5 L√° t·ª´ ${petName}! üçÇ`);
        
        // Hi·ªáu ·ª©ng bay l√™n bi·∫øn m·∫•t
        wrapper.style.animation = 'flyUpReward 0.5s ease-out forwards';
        
        updateDisplay();
        saveGame();

        // X√≥a element sau khi animation xong
        setTimeout(() => {
            wrapper.remove();
        }, 500);
    };

    // Th√™m v√†o v√πng Main ƒë·ªÉ hi·ªÉn th·ªã
    document.querySelector('main').appendChild(wrapper);
}

const chaosBlacksmith = document.getElementById("chaos-blacksmith");
if (chaosBlacksmith) {
    chaosBlacksmith.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showBlacksmithPopup();
    });
}
// --- S·ª∞ KI·ªÜN CLICK CHO ·∫¢NH ƒê·ªòNG (M·ªöI) ---
const chaosBlacksmithWorking = document.getElementById("chaos-blacksmith-working");
if (chaosBlacksmithWorking) {
    chaosBlacksmithWorking.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showBlacksmithPopup();
    });
}


function showBlacksmithPopup() {
    interactionTitle.innerHTML = "üî® Th·ª£ R√®n Chaos";
    interactionText.style.display = 'none';
    interactionControls.innerHTML = "";
    
    const container = document.createElement("div");
    container.style.cssText = 'max-height: 400px; overflow-y: auto; padding: 2px;';
    
    const queueContainer = document.createElement("div");
    queueContainer.id = "crafting-queue-list";
    container.appendChild(queueContainer);
    
    const table = document.createElement('table');
    table.className = 'blacksmith-table';
    table.innerHTML = `<tbody id="blacksmith-recipes-body"></tbody>`;
    container.appendChild(table);
    
    const tbody = table.querySelector('#blacksmith-recipes-body');

    const isSmithBusy = craftingQueue.length > 0;

    CRAFTING_RECIPES.forEach(recipe => {
        const hasDau = dau >= (recipe.cost.dau || 0);
        
        let materialsHtml = '';
        let canCraftMaterials = true;

        Object.keys(recipe.materials).forEach(matKey => {
            const reqQty = recipe.materials[matKey];
            let hasItem = false;
            let currentAmt = 0;
            let matName = matKey;

            if (matKey === 'hat_kim_loai') {
                 currentAmt = ownedSeeds['hat_kim_loai'] || 0;
                 matName = "Kim Lo·∫°i";
            } else if (POT_DEFINITIONS[matKey]) {
                 currentAmt = ownedPots[matKey] || 0;
                 matName = POT_DEFINITIONS[matKey].name;
            }

            hasItem = currentAmt >= reqQty;
            if (!hasItem) canCraftMaterials = false;
            
            materialsHtml += `<div class="${hasItem?'req-status-ok':'req-status-fail'}">${hasItem?'‚úì':'‚úó'} ${matName}: ${reqQty}</div>`;
        });
        
        materialsHtml += `<div class="${hasDau?'req-status-ok':'req-status-fail'}">${hasDau?'‚úì':'‚úó'} ƒê·∫≠u: ${recipe.cost.dau}</div>`;

        let isBlockedByBusy = (recipe.duration > 0 && isSmithBusy);

        const canCraft = hasDau && canCraftMaterials && !isBlockedByBusy;
        const btnText = recipe.duration === 0 ? "Mua" : (isBlockedByBusy ? "ƒêang B·∫≠n" : "R√®n");
        
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
            <td>
                <div class="blacksmith-recipe">
                    <img src="${recipe.icon}" style="width:40px;height:40px;object-fit:contain;">
                    <div style="font-weight:bold;">${recipe.name}</div>
                </div>
            </td>
            <td>
                ${materialsHtml}
            </td>
            <td>
                <button id="btn-craft-${recipe.id}" class="btn-crafting" style="width:auto; padding:8px 15px; background:${canCraft?'var(--accent)':'#999'};" ${canCraft?'':'disabled'}>
                    ${btnText}
                </button>
            </td>
        `;
        
        setTimeout(() => {
            const btn = document.getElementById(`btn-craft-${recipe.id}`);
            if(btn) btn.onclick = () => startCrafting(recipe);
        }, 0);
    });

    interactionControls.appendChild(container); 
    renderCraftingQueue();
    showPopup('interaction-popup');
    
    if (activePopupInterval) clearInterval(activePopupInterval);
    activePopupInterval = setInterval(renderCraftingQueue, 1000);
}

function startCrafting(recipe) {
    if (craftingQueue.length > 0 && recipe.duration > 0) {
        alert("Th·ª£ r√®n ƒëang b·∫≠n! Vui l√≤ng ƒë·ª£i r√®n xong m√≥n hi·ªán t·∫°i.");
        return;
    }

    if (dau < (recipe.cost.dau || 0)) return;
    
    for (const [matKey, matQty] of Object.entries(recipe.materials)) {
        let currentAmt = 0;
        if (matKey === 'hat_kim_loai') currentAmt = ownedSeeds['hat_kim_loai'] || 0;
        else if (ownedPots[matKey] !== undefined) currentAmt = ownedPots[matKey] || 0;
        
        if (currentAmt < matQty) {
            alert("Kh√¥ng ƒë·ªß nguy√™n li·ªáu!");
            return;
        }
    }

    const actionName = recipe.duration === 0 ? "Mua" : "R√®n";

    if(confirm(`B·∫°n mu·ªën ${actionName} ${recipe.name}?`)) {
        dau -= (recipe.cost.dau || 0);
        
        for (const [matKey, matQty] of Object.entries(recipe.materials)) {
            if (matKey === 'hat_kim_loai') {
                 ownedSeeds['hat_kim_loai'] -= matQty;
            } else if (ownedPots[matKey] !== undefined) {
                 ownedPots[matKey] -= matQty;
            }
        }

        if (recipe.duration === 0) {
             if (!ownedPots[recipe.output]) ownedPots[recipe.output] = 0;
             ownedPots[recipe.output]++;
             alert(`ƒê√£ mua th√†nh c√¥ng ${recipe.name}!`);
             updateDisplay();
             showBlacksmithPopup(); 
        } else {
            craftingQueue.push({ output: recipe.output, name: recipe.name, startTime: Date.now(), finishTime: Date.now() + recipe.duration });
            alert("ƒê√£ b·∫Øt ƒë·∫ßu r√®n!");
            updateDisplay();
            showBlacksmithPopup();
            updateBlacksmithVisuals(); // C·∫¨P NH·∫¨T H√åNH ·∫¢NH 
        }
    }
}

function renderCraftingQueue() {
    const container = document.getElementById("crafting-queue-list");
    if (!container) return;
    
    container.innerHTML = "";
    if (craftingQueue.length === 0) return;
    
    const queueList = document.createElement('div');
    queueList.style.cssText = 'border: 2px dashed #FF9800; padding: 10px; border-radius: 8px; margin-bottom: 15px; background: rgba(255, 236, 179, 0.5);';
    container.appendChild(queueList);

    const now = Date.now();
    let updated = false;

    for (let i = craftingQueue.length - 1; i >= 0; i--) {
        const item = craftingQueue[i];
        const timeLeft = item.finishTime - now;
        
        if (timeLeft <= 0) {
            craftingQueue.splice(i, 1);
            if (!ownedPots[item.output]) ownedPots[item.output] = 0;
            ownedPots[item.output]++;
            alert(`‚úÖ R√®n th√†nh c√¥ng: ${item.name}!`);
            updated = true;
        } else {
            const div = document.createElement("div");
            
            // --- C·∫¨P NH·∫¨T HI·ªÇN TH·ªä TH·ªúI GIAN ƒê·∫∏P H∆†N ---
            let seconds = Math.floor((timeLeft / 1000) % 60);
            let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
            let hours = Math.floor((timeLeft / (1000 * 60 * 60)));
            
            let timeString = "";
            if(hours > 0) timeString += `${hours}h `;
            if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
            timeString += `${seconds}s`;

            div.style.fontWeight = "bold";
            div.innerHTML = `üî• ${item.name}: <span style="color:#E65100">${timeString}</span>`;
            queueList.appendChild(div);
        }
    }
    
    if (updated) {
        updateDisplay();
        if (document.getElementById('interaction-popup').classList.contains('popup-active')) showBlacksmithPopup();
    }
}

function checkGlobalCrafting() {
    if(craftingQueue.length > 0) {
        const now = Date.now();
        let updated = false;
        for (let i = craftingQueue.length - 1; i >= 0; i--) {
            if (now >= craftingQueue[i].finishTime) {
                const item = craftingQueue[i];
                craftingQueue.splice(i, 1);
                if (!ownedPots[item.output]) ownedPots[item.output] = 0;
                ownedPots[item.output]++;
                alert(`‚úÖ R√®n th√†nh c√¥ng: ${item.name}!`);
                updated = true;
            }
        }
        if (updated) updateDisplay();
        updateBlacksmithVisuals(); // C·∫¨P NH·∫¨T L·∫†I N·∫æU H√ÄNG CH·ªú R·ªñNG
    }
}

const brandContainer = document.querySelector(".brand");
if (brandContainer) {
    brandContainer.addEventListener("click", () => {
        if (level === 0) return;
        const maxExp = expNeeded(level);
        const percent = ((exp / maxExp) * 100).toFixed(1);
        
        interactionTitle.innerHTML = `üìä C·∫•p ƒë·ªô ${level}`;
        interactionText.style.display = 'block';
        interactionText.innerHTML = `
            <div style="text-align:left; background:#f5f5f5; padding:15px; border-radius:10px;">
                üå± <b>Kinh nghi·ªám:</b> ${exp.toLocaleString()} / ${maxExp.toLocaleString()}<br>
                üìà <b>Ti·∫øn ƒë·ªô:</b> ${percent}%
            </div>
        `;
        interactionControls.innerHTML = '';
        showPopup('interaction-popup');
    });
}

function initializeGame(){
    loadGame(); 
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if(isDarkMode) document.body.classList.add('dark-mode');
    
    adjustAppWrapperScale(); 
    
    updateDisplay(); updateControlButtons(); updateShop(); 
    updateBlacksmithVisuals(); // C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI H√åNH ·∫¢NH KHI LOAD GAME
}

setInterval(updateFarmState, 1000); 
setInterval(checkGlobalCrafting, 1000); 
setInterval(autoSave, 60000);
setInterval(checkIncubationState, 1000);
// --- H√ÄM KI·ªÇM TRA TR·ª®NG N·ªû (CH·∫†Y T·ª∞ ƒê·ªòNG) ---
function checkIncubationState() {
    // Ch·ªâ ch·∫°y khi ƒëang c√≥ th·ªùi gian ·∫•p (l·ªõn h∆°n 0)
    if (incubationFinishTime > 0) {
        const now = Date.now();
        
        // N·∫øu th·ªùi gian hi·ªán t·∫°i ƒë√£ v∆∞·ª£t qua th·ªùi gian n·ªü
        if (now >= incubationFinishTime) {
            incubationFinishTime = 0; // Reset v·ªÅ 0
            hasIceEgg = false; 
            isIceDragonHatched = true;
            isIceDragonEvolved = true; 

            // Th√™m pet v√†o kho
            const petValue = (hatchedPetType === 'than_chet' ? "1000000104.gif" : "1000000127.gif");
            const petData = shopItems.find(i => i.value === petValue);
            const petNameDisplay = petData ? petData.name : (hatchedPetType === 'than_chet' ? "Th·∫ßn Ch·∫øt" : "Thi√™n Th·∫ßn");
            
            if(petData && !isPetOwned(petData.value)) ownedPets.push(petData.value);
            
            // Hi·ªán th√¥ng b√°o
            alert(`üéâ CH√öC M·ª™NG! Tr·ª©ng ƒë√£ n·ªü th√†nh: ${petNameDisplay}!\nƒê√£ m·ªü kh√≥a t√≠nh nƒÉng Auto Thu Ho·∫°ch.`);
            
            // C·∫≠p nh·∫≠t giao di·ªán
            updateDisplay();
            
            // N·∫øu ng∆∞·ªùi ch∆°i ƒëang m·ªü popup xem tr·ª©ng th√¨ ƒë√≥ng l·∫°i cho n√≥ c·∫≠p nh·∫≠t
            if(document.getElementById('interaction-popup').classList.contains('popup-active')) {
                hidePopup('interaction-popup');
            }
        }
    }
}
window.onload = initializeGame;

</script>
</body>
</html>
