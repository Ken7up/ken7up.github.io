<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Farm LOL - Pet Daily Reward</title>

<link rel="manifest" href="manifest.json"> 

<link rel="icon" type="image/png" href="1000000109.png">
<link rel="apple-touch-icon" href="1000000109.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root { 
    /* Palette mÃ u tÆ°Æ¡i sÃ¡ng */
    --bg-gradient: linear-gradient(180deg, #a1ffce 0%, #faffd1 100%);
    --primary: #4CAF50; 
    --primary-dark: #388E3C;
    --accent: #FF9800;
    --accent-dark: #F57C00;
    --text-main: #3e2723;
    --text-muted: #795548;
    
    /* UI Variables */
    --card-bg: rgba(255, 255, 255, 0.95);
    --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
    --btn-shadow: 0 4px 0px;
    --radius-lg: 20px;
    --radius-md: 12px;
    --radius-sm: 8px;
    
    /* Dark Mode Palette */
    --dark-bg-gradient: linear-gradient(180deg, #1a237e 0%, #311b92 100%);
    --dark-card-bg: rgba(30, 30, 40, 0.95);
    --dark-text: #e0e0e0;
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; 
    font-family: 'Fredoka', sans-serif; 
    background: #333; 
    color: var(--text-main); 
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    overflow: hidden;
    transition: background 0.3s;
  }

  /* --- APP CONTAINER (FIXED RATIO SCALING) --- */
  .app-wrapper {
    width: 400px; 
    height: 750px; 
    background: var(--bg-gradient);
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 50px rgba(0,0,0,0.5); 
    position: relative; 
    text-align: left; 
    
    /* Quan trá»ng cho viá»‡c Scale */
    transform-origin: top center; 
    transform: scale(1); 
    transition: transform 0.1s ease-out, background 0.3s;
    flex-shrink: 0;
    overflow: hidden; /* Cáº¯t pháº§n thá»«a náº¿u cÃ³ */
  }

  /* --- DARK MODE --- */
  body.dark-mode .app-wrapper {
    background: var(--dark-bg-gradient);
    color: var(--dark-text);
  }
  /* ÄÃƒ Sá»¬A: ThÃªm #inventory-box vÃ o danh sÃ¡ch dÆ°á»›i Ä‘Ã¢y */
  body.dark-mode .card-panel, 
  body.dark-mode #shop-box, 
  body.dark-mode #online-box, 
  body.dark-mode #pet-house-box, 
  body.dark-mode #interaction-popup, 
  body.dark-mode #seed-box,
  body.dark-mode #inventory-box {  /* <--- DÃ’NG Má»šI THÃŠM */
      background: var(--dark-card-bg);
      color: var(--dark-text);
      border: 1px solid rgba(255,255,255,0.1);
  }

  /* --- MENU TOGGLE BTN --- */
  #menu-btn {
      position: absolute;
      top: 15px; left: 15px;
      width: 46px; height: 46px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-dark);
      font-size: 20px;
      cursor: pointer;
      z-index: 101; 
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  #menu-btn:active { transform: scale(0.9); }
  body.dark-mode #menu-btn { background: #311b92; color: white; border-color: #5c6bc0; }

  /* --- HEADER --- */
  header { 
      position: absolute;
      top: 15px; 
      left: 70px; 
      right: 15px;
      display: flex; 
      flex-direction: column; 
      align-items: center;    
      padding: 8px 15px; 
      background: rgba(255, 255, 255, 0.65); 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 20px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      z-index: 100; 
      border: 1px solid rgba(255,255,255,0.4);
      
      /* Animation */
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      transform-origin: left center;
      opacity: 1;
      transform: scaleX(1);
  }

  header.collapsed {
      opacity: 0;
      transform: scaleX(0) translateX(-20px);
      pointer-events: none;
  }

  .dark-mode header {
      background: rgba(20, 20, 30, 0.7);
      border-color: rgba(255,255,255,0.1);
      color: white;
  }

  .brand {
      display: flex; 
      flex-direction: column; 
      align-items: center;
      width: 100%;
      cursor: pointer;
      margin-bottom: 5px;
  }
  
  #player-level-display {
      font-size: 15px; font-weight: 700; color: var(--primary-dark);
      text-shadow: 0 1px 0 rgba(255,255,255,0.5);
  }
  .dark-mode #player-level-display { color: #81c784; text-shadow: none; }

  /* EXP BAR */
  #exp-bar-container {
    width: 120px; 
    height: 14px; /* TÄƒng chiá»u cao lÃªn 1 chÃºt Ä‘á»ƒ chá»¯ dá»… Ä‘á»c hÆ¡n (cÅ© lÃ  6px) */
    background: rgba(0,0,0,0.2); 
    border-radius: 10px; 
    margin-top: 4px; 
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);

    /* QUAN TRá»ŒNG: Äá»ƒ Ä‘á»‹nh vá»‹ dÃ²ng chá»¯ náº±m Ä‘Ã¨ lÃªn trÃªn */
    position: relative; 
}

/* CSS cho dÃ²ng chá»¯ hiá»ƒn thá»‹ sá»‘ EXP */
#exp-text-overlay {
    position: absolute;
    top: 0; left: 0; 
    width: 100%; height: 100%;
    display: flex; 
    align-items: center; 
    justify-content: center;

    /* Chá»‰nh font chá»¯ cho Ä‘áº¹p vÃ  rÃµ */
    font-size: 9px; 
    font-weight: 800; 
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0,0,0,1); /* Viá»n Ä‘en quanh chá»¯ Ä‘á»ƒ ná»•i báº­t */
    z-index: 2; /* Äáº£m báº£o chá»¯ náº±m trÃªn thanh mÃ u xanh */
    pointer-events: none;
}
  #exp-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #66bb6a, #43a047);
      border-radius: 10px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* --- BUTTONS --- */
  button { font-family: 'Fredoka', sans-serif; }
  
  .controls { 
      display: flex; 
      flex-wrap: nowrap; 
      justify-content: center;
      width: 100%;
      gap: 6px;
  } 
  
  .controls button {
      font-size: 10px; font-weight: 700;
      padding: 5px 10px;
      margin: 0;
      border: none; border-radius: 20px;
      cursor: pointer;
      color: white;
      text-transform: uppercase;
      transition: transform 0.1s;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      white-space: nowrap;
  }
  
  .controls button:active { transform: translateY(2px); box-shadow: none; }

  #btn-new { background: #29b6f6; box-shadow: 0 2px 0 #0288d1; }
  #btn-save { background: #66bb6a; box-shadow: 0 2px 0 #388e3c; }
  #btn-delete { background: #ef5350; box-shadow: 0 2px 0 #d32f2f; }
  
  button:disabled { background: #bdbdbd !important; box-shadow: none !important; color: #757575 !important; cursor: not-allowed; transform: none !important; }

  /* --- MAIN GAME AREA --- */
  main { 
        flex: 1; display:flex; justify-content:center; 
        align-items:flex-start; 
        padding:0; 
        overflow: hidden;
        position: relative;
  }
  
  #beanstalk-bg {
    position: absolute; 
    top: 0; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 100%; 
    height: 100%;
    z-index: 3; 
    object-fit: cover;
  }

  /* UI Game Object Animations */
  @keyframes float { 0% { transform: translate(-50%, 0px); } 50% { transform: translate(-50%, -10px); } 100% { transform: translate(-50%, 0px); } }
  
  /* --- ANIMATION THá» CHO PET (SQUASH & STRETCH) --- */
  @keyframes pet-breathing {
      0%, 100% { 
          /* Tráº¡ng thÃ¡i bÃ¬nh thÆ°á»ng */
          transform: scale(1, 1); 
      }
      50% { 
          /* Hiá»‡u á»©ng xáº¹p phá»“ng: BÃ¨ ngang (1.06) vÃ  tháº¥p xuá»‘ng (0.94) */
          transform: scale(1.06, 0.94); 
      } 
  }

  /* --- ANIMATION THIÃŠN THáº¦N / THáº¦N CHáº¾T BAY THU HOáº CH --- */
  @keyframes angel-fly-harvest {
      0% { transform: translateX(0) scaleX(1); }
      45% { transform: translateX(340px) scaleX(1); } /* Bay sang pháº£i */
      50% { transform: translateX(340px) scaleX(-1); } /* Quay Ä‘áº§u */
      95% { transform: translateX(0) scaleX(-1); } /* Bay vá» */
      100% { transform: translateX(0) scaleX(1); } /* Quay láº¡i */
  }

  .angel-harvesting {
      animation: angel-fly-harvest 2s ease-in-out forwards;
      z-index: 100 !important;
      position: relative; 
  }

  /* --- CLASS Má»šI Äá»‚ KÃCH HOáº T HIá»†U á»¨NG THá» --- */
  .pet-breathing-effect {
      animation: pet-breathing 2s ease-in-out infinite;
  }

  #kinto-cloud {
      position: absolute; top: 30px; left: calc(60% + 15px); transform: translateX(-50%); 
      width: 45px;   /* TÄƒng tá»« 30px lÃªn 45px cho dÃ i ra */
      height: auto;  /* Äá»•i thÃ nh auto Ä‘á»ƒ áº£nh khÃ´ng bá»‹ mÃ©o */
      /* ---------------- */
      
      z-index: 10; cursor: pointer; 
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
  }
    /* --- CSS CHO MÃ‚Y Sá»° KIá»†N (Má»šI) --- */
  #event-cloud {
      position: absolute; 
      top: 30px;               /* Äáº·t cÃ¹ng Ä‘á»™ cao vá»›i CÃ¢n Äáº©u VÃ¢n */
      left: calc(60% + 75px);  /* Äáº©y sang pháº£i má»™t chÃºt Ä‘á»ƒ khÃ´ng bá»‹ che */
      transform: translateX(-50%); 
      
      width: 45px;             /* KÃ­ch thÆ°á»›c áº£nh */
      height: auto; 
      z-index: 10;             /* Lá»›p hiá»ƒn thá»‹ cao Ä‘á»ƒ báº¥m Ä‘Æ°á»£c */
      cursor: pointer; 
      
      /* Hiá»‡u á»©ng bay (float) giá»‘ng há»‡t mÃ¢y shop */
      animation: float 3s ease-in-out infinite; 
      animation-delay: 1.5s;   /* Trá»… 1.5s Ä‘á»ƒ 2 Ä‘Ã¡m mÃ¢y bay lá»‡ch nhá»‹p cho Ä‘áº¹p */
      
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); /* Táº¡o bÃ³ng Ä‘á»• nháº¹ */
  }
  
  /* Hiá»‡u á»©ng khi báº¥m vÃ o mÃ¢y (nhÃºn nháº¹) */
  #event-cloud:active {
      transform: translateX(-50%) scale(0.9);
  }
  
  #light-bulb {
      position: absolute; 
      top: 15px; 
      left: calc(30% - 10px); 
      transform: translateX(-50%);
      z-index: 8; 
      cursor: pointer; 
      width: 60px; 
      height: auto;
      filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
  }

  #pet-house {
      position: absolute; bottom: 210px; left: 50%; transform: translateX(calc(-50% + 100px)); 
      width: 150px; height: auto; z-index: 7; cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #chaos-blacksmith {
      position: absolute; bottom: 260px; left: 50%; transform: translateX(calc(-50% - 130px));
      width: 90px; height: auto; z-index: 7; cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #chaos-blacksmith-working {
      position: absolute; 
      bottom: 270px; 
      left: 50%; 
      transform: translateX(calc(-50% - 130px));
      width: 60px; 
      height: auto; 
      z-index: 7; 
      cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }
  
  #pug-pet {
      position: absolute; 
      bottom: 35px; 
      left: 50%; 
      transform: translateX(calc(-50% - 50px)); 
      width: 120px; 
      height: auto; 
      z-index: 7; 
      cursor: pointer;
      transform-origin: bottom center; 
      will-change: transform;
  }
  
  #bone-bowl {
      position: absolute; bottom: 130px; left: 50%; transform: translateX(calc(-50% + 110px)); 
      width: 50px; height: auto; z-index: 7; cursor: pointer; 
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #pot-container {
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 100%; height: 100%; z-index: 5; display: flex; justify-content: center; pointer-events: none; 
  }

  .pot-slot {
      position: absolute; width: 50px; height: 50px; background: transparent; border: none; 
      display: flex; align-items: center; justify-content: center; 
      cursor: pointer; transition: transform 0.1s; pointer-events: auto; 
  }
  .pot-slot:hover { transform: scale(1.1); filter: brightness(1.1); }
  .pot-slot:active { transform: scale(0.95); }

  .pot-slot img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
  }
  
  .pot-base-img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
      transition: opacity 0.3s;
  }

  /* --- SLOT POSITIONS --- */
  /* Chá»‰nh vá»‹ trÃ­ Ã´ Slot 1 (giá»¯ nguyÃªn vá»‹ trÃ­ Ã´) */
  #slot-1 { 
      width: 50px; 
      height: 50px; 
      top: 140px; 
      left: calc(50% - 160px); 
  }

  /* --- Vá»Š TRÃ áº¢NH PET á» SLOT 1 (ÄÃƒ Sá»¬A CÃ‚N Äá»I) --- */
  
  /* 1. Cáº¥u hÃ¬nh chung máº·c Ä‘á»‹nh */
  #slot-1 img { 
      position: absolute;       
      z-index: 5;
      object-fit: contain; 
      transition: none !important;
      
      /* Máº·c Ä‘á»‹nh an toÃ n náº¿u chÆ°a load class */
      width: 100%; height: 100%; top: 0; left: 0;
  }

  /* 2. Class riÃªng cho QUáº¢ TRá»¨NG (To, náº±m trá»n trong cháº­u) */
  .fix-egg {
      width: 150% !important;
      height: 120% !important;
      top: -18% !important;    /* Äáº©y lÃªn má»™t chÃºt */
      left: -35% !important;    /* CÄƒn giá»¯a */
  }

  /* 3. Class riÃªng cho THIÃŠN THáº¦N (Cáº§n to vÃ  bay cao hÆ¡n) */
  .fix-angel {
      width: 145% !important;   /* To hÆ¡n Ä‘á»ƒ tháº¥y rÃµ cÃ¡nh */
      height: 145% !important;
      top: -35% !important;     /* Bay cao háº³n lÃªn */
      left: -35% !important;
  }

  /* 4. Class riÃªng cho THáº¦N CHáº¾T (DÃ¡ng cao, gáº§y) */
  .fix-reaper {
      width: 290% !important;
      height: 150% !important;
      top: -40% !important;
      left: -100% !important;
  }

  /* 5. Class riÃªng cho BI GAI (Nhá», trÃ²n, cáº§n náº±m tháº¥p) */
  .fix-bigai {
      width: 120% !important;   /* KÃ­ch thÆ°á»›c vá»«a váº·n */
      height: 110% !important;
      top: -30% !important;      /* Náº±m gáº§n miá»‡ng cháº­u */
      left: -20% !important;      /* CÄƒn giá»¯a tuyá»‡t Ä‘á»‘i */
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.6)); /* ThÃªm hÃ o quang nháº¹ */
  }
  
  #slot-6 { width: 50px; height: 35px; top: 335px; left: calc(50% - 30px + 10px + 15px); }
  #slot-6 img { width: 130%; height: 130%; top: -15px; left: -10px; }
  
  #slot-2, #slot-3, #slot-4, #slot-5, #slot-7 { width: 35px; height: 35px; }
  #slot-2 img, #slot-3 img, #slot-4 img, #slot-5 img, #slot-7 img { width: 130%; height: 130%; top: -5px; left: -5px; }
  
  .seed-image {
      width: 140% !important; 
      height: auto !important; 
      max-height: 120px !important; 
      object-fit: contain; 
      position: absolute; 
      bottom: 27px !important;  
      top: auto !important;     
      left: 50% !important;
      transform: translateX(-50%) !important; 
      z-index: 6;
      pointer-events: none;
      transition: all 0.3s ease; 
  }

  /* --- Vá»Š TRÃ CÃC Ã” Äáº¤T --- */
  #slot-2 { top: 155px; left: calc(50% - 90px - 10px); }
  #slot-3 { top: 155px; left: calc(50% - 30px - 10px); } 
  #slot-4 { top: 155px; left: calc(50% + 30px - 10px); }
  #slot-5 { top: 155px; left: calc(50% + 90px - 10px); }
  #slot-7 { top: 155px; left: calc(50% + 150px - 10px); }


  /* --- POPUPS (MODALS) --- */
  .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); backdrop-filter: blur(3px);
      z-index: 990; display: none;
  }

  #shop-box, #online-box, #pet-house-box, #interaction-popup, #seed-box, #name-box, #inventory-box {
    position: fixed; top: 50%; left: 50%; 
    transform: translate(-50%, -50%) scale(0.9); 
    background: var(--card-bg);
    width: 90%; max-width: 320px;
    padding: 20px; 
    border-radius: var(--radius-lg); 
    box-shadow: var(--card-shadow); 
    z-index: 1000; 
    text-align: center; 
    border: 4px solid white;
    opacity: 0; pointer-events: none; 
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .popup-active {
      transform: translate(-50%, -50%) scale(1) !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      display: block !important;
  }

  h3 { 
      margin: 0 0 15px 0; color: var(--primary-dark); font-size: 1.2em; 
      text-transform: uppercase; letter-spacing: 1px;
  }
  .dark-mode h3 { color: #81c784; }

  hr { border: 0; border-top: 2px dashed #ddd; margin: 15px 0; }

  .btn-close, button[onclick*="none"] {
      margin-top: 15px;
      padding: 8px 25px;
      background: #f44336;
      color: white;
      border: none; border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 3px 0 #d32f2f;
      cursor: pointer;
      width: 100%;
      font-size: 0.9em;
  }
  .btn-close:active, button[onclick*="none"]:active { transform: translateY(4px); box-shadow: none; }
  .btn-remove-vines {
    width: 100%;
    margin-top: 10px;
    padding: 8px;
    background: #ff5252; /* MÃ u Ä‘á» */
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 0 #d32f2f;
    transition: all 0.1s;
}
.btn-remove-vines:active {
    transform: translateY(3px);
    box-shadow: none;
}

  /* --- SHOP ITEMS (GRID) --- */
  .shop-item, .pet-shop-item {
      background: white;
      border: 1px solid #eee;
      border-radius: var(--radius-md);
      padding: 10px;
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;
  }
  .dark-mode .shop-item, .dark-mode .pet-shop-item { background: #2c2c35; border-color: #444; }

  .shop-item:hover, .pet-shop-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

  .btn-buy, .btn-buy-pet, .btn-plant-now, .btn-equip-pot, .btn-crafting {
      width: 100%; border: none; border-radius: 8px;
      padding: 6px; margin-top: 8px;
      font-weight: 700; font-size: 11px;
      color: white; cursor: pointer;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      transition: all 0.1s;
  }
  .btn-buy:active, .btn-plant-now:active { transform: translateY(2px); box-shadow: none; }
  
  .btn-buy, .btn-plant-now { background: var(--accent); box-shadow: 0 2px 0 var(--accent-dark); }
  /* Override btn-plant-now specific color if needed, but keeping accent is fine */

  /* --- TABS --- */
  .tab-container {
      background: #f5f5f5; padding: 4px; border-radius: 12px;
      display: flex; gap: 5px; margin-bottom: 15px; border: none;
  }
  .dark-mode .tab-container { background: #2a2a35; }

  .tab-btn {
      flex: 1; padding: 8px; border-radius: 8px; border: none;
      background: transparent; color: #777; font-weight: 600; font-size: 0.9em;
      transition: all 0.2s; cursor: pointer;
  }
  .tab-btn.active {
      background: white; color: var(--primary);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .dark-mode .tab-btn.active { background: #4caf50; color: white; }

  /* --- CSS Má»šI CHO THá»¢ RÃˆN (BLACKSMITH) --- */
  /* Container danh sÃ¡ch */
  .blacksmith-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 5px;
  }

  /* Má»™t hÃ ng cÃ´ng thá»©c rÃ¨n */
  .blacksmith-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.1s;
  }
  .dark-mode .blacksmith-row {
      background: #2c2c35;
      border-color: #444;
  }

  /* Pháº§n bÃªn trÃ¡i: áº¢nh + TÃªn */
  .bs-info {
      display: flex;
      align-items: center;
      flex: 1.2; /* Chiáº¿m nhiá»u chá»— hÆ¡n chÃºt */
      gap: 10px;
  }

  /* KHUNG áº¢NH Cá» Äá»ŠNH (Quan trá»ng Ä‘á»ƒ sá»­a lá»—i to nhá») */
  .bs-icon-box {
      width: 50px;
      height: 50px;
      background: #f5f5f5;
      border: 1px solid #eeeeee;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0; /* KhÃ´ng bá»‹ co láº¡i */
  }
  .dark-mode .bs-icon-box {
      background: #3a3a45;
      border-color: #555;
  }

  .bs-icon-box img {
      width: 80%;       /* áº¢nh chá»‰ chiáº¿m 80% khung Ä‘á»ƒ cÃ³ khoáº£ng thá»Ÿ */
      height: 80%;
      object-fit: contain; /* Giá»¯ nguyÃªn tá»‰ lá»‡ áº£nh */
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15));
  }

  .bs-name {
      font-weight: 700;
      font-size: 0.95em;
      color: var(--text-main);
      line-height: 1.2;
  }
  .dark-mode .bs-name { color: #e0e0e0; }

  /* Pháº§n giá»¯a: NguyÃªn liá»‡u */
  .bs-req {
      flex: 1.5;
      font-size: 0.8em;
      padding: 0 5px;
      border-left: 1px dashed #ddd;
      border-right: 1px dashed #ddd;
      margin: 0 5px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
  }
  .dark-mode .bs-req { border-color: #555; }

  /* Pháº§n bÃªn pháº£i: NÃºt báº¥m */
  .bs-action {
      flex: 0.8;
      text-align: right;
  }

  .req-line { display: flex; align-items: center; gap: 4px; }
  .req-ok { color: var(--primary); font-weight: 600; }
  .req-miss { color: #f44336; }

  /* --- INPUT NAME BOX --- */
  #name-box input {
      width: 100%; padding: 10px; margin: 15px 0;
      border: 2px solid #ddd; border-radius: 10px;
      font-family: inherit; font-size: 14px; text-align: center;
      outline: none; transition: border 0.3s;
  }
  #name-box input:focus { border-color: var(--primary); }
  #btn-next {
      background: var(--primary); color: white;
      padding: 10px 30px; border-radius: 30px;
      font-size: 14px; font-weight: bold; border: none;
      box-shadow: 0 3px 0 var(--primary-dark);
  }
  #btn-next:active { transform: translateY(3px); box-shadow: none; }

  /* --- SCROLLBAR --- */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: #aaa; }

    /* --- CSS CHO CÃ‚Y TO --- */
  .seed-image.big-plant {
      width: 220% !important;        
      max-height: 250px !important;  
      bottom: 27px !important;       
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); 
      z-index: 10;                   
  }
    /* --- CSS FIX RIÃŠNG CHO CÃ‚Y TÃŒNH YÃŠU --- */
  .seed-image.big-plant.love-fix {
      width: 120% !important;        
      max-height: 160px !important;  
      bottom: 26px !important;       
      /* ÄÃƒ Sá»¬A: Äá»•i sang mÃ u há»“ng Ä‘áº­m (DeepPink) vÃ  tÄƒng Ä‘á»™ rÃµ nÃ©t */
      filter: drop-shadow(0 5px 10px rgba(255, 20, 147, 0.85)); 
      z-index: 10;
  }
    /* --- CSS Má»šI: CÃ¢y TÃ¬nh YÃªu giai Ä‘oáº¡n vá»«a (Stage 1) --- */
  /* Class nÃ y sáº½ giÃºp cÃ¢y nhá» hÆ¡n vÃ  bÃ³ng gá»n hÆ¡n so vá»›i giai Ä‘oáº¡n thu hoáº¡ch */
  .seed-image.medium-plant.love-fix {
      width: 100% !important;        /* Nhá» hÆ¡n má»©c 120% cá»§a giai Ä‘oáº¡n lá»›n */
      max-height: 130px !important;  /* Giá»›i háº¡n chiá»u cao tháº¥p hÆ¡n (gá»‘c lÃ  160px) */
      bottom: 27px !important;
      /* BÃ³ng mÃ u há»“ng nhÆ°ng nhá» hÆ¡n, gáº§n gá»‘c hÆ¡n */
      filter: drop-shadow(0 3px 7px rgba(255, 20, 147, 0.8)) !important;
      z-index: 9;
  }
    /* --- CSS CHO CÃ‚Y GIAI ÄOáº N TRÆ¯á»NG THÃ€NH (STAGE 1 - SIZE Vá»ªA) --- */
  .seed-image.medium-plant {
      width: 160% !important;        /* Nhá» hÆ¡n 220% cá»§a big-plant */
      max-height: 180px !important;  
      bottom: 27px !important;       
      z-index: 9;                   
      transition: all 0.3s ease;
  }

  /* Chá»‰nh bÃ³ng riÃªng cho CÃ¢y Kim Loáº¡i giai Ä‘oáº¡n vá»«a (nháº¡t hÆ¡n vÃ  nhá» hÆ¡n) */
  .seed-image.medium-plant.shadow-metal {
      filter: drop-shadow(0 3px 5px rgba(60, 60, 60, 0.8)) !important;
  }

  /* Chá»‰nh bÃ³ng riÃªng cho CÃ¢y NguyÃªn Tá»‘ giai Ä‘oáº¡n vá»«a (nháº¡t hÆ¡n vÃ  nhá» hÆ¡n) */
  .seed-image.medium-plant.shadow-element {
      filter: drop-shadow(0 3px 5px rgba(171, 71, 188, 0.7)) !important;
  }
    /* --- CSS BÃ“NG CHO CÃ‚Y (Má»šI THÃŠM) --- */
  
  /* 1. BÃ³ng xanh lÃ¡ cho Máº§m Nhá» (Giai Ä‘oáº¡n 0) */
  .seed-image.shadow-green {
      filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.8)) !important;
  }

  /* 2. BÃ³ng xÃ¡m cho CÃ¢y Kim Loáº¡i (Giai Ä‘oáº¡n lá»›n) */
  .seed-image.big-plant.shadow-metal {
      /* ÄÃƒ Sá»¬A: Äá»•i sang mÃ u xÃ¡m Ä‘en Ä‘áº­m Ä‘áº·c hÆ¡n */
      filter: drop-shadow(0 5px 10px rgba(60, 60, 60, 1.0)) !important;
  }

  /* 3. BÃ³ng tÃ­m cho CÃ¢y NguyÃªn Tá»‘ (Giai Ä‘oáº¡n lá»›n) */
  .seed-image.big-plant.shadow-element {
      filter: drop-shadow(0 5px 10px rgba(171, 71, 188, 0.8)) !important;
  }

  /* --- CSS CHO QUÃ€ Táº¶NG HÃ€NG NGÃ€Y (Daily Reward) --- */
  .daily-reward-bubble {
    position: absolute;
    width: 60px; /* KÃ­ch thÆ°á»›c áº£nh quáº£ Ä‘Ã o */
    height: 60px;
    z-index: 90; /* Cao hÆ¡n pet, tháº¥p hÆ¡n popup */
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: popInReward 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); /* Hiá»‡u á»©ng phÃ¡t sÃ¡ng nháº¹ */
}

/* Hiá»‡u á»©ng xuáº¥t hiá»‡n */
@keyframes popInReward {
    0% { transform: scale(0) translateY(20px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

/* Hiá»‡u á»©ng bay lÃªn khi nháº­n xong */
@keyframes flyUpReward {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
}
/* --- CSS CHO ICON áº¤P TRá»¨NG (ğŸ¦¢) --- */
  #incubator-icon {
      position: absolute;
      
      /* CÄƒn chá»‰nh vá»‹ trÃ­: Äáº·t láº¡i top cho phÃ¹ há»£p vá»›i kÃ­ch thÆ°á»›c má»›i */
      top: -18px;                   /* ÄÃ£ sá»­a: Äáº©y tháº¥p xuá»‘ng má»™t chÃºt cho gáº§n trá»©ng hÆ¡n (cÅ© lÃ  -35px) */
      left: 40%;
      transform: translateX(-50%);  /* CÄƒn giá»¯a ngang */
      
      /* Giao diá»‡n: KÃ­ch thÆ°á»›c nhá» láº¡i */
      font-size: 10px;              /* ÄÃ£ sá»­a: Nhá» láº¡i (cÅ© lÃ  40px) */
      z-index: 20;
      
      /* Hiá»‡u á»©ng: Cá»‘ Ä‘á»‹nh (Bá» animation float) */
      /* animation: float 2s ease-in-out infinite; */ /* <-- ÄÃ£ comment dÃ²ng nÃ y Ä‘á»ƒ táº¯t hiá»‡u á»©ng bay */
      
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
      pointer-events: none;
  }
/* --- CODE Má»šI CHO 3 LÃ” (BALO) --- */
#backpack-slot {
    position: absolute;
    width: 20px;       /* KÃ­ch thÆ°á»›c tÃºi */
    height: 60px;
    top: 320px;        /* Äá»™ cao (ngang táº§m vá»›i em bÃ© cÃ¢u cÃ¡) */
    left: 175px;        /* Náº±m bÃªn trÃ¡i mÃ n hÃ¬nh (hoáº·c chá»‰nh sá»‘ nÃ y Ä‘á»ƒ dá»i vá»‹ trÃ­) */
    z-index: 10;
    cursor: pointer;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); /* Äá»• bÃ³ng cho Ä‘áº¹p */
    transition: transform 0.2s;
}
#backpack-slot:hover { transform: scale(1.1); } /* PhÃ³ng to khi di chuá»™t vÃ o */
#backpack-slot img { width: 100%; height: 100%; object-fit: contain; }

/* --- GIAO DIá»†N 3 LÃ” (GRID 2 Cá»˜T CÃ‚N Äá»I) --- */
#inventory-list {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Chia lÃ m 2 cá»™t Ä‘á»u tÄƒm táº¯p */
    gap: 12px; /* Khoáº£ng cÃ¡ch giá»¯a cÃ¡c Ã´ */
    max-height: 320px;
    overflow-y: auto;
    padding: 5px;
    margin-top: 10px;
}

.inventory-item {
    display: flex;
    flex-direction: column; /* Xáº¿p dá»c: áº¢nh trÃªn - Chá»¯ dÆ°á»›i */
    align-items: center;
    justify-content: center;
    
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 10px;
    
    box-shadow: 0 3px 5px rgba(0,0,0,0.05); /* BÃ³ng Ä‘á»• nháº¹ */
    transition: transform 0.1s;
}

.inventory-item:active {
    transform: scale(0.95); /* Hiá»‡u á»©ng nhÃºn khi báº¥m */
}

/* KHUNG CHá»¨A áº¢NH (QUAN TRá»ŒNG Äá»‚ CÃ‚N Äá»I) */
.inventory-img-box {
    width: 55px;  /* Cá»‘ Ä‘á»‹nh chiá»u rá»™ng */
    height: 55px; /* Cá»‘ Ä‘á»‹nh chiá»u cao */
    
    background: #f5f5f5; /* MÃ u ná»n xÃ¡m nháº¹ sau lÆ°ng váº­t pháº©m */
    border-radius: 50%;  /* Bo trÃ²n khung */
    border: 1px solid #eeeeee;
    
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px; /* CÃ¡ch pháº§n chá»¯ bÃªn dÆ°á»›i */
}

.inventory-img-box img {
    width: 70%;  /* áº¢nh váº­t pháº©m chá»‰ chiáº¿m 70% khung Ä‘á»ƒ khÃ´ng bá»‹ trÃ n */
    height: 70%;
    object-fit: contain;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15));
}

.inventory-name {
    font-size: 0.85em;
    font-weight: 700;
    color: #3e2723;
    margin-bottom: 4px;
    text-align: center;
}

.inventory-qty {
    background: #FFF3E0;
    color: #E65100;
    font-size: 0.8em;
    padding: 2px 10px;
    border-radius: 10px;
    font-weight: bold;
    border: 1px solid #FFE0B2;
}
/* --- CSS CHO TOAST NOTIFICATION (PHIÃŠN Báº¢N PRO) --- */
#toast-notification {
    position: fixed;
    bottom: 140px;           /* Cao hÆ¡n má»™t chÃºt Ä‘á»ƒ dá»… nhÃ¬n */
    left: 50%;
    transform: translateX(-50%) scale(0.8);
    
/* Sá»¬A PHáº¦N NÃ€Y: LÃ m ná»n kÃ­nh má» hiá»‡n Ä‘áº¡i hÆ¡n */
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(76, 175, 80, 0.3); /* Viá»n má»ng tinh táº¿ */
    border-left: 6px solid #4CAF50; /* Äiá»ƒm nháº¥n bÃªn trÃ¡i */
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); /* BÃ³ng Ä‘á»• má»m máº¡i hÆ¡n */
    backdrop-filter: blur(5px); /* Hiá»‡u á»©ng má» ná»n phÃ­a sau */
    
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 2000;
    
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    white-space: nowrap;
}

#toast-notification .toast-icon {
    font-size: 24px;
    background: #e8f5e9;
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
}

#toast-notification .toast-content {
    display: flex;
    flex-direction: column;
    text-align: left;
}

#toast-notification .toast-title {
    font-weight: 800;
    font-size: 0.9em;
    text-transform: uppercase;
    color: #4CAF50;
    letter-spacing: 1px;
}

#toast-notification .toast-message {
    font-size: 1em;
    font-weight: 600;
    color: #333;
}

/* Class kÃ­ch hoáº¡t hiá»‡u á»©ng */
#toast-notification.show {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    animation: toastBounce 3s forwards;
}

@keyframes toastBounce {
    0%   { transform: translate(-50%, 20px) scale(0.8); opacity: 0; }
    10%  { transform: translate(-50%, 0px) scale(1); opacity: 1; }
    90%  { transform: translate(-50%, 0px) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -50px) scale(0.9); opacity: 0; }
}
/* --- HIá»†U á»¨NG Váº¬T PHáº¨M BAY LÃŠN (FLOATING REWARDS) --- */
.floating-reward {
    position: absolute;
    z-index: 9999; /* LuÃ´n ná»•i lÃªn trÃªn cÃ¹ng */
    font-weight: 900;
    font-size: 15px;
    pointer-events: none; /* KhÃ´ng cháº·n click chuá»™t */
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
    
    /* Táº¡o viá»n tráº¯ng cho chá»¯ dá»… Ä‘á»c trÃªn ná»n game */
    text-shadow: 
        -1px -1px 0 #fff,  
         1px -1px 0 #fff,
        -1px  1px 0 #fff,
         1px  1px 0 #fff;

    animation: floatUpFade 1.2s ease-out forwards;
}

/* Animation: PhÃ³ng to nháº¹ -> Bay lÃªn -> Má» dáº§n */
@keyframes floatUpFade {
    0% { transform: translateY(0) scale(0.8); opacity: 0; }
    20% { transform: translateY(-15px) scale(1.2); opacity: 1; }
    80% { opacity: 1; }
    100% { transform: translateY(-80px) scale(1); opacity: 0; }
}

/* MÃ u sáº¯c riÃªng cho tá»«ng loáº¡i */
.float-exp { color: #2E7D32; } /* Xanh lÃ¡ Ä‘áº­m */
.float-item { color: #E65100; } /* Cam Ä‘áº­m */
/* --- CSS CHO HÃ’M THÃNH GIFTCODE (ÄÃƒ Sá»¬A TO HÆ N) --- */
#giftcode-supply-drop {
    position: absolute;
    width: 40px; /* ÄÃ£ tÄƒng tá»« 40px lÃªn 50px cho hoÃ nh trÃ¡ng */
    height: auto;
    
    /* CÄƒn chá»‰nh láº¡i vá»‹ trÃ­ má»™t chÃºt cho cÃ¢n Ä‘á»‘i vá»›i kÃ­ch thÆ°á»›c má»›i */
    top: 400px; 
    left: 340px; 
    
    z-index: 12; /* Ná»•i lÃªn trÃªn máº·t nÆ°á»›c */
    cursor: pointer;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
}

/* Giao diá»‡n Ã´ nháº­p Giftcode */
#giftcode-input {
    width: 100%;
    padding: 12px;
    margin: 15px 0;
    border: 2px dashed #FF9800;
    border-radius: 10px;
    font-size: 16px;
    text-align: center;
    color: #E65100;
    font-weight: bold;
    text-transform: uppercase; /* Tá»± Ä‘á»™ng viáº¿t hoa */
    outline: none;
    background: #FFF3E0;
}
#giftcode-input:focus {
    border-color: #E65100;
    background: #fff;
}
/* --- HIá»†U á»¨NG KHÃ“I Äá» SIGNAL (REALISTIC & RÃ• NÃ‰T) --- */
.smoke-particle {
    position: absolute;
    width: 16px;  /* KÃ­ch thÆ°á»›c cÆ¡ báº£n to hÆ¡n xÃ­u */
    height: 16px;
    
    /* Gradient 3 lá»›p: TÃ¢m cam sÃ¡ng -> Äá» Ä‘áº­m -> Viá»n trong suá»‘t */
    background: radial-gradient(circle, #ff5722 10%, #d50000 45%, rgba(255,0,0,0) 70%);
    
    border-radius: 50%;
    pointer-events: none;
    z-index: 11;
    opacity: 0;
    
    /* Báº¯t Ä‘áº§u Ã­t blur Ä‘á»ƒ rÃµ nÃ©t, sau Ä‘Ã³ sáº½ blur dáº§n trong keyframes */
    filter: blur(2px); 
    
    /* Thá»i gian bay lÃ¢u hÆ¡n (2.5s) Ä‘á»ƒ cá»™t khÃ³i cao hÆ¡n */
    animation: smokeRise 2.5s ease-out forwards; 
}

@keyframes smokeRise {
    0% {
        transform: translate(0, 0) scale(0.5);
        opacity: 0;
    }
    10% {
        /* Hiá»‡n ra nhanh vÃ  rÃµ */
        opacity: 1; 
        transform: translate(0, -20px) scale(1);
    }
    100% {
        /* Bay lÃªn ráº¥t cao (-220px), phÃ¬nh to gáº¥p 6 láº§n, vÃ  táº£n ra theo giÃ³ (var --dx) */
        transform: translate(var(--dx), -220px) scale(6); 
        opacity: 0;
        filter: blur(12px); /* LÃªn cao thÃ¬ nhÃ²e Ä‘i nhÆ° khÃ³i tháº­t */
    }
}
#bee-guard {
    position: absolute;
    width: 15px;              
    height: auto;
    
    top: 233px;               
    left: calc(50% - 166px);  
    
    z-index: 15;
    cursor: pointer;
    
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));

    display: none; /* Máº·c Ä‘á»‹nh áº©n Ä‘i Ä‘á»ƒ JS xá»­ lÃ½ */
}

/* Váº«n giá»¯ hiá»‡u á»©ng nhÃºn khi báº¥m vÃ o */
#bee-guard:active {
    transform: scale(0.9);
}

/* Hiá»‡u á»©ng khi báº¥m vÃ o thÃ¬ nhÃºn nháº¹ */
#bee-guard:active {
    transform: scale(0.9);
}
/* --- CSS CHO MINIGAME CÃ‚U CÃ (PRO VERSION) --- */
#fishing-popup {
    background: #E0F7FA;
    border: 4px solid #0277BD;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    font-family: 'Fredoka', sans-serif;
}

/* Khu vá»±c chá» cÃ¡ cáº¯n */
#fishing-waiting { text-align: center; padding: 20px; }

@keyframes float-bobber { 
    0%, 100% { transform: translateY(0) rotate(-5deg); } 
    50% { transform: translateY(-10px) rotate(5deg); } 
}

.fishing-float-anim { 
    font-size: 60px; 
    margin-bottom: 15px;
    display: flex;             
    justify-content: center;   
    align-items: center;       
    animation: float-bobber 2s ease-in-out infinite;
    filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2));
}

/* Khu vá»±c chÆ¡i game */
#fishing-game-area {
    display: none; 
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 20px;
    height: 340px;
    position: relative;
    margin-top: 10px;
    background: #B3E5FC;
    border-radius: 15px;
    padding: 10px;
    border: 2px solid #81D4FA;
}

/* Cá»™t nÆ°á»›c chÃ­nh (Thanh Bar) */
#fishing-bar-container {
    width: 50px;
    height: 300px;
    background: linear-gradient(to right, #2c3e50, #4ca1af); /* MÃ u nÆ°á»›c sÃ¢u */
    border-radius: 25px;
    position: relative;
    overflow: hidden;
    border: 4px solid #37474F;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
}

/* VÃ¹ng Xanh (Má»¥c tiÃªu - Sáº½ di chuyá»ƒn) */
#zone-green {
    position: absolute; 
    left: 2px; 
    width: calc(100% - 4px); 
    height: 80px; /* Chiá»u cao vÃ¹ng an toÃ n */
    background: rgba(118, 255, 3, 0.5);
    border-top: 2px solid #76FF03;
    border-bottom: 2px solid #76FF03;
    z-index: 1;
    border-radius: 4px;
    box-shadow: 0 0 10px rgba(118, 255, 3, 0.4);
    transition: bottom 0.1s linear; /* Di chuyá»ƒn mÆ°á»£t */
}

/* Thanh trÆ°á»£t (Bobber - NgÆ°á»i chÆ¡i Ä‘iá»u khiá»ƒn) */
#fishing-bobber {
    position: absolute; 
    left: 50%; 
    transform: translateX(-50%);
    bottom: 10%;
    width: 36px; 
    height: 20px;
    background: #FF5722; /* MÃ u cam ná»•i báº­t */
    border: 2px solid #fff;
    border-radius: 10px;
    z-index: 10;
    transition: bottom 0.05s linear; 
    box-shadow: 0 0 8px rgba(255, 87, 34, 0.8);
}
/* ThÃªm thanh ngang nhá» giá»¯a bobber cho giá»‘ng tháº­t */
#fishing-bobber::after {
    content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(0,0,0,0.2);
}

/* Thanh tiáº¿n Ä‘á»™ báº¯t cÃ¡ (BÃªn pháº£i) */
#catch-progress-container {
    width: 25px; height: 300px;
    background: #eceff1; 
    border-radius: 15px;
    position: relative; 
    overflow: hidden; 
    border: 2px solid #cfd8dc;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

#catch-progress-fill {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
    background: linear-gradient(0deg, #FFEB3B, #FFC107, #FF9800, #4CAF50);
    transition: height 0.1s;
}

/* Hiá»‡u á»©ng khi thanh Ä‘áº§y (chiáº¿n tháº¯ng) */
.progress-full {
    filter: drop-shadow(0 0 5px #4CAF50);
}

#fishing-timer {
    position: absolute; top: 15px; right: 20px;
    font-size: 1.8em; font-weight: 900; color: #0277BD;
    text-shadow: 2px 2px 0px white;
}
/* --- CSS Má»šI CHO Ã” CHá»¨A áº¢NH --- */

/* 1. Class chuáº©n cho ná»n Ã´ áº£nh (DÃ¹ng chung cho táº¥t cáº£) */
.icon-box-bg {
    background: #f5f5f5;         /* MÃ u ná»n sÃ¡ng máº·c Ä‘á»‹nh */
    border: 1px solid #e0e0e0;   /* Viá»n sÃ¡ng máº·c Ä‘á»‹nh */
    transition: background 0.3s, border-color 0.3s;
}

/* 2. Khi báº­t Cháº¿ Ä‘á»™ Tá»‘i (Dark Mode) -> Äá»•i mÃ u ná»n thÃ nh xÃ¡m Ä‘en */
body.dark-mode .icon-box-bg, 
body.dark-mode .inventory-img-box { /* Ãp dá»¥ng cho cáº£ 3 LÃ´ (Balo) */
    background: #3a3a45 !important; 
    border-color: #555 !important;
}

/* 3. Chá»‰nh mÃ u ná»n cho cÃ¡c Tháº» bao bÃªn ngoÃ i (Card) khi tá»‘i */
body.dark-mode .shop-item, 
body.dark-mode .pet-shop-item,
body.dark-mode .inventory-item {
    background: #2c2c35 !important;
    border-color: #444 !important;
    color: #e0e0e0 !important;
}

/* 4. Chá»‰nh mÃ u chá»¯ phá»¥ (giÃ¡ tiá»n, sá»‘ lÆ°á»£ng) cho dá»… Ä‘á»c khi tá»‘i */
body.dark-mode .shop-item div[style*="color:var(--text-muted)"],
body.dark-mode .shop-item div[style*="color: var(--text-muted)"],
body.dark-mode .inventory-qty {
    color: #bdbdbd !important;
}
/* --- FIX Lá»–I HIá»‚N THá»Š BALO KHI DARK MODE --- */

/* 1. Chuyá»ƒn mÃ u thanh hiá»ƒn thá»‹ tiá»n (Ä‘ang bá»‹ cá»©ng mÃ u #FFF3E0) sang mÃ u tá»‘i */
body.dark-mode #inventory-box div[style*="background: #FFF3E0"],
body.dark-mode #inventory-box div[style*="background:#FFF3E0"] {
    background: #2c2c35 !important;
    border-color: #555 !important;
}

/* 2. Chuyá»ƒn mÃ u chá»¯ Äáº­u/LÃ¡ bÃªn trong thanh Ä‘Ã³ cho dá»… Ä‘á»c */
body.dark-mode #inventory-box div[style*="color:#795548"],
body.dark-mode #inventory-box div[style*="color:#E65100"] {
    color: #bdbdbd !important;
}

/* 3. Chuyá»ƒn mÃ u tiÃªu Ä‘á» "3 LÃ´" */
body.dark-mode #inventory-box h3 {
    color: #81c784 !important;
    border-bottom-color: #555 !important;
}
</style>
</head>
<body>
<div class="modal-overlay" id="global-overlay"></div> 

<div class="app-wrapper"> 

<button id="menu-btn" onclick="toggleHeader()">â—€</button>

<header id="main-header">
  <div class="brand">
    <div id="player-level-display">ğŸŒ¾ Farm LOL ğŸŒ¾</div>
    <div id="exp-bar-container">
    <div id="exp-fill"></div>
    <div id="exp-text-overlay">0 / 0</div>
</div>
  </div>
  <div class="controls">
    <button id="btn-new">ğŸ†• Táº¡o</button>
    <button id="btn-save" disabled>ğŸ’¾ LÆ°u</button>
    <button id="btn-delete" disabled>ğŸ—‘ï¸ XoÃ¡</button>
  </div>
</header>

<main>
  <img id="beanstalk-bg" src="1000000105.png" alt="Khu vÆ°á»n bÃªn há»“" />
  
  <img id="bee-guard" src="1000000144.gif" alt="Ong NÃ¹i Giáº»" onclick="showBeePopup()" />
  <img id="light-bulb" src="1000000123.gif" alt="BÃ³ng Ä‘Ã¨n" />
  
  <div id="pot-container">
        <div class="pot-slot" id="slot-1" data-slot="1">
        <img id="ice-egg-img" src="" alt="Trá»©ng NgÅ© Sáº¯c" style="display:none;" />
        
        <div id="incubator-icon" style="display:none;">ğŸ¦¢</div>
    </div>
    
    <div class="pot-slot" id="slot-2" data-slot="2">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" /> 
        <img id="seed-img-2" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-3" data-slot="3">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" />
        <img id="seed-img-3" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-6" data-slot="6" onclick="showFishingPrePopup()">
    <img src="1000000116.gif" alt="Em bÃ© cÃ¢u cÃ¡" style="pointer-events: none;" />
</div>
    
    <div class="pot-slot" id="slot-4" data-slot="4">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" />
        <img id="seed-img-4" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-5" data-slot="5">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" />
        <img id="seed-img-5" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-7" data-slot="7">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" />
        <img id="seed-img-7" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    <style>
  /* --- Cáº¬P NHáº¬T CSS DÃ‚Y LEO VÃ€ CHÃ‚U CHáº¤U --- */
  .vine-deco {
      position: absolute;
      width: 10px;       /* TÄƒng vÃ¹ng click lÃªn má»™t chÃºt cho dá»… báº¥m */
      height: auto;
      top: 195px;
      z-index: 4;
      cursor: pointer;   /* Hiá»ƒn thá»‹ bÃ n tay khi trá» vÃ o */
      pointer-events: auto; /* QUAN TRá»ŒNG: Cho phÃ©p click */
      opacity: 0.9;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
      transition: transform 0.1s;
  }
  .vine-deco:active { transform: scale(0.9); }
    /* --- CODE Má»šI: Hiá»‡u á»©ng Combo dÃ¢y leo --- */
  @keyframes gold-glow-blink {
      0% { filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5)); }
      50% { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 1)) brightness(1.2); }
      100% { filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5)); }
  }

  .vine-glowing {
      animation: gold-glow-blink 1.5s infinite ease-in-out !important;
      z-index: 5 !important; 
  }
  /* ---------------------------------------- */

  /* Class cho ChÃ¢u Cháº¥u */
  .hanging-grasshopper {
      position: absolute;
      width: 70px;       /* KÃ­ch thÆ°á»›c chÃ¢u cháº¥u */
      height: auto;
      top: 205px;        /* Náº±m ngay dÆ°á»›i dÃ¢y leo */
      z-index: 5;        /* Náº±m sau dÃ¢y leo má»™t xÃ­u cho tá»± nhiÃªn */
      pointer-events: auto; /* Cho phÃ©p click vÃ o con chÃ¢u cháº¥u */
      cursor: pointer;      /* Hiá»‡n bÃ n tay khi trá» vÃ o */
      /* ----------------------------------- */
      transform-origin: top center;
      animation: swing-grasshopper 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
      display: none;
  }

  @keyframes swing-grasshopper {
      0% { transform: rotate(3deg); }
      50% { transform: rotate(-3deg); }
      100% { transform: rotate(3deg); }
  }
    </style>

                <img src="1000000129.png" class="vine-deco" style="left: calc(50% - 87.5px);" data-index="0" />
    <img id="grasshopper-0" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% - 115px);" /> 

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% - 27.5px);" data-index="1" />
    <img id="grasshopper-1" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% - 55px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 32.5px);" data-index="2" />
    <img id="grasshopper-2" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 5px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 92.5px);" data-index="3" />
    <img id="grasshopper-3" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 65px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 152.5px);" data-index="4" />
    <img id="grasshopper-4" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 125px);" />
  </div>
  
    <div id="backpack-slot" onclick="openInventory()">
      <img src="1000000138.png" alt="3 LÃ´" />
  </div>

  <img id="giftcode-supply-drop" src="1000000143.png" alt="HÃ²m ThÃ­nh" onclick="showGiftcodePopup()" />
  <img id="kinto-cloud" src="1000000103.png" alt="CÃ¢n Äáº©u VÃ¢n" data-slot="0" />
  <img id="event-cloud" src="1000000131.png" alt="Sá»± Kiá»‡n" />
  <img id="pet-house" src="1000000100.png" alt="NhÃ  Pet" />
  
  <img id="chaos-blacksmith" src="1000000107.png" alt="Thá»£ RÃ¨n Chaos" />
  <img id="chaos-blacksmith-working" src="1000000101.gif" alt="Thá»£ RÃ¨n Äang LÃ m" style="display:none;" />
  
<div id="pet-container" style="position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); z-index: 7; pointer-events: none; width: 120px; height: 120px; display: flex; align-items: flex-end; justify-content: center;">
    <img id="pug-pet" src="" alt="ChÃº chÃ³ Pug" style="display:none; width: 100%; height: auto; cursor: pointer; transform-origin: bottom center; pointer-events: auto;" />
</div>
  <img id="bone-bowl" src="1000000115.png" alt="BÃ¡t Ä‘á»±ng xÆ°Æ¡ng" />
</main>

</div> 

<div id="name-box" style="display:none;">
    <h3>Xin chÃ o nÃ´ng dÃ¢n!</h3>
    <p style="color:var(--text-muted);">HÃ£y Ä‘áº·t má»™t cÃ¡i tÃªn tháº­t ngáº§u nhÃ©:</p>
    <input type="text" id="player-name" placeholder="VÃ­ dá»¥: Alice" maxlength="12"/>
    <button id="btn-next">Báº¯t Ä‘áº§u ngay &rarr;</button>
</div>

<div id="shop-box">
  <h3>â˜ï¸ Shop MÃ¢y</h3> 
  <div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
    <span style="font-size:1.1em; color:#795548;">ğŸ«˜</span> <b id="coin-dau-shop">0</b> &nbsp;|&nbsp; 
    <span style="font-size:1.1em; color:#E65100;">ğŸ‚</span> <b id="coin-la-shop">0</b>
  </div>
  
  <div id="shop-tab-container-wrapper"></div>
  
  <button onclick="hidePopup('shop-box')" class="btn-close">ÄÃ³ng</button>
</div>

<div id="seed-box">
<h3>ğŸŒ± Shop Háº¡t Giá»‘ng</h3> 
<div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
  <span style="font-size:1.1em; color:#795548;">ğŸ«˜</span> <b id="coin-dau-seed">0</b> &nbsp;|&nbsp; 
  <span style="font-size:1.1em; color:#E65100;">ğŸ‚</span> <b id="coin-la-seed">0</b>
</div>

<div id="seed-items" style="display:grid; grid-template-columns: 1fr; gap:10px; max-height: 400px; overflow-y: auto;"></div>
<button onclick="hidePopup('seed-box')" class="btn-close">ÄÃ³ng</button>
</div>

<div id="online-box">
  <h3 style="color:#E64A19;">ğŸ HÃ²m ThÃ­nh</h3>
  <p style="color:#795548; font-size:0.9em; margin-bottom:5px;">
      Nháº­p mÃ£ <b>Giftcode</b> Ä‘á»ƒ nháº­n quÃ  bÃ­ máº­t:
  </p>
  
  <input type="text" id="giftcode-input" placeholder="NHáº¬P MÃƒ Táº I ÄÃ‚Y" maxlength="15">
  
  <button onclick="handleGiftcode()" class="btn-buy" style="
      background: linear-gradient(45deg, #FF5722, #F4511E); 
      font-size: 1.1em; 
      padding: 10px; 
      margin-bottom: 10px;
      box-shadow: 0 4px 0 #D84315;">
    Má»Ÿ QuÃ  Ngay
  </button>

  <button onclick="hidePopup('online-box')" class="btn-close">ÄÃ³ng</button>
</div>

<div id="pet-house-box">
  <h3 id="pet-house-title">ğŸ¾ NhÃ  Pet</h3> 
  <div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
      <span style="font-size:1.1em; color:#795548;">ğŸ«˜</span> <b id="coin-dau-pet">0</b> &nbsp;|&nbsp; 
      <span style="font-size:1.1em; color:#E65100;">ğŸ‚</span> <b id="coin-la-pet">0</b>
  </div>
  <div id="pet-shop-items"></div>
  <button onclick="hidePopup('pet-house-box')" class="btn-close">ÄÃ³ng</button>
</div>

<div id="interaction-popup">
    <h3 id="interaction-title"></h3> 
    <div id="interaction-text" style="min-height: 50px; font-size: 0.95em; line-height: 1.5;"></div>
    <div id="interaction-controls" style="margin-top: 15px;"></div>
    <button onclick="closeInteractionPopup()" class="btn-close" style="margin-top: 20px;">ÄÃ³ng</button>
</div>

<div id="inventory-box">
    <h3 style="text-align:center; color:#5D4037; margin-top:0; border-bottom: 2px dashed #ddd; padding-bottom: 10px;">
        ğŸ’ 3 LÃ´
    </h3>
    
    <div style="background: #FFF3E0; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; border: 1px solid #FFE0B2;">
        <div style="color:#795548; font-weight:bold;">
            ğŸ«˜ Äáº­u: <span id="inv-dau" style="color:#D84315; font-size:1.1em;">0</span>
        </div>
        <div style="border-left: 2px solid #ccc; height: 20px;"></div>
        <div style="color:#E65100; font-weight:bold;">
            ğŸ‚ LÃ¡: <span id="inv-la" style="color:#D84315; font-size:1.1em;">0</span>
        </div>
    </div>

    <div id="inventory-list" style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
        <div style="text-align:center; color:#999; margin-top:20px;">Äang táº£i dá»¯ liá»‡u...</div>
    </div>

    <button onclick="hidePopup('inventory-box')" class="btn-close" style="width:100%; margin-top:15px; background:#f44336; color:white; border:none; padding:10px; border-radius:20px; font-weight:bold; cursor:pointer;">
        ÄÃ³ng
    </button>
</div>
<div id="fishing-popup" class="shop-box" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: #E3F2FD; width: 90%; max-width: 350px; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000; text-align: center; border: 4px solid #2196F3; display: none; opacity: 0; transition: all 0.3s;">
    
    <h3 style="color:#1565C0; margin: 0 0 10px 0;">ğŸ£ ÄÃ¬a CÃ¡ Dá»“</h3>
    
    <div id="fishing-waiting">
        <div id="fishing-start-ui">
            <p style="color:#555; font-size:0.9em;">DÃ¹ng <b>x1 Nhá»™ng Ong</b> <img src="1000000145.png" width="15" style="vertical-align:middle;"> Ä‘á»ƒ cÃ¢u.</p>
            <div style="background:rgba(255,255,255,0.5); padding:10px; border-radius:10px; margin:10px 0; font-size:0.85em; color:#37474F;">
                ğŸŸ CÃ¡ TrÃª (50%)<br>ğŸ¦ˆ CÃ¡ Dá»“ (30%)<br>ğŸ  CÃ¡ Tai TÆ°á»£ng (20%)
            </div>
            <button id="btn-start-fishing" style="background:#29B6F6; color:white; border:none; padding:12px 20px; border-radius:25px; font-weight:bold; font-size:1em; cursor:pointer; box-shadow: 0 4px 0 #0288D1; width:100%;">
                QuÄƒng Cáº§n Ngay!
            </button>
        </div>
        
        <div id="fishing-waiting-anim" style="display:none;">
            <div class="fishing-float-anim">ğŸŒŠğŸ£ğŸŒŠ</div>
            <p style="color:#0277BD; font-weight:bold;">Äang Ä‘á»£i cÃ¡ cáº¯n cÃ¢u...</p>
            <div id="fishing-countdown" style="font-size:3em; font-weight:900; color:#FF9800;">5</div>
        </div>
    </div>

    <div id="fishing-game-area">
        <div id="fishing-bar-container">
            <div id="zone-green"></div> <div id="zone-red"></div>   <div id="fishing-bobber"></div> </div>
        
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div style="font-size:0.7em; font-weight:bold; color:#E65100; margin-bottom:5px;">Báº®T!</div>
            <div id="catch-progress-container">
                <div id="catch-progress-fill"></div>
            </div>
        </div>
        
        <div id="fishing-timer">10s</div>
    </div>
    
    <div id="fishing-guide-text" style="font-size:0.85em; color:#555; margin-top:10px; display:none;">
        ğŸ‘† <b>NHáº¤P LIÃŠN Tá»¤C</b> Ä‘á»ƒ giá»¯ thanh xÃ¡m á»Ÿ vÃ¹ng Xanh!
    </div>

    <button onclick="closeFishingPopup()" style="margin-top:15px; background:#ef5350; color:white; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; width:100%; cursor:pointer;">ThoÃ¡t</button>
</div>
<script>
// --- Cáº¤U HÃŒNH THá»œI GIAN GAME (CHá»ˆNH Táº I ÄÃ‚Y) ---
const GAME_CONFIG = {
    // Thá»i gian áº¥p trá»©ng (Máº·c Ä‘á»‹nh: 24 * 60 * 60 * 1000 lÃ  24 giá»)
    // Äá»ƒ test nhanh, báº¡n sá»­a thÃ nh: 10 * 1000 (10 giÃ¢y)
    HATCH_TIME: 24 * 60 * 60 * 1000, 
    
    // Thá»i gian nÃ¢ng cáº¥p Pet (Máº·c Ä‘á»‹nh: 24 giá»)
    UPGRADE_TIME: 24 * 60 * 60 * 1000 
};
// --- LOGIC SCALING (GIá»® NGUYÃŠN) ---
function adjustAppWrapperScale() {
    const appWrapper = document.querySelector(".app-wrapper");
    if (!appWrapper) return;
    const designWidth = 400; const designHeight = 750; 
    const viewportWidth = window.innerWidth; const viewportHeight = window.innerHeight;
    
    const scaleX = viewportWidth / designWidth; 
    const scaleY = viewportHeight / designHeight;
    let scale = Math.min(scaleX, scaleY);
    const MAX_SCALE = 1.1; 
    scale = Math.min(scale, MAX_SCALE);
    
    appWrapper.style.transform = `scale(${scale})`;
    
    if (viewportHeight > designHeight * scale) { 
        const scaledHeight = designHeight * scale;
        const marginTop = (viewportHeight - scaledHeight) / 2;
        appWrapper.style.marginTop = `${marginTop}px`; appWrapper.style.marginBottom = `${marginTop}px`;
    } else { appWrapper.style.marginTop = '0'; appWrapper.style.marginBottom = '0'; }
}
window.addEventListener('resize', adjustAppWrapperScale);

function toggleHeader() {
    const header = document.getElementById('main-header');
    const btn = document.getElementById('menu-btn');
    header.classList.toggle('collapsed');
    if (header.classList.contains('collapsed')) { btn.innerHTML = 'âš™ï¸'; } else { btn.innerHTML = 'â—€'; }
}

let playerName = "NÃ´ng dÃ¢n";
let farmIcon = "ğŸŒ¾";
let level = 0;
let exp = 0;
let dau = 0; 
let la = 0;
let usedGiftcodes = []; // LÆ°u danh sÃ¡ch mÃ£ Ä‘Ã£ dÃ¹ng
// --- DANH SÃCH MÃƒ GIFTCODE ÄANG HOáº T Äá»˜NG ---
// Báº¡n thÃªm code má»›i vÃ o trong ngoáº·c nÃ y, vÃ­ dá»¥: ["FARMLOL", "NAMMOI", "TET2026"]
const ACTIVE_GIFTCODES = ["FARMLOL"];
// --- THÃŠM BIáº¾N QUáº¢N LÃ TRANG TRÃ ---
let vineDecorations = [null, null, null, null, null]; // 5 vá»‹ trÃ­ dÃ¢y leo, null = trá»‘ng
let tool = { name: "Xáº»ng Gá»—", power: 1, maxHP: 100, currentHP: 100 };
let ownedDecorations = { 'chau_chau': 0 }; // Kho chá»©a Ä‘á»“ trang trÃ­
let hasIceEgg = false; 
let isIceDragonHatched = false; 
let isIceDragonEvolved = false; 
let hatchedPetType = "thien_than"; // BIáº¾N Má»šI: LÆ¯U LOáº I PET ÄÃƒ áº¤P (thien_than HOáº¶C than_chet)
let activePet = null;
let incubationFinishTime = 0; // Thá»i gian káº¿t thÃºc áº¥p trá»©ng
let ownedPets = []; 
let ownedSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0, 'hat_tinh_yeu': 0 };
let globalPetAge = 0;
let petLevels = { 'thien_than': 1, 'than_chet': 1 }; // LÆ°u cáº¥p sao riÃªng
// --- KHAI BÃO KHO Váº¬T PHáº¨M Äáº¶C BIá»†T (Má»šI) ---
let petStarLevel = 1; // Biáº¿n lÆ°u cáº¥p Ä‘á»™ sao cá»§a Pet
let ownedArtifacts = { 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0 };
let grasshopperExchanged = 0; // Biáº¿n theo dÃµi sá»‘ láº§n Ä‘Ã£ Ä‘á»•i (Tá»‘i Ä‘a 5)
let isHarvesting = false; // Biáº¿n chá»‘ng click Ä‘Ãºp khi thu hoáº¡ch
// --- THÃŠM: Cáº¤U HÃŒNH DANH SÃCH Váº¬T PHáº¨M TREO ---
// ÄÃ¢y lÃ  danh sÃ¡ch Ä‘á»‹nh nghÄ©a tÃªn, áº£nh vÃ  giÃ¡ cá»§a cÃ¡c mÃ³n Ä‘á»“ treo
const HANGING_ITEMS_CONFIG = [
    { 
        id: 'chau_chau', name: 'ChÃ¢u Cháº¥u', img: '1000000130.gif', price: 100,
        style: { width: '50px', top: '205px', marginLeft: '7px' } 
    },
    { 
        id: 'treo_con_ca', name: 'Con CÃ¡', img: '1000000139.gif', price: 100,
        style: { width: '50px', top: '205px', marginLeft: '8px' }
    },
    { 
        id: 'treo_long_den', name: 'Lá»“ng ÄÃ¨n', img: '1000000140.gif', price: 100,
        style: { width: '45px', top: '202px', marginLeft: '7px' }
    },
    { 
        id: 'treo_trai_chau', name: 'TrÃ¡i ChÃ¢u', img: '1000000141.gif', price: 100,
        style: { width: '45px', top: '210px', marginLeft: '9px' }
    },
    { 
        id: 'treo_chong_chong', name: 'Chong ChÃ³ng', img: '1000000142.gif', price: 100,
        style: { width: '130px', top: '200px', marginLeft: '-32px' }
    }
];
// Cáº¥u hÃ¬nh váº­t pháº©m rá»›t khi thu hoáº¡ch
const HARVEST_DROPS = {
    'hat_nguyen_to': { id: 'manh_nguyen_to', name: 'Máº£nh NguyÃªn Tá»‘', img: '1000000135.png' },
    'hat_kim_loai': { id: 'manh_kim_loai', name: 'Máº£nh Kim Loáº¡i', img: '1000000136.png' },
    'hat_tinh_yeu': { id: 'vuong_mien', name: 'VÆ°Æ¡ng Miá»‡n', img: '1000000137.png' }
};
let lastFedTime = 0;
let lastBeePokeTime = 0; // Biáº¿n lÆ°u thá»i gian láº§n cuá»‘i thá»c ong
let activePopupInterval = null;

// --- 1. Cáº¬P NHáº¬T DANH SÃCH CHáº¬U ---
let ownedPots = { 
    'so_dua': 0, 'chau_dong': 0, 
    'chau_bac': 0, 'chau_vang': 0, 
    'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 
}; 
let craftingQueue = []; 

const POT_DEFINITIONS = {
    'so_dua': { name: "Sá» Dá»«a", img: "1000000112.png", expBonus: 0 },
    'chau_dong': { name: "Cháº­u Äá»“ng", img: "1000000117.png", expBonus: 1 },
    'chau_bac': { name: "Cháº­u Báº¡c", img: "1000000118.png", expBonus: 2 },
    'chau_vang': { name: "Cháº­u VÃ ng", img: "1000000119.png", expBonus: 3 },
    'chau_bach_kim': { name: "Cháº­u BK", img: "1000000120.png", expBonus: 4 }, // ÄÃ£ sá»­a tÃªn
    'chau_kim_cuong': { name: "Cháº­u KC", img: "1000000121.png", expBonus: 5 }, // ÄÃ£ sá»­a tÃªn
    'chau_kim_cuong_do': { name: "Cháº­u KCÄ", img: "1000000122.png", expBonus: 6 } // ÄÃ£ sá»­a tÃªn
};

// --- 2. Cáº¬P NHáº¬T CÃ”NG THá»¨C RÃˆN (ÄÃƒ CHá»ˆNH Sá»¬A: DÃ™NG Máº¢NH KIM LOáº I) ---
const CRAFTING_RECIPES = [
    {
        id: 'craft_so_dua',
        output: 'so_dua',
        name: 'Sá» Dá»«a',
        icon: '1000000112.png',
        duration: 0,
        cost: { dau: 1000 }, 
        materials: {} 
    },
    {
        id: 'craft_chau_dong',
        output: 'chau_dong',
        name: 'Cháº­u Äá»“ng',
        icon: '1000000117.png',
        duration: 2 * 60 * 60 * 1000, 
        cost: { dau: 2000 },
        materials: { 'so_dua': 1, 'manh_kim_loai': 20 }
    },
    {
        id: 'craft_chau_bac',
        output: 'chau_bac',
        name: 'Cháº­u Báº¡c',
        icon: '1000000118.png',
        duration: 3 * 60 * 60 * 1000, 
        cost: { dau: 3000 },
        materials: { 'chau_dong': 1, 'manh_kim_loai': 30 }
    },
    {
        id: 'craft_chau_vang',
        output: 'chau_vang',
        name: 'Cháº­u VÃ ng',
        icon: '1000000119.png',
        duration: 4 * 60 * 60 * 1000, 
        cost: { dau: 4000 },
        materials: { 'chau_bac': 1, 'manh_kim_loai': 40 }
    },
    {
        id: 'craft_chau_bach_kim',
        output: 'chau_bach_kim',
        name: 'Cháº­u BK', // ÄÃ£ sá»­a tÃªn
        icon: '1000000120.png',
        duration: 5 * 60 * 60 * 1000, 
        cost: { dau: 5000 },
        materials: { 'chau_vang': 1, 'manh_kim_loai': 50 }
    },
    {
        id: 'craft_chau_kim_cuong',
        output: 'chau_kim_cuong',
        name: 'Cháº­u KC', // ÄÃ£ sá»­a tÃªn
        icon: '1000000121.png',
        duration: 6 * 60 * 60 * 1000, 
        cost: { dau: 6000 },
        materials: { 'chau_bach_kim': 1, 'manh_kim_loai': 60 }
    },
    {
        id: 'craft_chau_kim_cuong_do',
        output: 'chau_kim_cuong_do',
        name: 'Cháº­u KCÄ', // ÄÃ£ sá»­a tÃªn
        icon: '1000000122.png',
        duration: 7 * 60 * 60 * 1000, 
        cost: { dau: 7000 },
        materials: { 'chau_kim_cuong': 1, 'manh_kim_loai': 70 }
    }
];

const FARM_IDS = [2, 3, 4, 5, 7]; 
let farmSlots = Array(5).fill(null); 
let equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua']; 

// --- ÄÃƒ CHá»ˆNH Sá»¬A Vá»Š TRÃ PET ---
let petShopItems = [
    // 1. Choco: Size nhá» (50px) -> CÄƒn giá»¯a (-25px) -> Äá»©ng cao hÆ¡n xÃ­u (50px)
    { 
        id: 100, 
        name: "Choco", 
        price: 0, 
        currency: "dau", 
        type: "pet", 
        icon: "1000000128.gif", 
        value: "1000000128.gif", 
        customWidth: "50px", 
        position: { bottom: '50px', left: 'calc(50% - 25px)' }, 
    },
    
    // 2. Pug PÃ©o: Size vá»«a (80px) -> CÄƒn giá»¯a (-40px) -> Äá»©ng chuáº©n (40px)
    { 
        id: 101, 
        name: "Pug PÃ©o", 
        price: 100, 
        currency: "la", 
        type: "pet", 
        icon: "1000000106.png", 
        value: "1000000106.png", 
        customWidth: "80px", 
        position: { bottom: '40px', left: 'calc(50% - 40px)' }, 
    },

    // 3. Mr. Gold: Size to (100px) -> CÄƒn giá»¯a (-50px) -> Äá»©ng tháº¥p do chÃ¢n to (35px)
    { 
        id: 102, 
        name: "Mr. Gold", 
        price: 100, 
        currency: "la", 
        type: "pet", 
        icon: "1000000108.gif", 
        value: "1000000108.gif", 
        customWidth: "100px", 
        position: { bottom: '35px', left: 'calc(50% - 50px)' }, 
    },
];

// --- DANH SÃCH SHOP ---
let shopItems = [
    // 1. ThÃªm BI GAI vÃ o Ä‘áº§u danh sÃ¡ch (GiÃ¡ 0 Ä‘á»ƒ Ä‘Ã¡nh dáº¥u lÃ  Pet khá»Ÿi Ä‘áº§u)
    { id: 201, name: "Bi Gai", price: 0, currency: "dau", type: "pet", icon: "1000000149.gif", value: "1000000149.gif", category: "pet_may" },

    // 2. Giá»¯ nguyÃªn ThiÃªn Tháº§n vÃ  Tháº§n Cháº¿t (Váº«n bÃ¡n trong Shop)
    { id: 202, name: "ThiÃªn Tháº§n", price: 100, currency: "la", type: "pet", icon: "1000000127.gif", value: "1000000127.gif", category: "pet_may" },
    { id: 203, name: "Tháº§n Cháº¿t",  price: 100, currency: "la", type: "pet", icon: "1000000104.gif", value: "1000000104.gif", category: "pet_may" },
    
    // CÃ¡c loáº¡i háº¡t giá»‘ng giá»¯ nguyÃªn
    { id: 204, name: "Háº¡t NguyÃªn Tá»‘", price: 100, currency: "dau", type: "seed", icon: "1000000125.png", value: "hat_nguyen_to", category: "hat_may" }, 
    { id: 205, name: "Háº¡t Kim Loáº¡i",  price: 100, currency: "dau", type: "seed", icon: "1000000126.png", value: "hat_kim_loai", category: "hat_may" },
    { id: 206, name: "Háº¡t TÃ¬nh YÃªu",  price: 100, currency: "dau", type: "seed", icon: "1000000132.png", value: "hat_tinh_yeu", category: "hat_may" },
];

// --- Cáº¬P NHáº¬T THá»œI GIAN TRá»’NG CÃ‚Y (0h - 6h - 12h) ---
const PLANT_STAGES = [
    { 
        name: "Máº§m Nhá»", 
        icon: "1000000110.gif", 
        duration: 0, 
    }, 
    { 
        name: "CÃ¢y TrÆ°á»Ÿng ThÃ nh", 
        icon: "1000000130.gif", 
        // Giai Ä‘oáº¡n Máº§m Nhá» kÃ©o dÃ i 6 giá»
        // 6 giá» * 60 phÃºt * 60 giÃ¢y * 1000 ms
        duration: 6 * 60 * 60 * 1000, 
    }, 
    { 
        name: "Sáºµn SÃ ng Thu Hoáº¡ch", 
        icon: "1000000130.gif", 
        // Giai Ä‘oáº¡n CÃ¢y TrÆ°á»Ÿng ThÃ nh kÃ©o dÃ i 6 giá» (tá»•ng cá»™ng 12 giá» tá»« lÃºc trá»“ng Ä‘á»ƒ thu hoáº¡ch)
        duration: 6* 60 * 60 * 1000, 
    }, 
];

function showPopup(id) {
    document.getElementById('global-overlay').style.display = 'block';
    const el = document.getElementById(id);
    if(el) el.classList.add('popup-active');
}
function hidePopup(id) {
    const el = document.getElementById(id);
    if(el) el.classList.remove('popup-active');
    setTimeout(() => {
        if(!document.querySelector('.popup-active')) {
            document.getElementById('global-overlay').style.display = 'none';
        }
    }, 100); 
}
// --- HÃ€M HIá»‚N THá»Š THÃ”NG BÃO TOAST (Báº¢N PRO) ---
function showToast(message, icon = "âœ…", title = "ThÃ´ng bÃ¡o") {
    let toast = document.getElementById('toast-notification');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        document.body.appendChild(toast);
    }

    // Cáº¥u trÃºc HTML má»›i: Icon + TiÃªu Ä‘á» + Ná»™i dung
    toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
    `;

    toast.classList.remove('show');
    void toast.offsetWidth; // Reset animation
    toast.classList.add('show');

    setTimeout(() => {
        if (toast.classList.contains('show')) {
            toast.classList.remove('show');
        }
    }, 3500); // Hiá»‡n lÃ¢u hÆ¡n xÃ­u (3.5s) Ä‘á»ƒ ká»‹p Ä‘á»c
}

// --- HÃ€M Cáº¬P NHáº¬T HÃŒNH áº¢NH THá»¢ RÃˆN (Má»šI) ---
function updateBlacksmithVisuals() {
    const idleImg = document.getElementById('chaos-blacksmith');
    const workingImg = document.getElementById('chaos-blacksmith-working');
    
    // Kiá»ƒm tra biáº¿n craftingQueue (hÃ ng chá» rÃ¨n)
    if (craftingQueue && craftingQueue.length > 0) {
        // Äang báº­n: áº¨n áº£nh tÄ©nh, Hiá»‡n áº£nh Ä‘á»™ng
        if(idleImg) idleImg.style.display = 'none';
        if(workingImg) workingImg.style.display = 'block';
    } else {
        // Äang ráº£nh: Hiá»‡n áº£nh tÄ©nh, áº¨n áº£nh Ä‘á»™ng
        if(idleImg) idleImg.style.display = 'block';
        if(workingImg) workingImg.style.display = 'none';
    }
}

const body = document.body; 
const btnNew = document.getElementById("btn-new");
const btnDelete = document.getElementById("btn-delete"); 
const btnSave = document.getElementById("btn-save");  
const lightBulb = document.getElementById("light-bulb"); 
const nameBox = document.getElementById("name-box");
const btnNext = document.getElementById("btn-next");
const nameInput = document.getElementById("player-name");
const shopBox = document.getElementById("shop-box");
const playerLevelDisplay = document.getElementById("player-level-display");
const expBarContainer = document.getElementById("exp-bar-container");
const expFill = document.getElementById("exp-fill");
const coinDauShop = document.getElementById("coin-dau-shop"); 
const coinLaShop = document.getElementById("coin-la-shop");   
const coinDauPet = document.getElementById("coin-dau-pet");   
const coinLaPet = document.getElementById("coin-la-pet");     
const seedBox = document.getElementById("seed-box"); 
const coinDauSeed = document.getElementById("coin-dau-seed"); 
const coinLaSeed = document.getElementById("coin-la-seed");   
const seedItemsContainer = document.getElementById("seed-items"); 
const onlineBox = document.getElementById("online-box");
const petHouseBox = document.getElementById("pet-house-box");
const petHouseTitle = document.getElementById("pet-house-title"); 
const petShopItemsContainer = document.getElementById("pet-shop-items"); 
const interactionPopup = document.getElementById("interaction-popup"); 
const interactionTitle = document.getElementById("interaction-title"); 
const interactionText = document.getElementById("interaction-text"); 
const interactionControls = document.getElementById("interaction-controls"); 
const pugPetImg = document.getElementById("pug-pet"); 
const iceEggImg = document.getElementById("ice-egg-img"); 

let currentShopTab = 'pet_may';
let currentPetTab = 'cloud';

function expNeeded(lv){ return lv * 100; }

function checkLevelUp() {
    let leveledUp = false;
    while (level > 0 && exp >= expNeeded(level)) {
        exp -= expNeeded(level);
        level += 1;
        leveledUp = true;
    }
    if (leveledUp) { updateDisplay(); updateControlButtons(); }
}

function updateControlButtons(){
    const gameCreated = level > 0;
    btnNew.disabled = gameCreated;
    btnDelete.disabled = !gameCreated;
    btnSave.disabled = !gameCreated;
    
    if (playerLevelDisplay) playerLevelDisplay.innerHTML = gameCreated ? `${playerName} <span style="font-size:0.8em; color:#888;">|</span> Lv.${level}` : `ğŸŒ¾ Farm LOL ğŸŒ¾`;
    if (expBarContainer) expBarContainer.style.visibility = gameCreated ? 'visible' : 'hidden';
}

function isPetOwned(petValue) { return ownedPets.includes(petValue); }

function activatePet(petValue) {
    const angelData = shopItems.find(i => i.name === "ThiÃªn Tháº§n");
    const reaperData = shopItems.find(i => i.name === "Tháº§n Cháº¿t");

    if((angelData && petValue === angelData.value) || (reaperData && petValue === reaperData.value)) {
        alert("Pet nÃ y khÃ´ng thá»ƒ lÃ m Pet chÃ­nh. NÃ³ sáº½ á»Ÿ láº¡i Ã” sá»‘ 1 Ä‘á»ƒ báº£o vá»‡ nÃ´ng tráº¡i!");
        return;
    }
    activePet = petValue; updateDisplay(); alert(`ÄÃ£ kÃ­ch hoáº¡t Pet má»›i!`);
}

function updateDisplay(){
  if(level > 0 && expFill){
    const needed = expNeeded(level);
    const percent = Math.min(100, (exp / needed) * 100);

    // 1. Cáº­p nháº­t thanh mÃ u xanh (nhÆ° cÅ©)
    expFill.style.width = percent + "%";

    // 2. Cáº­p nháº­t con sá»‘ hiá»ƒn thá»‹ (Má»šI THÃŠM)
    const expText = document.getElementById('exp-text-overlay');
    if(expText) {
        // Hiá»ƒn thá»‹ dáº¡ng: EXP Hiá»‡n Táº¡i / EXP Cáº§n Thiáº¿t
        expText.innerText = `${Math.floor(exp)} / ${needed}`;
    }
}
// --- THÃŠM ÄOáº N NÃ€Y Äá»‚ HIá»†N/áº¨N THIÃŠN NGA ---
  const incubatorIcon = document.getElementById("incubator-icon");
  if (incubatorIcon) {
      // Chá»‰ hiá»‡n khi thá»i gian káº¿t thÃºc áº¥p > 0 (tá»©c lÃ  Ä‘ang áº¥p)
      if (incubationFinishTime > 0) {
          incubatorIcon.style.display = 'block';
      } else {
          incubatorIcon.style.display = 'none';
      }
  }
  const dauStr = dau.toLocaleString('vi-VN');
  const laStr = la.toLocaleString('vi-VN');

  if (coinDauShop) coinDauShop.textContent = dauStr;
  if (coinLaShop) coinLaShop.textContent = laStr;
  if (coinDauPet) coinDauPet.textContent = dauStr;
  if (coinLaPet) coinLaPet.textContent = laStr;
  if (coinDauSeed) coinDauSeed.textContent = dauStr;
  if (coinLaSeed) coinLaSeed.textContent = laStr;
  
  const angelData = shopItems.find(i => i.name === "ThiÃªn Tháº§n");
  const reaperData = shopItems.find(i => i.name === "Tháº§n Cháº¿t");
  const biGaiData = shopItems.find(i => i.name === "Bi Gai"); // <--- Má»šI: Láº¥y thÃ´ng tin Bi Gai
  
  // ... (giá»¯ nguyÃªn pháº§n code hiá»ƒn thá»‹ Slot 1 á»Ÿ giá»¯a náº¿u cÃ³) ...

    // --- Sá»¬A Lá»–I PET: DÃ¹ng container Ä‘á»ƒ Ä‘á»‹nh vá»‹ ---
    const petContainer = document.getElementById("pet-container");
    
    if (pugPetImg && petContainer) {
      // DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¢u lá»‡nh kiá»ƒm tra: Náº¿u KHÃ”NG PHáº¢I ThiÃªn Tháº§n, KHÃ”NG PHáº¢I Tháº§n Cháº¿t, vÃ  KHÃ”NG PHáº¢I Bi Gai thÃ¬ má»›i hiá»‡n dÆ°á»›i Ä‘áº¥t
      if (activePet && 
          !(angelData && activePet === angelData.value) && 
          !(reaperData && activePet === reaperData.value) &&
          !(biGaiData && activePet === biGaiData.value) // <--- Má»šI: Cháº·n Bi Gai hiá»‡n dÆ°á»›i Ä‘áº¥t
      ) { 
          pugPetImg.src = activePet;
          pugPetImg.style.display = 'block'; 
          
          // 1. Xá»­ lÃ½ hiá»‡u á»©ng thá»Ÿ
          if (activePet.includes("1000000106.png")) {
              pugPetImg.classList.add("pet-breathing-effect");
          } else {
              pugPetImg.classList.remove("pet-breathing-effect");
          }

          let petData = petShopItems.find(p => p.value === activePet);
          if (!petData) petData = shopItems.find(p => p.value === activePet);
          
          // 2. Xá»­ lÃ½ kÃ­ch thÆ°á»›c (Set vÃ o container)
          if (petData && petData.customWidth) {
              petContainer.style.width = petData.customWidth;
          } else {
              petContainer.style.width = "120px"; // Size máº·c Ä‘á»‹nh
          }

          // 3. Xá»­ lÃ½ vá»‹ trÃ­ (Set vÃ o container)
          if (petData && petData.position) {
              petContainer.style.bottom = petData.position.bottom;
              petContainer.style.left = petData.position.left;
              petContainer.style.transform = 'none'; // Bá» cÄƒn giá»¯a náº¿u Ä‘Ã£ cÃ³ vá»‹ trÃ­ cá»¥ thá»ƒ
          } else {
              petContainer.style.bottom = '35px';
              petContainer.style.left = '50%';
              petContainer.style.transform = 'translateX(-50%)'; // CÄƒn giá»¯a
          }
      } else {
          pugPetImg.src = "";
          pugPetImg.style.display = 'none';
          pugPetImg.classList.remove("pet-breathing-effect"); 
      }
  }
  // --- Sá»¬A Lá»–I SLOT 1: Cáº¬P NHáº¬T HÃŒNH áº¢NH & KÃCH THÆ¯á»šC CHUáº¨N ---
  const slot1Img = document.getElementById("ice-egg-img");
  
  if (slot1Img) {
      // 1. XÃ³a sáº¡ch cÃ¡c class Ä‘á»‹nh dáº¡ng cÅ© Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t
      slot1Img.classList.remove('fix-egg', 'fix-angel', 'fix-reaper', 'fix-bigai');

      // 2. TRÆ¯á»œNG Há»¢P: TRá»¨NG ÄÃƒ Ná» (ÄÃ£ cÃ³ Pet Há»™ Vá»‡)
      if (isIceDragonHatched) {
          slot1Img.style.display = 'block';
          slot1Img.classList.remove('egg-shaking'); 
          slot1Img.style.animation = "none"; 
          slot1Img.style.transform = "none"; 
          
          if (hatchedPetType === 'than_chet') {
              slot1Img.src = "1000000104.gif";
              slot1Img.classList.add('fix-reaper'); // Ãp dá»¥ng size Tháº§n Cháº¿t
          }
          else if (hatchedPetType === 'bi_gai') {
              slot1Img.src = "1000000149.gif";
              slot1Img.classList.add('fix-bigai');  // Ãp dá»¥ng size Bi Gai
          }
          else {
              slot1Img.src = "1000000127.gif"; 
              slot1Img.classList.add('fix-angel');  // Ãp dá»¥ng size ThiÃªn Tháº§n
          }
      } 
      
      // 3. TRÆ¯á»œNG Há»¢P: ÄANG LÃ€ QUáº¢ TRá»¨NG (ChÆ°a ná»Ÿ)
      else if (hasIceEgg) {
          slot1Img.style.display = 'block';
          slot1Img.src = "1000000102.png"; 
          slot1Img.classList.add('fix-egg'); // Ãp dá»¥ng size Trá»©ng

          if (incubationFinishTime > 0) {
             slot1Img.style.animation = "shake-egg 0.5s infinite"; 
          } else {
             slot1Img.style.animation = "none"; 
             slot1Img.style.transform = "none"; 
          }
      } 
      
      // 4. TRÆ¯á»œNG Há»¢P: KHÃ”NG CÃ“ GÃŒ
      else {
          slot1Img.style.display = 'none';
          slot1Img.src = "";
          slot1Img.style.animation = "none"; 
      }
  }

  FARM_IDS.forEach((slotId, index) => {
      const seedImg = document.getElementById(`seed-img-${slotId}`);
      const baseImg = document.querySelector(`#slot-${slotId} .pot-base-img`);
      const slotData = farmSlots[index];

      let potType = equippedPots[index] || 'so_dua';
      let potImgSrc = POT_DEFINITIONS[potType] ? POT_DEFINITIONS[potType].img : "1000000112.png";
      
      if (baseImg) baseImg.src = potImgSrc;

      if(seedImg && baseImg) {
          if(slotData) {
              let currentStage = PLANT_STAGES[slotData.stage];
              let useIcon = currentStage.icon; 
              
              if (slotData.stage === 1) { 
                  if (slotData.value === 'hat_kim_loai') useIcon = "1000000111.gif"; 
                  else if (slotData.value === 'hat_nguyen_to') useIcon = "1000000113.gif";
                  else if (slotData.value === 'hat_tinh_yeu') useIcon = "1000000133.gif";
              }
              else if (slotData.stage === 2) {
                   if (slotData.value === 'hat_kim_loai') useIcon = "1000000124.gif"; 
                   else if (slotData.value === 'hat_nguyen_to') useIcon = "1000000114.gif";
                   else if (slotData.value === 'hat_tinh_yeu') useIcon = "1000000134.gif";
              }

              // --- RESET CÃC CLASS CÅ¨ ---
              // Nhá»› xÃ³a cáº£ class 'medium-plant' má»›i thÃªm
              seedImg.classList.remove('big-plant', 'medium-plant', 'love-fix', 'shadow-green', 'shadow-metal', 'shadow-element');

              if (slotData.stage === 0) {
                  // 1. Máº§m nhá»: ThÃªm bÃ³ng xanh lÃ¡
                  seedImg.classList.add('shadow-green');
              } 
              else if (slotData.stage >= 1) {
                  // --- Sá»¬A LOGIC SIZE: TÃCH RIá»†NG STAGE 1 VÃ€ 2 ---
                  
                  // Náº¿u lÃ  Háº¡t TÃ¬nh YÃªu -> Ãp dá»¥ng fix mÃ u há»“ng vÃ  chia size theo giai Ä‘oáº¡n
                  if (slotData.value === 'hat_tinh_yeu') {
                      seedImg.classList.add('love-fix'); // LuÃ´n thÃªm class Ä‘á»ƒ cÃ³ mÃ u bÃ³ng há»“ng

                      if (slotData.stage === 1) {
                          // Giai Ä‘oáº¡n 1: DÃ¹ng class medium-plant Ä‘á»ƒ kÃ­ch hoáº¡t CSS nhá» báº¡n vá»«a thÃªm
                          seedImg.classList.add('medium-plant'); 
                      } else {
                          // Giai Ä‘oáº¡n 2 (Thu hoáº¡ch): DÃ¹ng class big-plant nhÆ° cÅ©
                          seedImg.classList.add('big-plant');
                      }
                  }
                  else {
                      // Vá»›i cÃ¡c cÃ¢y khÃ¡c (Kim Loáº¡i, NguyÃªn Tá»‘...)
                      if (slotData.stage === 1) {
                          seedImg.classList.add('medium-plant'); // Giai Ä‘oáº¡n 1: Size vá»«a (160%)
                      } else {
                          seedImg.classList.add('big-plant');    // Giai Ä‘oáº¡n 2: Size to (220%)
                      }
                  }

                  // --- ADD CLASS BÃ“NG (DÃ™NG CHUNG LOGIC TÃŠN, CSS Tá»° CHá»ˆNH) ---
                  if (slotData.value === 'hat_kim_loai') {
                      seedImg.classList.add('shadow-metal');
                  }
                  if (slotData.value === 'hat_nguyen_to') {
                      seedImg.classList.add('shadow-element');
                  }
              }

              seedImg.src = useIcon;
              seedImg.alt = slotData.name;
              seedImg.style.display = 'block';
              baseImg.style.opacity = '1';
          } else {
              seedImg.style.display = 'none';
              seedImg.src = "";
              seedImg.classList.remove('big-plant');
              baseImg.style.opacity = '1';
          }
      }
  });
// --- Cáº¬P NHáº¬T HIá»‚N THá»Š Váº¬T PHáº¨M TREO (ÄÃƒ Tá»I Æ¯U) ---
vineDecorations.forEach((itemId, index) => {
  const hangingEl = document.getElementById(`grasshopper-${index}`);
  if (hangingEl) {
      if (itemId) {
          const itemConfig = HANGING_ITEMS_CONFIG.find(i => i.id === itemId);
          if (itemConfig) {
              hangingEl.src = itemConfig.img;
              hangingEl.style.display = 'block';
              
              // Ãp dá»¥ng style tá»« config (Code gá»n hÆ¡n ráº¥t nhiá»u)
              if (itemConfig.style) {
                  hangingEl.style.width = itemConfig.style.width || '50px';
                  hangingEl.style.top = itemConfig.style.top || '205px';
                  hangingEl.style.marginLeft = itemConfig.style.marginLeft || '0px';
              }
              
              // Hiá»‡u á»©ng láº¯c lÆ°
              hangingEl.style.animation = 'swing-grasshopper 3s ease-in-out infinite';
          }
      } else {
          hangingEl.style.display = 'none';
      }
  }
});

  // --- CODE Má»šI: Báº­t sÃ¡ng dÃ¢y leo khi Ä‘á»§ 5 mÃ³n ---
  const isFullSet = vineDecorations.every(item => item !== null);
  const vineElements = document.querySelectorAll('.vine-deco');
  
  vineElements.forEach(vine => {
      if (isFullSet) {
          vine.classList.add('vine-glowing');
      } else {
          vine.classList.remove('vine-glowing');
      }
  });
  // ----------------------------------------------
}
// --- ÄÃƒ Sá»¬A: HIá»‚N THá»Š KHO PET Äá»‚ Äá»”I VÃ€ Cáº¬P NHáº¬T NGAY ---
function showCloudPetInventory() {
    interactionTitle.innerHTML = "ğŸ¾ Kho Pet MÃ¢y";
    interactionText.innerHTML = "Chá»n Pet báº¡n muá»‘n Ä‘Æ°a ra báº£o vá»‡ nÃ´ng tráº¡i:";
    interactionControls.innerHTML = "";

    const container = document.createElement('div');
    container.style.cssText = "display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;";

    const guardianPets = [
        // ThÃªm dÃ²ng nÃ y:
        { type: 'bi_gai',     name: 'Bi Gai',     icon: '1000000149.gif', value: '1000000149.gif' },
        // Giá»¯ nguyÃªn 2 dÃ²ng cÅ©:
        { type: 'thien_than', name: 'ThiÃªn Tháº§n', icon: '1000000127.gif', value: '1000000127.gif' },
        { type: 'than_chet',  name: 'Tháº§n Cháº¿t',  icon: '1000000104.gif', value: '1000000104.gif' }
    ];

    let hasAny = false;

    guardianPets.forEach(p => {
        // Chá»‰ hiá»‡n nhá»¯ng con Ä‘Ã£ sá»Ÿ há»¯u
        if (isPetOwned(p.value)) {
            hasAny = true;
            // Kiá»ƒm tra xem con nÃ y cÃ³ pháº£i con Ä‘ang ná»Ÿ (active á»Ÿ slot 1) khÃ´ng
            const isCurrent = (hatchedPetType === p.type);
            
            // Láº¥y level riÃªng cá»§a con nÃ y
            const pLevel = petLevels[p.type] || 1;
            let stars = "";
            for(let i=0; i<pLevel; i++) stars += "â­";

            const itemDiv = document.createElement('div');
            itemDiv.className = "shop-item";
            itemDiv.style.borderColor = isCurrent ? "#4CAF50" : "#eee";
            itemDiv.style.background = isCurrent ? "#E8F5E9" : "#fff";

            itemDiv.innerHTML = `
                <img src="${p.icon}" style="width:50px; height:50px; object-fit:contain;">
                <div style="font-weight:bold; margin-top:5px; color:${isCurrent ? '#2E7D32' : '#333'}">${p.name}</div>
                <div style="font-size:0.8em; color:#FF9800;">${stars}</div>
                <button class="btn-select-pet" style="
                    margin-top:8px; width:100%; border:none; border-radius:15px; padding:5px;
                    background: ${isCurrent ? '#ccc' : 'var(--primary)'};
                    color: white; font-size: 0.8em; cursor: ${isCurrent ? 'default' : 'pointer'};
                ">
                    ${isCurrent ? 'Äang Chá»n' : 'Chá»n'}
                </button>
            `;

            if (!isCurrent) {
                itemDiv.querySelector('.btn-select-pet').onclick = () => {
                    // Logic Ä‘á»•i Pet
                    hatchedPetType = p.type;
                    petStarLevel = petLevels[p.type] || 1; // Cáº­p nháº­t láº¡i sao hiá»ƒn thá»‹ theo con má»›i Ä‘á»•i

                    // QUAN TRá»ŒNG: LÆ°u vÃ  Cáº­p nháº­t ngay láº­p tá»©c
                    saveGame();
                    updateDisplay(); // HÃ m nÃ y sáº½ Ä‘á»•i áº£nh á»Ÿ Slot 1 ngay láº­p tá»©c
                    
                    if(typeof showToast === 'function') {
                        showToast(`ÄÃ£ Ä‘á»•i sang ${p.name}`, "ğŸ”„", "ThÃ nh CÃ´ng");
                    } else {
                        alert(`ÄÃ£ Ä‘á»•i sang ${p.name}!`);
                    }
                    
                    closeInteractionPopup();

                    // Má»Ÿ láº¡i popup Slot 1 Ä‘á»ƒ tháº¥y thÃ´ng tin má»›i
                    setTimeout(() => { document.querySelector('#slot-1').click(); }, 300);
                };
            }
            container.appendChild(itemDiv);
        }
    });

    if(!hasAny) {
        container.innerHTML = "<div>Báº¡n chÆ°a cÃ³ Pet nÃ o.</div>";
    }

    interactionControls.appendChild(container);
    showPopup('interaction-popup');
}
// --- CODE Má»šI: showShopPopup ---
function showShopPopup() {
    const wrapper = document.getElementById('shop-tab-container-wrapper');
    if (!wrapper) return;
    wrapper.innerHTML = '';
    
    // Äáº·t máº·c Ä‘á»‹nh lÃ  háº¡t mÃ¢y Ä‘á»ƒ hiá»ƒn thá»‹ luÃ´n
    currentShopTab = 'hat_may'; 

    // Táº¡o tiÃªu Ä‘á» thay vÃ¬ Tab chá»n
    const title = document.createElement('div');
    title.style.cssText = "font-weight:bold; color:#795548; margin-bottom:10px; text-align:left; border-bottom:1px solid #eee; padding-bottom:5px;";
    title.innerHTML = "ğŸŒ± Danh sÃ¡ch Háº¡t Giá»‘ng";
    wrapper.appendChild(title);

    const contentContainer = document.createElement('div');
    contentContainer.id = 'shop-content-grid';
    contentContainer.style.cssText = 'max-height: 300px; overflow-y: auto; padding-right:5px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';
    wrapper.appendChild(contentContainer);

    renderShopItems(contentContainer);
    showPopup('shop-box');
}

function switchShopTab(tabName) {
    currentShopTab = tabName;
    showShopPopup();
}

// --- CODE Má»šI: renderShopItems ---
function renderShopItems(container) {
  container.innerHTML = "";
  // Chá»‰ hiá»ƒn thá»‹ háº¡t giá»‘ng trong tab nÃ y
  const itemsToRender = shopItems.filter(item => item.category === 'hat_may');

  itemsToRender.forEach(item => { 
      const itemDiv = document.createElement("div");
      itemDiv.className = "shop-item";
      
      const currencyIcon = item.currency === "dau" ? 'ğŸ«˜' : 'ğŸ‚';
      const currencyColor = item.currency === "dau" ? '#795548' : '#E65100'; 
      
      // Sá»¬A: ThÃªm class "icon-box-bg" vÃ  xÃ³a style background cá»©ng
      itemDiv.innerHTML = `
        <div class="icon-box-bg" style="
            width: 60px; 
            height: 60px; 
            border-radius: 50%;      
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 8px;
        ">
            <img src="${item.icon}" alt="${item.name}" style="
                width: 75%; 
                height: 75%; 
                object-fit: contain; 
                filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15));
            " />
        </div>
        <div style="font-weight:700; font-size:0.9em; color: var(--text-main); margin-bottom: 2px;">${item.name}</div>
        <div style="font-size:0.8em; color:var(--text-muted); margin-bottom: 5px;">
          <span style="color:${currencyColor};">${currencyIcon}</span> <b>${item.price.toLocaleString('vi-VN')}</b>
        </div>
        <button class="btn-buy" data-id="${item.id}" data-type="general">Mua</button>
      `;
      container.appendChild(itemDiv);
  });
  
  container.querySelectorAll(".btn-buy").forEach(btn => { 
      btn.addEventListener("click", handleBuy); 
  });
}

function updateShop(){
    if(document.getElementById('shop-box').classList.contains('popup-active')) {
        const container = document.getElementById('shop-content-grid');
        if(container) renderShopItems(container);
    }
}

// --- Sá»¬A Lá»–I: updatePetShop (ÄÃƒ FIX Lá»–I SAO) ---
function updatePetShop() {
    if (!petShopItemsContainer) return;
    petShopItemsContainer.innerHTML = "";
    petShopItemsContainer.style.display = "block"; 

    const cloudPets = shopItems.filter(i => i.name === "ThiÃªn Tháº§n" || i.name === "Tháº§n Cháº¿t" || i.name === "Bi Gai");
    const lamePets = petShopItems;

    const tabContainer = document.createElement("div");
    tabContainer.className = "tab-container"; 
    tabContainer.innerHTML = `
        <button class="tab-btn ${currentPetTab === 'cloud' ? 'active' : ''}" id="btn-tab-cloud">â˜ï¸ Pet MÃ¢y</button>
        <button class="tab-btn ${currentPetTab === 'lame' ? 'active' : ''}" id="btn-tab-lame">ğŸ• Pet Lá»</button>
    `;
    petShopItemsContainer.appendChild(tabContainer);

    tabContainer.querySelector("#btn-tab-cloud").onclick = () => { currentPetTab = 'cloud'; updatePetShop(); };
    tabContainer.querySelector("#btn-tab-lame").onclick = () => { currentPetTab = 'lame'; updatePetShop(); };

    const createPetHTML = (item, isCloudPet) => {
        const owned = isPetOwned(item.value); 
        let isActive = false;
        let starDisplay = ""; 
        let guardianType = "";

        if (isCloudPet) {
            if (item.name === "ThiÃªn Tháº§n") guardianType = 'thien_than';
            else if (item.name === "Tháº§n Cháº¿t") guardianType = 'than_chet';
            else if (item.name === "Bi Gai") guardianType = 'bi_gai';
            isActive = (hatchedPetType === guardianType);
            
            if (owned) {
                const pLevel = petLevels[guardianType] || 1;
                for(let i=0; i<pLevel; i++) starDisplay += "â­"; 
                starDisplay = `<div style="color:#FF9800; font-size:0.7em; margin-bottom:3px; height:15px;">${starDisplay}</div>`;
            } else { starDisplay = `<div style="height:15px;"></div>`; }
        } else {
            isActive = (item.value === activePet);
            starDisplay = `<div style="height:15px;"></div>`; 
        }

        const currencyIcon = item.currency === "la" ? 'ğŸ‚' : 'ğŸ«˜';
        const currencyColor = item.currency === "la" ? '#E65100' : '#795548';
        const priceDisplay = `<span style="font-size:0.8em; color:${currencyColor};">${currencyIcon}</span> ${item.price.toLocaleString('vi-VN')}`;

        let buttonHTML = '';
        if (!owned) {
            let buyType = isCloudPet ? "general" : "pet-shop-internal";
            buttonHTML = `<button class="btn-buy-pet" data-id="${item.id}" data-type="${buyType}" style="background:var(--primary);">Mua</button>`;
        } else if (isActive) {
            buttonHTML = `<button disabled style="background:#4CAF50; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%; opacity:0.8;">âœ… Äang DÃ¹ng</button>`;
        } else {
            buttonHTML = `<button class="btn-activate-pet" data-value="${item.value}" data-guardian="${isCloudPet ? guardianType : ''}" style="background:#2196F3; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%; cursor:pointer;">Chá»n</button>`;
        }

        const itemDiv = document.createElement("div");
        itemDiv.className = "pet-shop-item";
        
        // Sá»¬A: ThÃªm class "icon-box-bg" vÃ o tháº» div chá»©a áº£nh
        itemDiv.innerHTML = `
            <div class="icon-box-bg" style="width: 100%; height: 70px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; border-radius: 8px;">
                <img src="${item.icon}" alt="${item.name}" style="max-width: 80%; max-height: 80%; object-fit: contain; filter: drop-shadow(0 3px 3px rgba(0,0,0,0.1));" />
            </div>
            
            <div style="font-weight:700; font-size:0.95em; margin: 2px 0; color:var(--text-main); text-align:center; height: 20px; display: flex; align-items: center; justify-content: center;">
                ${item.name}
            </div>
            ${starDisplay}
            <div style="font-size:0.8em; margin-bottom:8px; height: 20px; display:flex; align-items:center;">
                ${owned ? '<span style="color:#4CAF50; font-weight:bold;">ÄÃ£ sá»Ÿ há»¯u</span>' : priceDisplay}
            </div>
            <div style="width:100%; margin-top: auto;">${buttonHTML}</div>
        `;
        return itemDiv;
    };

    const gridContainer = document.createElement("div");
    gridContainer.style.cssText = "display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;";

    if (currentPetTab === 'cloud') {
        gridContainer.appendChild(Object.assign(document.createElement("div"), {innerHTML: "(Há»™ Vá»‡: Báº£o vá»‡ nÃ´ng tráº¡i & Auto thu hoáº¡ch)", style: "grid-column: span 2; font-size: 0.8em; color: #1976D2; text-align: center; margin-bottom: 5px;"}));
        cloudPets.forEach(pet => gridContainer.appendChild(createPetHTML(pet, true)));
    } else {
        gridContainer.appendChild(Object.assign(document.createElement("div"), {innerHTML: "(Äi Dáº¡o: Cháº¡y lon ton cho vui & Táº·ng quÃ )", style: "grid-column: span 2; font-size: 0.8em; color: #E65100; text-align: center; margin-bottom: 5px;"}));
        lamePets.forEach(pet => gridContainer.appendChild(createPetHTML(pet, false)));
    }

    petShopItemsContainer.appendChild(gridContainer);
    petShopItemsContainer.querySelectorAll(".btn-buy-pet").forEach(btn => btn.addEventListener("click", handleBuy));
    petShopItemsContainer.querySelectorAll(".btn-activate-pet").forEach(btn => {
        btn.addEventListener("click", (e) => { 
            const val = e.target.getAttribute("data-value");
            const gType = e.target.getAttribute("data-guardian");
            if (gType) {
                hatchedPetType = gType; petStarLevel = petLevels[gType] || 1; 
                saveGame(); updateDisplay(); updatePetShop(); 
                if(typeof showToast === 'function') showToast("ÄÃ£ Ä‘á»•i Há»™ Vá»‡", "ğŸ›¡ï¸");
            } else { activatePet(val); updatePetShop(); }
        });
    });
}

function updateSeedShop() {
    if (!seedItemsContainer) return;
    seedItemsContainer.innerHTML = "";
    const seedShopMap = new Map();
    shopItems.filter(item => item.type === 'seed').forEach(item => seedShopMap.set(item.value, item));
    const ownedSeedValues = Object.keys(ownedSeeds).filter(key => seedShopMap.has(key));

    if(ownedSeedValues.length === 0 || Object.values(ownedSeeds).every(v => v === 0)) {
        seedItemsContainer.innerHTML = `<div style="text-align: center; color: var(--text-muted); margin: 20px 0;">Kho háº¡t giá»‘ng trá»‘ng.</div>`;
    }
    ownedSeedValues.forEach(seedValue => {
        const item = seedShopMap.get(seedValue);
        const ownedAmount = ownedSeeds[seedValue] || 0;
        if(ownedAmount === 0) return;
        
        const itemDiv = document.createElement("div");
        itemDiv.className = "shop-item";
        itemDiv.style.flexDirection = "row"; 
        
        const priceDisplay = `<span style="font-size:1em; color:#795548;">ğŸ«˜</span> ${item.price}`;
        
        itemDiv.innerHTML = `
            <div style="display:flex; align-items:center;">
                <img src="${item.icon}" style="width:50px; height:50px; margin-right:10px;" />
                <div style="text-align:left;">
                    <div style="font-weight:700;">${item.name}</div>
                    <div style="font-size:0.85em; color:var(--text-muted);">Äang cÃ³: <b>${ownedAmount}</b></div>
                </div>
            </div>
            <div style="text-align:right;">
                <button class="btn-buy" data-id="${item.id}" data-type="seed-shop-internal" style="width:auto; padding:6px 15px;">Mua thÃªm</button>
            </div>
        `;
        seedItemsContainer.appendChild(itemDiv);
    });
    document.querySelectorAll(".btn-buy[data-type='seed-shop-internal']").forEach(btn => { btn.addEventListener("click", handleBuy); });
    updateDisplay();
}

// --- LOGIC MUA HÃ€NG ---
function handleBuy(event) {
  const itemId = parseInt(event.target.getAttribute("data-id"));
  const itemType = event.target.getAttribute("data-type");
  let item = null;
  
  if (itemType === "general") item = shopItems.find(i => i.id === itemId);
  if (!item && itemType === "pet-shop-internal") item = petShopItems.find(i => i.id === itemId);
  if (!item && itemType === "seed-shop-internal") {
      item = shopItems.find(i => i.id === itemId && i.type === 'seed');
  }
  
  if (!item) return;
  
  // 1. MUA Háº T GIá»NG (Giá»¯ nguyÃªn)
  if (item.type === 'seed') {
      const currencyName = item.currency === 'la' ? 'LÃ¡' : 'Äáº­u';
      let quantityStr = prompt(`Báº¡n muá»‘n mua bao nhiÃªu ${item.name}?\n(GiÃ¡: ${item.price} ${currencyName}/háº¡t)`, "1");
      
      if (quantityStr === null) return;
      let quantity = parseInt(quantityStr);
      
      if (isNaN(quantity) || quantity <= 0) {
          alert("Sá»‘ lÆ°á»£ng khÃ´ng há»£p lá»‡!"); return;
      }
      
      let totalCost = item.price * quantity;
      let userMoney = (item.currency === 'la') ? la : dau;

      if (userMoney >= totalCost) {
          if (confirm(`Tá»•ng tiá»n lÃ  ${totalCost.toLocaleString('vi-VN')} ${currencyName}. Báº¡n cháº¯c cháº¯n muá»‘n mua ${quantity} háº¡t chá»©?`)) {
              if (item.currency === 'la') la -= totalCost;
              else dau -= totalCost;

              if (ownedSeeds[item.value] !== undefined) ownedSeeds[item.value] += quantity;
              else ownedSeeds[item.value] = quantity;
              
              alert(`ÄÃ£ mua thÃ nh cÃ´ng ${quantity}x ${item.name}!`);
              _saveGame(false);
              updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
          }
      } else {
          alert(`Báº¡n khÃ´ng Ä‘á»§ ${currencyName}! Cáº§n ${totalCost.toLocaleString('vi-VN')} ${currencyName}.`);
      }
      return; 
  }
  
  // 2. KIá»‚M TRA ÄÃƒ CÃ“ PET CHÆ¯A
  if (item.type === "pet" && isPetOwned(item.value)) { 
      alert(`${item.name} Ä‘Ã£ Ä‘Æ°á»£c sá»Ÿ há»¯u!`); return; 
  }

  // 3. LOGIC MUA PET/ITEM KHÃC
  let canBuy = false;
  if (item.currency === "dau" && dau >= item.price) { dau -= item.price; canBuy = true; } 
  else if (item.currency === "la" && la >= item.price) { la -= item.price; canBuy = true; }

  if (canBuy) {
    if (item.type === "tool") { 
        tool = item.value; alert(`Báº¡n Ä‘Ã£ trang bá»‹ ${item.name}!`); 
    } 
    else if (item.type === "pet") { 
        
        // KIá»‚M TRA: Náº¿u lÃ  Pet Há»™ Vá»‡ (Bi Gai, ThiÃªn Tháº§n, Tháº§n Cháº¿t)
        if (item.name === "ThiÃªn Tháº§n" || item.name === "Tháº§n Cháº¿t" || item.name === "Bi Gai") {
             
             // --- [Báº®T Äáº¦U Sá»¬A: CHáº¶N MUA Náº¾U ÄANG áº¤P] ---
             
             // Kiá»ƒm tra biáº¿n incubationFinishTime. Náº¿u > 0 nghÄ©a lÃ  Ä‘ang cÃ³ Ä‘á»“ng há»“ Ä‘áº¿m ngÆ°á»£c (Ä‘ang áº¥p hoáº·c nÃ¢ng cáº¥p)
             if (incubationFinishTime > 0) {
                 
                 // 1. HOÃ€N TIá»€N Láº I (VÃ¬ bÃªn trÃªn Ä‘Ã£ lá»¡ trá»« tiá»n rá»“i)
                 if (item.currency === "dau") {
                     dau += item.price;
                 } else {
                     la += item.price;
                 }
                 
                 // 2. Cáº­p nháº­t láº¡i giao diá»‡n Ä‘á»ƒ hiá»ƒn thá»‹ sá»‘ tiá»n Ä‘Ã£ hoÃ n
                 updateDisplay();

                 // 3. ThÃ´ng bÃ¡o cho ngÆ°á»i chÆ¡i
                 alert("ğŸš« Äang trong quÃ¡ trÃ¬nh áº¥p trá»©ng/nÃ¢ng cáº¥p!\nVui lÃ²ng Ä‘á»£i trá»©ng ná»Ÿ xong má»›i Ä‘Æ°á»£c mua Pet má»›i.");
                 
                 // 4. Dá»«ng hÃ m láº¡i ngay láº­p tá»©c, khÃ´ng cho cháº¡y tiáº¿p lá»‡nh bÃªn dÆ°á»›i
                 return; 
             }
             // --- [Káº¾T THÃšC Sá»¬A] ---

             // Náº¿u khÃ´ng báº­n áº¥p trá»©ng thÃ¬ cháº¡y logic mua bÃ¬nh thÆ°á»ng:
             ownedPets.push(item.value);

             // 1. XÃ¡c Ä‘á»‹nh loáº¡i vá»«a mua
             let newType = 'bi_gai'; // Máº·c Ä‘á»‹nh
             if (item.name === "ThiÃªn Tháº§n") newType = 'thien_than';
             if (item.name === "Tháº§n Cháº¿t") newType = 'than_chet';
             
             // 2. GÃ¡n lÃ m pet hiá»‡n táº¡i
             hatchedPetType = newType;
             
             // 3. Reset tráº¡ng thÃ¡i vá» Trá»©ng & Äang áº¤p
             isIceDragonHatched = false; 
             isIceDragonEvolved = false;
             
             // 4. Äáº·t thá»i gian áº¥p (Láº¥y tá»« CONFIG)
             incubationFinishTime = Date.now() + GAME_CONFIG.HATCH_TIME;

             // 5. ÄÃ¡nh dáº¥u lÃ  Ä‘ang cÃ³ trá»©ng
             hasIceEgg = true;

             alert(`ÄÃ£ mua ${item.name}! QuÃ¡ trÃ¬nh áº¥p trá»©ng (Slot 1) Ä‘Ã£ báº¯t Ä‘áº§u.`);
             
        } else {
             // TRÆ¯á»œNG Há»¢P: Mua Pet thÆ°á»ng (ChÃ³, MÃ¨o... - Pet Ä‘i dáº¡o)
             // Logic nÃ y giá»¯ nguyÃªn, khÃ´ng cáº§n cháº·n vÃ¬ Pet Ä‘i dáº¡o khÃ´ng áº£nh hÆ°á»Ÿng Slot 1
             ownedPets.push(item.value);
             activePet = item.value;
             alert(`Báº¡n Ä‘Ã£ mua Pet ${item.name}! Pet Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t!`);
        }
        
        if(itemType === "general") hidePopup('shop-box');
    }
    else if (item.type === "pot_base") {
        if (ownedPots[item.value] !== undefined) ownedPots[item.value] += 1;
        else ownedPots[item.value] = 1;
        alert(`Báº¡n Ä‘Ã£ mua 1x ${item.name}!`);
    }

    updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
  } else { alert("KhÃ´ng Ä‘á»§ Äáº­u hoáº·c LÃ¡!"); }
}

function handleNewGame(){
    showPopup('name-box');
    hidePopup('shop-box');
    hidePopup('online-box');
    hidePopup('pet-house-box'); 
    hidePopup('interaction-popup'); 
    hidePopup('seed-box'); 
}
btnNew.addEventListener('click', handleNewGame);

// --- BÆ¯á»šC 4: Táº O GAME Má»šI (Máº¶C Äá»ŠNH CÃ“ TRá»¨NG) ---
btnNext.addEventListener('click', () => {
    let inputName = nameInput.value.trim();
    const nameRegex = new RegExp(/^[\p{L}\p{N}]{2,12}$/u); 
    
    if (inputName.length < 2 || inputName.length > 12) {
        alert("TÃªn ngÆ°á»i chÆ¡i pháº£i tá»« 2 Ä‘áº¿n 12 kÃ½ tá»±!"); return;
    }
    if (!nameRegex.test(inputName)) {
        alert("TÃªn chá»‰ Ä‘Æ°á»£c chá»©a chá»¯ cÃ¡i vÃ  sá»‘!"); return;
    }
    
    playerName = inputName;
    hidePopup('name-box');
    farmIcon = "ğŸ "; 
    level = 1; exp = 0; 
    dau = 1000; la = 100; 
    
    activePet = "1000000128.gif"; 
    ownedPets = ["1000000128.gif"]; 

    // === QUAN TRá»ŒNG: Táº·ng trá»©ng máº·c Ä‘á»‹nh ===
    hasIceEgg = true; // CÃ³ trá»©ng ngay láº­p tá»©c
    // =======================================
    
    isIceDragonHatched = false; isIceDragonEvolved = false; hatchedPetType = "thien_than";
    ownedSeeds = { 'hat_nguyen_to': 1, 'hat_kim_loai': 1, 'hat_tinh_yeu': 1 };
    ownedPots = { 'so_dua': 0, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 }; 
    equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua']; 
    
    lastFedTime = 0; 
    lastBeePokeTime = 0; 
    farmSlots = Array(5).fill(null); 
    globalPetAge = 0;
    vineDecorations = [null, null, null, null, null]; 
    ownedDecorations = { 'chau_chau': 0 };
    ownedArtifacts = { 'manh_nguyen_to': 10000, 'manh_kim_loai': 10000, 'vuong_mien': 10000 };
    grasshopperExchanged = 0;  
    usedGiftcodes = [];        

    checkBeeHiveSpawn();      
    updateGiftcodeBoxState(); 
    updateDisplay(); 
    updateControlButtons();
    
    alert(`ChÃ o má»«ng ${playerName}!\nBáº¡n nháº­n Ä‘Æ°á»£c 01 TRá»¨NG NGÅ¨ Sáº®C miá»…n phÃ­ á»Ÿ Slot 1.`);
});

function loadGame(){
    const savedGame = localStorage.getItem('farmLolGame');
    if(savedGame){
        const gameData = JSON.parse(savedGame);
        
        // 1. Táº£i cÃ¡c chá»‰ sá»‘ cÆ¡ báº£n
        playerName = gameData.playerName; 
        farmIcon = gameData.farmIcon; 
        level = gameData.level; 
        exp = gameData.exp;
        dau = gameData.dau !== undefined ? gameData.dau : (gameData.xu !== undefined ? gameData.xu : 0);
        la = gameData.la !== undefined ? gameData.la : (gameData.usd !== undefined ? gameData.usd : 0);
        
        // 2. Táº£i cÃ´ng cá»¥ & Ã” Ä‘áº¥t
        tool = gameData.tool;
        farmSlots = gameData.farmSlots ? (Array.isArray(gameData.farmSlots) ? gameData.farmSlots : Array(5).fill(null)) : Array(5).fill(null);
        if (farmSlots.length < 5) { while(farmSlots.length < 5) farmSlots.push(null); }
        
        // 3. Táº£i Pet & Tráº¡ng thÃ¡i Trá»©ng
        activePet = gameData.activePet || null; 
        ownedPets = gameData.ownedPets || []; 
        hasIceEgg = gameData.hasIceEgg || false; 
        isIceDragonHatched = gameData.isIceDragonHatched || false; 
        isIceDragonEvolved = gameData.isIceDragonEvolved || false;
        hatchedPetType = gameData.hatchedPetType || "thien_than"; 
        incubationFinishTime = gameData.incubationFinishTime || 0; 
        
        // --- [Má»šI] Táº¢I Cáº¤P Äá»˜ RIÃŠNG CHO Tá»ªNG PET ---
        if (gameData.petLevels) {
            petLevels = gameData.petLevels;
        } else {
            // Náº¿u file save cÅ© chÆ°a cÃ³, táº¡o má»›i vÃ  chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u cÅ©
            petLevels = { 'thien_than': 1, 'than_chet': 1 };
            // Náº¿u trÆ°á»›c Ä‘Ã³ Ä‘Ã£ cÃ³ cáº¥p Ä‘á»™, gÃ¡n nÃ³ cho con pet hiá»‡n táº¡i
            if (gameData.petStarLevel) {
                petLevels[hatchedPetType] = gameData.petStarLevel;
            }
        }
        // Cáº­p nháº­t biáº¿n hiá»ƒn thá»‹ hiá»‡n táº¡i theo con pet Ä‘ang chá»n
        petStarLevel = petLevels[hatchedPetType] || 1;
        // ------------------------------------------

        // 4. Táº£i Háº¡t giá»‘ng
        const savedSeeds = gameData.ownedSeeds || {};
        ownedSeeds = Object.assign({}, savedSeeds); 
        
        if(ownedSeeds['hat_nguyen_to'] === undefined) ownedSeeds['hat_nguyen_to'] = 0;
        if(ownedSeeds['hat_kim_loai'] === undefined) ownedSeeds['hat_kim_loai'] = 0;
        if(ownedSeeds['hat_tinh_yeu'] === undefined) ownedSeeds['hat_tinh_yeu'] = 0;

        // 5. Táº£i Cháº­u & Äá»“ rÃ¨n
        ownedPots = Object.assign({ 'so_dua': 5, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 }, gameData.ownedPots || {});
        craftingQueue = gameData.craftingQueue || [];
        equippedPots = gameData.equippedPots || ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua'];
        
        farmSlots.forEach((slot, idx) => { if(slot && slot.potType) { equippedPots[idx] = slot.potType; } });
        
        // 6. Táº£i cÃ¡c chá»‰ sá»‘ phá»¥ & Trang trÃ­ & Kho Ä‘á»“
        lastFedTime = gameData.lastFedTime || 0;
        lastBeePokeTime = gameData.lastBeePokeTime || 0;

        // Äáº£m báº£o kho chá»©a cÃ³ Nhá»™ng Ong
        if (typeof ownedArtifacts === 'undefined') ownedArtifacts = {};
        
        globalPetAge = gameData.globalPetAge || 0;
        
        vineDecorations = gameData.vineDecorations || [null, null, null, null, null];
        ownedDecorations = gameData.ownedDecorations || { 'chau_chau': 0 };
        
        // Táº£i kho váº­t pháº©m Ä‘áº·c biá»‡t
        ownedArtifacts = Object.assign({ 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0, 'nhong_ong': 0 }, gameData.ownedArtifacts || {});
        
        grasshopperExchanged = gameData.grasshopperExchanged || 0;
        usedGiftcodes = gameData.usedGiftcodes || [];
    }
}

function _saveGame(showAlert = false){
    // LÆ°u cáº¥p Ä‘á»™ hiá»‡n táº¡i vÃ o object trÆ°á»›c khi save
    petLevels[hatchedPetType] = petStarLevel;

    const gameData = { 
        playerName, farmIcon, level, exp, dau, la, tool, farmSlots, 
        activePet, ownedPets, hasIceEgg, isIceDragonHatched, isIceDragonEvolved, 
        hatchedPetType, 
        ownedSeeds, lastFedTime, globalPetAge, lastBeePokeTime, 
        petStarLevel, // Váº«n lÆ°u Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch ngÆ°á»£c
        petLevels,    // <-- QUAN TRá»ŒNG: LÆ°u biáº¿n nÃ y
        ownedPots, craftingQueue, equippedPots,
        incubationFinishTime, vineDecorations, ownedDecorations, ownedArtifacts,
        grasshopperExchanged,
        usedGiftcodes
    };
    localStorage.setItem('farmLolGame', JSON.stringify(gameData));
    if(showAlert) alert("ÄÃ£ lÆ°u trÃ² chÆ¡i!");
}
function saveGame(){ _saveGame(true); }
btnSave.addEventListener('click', saveGame);
function autoSave() { if (level > 0) { _saveGame(false); } }

function deleteGame(){
    if(confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a nÃ´ng tráº¡i hiá»‡n táº¡i?")){
        localStorage.removeItem('farmLolGame');
        
        // 1. Reset cÃ¡c chá»‰ sá»‘ cÆ¡ báº£n
        playerName = "NÃ´ng dÃ¢n"; farmIcon = "ğŸŒ¾"; level = 0; exp = 0; 
        dau = 0; la = 0; 
        
        // 2. Reset cÃ¢y trá»“ng vÃ  pet
        farmSlots = Array(5).fill(null); 
        activePet = null; ownedPets = []; 
        hasIceEgg = false; 
        isIceDragonHatched = false; 
        isIceDragonEvolved = false; 
        hatchedPetType = "thien_than";
        incubationFinishTime = 0;
        
        // 3. Reset kho vÃ  cháº­u
        ownedSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0, 'hat_tinh_yeu': 0 };
        ownedPots = { 'so_dua': 0, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 };
        equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua'];
        
        // 4. RESET HÃ€NG CHá»œ RÃˆN Vá»€ Rá»–NG
        craftingQueue = []; 
        
        // 5. Reset cÃ¡c biáº¿n phá»¥ khÃ¡c
        lastFedTime = 0; globalPetAge = 0;
        petStarLevel = 1;
        vineDecorations = [null, null, null, null, null];
        ownedDecorations = { 'chau_chau': 0 };
        ownedArtifacts = { 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0 }; 
        grasshopperExchanged = 0;  
        usedGiftcodes = [];        

        // XÃ³a quáº£ Ä‘Ã o (náº¿u Ä‘ang hiá»‡n)
        const rewardIcon = document.getElementById('daily-reward-icon');
        if(rewardIcon) rewardIcon.remove();

        // 6. Cáº­p nháº­t giao diá»‡n
        checkBeeHiveSpawn();      
        updateGiftcodeBoxState(); 
        updateDisplay(); 
        updateControlButtons();
        
        // ğŸ”¥ QUAN TRá»ŒNG: Gá»i hÃ m nÃ y Ä‘á»ƒ Ä‘á»•i áº£nh Thá»£ RÃ¨n vá» tráº¡ng thÃ¡i tÄ©nh NGAY Láº¬P Tá»¨C ğŸ”¥
        updateBlacksmithVisuals(); 

        alert("ÄÃ£ xÃ³a nÃ´ng tráº¡i!");
    }
}
btnDelete.addEventListener('click', deleteGame);

const kintoCloud = document.getElementById("kinto-cloud");
if (kintoCloud) {
    kintoCloud.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
        showShopPopup();
    });
}
if (lightBulb) {
    lightBulb.addEventListener("click", () => {
        body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', body.classList.contains('dark-mode'));
    });
}

function closeInteractionPopup() {
    if (activePopupInterval) { clearInterval(activePopupInterval); activePopupInterval = null; }
    if (window.feedInterval) { clearInterval(window.feedInterval); window.feedInterval = null; }
    hidePopup('interaction-popup');
    const iText = document.getElementById('interaction-text');
    const iControls = document.getElementById('interaction-controls');
    if(iText) { iText.style.display = 'block'; iText.innerHTML = ''; }
    if(iControls) { iControls.innerHTML = ''; }
}

// --- HÃ€M Xá»¬ LÃ áº¤P TRá»¨NG Má»šI (CÃ“ Háº¸N GIá»œ 24H) ---
function handleIceDragonInteraction(action, selectedType = 'thien_than') {
    // Láº¥y thá»i gian tá»« Config
    const HATCH_DURATION = GAME_CONFIG.HATCH_TIME;

    // --- Sá»¬A á» ÄÃ‚Y: Logic tÃªn hiá»ƒn thá»‹ ---
    let petName = "Bi Gai";
    if (selectedType === 'than_chet') petName = "Tháº§n Cháº¿t";
    else if (selectedType === 'thien_than') petName = "ThiÃªn Tháº§n";
    // ------------------------------------

    if (action === 'hatch') {
        if (confirm(`QuÃ¡ trÃ¬nh áº¥p ${petName} sáº½ máº¥t 24 giá».\nBáº¡n cháº¯c cháº¯n chá»©?`)) {
            // 1. LÆ°u loáº¡i pet Ä‘ang áº¥p
            hatchedPetType = selectedType;

            // 2. TÃ­nh thá»i gian xong
            incubationFinishTime = Date.now() + HATCH_DURATION;

            // 3. ÄÃ¡nh dáº¥u sá»Ÿ há»¯u ngay
            // --- Sá»¬A á» ÄÃ‚Y: ThÃªm value áº£nh Bi Gai ---
            let petValue = "1000000149.gif"; 
            if(selectedType === 'than_chet') petValue = "1000000104.gif";
            else if(selectedType === 'thien_than') petValue = "1000000127.gif";
            // ----------------------------------------
            
            if (!ownedPets.includes(petValue)) {
                ownedPets.push(petValue);
            }

            // 4. ÄÃ³ng popup & LÆ°u
            interactionControls.innerHTML = '';
            closeInteractionPopup();
            
            if(typeof showToast === 'function') {
                showToast(`Äang áº¥p ${petName}...`, "ğŸ¥š");
            } else {
                alert(`ÄÃ£ báº¯t Ä‘áº§u áº¥p trá»©ng! Quay láº¡i sau 24 giá» nhÃ©.`);
            }

            updateDisplay();
            updatePetShop(); 
            saveGame(); 
        }
    }
}

let currentSeedTab = 'seeds';
function showSeedSelectionPopup(slotNum, slotIndex) {
    interactionTitle.innerHTML = `ğŸ“¦ Kho Äá»“`; 
    interactionText.style.display = 'none'; 
    interactionControls.innerHTML = '';

    const tabs = document.createElement('div');
    tabs.className = 'tab-container';
    tabs.innerHTML = `
        <button class="tab-btn ${currentSeedTab==='seeds'?'active':''}" onclick="switchTab('seeds', ${slotNum}, ${slotIndex})">ğŸŒ± Háº¡t Giá»‘ng</button>
        <button class="tab-btn ${currentSeedTab==='pots'?'active':''}" onclick="switchTab('pots', ${slotNum}, ${slotIndex})">ğŸº Cháº­u</button>
    `;
    interactionControls.appendChild(tabs);

    const contentContainer = document.createElement('div');
    contentContainer.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 250px; overflow-y: auto; padding: 5px;';
    interactionControls.appendChild(contentContainer);

    if (currentSeedTab === 'seeds') {
        renderSeedList(contentContainer, slotNum, slotIndex);
    } else {
        renderPotList(contentContainer, slotNum, slotIndex);
    }

    showPopup('interaction-popup');
}

function switchTab(tabName, slotNum, slotIndex) {
    currentSeedTab = tabName;
    showSeedSelectionPopup(slotNum, slotIndex);
}

// --- 3. Cáº¬P NHáº¬T RENDER POT LIST (KHUNG VUÃ”NG GIá»NG THá»¢ RÃˆN) ---
function renderPotList(container, slotNum, slotIndex) {
    let hasItem = false;
    const currentSlotPot = equippedPots[slotIndex] || 'so_dua';

    Object.keys(ownedPots).forEach(potKey => {
        const amount = ownedPots[potKey] || 0;
        const potDef = POT_DEFINITIONS[potKey];
        const isEquipped = (currentSlotPot === potKey);

        if ((amount > 0 || isEquipped) && potDef) {
            hasItem = true;
            const card = document.createElement('div');
            card.className = "shop-item";

            let bonusText = "";
            if (potDef.expBonus > 0) {
                bonusText = `<div style="color:#4CAF50; font-size:0.8em; font-weight:bold; margin-bottom:2px;">+${potDef.expBonus} Exp/láº§n</div>`;
            }

            // Sá»¬A: ThÃªm class "icon-box-bg"
            let htmlContent = `
                <div class="icon-box-bg" style="
                    width: 60px; height: 60px;
                    border-radius: 12px; 
                    display: flex; align-items: center; justify-content: center;
                    margin-bottom: 8px;
                ">
                    <img src="${potDef.img}" style="
                        width: 70%; height: 70%; 
                        object-fit: contain; 
                        filter: drop-shadow(0 3px 3px rgba(0,0,0,0.15));
                    ">
                </div>
                
                <div style="font-weight: 700; font-size: 0.95em; color: var(--text-main); margin-bottom: 2px;">
                    ${potDef.name}
                </div>
                ${bonusText}
                <div style="color: var(--text-muted); font-size: 0.8em; margin-bottom: 8px;">
                    Kho: <b>${amount}</b>
                </div>
            `;

            const btnEquipHTML = `
                <button class="btn-equip-pot" style="background:${isEquipped ? 'grey' : '#2196F3'}; border-radius:8px; padding:6px; font-size:11px; font-weight:bold; color:white; border:none; cursor:${isEquipped ? 'default' : 'pointer'}; width: 100%; box-shadow: 0 2px 0 rgba(0,0,0,0.2);">
                    ${isEquipped ? 'Äang dÃ¹ng' : 'Thay Cháº­u'}
                </button>
            `;

            if (potKey === 'so_dua') {
                htmlContent += `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%; margin-top:auto;">${btnEquipHTML}<button class="btn-sell-pot" style="width:100%; border:none; border-radius:8px; padding:6px; font-weight:700; font-size:11px; color:white; cursor:pointer; background:#FF5722; box-shadow: 0 2px 0 #E64A19;">ğŸ’° BÃ¡n</button></div>`;
            } else {
                htmlContent += `<div style="width:100%; margin-top:auto;">${btnEquipHTML}</div>`;
            }

            card.innerHTML = htmlContent;

            const btnEquip = card.querySelector('.btn-equip-pot');
            if (btnEquip) {
                btnEquip.onclick = () => {
                    if (isEquipped) return; 
                    if (farmSlots[slotIndex]) { alert("HÃ£y thu hoáº¡ch cÃ¢y trÆ°á»›c!"); return; }
                    const oldPot = currentSlotPot; const newPot = potKey;
                    if (ownedPots[newPot] > 0) {
                        ownedPots[newPot]--; ownedPots[oldPot] = (ownedPots[oldPot] || 0) + 1; equippedPots[slotIndex] = newPot; 
                        alert(`ÄÃ£ thay sang ${potDef.name} (Bonus +${potDef.expBonus} Exp)!`);
                        updateDisplay(); closeInteractionPopup();
                    } else { alert("Lá»—i: KhÃ´ng tÃ¬m tháº¥y cháº­u nÃ y trong kho!"); }
                };
            }
            const btnSell = card.querySelector('.btn-sell-pot');
            if (btnSell && potKey === 'so_dua') {
                btnSell.onclick = () => {
                    const sellableAmount = amount;
                    if (sellableAmount <= 0) { alert(`Báº¡n khÃ´ng cÃ²n Sá» Dá»«a dÆ° nÃ o!`); return; }
                    let sellQtyStr = prompt(`GiÃ¡ bÃ¡n: 500 Äáº­u/cháº­u. Kho: ${sellableAmount}. Nháº­p SL bÃ¡n:`, "1");
                    if (sellQtyStr === null) return;
                    let sellQty = parseInt(sellQtyStr);
                    if (!Number.isInteger(sellQty) || sellQty <= 0) return;
                    if (sellQty > sellableAmount) { alert(`Chá»‰ cÃ³ ${sellableAmount} cÃ¡i!`); return; }
                    if (confirm(`BÃ¡n ${sellQty}x Sá» Dá»«a Ä‘á»ƒ nháº­n ${(sellQty*500).toLocaleString()} Äáº­u?`)) {
                        ownedPots['so_dua'] -= sellQty; dau += sellQty*500;
                        alert(`ÄÃ£ bÃ¡n!`); updateDisplay(); container.innerHTML = ""; renderPotList(container, slotNum, slotIndex);
                    }
                };
            }
            container.appendChild(card);
        }
    });

    if (farmSlots[slotIndex]) container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding:10px; color:#ef5350; font-weight:bold;">âš ï¸ Thu hoáº¡ch cÃ¢y trÆ°á»›c khi thay cháº­u!</div>` + container.innerHTML;
    else if (!hasItem) container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding:10px; color:var(--text-muted);">KhÃ´ng cÃ³ cháº­u nÃ o khÃ¡c!</div>`;
}

// --- 4. Cáº¬P NHáº¬T RENDER SEED LIST ---
function renderSeedList(container, slotNum, slotIndex) {
    const seedMap = new Map();
    shopItems.filter(item => item.type === 'seed').forEach(item => seedMap.set(item.value, item));
    let seedFound = false;
    
    seedMap.forEach((seedData, seedValue) => {
        const amount = ownedSeeds[seedValue] || 0;
        
        if (amount > 0 && seedData) {
            seedFound = true;
            const card = document.createElement('div');
            card.className = "shop-item";
            
            // Sá»¬A: ThÃªm class "icon-box-bg"
            card.innerHTML = `
                <div class="icon-box-bg" style="
                    width: 60px; height: 60px;
                    border-radius: 50%; /* Bo trÃ²n */
                    display: flex; align-items: center; justify-content: center;
                    margin-bottom: 8px;
                ">
                    <img src="${seedData.icon}" style="
                        width: 65%; height: 65%; 
                        object-fit: contain; 
                        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15));
                    ">
                </div>
                
                <div style="font-size: 0.95em; font-weight: 700; color:var(--text-main); margin-bottom: 2px;">
                    ${seedData.name}
                </div>
                <div style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 8px;">
                    SL: <b>${amount}</b>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%; margin-top:auto;">
                    <button class="btn-plant-now" style="width:100%; border-radius:8px; padding:6px; font-size:11px; margin-top:0;">ğŸŒ± Trá»“ng</button>
                    <button class="btn-sell-seed" style="width:100%; border:none; border-radius:8px; padding:6px; font-weight:700; font-size:11px; color:white; cursor:pointer; background:#FF5722; box-shadow: 0 2px 0 #E64A19; transition: all 0.1s;">ğŸ’° BÃ¡n</button>
                </div>
            `;
            
            card.querySelector('.btn-plant-now').onclick = () => {
                ownedSeeds[seedValue] -= 1;
                const currentPot = equippedPots[slotIndex] || 'so_dua';
                farmSlots[slotIndex] = { name: seedData.name, icon: PLANT_STAGES[0].icon, value: seedValue, stage: 0, plantedAt: Date.now(), potType: currentPot };
                updateDisplay(); updateSeedShop(); closeInteractionPopup();
            };

            card.querySelector('.btn-sell-seed').onclick = () => {
                let sellQtyStr = prompt(`GiÃ¡ bÃ¡n: ${seedData.price} Äáº­u/háº¡t. Báº¡n muá»‘n bÃ¡n bao nhiÃªu?`, "1");
                if (sellQtyStr === null) return; 
                let sellQty = Number(sellQtyStr);
                if (!Number.isInteger(sellQty) || sellQty <= 0) { alert("Sá»‘ lÆ°á»£ng sai!"); return; }
                if (sellQty > amount) { alert("KhÃ´ng Ä‘á»§ hÃ ng!"); return; }
                if(confirm(`BÃ¡n ${sellQty}x ${seedData.name} nháº­n ${sellQty * seedData.price} Äáº­u?`)) {
                    ownedSeeds[seedValue] -= sellQty; dau += sellQty * seedData.price;
                    alert(`ÄÃ£ bÃ¡n!`); updateDisplay(); updateSeedShop(); container.innerHTML = ""; renderSeedList(container, slotNum, slotIndex);
                }
            };
            container.appendChild(card);
        }
    });

    if (!seedFound) container.innerHTML = `<div style="grid-column: span 2; text-align: center; margin: 15px 0; color: #666;">Háº¿t háº¡t giá»‘ng.</div>`;
}
// --- HÃ€M Táº O HIá»†U á»¨NG BAY ---
function spawnFloatingReward(slotId, htmlContent, delay = 0, typeClass = "float-exp") {
    // 1. TÃ¬m vá»‹ trÃ­ cá»§a Ã´ Ä‘áº¥t (slot) trong giao diá»‡n
    const slotEl = document.getElementById(`slot-${slotId}`);
    if (!slotEl) return;

    // 2. Táº¡o pháº§n tá»­ bay
    setTimeout(() => {
        const floater = document.createElement("div");
        floater.className = `floating-reward ${typeClass}`;
        floater.innerHTML = htmlContent;

        // 3. Láº¥y vá»‹ trÃ­ top/left hiá»‡n táº¡i cá»§a slot Ä‘á»ƒ Ä‘áº·t floater
        // VÃ¬ slot náº±m trong .app-wrapper (relative), ta láº¥y style top/left cá»§a nÃ³
        // Cá»™ng thÃªm má»™t chÃºt offset Ä‘á»ƒ nÃ³ xuáº¥t hiá»‡n giá»¯a Ã´
        const currentTop = parseInt(slotEl.style.top || 0);
        const currentLeft = parseInt(slotEl.style.left || 0) || (slotEl.offsetLeft); // Fallback náº¿u style left lÃ  calc

        // LÆ°u Ã½: Do dÃ¹ng calc() trong CSS, láº¥y offsetLeft/Top tá»« DOM chuáº©n hÆ¡n
        floater.style.top = (slotEl.offsetTop - 20) + "px"; 
        floater.style.left = (slotEl.offsetLeft + 10) + "px";

        // ThÃªm ngáº«u nhiÃªn vá»‹ trÃ­ X má»™t chÃºt Ä‘á»ƒ khÃ´ng bá»‹ chá»“ng chÃ©o náº¿u rá»›t nhiá»u mÃ³n
        const randomX = Math.floor(Math.random() * 20) - 10; 
        floater.style.left = (slotEl.offsetLeft + 10 + randomX) + "px";

        // 4. Gáº¯n vÃ o main (nÆ¡i chá»©a cÃ¡c slot)
        document.querySelector("main").appendChild(floater);

        // 5. Tá»± xÃ³a sau khi animation káº¿t thÃºc (1.2s)
        setTimeout(() => { floater.remove(); }, 1200);

    }, delay);
}
function updateFarmState() {
    const now = Date.now();
    let changed = false; 

    // --- LOGIC COMBO Má»šI: KIá»‚M TRA Äá»¦ 5 MÃ“N ---
    // HÃ m .every() sáº½ tráº£ vá» true náº¿u táº¥t cáº£ cÃ¡c pháº§n tá»­ trong máº£ng vineDecorations Ä‘á»u khÃ¡c null (tá»©c lÃ  Ä‘Ã£ treo Ä‘á»“)
    const isFullSet = vineDecorations.every(item => item !== null);

    // Náº¿u Ä‘á»§ 5 mÃ³n báº¥t ká»³: Giáº£m 2 giá» (7200000 ms)
    // Náº¿u chÆ°a Ä‘á»§: Giáº£m 1 giá» (3600000 ms) nhÆ° cÅ©
    const reductionAmount = isFullSet ? 7200000 : 3600000;
    
    // Náº¿u muá»‘n hiá»‡n thÃ´ng bÃ¡o Combo (tuá»³ chá»n, má»Ÿ console Ä‘á»ƒ xem)
    // if(isFullSet) console.log("Combo kÃ­ch hoáº¡t: Giáº£m 2h!");
    // ------------------------------------------

    farmSlots.forEach((slotData, index) => {
        if (slotData && slotData.stage < PLANT_STAGES.length - 1) { 
            const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
            
            let requiredDuration = nextStageInfo.duration;
            
            // Danh sÃ¡ch cÃ¡c váº­t pháº©m há»— trá»£ giáº£m thá»i gian
            const fastGrowthItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];

            // Kiá»ƒm tra xem vá»‹ trÃ­ nÃ y cÃ³ treo váº­t pháº©m náº±m trong danh sÃ¡ch trÃªn khÃ´ng
            if (fastGrowthItems.includes(vineDecorations[index])) {
                // ÃP Dá»¤NG THá»œI GIAN GIáº¢M ÄÃƒ TÃNH á» TRÃŠN
                requiredDuration -= reductionAmount; 
                
                if (requiredDuration < 0) requiredDuration = 0; // KhÃ´ng Ä‘á»ƒ thá»i gian Ã¢m
            }

            if (now >= slotData.plantedAt + requiredDuration) { 
                slotData.stage += 1; 
                changed = true; 
            }
        }
    });
    if (changed) updateDisplay();
}

function getCountdownTimePlant(timeToNext) {
    if (timeToNext <= 0) return "0s";
    
    // Logic tÃ­nh toÃ¡n giá»‘ng há»‡t Thá»£ RÃ¨n (renderCraftingQueue)
    let seconds = Math.floor((timeToNext / 1000) % 60);
    let minutes = Math.floor((timeToNext / (1000 * 60)) % 60);
    let hours = Math.floor((timeToNext / (1000 * 60 * 60)));
    
    let timeString = "";
    if(hours > 0) timeString += `${hours}h `;
    if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
    timeString += `${seconds}s`;
    
    return timeString;
}

const potSlots = document.querySelectorAll(".pot-slot");
potSlots.forEach(slot => {
    slot.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
        
        // --- Sá»¬A Lá»–I Táº I ÄÃ‚Y: Bá» qua Slot 6 (CÃ¢u cÃ¡) ---
        // VÃ¬ Slot 6 Ä‘Ã£ cÃ³ sá»± kiá»‡n onclick riÃªng trong HTML rá»“i
        const slotNum = slot.getAttribute('data-slot');
        if (slotNum === "6") return; 
        // ------------------------------------------------

        // --- Sá»¬A Lá»–I: LuÃ´n hiá»ƒn thá»‹ khung text trÆ°á»›c ---
        interactionText.style.display = 'block';
        interactionControls.innerHTML = ''; // Reset nÃºt báº¥m
        if (activePopupInterval) clearInterval(activePopupInterval);

        const slotNumInt = parseInt(slotNum);

        const renderSlotStatus = () => {
            // Äáº£m báº£o xÃ³a nÃºt cÅ© má»—i láº§n render láº¡i
            interactionControls.innerHTML = '';
            
        if (slotNum === "1") {
            // --- TRÆ¯á»œNG Há»¢P 1: ÄANG CÃ“ THá»œI GIAN CHá»œ (áº¤p hoáº·c NÃ¢ng cáº¥p) ---
            if (incubationFinishTime > 0) {
                // Sá»¬A: Logic xÃ¡c Ä‘á»‹nh Ä‘ang lÃ m gÃ¬
                // Náº¿u Ä‘ang cÃ³ trá»©ng (hasIceEgg) -> Cháº¯c cháº¯n lÃ  Ä‘ang áº¤p Má»›i
                // Náº¿u khÃ´ng cÃ³ trá»©ng mÃ  cÃ³ giá» -> LÃ  Ä‘ang NÃ¢ng Cáº¥p
                let isHatchingNew = hasIceEgg; 
                let actionText = isHatchingNew ? "Äang áº¤p Ná»Ÿ" : "Äang NÃ¢ng Cáº¥p";
                
                // XÃ¡c Ä‘á»‹nh Level má»¥c tiÃªu Ä‘á»ƒ hiá»ƒn thá»‹
                let currentLv = petLevels[hatchedPetType] || 1;
                // Náº¿u áº¥p má»›i -> Má»¥c tiÃªu lÃ  1. Náº¿u nÃ¢ng cáº¥p -> Má»¥c tiÃªu lÃ  Cáº¥p hiá»‡n táº¡i + 1
                let targetLevel = isHatchingNew ? 1 : (currentLv + 1);

                interactionTitle.innerHTML = `â³ ${actionText}`;

                const updateTimer = () => {
                    const now = Date.now();
                    const timeLeft = incubationFinishTime - now;

                    if (timeLeft <= 0) {
                        interactionText.innerHTML = "Äang hoÃ n táº¥t quÃ¡ trÃ¬nh...";
                        return;
                    }

                    let seconds = Math.floor((timeLeft / 1000) % 60);
                    let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
                    let hours = Math.floor((timeLeft / (1000 * 60 * 60)));
                    let timeString = "";
                    if (hours > 0) timeString += `${hours}h `;
                    if (minutes > 0 || hours > 0) timeString += `${minutes}m `;
                    timeString += `${seconds}s`;

                    const starConfig = {
                        1: { color: '#9E9E9E', stars: 'â­' },
                        2: { color: '#4CAF50', stars: 'â­â­' },
                        3: { color: '#2196F3', stars: 'â­â­â­' },
                        4: { color: '#9C27B0', stars: 'â­â­â­â­' },
                        5: { color: '#FF6F00', stars: 'â­â­â­â­â­' }
                    };
                    const style = starConfig[targetLevel] || starConfig[1];
// --- Sá»¬A LOGIC TÃŠN HIá»‚N THá»Š KHI áº¤P ---
let petName = "ğŸ‘¼ ThiÃªn Tháº§n"; // Máº·c Ä‘á»‹nh
if (hatchedPetType === 'than_chet') petName = "ğŸ’€ Tháº§n Cháº¿t";
if (hatchedPetType === 'bi_gai') petName = "ğŸŸ¢ Bi Gai"; // ThÃªm dÃ²ng nÃ y vÃ o
// -------------------------------------

                    interactionText.innerHTML = `
                        <div style="text-align:center;">
                            <div style="font-size:0.85em; font-weight:bold; color:#795548; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                                ${actionText}
                            </div>
                            <img src="1000000102.png" style="width:80px; display:block; margin: 0 auto 10px auto; filter: drop-shadow(0 0 5px ${style.color});">
                            <div style="font-size:1.3em; font-weight:900; color:${style.color}; margin-bottom:4px; text-shadow: 1px 1px 0 #fff;">
                                ${petName}
                            </div>
                            <div style="
                                font-size: 1.1em; color: ${style.color}; font-weight: bold; margin-bottom: 15px; 
                                display: inline-block; padding: 5px 15px; border: 2px solid ${style.color};
                                border-radius: 20px; background: rgba(255,255,255,0.8);
                            ">
                                Má»¥c tiÃªu: ${style.stars}
                            </div>
                            <div style="font-size:0.9em; color: #555; font-style: italic;">Äang háº¥p thá»¥ linh khÃ­...</div>
                            <div style="margin-top:10px; font-size:1.4em; color:#E65100; font-weight:900; background:#FFF3E0; padding:10px; border-radius:10px; border: 1px dashed #FF9800;">
                                ${timeString}
                            </div>
                        </div>`;
                };

                updateTimer();
                if (activePopupInterval) clearInterval(activePopupInterval);
                activePopupInterval = setInterval(updateTimer, 1000);
            }
            
            // --- TRÆ¯á»œNG Há»¢P 2: ÄÃƒ CÃ“ PET (HIá»†N THá»Š THÃ”NG TIN & Äá»”I PET & áº¤P Má»šI) ---
else if (isIceDragonHatched) {
                petStarLevel = petLevels[hatchedPetType] || 1;

                const starConfig = {
                    1: { color: '#757575', colorName: 'XÃ¡m' },
                    2: { color: '#4CAF50', colorName: 'Xanh LÃ¡' },
                    3: { color: '#2196F3', colorName: 'Xanh DÆ°Æ¡ng' },
                    4: { color: '#9C27B0', colorName: 'TÃ­m' },
                    5: { color: '#FF6F00', colorName: 'Cam' }
                };
                const currentConfig = starConfig[petStarLevel] || starConfig[1];
                
                // --- Sá»¬A á» ÄÃ‚Y: Logic hiá»ƒn thá»‹ tÃªn chuáº©n ---
                let baseName = "ThiÃªn Tháº§n"; 
                if (hatchedPetType === 'than_chet') baseName = "Tháº§n Cháº¿t";
                if (hatchedPetType === 'bi_gai') baseName = "Bi Gai"; 
                // ------------------------------------------
                
                let starsStr = "";
                for(let i=0; i<petStarLevel; i++) starsStr += "â­";

                interactionTitle.innerHTML = `
                    <span style="color:${currentConfig.color}; font-weight:900; font-size:1.1em; text-shadow: 1px 1px 0 #fff; display:block; margin-bottom:5px;">
                        ${baseName}
                    </span>
                    <span style="font-size:0.8em; color:#555;">${starsStr}</span>
                `;
                
                interactionText.innerHTML = `<div style="margin-bottom:15px; font-size:0.9em; color:#555; background:#f5f5f5; padding:8px; border-radius:8px;">
                    âš¡ <b>Hiá»‡u á»©ng:</b> Auto Thu hoáº¡ch (Cáº¥p ${petStarLevel})
                </div>`;

                if (petStarLevel < 5) {
                    const nextLevel = petStarLevel + 1;
                    const costManh = nextLevel * 100;
                    const costLa = nextLevel * 10;
                    const currentManh = ownedArtifacts['manh_nguyen_to'] || 0;
                    
                    const upgradeDiv = document.createElement('div');
                    upgradeDiv.style.cssText = "background: #FFF8E1; border: 2px dashed #FFCA28; border-radius: 12px; padding: 12px; margin-bottom: 15px;";
                    
                    upgradeDiv.innerHTML = `
                        <div style="font-weight:bold; color:#FF6F00; margin-bottom:8px; text-transform:uppercase;">ğŸ”¼ NÃ¢ng Cáº¥p LÃªn ${nextLevel} Sao</div>
                        <div style="font-size:0.9em; color:#4E342E; text-align:left; line-height:1.6;">
                            ğŸ”¸ Máº£nh NguyÃªn Tá»‘: <b>${currentManh}/${costManh}</b><br>
                            ğŸ”¸ LÃ¡: <b>${la}/${costLa}</b>
                        </div>
                    `;
                    
                    const btnUpgrade = document.createElement('button');
                    btnUpgrade.className = "btn-buy";
                    btnUpgrade.style.marginTop = "10px";
                    btnUpgrade.style.width = "100%";
                    btnUpgrade.textContent = "NÃ¢ng Cáº¥p (24h)";
                    btnUpgrade.onclick = () => {
                        if (currentManh >= costManh && la >= costLa) {
                            if (confirm(`NÃ¢ng cáº¥p Pet lÃªn ${nextLevel} Sao sáº½ máº¥t thá»i gian chá»?\nTrong lÃºc nÃ¢ng cáº¥p, Pet sáº½ khÃ´ng thá»ƒ thu hoáº¡ch giÃºp báº¡n.`)) {
    ownedArtifacts['manh_nguyen_to'] -= costManh;
    la -= costLa;
    // Láº¥y thá»i gian tá»« Config
    incubationFinishTime = Date.now() + GAME_CONFIG.UPGRADE_TIME; 
    
    saveGame(); updateDisplay(); closeInteractionPopup();
    alert(`ÄÃ£ báº¯t Ä‘áº§u nÃ¢ng cáº¥p!`);
}
                        } else {
                            alert(`Báº¡n khÃ´ng Ä‘á»§ tÃ i nguyÃªn!\nCáº§n: ${costManh} Máº£nh vÃ  ${costLa} LÃ¡.`);
                        }
                    };
                    upgradeDiv.appendChild(btnUpgrade);
                    interactionControls.appendChild(upgradeDiv);
                } else {
                    interactionControls.innerHTML += `<div style="text-align:center; color:#FF6F00; font-weight:bold; margin-bottom:10px;">ğŸ‘‘ ÄÃƒ MAX Cáº¤P</div>`;
                }

                // --- KHUNG áº¤P TRá»¨NG Má»šI (FIX Lá»–I HIá»‚N THá»Š) ---
                if (hasIceEgg) {
                    const hatchContainer = document.createElement('div');
                    hatchContainer.style.cssText = "margin-top:15px; background:#E0F2F1; padding:10px; border-radius:10px; border:2px dashed #009688;";
                    
                    const hasAngel = isPetOwned('1000000127.gif');
                    const hasReaper = isPetOwned('1000000104.gif');
                    
                    let optionsHTML = "";
                    if (!hasAngel) optionsHTML += `<label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="radio" name="new_hatch_choice" value="thien_than" checked> ğŸ‘¼ ThiÃªn Tháº§n</label>`;
                    
                    const reaperChecked = (!hasAngel) ? '' : 'checked';
                    if (!hasReaper) optionsHTML += `<label style="display:block; cursor:pointer;"><input type="radio" name="new_hatch_choice" value="than_chet" ${reaperChecked}> ğŸ’€ Tháº§n Cháº¿t</label>`;

                    hatchContainer.innerHTML = `
                        <div style="font-weight:bold; color:#00796B; margin-bottom:8px;">ğŸ¥š PHÃT HIá»†N TRá»¨NG Má»šI!</div>
                        <div style="font-size:0.9em; margin-bottom:8px; color:#555;">Báº¡n vá»«a mua thÃªm trá»©ng, hÃ£y áº¥p nÃ³ Ä‘á»ƒ nháº­n Pet thá»© 2:</div>
                        <div style="margin-bottom:10px; font-weight:bold;">${optionsHTML}</div>
                    `;

                    const btnHatchNew = document.createElement('button');
                    btnHatchNew.className = "btn-buy";
                    btnHatchNew.innerHTML = "áº¤p Ngay (24h)";
                    btnHatchNew.style.background = "#FF5722";
                    btnHatchNew.onclick = () => {
                        const choices = document.getElementsByName('new_hatch_choice');
                        let selected = null;
                        for(const c of choices) { if(c.checked) selected = c.value; }
                        
                        if(selected) {
                            if(confirm("Báº¯t Ä‘áº§u áº¥p trá»©ng má»›i?\n(Slot 1 sáº½ chuyá»ƒn sang tráº¡ng thÃ¡i áº¤p trong 24h)")) {
                                handleIceDragonInteraction('hatch', selected);
                            }
                        } else {
                            alert("Báº¡n Ä‘Ã£ sá»Ÿ há»¯u cáº£ 2 loáº¡i Pet rá»“i, khÃ´ng cáº§n áº¥p ná»¯a!");
                        }
                    };
                    
                    hatchContainer.appendChild(btnHatchNew);
                    interactionControls.appendChild(hatchContainer);
                }
            }
            // --- TRÆ¯á»œNG Há»¢P 3: LOGIC áº¤P TRá»¨NG (Máº¶C Äá»ŠNH LÃ€ BI GAI) ---
            else if (hasIceEgg) {
                interactionTitle.innerHTML = `Trá»©ng NgÅ© Sáº¯c`;
                interactionText.innerHTML = "Quáº£ trá»©ng Ä‘ang rung láº¯c dá»¯ dá»™i...";
                
                // Táº¡o giao diá»‡n giá»›i thiá»‡u Bi Gai
                const demoDiv = document.createElement('div');
                demoDiv.innerHTML = `
                    <div style="margin:15px 0; background:#E8F5E9; padding:15px; border-radius:15px; border:2px dashed #4CAF50; text-align:center;">
                        <img src="1000000149.gif" style="width:70px; height:auto; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.2)); margin-bottom:10px;">
                        <div style="font-weight:900; color:#2E7D32; font-size:1.2em;">Bi Gai</div>
                        <div style="font-size:0.9em; color:#555;">(Pet khá»Ÿi Ä‘áº§u)</div>
                    </div>
                `;
                interactionControls.appendChild(demoDiv);
                
                // NÃºt áº¤p Ngay
                const btnHatch = document.createElement('button');
                btnHatch.innerHTML = `ğŸ”¨ Äáº­p Trá»©ng (24h)`;
                btnHatch.className = "btn-buy";
                btnHatch.style.background = 'linear-gradient(45deg, #4CAF50, #8BC34A)';
                btnHatch.style.fontSize = '1.1em';
                btnHatch.style.boxShadow = '0 4px 0 #33691E';
                
                // Khi báº¥m -> Gá»i hÃ m áº¥p vá»›i tham sá»‘ 'bi_gai'
                btnHatch.onclick = () => {
                    handleIceDragonInteraction('hatch', 'bi_gai'); 
                };
                interactionControls.appendChild(btnHatch);
            }
            
            // --- TRÆ¯á»œNG Há»¢P 4: KHÃ”NG CÃ“ GÃŒ (Ã” TRá»NG) ---
            else { 
                interactionTitle.innerHTML = "ğŸ¾ Pet MÃ¢y";
                interactionText.innerHTML = "ChÆ°a cÃ³ pet nÃ o báº£o vá»‡ nÃ´ng tráº¡i!<br>HÃ£y vÃ o <b>Shop MÃ¢y</b> mua <b>Trá»©ng NgÅ© Sáº¯c</b>.";
            }
        }
            // --- LOGIC CÃC Ã” Äáº¤T TRá»’NG CÃ‚Y ---
            else if (FARM_IDS.includes(slotNumInt)) {
                 interactionTitle.innerHTML = "ğŸŒ± Trá»“ng Trá»t"; 
                 const slotIndex = FARM_IDS.indexOf(slotNumInt); 
                 const slotData = farmSlots[slotIndex];
                 
                 // 1. Ã” Äáº¤T TRá»NG -> Má»Ÿ kho háº¡t giá»‘ng
                 if (slotData === null) {
                     if(activePopupInterval) clearInterval(activePopupInterval);
                     showSeedSelectionPopup(slotNum, slotIndex); 
                     return; 
                 } 
                 
                 // 2. CÃ“ CÃ‚Y -> Hiá»ƒn thá»‹ tráº¡ng thÃ¡i
                 else {
                     updateFarmState(); // Cáº­p nháº­t tráº¡ng thÃ¡i má»›i nháº¥t
                     const currentStage = PLANT_STAGES[slotData.stage];
                     const isReadyForHarvest = slotData.stage === PLANT_STAGES.length - 1;
                     
                     // Táº¡o thÃ´ng bÃ¡o cÆ¡ báº£n
                     let statusMessage = `Báº¡n Ä‘ang trá»“ng <b style="color:#4CAF50; font-size:1.1em;">${slotData.name}</b><br>`;
                     statusMessage += `<span style="color:#795548; font-size:0.9em;">Giai Ä‘oáº¡n: ${currentStage.name}</span><br>`;

                     // TRÆ¯á»œNG Há»¢P A: ÄÃƒ CHÃN (THU HOáº CH)
                     if (isReadyForHarvest) {
                         interactionText.innerHTML = statusMessage + `<div style="margin-top:10px; color:#E65100; font-weight:bold;">âœ¨ CÃ¢y Ä‘Ã£ chÃ­n! Thu hoáº¡ch ngay.</div>`;
                         
                         const btnHarvest = document.createElement('button');
                         const currentPotType = slotData.potType || 'so_dua';
                         const potDef = POT_DEFINITIONS[currentPotType];
                         const potBonus = potDef ? (potDef.expBonus || 0) : 0;

                     // --- CODE Má»šI: Logic Auto Thu Hoáº¡ch (CÃ³ kiá»ƒm tra Pet báº­n) ---
                     
                     // Äiá»u kiá»‡n: Pet Ä‘Ã£ ná»Ÿ (isIceDragonEvolved) VÃ€ KhÃ´ng Ä‘ang báº­n nÃ¢ng cáº¥p (incubationFinishTime === 0)
                     if (isIceDragonEvolved && incubationFinishTime === 0) {
                         const harvesterName = (hatchedPetType === 'than_chet') ? "ğŸ’€ Tháº§n Cháº¿t" : "ğŸ‘¼ ThiÃªn Tháº§n";
                         btnHarvest.innerHTML = `${harvesterName} Thu Hoáº¡ch (Auto)`;
                         btnHarvest.className = "btn-buy";
                         btnHarvest.style.background = 'linear-gradient(45deg, #2196F3, #00BCD4)';
                         
                         btnHarvest.onclick = () => {
                            if (isHarvesting) return; 
                            isHarvesting = true; 
                            closeInteractionPopup(); 
                            
                            // Hiá»‡u á»©ng Pet bay
                            const angelImg = document.getElementById('ice-egg-img');
                            if (angelImg) { angelImg.classList.add('angel-harvesting'); }
                            
                            setTimeout(() => {
                                let hasHarvested = false; 
                                farmSlots.forEach((sData, sIdx) => {
                                    if (sData && sData.stage === PLANT_STAGES.length - 1) {
                                        const hSeedValue = sData.value; 
                                        const slotId = FARM_IDS[sIdx];
                                        const sPotType = sData.potType || 'so_dua'; 
                                        const sPotDef = POT_DEFINITIONS[sPotType];
                                        const sBonus = sPotDef ? (sPotDef.expBonus || 0) : 0; 
                                        const hExp = 10 + sBonus; 
                                        exp += hExp; 
                                        spawnFloatingReward(slotId, `+${hExp} XP`, 0, "float-exp");
                                        const hReturnAmount = 2; 
                                        if (ownedSeeds[hSeedValue] === undefined) ownedSeeds[hSeedValue] = 0;
                                        ownedSeeds[hSeedValue] += hReturnAmount;
                                        
                                        if (HARVEST_DROPS[hSeedValue]) {
                                            const dropInfo = HARVEST_DROPS[hSeedValue];
                                            if (!ownedArtifacts[dropInfo.id]) ownedArtifacts[dropInfo.id] = 0;
                                            ownedArtifacts[dropInfo.id]++;
                                            spawnFloatingReward(slotId, `<img src="${dropInfo.img}" style="width:25px; height:25px; object-fit:contain;"> +1`, 200, "float-item");
                                        }
                                        farmSlots[sIdx] = null; 
                                        hasHarvested = true;
                                    }
                                });
                                if (angelImg) angelImg.classList.remove('angel-harvesting');
                                if (hasHarvested) {
                                    updateDisplay(); checkLevelUp(); updateSeedShop(); saveGame(); 
                                } else { 
                                    showToast("ChÆ°a cÃ³ cÃ¢y nÃ o chÃ­n cáº£!", "âš ï¸", "Pet BÃ¡o CÃ¡o");
                                }
                                isHarvesting = false; 
                            }, 2000); 
                         };
                     } 
                     // Logic Thu Hoáº¡ch Thá»§ CÃ´ng (Cháº¡y khi chÆ°a cÃ³ Pet HOáº¶C Pet Ä‘ang báº­n nÃ¢ng cáº¥p)
                     else {
                         // HIá»†N Cáº¢NH BÃO Náº¾U PET ÄANG Báº¬N
                         if (isIceDragonEvolved && incubationFinishTime > 0) {
                            interactionText.innerHTML += `<div style="font-size:0.85em; color:#d32f2f; margin-top:5px; font-weight:bold; background:#ffebee; padding:5px; border-radius:5px; border:1px dashed #ef5350;">(Pet Ä‘ang báº­n nÃ¢ng cáº¥p, hÃ£y tá»± thu hoáº¡ch nhÃ©!)</div>`;
                         }

                         const harvestedSeedValue = slotData.value; const returnAmount = 2; 
                         let baseExp = 10; let finalExp = baseExp + potBonus;
                         let msgButton = potBonus > 0 ? `ğŸŒ¾ Thu hoáº¡ch (+${finalExp} Exp)` : `ğŸŒ¾ Thu hoáº¡ch (Nháº­n ${returnAmount} Háº¡t + ${finalExp} Exp)`;
                         btnHarvest.innerHTML = msgButton;
                         btnHarvest.className = "btn-buy";
                         btnHarvest.style.background = '#FF9800';
                         
                         btnHarvest.onclick = () => {
                             const slotId = FARM_IDS[slotIndex]; 
                             exp += finalExp; 
                             spawnFloatingReward(slotId, `+${finalExp} XP`, 0, "float-exp");
                             if (ownedSeeds[harvestedSeedValue] !== undefined) ownedSeeds[harvestedSeedValue] += returnAmount;
                             else ownedSeeds[harvestedSeedValue] = returnAmount;
                             if (HARVEST_DROPS[harvestedSeedValue]) {
                                 const dropInfo = HARVEST_DROPS[harvestedSeedValue];
                                 if (!ownedArtifacts[dropInfo.id]) ownedArtifacts[dropInfo.id] = 0;
                                 ownedArtifacts[dropInfo.id]++;
                                 spawnFloatingReward(slotId, `<img src="${dropInfo.img}" style="width:25px; height:25px; object-fit:contain;"> +1`, 200, "float-item");
                             }
                             farmSlots[slotIndex] = null; 
                             closeInteractionPopup(); 
                             updateDisplay(); 
                             checkLevelUp(); 
                             updateSeedShop(); 
                             saveGame(); 
                         };
                     }
                         interactionControls.appendChild(btnHarvest);
                     }
                     
                     // TRÆ¯á»œNG Há»¢P B: ÄANG Lá»šN (HIá»†N Äá»’NG Há»’)
                     else {
                         const updatePlantTimer = () => {
                             if (!farmSlots[slotIndex]) return;
                             
                             const now = Date.now();
                             const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
                             let requiredDuration = nextStageInfo.duration;
                             
                             // --- TÃNH TOÃN GIáº¢M GIá»œ (COMBO DÃ‚Y LEO) ---
                             const isFullSet = vineDecorations.every(item => item !== null);
                             const reductionAmount = isFullSet ? 7200000 : 3600000;
                             
                             const fastGrowthItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
                             if (fastGrowthItems.includes(vineDecorations[slotIndex])) {
                                 requiredDuration -= reductionAmount;
                                 if (requiredDuration < 0) requiredDuration = 0;
                             }

                             const finishTime = slotData.plantedAt + requiredDuration;
                             const timeLeft = finishTime - now;

                             if (timeLeft <= 0) {
                                 if(activePopupInterval) clearInterval(activePopupInterval);
                                 updateFarmState(); 
                                 renderSlotStatus(); 
                                 return;
                             }
                             
                             interactionText.innerHTML = statusMessage + `
                                <div style="margin-top:10px; background:#f5f5f5; padding:8px; border-radius:5px;">
                                    â³ Lá»›n sau: <b style="color:#2196F3;">${getCountdownTimePlant(timeLeft)}</b>
                                </div>`;
                         };
                         
                         updatePlantTimer(); 
                         if(activePopupInterval) clearInterval(activePopupInterval);
                         activePopupInterval = setInterval(updatePlantTimer, 1000);
                     }
                 }
            } else { 
                interactionTitle.innerHTML = "ThÃ´ng BÃ¡o"; 
                interactionText.innerHTML = `Ã” Ä‘áº¥t nÃ y chÆ°a má»Ÿ khÃ³a!`; 
            }
        };
        renderSlotStatus();
        showPopup('interaction-popup');
    });
});

const petHouse = document.getElementById("pet-house");
if (petHouse) {
    petHouse.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
        updatePetShop(); showPopup('pet-house-box'); 
    });
}

const pugPet = document.getElementById("pug-pet");
if (pugPet) {
    pugPet.addEventListener("click", () => {
        if (level === 0) return;
        interactionControls.innerHTML = '';
        if (!activePet) return;
        
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet")); 
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet";
        
        interactionTitle.innerHTML = `ğŸ¾ ${petName}`; 
        interactionText.innerHTML = `
            ${petName} Ä‘ang ráº¥t vui váº».<br>
            ğŸ‚ Tuá»•i: <b>${globalPetAge} ngÃ y</b>
        `;
        showPopup('interaction-popup');
    });
}

// --- ÄOáº N 1: Sá»¬A Sá»° KIá»†N CLICK BÃT XÆ¯Æ NG ---
const boneBowl = document.getElementById("bone-bowl");
if (boneBowl) {
    boneBowl.addEventListener("click", () => {
        if (level === 0) return;
        
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet";
        
        interactionControls.innerHTML = ''; 
        interactionTitle.innerHTML = `ğŸ¦´ Cho Äƒn`; 
        
        if (!activePet) { interactionText.innerHTML = `ChÆ°a cÃ³ Pet nÃ o!`; } 
        else if(petData && (petData.name.includes("Tháº§n Cháº¿t") || petData.name.includes("ThiÃªn Tháº§n"))) {
            interactionText.innerHTML = `${petName} tá»± kiáº¿m Äƒn, khÃ´ng Äƒn xÆ°Æ¡ng!`;
        } else {
            const now = new Date(); const last = new Date(lastFedTime);
            const isSameDay = now.getDate() === last.getDate() && now.getMonth() === last.getMonth() && now.getFullYear() === last.getFullYear();
            
            if (!isSameDay) {
                interactionText.innerHTML = `Pet Ä‘ang Ä‘Ã³i bá»¥ng...`;
                const btnFeed = document.createElement('button');
                btnFeed.innerHTML = "ğŸ¦´ Cho Äƒn ngay (Miá»…n phÃ­)"; 
                btnFeed.className = "btn-buy";
                
                // --- Sá»¬A á» ÄÃ‚Y: KHÃ”NG LÆ¯U GAME NGAY Láº¬P Tá»¨C ---
                btnFeed.onclick = () => {
                    // Chá»‰ Ä‘Ã³ng popup vÃ  hiá»‡n quáº£ Ä‘Ã o. 
                    // ChÆ°a lÆ°u lastFedTime vá»™i Ä‘á»ƒ phÃ²ng trÆ°á»ng há»£p lá»¡ tay táº¯t máº¥t.
                    hidePopup('interaction-popup');
                    spawnDailyReward();
                };
                // ----------------------------------------------
                
                interactionControls.appendChild(btnFeed);
            } else {
                interactionText.innerHTML = `${petName} Ä‘Ã£ no rá»“i! ğŸ¶`;
            }
        }
        showPopup('interaction-popup');
    });
}

// --- ÄOáº N 2: Sá»¬A HÃ€M HIá»†N QUÃ€ VÃ€ LÆ¯U Dá»® LIá»†U ---
function spawnDailyReward() {
    // XÃ³a quÃ  cÅ© náº¿u chÆ°a nháº­n (trÃ¡nh trÃ¹ng láº·p)
    const existingReward = document.getElementById('daily-reward-icon');
    if(existingReward) existingReward.remove();

    const petImg = document.getElementById('pug-pet');
    if(!petImg || petImg.style.display === 'none') return;

    // Táº¡o container quÃ 
    const wrapper = document.createElement('div');
    wrapper.id = 'daily-reward-icon';
    wrapper.className = 'daily-reward-bubble';

    // Láº¥y vá»‹ trÃ­ hiá»‡n táº¡i cá»§a Pet Ä‘á»ƒ Ä‘áº·t quÃ  ngay trÃªn Ä‘áº§u
    wrapper.style.left = petImg.style.left;
    wrapper.style.transform = petImg.style.transform; 
    
    // TÃ­nh toÃ¡n vá»‹ trÃ­ bottom: Láº¥y bottom cá»§a pet + chiá»u cao pet
    let currentBottom = parseInt(petImg.style.bottom || '35'); 
    wrapper.style.bottom = (currentBottom + 90) + 'px'; // Bay cao hÆ¡n pet 90px

    // 1. Chá»‰ táº¡o áº¢nh Quáº£ ÄÃ o (1000000109.png)
    const img = document.createElement('img');
    img.src = '1000000109.png';
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'contain';

    wrapper.appendChild(img);

    // --- Sá»° KIá»†N NHáº¬N QUÃ€ (QUAN TRá»ŒNG: LÆ¯U GAME Táº I ÄÃ‚Y) ---
    wrapper.onclick = () => {
        // 1. Cáº­p nháº­t dá»¯ liá»‡u game Táº I ÄÃ‚Y (Chá»‰ khi báº¥m trÃºng quÃ  má»›i tÃ­nh lÃ  Ä‘Ã£ Äƒn)
        la += 5;                // Cá»™ng lÃ¡
        lastFedTime = Date.now(); // ÄÃ¡nh dáº¥u hÃ´m nay Ä‘Ã£ Äƒn
        globalPetAge += 1;      // TÄƒng tuá»•i pet
        
        // --- TÃ¬m tÃªn Pet hiá»‡n táº¡i ---
        let petName = "Pet";
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const currentPetData = allPets.find(p => p.value === activePet);
        if (currentPetData) {
            petName = currentPetData.name; 
        }

        alert(`Báº¡n nháº­n Ä‘Æ°á»£c 5 LÃ¡ tá»« ${petName}! ğŸ‚`);
        
        // Hiá»‡u á»©ng bay lÃªn biáº¿n máº¥t
        wrapper.style.animation = 'flyUpReward 0.5s ease-out forwards';
        
        // LÆ°u game ngay láº­p tá»©c Ä‘á»ƒ ghi nháº­n káº¿t quáº£
        updateDisplay();
        saveGame();

        // XÃ³a element sau khi animation xong
        setTimeout(() => {
            wrapper.remove();
        }, 500);
    };

    // ThÃªm vÃ o vÃ¹ng Main Ä‘á»ƒ hiá»ƒn thá»‹
    document.querySelector('main').appendChild(wrapper);
}

const chaosBlacksmith = document.getElementById("chaos-blacksmith");
if (chaosBlacksmith) {
    chaosBlacksmith.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
        showBlacksmithPopup();
    });
}
// --- Sá»° KIá»†N CLICK CHO áº¢NH Äá»˜NG (Má»šI) ---
const chaosBlacksmithWorking = document.getElementById("chaos-blacksmith-working");
if (chaosBlacksmithWorking) {
    chaosBlacksmithWorking.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
        showBlacksmithPopup();
    });
}


function showBlacksmithPopup() {
    interactionTitle.innerHTML = "ğŸ”¨ Thá»£ RÃ¨n Chaos";
    interactionText.style.display = 'none';
    interactionControls.innerHTML = "";

    // 1. HEADER TÃ€I NGUYÃŠN (Giá»¯ nguyÃªn pháº§n hiá»ƒn thá»‹ Ä‘áº¹p)
    const resourceHeader = document.createElement("div");
    resourceHeader.style.cssText = "display:flex; justify-content:space-around; background:#FFF3E0; padding:10px; border-radius:12px; margin-bottom:12px; font-size:0.9em; border:2px solid #FFE0B2; box-shadow: inset 0 0 5px rgba(0,0,0,0.05);";
    resourceHeader.innerHTML = `
        <div style="display:flex; align-items:center; gap:5px;">
            <span style="font-size:1.2em;">ğŸ«˜</span> 
            <div>
                <div style="font-size:0.7em; color:#795548; font-weight:bold; text-transform:uppercase;">Äáº­u</div>
                <b style="color:#5D4037; font-size:1.1em;">${dau.toLocaleString()}</b>
            </div>
        </div>
        <div style="width:1px; background:#FFCC80;"></div>
        <div style="display:flex; align-items:center; gap:5px;">
            <img src="1000000136.png" style="width:20px; height:20px;">
            <div>
                <div style="font-size:0.7em; color:#546E7A; font-weight:bold; text-transform:uppercase;">Máº£nh K.Loáº¡i</div>
                <b style="color:#37474F; font-size:1.1em;">${(ownedArtifacts['manh_kim_loai']||0).toLocaleString()}</b>
            </div>
        </div>
    `;
    interactionControls.appendChild(resourceHeader);
    
    // 2. CONTAINER CHÃNH
    const scrollContainer = document.createElement("div");
    scrollContainer.style.cssText = 'max-height: 400px; overflow-y: auto; padding: 2px;';
    
    // 3. DANH SÃCH HÃ€NG CHá»œ (QUEUE)
    const queueContainer = document.createElement("div");
    queueContainer.id = "crafting-queue-list";
    scrollContainer.appendChild(queueContainer);
    
    // 4. DANH SÃCH CÃ”NG THá»¨C (DÃ¹ng tháº» DIV thay vÃ¬ TABLE)
    const listContainer = document.createElement('div');
    listContainer.className = 'blacksmith-list';
    
    const isSmithBusy = craftingQueue.length > 0;

    CRAFTING_RECIPES.forEach(recipe => {
        // Kiá»ƒm tra Ä‘iá»u kiá»‡n Äáº­u
        const hasDau = dau >= (recipe.cost.dau || 0);
        
        let reqHtml = '';
        let canCraftMaterials = true;

        // Xá»­ lÃ½ hiá»ƒn thá»‹ nguyÃªn liá»‡u
        Object.keys(recipe.materials).forEach(matKey => {
            const reqQty = recipe.materials[matKey];
            let currentAmt = 0;
            let matName = matKey;

            // Láº¥y tÃªn vÃ  sá»‘ lÆ°á»£ng hiá»‡n cÃ³
            if (matKey === 'manh_kim_loai') {
                 currentAmt = ownedArtifacts['manh_kim_loai'] || 0;
                 matName = "Máº£nh KL"; // Viáº¿t táº¯t cho gá»n
            } else if (POT_DEFINITIONS[matKey]) {
                 currentAmt = ownedPots[matKey] || 0;
                 matName = POT_DEFINITIONS[matKey].name;
            } else if (matKey === 'so_dua') { // Fallback tÃªn Sá» Dá»«a
                 currentAmt = ownedPots['so_dua'] || 0;
                 matName = "Sá» Dá»«a";
            }

            const hasItem = currentAmt >= reqQty;
            if (!hasItem) canCraftMaterials = false;
            
            // DÃ²ng nguyÃªn liá»‡u nhá» gá»n
            reqHtml += `
                <div class="req-line ${hasItem ? 'req-ok' : 'req-miss'}">
                    <span style="font-size:0.8em;">${hasItem ? 'â—' : 'â—‹'}</span> 
                    <span>${matName}: ${currentAmt}/${reqQty}</span>
                </div>`;
        });
        
        // DÃ²ng yÃªu cáº§u Äáº­u
        reqHtml += `
            <div class="req-line ${hasDau ? 'req-ok' : 'req-miss'}">
                <span style="font-size:0.8em;">${hasDau ? 'â—' : 'â—‹'}</span>
                <span>Äáº­u: ${recipe.cost.dau.toLocaleString()}</span>
            </div>`;

        // Logic nÃºt báº¥m
        let isBlockedByBusy = (recipe.duration > 0 && isSmithBusy);
        const canCraft = hasDau && canCraftMaterials && !isBlockedByBusy;
        
        let btnText = "RÃ¨n";
        let btnBg = "var(--accent)";
        
        if (recipe.duration === 0) {
            btnText = "Mua";
            btnBg = "#4CAF50"; // MÃ u xanh lÃ¡ cho nÃºt Mua
        } else if (isBlockedByBusy) {
            btnText = "Báº­n";
            btnBg = "#9E9E9E";
        }

        // Táº O GIAO DIá»†N HÃ€NG (ROW)
        const rowDiv = document.createElement('div');
        rowDiv.className = 'blacksmith-row';
        rowDiv.innerHTML = `
            <div class="bs-info">
                <div class="bs-icon-box">
                    <img src="${recipe.icon}" alt="${recipe.name}">
                </div>
                <div class="bs-name">${recipe.name}</div>
            </div>

            <div class="bs-req">
                ${reqHtml}
            </div>

            <div class="bs-action">
                <button id="btn-craft-${recipe.id}" class="btn-crafting" 
                    style="
                        width: auto; 
                        padding: 8px 16px; 
                        background: ${canCraft ? btnBg : '#ccc'}; 
                        cursor: ${canCraft ? 'pointer' : 'not-allowed'};
                        box-shadow: ${canCraft ? '0 2px 0 rgba(0,0,0,0.2)' : 'none'};
                    " 
                    ${canCraft ? '' : 'disabled'}>
                    ${btnText}
                </button>
            </div>
        `;

        // GÃ¡n sá»± kiá»‡n click (giá»¯ nguyÃªn logic cÅ©)
        setTimeout(() => {
            const btn = rowDiv.querySelector(`#btn-craft-${recipe.id}`);
            if(btn) btn.onclick = () => startCrafting(recipe);
        }, 0);

        listContainer.appendChild(rowDiv);
    });

    scrollContainer.appendChild(listContainer);
    interactionControls.appendChild(scrollContainer); 

    // Render hÃ ng chá» vÃ  kÃ­ch hoáº¡t interval
    renderCraftingQueue();
    showPopup('interaction-popup');
    
    if (activePopupInterval) clearInterval(activePopupInterval);
    activePopupInterval = setInterval(renderCraftingQueue, 1000);
}

function startCrafting(recipe) {
    if (craftingQueue.length > 0 && recipe.duration > 0) {
        alert("Thá»£ rÃ¨n Ä‘ang báº­n! Vui lÃ²ng Ä‘á»£i rÃ¨n xong mÃ³n hiá»‡n táº¡i.");
        return;
    }

    if (dau < (recipe.cost.dau || 0)) return;
    
    for (const [matKey, matQty] of Object.entries(recipe.materials)) {
        let currentAmt = 0;
        // --- Sá»¬A: KIá»‚M TRA KHO Máº¢NH ---
        if (matKey === 'manh_kim_loai') currentAmt = ownedArtifacts['manh_kim_loai'] || 0;
        else if (ownedPots[matKey] !== undefined) currentAmt = ownedPots[matKey] || 0;
        
        if (currentAmt < matQty) {
            alert("KhÃ´ng Ä‘á»§ nguyÃªn liá»‡u!");
            return;
        }
    }

    const actionName = recipe.duration === 0 ? "Mua" : "RÃ¨n";

    if(confirm(`Báº¡n muá»‘n ${actionName} ${recipe.name}?`)) {
        dau -= (recipe.cost.dau || 0);
        
        for (const [matKey, matQty] of Object.entries(recipe.materials)) {
            // --- Sá»¬A: TRá»ª NGUYÃŠN LIá»†U Máº¢NH ---
            if (matKey === 'manh_kim_loai') {
                 ownedArtifacts['manh_kim_loai'] -= matQty;
            } else if (ownedPots[matKey] !== undefined) {
                 ownedPots[matKey] -= matQty;
            }
        }

        if (recipe.duration === 0) {
             if (!ownedPots[recipe.output]) ownedPots[recipe.output] = 0;
             ownedPots[recipe.output]++;
             alert(`ÄÃ£ mua thÃ nh cÃ´ng ${recipe.name}!`);
             updateDisplay();
             showBlacksmithPopup(); 
        } else {
            craftingQueue.push({ output: recipe.output, name: recipe.name, startTime: Date.now(), finishTime: Date.now() + recipe.duration });
            alert("ÄÃ£ báº¯t Ä‘áº§u rÃ¨n!");
            updateDisplay();
            showBlacksmithPopup();
            updateBlacksmithVisuals(); 
        }
    }
}

function renderCraftingQueue() {
    const container = document.getElementById("crafting-queue-list");
    if (!container) return;
    
    container.innerHTML = "";
    if (craftingQueue.length === 0) return;
    
    const queueList = document.createElement('div');
    queueList.style.cssText = 'border: 2px dashed #FF9800; padding: 10px; border-radius: 8px; margin-bottom: 15px; background: rgba(255, 236, 179, 0.5);';
    container.appendChild(queueList);

    const now = Date.now();
    let updated = false;

    for (let i = craftingQueue.length - 1; i >= 0; i--) {
        const item = craftingQueue[i];
        const timeLeft = item.finishTime - now;
        
        if (timeLeft <= 0) {
            craftingQueue.splice(i, 1);
            if (!ownedPots[item.output]) ownedPots[item.output] = 0;
            ownedPots[item.output]++;
            alert(`âœ… RÃ¨n thÃ nh cÃ´ng: ${item.name}!`);
            updated = true;
        } else {
            const div = document.createElement("div");
            
            // --- Cáº¬P NHáº¬T HIá»‚N THá»Š THá»œI GIAN Äáº¸P HÆ N ---
            let seconds = Math.floor((timeLeft / 1000) % 60);
            let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
            let hours = Math.floor((timeLeft / (1000 * 60 * 60)));
            
            let timeString = "";
            if(hours > 0) timeString += `${hours}h `;
            if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
            timeString += `${seconds}s`;

            div.style.fontWeight = "bold";
            div.innerHTML = `ğŸ”¥ ${item.name}: <span style="color:#E65100">${timeString}</span>`;
            queueList.appendChild(div);
        }
    }
    
    if (updated) {
        updateDisplay();
        if (document.getElementById('interaction-popup').classList.contains('popup-active')) showBlacksmithPopup();
    }
}

function checkGlobalCrafting() {
    if(craftingQueue.length > 0) {
        const now = Date.now();
        let updated = false;
        for (let i = craftingQueue.length - 1; i >= 0; i--) {
            if (now >= craftingQueue[i].finishTime) {
                const item = craftingQueue[i];
                craftingQueue.splice(i, 1);
                if (!ownedPots[item.output]) ownedPots[item.output] = 0;
                ownedPots[item.output]++;
                alert(`âœ… RÃ¨n thÃ nh cÃ´ng: ${item.name}!`);
                updated = true;
            }
        }
        if (updated) updateDisplay();
        updateBlacksmithVisuals(); // Cáº¬P NHáº¬T Láº I Náº¾U HÃ€NG CHá»œ Rá»–NG
    }
}

const brandContainer = document.querySelector(".brand");
if (brandContainer) {
    brandContainer.addEventListener("click", () => {
        if (level === 0) return;
        const maxExp = expNeeded(level);
        const percent = ((exp / maxExp) * 100).toFixed(1);
        
        interactionTitle.innerHTML = `ğŸ“Š Cáº¥p Ä‘á»™ ${level}`;
        interactionText.style.display = 'block';
        interactionText.innerHTML = `
            <div style="text-align:left; background:#f5f5f5; padding:15px; border-radius:10px;">
                ğŸŒ± <b>Kinh nghiá»‡m:</b> ${exp.toLocaleString()} / ${maxExp.toLocaleString()}<br>
                ğŸ“ˆ <b>Tiáº¿n Ä‘á»™:</b> ${percent}%
            </div>
        `;
        interactionControls.innerHTML = '';
        showPopup('interaction-popup');
    });
}

// --- Bá»” SUNG HÃ€M GÃN Sá»° KIá»†N CHO Váº¬T PHáº¨M TREO (CHÃ‚U CHáº¤U...) ---
function initGrasshopperEvents() {
    // Láº¥y táº¥t cáº£ cÃ¡c tháº» img dÃ¹ng Ä‘á»ƒ hiá»ƒn thá»‹ váº­t pháº©m treo
    // ID cá»§a chÃºng lÃ  grasshopper-0, grasshopper-1, ...
    for (let i = 0; i < 5; i++) {
        const itemEl = document.getElementById(`grasshopper-${i}`);
        if (itemEl) {
            // Clone Ä‘á»ƒ xÃ³a sá»± kiá»‡n cÅ© (náº¿u cÃ³)
            const newItemEl = itemEl.cloneNode(true);
            itemEl.parentNode.replaceChild(newItemEl, itemEl);

            newItemEl.addEventListener('click', () => {
                if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
                // Má»Ÿ popup dÃ¢y leo táº¡i vá»‹ trÃ­ tÆ°Æ¡ng á»©ng
                showVinePopup(i);
            });
        }
    }
}
// --- Sá»¬A Láº I LOGIC KIá»‚M TRA TRá»¨NG Ná» ---
function checkIncubationState() {
    if (incubationFinishTime > 0) {
        const now = Date.now();
        if (now >= incubationFinishTime) {
            incubationFinishTime = 0; // XÃ³a thá»i gian chá»

            // TRÆ¯á»œNG Há»¢P 1: áº¤P Ná» THÃ€NH CÃ”NG
            if (hasIceEgg) {
                hasIceEgg = false; // Máº¥t trá»©ng
                isIceDragonHatched = true; 
                isIceDragonEvolved = true; 

                // Reset level vá» 1
                petLevels[hatchedPetType] = 1;
                petStarLevel = 1; 

                // --- Sá»¬A á» ÄÃ‚Y: ThÃªm trÆ°á»ng há»£p Bi Gai ---
                let petName = "Bi Gai";
                if (hatchedPetType === 'thien_than') petName = "ThiÃªn Tháº§n";
                if (hatchedPetType === 'than_chet') petName = "Tháº§n Cháº¿t";
                // -----------------------------------------

                if(typeof showToast === 'function') {
                    showToast(`Ná»Ÿ thÃ nh cÃ´ng: ${petName}`, "ğŸ£", "ChÃºc Má»«ng");
                } else {
                    alert(`ğŸ‰ CHÃšC Má»ªNG! Trá»©ng Ä‘Ã£ ná»Ÿ thÃ nh: ${petName}!`);
                }
            } 
            
            // TRÆ¯á»œNG Há»¢P 2: NÃ‚NG Cáº¤P THÃ€NH CÃ”NG
            else if (isIceDragonHatched) {
                if (!petLevels[hatchedPetType]) petLevels[hatchedPetType] = 1;
                if (petLevels[hatchedPetType] < 5) {
                    petLevels[hatchedPetType]++; 
                    petStarLevel = petLevels[hatchedPetType]; 
                    
                    if(typeof showToast === 'function') {
                        showToast(`LÃªn cáº¥p thÃ nh cÃ´ng!`, "ğŸŒŸ");
                    }
                }
            } 

            updateDisplay();
            saveGame();
            if(document.getElementById('interaction-popup').classList.contains('popup-active')) {
                hidePopup('interaction-popup');
            }
        }
    }
}
// ======================================================
// --- LOGIC TÆ¯Æ NG TÃC DÃ‚Y LEO & CHÃ‚U CHáº¤U (Má»šI) ---
// ======================================================

// 1. GÃ¡n sá»± kiá»‡n click cho cÃ¡c dÃ¢y leo ngay khi cháº¡y game
// LÆ°u Ã½: HÃ m nÃ y sáº½ tá»± cháº¡y nhá» logic bÃªn dÆ°á»›i, báº¡n khÃ´ng cáº§n gá»i thá»§ cÃ´ng
function initVineEvents() {
    const vines = document.querySelectorAll('.vine-deco');
    vines.forEach(vine => {
        // XÃ³a sá»± kiá»‡n cÅ© Ä‘á»ƒ trÃ¡nh bá»‹ double click (náº¿u cÃ³)
        const newVine = vine.cloneNode(true); 
        vine.parentNode.replaceChild(newVine, vine);
        
        newVine.addEventListener('click', (e) => {
            if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
            
            // Láº¥y vá»‹ trÃ­ dÃ¢y leo (0-4) tá»« HTML
            const index = parseInt(e.target.getAttribute('data-index'));
            showVinePopup(index);
        });
    });
}

// Gá»i hÃ m gÃ¡n sá»± kiá»‡n nÃ y má»—i khi khá»Ÿi táº¡o
// (Báº¡n hÃ£y tÃ¬m dÃ²ng initializeGame vÃ  thÃªm initVineEvents() vÃ o trong Ä‘Ã³ náº¿u muá»‘n cháº¯c cháº¯n,
// hoáº·c dÃ¡n dÃ²ng nÃ y vÃ o cuá»‘i file script: setTimeout(initVineEvents, 1000); )


// --- 2. HÃ m hiá»ƒn thá»‹ Popup khi click vÃ o dÃ¢y leo (ÄÃƒ LÃ€M Äáº¸P & LOGIC HÆ N) ---
function showVinePopup(index) {
    // Reset tiÃªu Ä‘á»
    interactionTitle.innerHTML = `ğŸŒ¿ DÃ¢y Leo (Vá»‹ trÃ­ ${index + 1})`;

    // 1. KIá»‚M TRA & HIá»‚N THá»Š COMBO
    const isFullSet = vineDecorations.every(item => item !== null);
    let comboHTML = "";
    
    if (isFullSet) {
        comboHTML = `
        <div style="
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
            border: 2px solid #fbc02d;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: #5d4037;
        ">
            <div style="font-size:1.2em; margin-bottom:5px;">âš¡âš¡âš¡</div>
            <strong style="color:#f57f17; font-size:1em;">ÄÃƒ KÃCH HOáº T COMBO!</strong>
            <div style="font-size:0.85em; margin-top:2px;">ToÃ n bá»™ cÃ¢y trá»“ng Ä‘Æ°á»£c giáº£m <b>2 giá»</b> trÆ°á»Ÿng thÃ nh.</div>
        </div>`;
    } else {
        const missingCount = vineDecorations.filter(x => x === null).length;
        comboHTML = `
        <div style="
            background: rgba(0,0,0,0.05); /* Sá»­a: ná»n bÃ¡n trong suá»‘t Ä‘á»ƒ Ä‘áº¹p cáº£ khi tá»‘i/sÃ¡ng */
            border: 1px dashed #bdbdbd;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        ">
            <strong style="color:var(--text-muted);">ChÆ°a kÃ­ch hoáº¡t Combo</strong>
            <div style="font-size:0.85em; color:var(--text-muted); margin-top:2px;">
                Cáº§n treo thÃªm <b>${missingCount}</b> mÃ³n ná»¯a Ä‘á»ƒ giáº£m <b>2 giá»</b> (Hiá»‡n táº¡i chá»‰ giáº£m 1h/mÃ³n).
            </div>
        </div>`;
    }

    interactionText.innerHTML = comboHTML;
    interactionControls.innerHTML = '';

    // 2. Táº O DANH SÃCH Váº¬T PHáº¨M
    const listContainer = document.createElement('div');
    listContainer.style.cssText = `
        max-height: 280px; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        padding: 5px;
    `;

    const currentDecoID = vineDecorations[index];

    // Duyá»‡t qua táº¥t cáº£ váº­t pháº©m cáº¥u hÃ¬nh Ä‘á»ƒ hiá»ƒn thá»‹
    HANGING_ITEMS_CONFIG.forEach(item => {
        const ownedAmount = ownedDecorations[item.id] || 0;
        const isEquippedHere = (currentDecoID === item.id);
        
        const itemRow = document.createElement('div');
        // Sá»¬A: ThÃªm class 'shop-item' Ä‘á»ƒ tá»± Ä‘á»™ng Ä‘á»•i mÃ u ná»n khi Dark Mode
        itemRow.className = 'shop-item';
        
        // Ghi Ä‘Ã¨ CSS flex Ä‘á»ƒ xáº¿p ngang (máº·c Ä‘á»‹nh shop-item xáº¿p dá»c)
        itemRow.style.cssText = `
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            justify-content: space-between;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: transform 0.1s;
        `;
        
        // Náº¿u Ä‘ang treo thÃ¬ Ä‘á»•i mÃ u ná»n Ä‘áº·c biá»‡t (Váº«n giá»¯ logic cÅ© nhÆ°ng dÃ¹ng mÃ u RGBA Ä‘á»ƒ há»£p Dark mode)
        if(isEquippedHere) {
             itemRow.style.border = "1px solid #4CAF50";
             itemRow.style.background = "rgba(76, 175, 80, 0.1)"; // Xanh nháº¡t trong suá»‘t
        }

        // Logic xÃ¡c Ä‘á»‹nh tÃ¡c dá»¥ng
        const speedUpItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
        let effectBadge = "";
        if (speedUpItems.includes(item.id)) {
            effectBadge = `<span style="background:#E3F2FD; color:#1565C0; font-size:0.7em; padding:2px 6px; border-radius:4px; font-weight:bold;">âš¡ -1 Giá»</span>`;
        }

        // Logic NÃºt Báº¥m
        let btnHtml = '';
        if (isEquippedHere) {
            btnHtml = `<button disabled style="
                background:transparent; color:#2E7D32; border: 2px solid #2E7D32; 
                border-radius:20px; padding:5px 10px; font-weight:bold; font-size: 0.8em; opacity: 0.7;">
                âœ” Äang dÃ¹ng
            </button>`;
        } else if (ownedAmount > 0) {
            btnHtml = `<button class="btn-equip-item" data-id="${item.id}" style="
                background:var(--primary); color:white; border:none; 
                border-radius:20px; padding:6px 15px; cursor:pointer; font-weight:bold; font-size: 0.85em; 
                box-shadow: 0 2px 0 var(--primary-dark);">
                Treo
            </button>`;
        } else {
            btnHtml = `<button onclick="document.getElementById('event-cloud').click()" style="
                background: rgba(0,0,0,0.1); color: var(--text-muted); border:1px solid #ddd; 
                border-radius:20px; padding:5px 10px; cursor:pointer; font-size: 0.8em;">
                ğŸ” TÃ¬m
            </button>`;
        }

        // Sá»¬A: DÃ¹ng class "icon-box-bg" cho Ã´ chá»©a áº£nh
        itemRow.innerHTML = `
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon-box-bg" style="
                    width:45px; height:45px; 
                    border-radius:8px; 
                    display:flex; align-items:center; justify-content:center;
                ">
                    <img src="${item.img}" style="width:80%; height:80%; object-fit:contain;">
                </div>
                <div style="text-align:left;">
                    <div style="font-weight:700; color:var(--text-main); font-size: 0.95em;">${item.name}</div>
                    <div style="display:flex; align-items:center; gap:5px; margin-top:2px;">
                        ${effectBadge}
                        <span style="font-size:0.75em; color:var(--text-muted);">Kho: <b>${ownedAmount}</b></span>
                    </div>
                </div>
            </div>
            <div>${btnHtml}</div>
        `;
        
        listContainer.appendChild(itemRow);
    });

    interactionControls.appendChild(listContainer);

    // 3. NÃšT Gá»  Bá» (Náº¿u Ä‘ang treo Ä‘á»“)
    if (currentDecoID !== null) {
        const removeContainer = document.createElement('div');
        removeContainer.style.marginTop = "15px";
        removeContainer.style.borderTop = "1px dashed #ddd";
        removeContainer.style.paddingTop = "10px";

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = "âŒ Gá»¡ váº­t pháº©m nÃ y xuá»‘ng";
        removeBtn.className = "btn-remove-vines"; 
        
        removeBtn.onclick = () => {
            if(confirm("Báº¡n muá»‘n gá»¡ váº­t pháº©m nÃ y vá» kho?")) {
                if (!ownedDecorations[currentDecoID]) ownedDecorations[currentDecoID] = 0;
                ownedDecorations[currentDecoID]++;
                vineDecorations[index] = null; // XÃ³a khá»i dÃ¢y
                saveGame(); updateDisplay(); closeInteractionPopup();
            }
        };
        removeContainer.appendChild(removeBtn);
        interactionControls.appendChild(removeContainer);
    }

    // 4. GÃN Sá»° KIá»†N CHO NÃšT TREO
    const equipBtns = listContainer.querySelectorAll('.btn-equip-item');
    equipBtns.forEach(btn => {
        btn.onclick = (e) => {
            const itemId = e.target.getAttribute('data-id');
            const itemData = HANGING_ITEMS_CONFIG.find(i => i.id === itemId);

            if (currentDecoID) {
                if (!ownedDecorations[currentDecoID]) ownedDecorations[currentDecoID] = 0;
                ownedDecorations[currentDecoID]++;
            }

            if (ownedDecorations[itemId] > 0) {
                ownedDecorations[itemId]--;
                vineDecorations[index] = itemId;
                alert(`ÄÃ£ treo ${itemData.name}!\n(Hiá»‡u á»©ng: Giáº£m 1h trÆ°á»Ÿng thÃ nh)`);
                saveGame(); updateDisplay(); closeInteractionPopup();
            }
        };
    });

    showPopup('interaction-popup');
}
// --- Sá»° KIá»†N CLICK MÃ‚Y ÄEN (SHOP Äá»”I Äá»’ TREO - GIAO DIá»†N GIá»NG THá»¢ RÃˆN) ---
const eventCloud = document.getElementById("event-cloud");
if (eventCloud) {
    eventCloud.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
        
        const myCrowns = ownedArtifacts['vuong_mien'] || 0;
        const MAX_EXCHANGE = 5; 

        // --- 1. HEADER Sá»° KIá»†N (Style giá»‘ng thanh tÃ i nguyÃªn Thá»£ RÃ¨n) ---
        interactionTitle.innerHTML = "ğŸ‰ Shop Sá»± Kiá»‡n";
        
        // --- Sá»¬A Táº I ÄÃ‚Y: áº¨n khung text Ä‘i Ä‘á»ƒ loáº¡i bá» khoáº£ng trá»‘ng 50px ---
        interactionText.style.display = 'none'; 
        interactionText.innerHTML = ""; 
        // ------------------------------------------------------------------

        // Táº¡o thanh hiá»ƒn thá»‹ tÃ i nguyÃªn
        const resourceHeader = document.createElement("div");
        // ÄÃ£ giáº£m margin-bottom tá»« 12px xuá»‘ng 5px cho gá»n hÆ¡n ná»¯a
        resourceHeader.style.cssText = "display:flex; justify-content:center; align-items:center; background:#FCE4EC; padding:10px; border-radius:12px; margin-bottom:5px; font-size:0.9em; border:2px solid #F8BBD0; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); gap: 15px;";
        resourceHeader.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
                <img src="1000000137.png" style="width:25px; height:25px; filter:drop-shadow(0 2px 2px rgba(0,0,0,0.2));">
                <div>
                    <div style="font-size:0.7em; color:#880E4F; font-weight:bold; text-transform:uppercase;">VÆ°Æ¡ng Miá»‡n</div>
                    <b style="color:#C2185B; font-size:1.2em;">${myCrowns.toLocaleString('vi-VN')}</b>
                </div>
            </div>
        `;
        interactionControls.innerHTML = '';
        interactionControls.appendChild(resourceHeader);
        
        // --- 2. CONTAINER DANH SÃCH (DÃ¹ng class blacksmith-list) ---
        const listContainer = document.createElement('div');
        listContainer.className = 'blacksmith-list'; // TÃ¡i sá»­ dá»¥ng class CSS cá»§a Thá»£ RÃ¨n
        listContainer.style.maxHeight = "350px";
        listContainer.style.overflowY = "auto";

        HANGING_ITEMS_CONFIG.forEach(item => {
            const currentOwned = ownedDecorations[item.id] || 0;
            const isMaxed = currentOwned >= MAX_EXCHANGE; 
            const canAfford = myCrowns >= item.price;     

            // Huy hiá»‡u hiá»‡u á»©ng
            const speedUpItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
            let badgeHTML = "";
            if (speedUpItems.includes(item.id)) {
                badgeHTML = `<div style="font-size:0.7em; color:#1565C0; background:#E3F2FD; padding:2px 5px; border-radius:4px; display:inline-block; margin-top:3px; font-weight:bold;">âš¡ -1h</div>`;
            }

            // Tráº¡ng thÃ¡i nÃºt báº¥m
            let btnText = "Äá»•i";
            let btnBg = "linear-gradient(45deg, #EC407A, #D81B60)"; // MÃ u há»“ng Ä‘áº­m
            let btnCursor = "pointer";
            let btnDisabled = false;

            if (isMaxed) {
                btnText = "Max";
                btnBg = "#9E9E9E"; 
                btnCursor = "default";
                btnDisabled = true;
            } else if (!canAfford) {
                btnText = "Thiáº¿u"; 
                btnBg = "#cfd8dc"; 
                btnCursor = "not-allowed";
                btnDisabled = true;
            }

            // Táº¡o hÃ ng (Row) dÃ¹ng class blacksmith-row
            const rowDiv = document.createElement('div');
            rowDiv.className = 'blacksmith-row'; // TÃ¡i sá»­ dá»¥ng class CSS Row
            
            // Náº¿u Ä‘Ã£ Max thÃ¬ lÃ m má» Ä‘i chÃºt
            if(isMaxed) rowDiv.style.opacity = "0.7";

            // --- [ÄÃƒ Sá»¬A Táº I ÄÃ‚Y] ---
            // 1. XÃ³a style="border-color:#f8bbd0;" á»Ÿ bs-icon-box
            // 2. XÃ³a style="border-color:#f8bbd0;" á»Ÿ bs-req
            rowDiv.innerHTML = `
                <div class="bs-info">
                    <div class="bs-icon-box"> <img src="${item.img}" alt="${item.name}">
                    </div>
                    <div class="bs-name">
                        ${item.name}
                        ${badgeHTML}
                    </div>
                </div>

                <div class="bs-req"> <div class="req-line ${canAfford ? 'req-ok' : 'req-miss'}">
                        <span>ğŸ‘‘ ${item.price}</span>
                    </div>
                    <div class="req-line" style="color:#555;">
                        <span style="font-size:0.8em;">Kho: </span> <b>${currentOwned}/${MAX_EXCHANGE}</b>
                    </div>
                </div>

                <div class="bs-action">
                    <button class="btn-exchange-event" data-id="${item.id}" ${btnDisabled ? 'disabled' : ''}
                        style="
                            width: auto; 
                            padding: 6px 14px; 
                            background: ${btnBg}; 
                            color: white; border: none; border-radius: 8px; 
                            font-weight: 700; font-size: 11px;
                            cursor: ${btnCursor};
                            box-shadow: ${btnDisabled ? 'none' : '0 2px 0 rgba(0,0,0,0.2)'};
                        ">
                        ${btnText}
                    </button>
                </div>
            `;
            
            listContainer.appendChild(rowDiv);
        });

        interactionControls.appendChild(listContainer);
        
        // --- 3. Xá»¬ LÃ CLICK Äá»”I Äá»’ ---
        const buttons = listContainer.querySelectorAll('.btn-exchange-event');
        buttons.forEach(btn => {
            btn.onclick = (e) => {
                const itemId = e.target.getAttribute('data-id');
                const itemData = HANGING_ITEMS_CONFIG.find(i => i.id === itemId);
                const currentOwned = ownedDecorations[itemId] || 0;

                if (currentOwned >= MAX_EXCHANGE) return; 

                if (ownedArtifacts['vuong_mien'] >= itemData.price) {
                    e.target.style.transform = "scale(0.95)";
                    setTimeout(() => {
                         if (confirm(`Äá»•i ${itemData.price} VÆ°Æ¡ng Miá»‡n láº¥y 1 ${itemData.name}?`)) {
                            ownedArtifacts['vuong_mien'] -= itemData.price;
                            if (!ownedDecorations[itemId]) ownedDecorations[itemId] = 0;
                            ownedDecorations[itemId]++;
                            
                            saveGame();
                            updateDisplay();
                            eventCloud.click(); // Load láº¡i popup Ä‘á»ƒ cáº­p nháº­t sá»‘ lÆ°á»£ng
                        } else {
                            e.target.style.transform = "scale(1)";
                        }
                    }, 100);
                }
            };
        });

        showPopup('interaction-popup');
    });
}
// --- HÃ€M Má» 3 LÃ” (PHIÃŠN Báº¢N GRID Äáº¸P) ---
function openInventory() {
    // 1. Kiá»ƒm tra náº¿u chÆ°a táº¡o game thÃ¬ cháº·n láº¡i
    if (level === 0) { 
        alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); 
        return; 
    }

    // 2. Cáº­p nháº­t sá»‘ Äáº­u vÃ  LÃ¡ trÃªn Ä‘áº§u báº£ng
    const invDauEl = document.getElementById('inv-dau');
    const invLaEl = document.getElementById('inv-la');
    
    if (invDauEl) invDauEl.innerText = dau.toLocaleString('vi-VN');
    if (invLaEl) invLaEl.innerText = la.toLocaleString('vi-VN');

    // 3. Äáº£m báº£o biáº¿n kho Ä‘á»“ tá»“n táº¡i
    if (typeof ownedArtifacts === 'undefined') { window.ownedArtifacts = {}; }

    // 4. DANH SÃCH CÃC Váº¬T PHáº¨M Sáº¼ HIá»‚N THá»Š
    // (Báº¡n cÃ³ thá»ƒ thÃªm mÃ³n má»›i vÃ o danh sÃ¡ch nÃ y sau nÃ y)
    const itemsToShow = [
        // --- NguyÃªn liá»‡u ---
        { id: 'manh_nguyen_to', name: 'Máº£nh Ng.Tá»‘',   img: '1000000135.png' },
        { id: 'manh_kim_loai', name: 'Máº£nh Kim Loáº¡i',img: '1000000136.png' },
        { id: 'vuong_mien',    name: 'VÆ°Æ¡ng Miá»‡n',    img: '1000000137.png' },
        { id: 'nhong_ong',     name: 'Nhá»™ng Ong',     img: '1000000145.png' },
        // --- CÃ¡c loáº¡i cÃ¡ ---
        { id: 'ca_tre',        name: 'CÃ¡ TrÃª',        img: '1000000148.png' },
        { id: 'ca_do',         name: 'CÃ¡ Dá»“',         img: '1000000146.png' },
        { id: 'ca_tai_tuong',  name: 'CÃ¡ Tai TÆ°á»£ng',  img: '1000000147.png' }
    ];

    // 5. TÃ¬m khung hiá»ƒn thá»‹ vÃ  xÃ³a ná»™i dung cÅ©
    const listContainer = document.getElementById('inventory-list');
    if (listContainer) {
        listContainer.innerHTML = ''; 
        
        // Quan trá»ng: Äáº·t láº¡i display grid Ä‘á»ƒ chia cá»™t
        listContainer.style.display = 'grid'; 

        let hasItem = false; 

        // 6. Duyá»‡t qua tá»«ng mÃ³n, náº¿u cÃ³ sá»‘ lÆ°á»£ng > 0 thÃ¬ váº½ ra
        itemsToShow.forEach(item => {
            let qty = ownedArtifacts[item.id] || 0;
            
            if (qty > 0) {
                hasItem = true;
                let div = document.createElement('div');
                div.className = 'inventory-item';
                
                // Váº½ HTML cho tá»«ng Ã´ (áº¢nh + TÃªn + Sá»‘ lÆ°á»£ng)
                div.innerHTML = `
                    <div class="inventory-img-box">
                        <img src="${item.img}" alt="${item.name}">
                    </div>
                    <div class="inventory-name">
                        ${item.name}
                    </div>
                    <div class="inventory-qty">
                        x${qty.toLocaleString('vi-VN')}
                    </div>
                `;
                listContainer.appendChild(div);
            }
        });

        // 7. Náº¿u tÃºi rá»—ng (khÃ´ng cÃ³ mÃ³n nÃ o > 0)
        if (!hasItem) {
            listContainer.style.display = 'block'; // Chuyá»ƒn vá» block Ä‘á»ƒ cÄƒn giá»¯a thÃ´ng bÃ¡o
            listContainer.innerHTML = `
                <div style="text-align:center; padding:50px 20px; color:#bdbdbd;">
                    <div style="font-size:3em; margin-bottom:10px; opacity:0.5;">ğŸ’</div>
                    <div>ChÆ°a cÃ³ váº­t pháº©m nÃ o.</div>
                </div>
            `;
        }
    }

    // 8. Hiá»‡n Popup lÃªn
    showPopup('inventory-box');
}
// --- CHá»¨C NÄ‚NG GIFTCODE (ÄÃƒ Tá»I Æ¯U) ---
// --- HÃ€M Má»šI: Dá»«ng khÃ³i vÃ  xÃ³a sáº¡ch khÃ³i ---
function stopSmokeEffect() {
    if (window.smokeInterval) {
        clearInterval(window.smokeInterval);
        window.smokeInterval = null;
    }
    // XÃ³a ngay cÃ¡c háº¡t khÃ³i cÃ²n sÃ³t láº¡i trÃªn mÃ n hÃ¬nh
    document.querySelectorAll('.smoke-particle').forEach(el => el.remove());
}

// --- HÃ€M Má»šI: Kiá»ƒm tra xem cÃ³ nÃªn hiá»‡n HÃ²m ThÃ­nh khÃ´ng ---
function updateGiftcodeBoxState() {
    const box = document.getElementById('giftcode-supply-drop');
    if (!box) return;

    // Kiá»ƒm tra: CÃ³ mÃ£ nÃ o trong danh sÃ¡ch ACTIVE mÃ  user chÆ°a dÃ¹ng khÃ´ng?
    const hasUnusedCode = ACTIVE_GIFTCODES.some(code => !usedGiftcodes.includes(code));

    if (hasUnusedCode) {
        // Náº¿u cÃ²n mÃ£ chÆ°a dÃ¹ng -> Hiá»‡n hÃ²m vÃ  Báº­t khÃ³i
        box.style.display = 'block';
        startSmokeEffect(); 
    } else {
        // Náº¿u Ä‘Ã£ dÃ¹ng háº¿t sáº¡ch mÃ£ -> áº¨n hÃ²m vÃ  Táº¯t khÃ³i ngay láº­p tá»©c
        box.style.display = 'none';
        stopSmokeEffect();
    }
}
function showGiftcodePopup() {
    if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
    const inputEl = document.getElementById('giftcode-input');
    if(inputEl) inputEl.value = ''; 
    showPopup('online-box');
}

function handleGiftcode() {
    const inputEl = document.getElementById('giftcode-input');
    const code = inputEl.value.trim().toUpperCase(); 

    if (!code) { alert("Vui lÃ²ng nháº­p mÃ£!"); return; }

    // Kiá»ƒm tra xem mÃ£ nháº­p vÃ o cÃ³ náº±m trong danh sÃ¡ch code active khÃ´ng
    if (ACTIVE_GIFTCODES.includes(code)) {
        if (usedGiftcodes.includes(code)) {
            alert("âŒ Báº¡n Ä‘Ã£ sá»­ dá»¥ng mÃ£ nÃ y rá»“i!");
        } else {
            // --- Cáº¤U HÃŒNH PHáº¦N THÆ¯á»NG ---
            let bonusDau = 0;
            let bonusLa = 0;

            // Logic pháº§n thÆ°á»Ÿng cho tá»«ng mÃ£
            if (code === "FARMLOL") {
                bonusDau = 10000;
                bonusLa = 1000;
            }
            // Náº¿u cÃ³ code khÃ¡c thÃ¬ thÃªm: else if (code === "CODEKHAC") { ... }

            // Cá»™ng quÃ 
            dau += bonusDau;
            la += bonusLa;
            usedGiftcodes.push(code); // LÆ°u mÃ£ Ä‘Ã£ dÃ¹ng vÃ o danh sÃ¡ch
            
            saveGame();
            updateDisplay();
            hidePopup('online-box');
            
            // Cáº­p nháº­t láº¡i kho náº¿u Ä‘ang má»Ÿ
            if(document.getElementById('inventory-box').classList.contains('popup-active')){
                openInventory();
            }

            // --- QUAN TRá»ŒNG: Cáº­p nháº­t láº¡i tráº¡ng thÃ¡i hÃ²m ngay láº­p tá»©c ---
            updateGiftcodeBoxState();

            // ThÃ´ng bÃ¡o
            if(typeof showToast === "function") {
                showToast(`Nháº­n: ${bonusDau.toLocaleString()} Äáº­u + ${bonusLa.toLocaleString()} LÃ¡`, "ğŸ", "Giftcode ThÃ nh CÃ´ng");
            } else {
                alert(`ğŸ‰ CHÃšC Má»ªNG!\nNháº­n: ${bonusDau.toLocaleString()} Äáº­u + ${bonusLa.toLocaleString()} LÃ¡`);
            }
        }
    } else {
        alert("âŒ MÃ£ Giftcode khÃ´ng Ä‘Ãºng hoáº·c Ä‘Ã£ háº¿t háº¡n!");
    }
}

// --- Há»† THá»NG KHÃ“I & KHá»I Táº O GAME (ÄÃƒ Sá»¬A Lá»–I THá»ªA CODE) ---

function spawnRedSmoke() {
    const box = document.getElementById('giftcode-supply-drop');
    if (!box) return; 

    const startTop = box.offsetTop; 
    const startLeft = box.offsetLeft; 
    const boxWidth = box.offsetWidth; 

    const smoke = document.createElement('div');
    smoke.className = 'smoke-particle';
    const randomDX = Math.floor(Math.random() * 50) - 25; 
    smoke.style.setProperty('--dx', `${randomDX}px`);
    const randomX = Math.random() * 14 - 7; 
    
    smoke.style.left = (startLeft + (boxWidth / 2) - 8 + randomX) + 'px'; 
    smoke.style.top = (startTop + 10) + 'px'; 

    document.querySelector('main').appendChild(smoke);
    setTimeout(() => { smoke.remove(); }, 2500);
}

function startSmokeEffect() {
    // Náº¿u Ä‘ang cháº¡y rá»“i thÃ¬ thÃ´i, khÃ´ng táº¡o thÃªm vÃ²ng láº·p má»›i
    if (window.smokeInterval) return;
    
    window.smokeInterval = setInterval(() => {
        const box = document.getElementById('giftcode-supply-drop');
        // Chá»‰ táº¡o khÃ³i khi tab Ä‘ang hiá»ƒn thá»‹ VÃ€ HÃ²m thÃ­nh Ä‘ang hiá»‡n (display != none)
        if(!document.hidden && box && box.style.display !== 'none') {
            spawnRedSmoke();
        }
    }, 150);
}

// Chá»‰ giá»¯ láº¡i 1 dÃ²ng onload duy nháº¥t
// ======================================================
// --- TÃNH NÄ‚NG: THá»ŒC ONG NÃ™I GIáºº ---
// ======================================================

// 1. HÃ m kiá»ƒm tra: Hiá»‡n hoáº·c áº¨n tá»• ong theo ngÃ y
function checkBeeHiveSpawn() {
    const beeGuard = document.getElementById('bee-guard');
    if (!beeGuard) return;

    // Náº¿u chÆ°a táº¡o game (level 0) thÃ¬ cá»© hiá»‡n Ä‘á»ƒ ngÆ°á»i chÆ¡i tháº¥y
    if (level === 0) {
        beeGuard.style.display = 'block';
        return;
    }

    const now = new Date();
    const last = new Date(lastBeePokeTime);
    
    // Kiá»ƒm tra xem hÃ´m nay Ä‘Ã£ thá»c chÆ°a (so sÃ¡nh ngÃ y/thÃ¡ng/nÄƒm)
    const isSameDay = now.getDate() === last.getDate() && 
                      now.getMonth() === last.getMonth() && 
                      now.getFullYear() === last.getFullYear();

    if (isSameDay) {
        // ÄÃ£ thá»c hÃ´m nay -> áº¨n Ä‘i
        beeGuard.style.display = 'none';
    } else {
        // Qua ngÃ y má»›i -> Hiá»‡n láº¡i
        beeGuard.style.display = 'block';
    }
}

// 2. HÃ m hiá»ƒn thá»‹ Popup khi báº¥m vÃ o ong
function showBeePopup() {
    if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }

    interactionTitle.innerHTML = "ğŸ Tá»• Ong NÃ¹i Giáº»";
    interactionText.style.display = 'block';
    
    // Ná»™i dung giá»›i thiá»‡u
    interactionText.innerHTML = `
        <div style="text-align:center;">
            <img src="1000000144.gif" style="width:80px; height:auto; margin-bottom:10px;">
            <div style="color:#5D4037; font-weight:bold;">PhÃ¡t hiá»‡n má»™t tá»• ong láº¡!</div>
            <div style="font-size:0.9em; color:#795548;">
                BÃªn trong cÃ³ váº» chá»©a <b>Nhá»™ng Ong</b> quÃ½ hiáº¿m.
                <br>Báº¡n cÃ³ muá»‘n láº¥y nÃ³ khÃ´ng?
            </div>
        </div>
    `;

    interactionControls.innerHTML = '';

    // Táº¡o nÃºt "Thá»c Ong"
    const btnPoke = document.createElement('button');
    btnPoke.className = 'btn-buy'; 
    btnPoke.style.background = 'linear-gradient(45deg, #FFC107, #FF9800)'; // MÃ u vÃ ng cam
    btnPoke.style.color = '#3e2723';
    btnPoke.style.border = '2px solid #fff';
    btnPoke.style.boxShadow = '0 4px 0 #F57C00';
    btnPoke.style.fontSize = '1.2em';
    btnPoke.style.padding = '12px';
    btnPoke.style.marginTop = '15px';
    btnPoke.innerHTML = "ğŸ‘‰ <b>Thá»c Ong</b>";

    // Sá»± kiá»‡n khi báº¥m nÃºt Thá»c
    btnPoke.onclick = () => {
        // 1. Cá»™ng 5 Nhá»™ng Ong vÃ o kho
        if (!ownedArtifacts['nhong_ong']) ownedArtifacts['nhong_ong'] = 0;
        ownedArtifacts['nhong_ong'] += 5;

        // 2. Cáº­p nháº­t thá»i gian Ä‘Ã£ thá»c (Ä‘á»ƒ tÃ­nh 24h)
        lastBeePokeTime = Date.now();

        // 3. ÄÃ³ng popup
        hidePopup('interaction-popup');

        // 4. Táº¡o hiá»‡u á»©ng váº­t pháº©m bay lÃªn
        const beeGuard = document.getElementById('bee-guard');
        if(beeGuard) {
             const floater = document.createElement("div");
             floater.className = "floating-reward float-item";
             // Sá»­ dá»¥ng Ä‘Ãºng tÃªn file áº£nh báº¡n cung cáº¥p
             floater.innerHTML = `<img src="1000000145.png" style="width:35px; height:35px;"> +5 Nhá»™ng`;
             
             // CÄƒn vá»‹ trÃ­ bay tá»« con ong
             floater.style.top = (beeGuard.offsetTop) + "px";
             floater.style.left = (beeGuard.offsetLeft) + "px";
             floater.style.zIndex = "100";
             
             document.querySelector("main").appendChild(floater);
             
             // XÃ³a hiá»‡u á»©ng sau 1.2 giÃ¢y
             setTimeout(() => floater.remove(), 1200);
        }

        // 5. ThÃ´ng bÃ¡o
        if(typeof showToast === 'function') {
            showToast("ÄÃ£ nháº­n 5 Nhá»™ng Ong!", "ğŸ", "ThÃ nh CÃ´ng");
        } else {
            alert("Báº¡n nháº­n Ä‘Æ°á»£c 5 Nhá»™ng Ong! ÄÃ£ chuyá»ƒn vÃ o 3 LÃ´.");
        }

        // 6. áº¨n con ong Ä‘i vÃ  LÆ°u game
        checkBeeHiveSpawn(); // HÃ m nÃ y sáº½ tá»± áº©n ong vÃ¬ lastBeePokeTime vá»«a cáº­p nháº­t
        saveGame();
    };

    interactionControls.appendChild(btnPoke);
    showPopup('interaction-popup');
}
// --- LOGIC CÃ‚U CÃ (PRO VERSION) ---
let fishingInterval = null;
let fishingTimerInterval = null;
let fishingWaitInterval = null;

// Biáº¿n Váº­t LÃ½ NgÆ°á»i ChÆ¡i (ÄÃƒ CHá»ˆNH Dá»„ HÆ N)
let bobberPos = 10;      
let bobberVelocity = 0;  
const GRAVITY = 0.15;    // RÆ¡i cháº­m hÆ¡n
const JUMP_FORCE = 2.5;  // Náº£y nháº¹ hÆ¡n

// Biáº¿n Váº­t LÃ½ Má»¥c TiÃªu (ÄÃƒ Cá» Äá»ŠNH)
let targetPos = 35;      // Äá»©ng im á»Ÿ vá»‹ trÃ­ 35%
let targetDirection = 0; 
let targetSpeed = 0;     
let changeDirCounter = 0; 

let catchProgress = 30;   // Tiáº¿n Ä‘á»™ báº¯t (30% khá»Ÿi Ä‘iá»ƒm)
let gameTimeLeft = 15;    // Thá»i gian chÆ¡i tÄƒng lÃªn 15s

// Danh sÃ¡ch CÃ¡ & Tá»‰ lá»‡ (Giá»¯ nguyÃªn)
const FISH_TYPES = [
    { id: 'ca_tre', name: 'CÃ¡ TrÃª', img: '1000000148.png', rate: 0.5 },
    { id: 'ca_do', name: 'CÃ¡ Dá»“', img: '1000000146.png', rate: 0.8 }, 
    { id: 'ca_tai_tuong', name: 'CÃ¡ Tai TÆ°á»£ng', img: '1000000147.png', rate: 1.0 }
];

// 1. Má»Ÿ báº£ng chuáº©n bá»‹
function showFishingPrePopup() {
    if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c!"); return; }
    
    // Reset HTML sáº¡ch sáº½ cho láº§n chÆ¡i má»›i
    document.getElementById('fishing-game-area').innerHTML = `
        <div id="fishing-bar-container">
            <div id="zone-green"></div>
            <div id="fishing-bobber"></div>
        </div>
        
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div style="font-size:0.7em; font-weight:bold; color:#0277BD; margin-bottom:5px;">TIáº¾N Äá»˜</div>
            <div id="catch-progress-container">
                <div id="catch-progress-fill"></div>
            </div>
        </div>
        
        <div id="fishing-timer">15s</div>
    `;

    document.getElementById('fishing-waiting').style.display = 'block';
    document.getElementById('fishing-start-ui').style.display = 'block';
    document.getElementById('fishing-waiting-anim').style.display = 'none';
    document.getElementById('fishing-game-area').style.display = 'none';
    document.getElementById('fishing-guide-text').style.display = 'none';
    
    const btnStart = document.getElementById('btn-start-fishing');
    if (typeof ownedArtifacts === 'undefined') ownedArtifacts = {};
    const nhongQty = ownedArtifacts['nhong_ong'] || 0;
    
    if (nhongQty > 0) {
        btnStart.innerHTML = `QuÄƒng Cáº§n (CÃ³: ${nhongQty})`;
        btnStart.disabled = false;
        btnStart.style.background = "#29B6F6";
        btnStart.style.cursor = "pointer";
        btnStart.onclick = startFishingWait;
    } else {
        btnStart.innerHTML = `Thiáº¿u Nhá»™ng Ong!`;
        btnStart.disabled = true;
        btnStart.style.background = "#bdbdbd";
        btnStart.style.cursor = "not-allowed";
    }

    showPopup('fishing-popup');
}
// --- HÃ€M Sá»¬A Lá»–I: NÃšT THOÃT CÃ‚U CÃ ---
function closeFishingPopup() {
    // 1. Dá»«ng má»i bá»™ Ä‘áº¿m giá» (Ä‘á»ƒ game khÃ´ng cháº¡y ngáº§m)
    if (fishingInterval) clearInterval(fishingInterval);
    if (fishingTimerInterval) clearInterval(fishingTimerInterval);
    if (fishingWaitInterval) clearInterval(fishingWaitInterval);

    // 2. Gá»¡ bá» sá»± kiá»‡n click/tap (Ä‘á»ƒ khÃ´ng bá»‹ lá»—i khi báº¥m ra ngoÃ i)
    document.removeEventListener('mousedown', fishingTap);
    document.removeEventListener('touchstart', fishingTap);

    // 3. ÄÃ³ng Popup
    hidePopup('fishing-popup');

    // 4. Reset láº¡i giao diá»‡n chá» (Ä‘á»ƒ láº§n sau má»Ÿ láº¡i Ä‘áº¹p hÆ¡n)
    const guideText = document.getElementById('fishing-guide-text');
    if(guideText) guideText.style.display = 'none';
}
// 2. Giai Ä‘oáº¡n Ä‘á»£i 3 giÃ¢y (Giáº£m xuá»‘ng 3s cho nhanh)
function startFishingWait() {
    if (!ownedArtifacts['nhong_ong']) ownedArtifacts['nhong_ong'] = 0;
    ownedArtifacts['nhong_ong']--;
    saveGame();
    
    document.getElementById('fishing-start-ui').style.display = 'none';
    document.getElementById('fishing-waiting-anim').style.display = 'block';
    
    let count = 3; // Giáº£m thá»i gian chá»
    const countEl = document.getElementById('fishing-countdown');
    countEl.innerText = count;
    
    if (fishingWaitInterval) clearInterval(fishingWaitInterval);

    fishingWaitInterval = setInterval(() => {
        count--;
        countEl.innerText = count;
        if (count <= 0) {
            clearInterval(fishingWaitInterval);
            fishingWaitInterval = null;
            startFishingMinigame();
        }
    }, 1000);
}

// 3. Báº¯t Ä‘áº§u Minigame
function startFishingMinigame() {
    document.getElementById('fishing-waiting').style.display = 'none';
    document.getElementById('fishing-game-area').style.display = 'flex';
    document.getElementById('fishing-guide-text').style.display = 'block';
    document.getElementById('fishing-guide-text').innerHTML = "ğŸ‘† <b>NHáº¤P LIÃŠN Tá»¤C</b> Ä‘á»ƒ giá»¯ thanh cam náº±m trong vÃ¹ng xanh!";
    
    // Reset thÃ´ng sá»‘ game
    bobberPos = 20;
    bobberVelocity = 0;
    targetPos = 40; // VÃ¹ng xanh báº¯t Ä‘áº§u á»Ÿ giá»¯a
    catchProgress = 25; // Thanh tiáº¿n Ä‘á»™ báº¯t Ä‘áº§u tháº¥p
    gameTimeLeft = 15;
    
    document.addEventListener('mousedown', fishingTap);
    document.addEventListener('touchstart', fishingTap, {passive: false});
    
    if (fishingInterval) clearInterval(fishingInterval);
    fishingInterval = setInterval(gameLoop, 16); // 60 FPS
    
    if (fishingTimerInterval) clearInterval(fishingTimerInterval);
    fishingTimerInterval = setInterval(() => {
        gameTimeLeft--;
        const timerEl = document.getElementById('fishing-timer');
        if(timerEl) timerEl.innerText = gameTimeLeft + "s";
        
        if (gameTimeLeft <= 0) {
            endFishingGame(false); // Háº¿t giá» mÃ  chÆ°a Ä‘áº§y thanh -> Thua
        }
    }, 1000);
}

// Xá»­ lÃ½ cÃº Ä‘áº©y (Tap)
function fishingTap(e) {
    if(e.type === 'touchstart') e.preventDefault();
    // Má»—i láº§n tap, váº­n tá»‘c tÄƒng lÃªn (bay lÃªn)
    bobberVelocity = JUMP_FORCE; 
}

// Logic di chuyá»ƒn VÃ¹ng Xanh (ÄÃƒ Cá» Äá»ŠNH)
function updateTargetPosition() {
    // LuÃ´n giá»¯ vÃ¹ng xanh á»Ÿ vá»‹ trÃ­ 35%
    targetPos = 35; 

    const zoneEl = document.getElementById('zone-green');
    if(zoneEl) zoneEl.style.bottom = targetPos + "%";
}

// VÃ²ng láº·p chÃ­nh xá»­ lÃ½ váº­t lÃ½
function gameLoop() {
    // A. Xá»­ lÃ½ VÃ¹ng Xanh (CÃ¡ cháº¡y)
    updateTargetPosition();

    // B. Xá»­ lÃ½ Thanh Cam (NgÆ°á»i chÆ¡i)
    bobberVelocity -= GRAVITY; // Trá»ng lá»±c kÃ©o xuá»‘ng
    bobberPos += bobberVelocity;
    
    // Giá»›i háº¡n thanh cam trong á»‘ng
    if (bobberPos < 0) { bobberPos = 0; bobberVelocity = 0; } // Cháº¡m Ä‘Ã¡y náº£y nháº¹ hoáº·c dá»«ng
    if (bobberPos > 92) { bobberPos = 92; bobberVelocity = 0; } // Cháº¡m Ä‘á»‰nh
    
    const bobberEl = document.getElementById('fishing-bobber');
    if(bobberEl) bobberEl.style.bottom = bobberPos + "%";
    
    // C. Kiá»ƒm tra va cháº¡m (Thanh Cam cÃ³ náº±m trong VÃ¹ng Xanh khÃ´ng?)
    // VÃ¹ng xanh cao khoáº£ng 25% (80px/300px), Bobber cao khoáº£ng 6%
    // Logic: Kiá»ƒm tra bottom cá»§a 2 tháº±ng
    // targetPos lÃ  bottom cá»§a vÃ¹ng xanh. VÃ¹ng xanh cao ~25%.
    // bobberPos lÃ  bottom cá»§a thanh cam.
    
    // Äiá»u kiá»‡n náº±m trong vÃ¹ng: Bobber cao hÆ¡n Ä‘Ã¡y vÃ¹ng xanh VÃ€ tháº¥p hÆ¡n Ä‘á»‰nh vÃ¹ng xanh
    // Äá»‰nh vÃ¹ng xanh = targetPos + 25
    // ÄÃ¡y bobber = bobberPos
    // Äá»‰nh bobber = bobberPos + 6
    
    const zoneBottom = targetPos;
    const zoneTop = targetPos + 25;
    const bobberBottom = bobberPos;
    const bobberTop = bobberPos + 6;

    // Kiá»ƒm tra giao nhau
    const isOverlapping = (bobberTop > zoneBottom && bobberBottom < zoneTop);
    
    if (isOverlapping) {
        // TRÃšNG: Thanh xanh sÃ¡ng lÃªn, tÄƒng tiáº¿n Ä‘á»™
        const zoneEl = document.getElementById('zone-green');
        if(zoneEl) {
            zoneEl.style.background = "rgba(118, 255, 3, 0.8)";
            zoneEl.style.boxShadow = "0 0 15px #76FF03";
        }
        catchProgress += 0.4; // TÄƒng cháº­m Ä‘á»ƒ game dÃ i hÆ¡n xÃ­u
    } else {
        // TRÆ¯á»¢T: Thanh xanh má» Ä‘i, giáº£m tiáº¿n Ä‘á»™
        const zoneEl = document.getElementById('zone-green');
        if(zoneEl) {
            zoneEl.style.background = "rgba(118, 255, 3, 0.3)";
            zoneEl.style.boxShadow = "none";
        }
        catchProgress -= 0.3; // Giáº£m pháº¡t
    }
    
    // Giá»›i háº¡n thanh tiáº¿n Ä‘á»™
    if (catchProgress < 0) catchProgress = 0;
    if (catchProgress > 100) catchProgress = 100;
    
    // Cáº­p nháº­t giao diá»‡n thanh tiáº¿n Ä‘á»™
    const progressFill = document.getElementById('catch-progress-fill');
    if(progressFill) {
        progressFill.style.height = catchProgress + "%";
        
        // Äá»•i mÃ u theo má»©c Ä‘á»™ nguy hiá»ƒm
        if(catchProgress < 30) progressFill.style.background = "#F44336"; // Äá» (Nguy hiá»ƒm)
        else if(catchProgress < 70) progressFill.style.background = "#FF9800"; // Cam
        else progressFill.style.background = "#4CAF50"; // Xanh (Tá»‘t)
    }

    // D. Kiá»ƒm tra Tháº¯ng/Thua
    if (catchProgress >= 100) {
        endFishingGame(true);
    } else if (catchProgress <= 0 && gameTimeLeft < 13) {
        // Chá»‰ thua náº¿u thanh tuá»™t vá» 0 SAU 2 giÃ¢y Ä‘áº§u tiÃªn (Ä‘á»ƒ trÃ¡nh vá»«a vÃ o game Ä‘Ã£ thua)
        endFishingGame(false);
    }
}

// 4. Káº¿t thÃºc game
function endFishingGame(isWin) {
    clearInterval(fishingInterval);
    clearInterval(fishingTimerInterval);
    document.removeEventListener('mousedown', fishingTap);
    document.removeEventListener('touchstart', fishingTap);
    
    const gameArea = document.getElementById('fishing-game-area');
    const guideText = document.getElementById('fishing-guide-text');
    if(guideText) guideText.style.display = 'none';

    if (isWin) {
        // Random cÃ¡ (Tá»‰ lá»‡ xá»‹n hÆ¡n)
        const rand = Math.random();
        let fish = null;
        let starRating = "";
        
        if (rand < 0.5) { fish = FISH_TYPES[0]; starRating = "â­"; }      
        else if (rand < 0.85) { fish = FISH_TYPES[1]; starRating = "â­â­"; } 
        else { fish = FISH_TYPES[2]; starRating = "â­â­â­"; }                
        
        if (!ownedArtifacts[fish.id]) ownedArtifacts[fish.id] = 0;
        ownedArtifacts[fish.id]++;
        saveGame();
        
        gameArea.innerHTML = `
            <div style="text-align:center; animation:popInReward 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                <div style="font-size:3em; margin-bottom:5px;">ğŸ£</div>
                <h2 style="color:#2E7D32; margin:0; text-transform:uppercase;">DÃ­nh cÃ¡ rá»“i!</h2>
                <div style="background:radial-gradient(circle, #fff, #B2DFDB); padding:10px; border-radius:50%; width:100px; height:100px; display:flex; align-items:center; justify-content:center; margin:10px auto; border:3px solid #009688;">
                    <img src="${fish.img}" style="width:80%; height:auto; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.3));">
                </div>
                <div style="font-size:1.3em; font-weight:900; color:#006064;">${fish.name}</div>
                <div style="color:#FFC107; font-size:1.2em; letter-spacing:2px; margin-bottom:5px;">${starRating}</div>
                <button onclick="showFishingPrePopup()" class="btn-buy" style="margin-top:10px; width:auto; padding:10px 25px; box-shadow:0 4px 0 rgba(0,0,0,0.2);">CÃ¢u Tiáº¿p</button>
            </div>
        `;
    } else {
        gameArea.innerHTML = `
            <div style="text-align:center; animation:shake 0.5s;">
                <div style="font-size:4em; margin:10px 0; opacity:0.7;">ğŸŒŠ</div>
                <h2 style="color:#c62828; margin:0;">Sáº¨Y Máº¤T Rá»’I!</h2>
                <p style="color:#546E7A; font-weight:bold;">CÃ¡ quÃ¡ máº¡nh...</p>
                <div style="width:100%; height:2px; background:#cfd8dc; margin:15px 0;"></div>
                <button onclick="showFishingPrePopup()" class="btn-buy" style="width:auto; padding:10px 25px; background:#FF5722; box-shadow:0 4px 0 #D84315;">Thá»­ Láº¡i Ngay</button>
            </div>
            <style>@keyframes shake {0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); }}</style>
        `;
    }
}

function initializeGame(){
    // 1. Táº£i dá»¯ liá»‡u
    loadGame(); 
    
    // 2. CÃ i Ä‘áº·t giao diá»‡n
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if(isDarkMode) document.body.classList.add('dark-mode');
    adjustAppWrapperScale(); 
    
    // 3. Cáº­p nháº­t logic game
    updateFarmState(); 
    checkGlobalCrafting();
    checkIncubationState();

    // 4. Hiá»ƒn thá»‹
    updateDisplay(); 
    updateControlButtons(); 
    updateShop(); 
    updateBlacksmithVisuals(); 
    
    // 5. Khá»Ÿi táº¡o sá»± kiá»‡n
    initVineEvents();        
    initGrasshopperEvents(); 
    
    // 6. KIá»‚M TRA Sá»° KIá»†N Äáº¶C BIá»†T (QUAN TRá»ŒNG)
    updateGiftcodeBoxState(); // Kiá»ƒm tra hÃ²m thÃ­nh
    checkBeeHiveSpawn();      // <--- Bá»” SUNG: Gá»i ong ngay khi vÃ o game
    
    // Báº­t khÃ³i náº¿u hÃ²m thÃ­nh Ä‘ang hiá»‡n
    const giftBox = document.getElementById('giftcode-supply-drop');
    if(giftBox && giftBox.style.display !== 'none') {
        startSmokeEffect();
    }
}

// --- VÃ’NG Láº¶P GAME (Cháº¡y má»—i giÃ¢y) ---
setInterval(() => {
    updateFarmState();        // CÃ¢y lá»›n
    checkGlobalCrafting();    // Thá»£ rÃ¨n
    checkIncubationState();   // Trá»©ng ná»Ÿ
    checkBeeHiveSpawn();      // <--- Bá»” SUNG: Kiá»ƒm tra ong liÃªn tá»¥c má»—i giÃ¢y
}, 1000);

// --- Tá»° Äá»˜NG LÆ¯U (Má»—i 60 giÃ¢y) ---
setInterval(autoSave, 60000);
window.onload = initializeGame;
</script>
</body>
</html>
