<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Farm LOL - Pet Daily Reward</title>

<link rel="manifest" href="manifest.json"> 

<link rel="icon" type="image/png" href="1000000109.png">
<link rel="apple-touch-icon" href="1000000109.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root { 
    /* Palette m√†u t∆∞∆°i s√°ng */
    --bg-gradient: linear-gradient(180deg, #a1ffce 0%, #faffd1 100%);
    --primary: #4CAF50; 
    --primary-dark: #388E3C;
    --accent: #FF9800;
    --accent-dark: #F57C00;
    --text-main: #3e2723;
    --text-muted: #795548;
    
    /* UI Variables */
    --card-bg: rgba(255, 255, 255, 0.95);
    --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
    --btn-shadow: 0 4px 0px;
    --radius-lg: 20px;
    --radius-md: 12px;
    --radius-sm: 8px;
    
    /* Dark Mode Palette */
    --dark-bg-gradient: linear-gradient(180deg, #1a237e 0%, #311b92 100%);
    --dark-card-bg: rgba(30, 30, 40, 0.95);
    --dark-text: #e0e0e0;
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; 
    font-family: 'Fredoka', sans-serif; 
    background: #333; 
    color: var(--text-main); 
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    overflow: hidden;
    transition: background 0.3s;
  }

  /* --- APP CONTAINER (FIXED RATIO SCALING) --- */
  .app-wrapper {
    width: 400px; 
    height: 750px; 
    background: var(--bg-gradient);
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 50px rgba(0,0,0,0.5); 
    position: relative; 
    text-align: left; 
    
    /* Quan tr·ªçng cho vi·ªác Scale */
    transform-origin: top center; 
    transform: scale(1); 
    transition: transform 0.1s ease-out, background 0.3s;
    flex-shrink: 0;
    overflow: hidden; /* C·∫Øt ph·∫ßn th·ª´a n·∫øu c√≥ */
  }

  /* --- DARK MODE --- */
  body.dark-mode .app-wrapper {
    background: var(--dark-bg-gradient);
    color: var(--dark-text);
  }
  body.dark-mode .card-panel, 
  body.dark-mode #shop-box, 
  body.dark-mode #online-box, 
  body.dark-mode #pet-house-box, 
  body.dark-mode #interaction-popup, 
  body.dark-mode #seed-box {
      background: var(--dark-card-bg);
      color: var(--dark-text);
      border: 1px solid rgba(255,255,255,0.1);
  }

  /* --- MENU TOGGLE BTN --- */
  #menu-btn {
      position: absolute;
      top: 15px; left: 15px;
      width: 46px; height: 46px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-dark);
      font-size: 20px;
      cursor: pointer;
      z-index: 101; 
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  #menu-btn:active { transform: scale(0.9); }
  body.dark-mode #menu-btn { background: #311b92; color: white; border-color: #5c6bc0; }

  /* --- HEADER --- */
  header { 
      position: absolute;
      top: 15px; 
      left: 70px; 
      right: 15px;
      display: flex; 
      flex-direction: column; 
      align-items: center;    
      padding: 8px 15px; 
      background: rgba(255, 255, 255, 0.65); 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 20px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      z-index: 100; 
      border: 1px solid rgba(255,255,255,0.4);
      
      /* Animation */
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      transform-origin: left center;
      opacity: 1;
      transform: scaleX(1);
  }

  header.collapsed {
      opacity: 0;
      transform: scaleX(0) translateX(-20px);
      pointer-events: none;
  }

  .dark-mode header {
      background: rgba(20, 20, 30, 0.7);
      border-color: rgba(255,255,255,0.1);
      color: white;
  }

  .brand {
      display: flex; 
      flex-direction: column; 
      align-items: center;
      width: 100%;
      cursor: pointer;
      margin-bottom: 5px;
  }
  
  #player-level-display {
      font-size: 15px; font-weight: 700; color: var(--primary-dark);
      text-shadow: 0 1px 0 rgba(255,255,255,0.5);
  }
  .dark-mode #player-level-display { color: #81c784; text-shadow: none; }

  /* EXP BAR */
  #exp-bar-container {
    width: 120px; 
    height: 14px; /* TƒÉng chi·ªÅu cao l√™n 1 ch√∫t ƒë·ªÉ ch·ªØ d·ªÖ ƒë·ªçc h∆°n (c≈© l√† 6px) */
    background: rgba(0,0,0,0.2); 
    border-radius: 10px; 
    margin-top: 4px; 
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);

    /* QUAN TR·ªåNG: ƒê·ªÉ ƒë·ªãnh v·ªã d√≤ng ch·ªØ n·∫±m ƒë√® l√™n tr√™n */
    position: relative; 
}

/* CSS cho d√≤ng ch·ªØ hi·ªÉn th·ªã s·ªë EXP */
#exp-text-overlay {
    position: absolute;
    top: 0; left: 0; 
    width: 100%; height: 100%;
    display: flex; 
    align-items: center; 
    justify-content: center;

    /* Ch·ªânh font ch·ªØ cho ƒë·∫πp v√† r√µ */
    font-size: 9px; 
    font-weight: 800; 
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0,0,0,1); /* Vi·ªÅn ƒëen quanh ch·ªØ ƒë·ªÉ n·ªïi b·∫≠t */
    z-index: 2; /* ƒê·∫£m b·∫£o ch·ªØ n·∫±m tr√™n thanh m√†u xanh */
    pointer-events: none;
}
  #exp-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #66bb6a, #43a047);
      border-radius: 10px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* --- BUTTONS --- */
  button { font-family: 'Fredoka', sans-serif; }
  
  .controls { 
      display: flex; 
      flex-wrap: nowrap; 
      justify-content: center;
      width: 100%;
      gap: 6px;
  } 
  
  .controls button {
      font-size: 10px; font-weight: 700;
      padding: 5px 10px;
      margin: 0;
      border: none; border-radius: 20px;
      cursor: pointer;
      color: white;
      text-transform: uppercase;
      transition: transform 0.1s;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      white-space: nowrap;
  }
  
  .controls button:active { transform: translateY(2px); box-shadow: none; }

  #btn-new { background: #29b6f6; box-shadow: 0 2px 0 #0288d1; }
  #btn-save { background: #66bb6a; box-shadow: 0 2px 0 #388e3c; }
  #btn-delete { background: #ef5350; box-shadow: 0 2px 0 #d32f2f; }
  
  button:disabled { background: #bdbdbd !important; box-shadow: none !important; color: #757575 !important; cursor: not-allowed; transform: none !important; }

  /* --- MAIN GAME AREA --- */
  main { 
        flex: 1; display:flex; justify-content:center; 
        align-items:flex-start; 
        padding:0; 
        overflow: hidden;
        position: relative;
  }
  
  #beanstalk-bg {
    position: absolute; 
    top: 0; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 100%; 
    height: 100%;
    z-index: 3; 
    object-fit: cover;
  }

  /* UI Game Object Animations */
  @keyframes float { 0% { transform: translate(-50%, 0px); } 50% { transform: translate(-50%, -10px); } 100% { transform: translate(-50%, 0px); } }
  
  /* --- ANIMATION TH·ªû CHO PET (SQUASH & STRETCH) --- */
  @keyframes pet-breathing {
      0%, 100% { 
          /* Tr·∫°ng th√°i b√¨nh th∆∞·ªùng */
          transform: scale(1, 1); 
      }
      50% { 
          /* Hi·ªáu ·ª©ng x·∫πp ph·ªìng: B√® ngang (1.06) v√† th·∫•p xu·ªëng (0.94) */
          transform: scale(1.06, 0.94); 
      } 
  }

  /* --- ANIMATION THI√äN TH·∫¶N / TH·∫¶N CH·∫æT BAY THU HO·∫†CH --- */
  @keyframes angel-fly-harvest {
      0% { transform: translateX(0) scaleX(1); }
      45% { transform: translateX(340px) scaleX(1); } /* Bay sang ph·∫£i */
      50% { transform: translateX(340px) scaleX(-1); } /* Quay ƒë·∫ßu */
      95% { transform: translateX(0) scaleX(-1); } /* Bay v·ªÅ */
      100% { transform: translateX(0) scaleX(1); } /* Quay l·∫°i */
  }

  .angel-harvesting {
      animation: angel-fly-harvest 2s ease-in-out forwards;
      z-index: 100 !important;
      position: relative; 
  }

  /* --- CLASS M·ªöI ƒê·ªÇ K√çCH HO·∫†T HI·ªÜU ·ª®NG TH·ªû --- */
  .pet-breathing-effect {
      animation: pet-breathing 2s ease-in-out infinite;
  }

  #kinto-cloud {
      position: absolute; top: 30px; left: calc(60% + 15px); transform: translateX(-50%); 
      width: 45px;   /* TƒÉng t·ª´ 30px l√™n 45px cho d√†i ra */
      height: auto;  /* ƒê·ªïi th√†nh auto ƒë·ªÉ ·∫£nh kh√¥ng b·ªã m√©o */
      /* ---------------- */
      
      z-index: 10; cursor: pointer; 
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
  }
    /* --- CSS CHO M√ÇY S·ª∞ KI·ªÜN (M·ªöI) --- */
  #event-cloud {
      position: absolute; 
      top: 30px;               /* ƒê·∫∑t c√πng ƒë·ªô cao v·ªõi C√¢n ƒê·∫©u V√¢n */
      left: calc(60% + 75px);  /* ƒê·∫©y sang ph·∫£i m·ªôt ch√∫t ƒë·ªÉ kh√¥ng b·ªã che */
      transform: translateX(-50%); 
      
      width: 45px;             /* K√≠ch th∆∞·ªõc ·∫£nh */
      height: auto; 
      z-index: 10;             /* L·ªõp hi·ªÉn th·ªã cao ƒë·ªÉ b·∫•m ƒë∆∞·ª£c */
      cursor: pointer; 
      
      /* Hi·ªáu ·ª©ng bay (float) gi·ªëng h·ªát m√¢y shop */
      animation: float 3s ease-in-out infinite; 
      animation-delay: 1.5s;   /* Tr·ªÖ 1.5s ƒë·ªÉ 2 ƒë√°m m√¢y bay l·ªách nh·ªãp cho ƒë·∫πp */
      
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); /* T·∫°o b√≥ng ƒë·ªï nh·∫π */
  }
  
  /* Hi·ªáu ·ª©ng khi b·∫•m v√†o m√¢y (nh√∫n nh·∫π) */
  #event-cloud:active {
      transform: translateX(-50%) scale(0.9);
  }
  
  #light-bulb {
      position: absolute; 
      top: 15px; 
      left: calc(30% - 10px); 
      transform: translateX(-50%);
      z-index: 8; 
      cursor: pointer; 
      width: 60px; 
      height: auto;
      filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
  }

  #pet-house {
      position: absolute; bottom: 210px; left: 50%; transform: translateX(calc(-50% + 100px)); 
      width: 150px; height: auto; z-index: 7; cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #chaos-blacksmith {
      position: absolute; bottom: 260px; left: 50%; transform: translateX(calc(-50% - 130px));
      width: 90px; height: auto; z-index: 7; cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #chaos-blacksmith-working {
      position: absolute; 
      bottom: 270px; 
      left: 50%; 
      transform: translateX(calc(-50% - 130px));
      width: 60px; 
      height: auto; 
      z-index: 7; 
      cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }
  
  #pug-pet {
      position: absolute; 
      bottom: 35px; 
      left: 50%; 
      transform: translateX(calc(-50% - 50px)); 
      width: 120px; 
      height: auto; 
      z-index: 7; 
      cursor: pointer;
      transform-origin: bottom center; 
      will-change: transform;
  }
  
  #bone-bowl {
      position: absolute; bottom: 130px; left: 50%; transform: translateX(calc(-50% + 110px)); 
      width: 50px; height: auto; z-index: 7; cursor: pointer; 
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #pot-container {
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 100%; height: 100%; z-index: 5; display: flex; justify-content: center; pointer-events: none; 
  }

  .pot-slot {
      position: absolute; width: 50px; height: 50px; background: transparent; border: none; 
      display: flex; align-items: center; justify-content: center; 
      cursor: pointer; transition: transform 0.1s; pointer-events: auto; 
  }
  .pot-slot:hover { transform: scale(1.1); filter: brightness(1.1); }
  .pot-slot:active { transform: scale(0.95); }

  .pot-slot img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
  }
  
  .pot-base-img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
      transition: opacity 0.3s;
  }

  /* --- SLOT POSITIONS --- */
  /* Ch·ªânh v·ªã tr√≠ √¥ Slot 1 (gi·ªØ nguy√™n v·ªã tr√≠ √¥) */
  #slot-1 { 
      width: 50px; 
      height: 50px; 
      top: 140px; 
      left: calc(50% - 160px); 
  }

  /* --- V·ªä TR√ç ·∫¢NH PET ·ªû SLOT 1 (ƒê√É S·ª¨A C√ÇN ƒê·ªêI) --- */
  
  /* 1. C·∫•u h√¨nh chung m·∫∑c ƒë·ªãnh */
  #slot-1 img { 
      position: absolute;       
      z-index: 5;
      object-fit: contain; 
      transition: none !important;
      
      /* M·∫∑c ƒë·ªãnh an to√†n n·∫øu ch∆∞a load class */
      width: 100%; height: 100%; top: 0; left: 0;
  }

  /* 2. Class ri√™ng cho QU·∫¢ TR·ª®NG (To, n·∫±m tr·ªçn trong ch·∫≠u) */
  .fix-egg {
      width: 150% !important;
      height: 120% !important;
      top: -18% !important;    /* ƒê·∫©y l√™n m·ªôt ch√∫t */
      left: -35% !important;    /* CƒÉn gi·ªØa */
  }

  /* 3. Class ri√™ng cho THI√äN TH·∫¶N (C·∫ßn to v√† bay cao h∆°n) */
  .fix-angel {
      width: 145% !important;   /* To h∆°n ƒë·ªÉ th·∫•y r√µ c√°nh */
      height: 145% !important;
      top: -35% !important;     /* Bay cao h·∫≥n l√™n */
      left: -35% !important;
  }

  /* 4. Class ri√™ng cho TH·∫¶N CH·∫æT (D√°ng cao, g·∫ßy) */
  .fix-reaper {
      width: 290% !important;
      height: 150% !important;
      top: -40% !important;
      left: -100% !important;
  }

  /* 5. Class ri√™ng cho BI GAI (Nh·ªè, tr√≤n, c·∫ßn n·∫±m th·∫•p) */
  .fix-bigai {
      width: 120% !important;   /* K√≠ch th∆∞·ªõc v·ª´a v·∫∑n */
      height: 110% !important;
      top: -30% !important;      /* N·∫±m g·∫ßn mi·ªáng ch·∫≠u */
      left: -20% !important;      /* CƒÉn gi·ªØa tuy·ªát ƒë·ªëi */
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.6)); /* Th√™m h√†o quang nh·∫π */
  }
  
  #slot-6 { width: 50px; height: 35px; top: 335px; left: calc(50% - 30px + 10px + 15px); }
  #slot-6 img { width: 130%; height: 130%; top: -15px; left: -10px; }
  
  #slot-2, #slot-3, #slot-4, #slot-5, #slot-7 { width: 35px; height: 35px; }
  #slot-2 img, #slot-3 img, #slot-4 img, #slot-5 img, #slot-7 img { width: 130%; height: 130%; top: -5px; left: -5px; }
  
  .seed-image {
      width: 140% !important; 
      height: auto !important; 
      max-height: 120px !important; 
      object-fit: contain; 
      position: absolute; 
      bottom: 27px !important;  
      top: auto !important;     
      left: 50% !important;
      transform: translateX(-50%) !important; 
      z-index: 6;
      pointer-events: none;
      transition: all 0.3s ease; 
  }

  /* --- V·ªä TR√ç C√ÅC √î ƒê·∫§T --- */
  #slot-2 { top: 155px; left: calc(50% - 90px - 10px); }
  #slot-3 { top: 155px; left: calc(50% - 30px - 10px); } 
  #slot-4 { top: 155px; left: calc(50% + 30px - 10px); }
  #slot-5 { top: 155px; left: calc(50% + 90px - 10px); }
  #slot-7 { top: 155px; left: calc(50% + 150px - 10px); }


  /* --- POPUPS (MODALS) --- */
  .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); backdrop-filter: blur(3px);
      z-index: 990; display: none;
  }

  #shop-box, #online-box, #pet-house-box, #interaction-popup, #seed-box, #name-box, #inventory-box {
    position: fixed; top: 50%; left: 50%; 
    transform: translate(-50%, -50%) scale(0.9); 
    background: var(--card-bg);
    width: 90%; max-width: 320px;
    padding: 20px; 
    border-radius: var(--radius-lg); 
    box-shadow: var(--card-shadow); 
    z-index: 1000; 
    text-align: center; 
    border: 4px solid white;
    opacity: 0; pointer-events: none; 
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .popup-active {
      transform: translate(-50%, -50%) scale(1) !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      display: block !important;
  }

  h3 { 
      margin: 0 0 15px 0; color: var(--primary-dark); font-size: 1.2em; 
      text-transform: uppercase; letter-spacing: 1px;
  }
  .dark-mode h3 { color: #81c784; }

  hr { border: 0; border-top: 2px dashed #ddd; margin: 15px 0; }

  .btn-close, button[onclick*="none"] {
      margin-top: 15px;
      padding: 8px 25px;
      background: #f44336;
      color: white;
      border: none; border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 3px 0 #d32f2f;
      cursor: pointer;
      width: 100%;
      font-size: 0.9em;
  }
  .btn-close:active, button[onclick*="none"]:active { transform: translateY(4px); box-shadow: none; }
  .btn-remove-vines {
    width: 100%;
    margin-top: 10px;
    padding: 8px;
    background: #ff5252; /* M√†u ƒë·ªè */
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 0 #d32f2f;
    transition: all 0.1s;
}
.btn-remove-vines:active {
    transform: translateY(3px);
    box-shadow: none;
}

  /* --- SHOP ITEMS (GRID) --- */
  .shop-item, .pet-shop-item {
      background: white;
      border: 1px solid #eee;
      border-radius: var(--radius-md);
      padding: 10px;
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;
  }
  .dark-mode .shop-item, .dark-mode .pet-shop-item { background: #2c2c35; border-color: #444; }

  .shop-item:hover, .pet-shop-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

  .btn-buy, .btn-buy-pet, .btn-plant-now, .btn-equip-pot, .btn-crafting {
      width: 100%; border: none; border-radius: 8px;
      padding: 6px; margin-top: 8px;
      font-weight: 700; font-size: 11px;
      color: white; cursor: pointer;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      transition: all 0.1s;
  }
  .btn-buy:active, .btn-plant-now:active { transform: translateY(2px); box-shadow: none; }
  
  .btn-buy, .btn-plant-now { background: var(--accent); box-shadow: 0 2px 0 var(--accent-dark); }
  /* Override btn-plant-now specific color if needed, but keeping accent is fine */

  /* --- TABS --- */
  .tab-container {
      background: #f5f5f5; padding: 4px; border-radius: 12px;
      display: flex; gap: 5px; margin-bottom: 15px; border: none;
  }
  .dark-mode .tab-container { background: #2a2a35; }

  .tab-btn {
      flex: 1; padding: 8px; border-radius: 8px; border: none;
      background: transparent; color: #777; font-weight: 600; font-size: 0.9em;
      transition: all 0.2s; cursor: pointer;
  }
  .tab-btn.active {
      background: white; color: var(--primary);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .dark-mode .tab-btn.active { background: #4caf50; color: white; }

  /* --- CSS M·ªöI CHO TH·ª¢ R√àN (BLACKSMITH) --- */
  /* Container danh s√°ch */
  .blacksmith-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 5px;
  }

  /* M·ªôt h√†ng c√¥ng th·ª©c r√®n */
  .blacksmith-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.1s;
  }
  .dark-mode .blacksmith-row {
      background: #2c2c35;
      border-color: #444;
  }

  /* Ph·∫ßn b√™n tr√°i: ·∫¢nh + T√™n */
  .bs-info {
      display: flex;
      align-items: center;
      flex: 1.2; /* Chi·∫øm nhi·ªÅu ch·ªó h∆°n ch√∫t */
      gap: 10px;
  }

  /* KHUNG ·∫¢NH C·ªê ƒê·ªäNH (Quan tr·ªçng ƒë·ªÉ s·ª≠a l·ªói to nh·ªè) */
  .bs-icon-box {
      width: 50px;
      height: 50px;
      background: #f5f5f5;
      border: 1px solid #eeeeee;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0; /* Kh√¥ng b·ªã co l·∫°i */
  }
  .dark-mode .bs-icon-box {
      background: #3a3a45;
      border-color: #555;
  }

  .bs-icon-box img {
      width: 80%;       /* ·∫¢nh ch·ªâ chi·∫øm 80% khung ƒë·ªÉ c√≥ kho·∫£ng th·ªü */
      height: 80%;
      object-fit: contain; /* Gi·ªØ nguy√™n t·ªâ l·ªá ·∫£nh */
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15));
  }

  .bs-name {
      font-weight: 700;
      font-size: 0.95em;
      color: var(--text-main);
      line-height: 1.2;
  }
  .dark-mode .bs-name { color: #e0e0e0; }

  /* Ph·∫ßn gi·ªØa: Nguy√™n li·ªáu */
  .bs-req {
      flex: 1.5;
      font-size: 0.8em;
      padding: 0 5px;
      border-left: 1px dashed #ddd;
      border-right: 1px dashed #ddd;
      margin: 0 5px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
  }
  .dark-mode .bs-req { border-color: #555; }

  /* Ph·∫ßn b√™n ph·∫£i: N√∫t b·∫•m */
  .bs-action {
      flex: 0.8;
      text-align: right;
  }

  .req-line { display: flex; align-items: center; gap: 4px; }
  .req-ok { color: var(--primary); font-weight: 600; }
  .req-miss { color: #f44336; }

  /* --- INPUT NAME BOX --- */
  #name-box input {
      width: 100%; padding: 10px; margin: 15px 0;
      border: 2px solid #ddd; border-radius: 10px;
      font-family: inherit; font-size: 14px; text-align: center;
      outline: none; transition: border 0.3s;
  }
  #name-box input:focus { border-color: var(--primary); }
  #btn-next {
      background: var(--primary); color: white;
      padding: 10px 30px; border-radius: 30px;
      font-size: 14px; font-weight: bold; border: none;
      box-shadow: 0 3px 0 var(--primary-dark);
  }
  #btn-next:active { transform: translateY(3px); box-shadow: none; }

  /* --- SCROLLBAR --- */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: #aaa; }

    /* --- CSS CHO C√ÇY TO --- */
  .seed-image.big-plant {
      width: 220% !important;        
      max-height: 250px !important;  
      bottom: 27px !important;       
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); 
      z-index: 10;                   
  }
    /* --- CSS FIX RI√äNG CHO C√ÇY T√åNH Y√äU --- */
  .seed-image.big-plant.love-fix {
      width: 120% !important;        
      max-height: 160px !important;  
      bottom: 26px !important;       
      /* ƒê√É S·ª¨A: ƒê·ªïi sang m√†u h·ªìng ƒë·∫≠m (DeepPink) v√† tƒÉng ƒë·ªô r√µ n√©t */
      filter: drop-shadow(0 5px 10px rgba(255, 20, 147, 0.85)); 
      z-index: 10;
  }
    /* --- CSS M·ªöI: C√¢y T√¨nh Y√™u giai ƒëo·∫°n v·ª´a (Stage 1) --- */
  /* Class n√†y s·∫Ω gi√∫p c√¢y nh·ªè h∆°n v√† b√≥ng g·ªçn h∆°n so v·ªõi giai ƒëo·∫°n thu ho·∫°ch */
  .seed-image.medium-plant.love-fix {
      width: 100% !important;        /* Nh·ªè h∆°n m·ª©c 120% c·ªßa giai ƒëo·∫°n l·ªõn */
      max-height: 130px !important;  /* Gi·ªõi h·∫°n chi·ªÅu cao th·∫•p h∆°n (g·ªëc l√† 160px) */
      bottom: 27px !important;
      /* B√≥ng m√†u h·ªìng nh∆∞ng nh·ªè h∆°n, g·∫ßn g·ªëc h∆°n */
      filter: drop-shadow(0 3px 7px rgba(255, 20, 147, 0.8)) !important;
      z-index: 9;
  }
    /* --- CSS CHO C√ÇY GIAI ƒêO·∫†N TR∆Ø·ªûNG TH√ÄNH (STAGE 1 - SIZE V·ª™A) --- */
  .seed-image.medium-plant {
      width: 160% !important;        /* Nh·ªè h∆°n 220% c·ªßa big-plant */
      max-height: 180px !important;  
      bottom: 27px !important;       
      z-index: 9;                   
      transition: all 0.3s ease;
  }

  /* Ch·ªânh b√≥ng ri√™ng cho C√¢y Kim Lo·∫°i giai ƒëo·∫°n v·ª´a (nh·∫°t h∆°n v√† nh·ªè h∆°n) */
  .seed-image.medium-plant.shadow-metal {
      filter: drop-shadow(0 3px 5px rgba(60, 60, 60, 0.8)) !important;
  }

  /* Ch·ªânh b√≥ng ri√™ng cho C√¢y Nguy√™n T·ªë giai ƒëo·∫°n v·ª´a (nh·∫°t h∆°n v√† nh·ªè h∆°n) */
  .seed-image.medium-plant.shadow-element {
      filter: drop-shadow(0 3px 5px rgba(171, 71, 188, 0.7)) !important;
  }
    /* --- CSS B√ìNG CHO C√ÇY (M·ªöI TH√äM) --- */
  
  /* 1. B√≥ng xanh l√° cho M·∫ßm Nh·ªè (Giai ƒëo·∫°n 0) */
  .seed-image.shadow-green {
      filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.8)) !important;
  }

  /* 2. B√≥ng x√°m cho C√¢y Kim Lo·∫°i (Giai ƒëo·∫°n l·ªõn) */
  .seed-image.big-plant.shadow-metal {
      /* ƒê√É S·ª¨A: ƒê·ªïi sang m√†u x√°m ƒëen ƒë·∫≠m ƒë·∫∑c h∆°n */
      filter: drop-shadow(0 5px 10px rgba(60, 60, 60, 1.0)) !important;
  }

  /* 3. B√≥ng t√≠m cho C√¢y Nguy√™n T·ªë (Giai ƒëo·∫°n l·ªõn) */
  .seed-image.big-plant.shadow-element {
      filter: drop-shadow(0 5px 10px rgba(171, 71, 188, 0.8)) !important;
  }

  /* --- CSS CHO QU√Ä T·∫∂NG H√ÄNG NG√ÄY (Daily Reward) --- */
  .daily-reward-bubble {
    position: absolute;
    width: 60px; /* K√≠ch th∆∞·ªõc ·∫£nh qu·∫£ ƒë√†o */
    height: 60px;
    z-index: 90; /* Cao h∆°n pet, th·∫•p h∆°n popup */
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: popInReward 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); /* Hi·ªáu ·ª©ng ph√°t s√°ng nh·∫π */
}

/* Hi·ªáu ·ª©ng xu·∫•t hi·ªán */
@keyframes popInReward {
    0% { transform: scale(0) translateY(20px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

/* Hi·ªáu ·ª©ng bay l√™n khi nh·∫≠n xong */
@keyframes flyUpReward {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
}
/* --- CSS CHO ICON ·∫§P TR·ª®NG (ü¶¢) --- */
  #incubator-icon {
      position: absolute;
      
      /* CƒÉn ch·ªânh v·ªã tr√≠: ƒê·∫∑t l·∫°i top cho ph√π h·ª£p v·ªõi k√≠ch th∆∞·ªõc m·ªõi */
      top: -18px;                   /* ƒê√£ s·ª≠a: ƒê·∫©y th·∫•p xu·ªëng m·ªôt ch√∫t cho g·∫ßn tr·ª©ng h∆°n (c≈© l√† -35px) */
      left: 40%;
      transform: translateX(-50%);  /* CƒÉn gi·ªØa ngang */
      
      /* Giao di·ªán: K√≠ch th∆∞·ªõc nh·ªè l·∫°i */
      font-size: 10px;              /* ƒê√£ s·ª≠a: Nh·ªè l·∫°i (c≈© l√† 40px) */
      z-index: 20;
      
      /* Hi·ªáu ·ª©ng: C·ªë ƒë·ªãnh (B·ªè animation float) */
      /* animation: float 2s ease-in-out infinite; */ /* <-- ƒê√£ comment d√≤ng n√†y ƒë·ªÉ t·∫Øt hi·ªáu ·ª©ng bay */
      
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
      pointer-events: none;
  }
/* --- CODE M·ªöI CHO 3 L√î (BALO) --- */
#backpack-slot {
    position: absolute;
    width: 20px;       /* K√≠ch th∆∞·ªõc t√∫i */
    height: 60px;
    top: 320px;        /* ƒê·ªô cao (ngang t·∫ßm v·ªõi em b√© c√¢u c√°) */
    left: 175px;        /* N·∫±m b√™n tr√°i m√†n h√¨nh (ho·∫∑c ch·ªânh s·ªë n√†y ƒë·ªÉ d·ªùi v·ªã tr√≠) */
    z-index: 10;
    cursor: pointer;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); /* ƒê·ªï b√≥ng cho ƒë·∫πp */
    transition: transform 0.2s;
}
#backpack-slot:hover { transform: scale(1.1); } /* Ph√≥ng to khi di chu·ªôt v√†o */
#backpack-slot img { width: 100%; height: 100%; object-fit: contain; }

/* --- GIAO DI·ªÜN 3 L√î (GRID 2 C·ªòT C√ÇN ƒê·ªêI) --- */
#inventory-list {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Chia l√†m 2 c·ªôt ƒë·ªÅu tƒÉm t·∫Øp */
    gap: 12px; /* Kho·∫£ng c√°ch gi·ªØa c√°c √¥ */
    max-height: 320px;
    overflow-y: auto;
    padding: 5px;
    margin-top: 10px;
}

.inventory-item {
    display: flex;
    flex-direction: column; /* X·∫øp d·ªçc: ·∫¢nh tr√™n - Ch·ªØ d∆∞·ªõi */
    align-items: center;
    justify-content: center;
    
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 10px;
    
    box-shadow: 0 3px 5px rgba(0,0,0,0.05); /* B√≥ng ƒë·ªï nh·∫π */
    transition: transform 0.1s;
}

.inventory-item:active {
    transform: scale(0.95); /* Hi·ªáu ·ª©ng nh√∫n khi b·∫•m */
}

/* KHUNG CH·ª®A ·∫¢NH (QUAN TR·ªåNG ƒê·ªÇ C√ÇN ƒê·ªêI) */
.inventory-img-box {
    width: 55px;  /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông */
    height: 55px; /* C·ªë ƒë·ªãnh chi·ªÅu cao */
    
    background: #f5f5f5; /* M√†u n·ªÅn x√°m nh·∫π sau l∆∞ng v·∫≠t ph·∫©m */
    border-radius: 50%;  /* Bo tr√≤n khung */
    border: 1px solid #eeeeee;
    
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px; /* C√°ch ph·∫ßn ch·ªØ b√™n d∆∞·ªõi */
}

.inventory-img-box img {
    width: 70%;  /* ·∫¢nh v·∫≠t ph·∫©m ch·ªâ chi·∫øm 70% khung ƒë·ªÉ kh√¥ng b·ªã tr√†n */
    height: 70%;
    object-fit: contain;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15));
}

.inventory-name {
    font-size: 0.85em;
    font-weight: 700;
    color: #3e2723;
    margin-bottom: 4px;
    text-align: center;
}

.inventory-qty {
    background: #FFF3E0;
    color: #E65100;
    font-size: 0.8em;
    padding: 2px 10px;
    border-radius: 10px;
    font-weight: bold;
    border: 1px solid #FFE0B2;
}
/* --- CSS CHO TOAST NOTIFICATION (PHI√äN B·∫¢N PRO) --- */
#toast-notification {
    position: fixed;
    bottom: 140px;           /* Cao h∆°n m·ªôt ch√∫t ƒë·ªÉ d·ªÖ nh√¨n */
    left: 50%;
    transform: translateX(-50%) scale(0.8);
    
/* S·ª¨A PH·∫¶N N√ÄY: L√†m n·ªÅn k√≠nh m·ªù hi·ªán ƒë·∫°i h∆°n */
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(76, 175, 80, 0.3); /* Vi·ªÅn m·ªèng tinh t·∫ø */
    border-left: 6px solid #4CAF50; /* ƒêi·ªÉm nh·∫•n b√™n tr√°i */
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); /* B√≥ng ƒë·ªï m·ªÅm m·∫°i h∆°n */
    backdrop-filter: blur(5px); /* Hi·ªáu ·ª©ng m·ªù n·ªÅn ph√≠a sau */
    
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 2000;
    
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    white-space: nowrap;
}

#toast-notification .toast-icon {
    font-size: 24px;
    background: #e8f5e9;
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
}

#toast-notification .toast-content {
    display: flex;
    flex-direction: column;
    text-align: left;
}

#toast-notification .toast-title {
    font-weight: 800;
    font-size: 0.9em;
    text-transform: uppercase;
    color: #4CAF50;
    letter-spacing: 1px;
}

#toast-notification .toast-message {
    font-size: 1em;
    font-weight: 600;
    color: #333;
}

/* Class k√≠ch ho·∫°t hi·ªáu ·ª©ng */
#toast-notification.show {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    animation: toastBounce 3s forwards;
}

@keyframes toastBounce {
    0%   { transform: translate(-50%, 20px) scale(0.8); opacity: 0; }
    10%  { transform: translate(-50%, 0px) scale(1); opacity: 1; }
    90%  { transform: translate(-50%, 0px) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -50px) scale(0.9); opacity: 0; }
}
/* --- HI·ªÜU ·ª®NG V·∫¨T PH·∫®M BAY L√äN (FLOATING REWARDS) --- */
.floating-reward {
    position: absolute;
    z-index: 9999; /* Lu√¥n n·ªïi l√™n tr√™n c√πng */
    font-weight: 900;
    font-size: 15px;
    pointer-events: none; /* Kh√¥ng ch·∫∑n click chu·ªôt */
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
    
    /* T·∫°o vi·ªÅn tr·∫Øng cho ch·ªØ d·ªÖ ƒë·ªçc tr√™n n·ªÅn game */
    text-shadow: 
        -1px -1px 0 #fff,  
         1px -1px 0 #fff,
        -1px  1px 0 #fff,
         1px  1px 0 #fff;

    animation: floatUpFade 1.2s ease-out forwards;
}

/* Animation: Ph√≥ng to nh·∫π -> Bay l√™n -> M·ªù d·∫ßn */
@keyframes floatUpFade {
    0% { transform: translateY(0) scale(0.8); opacity: 0; }
    20% { transform: translateY(-15px) scale(1.2); opacity: 1; }
    80% { opacity: 1; }
    100% { transform: translateY(-80px) scale(1); opacity: 0; }
}

/* M√†u s·∫Øc ri√™ng cho t·ª´ng lo·∫°i */
.float-exp { color: #2E7D32; } /* Xanh l√° ƒë·∫≠m */
.float-item { color: #E65100; } /* Cam ƒë·∫≠m */
/* --- CSS CHO H√íM TH√çNH GIFTCODE (ƒê√É S·ª¨A TO H∆†N) --- */
#giftcode-supply-drop {
    position: absolute;
    width: 40px; /* ƒê√£ tƒÉng t·ª´ 40px l√™n 50px cho ho√†nh tr√°ng */
    height: auto;
    
    /* CƒÉn ch·ªânh l·∫°i v·ªã tr√≠ m·ªôt ch√∫t cho c√¢n ƒë·ªëi v·ªõi k√≠ch th∆∞·ªõc m·ªõi */
    top: 400px; 
    left: 340px; 
    
    z-index: 12; /* N·ªïi l√™n tr√™n m·∫∑t n∆∞·ªõc */
    cursor: pointer;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
}

/* Giao di·ªán √¥ nh·∫≠p Giftcode */
#giftcode-input {
    width: 100%;
    padding: 12px;
    margin: 15px 0;
    border: 2px dashed #FF9800;
    border-radius: 10px;
    font-size: 16px;
    text-align: center;
    color: #E65100;
    font-weight: bold;
    text-transform: uppercase; /* T·ª± ƒë·ªông vi·∫øt hoa */
    outline: none;
    background: #FFF3E0;
}
#giftcode-input:focus {
    border-color: #E65100;
    background: #fff;
}
/* --- HI·ªÜU ·ª®NG KH√ìI ƒê·ªé SIGNAL (REALISTIC & R√ï N√âT) --- */
.smoke-particle {
    position: absolute;
    width: 16px;  /* K√≠ch th∆∞·ªõc c∆° b·∫£n to h∆°n x√≠u */
    height: 16px;
    
    /* Gradient 3 l·ªõp: T√¢m cam s√°ng -> ƒê·ªè ƒë·∫≠m -> Vi·ªÅn trong su·ªët */
    background: radial-gradient(circle, #ff5722 10%, #d50000 45%, rgba(255,0,0,0) 70%);
    
    border-radius: 50%;
    pointer-events: none;
    z-index: 11;
    opacity: 0;
    
    /* B·∫Øt ƒë·∫ßu √≠t blur ƒë·ªÉ r√µ n√©t, sau ƒë√≥ s·∫Ω blur d·∫ßn trong keyframes */
    filter: blur(2px); 
    
    /* Th·ªùi gian bay l√¢u h∆°n (2.5s) ƒë·ªÉ c·ªôt kh√≥i cao h∆°n */
    animation: smokeRise 2.5s ease-out forwards; 
}

@keyframes smokeRise {
    0% {
        transform: translate(0, 0) scale(0.5);
        opacity: 0;
    }
    10% {
        /* Hi·ªán ra nhanh v√† r√µ */
        opacity: 1; 
        transform: translate(0, -20px) scale(1);
    }
    100% {
        /* Bay l√™n r·∫•t cao (-220px), ph√¨nh to g·∫•p 6 l·∫ßn, v√† t·∫£n ra theo gi√≥ (var --dx) */
        transform: translate(var(--dx), -220px) scale(6); 
        opacity: 0;
        filter: blur(12px); /* L√™n cao th√¨ nh√≤e ƒëi nh∆∞ kh√≥i th·∫≠t */
    }
}
#bee-guard {
    position: absolute;
    width: 15px;              
    height: auto;
    
    top: 233px;               
    left: calc(50% - 166px);  
    
    z-index: 15;
    cursor: pointer;
    
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));

    display: none; /* M·∫∑c ƒë·ªãnh ·∫©n ƒëi ƒë·ªÉ JS x·ª≠ l√Ω */
}

/* V·∫´n gi·ªØ hi·ªáu ·ª©ng nh√∫n khi b·∫•m v√†o */
#bee-guard:active {
    transform: scale(0.9);
}

/* Hi·ªáu ·ª©ng khi b·∫•m v√†o th√¨ nh√∫n nh·∫π */
#bee-guard:active {
    transform: scale(0.9);
}
/* --- CSS CHO MINIGAME C√ÇU C√Å (PRO VERSION) --- */
#fishing-popup {
    background: #E0F7FA;
    border: 4px solid #0277BD;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    font-family: 'Fredoka', sans-serif;
}

/* Khu v·ª±c ch·ªù c√° c·∫Øn */
#fishing-waiting { text-align: center; padding: 20px; }

@keyframes float-bobber { 
    0%, 100% { transform: translateY(0) rotate(-5deg); } 
    50% { transform: translateY(-10px) rotate(5deg); } 
}

.fishing-float-anim { 
    font-size: 60px; 
    margin-bottom: 15px;
    display: flex;             
    justify-content: center;   
    align-items: center;       
    animation: float-bobber 2s ease-in-out infinite;
    filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2));
}

/* Khu v·ª±c ch∆°i game */
#fishing-game-area {
    display: none; 
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 20px;
    height: 340px;
    position: relative;
    margin-top: 10px;
    background: #B3E5FC;
    border-radius: 15px;
    padding: 10px;
    border: 2px solid #81D4FA;
}

/* C·ªôt n∆∞·ªõc ch√≠nh (Thanh Bar) */
#fishing-bar-container {
    width: 50px;
    height: 300px;
    background: linear-gradient(to right, #2c3e50, #4ca1af); /* M√†u n∆∞·ªõc s√¢u */
    border-radius: 25px;
    position: relative;
    overflow: hidden;
    border: 4px solid #37474F;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
}

/* V√πng Xanh (M·ª•c ti√™u - S·∫Ω di chuy·ªÉn) */
#zone-green {
    position: absolute; 
    left: 2px; 
    width: calc(100% - 4px); 
    height: 80px; /* Chi·ªÅu cao v√πng an to√†n */
    background: rgba(118, 255, 3, 0.5);
    border-top: 2px solid #76FF03;
    border-bottom: 2px solid #76FF03;
    z-index: 1;
    border-radius: 4px;
    box-shadow: 0 0 10px rgba(118, 255, 3, 0.4);
    transition: bottom 0.1s linear; /* Di chuy·ªÉn m∆∞·ª£t */
}

/* Thanh tr∆∞·ª£t (Bobber - Ng∆∞·ªùi ch∆°i ƒëi·ªÅu khi·ªÉn) */
#fishing-bobber {
    position: absolute; 
    left: 50%; 
    transform: translateX(-50%);
    bottom: 10%;
    width: 36px; 
    height: 20px;
    background: #FF5722; /* M√†u cam n·ªïi b·∫≠t */
    border: 2px solid #fff;
    border-radius: 10px;
    z-index: 10;
    transition: bottom 0.05s linear; 
    box-shadow: 0 0 8px rgba(255, 87, 34, 0.8);
}
/* Th√™m thanh ngang nh·ªè gi·ªØa bobber cho gi·ªëng th·∫≠t */
#fishing-bobber::after {
    content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(0,0,0,0.2);
}

/* Thanh ti·∫øn ƒë·ªô b·∫Øt c√° (B√™n ph·∫£i) */
#catch-progress-container {
    width: 25px; height: 300px;
    background: #eceff1; 
    border-radius: 15px;
    position: relative; 
    overflow: hidden; 
    border: 2px solid #cfd8dc;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

#catch-progress-fill {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
    background: linear-gradient(0deg, #FFEB3B, #FFC107, #FF9800, #4CAF50);
    transition: height 0.1s;
}

/* Hi·ªáu ·ª©ng khi thanh ƒë·∫ßy (chi·∫øn th·∫Øng) */
.progress-full {
    filter: drop-shadow(0 0 5px #4CAF50);
}

#fishing-timer {
    position: absolute; top: 15px; right: 20px;
    font-size: 1.8em; font-weight: 900; color: #0277BD;
    text-shadow: 2px 2px 0px white;
}
</style>
</head>
<body>
<div class="modal-overlay" id="global-overlay"></div> 

<div class="app-wrapper"> 

<button id="menu-btn" onclick="toggleHeader()">‚óÄ</button>

<header id="main-header">
  <div class="brand">
    <div id="player-level-display">üåæ Farm LOL üåæ</div>
    <div id="exp-bar-container">
    <div id="exp-fill"></div>
    <div id="exp-text-overlay">0 / 0</div>
</div>
  </div>
  <div class="controls">
    <button id="btn-new">üÜï T·∫°o</button>
    <button id="btn-save" disabled>üíæ L∆∞u</button>
    <button id="btn-delete" disabled>üóëÔ∏è Xo√°</button>
  </div>
</header>

<main>
  <img id="beanstalk-bg" src="1000000105.png" alt="Khu v∆∞·ªùn b√™n h·ªì" />
  
  <img id="bee-guard" src="1000000144.gif" alt="Ong N√πi Gi·∫ª" onclick="showBeePopup()" />
  <img id="light-bulb" src="1000000123.gif" alt="B√≥ng ƒë√®n" />
  
  <div id="pot-container">
        <div class="pot-slot" id="slot-1" data-slot="1">
        <img id="ice-egg-img" src="" alt="Tr·ª©ng Ng≈© S·∫Øc" style="display:none;" />
        
        <div id="incubator-icon" style="display:none;">ü¶¢</div>
    </div>
    
    <div class="pot-slot" id="slot-2" data-slot="2">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" /> 
        <img id="seed-img-2" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-3" data-slot="3">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-3" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-6" data-slot="6" onclick="showFishingPrePopup()">
    <img src="1000000116.gif" alt="Em b√© c√¢u c√°" style="pointer-events: none;" />
</div>
    
    <div class="pot-slot" id="slot-4" data-slot="4">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-4" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-5" data-slot="5">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-5" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-7" data-slot="7">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-7" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    <style>
  /* --- C·∫¨P NH·∫¨T CSS D√ÇY LEO V√Ä CH√ÇU CH·∫§U --- */
  .vine-deco {
      position: absolute;
      width: 10px;       /* TƒÉng v√πng click l√™n m·ªôt ch√∫t cho d·ªÖ b·∫•m */
      height: auto;
      top: 195px;
      z-index: 4;
      cursor: pointer;   /* Hi·ªÉn th·ªã b√†n tay khi tr·ªè v√†o */
      pointer-events: auto; /* QUAN TR·ªåNG: Cho ph√©p click */
      opacity: 0.9;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
      transition: transform 0.1s;
  }
  .vine-deco:active { transform: scale(0.9); }
    /* --- CODE M·ªöI: Hi·ªáu ·ª©ng Combo d√¢y leo --- */
  @keyframes gold-glow-blink {
      0% { filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5)); }
      50% { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 1)) brightness(1.2); }
      100% { filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5)); }
  }

  .vine-glowing {
      animation: gold-glow-blink 1.5s infinite ease-in-out !important;
      z-index: 5 !important; 
  }
  /* ---------------------------------------- */

  /* Class cho Ch√¢u Ch·∫•u */
  .hanging-grasshopper {
      position: absolute;
      width: 70px;       /* K√≠ch th∆∞·ªõc ch√¢u ch·∫•u */
      height: auto;
      top: 205px;        /* N·∫±m ngay d∆∞·ªõi d√¢y leo */
      z-index: 5;        /* N·∫±m sau d√¢y leo m·ªôt x√≠u cho t·ª± nhi√™n */
      pointer-events: auto; /* Cho ph√©p click v√†o con ch√¢u ch·∫•u */
      cursor: pointer;      /* Hi·ªán b√†n tay khi tr·ªè v√†o */
      /* ----------------------------------- */
      transform-origin: top center;
      animation: swing-grasshopper 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
      display: none;
  }

  @keyframes swing-grasshopper {
      0% { transform: rotate(3deg); }
      50% { transform: rotate(-3deg); }
      100% { transform: rotate(3deg); }
  }
    </style>

                <img src="1000000129.png" class="vine-deco" style="left: calc(50% - 87.5px);" data-index="0" />
    <img id="grasshopper-0" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% - 115px);" /> 

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% - 27.5px);" data-index="1" />
    <img id="grasshopper-1" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% - 55px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 32.5px);" data-index="2" />
    <img id="grasshopper-2" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 5px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 92.5px);" data-index="3" />
    <img id="grasshopper-3" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 65px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 152.5px);" data-index="4" />
    <img id="grasshopper-4" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 125px);" />
  </div>
  
    <div id="backpack-slot" onclick="openInventory()">
      <img src="1000000138.png" alt="3 L√¥" />
  </div>

  <img id="giftcode-supply-drop" src="1000000143.png" alt="H√≤m Th√≠nh" onclick="showGiftcodePopup()" />
  <img id="kinto-cloud" src="1000000103.png" alt="C√¢n ƒê·∫©u V√¢n" data-slot="0" />
  <img id="event-cloud" src="1000000131.png" alt="S·ª± Ki·ªán" />
  <img id="pet-house" src="1000000100.png" alt="Nh√† Pet" />
  
  <img id="chaos-blacksmith" src="1000000107.png" alt="Th·ª£ R√®n Chaos" />
  <img id="chaos-blacksmith-working" src="1000000101.gif" alt="Th·ª£ R√®n ƒêang L√†m" style="display:none;" />
  
<div id="pet-container" style="position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); z-index: 7; pointer-events: none; width: 120px; height: 120px; display: flex; align-items: flex-end; justify-content: center;">
    <img id="pug-pet" src="" alt="Ch√∫ ch√≥ Pug" style="display:none; width: 100%; height: auto; cursor: pointer; transform-origin: bottom center; pointer-events: auto;" />
</div>
  <img id="bone-bowl" src="1000000115.png" alt="B√°t ƒë·ª±ng x∆∞∆°ng" />
</main>

</div> 

<div id="name-box" style="display:none;">
    <h3>Xin ch√†o n√¥ng d√¢n!</h3>
    <p style="color:var(--text-muted);">H√£y ƒë·∫∑t m·ªôt c√°i t√™n th·∫≠t ng·∫ßu nh√©:</p>
    <input type="text" id="player-name" placeholder="V√≠ d·ª•: Alice" maxlength="12"/>
    <button id="btn-next">B·∫Øt ƒë·∫ßu ngay &rarr;</button>
</div>

<div id="shop-box">
  <h3>‚òÅÔ∏è Shop M√¢y</h3> 
  <div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
    <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-shop">0</b> &nbsp;|&nbsp; 
    <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-shop">0</b>
  </div>
  
  <div id="shop-tab-container-wrapper"></div>
  
  <button onclick="hidePopup('shop-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="seed-box">
<h3>üå± Shop H·∫°t Gi·ªëng</h3> 
<div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
  <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-seed">0</b> &nbsp;|&nbsp; 
  <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-seed">0</b>
</div>

<div id="seed-items" style="display:grid; grid-template-columns: 1fr; gap:10px; max-height: 400px; overflow-y: auto;"></div>
<button onclick="hidePopup('seed-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="online-box">
  <h3 style="color:#E64A19;">üéÅ H√≤m Th√≠nh</h3>
  <p style="color:#795548; font-size:0.9em; margin-bottom:5px;">
      Nh·∫≠p m√£ <b>Giftcode</b> ƒë·ªÉ nh·∫≠n qu√† b√≠ m·∫≠t:
  </p>
  
  <input type="text" id="giftcode-input" placeholder="NH·∫¨P M√É T·∫†I ƒê√ÇY" maxlength="15">
  
  <button onclick="handleGiftcode()" class="btn-buy" style="
      background: linear-gradient(45deg, #FF5722, #F4511E); 
      font-size: 1.1em; 
      padding: 10px; 
      margin-bottom: 10px;
      box-shadow: 0 4px 0 #D84315;">
    M·ªü Qu√† Ngay
  </button>

  <button onclick="hidePopup('online-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="pet-house-box">
  <h3 id="pet-house-title">üêæ Nh√† Pet</h3> 
  <div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
      <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-pet">0</b> &nbsp;|&nbsp; 
      <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-pet">0</b>
  </div>
  <div id="pet-shop-items"></div>
  <button onclick="hidePopup('pet-house-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="interaction-popup">
    <h3 id="interaction-title"></h3> 
    <div id="interaction-text" style="min-height: 50px; font-size: 0.95em; line-height: 1.5;"></div>
    <div id="interaction-controls" style="margin-top: 15px;"></div>
    <button onclick="closeInteractionPopup()" class="btn-close" style="margin-top: 20px;">ƒê√≥ng</button>
</div>

<div id="inventory-box">
    <h3 style="text-align:center; color:#5D4037; margin-top:0; border-bottom: 2px dashed #ddd; padding-bottom: 10px;">
        üéí 3 L√¥
    </h3>
    
    <div style="background: #FFF3E0; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; border: 1px solid #FFE0B2;">
        <div style="color:#795548; font-weight:bold;">
            ü´ò ƒê·∫≠u: <span id="inv-dau" style="color:#D84315; font-size:1.1em;">0</span>
        </div>
        <div style="border-left: 2px solid #ccc; height: 20px;"></div>
        <div style="color:#E65100; font-weight:bold;">
            üçÇ L√°: <span id="inv-la" style="color:#D84315; font-size:1.1em;">0</span>
        </div>
    </div>

    <div id="inventory-list" style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
        <div style="text-align:center; color:#999; margin-top:20px;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <button onclick="hidePopup('inventory-box')" class="btn-close" style="width:100%; margin-top:15px; background:#f44336; color:white; border:none; padding:10px; border-radius:20px; font-weight:bold; cursor:pointer;">
        ƒê√≥ng
    </button>
</div>
<div id="fishing-popup" class="shop-box" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: #E3F2FD; width: 90%; max-width: 350px; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000; text-align: center; border: 4px solid #2196F3; display: none; opacity: 0; transition: all 0.3s;">
    
    <h3 style="color:#1565C0; margin: 0 0 10px 0;">üé£ ƒê√¨a C√° D·ªì</h3>
    
    <div id="fishing-waiting">
        <div id="fishing-start-ui">
            <p style="color:#555; font-size:0.9em;">D√πng <b>x1 Nh·ªông Ong</b> <img src="1000000145.png" width="15" style="vertical-align:middle;"> ƒë·ªÉ c√¢u.</p>
            <div style="background:rgba(255,255,255,0.5); padding:10px; border-radius:10px; margin:10px 0; font-size:0.85em; color:#37474F;">
                üêü C√° Tr√™ (50%)<br>ü¶à C√° D·ªì (30%)<br>üê† C√° Tai T∆∞·ª£ng (20%)
            </div>
            <button id="btn-start-fishing" style="background:#29B6F6; color:white; border:none; padding:12px 20px; border-radius:25px; font-weight:bold; font-size:1em; cursor:pointer; box-shadow: 0 4px 0 #0288D1; width:100%;">
                QuƒÉng C·∫ßn Ngay!
            </button>
        </div>
        
        <div id="fishing-waiting-anim" style="display:none;">
            <div class="fishing-float-anim">üåäüé£üåä</div>
            <p style="color:#0277BD; font-weight:bold;">ƒêang ƒë·ª£i c√° c·∫Øn c√¢u...</p>
            <div id="fishing-countdown" style="font-size:3em; font-weight:900; color:#FF9800;">5</div>
        </div>
    </div>

    <div id="fishing-game-area">
        <div id="fishing-bar-container">
            <div id="zone-green"></div> <div id="zone-red"></div>   <div id="fishing-bobber"></div> </div>
        
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div style="font-size:0.7em; font-weight:bold; color:#E65100; margin-bottom:5px;">B·∫ÆT!</div>
            <div id="catch-progress-container">
                <div id="catch-progress-fill"></div>
            </div>
        </div>
        
        <div id="fishing-timer">10s</div>
    </div>
    
    <div id="fishing-guide-text" style="font-size:0.85em; color:#555; margin-top:10px; display:none;">
        üëÜ <b>NH·∫§P LI√äN T·ª§C</b> ƒë·ªÉ gi·ªØ thanh x√°m ·ªü v√πng Xanh!
    </div>

    <button onclick="closeFishingPopup()" style="margin-top:15px; background:#ef5350; color:white; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; width:100%; cursor:pointer;">Tho√°t</button>
</div>
<script>
// --- C·∫§U H√åNH TH·ªúI GIAN GAME (CH·ªàNH T·∫†I ƒê√ÇY) ---
const GAME_CONFIG = {
    // Th·ªùi gian ·∫•p tr·ª©ng (M·∫∑c ƒë·ªãnh: 24 * 60 * 60 * 1000 l√† 24 gi·ªù)
    // ƒê·ªÉ test nhanh, b·∫°n s·ª≠a th√†nh: 10 * 1000 (10 gi√¢y)
    HATCH_TIME: 24 * 60 * 60 * 1000, 
    
    // Th·ªùi gian n√¢ng c·∫•p Pet (M·∫∑c ƒë·ªãnh: 24 gi·ªù)
    UPGRADE_TIME: 24 * 60 * 60 * 1000 
};
// --- LOGIC SCALING (GI·ªÆ NGUY√äN) ---
function adjustAppWrapperScale() {
    const appWrapper = document.querySelector(".app-wrapper");
    if (!appWrapper) return;
    const designWidth = 400; const designHeight = 750; 
    const viewportWidth = window.innerWidth; const viewportHeight = window.innerHeight;
    
    const scaleX = viewportWidth / designWidth; 
    const scaleY = viewportHeight / designHeight;
    let scale = Math.min(scaleX, scaleY);
    const MAX_SCALE = 1.1; 
    scale = Math.min(scale, MAX_SCALE);
    
    appWrapper.style.transform = `scale(${scale})`;
    
    if (viewportHeight > designHeight * scale) { 
        const scaledHeight = designHeight * scale;
        const marginTop = (viewportHeight - scaledHeight) / 2;
        appWrapper.style.marginTop = `${marginTop}px`; appWrapper.style.marginBottom = `${marginTop}px`;
    } else { appWrapper.style.marginTop = '0'; appWrapper.style.marginBottom = '0'; }
}
window.addEventListener('resize', adjustAppWrapperScale);

function toggleHeader() {
    const header = document.getElementById('main-header');
    const btn = document.getElementById('menu-btn');
    header.classList.toggle('collapsed');
    if (header.classList.contains('collapsed')) { btn.innerHTML = '‚öôÔ∏è'; } else { btn.innerHTML = '‚óÄ'; }
}

let playerName = "N√¥ng d√¢n";
let farmIcon = "üåæ";
let level = 0;
let exp = 0;
let dau = 0; 
let la = 0;
let usedGiftcodes = []; // L∆∞u danh s√°ch m√£ ƒë√£ d√πng
// --- DANH S√ÅCH M√É GIFTCODE ƒêANG HO·∫†T ƒê·ªòNG ---
// B·∫°n th√™m code m·ªõi v√†o trong ngo·∫∑c n√†y, v√≠ d·ª•: ["FARMLOL", "NAMMOI", "TET2026"]
const ACTIVE_GIFTCODES = ["FARMLOL"];
// --- TH√äM BI·∫æN QU·∫¢N L√ù TRANG TR√ç ---
let vineDecorations = [null, null, null, null, null]; // 5 v·ªã tr√≠ d√¢y leo, null = tr·ªëng
let tool = { name: "X·∫ªng G·ªó", power: 1, maxHP: 100, currentHP: 100 };
let ownedDecorations = { 'chau_chau': 0 }; // Kho ch·ª©a ƒë·ªì trang tr√≠
let hasIceEgg = false; 
let isIceDragonHatched = false; 
let isIceDragonEvolved = false; 
let hatchedPetType = "thien_than"; // BI·∫æN M·ªöI: L∆ØU LO·∫†I PET ƒê√É ·∫§P (thien_than HO·∫∂C than_chet)
let activePet = null;
let incubationFinishTime = 0; // Th·ªùi gian k·∫øt th√∫c ·∫•p tr·ª©ng
let ownedPets = []; 
let ownedSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0, 'hat_tinh_yeu': 0 };
let globalPetAge = 0;
let petLevels = { 'thien_than': 1, 'than_chet': 1 }; // L∆∞u c·∫•p sao ri√™ng
// --- KHAI B√ÅO KHO V·∫¨T PH·∫®M ƒê·∫∂C BI·ªÜT (M·ªöI) ---
let petStarLevel = 1; // Bi·∫øn l∆∞u c·∫•p ƒë·ªô sao c·ªßa Pet
let ownedArtifacts = { 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0 };
let grasshopperExchanged = 0; // Bi·∫øn theo d√µi s·ªë l·∫ßn ƒë√£ ƒë·ªïi (T·ªëi ƒëa 5)
let isHarvesting = false; // Bi·∫øn ch·ªëng click ƒë√∫p khi thu ho·∫°ch
// --- TH√äM: C·∫§U H√åNH DANH S√ÅCH V·∫¨T PH·∫®M TREO ---
// ƒê√¢y l√† danh s√°ch ƒë·ªãnh nghƒ©a t√™n, ·∫£nh v√† gi√° c·ªßa c√°c m√≥n ƒë·ªì treo
const HANGING_ITEMS_CONFIG = [
    { 
        id: 'chau_chau', name: 'Ch√¢u Ch·∫•u', img: '1000000130.gif', price: 100,
        style: { width: '50px', top: '205px', marginLeft: '7px' } 
    },
    { 
        id: 'treo_con_ca', name: 'Con C√°', img: '1000000139.gif', price: 100,
        style: { width: '50px', top: '205px', marginLeft: '8px' }
    },
    { 
        id: 'treo_long_den', name: 'L·ªìng ƒê√®n', img: '1000000140.gif', price: 100,
        style: { width: '45px', top: '202px', marginLeft: '7px' }
    },
    { 
        id: 'treo_trai_chau', name: 'Tr√°i Ch√¢u', img: '1000000141.gif', price: 100,
        style: { width: '45px', top: '210px', marginLeft: '9px' }
    },
    { 
        id: 'treo_chong_chong', name: 'Chong Ch√≥ng', img: '1000000142.gif', price: 100,
        style: { width: '130px', top: '200px', marginLeft: '-32px' }
    }
];
// C·∫•u h√¨nh v·∫≠t ph·∫©m r·ªõt khi thu ho·∫°ch
const HARVEST_DROPS = {
    'hat_nguyen_to': { id: 'manh_nguyen_to', name: 'M·∫£nh Nguy√™n T·ªë', img: '1000000135.png' },
    'hat_kim_loai': { id: 'manh_kim_loai', name: 'M·∫£nh Kim Lo·∫°i', img: '1000000136.png' },
    'hat_tinh_yeu': { id: 'vuong_mien', name: 'V∆∞∆°ng Mi·ªán', img: '1000000137.png' }
};
let lastFedTime = 0;
let lastBeePokeTime = 0; // Bi·∫øn l∆∞u th·ªùi gian l·∫ßn cu·ªëi th·ªçc ong
let activePopupInterval = null;

// --- 1. C·∫¨P NH·∫¨T DANH S√ÅCH CH·∫¨U ---
let ownedPots = { 
    'so_dua': 0, 'chau_dong': 0, 
    'chau_bac': 0, 'chau_vang': 0, 
    'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 
}; 
let craftingQueue = []; 

const POT_DEFINITIONS = {
    'so_dua': { name: "S·ªç D·ª´a", img: "1000000112.png", expBonus: 0 },
    'chau_dong': { name: "Ch·∫≠u ƒê·ªìng", img: "1000000117.png", expBonus: 1 },
    'chau_bac': { name: "Ch·∫≠u B·∫°c", img: "1000000118.png", expBonus: 2 },
    'chau_vang': { name: "Ch·∫≠u V√†ng", img: "1000000119.png", expBonus: 3 },
    'chau_bach_kim': { name: "Ch·∫≠u BK", img: "1000000120.png", expBonus: 4 }, // ƒê√£ s·ª≠a t√™n
    'chau_kim_cuong': { name: "Ch·∫≠u KC", img: "1000000121.png", expBonus: 5 }, // ƒê√£ s·ª≠a t√™n
    'chau_kim_cuong_do': { name: "Ch·∫≠u KCƒê", img: "1000000122.png", expBonus: 6 } // ƒê√£ s·ª≠a t√™n
};

// --- 2. C·∫¨P NH·∫¨T C√îNG TH·ª®C R√àN (ƒê√É CH·ªàNH S·ª¨A: D√ôNG M·∫¢NH KIM LO·∫†I) ---
const CRAFTING_RECIPES = [
    {
        id: 'craft_so_dua',
        output: 'so_dua',
        name: 'S·ªç D·ª´a',
        icon: '1000000112.png',
        duration: 0,
        cost: { dau: 1000 }, 
        materials: {} 
    },
    {
        id: 'craft_chau_dong',
        output: 'chau_dong',
        name: 'Ch·∫≠u ƒê·ªìng',
        icon: '1000000117.png',
        duration: 2 * 60 * 60 * 1000, 
        cost: { dau: 2000 },
        materials: { 'so_dua': 1, 'manh_kim_loai': 20 }
    },
    {
        id: 'craft_chau_bac',
        output: 'chau_bac',
        name: 'Ch·∫≠u B·∫°c',
        icon: '1000000118.png',
        duration: 3 * 60 * 60 * 1000, 
        cost: { dau: 3000 },
        materials: { 'chau_dong': 1, 'manh_kim_loai': 30 }
    },
    {
        id: 'craft_chau_vang',
        output: 'chau_vang',
        name: 'Ch·∫≠u V√†ng',
        icon: '1000000119.png',
        duration: 4 * 60 * 60 * 1000, 
        cost: { dau: 4000 },
        materials: { 'chau_bac': 1, 'manh_kim_loai': 40 }
    },
    {
        id: 'craft_chau_bach_kim',
        output: 'chau_bach_kim',
        name: 'Ch·∫≠u BK', // ƒê√£ s·ª≠a t√™n
        icon: '1000000120.png',
        duration: 5 * 60 * 60 * 1000, 
        cost: { dau: 5000 },
        materials: { 'chau_vang': 1, 'manh_kim_loai': 50 }
    },
    {
        id: 'craft_chau_kim_cuong',
        output: 'chau_kim_cuong',
        name: 'Ch·∫≠u KC', // ƒê√£ s·ª≠a t√™n
        icon: '1000000121.png',
        duration: 6 * 60 * 60 * 1000, 
        cost: { dau: 6000 },
        materials: { 'chau_bach_kim': 1, 'manh_kim_loai': 60 }
    },
    {
        id: 'craft_chau_kim_cuong_do',
        output: 'chau_kim_cuong_do',
        name: 'Ch·∫≠u KCƒê', // ƒê√£ s·ª≠a t√™n
        icon: '1000000122.png',
        duration: 7 * 60 * 60 * 1000, 
        cost: { dau: 7000 },
        materials: { 'chau_kim_cuong': 1, 'manh_kim_loai': 70 }
    }
];

const FARM_IDS = [2, 3, 4, 5, 7]; 
let farmSlots = Array(5).fill(null); 
let equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua']; 

// --- ƒê√É CH·ªàNH S·ª¨A V·ªä TR√ç PET ---
let petShopItems = [
    // 1. Choco: Size nh·ªè (50px) -> CƒÉn gi·ªØa (-25px) -> ƒê·ª©ng cao h∆°n x√≠u (50px)
    { 
        id: 100, 
        name: "Choco", 
        price: 0, 
        currency: "dau", 
        type: "pet", 
        icon: "1000000128.gif", 
        value: "1000000128.gif", 
        customWidth: "50px", 
        position: { bottom: '50px', left: 'calc(50% - 25px)' }, 
    },
    
    // 2. Pug P√©o: Size v·ª´a (80px) -> CƒÉn gi·ªØa (-40px) -> ƒê·ª©ng chu·∫©n (40px)
    { 
        id: 101, 
        name: "Pug P√©o", 
        price: 100, 
        currency: "la", 
        type: "pet", 
        icon: "1000000106.png", 
        value: "1000000106.png", 
        customWidth: "80px", 
        position: { bottom: '40px', left: 'calc(50% - 40px)' }, 
    },

    // 3. Mr. Gold: Size to (100px) -> CƒÉn gi·ªØa (-50px) -> ƒê·ª©ng th·∫•p do ch√¢n to (35px)
    { 
        id: 102, 
        name: "Mr. Gold", 
        price: 100, 
        currency: "la", 
        type: "pet", 
        icon: "1000000108.gif", 
        value: "1000000108.gif", 
        customWidth: "100px", 
        position: { bottom: '35px', left: 'calc(50% - 50px)' }, 
    },
];

// --- DANH S√ÅCH SHOP ---
let shopItems = [
    // 1. Th√™m BI GAI v√†o ƒë·∫ßu danh s√°ch (Gi√° 0 ƒë·ªÉ ƒë√°nh d·∫•u l√† Pet kh·ªüi ƒë·∫ßu)
    { id: 201, name: "Bi Gai", price: 0, currency: "dau", type: "pet", icon: "1000000149.gif", value: "1000000149.gif", category: "pet_may" },

    // 2. Gi·ªØ nguy√™n Thi√™n Th·∫ßn v√† Th·∫ßn Ch·∫øt (V·∫´n b√°n trong Shop)
    { id: 202, name: "Thi√™n Th·∫ßn", price: 100, currency: "la", type: "pet", icon: "1000000127.gif", value: "1000000127.gif", category: "pet_may" },
    { id: 203, name: "Th·∫ßn Ch·∫øt",  price: 100, currency: "la", type: "pet", icon: "1000000104.gif", value: "1000000104.gif", category: "pet_may" },
    
    // C√°c lo·∫°i h·∫°t gi·ªëng gi·ªØ nguy√™n
    { id: 204, name: "H·∫°t Nguy√™n T·ªë", price: 100, currency: "dau", type: "seed", icon: "1000000125.png", value: "hat_nguyen_to", category: "hat_may" }, 
    { id: 205, name: "H·∫°t Kim Lo·∫°i",  price: 100, currency: "dau", type: "seed", icon: "1000000126.png", value: "hat_kim_loai", category: "hat_may" },
    { id: 206, name: "H·∫°t T√¨nh Y√™u",  price: 100, currency: "dau", type: "seed", icon: "1000000132.png", value: "hat_tinh_yeu", category: "hat_may" },
];

// --- C·∫¨P NH·∫¨T TH·ªúI GIAN TR·ªíNG C√ÇY (0h - 6h - 12h) ---
const PLANT_STAGES = [
    { 
        name: "M·∫ßm Nh·ªè", 
        icon: "1000000110.gif", 
        duration: 0, 
    }, 
    { 
        name: "C√¢y Tr∆∞·ªüng Th√†nh", 
        icon: "1000000130.gif", 
        // Giai ƒëo·∫°n M·∫ßm Nh·ªè k√©o d√†i 6 gi·ªù
        // 6 gi·ªù * 60 ph√∫t * 60 gi√¢y * 1000 ms
        duration: 6 * 60 * 60 * 1000, 
    }, 
    { 
        name: "S·∫µn S√†ng Thu Ho·∫°ch", 
        icon: "1000000130.gif", 
        // Giai ƒëo·∫°n C√¢y Tr∆∞·ªüng Th√†nh k√©o d√†i 6 gi·ªù (t·ªïng c·ªông 12 gi·ªù t·ª´ l√∫c tr·ªìng ƒë·ªÉ thu ho·∫°ch)
        duration: 6* 60 * 60 * 1000, 
    }, 
];

function showPopup(id) {
    document.getElementById('global-overlay').style.display = 'block';
    const el = document.getElementById(id);
    if(el) el.classList.add('popup-active');
}
function hidePopup(id) {
    const el = document.getElementById(id);
    if(el) el.classList.remove('popup-active');
    setTimeout(() => {
        if(!document.querySelector('.popup-active')) {
            document.getElementById('global-overlay').style.display = 'none';
        }
    }, 100); 
}
// --- H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO TOAST (B·∫¢N PRO) ---
function showToast(message, icon = "‚úÖ", title = "Th√¥ng b√°o") {
    let toast = document.getElementById('toast-notification');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        document.body.appendChild(toast);
    }

    // C·∫•u tr√∫c HTML m·ªõi: Icon + Ti√™u ƒë·ªÅ + N·ªôi dung
    toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
    `;

    toast.classList.remove('show');
    void toast.offsetWidth; // Reset animation
    toast.classList.add('show');

    setTimeout(() => {
        if (toast.classList.contains('show')) {
            toast.classList.remove('show');
        }
    }, 3500); // Hi·ªán l√¢u h∆°n x√≠u (3.5s) ƒë·ªÉ k·ªãp ƒë·ªçc
}

// --- H√ÄM C·∫¨P NH·∫¨T H√åNH ·∫¢NH TH·ª¢ R√àN (M·ªöI) ---
function updateBlacksmithVisuals() {
    const idleImg = document.getElementById('chaos-blacksmith');
    const workingImg = document.getElementById('chaos-blacksmith-working');
    
    // Ki·ªÉm tra bi·∫øn craftingQueue (h√†ng ch·ªù r√®n)
    if (craftingQueue && craftingQueue.length > 0) {
        // ƒêang b·∫≠n: ·∫®n ·∫£nh tƒ©nh, Hi·ªán ·∫£nh ƒë·ªông
        if(idleImg) idleImg.style.display = 'none';
        if(workingImg) workingImg.style.display = 'block';
    } else {
        // ƒêang r·∫£nh: Hi·ªán ·∫£nh tƒ©nh, ·∫®n ·∫£nh ƒë·ªông
        if(idleImg) idleImg.style.display = 'block';
        if(workingImg) workingImg.style.display = 'none';
    }
}

const body = document.body; 
const btnNew = document.getElementById("btn-new");
const btnDelete = document.getElementById("btn-delete"); 
const btnSave = document.getElementById("btn-save");  
const lightBulb = document.getElementById("light-bulb"); 
const nameBox = document.getElementById("name-box");
const btnNext = document.getElementById("btn-next");
const nameInput = document.getElementById("player-name");
const shopBox = document.getElementById("shop-box");
const playerLevelDisplay = document.getElementById("player-level-display");
const expBarContainer = document.getElementById("exp-bar-container");
const expFill = document.getElementById("exp-fill");
const coinDauShop = document.getElementById("coin-dau-shop"); 
const coinLaShop = document.getElementById("coin-la-shop");   
const coinDauPet = document.getElementById("coin-dau-pet");   
const coinLaPet = document.getElementById("coin-la-pet");     
const seedBox = document.getElementById("seed-box"); 
const coinDauSeed = document.getElementById("coin-dau-seed"); 
const coinLaSeed = document.getElementById("coin-la-seed");   
const seedItemsContainer = document.getElementById("seed-items"); 
const onlineBox = document.getElementById("online-box");
const petHouseBox = document.getElementById("pet-house-box");
const petHouseTitle = document.getElementById("pet-house-title"); 
const petShopItemsContainer = document.getElementById("pet-shop-items"); 
const interactionPopup = document.getElementById("interaction-popup"); 
const interactionTitle = document.getElementById("interaction-title"); 
const interactionText = document.getElementById("interaction-text"); 
const interactionControls = document.getElementById("interaction-controls"); 
const pugPetImg = document.getElementById("pug-pet"); 
const iceEggImg = document.getElementById("ice-egg-img"); 

let currentShopTab = 'pet_may';
let currentPetTab = 'cloud';

function expNeeded(lv){ return lv * 100; }

function checkLevelUp() {
    let leveledUp = false;
    while (level > 0 && exp >= expNeeded(level)) {
        exp -= expNeeded(level);
        level += 1;
        leveledUp = true;
    }
    if (leveledUp) { updateDisplay(); updateControlButtons(); }
}

function updateControlButtons(){
    const gameCreated = level > 0;
    btnNew.disabled = gameCreated;
    btnDelete.disabled = !gameCreated;
    btnSave.disabled = !gameCreated;
    
    if (playerLevelDisplay) playerLevelDisplay.innerHTML = gameCreated ? `${playerName} <span style="font-size:0.8em; color:#888;">|</span> Lv.${level}` : `üåæ Farm LOL üåæ`;
    if (expBarContainer) expBarContainer.style.visibility = gameCreated ? 'visible' : 'hidden';
}

function isPetOwned(petValue) { return ownedPets.includes(petValue); }

function activatePet(petValue) {
    const angelData = shopItems.find(i => i.name === "Thi√™n Th·∫ßn");
    const reaperData = shopItems.find(i => i.name === "Th·∫ßn Ch·∫øt");

    if((angelData && petValue === angelData.value) || (reaperData && petValue === reaperData.value)) {
        alert("Pet n√†y kh√¥ng th·ªÉ l√†m Pet ch√≠nh. N√≥ s·∫Ω ·ªü l·∫°i √î s·ªë 1 ƒë·ªÉ b·∫£o v·ªá n√¥ng tr·∫°i!");
        return;
    }
    activePet = petValue; updateDisplay(); alert(`ƒê√£ k√≠ch ho·∫°t Pet m·ªõi!`);
}

function updateDisplay(){
  if(level > 0 && expFill){
    const needed = expNeeded(level);
    const percent = Math.min(100, (exp / needed) * 100);

    // 1. C·∫≠p nh·∫≠t thanh m√†u xanh (nh∆∞ c≈©)
    expFill.style.width = percent + "%";

    // 2. C·∫≠p nh·∫≠t con s·ªë hi·ªÉn th·ªã (M·ªöI TH√äM)
    const expText = document.getElementById('exp-text-overlay');
    if(expText) {
        // Hi·ªÉn th·ªã d·∫°ng: EXP Hi·ªán T·∫°i / EXP C·∫ßn Thi·∫øt
        expText.innerText = `${Math.floor(exp)} / ${needed}`;
    }
}
// --- TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ HI·ªÜN/·∫®N THI√äN NGA ---
  const incubatorIcon = document.getElementById("incubator-icon");
  if (incubatorIcon) {
      // Ch·ªâ hi·ªán khi th·ªùi gian k·∫øt th√∫c ·∫•p > 0 (t·ª©c l√† ƒëang ·∫•p)
      if (incubationFinishTime > 0) {
          incubatorIcon.style.display = 'block';
      } else {
          incubatorIcon.style.display = 'none';
      }
  }
  const dauStr = dau.toLocaleString('vi-VN');
  const laStr = la.toLocaleString('vi-VN');

  if (coinDauShop) coinDauShop.textContent = dauStr;
  if (coinLaShop) coinLaShop.textContent = laStr;
  if (coinDauPet) coinDauPet.textContent = dauStr;
  if (coinLaPet) coinLaPet.textContent = laStr;
  if (coinDauSeed) coinDauSeed.textContent = dauStr;
  if (coinLaSeed) coinLaSeed.textContent = laStr;
  
  const angelData = shopItems.find(i => i.name === "Thi√™n Th·∫ßn");
  const reaperData = shopItems.find(i => i.name === "Th·∫ßn Ch·∫øt");
  const biGaiData = shopItems.find(i => i.name === "Bi Gai"); // <--- M·ªöI: L·∫•y th√¥ng tin Bi Gai
  
  // ... (gi·ªØ nguy√™n ph·∫ßn code hi·ªÉn th·ªã Slot 1 ·ªü gi·ªØa n·∫øu c√≥) ...

    // --- S·ª¨A L·ªñI PET: D√πng container ƒë·ªÉ ƒë·ªãnh v·ªã ---
    const petContainer = document.getElementById("pet-container");
    
    if (pugPetImg && petContainer) {
      // D∆∞·ªõi ƒë√¢y l√† c√¢u l·ªánh ki·ªÉm tra: N·∫øu KH√îNG PH·∫¢I Thi√™n Th·∫ßn, KH√îNG PH·∫¢I Th·∫ßn Ch·∫øt, v√† KH√îNG PH·∫¢I Bi Gai th√¨ m·ªõi hi·ªán d∆∞·ªõi ƒë·∫•t
      if (activePet && 
          !(angelData && activePet === angelData.value) && 
          !(reaperData && activePet === reaperData.value) &&
          !(biGaiData && activePet === biGaiData.value) // <--- M·ªöI: Ch·∫∑n Bi Gai hi·ªán d∆∞·ªõi ƒë·∫•t
      ) { 
          pugPetImg.src = activePet;
          pugPetImg.style.display = 'block'; 
          
          // 1. X·ª≠ l√Ω hi·ªáu ·ª©ng th·ªü
          if (activePet.includes("1000000106.png")) {
              pugPetImg.classList.add("pet-breathing-effect");
          } else {
              pugPetImg.classList.remove("pet-breathing-effect");
          }

          let petData = petShopItems.find(p => p.value === activePet);
          if (!petData) petData = shopItems.find(p => p.value === activePet);
          
          // 2. X·ª≠ l√Ω k√≠ch th∆∞·ªõc (Set v√†o container)
          if (petData && petData.customWidth) {
              petContainer.style.width = petData.customWidth;
          } else {
              petContainer.style.width = "120px"; // Size m·∫∑c ƒë·ªãnh
          }

          // 3. X·ª≠ l√Ω v·ªã tr√≠ (Set v√†o container)
          if (petData && petData.position) {
              petContainer.style.bottom = petData.position.bottom;
              petContainer.style.left = petData.position.left;
              petContainer.style.transform = 'none'; // B·ªè cƒÉn gi·ªØa n·∫øu ƒë√£ c√≥ v·ªã tr√≠ c·ª• th·ªÉ
          } else {
              petContainer.style.bottom = '35px';
              petContainer.style.left = '50%';
              petContainer.style.transform = 'translateX(-50%)'; // CƒÉn gi·ªØa
          }
      } else {
          pugPetImg.src = "";
          pugPetImg.style.display = 'none';
          pugPetImg.classList.remove("pet-breathing-effect"); 
      }
  }
  // --- S·ª¨A L·ªñI SLOT 1: C·∫¨P NH·∫¨T H√åNH ·∫¢NH & K√çCH TH∆Ø·ªöC CHU·∫®N ---
  const slot1Img = document.getElementById("ice-egg-img");
  
  if (slot1Img) {
      // 1. X√≥a s·∫°ch c√°c class ƒë·ªãnh d·∫°ng c≈© ƒë·ªÉ tr√°nh xung ƒë·ªôt
      slot1Img.classList.remove('fix-egg', 'fix-angel', 'fix-reaper', 'fix-bigai');

      // 2. TR∆Ø·ªúNG H·ª¢P: TR·ª®NG ƒê√É N·ªû (ƒê√£ c√≥ Pet H·ªô V·ªá)
      if (isIceDragonHatched) {
          slot1Img.style.display = 'block';
          slot1Img.classList.remove('egg-shaking'); 
          slot1Img.style.animation = "none"; 
          slot1Img.style.transform = "none"; 
          
          if (hatchedPetType === 'than_chet') {
              slot1Img.src = "1000000104.gif";
              slot1Img.classList.add('fix-reaper'); // √Åp d·ª•ng size Th·∫ßn Ch·∫øt
          }
          else if (hatchedPetType === 'bi_gai') {
              slot1Img.src = "1000000149.gif";
              slot1Img.classList.add('fix-bigai');  // √Åp d·ª•ng size Bi Gai
          }
          else {
              slot1Img.src = "1000000127.gif"; 
              slot1Img.classList.add('fix-angel');  // √Åp d·ª•ng size Thi√™n Th·∫ßn
          }
      } 
      
      // 3. TR∆Ø·ªúNG H·ª¢P: ƒêANG L√Ä QU·∫¢ TR·ª®NG (Ch∆∞a n·ªü)
      else if (hasIceEgg) {
          slot1Img.style.display = 'block';
          slot1Img.src = "1000000102.png"; 
          slot1Img.classList.add('fix-egg'); // √Åp d·ª•ng size Tr·ª©ng

          if (incubationFinishTime > 0) {
             slot1Img.style.animation = "shake-egg 0.5s infinite"; 
          } else {
             slot1Img.style.animation = "none"; 
             slot1Img.style.transform = "none"; 
          }
      } 
      
      // 4. TR∆Ø·ªúNG H·ª¢P: KH√îNG C√ì G√å
      else {
          slot1Img.style.display = 'none';
          slot1Img.src = "";
          slot1Img.style.animation = "none"; 
      }
  }

  FARM_IDS.forEach((slotId, index) => {
      const seedImg = document.getElementById(`seed-img-${slotId}`);
      const baseImg = document.querySelector(`#slot-${slotId} .pot-base-img`);
      const slotData = farmSlots[index];

      let potType = equippedPots[index] || 'so_dua';
      let potImgSrc = POT_DEFINITIONS[potType] ? POT_DEFINITIONS[potType].img : "1000000112.png";
      
      if (baseImg) baseImg.src = potImgSrc;

      if(seedImg && baseImg) {
          if(slotData) {
              let currentStage = PLANT_STAGES[slotData.stage];
              let useIcon = currentStage.icon; 
              
              if (slotData.stage === 1) { 
                  if (slotData.value === 'hat_kim_loai') useIcon = "1000000111.gif"; 
                  else if (slotData.value === 'hat_nguyen_to') useIcon = "1000000113.gif";
                  else if (slotData.value === 'hat_tinh_yeu') useIcon = "1000000133.gif";
              }
              else if (slotData.stage === 2) {
                   if (slotData.value === 'hat_kim_loai') useIcon = "1000000124.gif"; 
                   else if (slotData.value === 'hat_nguyen_to') useIcon = "1000000114.gif";
                   else if (slotData.value === 'hat_tinh_yeu') useIcon = "1000000134.gif";
              }

              // --- RESET C√ÅC CLASS C≈® ---
              // Nh·ªõ x√≥a c·∫£ class 'medium-plant' m·ªõi th√™m
              seedImg.classList.remove('big-plant', 'medium-plant', 'love-fix', 'shadow-green', 'shadow-metal', 'shadow-element');

              if (slotData.stage === 0) {
                  // 1. M·∫ßm nh·ªè: Th√™m b√≥ng xanh l√°
                  seedImg.classList.add('shadow-green');
              } 
              else if (slotData.stage >= 1) {
                  // --- S·ª¨A LOGIC SIZE: T√ÅCH RI·ªÜNG STAGE 1 V√Ä 2 ---
                  
                  // N·∫øu l√† H·∫°t T√¨nh Y√™u -> √Åp d·ª•ng fix m√†u h·ªìng v√† chia size theo giai ƒëo·∫°n
                  if (slotData.value === 'hat_tinh_yeu') {
                      seedImg.classList.add('love-fix'); // Lu√¥n th√™m class ƒë·ªÉ c√≥ m√†u b√≥ng h·ªìng

                      if (slotData.stage === 1) {
                          // Giai ƒëo·∫°n 1: D√πng class medium-plant ƒë·ªÉ k√≠ch ho·∫°t CSS nh·ªè b·∫°n v·ª´a th√™m
                          seedImg.classList.add('medium-plant'); 
                      } else {
                          // Giai ƒëo·∫°n 2 (Thu ho·∫°ch): D√πng class big-plant nh∆∞ c≈©
                          seedImg.classList.add('big-plant');
                      }
                  }
                  else {
                      // V·ªõi c√°c c√¢y kh√°c (Kim Lo·∫°i, Nguy√™n T·ªë...)
                      if (slotData.stage === 1) {
                          seedImg.classList.add('medium-plant'); // Giai ƒëo·∫°n 1: Size v·ª´a (160%)
                      } else {
                          seedImg.classList.add('big-plant');    // Giai ƒëo·∫°n 2: Size to (220%)
                      }
                  }

                  // --- ADD CLASS B√ìNG (D√ôNG CHUNG LOGIC T√äN, CSS T·ª∞ CH·ªàNH) ---
                  if (slotData.value === 'hat_kim_loai') {
                      seedImg.classList.add('shadow-metal');
                  }
                  if (slotData.value === 'hat_nguyen_to') {
                      seedImg.classList.add('shadow-element');
                  }
              }

              seedImg.src = useIcon;
              seedImg.alt = slotData.name;
              seedImg.style.display = 'block';
              baseImg.style.opacity = '1';
          } else {
              seedImg.style.display = 'none';
              seedImg.src = "";
              seedImg.classList.remove('big-plant');
              baseImg.style.opacity = '1';
          }
      }
  });
// --- C·∫¨P NH·∫¨T HI·ªÇN TH·ªä V·∫¨T PH·∫®M TREO (ƒê√É T·ªêI ∆ØU) ---
vineDecorations.forEach((itemId, index) => {
  const hangingEl = document.getElementById(`grasshopper-${index}`);
  if (hangingEl) {
      if (itemId) {
          const itemConfig = HANGING_ITEMS_CONFIG.find(i => i.id === itemId);
          if (itemConfig) {
              hangingEl.src = itemConfig.img;
              hangingEl.style.display = 'block';
              
              // √Åp d·ª•ng style t·ª´ config (Code g·ªçn h∆°n r·∫•t nhi·ªÅu)
              if (itemConfig.style) {
                  hangingEl.style.width = itemConfig.style.width || '50px';
                  hangingEl.style.top = itemConfig.style.top || '205px';
                  hangingEl.style.marginLeft = itemConfig.style.marginLeft || '0px';
              }
              
              // Hi·ªáu ·ª©ng l·∫Øc l∆∞
              hangingEl.style.animation = 'swing-grasshopper 3s ease-in-out infinite';
          }
      } else {
          hangingEl.style.display = 'none';
      }
  }
});

  // --- CODE M·ªöI: B·∫≠t s√°ng d√¢y leo khi ƒë·ªß 5 m√≥n ---
  const isFullSet = vineDecorations.every(item => item !== null);
  const vineElements = document.querySelectorAll('.vine-deco');
  
  vineElements.forEach(vine => {
      if (isFullSet) {
          vine.classList.add('vine-glowing');
      } else {
          vine.classList.remove('vine-glowing');
      }
  });
  // ----------------------------------------------
}
// --- ƒê√É S·ª¨A: HI·ªÇN TH·ªä KHO PET ƒê·ªÇ ƒê·ªîI V√Ä C·∫¨P NH·∫¨T NGAY ---
function showCloudPetInventory() {
    interactionTitle.innerHTML = "üêæ Kho Pet M√¢y";
    interactionText.innerHTML = "Ch·ªçn Pet b·∫°n mu·ªën ƒë∆∞a ra b·∫£o v·ªá n√¥ng tr·∫°i:";
    interactionControls.innerHTML = "";

    const container = document.createElement('div');
    container.style.cssText = "display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;";

    const guardianPets = [
        // Th√™m d√≤ng n√†y:
        { type: 'bi_gai',     name: 'Bi Gai',     icon: '1000000149.gif', value: '1000000149.gif' },
        // Gi·ªØ nguy√™n 2 d√≤ng c≈©:
        { type: 'thien_than', name: 'Thi√™n Th·∫ßn', icon: '1000000127.gif', value: '1000000127.gif' },
        { type: 'than_chet',  name: 'Th·∫ßn Ch·∫øt',  icon: '1000000104.gif', value: '1000000104.gif' }
    ];

    let hasAny = false;

    guardianPets.forEach(p => {
        // Ch·ªâ hi·ªán nh·ªØng con ƒë√£ s·ªü h·ªØu
        if (isPetOwned(p.value)) {
            hasAny = true;
            // Ki·ªÉm tra xem con n√†y c√≥ ph·∫£i con ƒëang n·ªü (active ·ªü slot 1) kh√¥ng
            const isCurrent = (hatchedPetType === p.type);
            
            // L·∫•y level ri√™ng c·ªßa con n√†y
            const pLevel = petLevels[p.type] || 1;
            let stars = "";
            for(let i=0; i<pLevel; i++) stars += "‚≠ê";

            const itemDiv = document.createElement('div');
            itemDiv.className = "shop-item";
            itemDiv.style.borderColor = isCurrent ? "#4CAF50" : "#eee";
            itemDiv.style.background = isCurrent ? "#E8F5E9" : "#fff";

            itemDiv.innerHTML = `
                <img src="${p.icon}" style="width:50px; height:50px; object-fit:contain;">
                <div style="font-weight:bold; margin-top:5px; color:${isCurrent ? '#2E7D32' : '#333'}">${p.name}</div>
                <div style="font-size:0.8em; color:#FF9800;">${stars}</div>
                <button class="btn-select-pet" style="
                    margin-top:8px; width:100%; border:none; border-radius:15px; padding:5px;
                    background: ${isCurrent ? '#ccc' : 'var(--primary)'};
                    color: white; font-size: 0.8em; cursor: ${isCurrent ? 'default' : 'pointer'};
                ">
                    ${isCurrent ? 'ƒêang Ch·ªçn' : 'Ch·ªçn'}
                </button>
            `;

            if (!isCurrent) {
                itemDiv.querySelector('.btn-select-pet').onclick = () => {
                    // Logic ƒë·ªïi Pet
                    hatchedPetType = p.type;
                    petStarLevel = petLevels[p.type] || 1; // C·∫≠p nh·∫≠t l·∫°i sao hi·ªÉn th·ªã theo con m·ªõi ƒë·ªïi

                    // QUAN TR·ªåNG: L∆∞u v√† C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
                    saveGame();
                    updateDisplay(); // H√†m n√†y s·∫Ω ƒë·ªïi ·∫£nh ·ªü Slot 1 ngay l·∫≠p t·ª©c
                    
                    if(typeof showToast === 'function') {
                        showToast(`ƒê√£ ƒë·ªïi sang ${p.name}`, "üîÑ", "Th√†nh C√¥ng");
                    } else {
                        alert(`ƒê√£ ƒë·ªïi sang ${p.name}!`);
                    }
                    
                    closeInteractionPopup();

                    // M·ªü l·∫°i popup Slot 1 ƒë·ªÉ th·∫•y th√¥ng tin m·ªõi
                    setTimeout(() => { document.querySelector('#slot-1').click(); }, 300);
                };
            }
            container.appendChild(itemDiv);
        }
    });

    if(!hasAny) {
        container.innerHTML = "<div>B·∫°n ch∆∞a c√≥ Pet n√†o.</div>";
    }

    interactionControls.appendChild(container);
    showPopup('interaction-popup');
}
// --- CODE M·ªöI: showShopPopup ---
function showShopPopup() {
    const wrapper = document.getElementById('shop-tab-container-wrapper');
    if (!wrapper) return;
    wrapper.innerHTML = '';
    
    // ƒê·∫∑t m·∫∑c ƒë·ªãnh l√† h·∫°t m√¢y ƒë·ªÉ hi·ªÉn th·ªã lu√¥n
    currentShopTab = 'hat_may'; 

    // T·∫°o ti√™u ƒë·ªÅ thay v√¨ Tab ch·ªçn
    const title = document.createElement('div');
    title.style.cssText = "font-weight:bold; color:#795548; margin-bottom:10px; text-align:left; border-bottom:1px solid #eee; padding-bottom:5px;";
    title.innerHTML = "üå± Danh s√°ch H·∫°t Gi·ªëng";
    wrapper.appendChild(title);

    const contentContainer = document.createElement('div');
    contentContainer.id = 'shop-content-grid';
    contentContainer.style.cssText = 'max-height: 300px; overflow-y: auto; padding-right:5px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';
    wrapper.appendChild(contentContainer);

    renderShopItems(contentContainer);
    showPopup('shop-box');
}

function switchShopTab(tabName) {
    currentShopTab = tabName;
    showShopPopup();
}

// --- CODE M·ªöI: renderShopItems (ƒê√É C√ÇN ƒê·ªêI ·∫¢NH H·∫†T GI·ªêNG) ---
function renderShopItems(container) {
  container.innerHTML = "";
  // S·ª¨A: Lu√¥n l·ªçc theo 'hat_may' ƒë·ªÉ ch·ªâ hi·ªÉn th·ªã h·∫°t gi·ªëng
  const itemsToRender = shopItems.filter(item => item.category === 'hat_may');

  itemsToRender.forEach(item => { 
      const itemDiv = document.createElement("div");
      itemDiv.className = "shop-item";
      
      const currencyIcon = item.currency === "dau" ? 'ü´ò' : 'üçÇ';
      const currencyColor = item.currency === "dau" ? '#795548' : '#E65100'; 
      
      itemDiv.innerHTML = `
        <div style="
            width: 60px; 
            height: 60px; 
            background: #f5f5f5; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 8px;
            border: 1px solid #eee;
        ">
            <img src="${item.icon}" alt="${item.name}" style="
                width: 65%; 
                height: 65%; 
                object-fit: contain; 
                filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15));
            " />
        </div>
        <div style="font-weight:700; font-size:0.9em; color: var(--text-main); margin-bottom: 2px;">${item.name}</div>
        <div style="font-size:0.8em; color:var(--text-muted); margin-bottom: 5px;">
          <span style="color:${currencyColor};">${currencyIcon}</span> <b>${item.price.toLocaleString('vi-VN')}</b>
        </div>
        <button class="btn-buy" data-id="${item.id}" data-type="general">Mua</button>
      `;
      container.appendChild(itemDiv);
  });
  
  container.querySelectorAll(".btn-buy").forEach(btn => { 
      btn.addEventListener("click", handleBuy); 
  });
}

function updateShop(){
    if(document.getElementById('shop-box').classList.contains('popup-active')) {
        const container = document.getElementById('shop-content-grid');
        if(container) renderShopItems(container);
    }
}

// --- S·ª¨A L·ªñI: updatePetShop (ƒê√É FIX L·ªñI SAO) ---
function updatePetShop() {
    if (!petShopItemsContainer) return;
    petShopItemsContainer.innerHTML = "";
    
    // Chuy·ªÉn sang hi·ªÉn th·ªã d·∫°ng kh·ªëi
    petShopItemsContainer.style.display = "block"; 

    // 1. Ph√¢n lo·∫°i Pet
    const cloudPets = shopItems.filter(i => i.name === "Thi√™n Th·∫ßn" || i.name === "Th·∫ßn Ch·∫øt" || i.name === "Bi Gai");
    const lamePets = petShopItems; // C√°c con Choco, Pug...

    // 2. T·∫†O THANH TAB NGANG
    const tabContainer = document.createElement("div");
    tabContainer.className = "tab-container"; 
    tabContainer.innerHTML = `
        <button class="tab-btn ${currentPetTab === 'cloud' ? 'active' : ''}" id="btn-tab-cloud">
            ‚òÅÔ∏è Pet M√¢y
        </button>
        <button class="tab-btn ${currentPetTab === 'lame' ? 'active' : ''}" id="btn-tab-lame">
            üêï Pet L·ªè
        </button>
    `;
    petShopItemsContainer.appendChild(tabContainer);

    // G√°n s·ª± ki·ªán chuy·ªÉn Tab
    tabContainer.querySelector("#btn-tab-cloud").onclick = () => {
        currentPetTab = 'cloud';
        updatePetShop(); 
    };
    tabContainer.querySelector("#btn-tab-lame").onclick = () => {
        currentPetTab = 'lame';
        updatePetShop(); 
    };

    // 3. H√†m t·∫°o HTML cho t·ª´ng con Pet
    const createPetHTML = (item, isCloudPet) => {
        const owned = isPetOwned(item.value); 
        let isActive = false;
        let starDisplay = ""; // <--- T√™n bi·∫øn ƒë√∫ng l√† starDisplay
        let guardianType = "";

        if (isCloudPet) {
            if (item.name === "Thi√™n Th·∫ßn") guardianType = 'thien_than';
            else if (item.name === "Th·∫ßn Ch·∫øt") guardianType = 'than_chet';
            else if (item.name === "Bi Gai") guardianType = 'bi_gai';
            
            isActive = (hatchedPetType === guardianType);
            
            if (owned) {
                const pLevel = petLevels[guardianType] || 1;
                // --- ƒê√É S·ª¨A L·ªñI T·∫†I D√íNG N√ÄY (starsDisplay -> starDisplay) ---
                for(let i=0; i<pLevel; i++) starDisplay += "‚≠ê"; 
                // -------------------------------------------------------------
                starDisplay = `<div style="color:#FF9800; font-size:0.7em; margin-bottom:3px; height:15px;">${starDisplay}</div>`;
            } else {
                 starDisplay = `<div style="height:15px;"></div>`; 
            }
        } else {
            isActive = (item.value === activePet);
            starDisplay = `<div style="height:15px;"></div>`; 
        }

        const currencyIcon = item.currency === "la" ? 'üçÇ' : 'ü´ò';
        const currencyColor = item.currency === "la" ? '#E65100' : '#795548';
        const priceDisplay = `<span style="font-size:0.8em; color:${currencyColor};">${currencyIcon}</span> ${item.price.toLocaleString('vi-VN')}`;

        let buttonHTML = '';
        if (!owned) {
            let buyType = isCloudPet ? "general" : "pet-shop-internal";
            buttonHTML = `<button class="btn-buy-pet" data-id="${item.id}" data-type="${buyType}" style="background:var(--primary);">Mua</button>`;
        } else if (isActive) {
            buttonHTML = `<button disabled style="background:#4CAF50; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%; opacity:0.8;">‚úÖ ƒêang D√πng</button>`;
        } else {
            buttonHTML = `<button class="btn-activate-pet" data-value="${item.value}" data-guardian="${isCloudPet ? guardianType : ''}" style="background:#2196F3; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%; cursor:pointer;">Ch·ªçn</button>`;
        }

        const itemDiv = document.createElement("div");
        itemDiv.className = "pet-shop-item";
        itemDiv.style.cssText = "background: white; border: 1px solid #eee; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 180px;";

        itemDiv.innerHTML = `
            <div style="width: 100%; height: 70px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px;">
                <img src="${item.icon}" alt="${item.name}" style="max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 3px 3px rgba(0,0,0,0.1));" />
            </div>
            
            <div style="font-weight:700; font-size:0.95em; margin: 2px 0; color:#333; text-align:center; height: 20px; display: flex; align-items: center; justify-content: center;">
                ${item.name}
            </div>
            
            ${starDisplay}
            
            <div style="font-size:0.8em; margin-bottom:8px; height: 20px; display:flex; align-items:center;">
                ${owned ? '<span style="color:#4CAF50; font-weight:bold;">ƒê√£ s·ªü h·ªØu</span>' : priceDisplay}
            </div>
            
            <div style="width:100%; margin-top: auto;">${buttonHTML}</div>
        `;
        return itemDiv;
    };

    // 4. V·∫º DANH S√ÅCH
    const gridContainer = document.createElement("div");
    gridContainer.style.cssText = "display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;";

    if (currentPetTab === 'cloud') {
        const note = document.createElement("div");
        note.innerHTML = "(H·ªô V·ªá: B·∫£o v·ªá n√¥ng tr·∫°i & Auto thu ho·∫°ch)";
        note.style.cssText = "grid-column: span 2; font-size: 0.8em; color: #1976D2; text-align: center; margin-bottom: 5px;";
        gridContainer.appendChild(note);

        cloudPets.forEach(pet => {
            gridContainer.appendChild(createPetHTML(pet, true));
        });
    } else {
        const note = document.createElement("div");
        note.innerHTML = "(ƒêi D·∫°o: Ch·∫°y lon ton cho vui & T·∫∑ng qu√†)";
        note.style.cssText = "grid-column: span 2; font-size: 0.8em; color: #E65100; text-align: center; margin-bottom: 5px;";
        gridContainer.appendChild(note);

        lamePets.forEach(pet => {
            gridContainer.appendChild(createPetHTML(pet, false));
        });
    }

    petShopItemsContainer.appendChild(gridContainer);

    // 5. G√°n s·ª± ki·ªán click
    petShopItemsContainer.querySelectorAll(".btn-buy-pet").forEach(btn => { 
        btn.addEventListener("click", handleBuy); 
    });
    
    petShopItemsContainer.querySelectorAll(".btn-activate-pet").forEach(btn => {
        btn.addEventListener("click", (e) => { 
            const val = e.target.getAttribute("data-value");
            const gType = e.target.getAttribute("data-guardian");

            if (gType) {
                hatchedPetType = gType;
                petStarLevel = petLevels[gType] || 1; 
                let showName = "Bi Gai";
                if(gType === 'thien_than') showName = "Thi√™n Th·∫ßn";
                if(gType === 'than_chet') showName = "Th·∫ßn Ch·∫øt";

                saveGame(); updateDisplay(); updatePetShop(); 
                if(typeof showToast === 'function') showToast(`ƒê√£ ƒë·ªïi H·ªô V·ªá: ${showName}`, "üõ°Ô∏è");
            } else {
                activatePet(val); 
                updatePetShop(); 
            }
        });
    });
}

function updateSeedShop() {
    if (!seedItemsContainer) return;
    seedItemsContainer.innerHTML = "";
    const seedShopMap = new Map();
    shopItems.filter(item => item.type === 'seed').forEach(item => seedShopMap.set(item.value, item));
    const ownedSeedValues = Object.keys(ownedSeeds).filter(key => seedShopMap.has(key));

    if(ownedSeedValues.length === 0 || Object.values(ownedSeeds).every(v => v === 0)) {
        seedItemsContainer.innerHTML = `<div style="text-align: center; color: var(--text-muted); margin: 20px 0;">Kho h·∫°t gi·ªëng tr·ªëng.</div>`;
    }
    ownedSeedValues.forEach(seedValue => {
        const item = seedShopMap.get(seedValue);
        const ownedAmount = ownedSeeds[seedValue] || 0;
        if(ownedAmount === 0) return;
        
        const itemDiv = document.createElement("div");
        itemDiv.className = "shop-item";
        itemDiv.style.flexDirection = "row"; 
        
        const priceDisplay = `<span style="font-size:1em; color:#795548;">ü´ò</span> ${item.price}`;
        
        itemDiv.innerHTML = `
            <div style="display:flex; align-items:center;">
                <img src="${item.icon}" style="width:50px; height:50px; margin-right:10px;" />
                <div style="text-align:left;">
                    <div style="font-weight:700;">${item.name}</div>
                    <div style="font-size:0.85em; color:var(--text-muted);">ƒêang c√≥: <b>${ownedAmount}</b></div>
                </div>
            </div>
            <div style="text-align:right;">
                <button class="btn-buy" data-id="${item.id}" data-type="seed-shop-internal" style="width:auto; padding:6px 15px;">Mua th√™m</button>
            </div>
        `;
        seedItemsContainer.appendChild(itemDiv);
    });
    document.querySelectorAll(".btn-buy[data-type='seed-shop-internal']").forEach(btn => { btn.addEventListener("click", handleBuy); });
    updateDisplay();
}

// --- LOGIC MUA H√ÄNG ---
function handleBuy(event) {
  const itemId = parseInt(event.target.getAttribute("data-id"));
  const itemType = event.target.getAttribute("data-type");
  let item = null;
  
  if (itemType === "general") item = shopItems.find(i => i.id === itemId);
  if (!item && itemType === "pet-shop-internal") item = petShopItems.find(i => i.id === itemId);
  if (!item && itemType === "seed-shop-internal") {
      item = shopItems.find(i => i.id === itemId && i.type === 'seed');
  }
  
  if (!item) return;
  
  // 1. MUA H·∫†T GI·ªêNG (Gi·ªØ nguy√™n)
  if (item.type === 'seed') {
      const currencyName = item.currency === 'la' ? 'L√°' : 'ƒê·∫≠u';
      let quantityStr = prompt(`B·∫°n mu·ªën mua bao nhi√™u ${item.name}?\n(Gi√°: ${item.price} ${currencyName}/h·∫°t)`, "1");
      
      if (quantityStr === null) return;
      let quantity = parseInt(quantityStr);
      
      if (isNaN(quantity) || quantity <= 0) {
          alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!"); return;
      }
      
      let totalCost = item.price * quantity;
      let userMoney = (item.currency === 'la') ? la : dau;

      if (userMoney >= totalCost) {
          if (confirm(`T·ªïng ti·ªÅn l√† ${totalCost.toLocaleString('vi-VN')} ${currencyName}. B·∫°n ch·∫Øc ch·∫Øn mu·ªën mua ${quantity} h·∫°t ch·ª©?`)) {
              if (item.currency === 'la') la -= totalCost;
              else dau -= totalCost;

              if (ownedSeeds[item.value] !== undefined) ownedSeeds[item.value] += quantity;
              else ownedSeeds[item.value] = quantity;
              
              alert(`ƒê√£ mua th√†nh c√¥ng ${quantity}x ${item.name}!`);
              _saveGame(false);
              updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
          }
      } else {
          alert(`B·∫°n kh√¥ng ƒë·ªß ${currencyName}! C·∫ßn ${totalCost.toLocaleString('vi-VN')} ${currencyName}.`);
      }
      return; 
  }
  
  // 2. KI·ªÇM TRA ƒê√É C√ì PET CH∆ØA
  if (item.type === "pet" && isPetOwned(item.value)) { 
      alert(`${item.name} ƒë√£ ƒë∆∞·ª£c s·ªü h·ªØu!`); return; 
  }

  // 3. LOGIC MUA PET/ITEM KH√ÅC
  let canBuy = false;
  if (item.currency === "dau" && dau >= item.price) { dau -= item.price; canBuy = true; } 
  else if (item.currency === "la" && la >= item.price) { la -= item.price; canBuy = true; }

  if (canBuy) {
    if (item.type === "tool") { 
        tool = item.value; alert(`B·∫°n ƒë√£ trang b·ªã ${item.name}!`); 
    } 
    else if (item.type === "pet") { 
        
        // KI·ªÇM TRA: N·∫øu l√† Pet H·ªô V·ªá (Bi Gai, Thi√™n Th·∫ßn, Th·∫ßn Ch·∫øt)
        if (item.name === "Thi√™n Th·∫ßn" || item.name === "Th·∫ßn Ch·∫øt" || item.name === "Bi Gai") {
             
             // --- [B·∫ÆT ƒê·∫¶U S·ª¨A: CH·∫∂N MUA N·∫æU ƒêANG ·∫§P] ---
             
             // Ki·ªÉm tra bi·∫øn incubationFinishTime. N·∫øu > 0 nghƒ©a l√† ƒëang c√≥ ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c (ƒëang ·∫•p ho·∫∑c n√¢ng c·∫•p)
             if (incubationFinishTime > 0) {
                 
                 // 1. HO√ÄN TI·ªÄN L·∫†I (V√¨ b√™n tr√™n ƒë√£ l·ª° tr·ª´ ti·ªÅn r·ªìi)
                 if (item.currency === "dau") {
                     dau += item.price;
                 } else {
                     la += item.price;
                 }
                 
                 // 2. C·∫≠p nh·∫≠t l·∫°i giao di·ªán ƒë·ªÉ hi·ªÉn th·ªã s·ªë ti·ªÅn ƒë√£ ho√†n
                 updateDisplay();

                 // 3. Th√¥ng b√°o cho ng∆∞·ªùi ch∆°i
                 alert("üö´ ƒêang trong qu√° tr√¨nh ·∫•p tr·ª©ng/n√¢ng c·∫•p!\nVui l√≤ng ƒë·ª£i tr·ª©ng n·ªü xong m·ªõi ƒë∆∞·ª£c mua Pet m·ªõi.");
                 
                 // 4. D·ª´ng h√†m l·∫°i ngay l·∫≠p t·ª©c, kh√¥ng cho ch·∫°y ti·∫øp l·ªánh b√™n d∆∞·ªõi
                 return; 
             }
             // --- [K·∫æT TH√öC S·ª¨A] ---

             // N·∫øu kh√¥ng b·∫≠n ·∫•p tr·ª©ng th√¨ ch·∫°y logic mua b√¨nh th∆∞·ªùng:
             ownedPets.push(item.value);

             // 1. X√°c ƒë·ªãnh lo·∫°i v·ª´a mua
             let newType = 'bi_gai'; // M·∫∑c ƒë·ªãnh
             if (item.name === "Thi√™n Th·∫ßn") newType = 'thien_than';
             if (item.name === "Th·∫ßn Ch·∫øt") newType = 'than_chet';
             
             // 2. G√°n l√†m pet hi·ªán t·∫°i
             hatchedPetType = newType;
             
             // 3. Reset tr·∫°ng th√°i v·ªÅ Tr·ª©ng & ƒêang ·∫§p
             isIceDragonHatched = false; 
             isIceDragonEvolved = false;
             
             // 4. ƒê·∫∑t th·ªùi gian ·∫•p (L·∫•y t·ª´ CONFIG)
             incubationFinishTime = Date.now() + GAME_CONFIG.HATCH_TIME;

             // 5. ƒê√°nh d·∫•u l√† ƒëang c√≥ tr·ª©ng
             hasIceEgg = true;

             alert(`ƒê√£ mua ${item.name}! Qu√° tr√¨nh ·∫•p tr·ª©ng (Slot 1) ƒë√£ b·∫Øt ƒë·∫ßu.`);
             
        } else {
             // TR∆Ø·ªúNG H·ª¢P: Mua Pet th∆∞·ªùng (Ch√≥, M√®o... - Pet ƒëi d·∫°o)
             // Logic n√†y gi·ªØ nguy√™n, kh√¥ng c·∫ßn ch·∫∑n v√¨ Pet ƒëi d·∫°o kh√¥ng ·∫£nh h∆∞·ªüng Slot 1
             ownedPets.push(item.value);
             activePet = item.value;
             alert(`B·∫°n ƒë√£ mua Pet ${item.name}! Pet ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!`);
        }
        
        if(itemType === "general") hidePopup('shop-box');
    }
    else if (item.type === "pot_base") {
        if (ownedPots[item.value] !== undefined) ownedPots[item.value] += 1;
        else ownedPots[item.value] = 1;
        alert(`B·∫°n ƒë√£ mua 1x ${item.name}!`);
    }

    updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
  } else { alert("Kh√¥ng ƒë·ªß ƒê·∫≠u ho·∫∑c L√°!"); }
}

function handleNewGame(){
    showPopup('name-box');
    hidePopup('shop-box');
    hidePopup('online-box');
    hidePopup('pet-house-box'); 
    hidePopup('interaction-popup'); 
    hidePopup('seed-box'); 
}
btnNew.addEventListener('click', handleNewGame);

// --- B∆Ø·ªöC 4: T·∫†O GAME M·ªöI (M·∫∂C ƒê·ªäNH C√ì TR·ª®NG) ---
btnNext.addEventListener('click', () => {
    let inputName = nameInput.value.trim();
    const nameRegex = new RegExp(/^[\p{L}\p{N}]{2,12}$/u); 
    
    if (inputName.length < 2 || inputName.length > 12) {
        alert("T√™n ng∆∞·ªùi ch∆°i ph·∫£i t·ª´ 2 ƒë·∫øn 12 k√Ω t·ª±!"); return;
    }
    if (!nameRegex.test(inputName)) {
        alert("T√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i v√† s·ªë!"); return;
    }
    
    playerName = inputName;
    hidePopup('name-box');
    farmIcon = "üè†"; 
    level = 1; exp = 0; 
    dau = 1000; la = 100; 
    
    activePet = "1000000128.gif"; 
    ownedPets = ["1000000128.gif"]; 

    // === QUAN TR·ªåNG: T·∫∑ng tr·ª©ng m·∫∑c ƒë·ªãnh ===
    hasIceEgg = true; // C√≥ tr·ª©ng ngay l·∫≠p t·ª©c
    // =======================================
    
    isIceDragonHatched = false; isIceDragonEvolved = false; hatchedPetType = "thien_than";
    ownedSeeds = { 'hat_nguyen_to': 1, 'hat_kim_loai': 1, 'hat_tinh_yeu': 1 };
    ownedPots = { 'so_dua': 0, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 }; 
    equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua']; 
    
    lastFedTime = 0; 
    lastBeePokeTime = 0; 
    farmSlots = Array(5).fill(null); 
    globalPetAge = 0;
    vineDecorations = [null, null, null, null, null]; 
    ownedDecorations = { 'chau_chau': 0 };
    ownedArtifacts = { 'manh_nguyen_to': 10000, 'manh_kim_loai': 10000, 'vuong_mien': 10000 };
    grasshopperExchanged = 0;  
    usedGiftcodes = [];        

    checkBeeHiveSpawn();      
    updateGiftcodeBoxState(); 
    updateDisplay(); 
    updateControlButtons();
    
    alert(`Ch√†o m·ª´ng ${playerName}!\nB·∫°n nh·∫≠n ƒë∆∞·ª£c 01 TR·ª®NG NG≈® S·∫ÆC mi·ªÖn ph√≠ ·ªü Slot 1.`);
});

function loadGame(){
    const savedGame = localStorage.getItem('farmLolGame');
    if(savedGame){
        const gameData = JSON.parse(savedGame);
        
        // 1. T·∫£i c√°c ch·ªâ s·ªë c∆° b·∫£n
        playerName = gameData.playerName; 
        farmIcon = gameData.farmIcon; 
        level = gameData.level; 
        exp = gameData.exp;
        dau = gameData.dau !== undefined ? gameData.dau : (gameData.xu !== undefined ? gameData.xu : 0);
        la = gameData.la !== undefined ? gameData.la : (gameData.usd !== undefined ? gameData.usd : 0);
        
        // 2. T·∫£i c√¥ng c·ª• & √î ƒë·∫•t
        tool = gameData.tool;
        farmSlots = gameData.farmSlots ? (Array.isArray(gameData.farmSlots) ? gameData.farmSlots : Array(5).fill(null)) : Array(5).fill(null);
        if (farmSlots.length < 5) { while(farmSlots.length < 5) farmSlots.push(null); }
        
        // 3. T·∫£i Pet & Tr·∫°ng th√°i Tr·ª©ng
        activePet = gameData.activePet || null; 
        ownedPets = gameData.ownedPets || []; 
        hasIceEgg = gameData.hasIceEgg || false; 
        isIceDragonHatched = gameData.isIceDragonHatched || false; 
        isIceDragonEvolved = gameData.isIceDragonEvolved || false;
        hatchedPetType = gameData.hatchedPetType || "thien_than"; 
        incubationFinishTime = gameData.incubationFinishTime || 0; 
        
        // --- [M·ªöI] T·∫¢I C·∫§P ƒê·ªò RI√äNG CHO T·ª™NG PET ---
        if (gameData.petLevels) {
            petLevels = gameData.petLevels;
        } else {
            // N·∫øu file save c≈© ch∆∞a c√≥, t·∫°o m·ªõi v√† chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu c≈©
            petLevels = { 'thien_than': 1, 'than_chet': 1 };
            // N·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ c√≥ c·∫•p ƒë·ªô, g√°n n√≥ cho con pet hi·ªán t·∫°i
            if (gameData.petStarLevel) {
                petLevels[hatchedPetType] = gameData.petStarLevel;
            }
        }
        // C·∫≠p nh·∫≠t bi·∫øn hi·ªÉn th·ªã hi·ªán t·∫°i theo con pet ƒëang ch·ªçn
        petStarLevel = petLevels[hatchedPetType] || 1;
        // ------------------------------------------

        // 4. T·∫£i H·∫°t gi·ªëng
        const savedSeeds = gameData.ownedSeeds || {};
        ownedSeeds = Object.assign({}, savedSeeds); 
        
        if(ownedSeeds['hat_nguyen_to'] === undefined) ownedSeeds['hat_nguyen_to'] = 0;
        if(ownedSeeds['hat_kim_loai'] === undefined) ownedSeeds['hat_kim_loai'] = 0;
        if(ownedSeeds['hat_tinh_yeu'] === undefined) ownedSeeds['hat_tinh_yeu'] = 0;

        // 5. T·∫£i Ch·∫≠u & ƒê·ªì r√®n
        ownedPots = Object.assign({ 'so_dua': 5, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 }, gameData.ownedPots || {});
        craftingQueue = gameData.craftingQueue || [];
        equippedPots = gameData.equippedPots || ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua'];
        
        farmSlots.forEach((slot, idx) => { if(slot && slot.potType) { equippedPots[idx] = slot.potType; } });
        
        // 6. T·∫£i c√°c ch·ªâ s·ªë ph·ª• & Trang tr√≠ & Kho ƒë·ªì
        lastFedTime = gameData.lastFedTime || 0;
        lastBeePokeTime = gameData.lastBeePokeTime || 0;

        // ƒê·∫£m b·∫£o kho ch·ª©a c√≥ Nh·ªông Ong
        if (typeof ownedArtifacts === 'undefined') ownedArtifacts = {};
        
        globalPetAge = gameData.globalPetAge || 0;
        
        vineDecorations = gameData.vineDecorations || [null, null, null, null, null];
        ownedDecorations = gameData.ownedDecorations || { 'chau_chau': 0 };
        
        // T·∫£i kho v·∫≠t ph·∫©m ƒë·∫∑c bi·ªát
        ownedArtifacts = Object.assign({ 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0, 'nhong_ong': 0 }, gameData.ownedArtifacts || {});
        
        grasshopperExchanged = gameData.grasshopperExchanged || 0;
        usedGiftcodes = gameData.usedGiftcodes || [];
    }
}

function _saveGame(showAlert = false){
    // L∆∞u c·∫•p ƒë·ªô hi·ªán t·∫°i v√†o object tr∆∞·ªõc khi save
    petLevels[hatchedPetType] = petStarLevel;

    const gameData = { 
        playerName, farmIcon, level, exp, dau, la, tool, farmSlots, 
        activePet, ownedPets, hasIceEgg, isIceDragonHatched, isIceDragonEvolved, 
        hatchedPetType, 
        ownedSeeds, lastFedTime, globalPetAge, lastBeePokeTime, 
        petStarLevel, // V·∫´n l∆∞u ƒë·ªÉ t∆∞∆°ng th√≠ch ng∆∞·ª£c
        petLevels,    // <-- QUAN TR·ªåNG: L∆∞u bi·∫øn n√†y
        ownedPots, craftingQueue, equippedPots,
        incubationFinishTime, vineDecorations, ownedDecorations, ownedArtifacts,
        grasshopperExchanged,
        usedGiftcodes
    };
    localStorage.setItem('farmLolGame', JSON.stringify(gameData));
    if(showAlert) alert("ƒê√£ l∆∞u tr√≤ ch∆°i!");
}
function saveGame(){ _saveGame(true); }
btnSave.addEventListener('click', saveGame);
function autoSave() { if (level > 0) { _saveGame(false); } }

function deleteGame(){
    if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a n√¥ng tr·∫°i hi·ªán t·∫°i?")){
        localStorage.removeItem('farmLolGame');
        
        // 1. Reset c√°c ch·ªâ s·ªë c∆° b·∫£n
        playerName = "N√¥ng d√¢n"; farmIcon = "üåæ"; level = 0; exp = 0; 
        dau = 0; la = 0; 
        
        // 2. Reset c√¢y tr·ªìng v√† pet
        farmSlots = Array(5).fill(null); 
        activePet = null; ownedPets = []; 
        hasIceEgg = false; 
        isIceDragonHatched = false; 
        isIceDragonEvolved = false; 
        hatchedPetType = "thien_than";
        incubationFinishTime = 0;
        
        // 3. Reset kho v√† ch·∫≠u
        ownedSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0, 'hat_tinh_yeu': 0 };
        ownedPots = { 'so_dua': 0, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 };
        equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua'];
        
        // 4. RESET H√ÄNG CH·ªú R√àN V·ªÄ R·ªñNG
        craftingQueue = []; 
        
        // 5. Reset c√°c bi·∫øn ph·ª• kh√°c
        lastFedTime = 0; globalPetAge = 0;
        petStarLevel = 1;
        vineDecorations = [null, null, null, null, null];
        ownedDecorations = { 'chau_chau': 0 };
        ownedArtifacts = { 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0 }; 
        grasshopperExchanged = 0;  
        usedGiftcodes = [];        

        // X√≥a qu·∫£ ƒë√†o (n·∫øu ƒëang hi·ªán)
        const rewardIcon = document.getElementById('daily-reward-icon');
        if(rewardIcon) rewardIcon.remove();

        // 6. C·∫≠p nh·∫≠t giao di·ªán
        checkBeeHiveSpawn();      
        updateGiftcodeBoxState(); 
        updateDisplay(); 
        updateControlButtons();
        
        // üî• QUAN TR·ªåNG: G·ªçi h√†m n√†y ƒë·ªÉ ƒë·ªïi ·∫£nh Th·ª£ R√®n v·ªÅ tr·∫°ng th√°i tƒ©nh NGAY L·∫¨P T·ª®C üî•
        updateBlacksmithVisuals(); 

        alert("ƒê√£ x√≥a n√¥ng tr·∫°i!");
    }
}
btnDelete.addEventListener('click', deleteGame);

const kintoCloud = document.getElementById("kinto-cloud");
if (kintoCloud) {
    kintoCloud.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showShopPopup();
    });
}
if (lightBulb) {
    lightBulb.addEventListener("click", () => {
        body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', body.classList.contains('dark-mode'));
    });
}

function closeInteractionPopup() {
    if (activePopupInterval) { clearInterval(activePopupInterval); activePopupInterval = null; }
    if (window.feedInterval) { clearInterval(window.feedInterval); window.feedInterval = null; }
    hidePopup('interaction-popup');
    const iText = document.getElementById('interaction-text');
    const iControls = document.getElementById('interaction-controls');
    if(iText) { iText.style.display = 'block'; iText.innerHTML = ''; }
    if(iControls) { iControls.innerHTML = ''; }
}

// --- H√ÄM X·ª¨ L√ù ·∫§P TR·ª®NG M·ªöI (C√ì H·∫∏N GI·ªú 24H) ---
function handleIceDragonInteraction(action, selectedType = 'thien_than') {
    // L·∫•y th·ªùi gian t·ª´ Config
    const HATCH_DURATION = GAME_CONFIG.HATCH_TIME;

    // --- S·ª¨A ·ªû ƒê√ÇY: Logic t√™n hi·ªÉn th·ªã ---
    let petName = "Bi Gai";
    if (selectedType === 'than_chet') petName = "Th·∫ßn Ch·∫øt";
    else if (selectedType === 'thien_than') petName = "Thi√™n Th·∫ßn";
    // ------------------------------------

    if (action === 'hatch') {
        if (confirm(`Qu√° tr√¨nh ·∫•p ${petName} s·∫Ω m·∫•t 24 gi·ªù.\nB·∫°n ch·∫Øc ch·∫Øn ch·ª©?`)) {
            // 1. L∆∞u lo·∫°i pet ƒëang ·∫•p
            hatchedPetType = selectedType;

            // 2. T√≠nh th·ªùi gian xong
            incubationFinishTime = Date.now() + HATCH_DURATION;

            // 3. ƒê√°nh d·∫•u s·ªü h·ªØu ngay
            // --- S·ª¨A ·ªû ƒê√ÇY: Th√™m value ·∫£nh Bi Gai ---
            let petValue = "1000000149.gif"; 
            if(selectedType === 'than_chet') petValue = "1000000104.gif";
            else if(selectedType === 'thien_than') petValue = "1000000127.gif";
            // ----------------------------------------
            
            if (!ownedPets.includes(petValue)) {
                ownedPets.push(petValue);
            }

            // 4. ƒê√≥ng popup & L∆∞u
            interactionControls.innerHTML = '';
            closeInteractionPopup();
            
            if(typeof showToast === 'function') {
                showToast(`ƒêang ·∫•p ${petName}...`, "ü•ö");
            } else {
                alert(`ƒê√£ b·∫Øt ƒë·∫ßu ·∫•p tr·ª©ng! Quay l·∫°i sau 24 gi·ªù nh√©.`);
            }

            updateDisplay();
            updatePetShop(); 
            saveGame(); 
        }
    }
}

let currentSeedTab = 'seeds';
function showSeedSelectionPopup(slotNum, slotIndex) {
    interactionTitle.innerHTML = `üì¶ Kho ƒê·ªì`; 
    interactionText.style.display = 'none'; 
    interactionControls.innerHTML = '';

    const tabs = document.createElement('div');
    tabs.className = 'tab-container';
    tabs.innerHTML = `
        <button class="tab-btn ${currentSeedTab==='seeds'?'active':''}" onclick="switchTab('seeds', ${slotNum}, ${slotIndex})">üå± H·∫°t Gi·ªëng</button>
        <button class="tab-btn ${currentSeedTab==='pots'?'active':''}" onclick="switchTab('pots', ${slotNum}, ${slotIndex})">üè∫ Ch·∫≠u</button>
    `;
    interactionControls.appendChild(tabs);

    const contentContainer = document.createElement('div');
    contentContainer.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 250px; overflow-y: auto; padding: 5px;';
    interactionControls.appendChild(contentContainer);

    if (currentSeedTab === 'seeds') {
        renderSeedList(contentContainer, slotNum, slotIndex);
    } else {
        renderPotList(contentContainer, slotNum, slotIndex);
    }

    showPopup('interaction-popup');
}

function switchTab(tabName, slotNum, slotIndex) {
    currentSeedTab = tabName;
    showSeedSelectionPopup(slotNum, slotIndex);
}

// --- 3. C·∫¨P NH·∫¨T RENDER POT LIST (C√ì B√ÅN S·ªå D·ª™A) ---
function renderPotList(container, slotNum, slotIndex) {
    let hasItem = false;
    const currentSlotPot = equippedPots[slotIndex] || 'so_dua';

    Object.keys(ownedPots).forEach(potKey => {
        const amount = ownedPots[potKey] || 0;
        const potDef = POT_DEFINITIONS[potKey];
        // S·ª¨A: Ki·ªÉm tra n·∫øu ƒëang d√πng th√¨ v·∫´n hi·ªán ra d√π kho = 0
        const isEquipped = (currentSlotPot === potKey);

        // ƒêI·ªÄU KI·ªÜN M·ªöI: (C√≥ trong kho HO·∫∂C ƒêang d√πng) V√Ä (D·ªØ li·ªáu h·ª£p l·ªá)
        if ((amount > 0 || isEquipped) && potDef) {
            hasItem = true;
            const card = document.createElement('div');
            card.className = "shop-item";

            // Hi·ªÉn th·ªã d√≤ng Bonus Exp
            let bonusText = "";
            if (potDef.expBonus > 0) {
                bonusText = `<div style="color:#4CAF50; font-size:0.8em; font-weight:bold;">+${potDef.expBonus} Exp/l·∫ßn</div>`;
            }

            let htmlContent = `
                <img src="${potDef.img}" style="width: 40px; height: 40px; object-fit: contain;">
                <div style="font-weight: bold; font-size: 0.9em; margin-top:5px;">${potDef.name}</div>
                ${bonusText}
                <div style="color: var(--text-muted); font-size: 0.8em; margin:3px 0 5px 0;">C√≥: ${amount}</div>
            `;

            // N√∫t b·∫•m: N·∫øu ƒëang d√πng th√¨ hi·ªán m√†u X√°m, ch∆∞a d√πng th√¨ m√†u Xanh
            const btnEquipHTML = `
                <button class="btn-equip-pot" style="background:${isEquipped ? 'grey' : '#2196F3'}; border-radius:6px; cursor:${isEquipped ? 'default' : 'pointer'}; width: 100%;">
                    ${isEquipped ? 'ƒêang d√πng' : 'Thay Ch·∫≠u'}
                </button>
            `;

            // N·∫øu l√† S·ªç D·ª´a -> Th√™m n√∫t B√°n
            if (potKey === 'so_dua') {
                htmlContent += `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%; margin-top:5px;">
                        ${btnEquipHTML}
                        <button class="btn-sell-pot" style="width:100%; border:none; border-radius:6px; padding:6px; font-weight:700; font-size:11px; color:white; cursor:pointer; background:#FF5722; box-shadow: 0 2px 0 #E64A19;">üí∞ B√°n</button>
                    </div>
                `;
            } else {
                htmlContent += `<div style="width:100%; margin-top:5px;">${btnEquipHTML}</div>`;
            }

            card.innerHTML = htmlContent;

            // --- S·ª∞ KI·ªÜN: THAY CH·∫¨U ---
            const btnEquip = card.querySelector('.btn-equip-pot');
            if (btnEquip) {
                btnEquip.onclick = () => {
                    if (isEquipped) return; // ƒêang d√πng th√¨ kh√¥ng l√†m g√¨
                    if (farmSlots[slotIndex]) {
                        alert("H√£y thu ho·∫°ch c√¢y tr∆∞·ªõc!");
                        return;
                    }

                    const oldPot = currentSlotPot;
                    const newPot = potKey;

                    // Ki·ªÉm tra k·ªπ l·∫°i xem kho c√≤n h√†ng ƒë·ªÉ thay kh√¥ng
                    if (ownedPots[newPot] > 0) {
                        ownedPots[newPot]--; // Tr·ª´ c√°i m·ªõi
                        ownedPots[oldPot] = (ownedPots[oldPot] || 0) + 1; // Tr·∫£ c√°i c≈© v·ªÅ kho
                        equippedPots[slotIndex] = newPot; // G√°n v√†o √¥ ƒë·∫•t

                        alert(`ƒê√£ thay sang ${potDef.name} (Bonus +${potDef.expBonus} Exp)!`);
                        updateDisplay();
                        closeInteractionPopup();
                    } else {
                        alert("L·ªói: Kh√¥ng t√¨m th·∫•y ch·∫≠u n√†y trong kho!");
                    }
                };
            }

            // --- S·ª∞ KI·ªÜN: B√ÅN S·ªå D·ª™A ---
            const btnSell = card.querySelector('.btn-sell-pot');
            if (btnSell && potKey === 'so_dua') {
                btnSell.onclick = () => {
                    // Ch·ªâ b√°n s·ªë l∆∞·ª£ng ƒëang R·∫¢NH (kh√¥ng t√≠nh c√°i ƒëang tr·ªìng)
                    const sellableAmount = amount;

                    if (sellableAmount <= 0) {
                        alert(`B·∫°n kh√¥ng c√≤n S·ªç D·ª´a d∆∞ n√†o trong kho ƒë·ªÉ b√°n!\n(C√°c ch·∫≠u ƒëang tr·ªìng c√¢y kh√¥ng th·ªÉ b√°n).`);
                        return;
                    }

                    const sellPrice = 500;
                    let sellQtyStr = prompt(`Gi√° b√°n l·∫°i: ${sellPrice.toLocaleString()} ƒê·∫≠u/ch·∫≠u.\nTrong kho ƒëang c√≥: ${sellableAmount} c√°i.\nNh·∫≠p s·ªë l∆∞·ª£ng mu·ªën b√°n:`, "1");

                    if (sellQtyStr === null) return;
                    let sellQty = parseInt(sellQtyStr);

                    if (!Number.isInteger(sellQty) || sellQty <= 0) {
                        alert("Vui l√≤ng nh·∫≠p s·ªë nguy√™n d∆∞∆°ng h·ª£p l·ªá!");
                        return;
                    }
                    if (sellQty > sellableAmount) {
                        alert(`B·∫°n ch·ªâ c√≥ ${sellableAmount} c√°i trong kho!`);
                        return;
                    }

                    const totalValue = sellQty * sellPrice;
                    if (confirm(`B√°n ${sellQty}x S·ªç D·ª´a ƒë·ªÉ nh·∫≠n ${totalValue.toLocaleString()} ƒê·∫≠u?`)) {
                        ownedPots['so_dua'] -= sellQty;
                        dau += totalValue;
                        alert(`ƒê√£ b√°n th√†nh c√¥ng! Nh·∫≠n ƒë∆∞·ª£c ${totalValue.toLocaleString()} ƒê·∫≠u.`);

                        updateDisplay();
                        // Render l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ngay l·∫≠p t·ª©c
                        container.innerHTML = "";
                        renderPotList(container, slotNum, slotIndex);
                    }
                };
            }

            container.appendChild(card);
        }
    });

    // Th√¥ng b√°o cu·ªëi danh s√°ch
    if (farmSlots[slotIndex]) {
        container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding:10px; color:#ef5350; font-weight:bold;">‚ö†Ô∏è Thu ho·∫°ch c√¢y tr∆∞·ªõc khi thay ch·∫≠u!</div>` + container.innerHTML;
    } else if (!hasItem) {
        container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding:10px; color:var(--text-muted);">Kh√¥ng c√≥ ch·∫≠u n√†o kh√°c!</div>`;
    }
}

function renderSeedList(container, slotNum, slotIndex) {
    const seedMap = new Map();
    // L·∫•y th√¥ng tin h·∫°t gi·ªëng t·ª´ shopItems ƒë·ªÉ bi·∫øt gi√°
    shopItems.filter(item => item.type === 'seed').forEach(item => seedMap.set(item.value, item));
    let seedFound = false;
    
    seedMap.forEach((seedData, seedValue) => {
        const amount = ownedSeeds[seedValue] || 0;
        
        // Ch·ªâ hi·ªán n·∫øu c√≥ s·ªë l∆∞·ª£ng > 0 v√† d·ªØ li·ªáu h·ª£p l·ªá
        if (amount > 0 && seedData) {
            seedFound = true;
            const card = document.createElement('div');
            card.className = "shop-item";
            
            // C·∫≠p nh·∫≠t HTML: Th√™m n√∫t B√°n b√™n c·∫°nh n√∫t Tr·ªìng
            card.innerHTML = `
                <img src="${seedData.icon}" style="width: 40px; height: 40px; object-fit: contain;" />
                <div style="font-size: 0.85em; font-weight: 700; margin:5px 0;">${seedData.name}</div>
                <div style="font-size: 0.75em; color: var(--text-muted);">SL: <b>${amount}</b></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%; margin-top:5px;">
                    <button class="btn-plant-now" style="width:100%; margin-top:0;">üå± Tr·ªìng</button>
                    <button class="btn-sell-seed" style="
                        width:100%; border:none; border-radius:8px; 
                        padding:6px; font-weight:700; font-size:11px; 
                        color:white; cursor:pointer; 
                        background:#FF5722; box-shadow: 0 2px 0 #E64A19;
                        transition: all 0.1s;
                    ">üí∞ B√°n</button>
                </div>
            `;
            
            // --- Logic N√∫t Tr·ªìng ---
            card.querySelector('.btn-plant-now').onclick = () => {
                ownedSeeds[seedValue] -= 1;
                const currentPot = equippedPots[slotIndex] || 'so_dua';
                farmSlots[slotIndex] = { 
                    name: seedData.name, icon: PLANT_STAGES[0].icon, value: seedValue, 
                    stage: 0, plantedAt: Date.now(), potType: currentPot 
                };
                updateDisplay(); updateSeedShop(); closeInteractionPopup();
            };

            // --- Logic N√∫t B√°n (M·ªöI) ---
card.querySelector('.btn-sell-seed').onclick = () => {
    // H·ªèi ng∆∞·ªùi ch∆°i s·ªë l∆∞·ª£ng mu·ªën b√°n
    let sellQtyStr = prompt(`Gi√° b√°n l·∫°i: ${seedData.price} ƒê·∫≠u/h·∫°t.\nB·∫°n mu·ªën b√°n bao nhi√™u ${seedData.name}?`, "1");
    if (sellQtyStr === null) return; // Ng∆∞·ªùi ch∆°i ·∫•n H·ªßy

    // --- B·∫ÆT ƒê·∫¶U ƒêO·∫†N V·ª™A S·ª¨A ---
    let sellQty = Number(sellQtyStr);
    
    // Ki·ªÉm tra t√≠nh h·ª£p l·ªá ch·∫∑t ch·∫Ω
    if (!Number.isInteger(sellQty) || sellQty <= 0) {
        alert("Vui l√≤ng nh·∫≠p s·ªë nguy√™n d∆∞∆°ng h·ª£p l·ªá (Kh√¥ng nh·∫≠p s·ªë √¢m ho·∫∑c s·ªë th·∫≠p ph√¢n)!");
        return;
    }

    if (sellQty > amount) {
        alert(`B·∫°n ch·ªâ c√≥ ${amount} h·∫°t, kh√¥ng th·ªÉ b√°n ${sellQty}!`);
        return;
    }

    // Th·ª±c hi·ªán giao d·ªãch
    const totalValue = sellQty * seedData.price;
    
    if(confirm(`B√°n ${sellQty}x ${seedData.name} ƒë·ªÉ nh·∫≠n ${totalValue.toLocaleString()} ƒê·∫≠u?`)) {
        ownedSeeds[seedValue] -= sellQty;
        dau += totalValue;
        
        alert(`ƒê√£ b√°n th√†nh c√¥ng! Nh·∫≠n ƒë∆∞·ª£c ${totalValue.toLocaleString()} ƒê·∫≠u.`);
        
        // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
        updateDisplay();
        updateSeedShop();
        
        // Render l·∫°i danh s√°ch n√†y ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
        container.innerHTML = ""; 
        renderSeedList(container, slotNum, slotIndex);
    }
};

            container.appendChild(card);
        }
    });

    if (!seedFound) {
         container.innerHTML = `<div style="grid-column: span 2; text-align: center; margin: 15px 0; color: #666;">H·∫øt h·∫°t gi·ªëng.</div>`;
    }
}
// --- H√ÄM T·∫†O HI·ªÜU ·ª®NG BAY ---
function spawnFloatingReward(slotId, htmlContent, delay = 0, typeClass = "float-exp") {
    // 1. T√¨m v·ªã tr√≠ c·ªßa √¥ ƒë·∫•t (slot) trong giao di·ªán
    const slotEl = document.getElementById(`slot-${slotId}`);
    if (!slotEl) return;

    // 2. T·∫°o ph·∫ßn t·ª≠ bay
    setTimeout(() => {
        const floater = document.createElement("div");
        floater.className = `floating-reward ${typeClass}`;
        floater.innerHTML = htmlContent;

        // 3. L·∫•y v·ªã tr√≠ top/left hi·ªán t·∫°i c·ªßa slot ƒë·ªÉ ƒë·∫∑t floater
        // V√¨ slot n·∫±m trong .app-wrapper (relative), ta l·∫•y style top/left c·ªßa n√≥
        // C·ªông th√™m m·ªôt ch√∫t offset ƒë·ªÉ n√≥ xu·∫•t hi·ªán gi·ªØa √¥
        const currentTop = parseInt(slotEl.style.top || 0);
        const currentLeft = parseInt(slotEl.style.left || 0) || (slotEl.offsetLeft); // Fallback n·∫øu style left l√† calc

        // L∆∞u √Ω: Do d√πng calc() trong CSS, l·∫•y offsetLeft/Top t·ª´ DOM chu·∫©n h∆°n
        floater.style.top = (slotEl.offsetTop - 20) + "px"; 
        floater.style.left = (slotEl.offsetLeft + 10) + "px";

        // Th√™m ng·∫´u nhi√™n v·ªã tr√≠ X m·ªôt ch√∫t ƒë·ªÉ kh√¥ng b·ªã ch·ªìng ch√©o n·∫øu r·ªõt nhi·ªÅu m√≥n
        const randomX = Math.floor(Math.random() * 20) - 10; 
        floater.style.left = (slotEl.offsetLeft + 10 + randomX) + "px";

        // 4. G·∫Øn v√†o main (n∆°i ch·ª©a c√°c slot)
        document.querySelector("main").appendChild(floater);

        // 5. T·ª± x√≥a sau khi animation k·∫øt th√∫c (1.2s)
        setTimeout(() => { floater.remove(); }, 1200);

    }, delay);
}
function updateFarmState() {
    const now = Date.now();
    let changed = false; 

    // --- LOGIC COMBO M·ªöI: KI·ªÇM TRA ƒê·ª¶ 5 M√ìN ---
    // H√†m .every() s·∫Ω tr·∫£ v·ªÅ true n·∫øu t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ trong m·∫£ng vineDecorations ƒë·ªÅu kh√°c null (t·ª©c l√† ƒë√£ treo ƒë·ªì)
    const isFullSet = vineDecorations.every(item => item !== null);

    // N·∫øu ƒë·ªß 5 m√≥n b·∫•t k·ª≥: Gi·∫£m 2 gi·ªù (7200000 ms)
    // N·∫øu ch∆∞a ƒë·ªß: Gi·∫£m 1 gi·ªù (3600000 ms) nh∆∞ c≈©
    const reductionAmount = isFullSet ? 7200000 : 3600000;
    
    // N·∫øu mu·ªën hi·ªán th√¥ng b√°o Combo (tu·ª≥ ch·ªçn, m·ªü console ƒë·ªÉ xem)
    // if(isFullSet) console.log("Combo k√≠ch ho·∫°t: Gi·∫£m 2h!");
    // ------------------------------------------

    farmSlots.forEach((slotData, index) => {
        if (slotData && slotData.stage < PLANT_STAGES.length - 1) { 
            const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
            
            let requiredDuration = nextStageInfo.duration;
            
            // Danh s√°ch c√°c v·∫≠t ph·∫©m h·ªó tr·ª£ gi·∫£m th·ªùi gian
            const fastGrowthItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];

            // Ki·ªÉm tra xem v·ªã tr√≠ n√†y c√≥ treo v·∫≠t ph·∫©m n·∫±m trong danh s√°ch tr√™n kh√¥ng
            if (fastGrowthItems.includes(vineDecorations[index])) {
                // √ÅP D·ª§NG TH·ªúI GIAN GI·∫¢M ƒê√É T√çNH ·ªû TR√äN
                requiredDuration -= reductionAmount; 
                
                if (requiredDuration < 0) requiredDuration = 0; // Kh√¥ng ƒë·ªÉ th·ªùi gian √¢m
            }

            if (now >= slotData.plantedAt + requiredDuration) { 
                slotData.stage += 1; 
                changed = true; 
            }
        }
    });
    if (changed) updateDisplay();
}

function getCountdownTimePlant(timeToNext) {
    if (timeToNext <= 0) return "0s";
    
    // Logic t√≠nh to√°n gi·ªëng h·ªát Th·ª£ R√®n (renderCraftingQueue)
    let seconds = Math.floor((timeToNext / 1000) % 60);
    let minutes = Math.floor((timeToNext / (1000 * 60)) % 60);
    let hours = Math.floor((timeToNext / (1000 * 60 * 60)));
    
    let timeString = "";
    if(hours > 0) timeString += `${hours}h `;
    if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
    timeString += `${seconds}s`;
    
    return timeString;
}

const potSlots = document.querySelectorAll(".pot-slot");
potSlots.forEach(slot => {
    slot.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        
        // --- S·ª¨A L·ªñI T·∫†I ƒê√ÇY: B·ªè qua Slot 6 (C√¢u c√°) ---
        // V√¨ Slot 6 ƒë√£ c√≥ s·ª± ki·ªán onclick ri√™ng trong HTML r·ªìi
        const slotNum = slot.getAttribute('data-slot');
        if (slotNum === "6") return; 
        // ------------------------------------------------

        // --- S·ª¨A L·ªñI: Lu√¥n hi·ªÉn th·ªã khung text tr∆∞·ªõc ---
        interactionText.style.display = 'block';
        interactionControls.innerHTML = ''; // Reset n√∫t b·∫•m
        if (activePopupInterval) clearInterval(activePopupInterval);

        const slotNumInt = parseInt(slotNum);

        const renderSlotStatus = () => {
            // ƒê·∫£m b·∫£o x√≥a n√∫t c≈© m·ªói l·∫ßn render l·∫°i
            interactionControls.innerHTML = '';
            
        if (slotNum === "1") {
            // --- TR∆Ø·ªúNG H·ª¢P 1: ƒêANG C√ì TH·ªúI GIAN CH·ªú (·∫§p ho·∫∑c N√¢ng c·∫•p) ---
            if (incubationFinishTime > 0) {
                // S·ª¨A: Logic x√°c ƒë·ªãnh ƒëang l√†m g√¨
                // N·∫øu ƒëang c√≥ tr·ª©ng (hasIceEgg) -> Ch·∫Øc ch·∫Øn l√† ƒëang ·∫§p M·ªõi
                // N·∫øu kh√¥ng c√≥ tr·ª©ng m√† c√≥ gi·ªù -> L√† ƒëang N√¢ng C·∫•p
                let isHatchingNew = hasIceEgg; 
                let actionText = isHatchingNew ? "ƒêang ·∫§p N·ªü" : "ƒêang N√¢ng C·∫•p";
                
                // X√°c ƒë·ªãnh Level m·ª•c ti√™u ƒë·ªÉ hi·ªÉn th·ªã
                let currentLv = petLevels[hatchedPetType] || 1;
                // N·∫øu ·∫•p m·ªõi -> M·ª•c ti√™u l√† 1. N·∫øu n√¢ng c·∫•p -> M·ª•c ti√™u l√† C·∫•p hi·ªán t·∫°i + 1
                let targetLevel = isHatchingNew ? 1 : (currentLv + 1);

                interactionTitle.innerHTML = `‚è≥ ${actionText}`;

                const updateTimer = () => {
                    const now = Date.now();
                    const timeLeft = incubationFinishTime - now;

                    if (timeLeft <= 0) {
                        interactionText.innerHTML = "ƒêang ho√†n t·∫•t qu√° tr√¨nh...";
                        return;
                    }

                    let seconds = Math.floor((timeLeft / 1000) % 60);
                    let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
                    let hours = Math.floor((timeLeft / (1000 * 60 * 60)));
                    let timeString = "";
                    if (hours > 0) timeString += `${hours}h `;
                    if (minutes > 0 || hours > 0) timeString += `${minutes}m `;
                    timeString += `${seconds}s`;

                    const starConfig = {
                        1: { color: '#9E9E9E', stars: '‚≠ê' },
                        2: { color: '#4CAF50', stars: '‚≠ê‚≠ê' },
                        3: { color: '#2196F3', stars: '‚≠ê‚≠ê‚≠ê' },
                        4: { color: '#9C27B0', stars: '‚≠ê‚≠ê‚≠ê‚≠ê' },
                        5: { color: '#FF6F00', stars: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê' }
                    };
                    const style = starConfig[targetLevel] || starConfig[1];
// --- S·ª¨A LOGIC T√äN HI·ªÇN TH·ªä KHI ·∫§P ---
let petName = "üëº Thi√™n Th·∫ßn"; // M·∫∑c ƒë·ªãnh
if (hatchedPetType === 'than_chet') petName = "üíÄ Th·∫ßn Ch·∫øt";
if (hatchedPetType === 'bi_gai') petName = "üü¢ Bi Gai"; // Th√™m d√≤ng n√†y v√†o
// -------------------------------------

                    interactionText.innerHTML = `
                        <div style="text-align:center;">
                            <div style="font-size:0.85em; font-weight:bold; color:#795548; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                                ${actionText}
                            </div>
                            <img src="1000000102.png" style="width:80px; display:block; margin: 0 auto 10px auto; filter: drop-shadow(0 0 5px ${style.color});">
                            <div style="font-size:1.3em; font-weight:900; color:${style.color}; margin-bottom:4px; text-shadow: 1px 1px 0 #fff;">
                                ${petName}
                            </div>
                            <div style="
                                font-size: 1.1em; color: ${style.color}; font-weight: bold; margin-bottom: 15px; 
                                display: inline-block; padding: 5px 15px; border: 2px solid ${style.color};
                                border-radius: 20px; background: rgba(255,255,255,0.8);
                            ">
                                M·ª•c ti√™u: ${style.stars}
                            </div>
                            <div style="font-size:0.9em; color: #555; font-style: italic;">ƒêang h·∫•p th·ª• linh kh√≠...</div>
                            <div style="margin-top:10px; font-size:1.4em; color:#E65100; font-weight:900; background:#FFF3E0; padding:10px; border-radius:10px; border: 1px dashed #FF9800;">
                                ${timeString}
                            </div>
                        </div>`;
                };

                updateTimer();
                if (activePopupInterval) clearInterval(activePopupInterval);
                activePopupInterval = setInterval(updateTimer, 1000);
            }
            
            // --- TR∆Ø·ªúNG H·ª¢P 2: ƒê√É C√ì PET (HI·ªÜN TH·ªä TH√îNG TIN & ƒê·ªîI PET & ·∫§P M·ªöI) ---
else if (isIceDragonHatched) {
                petStarLevel = petLevels[hatchedPetType] || 1;

                const starConfig = {
                    1: { color: '#757575', colorName: 'X√°m' },
                    2: { color: '#4CAF50', colorName: 'Xanh L√°' },
                    3: { color: '#2196F3', colorName: 'Xanh D∆∞∆°ng' },
                    4: { color: '#9C27B0', colorName: 'T√≠m' },
                    5: { color: '#FF6F00', colorName: 'Cam' }
                };
                const currentConfig = starConfig[petStarLevel] || starConfig[1];
                
                // --- S·ª¨A ·ªû ƒê√ÇY: Logic hi·ªÉn th·ªã t√™n chu·∫©n ---
                let baseName = "Thi√™n Th·∫ßn"; 
                if (hatchedPetType === 'than_chet') baseName = "Th·∫ßn Ch·∫øt";
                if (hatchedPetType === 'bi_gai') baseName = "Bi Gai"; 
                // ------------------------------------------
                
                let starsStr = "";
                for(let i=0; i<petStarLevel; i++) starsStr += "‚≠ê";

                interactionTitle.innerHTML = `
                    <span style="color:${currentConfig.color}; font-weight:900; font-size:1.1em; text-shadow: 1px 1px 0 #fff; display:block; margin-bottom:5px;">
                        ${baseName}
                    </span>
                    <span style="font-size:0.8em; color:#555;">${starsStr}</span>
                `;
                
                interactionText.innerHTML = `<div style="margin-bottom:15px; font-size:0.9em; color:#555; background:#f5f5f5; padding:8px; border-radius:8px;">
                    ‚ö° <b>Hi·ªáu ·ª©ng:</b> Auto Thu ho·∫°ch (C·∫•p ${petStarLevel})
                </div>`;

                if (petStarLevel < 5) {
                    const nextLevel = petStarLevel + 1;
                    const costManh = nextLevel * 100;
                    const costLa = nextLevel * 10;
                    const currentManh = ownedArtifacts['manh_nguyen_to'] || 0;
                    
                    const upgradeDiv = document.createElement('div');
                    upgradeDiv.style.cssText = "background: #FFF8E1; border: 2px dashed #FFCA28; border-radius: 12px; padding: 12px; margin-bottom: 15px;";
                    
                    upgradeDiv.innerHTML = `
                        <div style="font-weight:bold; color:#FF6F00; margin-bottom:8px; text-transform:uppercase;">üîº N√¢ng C·∫•p L√™n ${nextLevel} Sao</div>
                        <div style="font-size:0.9em; color:#4E342E; text-align:left; line-height:1.6;">
                            üî∏ M·∫£nh Nguy√™n T·ªë: <b>${currentManh}/${costManh}</b><br>
                            üî∏ L√°: <b>${la}/${costLa}</b>
                        </div>
                    `;
                    
                    const btnUpgrade = document.createElement('button');
                    btnUpgrade.className = "btn-buy";
                    btnUpgrade.style.marginTop = "10px";
                    btnUpgrade.style.width = "100%";
                    btnUpgrade.textContent = "N√¢ng C·∫•p (24h)";
                    btnUpgrade.onclick = () => {
                        if (currentManh >= costManh && la >= costLa) {
                            if (confirm(`N√¢ng c·∫•p Pet l√™n ${nextLevel} Sao s·∫Ω m·∫•t th·ªùi gian ch·ªù?\nTrong l√∫c n√¢ng c·∫•p, Pet s·∫Ω kh√¥ng th·ªÉ thu ho·∫°ch gi√∫p b·∫°n.`)) {
    ownedArtifacts['manh_nguyen_to'] -= costManh;
    la -= costLa;
    // L·∫•y th·ªùi gian t·ª´ Config
    incubationFinishTime = Date.now() + GAME_CONFIG.UPGRADE_TIME; 
    
    saveGame(); updateDisplay(); closeInteractionPopup();
    alert(`ƒê√£ b·∫Øt ƒë·∫ßu n√¢ng c·∫•p!`);
}
                        } else {
                            alert(`B·∫°n kh√¥ng ƒë·ªß t√†i nguy√™n!\nC·∫ßn: ${costManh} M·∫£nh v√† ${costLa} L√°.`);
                        }
                    };
                    upgradeDiv.appendChild(btnUpgrade);
                    interactionControls.appendChild(upgradeDiv);
                } else {
                    interactionControls.innerHTML += `<div style="text-align:center; color:#FF6F00; font-weight:bold; margin-bottom:10px;">üëë ƒê√É MAX C·∫§P</div>`;
                }

                // --- KHUNG ·∫§P TR·ª®NG M·ªöI (FIX L·ªñI HI·ªÇN TH·ªä) ---
                if (hasIceEgg) {
                    const hatchContainer = document.createElement('div');
                    hatchContainer.style.cssText = "margin-top:15px; background:#E0F2F1; padding:10px; border-radius:10px; border:2px dashed #009688;";
                    
                    const hasAngel = isPetOwned('1000000127.gif');
                    const hasReaper = isPetOwned('1000000104.gif');
                    
                    let optionsHTML = "";
                    if (!hasAngel) optionsHTML += `<label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="radio" name="new_hatch_choice" value="thien_than" checked> üëº Thi√™n Th·∫ßn</label>`;
                    
                    const reaperChecked = (!hasAngel) ? '' : 'checked';
                    if (!hasReaper) optionsHTML += `<label style="display:block; cursor:pointer;"><input type="radio" name="new_hatch_choice" value="than_chet" ${reaperChecked}> üíÄ Th·∫ßn Ch·∫øt</label>`;

                    hatchContainer.innerHTML = `
                        <div style="font-weight:bold; color:#00796B; margin-bottom:8px;">ü•ö PH√ÅT HI·ªÜN TR·ª®NG M·ªöI!</div>
                        <div style="font-size:0.9em; margin-bottom:8px; color:#555;">B·∫°n v·ª´a mua th√™m tr·ª©ng, h√£y ·∫•p n√≥ ƒë·ªÉ nh·∫≠n Pet th·ª© 2:</div>
                        <div style="margin-bottom:10px; font-weight:bold;">${optionsHTML}</div>
                    `;

                    const btnHatchNew = document.createElement('button');
                    btnHatchNew.className = "btn-buy";
                    btnHatchNew.innerHTML = "·∫§p Ngay (24h)";
                    btnHatchNew.style.background = "#FF5722";
                    btnHatchNew.onclick = () => {
                        const choices = document.getElementsByName('new_hatch_choice');
                        let selected = null;
                        for(const c of choices) { if(c.checked) selected = c.value; }
                        
                        if(selected) {
                            if(confirm("B·∫Øt ƒë·∫ßu ·∫•p tr·ª©ng m·ªõi?\n(Slot 1 s·∫Ω chuy·ªÉn sang tr·∫°ng th√°i ·∫§p trong 24h)")) {
                                handleIceDragonInteraction('hatch', selected);
                            }
                        } else {
                            alert("B·∫°n ƒë√£ s·ªü h·ªØu c·∫£ 2 lo·∫°i Pet r·ªìi, kh√¥ng c·∫ßn ·∫•p n·ªØa!");
                        }
                    };
                    
                    hatchContainer.appendChild(btnHatchNew);
                    interactionControls.appendChild(hatchContainer);
                }
            }
            // --- TR∆Ø·ªúNG H·ª¢P 3: LOGIC ·∫§P TR·ª®NG (M·∫∂C ƒê·ªäNH L√Ä BI GAI) ---
            else if (hasIceEgg) {
                interactionTitle.innerHTML = `Tr·ª©ng Ng≈© S·∫Øc`;
                interactionText.innerHTML = "Qu·∫£ tr·ª©ng ƒëang rung l·∫Øc d·ªØ d·ªôi...";
                
                // T·∫°o giao di·ªán gi·ªõi thi·ªáu Bi Gai
                const demoDiv = document.createElement('div');
                demoDiv.innerHTML = `
                    <div style="margin:15px 0; background:#E8F5E9; padding:15px; border-radius:15px; border:2px dashed #4CAF50; text-align:center;">
                        <img src="1000000149.gif" style="width:70px; height:auto; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.2)); margin-bottom:10px;">
                        <div style="font-weight:900; color:#2E7D32; font-size:1.2em;">Bi Gai</div>
                        <div style="font-size:0.9em; color:#555;">(Pet kh·ªüi ƒë·∫ßu)</div>
                    </div>
                `;
                interactionControls.appendChild(demoDiv);
                
                // N√∫t ·∫§p Ngay
                const btnHatch = document.createElement('button');
                btnHatch.innerHTML = `üî® ƒê·∫≠p Tr·ª©ng (24h)`;
                btnHatch.className = "btn-buy";
                btnHatch.style.background = 'linear-gradient(45deg, #4CAF50, #8BC34A)';
                btnHatch.style.fontSize = '1.1em';
                btnHatch.style.boxShadow = '0 4px 0 #33691E';
                
                // Khi b·∫•m -> G·ªçi h√†m ·∫•p v·ªõi tham s·ªë 'bi_gai'
                btnHatch.onclick = () => {
                    handleIceDragonInteraction('hatch', 'bi_gai'); 
                };
                interactionControls.appendChild(btnHatch);
            }
            
            // --- TR∆Ø·ªúNG H·ª¢P 4: KH√îNG C√ì G√å (√î TR·ªêNG) ---
            else { 
                interactionTitle.innerHTML = "üêæ Pet M√¢y";
                interactionText.innerHTML = "Ch∆∞a c√≥ pet n√†o b·∫£o v·ªá n√¥ng tr·∫°i!<br>H√£y v√†o <b>Shop M√¢y</b> mua <b>Tr·ª©ng Ng≈© S·∫Øc</b>.";
            }
        }
            // --- LOGIC C√ÅC √î ƒê·∫§T TR·ªíNG C√ÇY ---
            else if (FARM_IDS.includes(slotNumInt)) {
                 interactionTitle.innerHTML = "üå± Tr·ªìng Tr·ªçt"; 
                 const slotIndex = FARM_IDS.indexOf(slotNumInt); 
                 const slotData = farmSlots[slotIndex];
                 
                 // 1. √î ƒê·∫§T TR·ªêNG -> M·ªü kho h·∫°t gi·ªëng
                 if (slotData === null) {
                     if(activePopupInterval) clearInterval(activePopupInterval);
                     showSeedSelectionPopup(slotNum, slotIndex); 
                     return; 
                 } 
                 
                 // 2. C√ì C√ÇY -> Hi·ªÉn th·ªã tr·∫°ng th√°i
                 else {
                     updateFarmState(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi nh·∫•t
                     const currentStage = PLANT_STAGES[slotData.stage];
                     const isReadyForHarvest = slotData.stage === PLANT_STAGES.length - 1;
                     
                     // T·∫°o th√¥ng b√°o c∆° b·∫£n
                     let statusMessage = `B·∫°n ƒëang tr·ªìng <b style="color:#4CAF50; font-size:1.1em;">${slotData.name}</b><br>`;
                     statusMessage += `<span style="color:#795548; font-size:0.9em;">Giai ƒëo·∫°n: ${currentStage.name}</span><br>`;

                     // TR∆Ø·ªúNG H·ª¢P A: ƒê√É CH√çN (THU HO·∫†CH)
                     if (isReadyForHarvest) {
                         interactionText.innerHTML = statusMessage + `<div style="margin-top:10px; color:#E65100; font-weight:bold;">‚ú® C√¢y ƒë√£ ch√≠n! Thu ho·∫°ch ngay.</div>`;
                         
                         const btnHarvest = document.createElement('button');
                         const currentPotType = slotData.potType || 'so_dua';
                         const potDef = POT_DEFINITIONS[currentPotType];
                         const potBonus = potDef ? (potDef.expBonus || 0) : 0;

                     // --- CODE M·ªöI: Logic Auto Thu Ho·∫°ch (C√≥ ki·ªÉm tra Pet b·∫≠n) ---
                     
                     // ƒêi·ªÅu ki·ªán: Pet ƒë√£ n·ªü (isIceDragonEvolved) V√Ä Kh√¥ng ƒëang b·∫≠n n√¢ng c·∫•p (incubationFinishTime === 0)
                     if (isIceDragonEvolved && incubationFinishTime === 0) {
                         const harvesterName = (hatchedPetType === 'than_chet') ? "üíÄ Th·∫ßn Ch·∫øt" : "üëº Thi√™n Th·∫ßn";
                         btnHarvest.innerHTML = `${harvesterName} Thu Ho·∫°ch (Auto)`;
                         btnHarvest.className = "btn-buy";
                         btnHarvest.style.background = 'linear-gradient(45deg, #2196F3, #00BCD4)';
                         
                         btnHarvest.onclick = () => {
                            if (isHarvesting) return; 
                            isHarvesting = true; 
                            closeInteractionPopup(); 
                            
                            // Hi·ªáu ·ª©ng Pet bay
                            const angelImg = document.getElementById('ice-egg-img');
                            if (angelImg) { angelImg.classList.add('angel-harvesting'); }
                            
                            setTimeout(() => {
                                let hasHarvested = false; 
                                farmSlots.forEach((sData, sIdx) => {
                                    if (sData && sData.stage === PLANT_STAGES.length - 1) {
                                        const hSeedValue = sData.value; 
                                        const slotId = FARM_IDS[sIdx];
                                        const sPotType = sData.potType || 'so_dua'; 
                                        const sPotDef = POT_DEFINITIONS[sPotType];
                                        const sBonus = sPotDef ? (sPotDef.expBonus || 0) : 0; 
                                        const hExp = 10 + sBonus; 
                                        exp += hExp; 
                                        spawnFloatingReward(slotId, `+${hExp} XP`, 0, "float-exp");
                                        const hReturnAmount = 2; 
                                        if (ownedSeeds[hSeedValue] === undefined) ownedSeeds[hSeedValue] = 0;
                                        ownedSeeds[hSeedValue] += hReturnAmount;
                                        
                                        if (HARVEST_DROPS[hSeedValue]) {
                                            const dropInfo = HARVEST_DROPS[hSeedValue];
                                            if (!ownedArtifacts[dropInfo.id]) ownedArtifacts[dropInfo.id] = 0;
                                            ownedArtifacts[dropInfo.id]++;
                                            spawnFloatingReward(slotId, `<img src="${dropInfo.img}" style="width:25px; height:25px; object-fit:contain;"> +1`, 200, "float-item");
                                        }
                                        farmSlots[sIdx] = null; 
                                        hasHarvested = true;
                                    }
                                });
                                if (angelImg) angelImg.classList.remove('angel-harvesting');
                                if (hasHarvested) {
                                    updateDisplay(); checkLevelUp(); updateSeedShop(); saveGame(); 
                                } else { 
                                    showToast("Ch∆∞a c√≥ c√¢y n√†o ch√≠n c·∫£!", "‚ö†Ô∏è", "Pet B√°o C√°o");
                                }
                                isHarvesting = false; 
                            }, 2000); 
                         };
                     } 
                     // Logic Thu Ho·∫°ch Th·ªß C√¥ng (Ch·∫°y khi ch∆∞a c√≥ Pet HO·∫∂C Pet ƒëang b·∫≠n n√¢ng c·∫•p)
                     else {
                         // HI·ªÜN C·∫¢NH B√ÅO N·∫æU PET ƒêANG B·∫¨N
                         if (isIceDragonEvolved && incubationFinishTime > 0) {
                            interactionText.innerHTML += `<div style="font-size:0.85em; color:#d32f2f; margin-top:5px; font-weight:bold; background:#ffebee; padding:5px; border-radius:5px; border:1px dashed #ef5350;">(Pet ƒëang b·∫≠n n√¢ng c·∫•p, h√£y t·ª± thu ho·∫°ch nh√©!)</div>`;
                         }

                         const harvestedSeedValue = slotData.value; const returnAmount = 2; 
                         let baseExp = 10; let finalExp = baseExp + potBonus;
                         let msgButton = potBonus > 0 ? `üåæ Thu ho·∫°ch (+${finalExp} Exp)` : `üåæ Thu ho·∫°ch (Nh·∫≠n ${returnAmount} H·∫°t + ${finalExp} Exp)`;
                         btnHarvest.innerHTML = msgButton;
                         btnHarvest.className = "btn-buy";
                         btnHarvest.style.background = '#FF9800';
                         
                         btnHarvest.onclick = () => {
                             const slotId = FARM_IDS[slotIndex]; 
                             exp += finalExp; 
                             spawnFloatingReward(slotId, `+${finalExp} XP`, 0, "float-exp");
                             if (ownedSeeds[harvestedSeedValue] !== undefined) ownedSeeds[harvestedSeedValue] += returnAmount;
                             else ownedSeeds[harvestedSeedValue] = returnAmount;
                             if (HARVEST_DROPS[harvestedSeedValue]) {
                                 const dropInfo = HARVEST_DROPS[harvestedSeedValue];
                                 if (!ownedArtifacts[dropInfo.id]) ownedArtifacts[dropInfo.id] = 0;
                                 ownedArtifacts[dropInfo.id]++;
                                 spawnFloatingReward(slotId, `<img src="${dropInfo.img}" style="width:25px; height:25px; object-fit:contain;"> +1`, 200, "float-item");
                             }
                             farmSlots[slotIndex] = null; 
                             closeInteractionPopup(); 
                             updateDisplay(); 
                             checkLevelUp(); 
                             updateSeedShop(); 
                             saveGame(); 
                         };
                     }
                         interactionControls.appendChild(btnHarvest);
                     }
                     
                     // TR∆Ø·ªúNG H·ª¢P B: ƒêANG L·ªöN (HI·ªÜN ƒê·ªíNG H·ªí)
                     else {
                         const updatePlantTimer = () => {
                             if (!farmSlots[slotIndex]) return;
                             
                             const now = Date.now();
                             const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
                             let requiredDuration = nextStageInfo.duration;
                             
                             // --- T√çNH TO√ÅN GI·∫¢M GI·ªú (COMBO D√ÇY LEO) ---
                             const isFullSet = vineDecorations.every(item => item !== null);
                             const reductionAmount = isFullSet ? 7200000 : 3600000;
                             
                             const fastGrowthItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
                             if (fastGrowthItems.includes(vineDecorations[slotIndex])) {
                                 requiredDuration -= reductionAmount;
                                 if (requiredDuration < 0) requiredDuration = 0;
                             }

                             const finishTime = slotData.plantedAt + requiredDuration;
                             const timeLeft = finishTime - now;

                             if (timeLeft <= 0) {
                                 if(activePopupInterval) clearInterval(activePopupInterval);
                                 updateFarmState(); 
                                 renderSlotStatus(); 
                                 return;
                             }
                             
                             interactionText.innerHTML = statusMessage + `
                                <div style="margin-top:10px; background:#f5f5f5; padding:8px; border-radius:5px;">
                                    ‚è≥ L·ªõn sau: <b style="color:#2196F3;">${getCountdownTimePlant(timeLeft)}</b>
                                </div>`;
                         };
                         
                         updatePlantTimer(); 
                         if(activePopupInterval) clearInterval(activePopupInterval);
                         activePopupInterval = setInterval(updatePlantTimer, 1000);
                     }
                 }
            } else { 
                interactionTitle.innerHTML = "Th√¥ng B√°o"; 
                interactionText.innerHTML = `√î ƒë·∫•t n√†y ch∆∞a m·ªü kh√≥a!`; 
            }
        };
        renderSlotStatus();
        showPopup('interaction-popup');
    });
});

const petHouse = document.getElementById("pet-house");
if (petHouse) {
    petHouse.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        updatePetShop(); showPopup('pet-house-box'); 
    });
}

const pugPet = document.getElementById("pug-pet");
if (pugPet) {
    pugPet.addEventListener("click", () => {
        if (level === 0) return;
        interactionControls.innerHTML = '';
        if (!activePet) return;
        
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet")); 
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet";
        
        interactionTitle.innerHTML = `üêæ ${petName}`; 
        interactionText.innerHTML = `
            ${petName} ƒëang r·∫•t vui v·∫ª.<br>
            üéÇ Tu·ªïi: <b>${globalPetAge} ng√†y</b>
        `;
        showPopup('interaction-popup');
    });
}

// --- ƒêO·∫†N 1: S·ª¨A S·ª∞ KI·ªÜN CLICK B√ÅT X∆Ø∆†NG ---
const boneBowl = document.getElementById("bone-bowl");
if (boneBowl) {
    boneBowl.addEventListener("click", () => {
        if (level === 0) return;
        
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet";
        
        interactionControls.innerHTML = ''; 
        interactionTitle.innerHTML = `ü¶¥ Cho ƒÉn`; 
        
        if (!activePet) { interactionText.innerHTML = `Ch∆∞a c√≥ Pet n√†o!`; } 
        else if(petData && (petData.name.includes("Th·∫ßn Ch·∫øt") || petData.name.includes("Thi√™n Th·∫ßn"))) {
            interactionText.innerHTML = `${petName} t·ª± ki·∫øm ƒÉn, kh√¥ng ƒÉn x∆∞∆°ng!`;
        } else {
            const now = new Date(); const last = new Date(lastFedTime);
            const isSameDay = now.getDate() === last.getDate() && now.getMonth() === last.getMonth() && now.getFullYear() === last.getFullYear();
            
            if (!isSameDay) {
                interactionText.innerHTML = `Pet ƒëang ƒë√≥i b·ª•ng...`;
                const btnFeed = document.createElement('button');
                btnFeed.innerHTML = "ü¶¥ Cho ƒÉn ngay (Mi·ªÖn ph√≠)"; 
                btnFeed.className = "btn-buy";
                
                // --- S·ª¨A ·ªû ƒê√ÇY: KH√îNG L∆ØU GAME NGAY L·∫¨P T·ª®C ---
                btnFeed.onclick = () => {
                    // Ch·ªâ ƒë√≥ng popup v√† hi·ªán qu·∫£ ƒë√†o. 
                    // Ch∆∞a l∆∞u lastFedTime v·ªôi ƒë·ªÉ ph√≤ng tr∆∞·ªùng h·ª£p l·ª° tay t·∫Øt m·∫•t.
                    hidePopup('interaction-popup');
                    spawnDailyReward();
                };
                // ----------------------------------------------
                
                interactionControls.appendChild(btnFeed);
            } else {
                interactionText.innerHTML = `${petName} ƒë√£ no r·ªìi! üê∂`;
            }
        }
        showPopup('interaction-popup');
    });
}

// --- ƒêO·∫†N 2: S·ª¨A H√ÄM HI·ªÜN QU√Ä V√Ä L∆ØU D·ªÆ LI·ªÜU ---
function spawnDailyReward() {
    // X√≥a qu√† c≈© n·∫øu ch∆∞a nh·∫≠n (tr√°nh tr√πng l·∫∑p)
    const existingReward = document.getElementById('daily-reward-icon');
    if(existingReward) existingReward.remove();

    const petImg = document.getElementById('pug-pet');
    if(!petImg || petImg.style.display === 'none') return;

    // T·∫°o container qu√†
    const wrapper = document.createElement('div');
    wrapper.id = 'daily-reward-icon';
    wrapper.className = 'daily-reward-bubble';

    // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa Pet ƒë·ªÉ ƒë·∫∑t qu√† ngay tr√™n ƒë·∫ßu
    wrapper.style.left = petImg.style.left;
    wrapper.style.transform = petImg.style.transform; 
    
    // T√≠nh to√°n v·ªã tr√≠ bottom: L·∫•y bottom c·ªßa pet + chi·ªÅu cao pet
    let currentBottom = parseInt(petImg.style.bottom || '35'); 
    wrapper.style.bottom = (currentBottom + 90) + 'px'; // Bay cao h∆°n pet 90px

    // 1. Ch·ªâ t·∫°o ·∫¢nh Qu·∫£ ƒê√†o (1000000109.png)
    const img = document.createElement('img');
    img.src = '1000000109.png';
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'contain';

    wrapper.appendChild(img);

    // --- S·ª∞ KI·ªÜN NH·∫¨N QU√Ä (QUAN TR·ªåNG: L∆ØU GAME T·∫†I ƒê√ÇY) ---
    wrapper.onclick = () => {
        // 1. C·∫≠p nh·∫≠t d·ªØ li·ªáu game T·∫†I ƒê√ÇY (Ch·ªâ khi b·∫•m tr√∫ng qu√† m·ªõi t√≠nh l√† ƒë√£ ƒÉn)
        la += 5;                // C·ªông l√°
        lastFedTime = Date.now(); // ƒê√°nh d·∫•u h√¥m nay ƒë√£ ƒÉn
        globalPetAge += 1;      // TƒÉng tu·ªïi pet
        
        // --- T√¨m t√™n Pet hi·ªán t·∫°i ---
        let petName = "Pet";
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const currentPetData = allPets.find(p => p.value === activePet);
        if (currentPetData) {
            petName = currentPetData.name; 
        }

        alert(`B·∫°n nh·∫≠n ƒë∆∞·ª£c 5 L√° t·ª´ ${petName}! üçÇ`);
        
        // Hi·ªáu ·ª©ng bay l√™n bi·∫øn m·∫•t
        wrapper.style.animation = 'flyUpReward 0.5s ease-out forwards';
        
        // L∆∞u game ngay l·∫≠p t·ª©c ƒë·ªÉ ghi nh·∫≠n k·∫øt qu·∫£
        updateDisplay();
        saveGame();

        // X√≥a element sau khi animation xong
        setTimeout(() => {
            wrapper.remove();
        }, 500);
    };

    // Th√™m v√†o v√πng Main ƒë·ªÉ hi·ªÉn th·ªã
    document.querySelector('main').appendChild(wrapper);
}

const chaosBlacksmith = document.getElementById("chaos-blacksmith");
if (chaosBlacksmith) {
    chaosBlacksmith.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showBlacksmithPopup();
    });
}
// --- S·ª∞ KI·ªÜN CLICK CHO ·∫¢NH ƒê·ªòNG (M·ªöI) ---
const chaosBlacksmithWorking = document.getElementById("chaos-blacksmith-working");
if (chaosBlacksmithWorking) {
    chaosBlacksmithWorking.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showBlacksmithPopup();
    });
}


function showBlacksmithPopup() {
    interactionTitle.innerHTML = "üî® Th·ª£ R√®n Chaos";
    interactionText.style.display = 'none';
    interactionControls.innerHTML = "";

    // 1. HEADER T√ÄI NGUY√äN (Gi·ªØ nguy√™n ph·∫ßn hi·ªÉn th·ªã ƒë·∫πp)
    const resourceHeader = document.createElement("div");
    resourceHeader.style.cssText = "display:flex; justify-content:space-around; background:#FFF3E0; padding:10px; border-radius:12px; margin-bottom:12px; font-size:0.9em; border:2px solid #FFE0B2; box-shadow: inset 0 0 5px rgba(0,0,0,0.05);";
    resourceHeader.innerHTML = `
        <div style="display:flex; align-items:center; gap:5px;">
            <span style="font-size:1.2em;">ü´ò</span> 
            <div>
                <div style="font-size:0.7em; color:#795548; font-weight:bold; text-transform:uppercase;">ƒê·∫≠u</div>
                <b style="color:#5D4037; font-size:1.1em;">${dau.toLocaleString()}</b>
            </div>
        </div>
        <div style="width:1px; background:#FFCC80;"></div>
        <div style="display:flex; align-items:center; gap:5px;">
            <img src="1000000136.png" style="width:20px; height:20px;">
            <div>
                <div style="font-size:0.7em; color:#546E7A; font-weight:bold; text-transform:uppercase;">M·∫£nh K.Lo·∫°i</div>
                <b style="color:#37474F; font-size:1.1em;">${(ownedArtifacts['manh_kim_loai']||0).toLocaleString()}</b>
            </div>
        </div>
    `;
    interactionControls.appendChild(resourceHeader);
    
    // 2. CONTAINER CH√çNH
    const scrollContainer = document.createElement("div");
    scrollContainer.style.cssText = 'max-height: 400px; overflow-y: auto; padding: 2px;';
    
    // 3. DANH S√ÅCH H√ÄNG CH·ªú (QUEUE)
    const queueContainer = document.createElement("div");
    queueContainer.id = "crafting-queue-list";
    scrollContainer.appendChild(queueContainer);
    
    // 4. DANH S√ÅCH C√îNG TH·ª®C (D√πng th·∫ª DIV thay v√¨ TABLE)
    const listContainer = document.createElement('div');
    listContainer.className = 'blacksmith-list';
    
    const isSmithBusy = craftingQueue.length > 0;

    CRAFTING_RECIPES.forEach(recipe => {
        // Ki·ªÉm tra ƒëi·ªÅu ki·ªán ƒê·∫≠u
        const hasDau = dau >= (recipe.cost.dau || 0);
        
        let reqHtml = '';
        let canCraftMaterials = true;

        // X·ª≠ l√Ω hi·ªÉn th·ªã nguy√™n li·ªáu
        Object.keys(recipe.materials).forEach(matKey => {
            const reqQty = recipe.materials[matKey];
            let currentAmt = 0;
            let matName = matKey;

            // L·∫•y t√™n v√† s·ªë l∆∞·ª£ng hi·ªán c√≥
            if (matKey === 'manh_kim_loai') {
                 currentAmt = ownedArtifacts['manh_kim_loai'] || 0;
                 matName = "M·∫£nh KL"; // Vi·∫øt t·∫Øt cho g·ªçn
            } else if (POT_DEFINITIONS[matKey]) {
                 currentAmt = ownedPots[matKey] || 0;
                 matName = POT_DEFINITIONS[matKey].name;
            } else if (matKey === 'so_dua') { // Fallback t√™n S·ªç D·ª´a
                 currentAmt = ownedPots['so_dua'] || 0;
                 matName = "S·ªç D·ª´a";
            }

            const hasItem = currentAmt >= reqQty;
            if (!hasItem) canCraftMaterials = false;
            
            // D√≤ng nguy√™n li·ªáu nh·ªè g·ªçn
            reqHtml += `
                <div class="req-line ${hasItem ? 'req-ok' : 'req-miss'}">
                    <span style="font-size:0.8em;">${hasItem ? '‚óè' : '‚óã'}</span> 
                    <span>${matName}: ${currentAmt}/${reqQty}</span>
                </div>`;
        });
        
        // D√≤ng y√™u c·∫ßu ƒê·∫≠u
        reqHtml += `
            <div class="req-line ${hasDau ? 'req-ok' : 'req-miss'}">
                <span style="font-size:0.8em;">${hasDau ? '‚óè' : '‚óã'}</span>
                <span>ƒê·∫≠u: ${recipe.cost.dau.toLocaleString()}</span>
            </div>`;

        // Logic n√∫t b·∫•m
        let isBlockedByBusy = (recipe.duration > 0 && isSmithBusy);
        const canCraft = hasDau && canCraftMaterials && !isBlockedByBusy;
        
        let btnText = "R√®n";
        let btnBg = "var(--accent)";
        
        if (recipe.duration === 0) {
            btnText = "Mua";
            btnBg = "#4CAF50"; // M√†u xanh l√° cho n√∫t Mua
        } else if (isBlockedByBusy) {
            btnText = "B·∫≠n";
            btnBg = "#9E9E9E";
        }

        // T·∫†O GIAO DI·ªÜN H√ÄNG (ROW)
        const rowDiv = document.createElement('div');
        rowDiv.className = 'blacksmith-row';
        rowDiv.innerHTML = `
            <div class="bs-info">
                <div class="bs-icon-box">
                    <img src="${recipe.icon}" alt="${recipe.name}">
                </div>
                <div class="bs-name">${recipe.name}</div>
            </div>

            <div class="bs-req">
                ${reqHtml}
            </div>

            <div class="bs-action">
                <button id="btn-craft-${recipe.id}" class="btn-crafting" 
                    style="
                        width: auto; 
                        padding: 8px 16px; 
                        background: ${canCraft ? btnBg : '#ccc'}; 
                        cursor: ${canCraft ? 'pointer' : 'not-allowed'};
                        box-shadow: ${canCraft ? '0 2px 0 rgba(0,0,0,0.2)' : 'none'};
                    " 
                    ${canCraft ? '' : 'disabled'}>
                    ${btnText}
                </button>
            </div>
        `;

        // G√°n s·ª± ki·ªán click (gi·ªØ nguy√™n logic c≈©)
        setTimeout(() => {
            const btn = rowDiv.querySelector(`#btn-craft-${recipe.id}`);
            if(btn) btn.onclick = () => startCrafting(recipe);
        }, 0);

        listContainer.appendChild(rowDiv);
    });

    scrollContainer.appendChild(listContainer);
    interactionControls.appendChild(scrollContainer); 

    // Render h√†ng ch·ªù v√† k√≠ch ho·∫°t interval
    renderCraftingQueue();
    showPopup('interaction-popup');
    
    if (activePopupInterval) clearInterval(activePopupInterval);
    activePopupInterval = setInterval(renderCraftingQueue, 1000);
}

function startCrafting(recipe) {
    if (craftingQueue.length > 0 && recipe.duration > 0) {
        alert("Th·ª£ r√®n ƒëang b·∫≠n! Vui l√≤ng ƒë·ª£i r√®n xong m√≥n hi·ªán t·∫°i.");
        return;
    }

    if (dau < (recipe.cost.dau || 0)) return;
    
    for (const [matKey, matQty] of Object.entries(recipe.materials)) {
        let currentAmt = 0;
        // --- S·ª¨A: KI·ªÇM TRA KHO M·∫¢NH ---
        if (matKey === 'manh_kim_loai') currentAmt = ownedArtifacts['manh_kim_loai'] || 0;
        else if (ownedPots[matKey] !== undefined) currentAmt = ownedPots[matKey] || 0;
        
        if (currentAmt < matQty) {
            alert("Kh√¥ng ƒë·ªß nguy√™n li·ªáu!");
            return;
        }
    }

    const actionName = recipe.duration === 0 ? "Mua" : "R√®n";

    if(confirm(`B·∫°n mu·ªën ${actionName} ${recipe.name}?`)) {
        dau -= (recipe.cost.dau || 0);
        
        for (const [matKey, matQty] of Object.entries(recipe.materials)) {
            // --- S·ª¨A: TR·ª™ NGUY√äN LI·ªÜU M·∫¢NH ---
            if (matKey === 'manh_kim_loai') {
                 ownedArtifacts['manh_kim_loai'] -= matQty;
            } else if (ownedPots[matKey] !== undefined) {
                 ownedPots[matKey] -= matQty;
            }
        }

        if (recipe.duration === 0) {
             if (!ownedPots[recipe.output]) ownedPots[recipe.output] = 0;
             ownedPots[recipe.output]++;
             alert(`ƒê√£ mua th√†nh c√¥ng ${recipe.name}!`);
             updateDisplay();
             showBlacksmithPopup(); 
        } else {
            craftingQueue.push({ output: recipe.output, name: recipe.name, startTime: Date.now(), finishTime: Date.now() + recipe.duration });
            alert("ƒê√£ b·∫Øt ƒë·∫ßu r√®n!");
            updateDisplay();
            showBlacksmithPopup();
            updateBlacksmithVisuals(); 
        }
    }
}

function renderCraftingQueue() {
    const container = document.getElementById("crafting-queue-list");
    if (!container) return;
    
    container.innerHTML = "";
    if (craftingQueue.length === 0) return;
    
    const queueList = document.createElement('div');
    queueList.style.cssText = 'border: 2px dashed #FF9800; padding: 10px; border-radius: 8px; margin-bottom: 15px; background: rgba(255, 236, 179, 0.5);';
    container.appendChild(queueList);

    const now = Date.now();
    let updated = false;

    for (let i = craftingQueue.length - 1; i >= 0; i--) {
        const item = craftingQueue[i];
        const timeLeft = item.finishTime - now;
        
        if (timeLeft <= 0) {
            craftingQueue.splice(i, 1);
            if (!ownedPots[item.output]) ownedPots[item.output] = 0;
            ownedPots[item.output]++;
            alert(`‚úÖ R√®n th√†nh c√¥ng: ${item.name}!`);
            updated = true;
        } else {
            const div = document.createElement("div");
            
            // --- C·∫¨P NH·∫¨T HI·ªÇN TH·ªä TH·ªúI GIAN ƒê·∫∏P H∆†N ---
            let seconds = Math.floor((timeLeft / 1000) % 60);
            let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
            let hours = Math.floor((timeLeft / (1000 * 60 * 60)));
            
            let timeString = "";
            if(hours > 0) timeString += `${hours}h `;
            if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
            timeString += `${seconds}s`;

            div.style.fontWeight = "bold";
            div.innerHTML = `üî• ${item.name}: <span style="color:#E65100">${timeString}</span>`;
            queueList.appendChild(div);
        }
    }
    
    if (updated) {
        updateDisplay();
        if (document.getElementById('interaction-popup').classList.contains('popup-active')) showBlacksmithPopup();
    }
}

function checkGlobalCrafting() {
    if(craftingQueue.length > 0) {
        const now = Date.now();
        let updated = false;
        for (let i = craftingQueue.length - 1; i >= 0; i--) {
            if (now >= craftingQueue[i].finishTime) {
                const item = craftingQueue[i];
                craftingQueue.splice(i, 1);
                if (!ownedPots[item.output]) ownedPots[item.output] = 0;
                ownedPots[item.output]++;
                alert(`‚úÖ R√®n th√†nh c√¥ng: ${item.name}!`);
                updated = true;
            }
        }
        if (updated) updateDisplay();
        updateBlacksmithVisuals(); // C·∫¨P NH·∫¨T L·∫†I N·∫æU H√ÄNG CH·ªú R·ªñNG
    }
}

const brandContainer = document.querySelector(".brand");
if (brandContainer) {
    brandContainer.addEventListener("click", () => {
        if (level === 0) return;
        const maxExp = expNeeded(level);
        const percent = ((exp / maxExp) * 100).toFixed(1);
        
        interactionTitle.innerHTML = `üìä C·∫•p ƒë·ªô ${level}`;
        interactionText.style.display = 'block';
        interactionText.innerHTML = `
            <div style="text-align:left; background:#f5f5f5; padding:15px; border-radius:10px;">
                üå± <b>Kinh nghi·ªám:</b> ${exp.toLocaleString()} / ${maxExp.toLocaleString()}<br>
                üìà <b>Ti·∫øn ƒë·ªô:</b> ${percent}%
            </div>
        `;
        interactionControls.innerHTML = '';
        showPopup('interaction-popup');
    });
}

// --- B·ªî SUNG H√ÄM G√ÅN S·ª∞ KI·ªÜN CHO V·∫¨T PH·∫®M TREO (CH√ÇU CH·∫§U...) ---
function initGrasshopperEvents() {
    // L·∫•y t·∫•t c·∫£ c√°c th·∫ª img d√πng ƒë·ªÉ hi·ªÉn th·ªã v·∫≠t ph·∫©m treo
    // ID c·ªßa ch√∫ng l√† grasshopper-0, grasshopper-1, ...
    for (let i = 0; i < 5; i++) {
        const itemEl = document.getElementById(`grasshopper-${i}`);
        if (itemEl) {
            // Clone ƒë·ªÉ x√≥a s·ª± ki·ªán c≈© (n·∫øu c√≥)
            const newItemEl = itemEl.cloneNode(true);
            itemEl.parentNode.replaceChild(newItemEl, itemEl);

            newItemEl.addEventListener('click', () => {
                if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
                // M·ªü popup d√¢y leo t·∫°i v·ªã tr√≠ t∆∞∆°ng ·ª©ng
                showVinePopup(i);
            });
        }
    }
}
// --- S·ª¨A L·∫†I LOGIC KI·ªÇM TRA TR·ª®NG N·ªû ---
function checkIncubationState() {
    if (incubationFinishTime > 0) {
        const now = Date.now();
        if (now >= incubationFinishTime) {
            incubationFinishTime = 0; // X√≥a th·ªùi gian ch·ªù

            // TR∆Ø·ªúNG H·ª¢P 1: ·∫§P N·ªû TH√ÄNH C√îNG
            if (hasIceEgg) {
                hasIceEgg = false; // M·∫•t tr·ª©ng
                isIceDragonHatched = true; 
                isIceDragonEvolved = true; 

                // Reset level v·ªÅ 1
                petLevels[hatchedPetType] = 1;
                petStarLevel = 1; 

                // --- S·ª¨A ·ªû ƒê√ÇY: Th√™m tr∆∞·ªùng h·ª£p Bi Gai ---
                let petName = "Bi Gai";
                if (hatchedPetType === 'thien_than') petName = "Thi√™n Th·∫ßn";
                if (hatchedPetType === 'than_chet') petName = "Th·∫ßn Ch·∫øt";
                // -----------------------------------------

                if(typeof showToast === 'function') {
                    showToast(`N·ªü th√†nh c√¥ng: ${petName}`, "üê£", "Ch√∫c M·ª´ng");
                } else {
                    alert(`üéâ CH√öC M·ª™NG! Tr·ª©ng ƒë√£ n·ªü th√†nh: ${petName}!`);
                }
            } 
            
            // TR∆Ø·ªúNG H·ª¢P 2: N√ÇNG C·∫§P TH√ÄNH C√îNG
            else if (isIceDragonHatched) {
                if (!petLevels[hatchedPetType]) petLevels[hatchedPetType] = 1;
                if (petLevels[hatchedPetType] < 5) {
                    petLevels[hatchedPetType]++; 
                    petStarLevel = petLevels[hatchedPetType]; 
                    
                    if(typeof showToast === 'function') {
                        showToast(`L√™n c·∫•p th√†nh c√¥ng!`, "üåü");
                    }
                }
            } 

            updateDisplay();
            saveGame();
            if(document.getElementById('interaction-popup').classList.contains('popup-active')) {
                hidePopup('interaction-popup');
            }
        }
    }
}
// ======================================================
// --- LOGIC T∆Ø∆†NG T√ÅC D√ÇY LEO & CH√ÇU CH·∫§U (M·ªöI) ---
// ======================================================

// 1. G√°n s·ª± ki·ªán click cho c√°c d√¢y leo ngay khi ch·∫°y game
// L∆∞u √Ω: H√†m n√†y s·∫Ω t·ª± ch·∫°y nh·ªù logic b√™n d∆∞·ªõi, b·∫°n kh√¥ng c·∫ßn g·ªçi th·ªß c√¥ng
function initVineEvents() {
    const vines = document.querySelectorAll('.vine-deco');
    vines.forEach(vine => {
        // X√≥a s·ª± ki·ªán c≈© ƒë·ªÉ tr√°nh b·ªã double click (n·∫øu c√≥)
        const newVine = vine.cloneNode(true); 
        vine.parentNode.replaceChild(newVine, vine);
        
        newVine.addEventListener('click', (e) => {
            if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
            
            // L·∫•y v·ªã tr√≠ d√¢y leo (0-4) t·ª´ HTML
            const index = parseInt(e.target.getAttribute('data-index'));
            showVinePopup(index);
        });
    });
}

// G·ªçi h√†m g√°n s·ª± ki·ªán n√†y m·ªói khi kh·ªüi t·∫°o
// (B·∫°n h√£y t√¨m d√≤ng initializeGame v√† th√™m initVineEvents() v√†o trong ƒë√≥ n·∫øu mu·ªën ch·∫Øc ch·∫Øn,
// ho·∫∑c d√°n d√≤ng n√†y v√†o cu·ªëi file script: setTimeout(initVineEvents, 1000); )


// --- 2. H√†m hi·ªÉn th·ªã Popup khi click v√†o d√¢y leo (ƒê√É L√ÄM ƒê·∫∏P & LOGIC H∆†N) ---
function showVinePopup(index) {
    // Reset ti√™u ƒë·ªÅ
    interactionTitle.innerHTML = `üåø D√¢y Leo (V·ªã tr√≠ ${index + 1})`;

    // 1. KI·ªÇM TRA & HI·ªÇN TH·ªä COMBO
    const isFullSet = vineDecorations.every(item => item !== null);
    let comboHTML = "";
    
    if (isFullSet) {
        // Giao di·ªán khi ƒê√É k√≠ch ho·∫°t Combo
        comboHTML = `
        <div style="
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
            border: 2px solid #fbc02d;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        ">
            <div style="font-size:1.2em; margin-bottom:5px;">‚ö°‚ö°‚ö°</div>
            <strong style="color:#f57f17; font-size:1em;">ƒê√É K√çCH HO·∫†T COMBO!</strong>
            <div style="font-size:0.85em; color:#5d4037; margin-top:2px;">To√†n b·ªô c√¢y tr·ªìng ƒë∆∞·ª£c gi·∫£m <b>2 gi·ªù</b> tr∆∞·ªüng th√†nh.</div>
        </div>`;
    } else {
        // Giao di·ªán khi CH∆ØA k√≠ch ho·∫°t Combo
        const missingCount = vineDecorations.filter(x => x === null).length;
        comboHTML = `
        <div style="
            background: #f5f5f5;
            border: 1px dashed #bdbdbd;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        ">
            <strong style="color:#757575;">Ch∆∞a k√≠ch ho·∫°t Combo</strong>
            <div style="font-size:0.85em; color:#9e9e9e; margin-top:2px;">
                C·∫ßn treo th√™m <b>${missingCount}</b> m√≥n n·ªØa ƒë·ªÉ gi·∫£m <b>2 gi·ªù</b> (Hi·ªán t·∫°i ch·ªâ gi·∫£m 1h/m√≥n).
            </div>
        </div>`;
    }

    interactionText.innerHTML = comboHTML;
    interactionControls.innerHTML = '';

    // 2. T·∫†O DANH S√ÅCH V·∫¨T PH·∫®M (Clean List Style)
    const listContainer = document.createElement('div');
    listContainer.style.cssText = `
        max-height: 280px; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        padding: 5px;
    `;

    const currentDecoID = vineDecorations[index];

    // Duy·ªát qua t·∫•t c·∫£ v·∫≠t ph·∫©m c·∫•u h√¨nh ƒë·ªÉ hi·ªÉn th·ªã
    HANGING_ITEMS_CONFIG.forEach(item => {
        const ownedAmount = ownedDecorations[item.id] || 0;
        const isEquippedHere = (currentDecoID === item.id);
        
        // Ch·ªâ hi·ªÉn th·ªã nh·ªØng m√≥n m√¨nh C√ì ho·∫∑c ƒêANG TREO (ho·∫∑c hi·ªÉn th·ªã m·ªù n·∫øu mu·ªën khoe v·∫≠t ph·∫©m)
        // ·ªû ƒë√¢y m√¨nh s·∫Ω hi·ªÉn th·ªã T·∫§T C·∫¢ ƒë·ªÉ ng∆∞·ªùi ch∆°i bi·∫øt game c√≥ nh·ªØng g√¨
        
        const itemRow = document.createElement('div');
        // Style cho t·ª´ng d√≤ng
        itemRow.style.cssText = `
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            background: white;
            border: 1px solid ${isEquippedHere ? '#4CAF50' : '#eee'};
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: transform 0.1s;
        `;
        if(isEquippedHere) itemRow.style.background = "#e8f5e9"; // M√†u xanh nh·∫°t n·∫øu ƒëang treo

        // Logic x√°c ƒë·ªãnh t√°c d·ª•ng
        const speedUpItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
        let effectBadge = "";
        if (speedUpItems.includes(item.id)) {
            effectBadge = `<span style="background:#E3F2FD; color:#1565C0; font-size:0.7em; padding:2px 6px; border-radius:4px; font-weight:bold;">‚ö° -1 Gi·ªù</span>`;
        }

        // Logic N√∫t B·∫•m
        let btnHtml = '';
        if (isEquippedHere) {
            // ƒêang treo t·∫°i √¥ n√†y
            btnHtml = `<button disabled style="
                background:transparent; color:#2E7D32; border: 2px solid #2E7D32; 
                border-radius:20px; padding:5px 10px; font-weight:bold; font-size: 0.8em; opacity: 0.7;">
                ‚úî ƒêang d√πng
            </button>`;
        } else if (ownedAmount > 0) {
            // C√≥ h√†ng -> Cho ph√©p treo
            btnHtml = `<button class="btn-equip-item" data-id="${item.id}" style="
                background:var(--primary); color:white; border:none; 
                border-radius:20px; padding:6px 15px; cursor:pointer; font-weight:bold; font-size: 0.85em; 
                box-shadow: 0 2px 0 var(--primary-dark);">
                Treo
            </button>`;
        } else {
            // H·∫øt h√†ng -> N√∫t T√¨m/Mua
            btnHtml = `<button onclick="document.getElementById('event-cloud').click()" style="
                background:#f5f5f5; color:#999; border:1px solid #ddd; 
                border-radius:20px; padding:5px 10px; cursor:pointer; font-size: 0.8em;">
                üîç T√¨m
            </button>`;
        }

        itemRow.innerHTML = `
            <div style="display:flex; align-items:center; gap: 12px;">
                <div style="width:45px; height:45px; background:#f9f9f9; border-radius:8px; display:flex; align-items:center; justify-content:center; border:1px solid #eee;">
                    <img src="${item.img}" style="width:80%; height:80%; object-fit:contain;">
                </div>
                <div style="text-align:left;">
                    <div style="font-weight:700; color:#3e2723; font-size: 0.95em;">${item.name}</div>
                    <div style="display:flex; align-items:center; gap:5px; margin-top:2px;">
                        ${effectBadge}
                        <span style="font-size:0.75em; color:#795548;">Kho: <b>${ownedAmount}</b></span>
                    </div>
                </div>
            </div>
            <div>${btnHtml}</div>
        `;
        
        listContainer.appendChild(itemRow);
    });

    interactionControls.appendChild(listContainer);

    // 3. N√öT G·ª† B·ªé (N·∫øu ƒëang treo ƒë·ªì)
    if (currentDecoID !== null) {
        const removeContainer = document.createElement('div');
        removeContainer.style.marginTop = "15px";
        removeContainer.style.borderTop = "1px dashed #ddd";
        removeContainer.style.paddingTop = "10px";

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = "‚ùå G·ª° v·∫≠t ph·∫©m n√†y xu·ªëng";
        
        // --- THAY ƒê·ªîI ·ªû ƒê√ÇY: G√°n class CSS m·ªõi t·∫°o ---
        removeBtn.className = "btn-remove-vines"; 
        // ---------------------------------------------
        
        removeBtn.onclick = () => {
            if(confirm("B·∫°n mu·ªën g·ª° v·∫≠t ph·∫©m n√†y v·ªÅ kho?")) {
                // Tr·∫£ l·∫°i kho
                if (!ownedDecorations[currentDecoID]) ownedDecorations[currentDecoID] = 0;
                ownedDecorations[currentDecoID]++;
                
                // X√≥a kh·ªèi d√¢y
                vineDecorations[index] = null;
                
                saveGame(); updateDisplay(); closeInteractionPopup();
            }
        };
        removeContainer.appendChild(removeBtn);
        interactionControls.appendChild(removeContainer);
    }

    // 4. G√ÅN S·ª∞ KI·ªÜN CHO N√öT TREO
    const equipBtns = listContainer.querySelectorAll('.btn-equip-item');
    equipBtns.forEach(btn => {
        btn.onclick = (e) => {
            const itemId = e.target.getAttribute('data-id');
            const itemData = HANGING_ITEMS_CONFIG.find(i => i.id === itemId);

            // Logic thay th·∫ø:
            // 1. N·∫øu ƒëang treo c√°i c≈© -> Th√°o c√°i c≈© tr·∫£ v·ªÅ kho
            if (currentDecoID) {
                if (!ownedDecorations[currentDecoID]) ownedDecorations[currentDecoID] = 0;
                ownedDecorations[currentDecoID]++;
            }

            // 2. L·∫•y c√°i m·ªõi t·ª´ kho ra treo -> Tr·ª´ kho
            if (ownedDecorations[itemId] > 0) {
                ownedDecorations[itemId]--;
                vineDecorations[index] = itemId;

                // Hi·ªáu ·ª©ng ph·∫£n h·ªìi nh·ªè
                alert(`ƒê√£ treo ${itemData.name}!\n(Hi·ªáu ·ª©ng: Gi·∫£m 1h tr∆∞·ªüng th√†nh)`);
                
                saveGame(); updateDisplay(); closeInteractionPopup();
            }
        };
    });

    showPopup('interaction-popup');
}
// --- S·ª∞ KI·ªÜN CLICK M√ÇY ƒêEN (SHOP ƒê·ªîI ƒê·ªí TREO) ---
const eventCloud = document.getElementById("event-cloud");
if (eventCloud) {
    eventCloud.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        
        const myCrowns = ownedArtifacts['vuong_mien'] || 0;
        const MAX_EXCHANGE = 5; 

        // --- 1. HEADER S·ª∞ KI·ªÜN ---
        interactionTitle.innerHTML = "üéâ Shop S·ª± Ki·ªán";
        interactionText.style.display = 'block';
        interactionText.innerHTML = `
            <div style="
                background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); 
                padding: 12px; 
                border-radius: 15px; 
                margin-bottom: 15px; 
                text-align: center; 
                border: 2px solid #f48fb1;
                box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            ">
                <div style="color: #880E4F; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; font-weight:bold;">
                    üëë V∆∞∆°ng Mi·ªán C·ªßa B·∫°n
                </div>
                <div style="font-size: 2em; font-weight: 800; color: #C2185B; text-shadow: 1px 1px 0px rgba(255,255,255,0.5);">
                    ${myCrowns.toLocaleString('vi-VN')}
                </div>
            </div>
        `;
        
        interactionControls.innerHTML = '';
        
        // --- 2. CONTAINER D·∫†NG L∆Ø·ªöI ---
        const shopContainer = document.createElement('div');
        shopContainer.style.cssText = `
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            max-height: 380px; 
            overflow-y: auto; 
            padding: 4px;
        `;

        HANGING_ITEMS_CONFIG.forEach(item => {
            const currentOwned = ownedDecorations[item.id] || 0;
            const isMaxed = currentOwned >= MAX_EXCHANGE; 
            const canAfford = myCrowns >= item.price;     

            // T·∫°o Card
            const itemCard = document.createElement('div');
            // Th√™m min-height ƒë·ªÉ c√°c √¥ b·∫±ng nhau tƒÉm t·∫Øp
            itemCard.style.cssText = `
                background: white;
                border: 1px solid ${isMaxed ? '#eee' : '#f8bbd0'};
                border-radius: 12px;
                padding: 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                position: relative;
                overflow: hidden;
                transition: transform 0.1s;
                height: 200px; /* C·ªê ƒê·ªäNH CHI·ªÄU CAO CARD */
            `;
            if(isMaxed) itemCard.style.opacity = "0.7";

            // Badge gi·∫£m gi·ªù
            const speedUpItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
            let badgeHTML = "";
            if (speedUpItems.includes(item.id)) {
                badgeHTML = `<div style="
                    position: absolute; top: 0; left: 0; 
                    background: #E3F2FD; color: #1565C0; 
                    font-size: 0.65em; font-weight: bold; 
                    padding: 3px 8px; border-bottom-right-radius: 8px; z-index:2;
                ">‚ö° -1 Gi·ªù</div>`;
            }

            let btnText = "ƒê·ªïi Ngay";
            let btnBg = "linear-gradient(45deg, #EC407A, #D81B60)";
            let btnCursor = "pointer";
            let btnDisabled = false;

            if (isMaxed) {
                btnText = "ƒê√£ Max";
                btnBg = "#9E9E9E"; 
                btnCursor = "default";
                btnDisabled = true;
            } else if (!canAfford) {
                btnText = "Thi·∫øu Ti·ªÅn";
                btnBg = "#cfd8dc"; 
                btnCursor = "not-allowed";
                btnDisabled = true;
            }

            // --- PH·∫¶N S·ª¨A CH√çNH ·ªû ƒê√ÇY ---
            itemCard.innerHTML = `
                ${badgeHTML}
                
                <div style="
                    width: 100%; 
                    height: 80px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    margin-top: 5px;
                    margin-bottom: 5px;
                ">
                    <img src="${item.img}" style="
                        max-width: 100%; 
                        max-height: 100%; 
                        object-fit: contain; 
                        filter: drop-shadow(0 4px 4px rgba(0,0,0,0.15));
                    ">
                </div>
                
                <div style="text-align: center; width: 100%; flex: 1; display: flex; flex-direction: column; justify-content: center;">
                    <div style="
                        font-weight: 700; color: #3e2723; font-size: 0.9em; 
                        margin-bottom: 2px;
                        overflow: hidden; text-overflow: ellipsis; 
                        display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;
                    ">
                        ${item.name}
                    </div>
                    <div style="color: #C2185B; font-weight: bold; font-size: 0.95em;">
                        üëë ${item.price}
                    </div>
                    <div style="font-size: 0.75em; color: #757575;">
                        ƒê√£ c√≥: <b>${currentOwned}/${MAX_EXCHANGE}</b>
                    </div>
                </div>

                <button class="btn-exchange-event" data-id="${item.id}" ${btnDisabled ? 'disabled' : ''}
                    style="
                        width: 100%;
                        background: ${btnBg}; 
                        color: white; 
                        border: none; 
                        padding: 8px 0; 
                        border-radius: 8px; 
                        font-weight: bold; 
                        font-size: 0.85em;
                        cursor: ${btnCursor};
                        box-shadow: ${btnDisabled ? 'none' : '0 3px 0 #880E4F'};
                        transition: transform 0.1s;
                        margin-top: auto; /* ƒê·∫©y n√∫t xu·ªëng ƒë√°y */
                    ">
                    ${btnText}
                </button>
            `;
            
            shopContainer.appendChild(itemCard);
        });

        interactionControls.appendChild(shopContainer);
        
        // --- 3. X·ª¨ L√ù CLICK ƒê·ªîI ƒê·ªí (Gi·ªØ nguy√™n logic) ---
        const buttons = shopContainer.querySelectorAll('.btn-exchange-event');
        buttons.forEach(btn => {
            btn.onclick = (e) => {
                const itemId = e.target.getAttribute('data-id');
                const itemData = HANGING_ITEMS_CONFIG.find(i => i.id === itemId);
                const currentOwned = ownedDecorations[itemId] || 0;

                if (currentOwned >= MAX_EXCHANGE) return; 

                if (ownedArtifacts['vuong_mien'] >= itemData.price) {
                    e.target.style.transform = "translateY(3px)";
                    e.target.style.boxShadow = "none";
                    setTimeout(() => {
                         if (confirm(`ƒê·ªïi ${itemData.price} V∆∞∆°ng Mi·ªán l·∫•y 1 ${itemData.name}?`)) {
                            ownedArtifacts['vuong_mien'] -= itemData.price;
                            if (!ownedDecorations[itemId]) ownedDecorations[itemId] = 0;
                            ownedDecorations[itemId]++;
                            
                            saveGame();
                            updateDisplay();
                            eventCloud.click(); 
                        } else {
                            e.target.style.transform = "translateY(0)";
                            e.target.style.boxShadow = "0 3px 0 #880E4F";
                        }
                    }, 100);
                }
            };
        });

        showPopup('interaction-popup');
    });
}
// --- H√ÄM M·ªû 3 L√î (PHI√äN B·∫¢N GRID ƒê·∫∏P) ---
function openInventory() {
    // 1. Ki·ªÉm tra n·∫øu ch∆∞a t·∫°o game th√¨ ch·∫∑n l·∫°i
    if (level === 0) { 
        alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); 
        return; 
    }

    // 2. C·∫≠p nh·∫≠t s·ªë ƒê·∫≠u v√† L√° tr√™n ƒë·∫ßu b·∫£ng
    const invDauEl = document.getElementById('inv-dau');
    const invLaEl = document.getElementById('inv-la');
    
    if (invDauEl) invDauEl.innerText = dau.toLocaleString('vi-VN');
    if (invLaEl) invLaEl.innerText = la.toLocaleString('vi-VN');

    // 3. ƒê·∫£m b·∫£o bi·∫øn kho ƒë·ªì t·ªìn t·∫°i
    if (typeof ownedArtifacts === 'undefined') { window.ownedArtifacts = {}; }

    // 4. DANH S√ÅCH C√ÅC V·∫¨T PH·∫®M S·∫º HI·ªÇN TH·ªä
    // (B·∫°n c√≥ th·ªÉ th√™m m√≥n m·ªõi v√†o danh s√°ch n√†y sau n√†y)
    const itemsToShow = [
        // --- Nguy√™n li·ªáu ---
        { id: 'manh_nguyen_to', name: 'M·∫£nh Ng.T·ªë',   img: '1000000135.png' },
        { id: 'manh_kim_loai', name: 'M·∫£nh Kim Lo·∫°i',img: '1000000136.png' },
        { id: 'vuong_mien',    name: 'V∆∞∆°ng Mi·ªán',    img: '1000000137.png' },
        { id: 'nhong_ong',     name: 'Nh·ªông Ong',     img: '1000000145.png' },
        // --- C√°c lo·∫°i c√° ---
        { id: 'ca_tre',        name: 'C√° Tr√™',        img: '1000000148.png' },
        { id: 'ca_do',         name: 'C√° D·ªì',         img: '1000000146.png' },
        { id: 'ca_tai_tuong',  name: 'C√° Tai T∆∞·ª£ng',  img: '1000000147.png' }
    ];

    // 5. T√¨m khung hi·ªÉn th·ªã v√† x√≥a n·ªôi dung c≈©
    const listContainer = document.getElementById('inventory-list');
    if (listContainer) {
        listContainer.innerHTML = ''; 
        
        // Quan tr·ªçng: ƒê·∫∑t l·∫°i display grid ƒë·ªÉ chia c·ªôt
        listContainer.style.display = 'grid'; 

        let hasItem = false; 

        // 6. Duy·ªát qua t·ª´ng m√≥n, n·∫øu c√≥ s·ªë l∆∞·ª£ng > 0 th√¨ v·∫Ω ra
        itemsToShow.forEach(item => {
            let qty = ownedArtifacts[item.id] || 0;
            
            if (qty > 0) {
                hasItem = true;
                let div = document.createElement('div');
                div.className = 'inventory-item';
                
                // V·∫Ω HTML cho t·ª´ng √¥ (·∫¢nh + T√™n + S·ªë l∆∞·ª£ng)
                div.innerHTML = `
                    <div class="inventory-img-box">
                        <img src="${item.img}" alt="${item.name}">
                    </div>
                    <div class="inventory-name">
                        ${item.name}
                    </div>
                    <div class="inventory-qty">
                        x${qty.toLocaleString('vi-VN')}
                    </div>
                `;
                listContainer.appendChild(div);
            }
        });

        // 7. N·∫øu t√∫i r·ªóng (kh√¥ng c√≥ m√≥n n√†o > 0)
        if (!hasItem) {
            listContainer.style.display = 'block'; // Chuy·ªÉn v·ªÅ block ƒë·ªÉ cƒÉn gi·ªØa th√¥ng b√°o
            listContainer.innerHTML = `
                <div style="text-align:center; padding:50px 20px; color:#bdbdbd;">
                    <div style="font-size:3em; margin-bottom:10px; opacity:0.5;">üéí</div>
                    <div>Ch∆∞a c√≥ v·∫≠t ph·∫©m n√†o.</div>
                </div>
            `;
        }
    }

    // 8. Hi·ªán Popup l√™n
    showPopup('inventory-box');
}
// --- CH·ª®C NƒÇNG GIFTCODE (ƒê√É T·ªêI ∆ØU) ---
// --- H√ÄM M·ªöI: D·ª´ng kh√≥i v√† x√≥a s·∫°ch kh√≥i ---
function stopSmokeEffect() {
    if (window.smokeInterval) {
        clearInterval(window.smokeInterval);
        window.smokeInterval = null;
    }
    // X√≥a ngay c√°c h·∫°t kh√≥i c√≤n s√≥t l·∫°i tr√™n m√†n h√¨nh
    document.querySelectorAll('.smoke-particle').forEach(el => el.remove());
}

// --- H√ÄM M·ªöI: Ki·ªÉm tra xem c√≥ n√™n hi·ªán H√≤m Th√≠nh kh√¥ng ---
function updateGiftcodeBoxState() {
    const box = document.getElementById('giftcode-supply-drop');
    if (!box) return;

    // Ki·ªÉm tra: C√≥ m√£ n√†o trong danh s√°ch ACTIVE m√† user ch∆∞a d√πng kh√¥ng?
    const hasUnusedCode = ACTIVE_GIFTCODES.some(code => !usedGiftcodes.includes(code));

    if (hasUnusedCode) {
        // N·∫øu c√≤n m√£ ch∆∞a d√πng -> Hi·ªán h√≤m v√† B·∫≠t kh√≥i
        box.style.display = 'block';
        startSmokeEffect(); 
    } else {
        // N·∫øu ƒë√£ d√πng h·∫øt s·∫°ch m√£ -> ·∫®n h√≤m v√† T·∫Øt kh√≥i ngay l·∫≠p t·ª©c
        box.style.display = 'none';
        stopSmokeEffect();
    }
}
function showGiftcodePopup() {
    if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
    const inputEl = document.getElementById('giftcode-input');
    if(inputEl) inputEl.value = ''; 
    showPopup('online-box');
}

function handleGiftcode() {
    const inputEl = document.getElementById('giftcode-input');
    const code = inputEl.value.trim().toUpperCase(); 

    if (!code) { alert("Vui l√≤ng nh·∫≠p m√£!"); return; }

    // Ki·ªÉm tra xem m√£ nh·∫≠p v√†o c√≥ n·∫±m trong danh s√°ch code active kh√¥ng
    if (ACTIVE_GIFTCODES.includes(code)) {
        if (usedGiftcodes.includes(code)) {
            alert("‚ùå B·∫°n ƒë√£ s·ª≠ d·ª•ng m√£ n√†y r·ªìi!");
        } else {
            // --- C·∫§U H√åNH PH·∫¶N TH∆Ø·ªûNG ---
            let bonusDau = 0;
            let bonusLa = 0;

            // Logic ph·∫ßn th∆∞·ªüng cho t·ª´ng m√£
            if (code === "FARMLOL") {
                bonusDau = 10000;
                bonusLa = 1000;
            }
            // N·∫øu c√≥ code kh√°c th√¨ th√™m: else if (code === "CODEKHAC") { ... }

            // C·ªông qu√†
            dau += bonusDau;
            la += bonusLa;
            usedGiftcodes.push(code); // L∆∞u m√£ ƒë√£ d√πng v√†o danh s√°ch
            
            saveGame();
            updateDisplay();
            hidePopup('online-box');
            
            // C·∫≠p nh·∫≠t l·∫°i kho n·∫øu ƒëang m·ªü
            if(document.getElementById('inventory-box').classList.contains('popup-active')){
                openInventory();
            }

            // --- QUAN TR·ªåNG: C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i h√≤m ngay l·∫≠p t·ª©c ---
            updateGiftcodeBoxState();

            // Th√¥ng b√°o
            if(typeof showToast === "function") {
                showToast(`Nh·∫≠n: ${bonusDau.toLocaleString()} ƒê·∫≠u + ${bonusLa.toLocaleString()} L√°`, "üéÅ", "Giftcode Th√†nh C√¥ng");
            } else {
                alert(`üéâ CH√öC M·ª™NG!\nNh·∫≠n: ${bonusDau.toLocaleString()} ƒê·∫≠u + ${bonusLa.toLocaleString()} L√°`);
            }
        }
    } else {
        alert("‚ùå M√£ Giftcode kh√¥ng ƒë√∫ng ho·∫∑c ƒë√£ h·∫øt h·∫°n!");
    }
}

// --- H·ªÜ TH·ªêNG KH√ìI & KH·ªûI T·∫†O GAME (ƒê√É S·ª¨A L·ªñI TH·ª™A CODE) ---

function spawnRedSmoke() {
    const box = document.getElementById('giftcode-supply-drop');
    if (!box) return; 

    const startTop = box.offsetTop; 
    const startLeft = box.offsetLeft; 
    const boxWidth = box.offsetWidth; 

    const smoke = document.createElement('div');
    smoke.className = 'smoke-particle';
    const randomDX = Math.floor(Math.random() * 50) - 25; 
    smoke.style.setProperty('--dx', `${randomDX}px`);
    const randomX = Math.random() * 14 - 7; 
    
    smoke.style.left = (startLeft + (boxWidth / 2) - 8 + randomX) + 'px'; 
    smoke.style.top = (startTop + 10) + 'px'; 

    document.querySelector('main').appendChild(smoke);
    setTimeout(() => { smoke.remove(); }, 2500);
}

function startSmokeEffect() {
    // N·∫øu ƒëang ch·∫°y r·ªìi th√¨ th√¥i, kh√¥ng t·∫°o th√™m v√≤ng l·∫∑p m·ªõi
    if (window.smokeInterval) return;
    
    window.smokeInterval = setInterval(() => {
        const box = document.getElementById('giftcode-supply-drop');
        // Ch·ªâ t·∫°o kh√≥i khi tab ƒëang hi·ªÉn th·ªã V√Ä H√≤m th√≠nh ƒëang hi·ªán (display != none)
        if(!document.hidden && box && box.style.display !== 'none') {
            spawnRedSmoke();
        }
    }, 150);
}

// Ch·ªâ gi·ªØ l·∫°i 1 d√≤ng onload duy nh·∫•t
// ======================================================
// --- T√çNH NƒÇNG: TH·ªåC ONG N√ôI GI·∫∫ ---
// ======================================================

// 1. H√†m ki·ªÉm tra: Hi·ªán ho·∫∑c ·∫®n t·ªï ong theo ng√†y
function checkBeeHiveSpawn() {
    const beeGuard = document.getElementById('bee-guard');
    if (!beeGuard) return;

    // N·∫øu ch∆∞a t·∫°o game (level 0) th√¨ c·ª© hi·ªán ƒë·ªÉ ng∆∞·ªùi ch∆°i th·∫•y
    if (level === 0) {
        beeGuard.style.display = 'block';
        return;
    }

    const now = new Date();
    const last = new Date(lastBeePokeTime);
    
    // Ki·ªÉm tra xem h√¥m nay ƒë√£ th·ªçc ch∆∞a (so s√°nh ng√†y/th√°ng/nƒÉm)
    const isSameDay = now.getDate() === last.getDate() && 
                      now.getMonth() === last.getMonth() && 
                      now.getFullYear() === last.getFullYear();

    if (isSameDay) {
        // ƒê√£ th·ªçc h√¥m nay -> ·∫®n ƒëi
        beeGuard.style.display = 'none';
    } else {
        // Qua ng√†y m·ªõi -> Hi·ªán l·∫°i
        beeGuard.style.display = 'block';
    }
}

// 2. H√†m hi·ªÉn th·ªã Popup khi b·∫•m v√†o ong
function showBeePopup() {
    if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }

    interactionTitle.innerHTML = "üêù T·ªï Ong N√πi Gi·∫ª";
    interactionText.style.display = 'block';
    
    // N·ªôi dung gi·ªõi thi·ªáu
    interactionText.innerHTML = `
        <div style="text-align:center;">
            <img src="1000000144.gif" style="width:80px; height:auto; margin-bottom:10px;">
            <div style="color:#5D4037; font-weight:bold;">Ph√°t hi·ªán m·ªôt t·ªï ong l·∫°!</div>
            <div style="font-size:0.9em; color:#795548;">
                B√™n trong c√≥ v·∫ª ch·ª©a <b>Nh·ªông Ong</b> qu√Ω hi·∫øm.
                <br>B·∫°n c√≥ mu·ªën l·∫•y n√≥ kh√¥ng?
            </div>
        </div>
    `;

    interactionControls.innerHTML = '';

    // T·∫°o n√∫t "Th·ªçc Ong"
    const btnPoke = document.createElement('button');
    btnPoke.className = 'btn-buy'; 
    btnPoke.style.background = 'linear-gradient(45deg, #FFC107, #FF9800)'; // M√†u v√†ng cam
    btnPoke.style.color = '#3e2723';
    btnPoke.style.border = '2px solid #fff';
    btnPoke.style.boxShadow = '0 4px 0 #F57C00';
    btnPoke.style.fontSize = '1.2em';
    btnPoke.style.padding = '12px';
    btnPoke.style.marginTop = '15px';
    btnPoke.innerHTML = "üëâ <b>Th·ªçc Ong</b>";

    // S·ª± ki·ªán khi b·∫•m n√∫t Th·ªçc
    btnPoke.onclick = () => {
        // 1. C·ªông 5 Nh·ªông Ong v√†o kho
        if (!ownedArtifacts['nhong_ong']) ownedArtifacts['nhong_ong'] = 0;
        ownedArtifacts['nhong_ong'] += 5;

        // 2. C·∫≠p nh·∫≠t th·ªùi gian ƒë√£ th·ªçc (ƒë·ªÉ t√≠nh 24h)
        lastBeePokeTime = Date.now();

        // 3. ƒê√≥ng popup
        hidePopup('interaction-popup');

        // 4. T·∫°o hi·ªáu ·ª©ng v·∫≠t ph·∫©m bay l√™n
        const beeGuard = document.getElementById('bee-guard');
        if(beeGuard) {
             const floater = document.createElement("div");
             floater.className = "floating-reward float-item";
             // S·ª≠ d·ª•ng ƒë√∫ng t√™n file ·∫£nh b·∫°n cung c·∫•p
             floater.innerHTML = `<img src="1000000145.png" style="width:35px; height:35px;"> +5 Nh·ªông`;
             
             // CƒÉn v·ªã tr√≠ bay t·ª´ con ong
             floater.style.top = (beeGuard.offsetTop) + "px";
             floater.style.left = (beeGuard.offsetLeft) + "px";
             floater.style.zIndex = "100";
             
             document.querySelector("main").appendChild(floater);
             
             // X√≥a hi·ªáu ·ª©ng sau 1.2 gi√¢y
             setTimeout(() => floater.remove(), 1200);
        }

        // 5. Th√¥ng b√°o
        if(typeof showToast === 'function') {
            showToast("ƒê√£ nh·∫≠n 5 Nh·ªông Ong!", "üêõ", "Th√†nh C√¥ng");
        } else {
            alert("B·∫°n nh·∫≠n ƒë∆∞·ª£c 5 Nh·ªông Ong! ƒê√£ chuy·ªÉn v√†o 3 L√¥.");
        }

        // 6. ·∫®n con ong ƒëi v√† L∆∞u game
        checkBeeHiveSpawn(); // H√†m n√†y s·∫Ω t·ª± ·∫©n ong v√¨ lastBeePokeTime v·ª´a c·∫≠p nh·∫≠t
        saveGame();
    };

    interactionControls.appendChild(btnPoke);
    showPopup('interaction-popup');
}
// --- LOGIC C√ÇU C√Å (PRO VERSION) ---
let fishingInterval = null;
let fishingTimerInterval = null;
let fishingWaitInterval = null;

// Bi·∫øn V·∫≠t L√Ω Ng∆∞·ªùi Ch∆°i (ƒê√É CH·ªàNH D·ªÑ H∆†N)
let bobberPos = 10;      
let bobberVelocity = 0;  
const GRAVITY = 0.15;    // R∆°i ch·∫≠m h∆°n
const JUMP_FORCE = 2.5;  // N·∫£y nh·∫π h∆°n

// Bi·∫øn V·∫≠t L√Ω M·ª•c Ti√™u (ƒê√É C·ªê ƒê·ªäNH)
let targetPos = 35;      // ƒê·ª©ng im ·ªü v·ªã tr√≠ 35%
let targetDirection = 0; 
let targetSpeed = 0;     
let changeDirCounter = 0; 

let catchProgress = 30;   // Ti·∫øn ƒë·ªô b·∫Øt (30% kh·ªüi ƒëi·ªÉm)
let gameTimeLeft = 15;    // Th·ªùi gian ch∆°i tƒÉng l√™n 15s

// Danh s√°ch C√° & T·ªâ l·ªá (Gi·ªØ nguy√™n)
const FISH_TYPES = [
    { id: 'ca_tre', name: 'C√° Tr√™', img: '1000000148.png', rate: 0.5 },
    { id: 'ca_do', name: 'C√° D·ªì', img: '1000000146.png', rate: 0.8 }, 
    { id: 'ca_tai_tuong', name: 'C√° Tai T∆∞·ª£ng', img: '1000000147.png', rate: 1.0 }
];

// 1. M·ªü b·∫£ng chu·∫©n b·ªã
function showFishingPrePopup() {
    if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
    
    // Reset HTML s·∫°ch s·∫Ω cho l·∫ßn ch∆°i m·ªõi
    document.getElementById('fishing-game-area').innerHTML = `
        <div id="fishing-bar-container">
            <div id="zone-green"></div>
            <div id="fishing-bobber"></div>
        </div>
        
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div style="font-size:0.7em; font-weight:bold; color:#0277BD; margin-bottom:5px;">TI·∫æN ƒê·ªò</div>
            <div id="catch-progress-container">
                <div id="catch-progress-fill"></div>
            </div>
        </div>
        
        <div id="fishing-timer">15s</div>
    `;

    document.getElementById('fishing-waiting').style.display = 'block';
    document.getElementById('fishing-start-ui').style.display = 'block';
    document.getElementById('fishing-waiting-anim').style.display = 'none';
    document.getElementById('fishing-game-area').style.display = 'none';
    document.getElementById('fishing-guide-text').style.display = 'none';
    
    const btnStart = document.getElementById('btn-start-fishing');
    if (typeof ownedArtifacts === 'undefined') ownedArtifacts = {};
    const nhongQty = ownedArtifacts['nhong_ong'] || 0;
    
    if (nhongQty > 0) {
        btnStart.innerHTML = `QuƒÉng C·∫ßn (C√≥: ${nhongQty})`;
        btnStart.disabled = false;
        btnStart.style.background = "#29B6F6";
        btnStart.style.cursor = "pointer";
        btnStart.onclick = startFishingWait;
    } else {
        btnStart.innerHTML = `Thi·∫øu Nh·ªông Ong!`;
        btnStart.disabled = true;
        btnStart.style.background = "#bdbdbd";
        btnStart.style.cursor = "not-allowed";
    }

    showPopup('fishing-popup');
}
// --- H√ÄM S·ª¨A L·ªñI: N√öT THO√ÅT C√ÇU C√Å ---
function closeFishingPopup() {
    // 1. D·ª´ng m·ªçi b·ªô ƒë·∫øm gi·ªù (ƒë·ªÉ game kh√¥ng ch·∫°y ng·∫ßm)
    if (fishingInterval) clearInterval(fishingInterval);
    if (fishingTimerInterval) clearInterval(fishingTimerInterval);
    if (fishingWaitInterval) clearInterval(fishingWaitInterval);

    // 2. G·ª° b·ªè s·ª± ki·ªán click/tap (ƒë·ªÉ kh√¥ng b·ªã l·ªói khi b·∫•m ra ngo√†i)
    document.removeEventListener('mousedown', fishingTap);
    document.removeEventListener('touchstart', fishingTap);

    // 3. ƒê√≥ng Popup
    hidePopup('fishing-popup');

    // 4. Reset l·∫°i giao di·ªán ch·ªù (ƒë·ªÉ l·∫ßn sau m·ªü l·∫°i ƒë·∫πp h∆°n)
    const guideText = document.getElementById('fishing-guide-text');
    if(guideText) guideText.style.display = 'none';
}
// 2. Giai ƒëo·∫°n ƒë·ª£i 3 gi√¢y (Gi·∫£m xu·ªëng 3s cho nhanh)
function startFishingWait() {
    if (!ownedArtifacts['nhong_ong']) ownedArtifacts['nhong_ong'] = 0;
    ownedArtifacts['nhong_ong']--;
    saveGame();
    
    document.getElementById('fishing-start-ui').style.display = 'none';
    document.getElementById('fishing-waiting-anim').style.display = 'block';
    
    let count = 3; // Gi·∫£m th·ªùi gian ch·ªù
    const countEl = document.getElementById('fishing-countdown');
    countEl.innerText = count;
    
    if (fishingWaitInterval) clearInterval(fishingWaitInterval);

    fishingWaitInterval = setInterval(() => {
        count--;
        countEl.innerText = count;
        if (count <= 0) {
            clearInterval(fishingWaitInterval);
            fishingWaitInterval = null;
            startFishingMinigame();
        }
    }, 1000);
}

// 3. B·∫Øt ƒë·∫ßu Minigame
function startFishingMinigame() {
    document.getElementById('fishing-waiting').style.display = 'none';
    document.getElementById('fishing-game-area').style.display = 'flex';
    document.getElementById('fishing-guide-text').style.display = 'block';
    document.getElementById('fishing-guide-text').innerHTML = "üëÜ <b>NH·∫§P LI√äN T·ª§C</b> ƒë·ªÉ gi·ªØ thanh cam n·∫±m trong v√πng xanh!";
    
    // Reset th√¥ng s·ªë game
    bobberPos = 20;
    bobberVelocity = 0;
    targetPos = 40; // V√πng xanh b·∫Øt ƒë·∫ßu ·ªü gi·ªØa
    catchProgress = 25; // Thanh ti·∫øn ƒë·ªô b·∫Øt ƒë·∫ßu th·∫•p
    gameTimeLeft = 15;
    
    document.addEventListener('mousedown', fishingTap);
    document.addEventListener('touchstart', fishingTap, {passive: false});
    
    if (fishingInterval) clearInterval(fishingInterval);
    fishingInterval = setInterval(gameLoop, 16); // 60 FPS
    
    if (fishingTimerInterval) clearInterval(fishingTimerInterval);
    fishingTimerInterval = setInterval(() => {
        gameTimeLeft--;
        const timerEl = document.getElementById('fishing-timer');
        if(timerEl) timerEl.innerText = gameTimeLeft + "s";
        
        if (gameTimeLeft <= 0) {
            endFishingGame(false); // H·∫øt gi·ªù m√† ch∆∞a ƒë·∫ßy thanh -> Thua
        }
    }, 1000);
}

// X·ª≠ l√Ω c√∫ ƒë·∫©y (Tap)
function fishingTap(e) {
    if(e.type === 'touchstart') e.preventDefault();
    // M·ªói l·∫ßn tap, v·∫≠n t·ªëc tƒÉng l√™n (bay l√™n)
    bobberVelocity = JUMP_FORCE; 
}

// Logic di chuy·ªÉn V√πng Xanh (ƒê√É C·ªê ƒê·ªäNH)
function updateTargetPosition() {
    // Lu√¥n gi·ªØ v√πng xanh ·ªü v·ªã tr√≠ 35%
    targetPos = 35; 

    const zoneEl = document.getElementById('zone-green');
    if(zoneEl) zoneEl.style.bottom = targetPos + "%";
}

// V√≤ng l·∫∑p ch√≠nh x·ª≠ l√Ω v·∫≠t l√Ω
function gameLoop() {
    // A. X·ª≠ l√Ω V√πng Xanh (C√° ch·∫°y)
    updateTargetPosition();

    // B. X·ª≠ l√Ω Thanh Cam (Ng∆∞·ªùi ch∆°i)
    bobberVelocity -= GRAVITY; // Tr·ªçng l·ª±c k√©o xu·ªëng
    bobberPos += bobberVelocity;
    
    // Gi·ªõi h·∫°n thanh cam trong ·ªëng
    if (bobberPos < 0) { bobberPos = 0; bobberVelocity = 0; } // Ch·∫°m ƒë√°y n·∫£y nh·∫π ho·∫∑c d·ª´ng
    if (bobberPos > 92) { bobberPos = 92; bobberVelocity = 0; } // Ch·∫°m ƒë·ªânh
    
    const bobberEl = document.getElementById('fishing-bobber');
    if(bobberEl) bobberEl.style.bottom = bobberPos + "%";
    
    // C. Ki·ªÉm tra va ch·∫°m (Thanh Cam c√≥ n·∫±m trong V√πng Xanh kh√¥ng?)
    // V√πng xanh cao kho·∫£ng 25% (80px/300px), Bobber cao kho·∫£ng 6%
    // Logic: Ki·ªÉm tra bottom c·ªßa 2 th·∫±ng
    // targetPos l√† bottom c·ªßa v√πng xanh. V√πng xanh cao ~25%.
    // bobberPos l√† bottom c·ªßa thanh cam.
    
    // ƒêi·ªÅu ki·ªán n·∫±m trong v√πng: Bobber cao h∆°n ƒë√°y v√πng xanh V√Ä th·∫•p h∆°n ƒë·ªânh v√πng xanh
    // ƒê·ªânh v√πng xanh = targetPos + 25
    // ƒê√°y bobber = bobberPos
    // ƒê·ªânh bobber = bobberPos + 6
    
    const zoneBottom = targetPos;
    const zoneTop = targetPos + 25;
    const bobberBottom = bobberPos;
    const bobberTop = bobberPos + 6;

    // Ki·ªÉm tra giao nhau
    const isOverlapping = (bobberTop > zoneBottom && bobberBottom < zoneTop);
    
    if (isOverlapping) {
        // TR√öNG: Thanh xanh s√°ng l√™n, tƒÉng ti·∫øn ƒë·ªô
        const zoneEl = document.getElementById('zone-green');
        if(zoneEl) {
            zoneEl.style.background = "rgba(118, 255, 3, 0.8)";
            zoneEl.style.boxShadow = "0 0 15px #76FF03";
        }
        catchProgress += 0.4; // TƒÉng ch·∫≠m ƒë·ªÉ game d√†i h∆°n x√≠u
    } else {
        // TR∆Ø·ª¢T: Thanh xanh m·ªù ƒëi, gi·∫£m ti·∫øn ƒë·ªô
        const zoneEl = document.getElementById('zone-green');
        if(zoneEl) {
            zoneEl.style.background = "rgba(118, 255, 3, 0.3)";
            zoneEl.style.boxShadow = "none";
        }
        catchProgress -= 0.3; // Gi·∫£m ph·∫°t
    }
    
    // Gi·ªõi h·∫°n thanh ti·∫øn ƒë·ªô
    if (catchProgress < 0) catchProgress = 0;
    if (catchProgress > 100) catchProgress = 100;
    
    // C·∫≠p nh·∫≠t giao di·ªán thanh ti·∫øn ƒë·ªô
    const progressFill = document.getElementById('catch-progress-fill');
    if(progressFill) {
        progressFill.style.height = catchProgress + "%";
        
        // ƒê·ªïi m√†u theo m·ª©c ƒë·ªô nguy hi·ªÉm
        if(catchProgress < 30) progressFill.style.background = "#F44336"; // ƒê·ªè (Nguy hi·ªÉm)
        else if(catchProgress < 70) progressFill.style.background = "#FF9800"; // Cam
        else progressFill.style.background = "#4CAF50"; // Xanh (T·ªët)
    }

    // D. Ki·ªÉm tra Th·∫Øng/Thua
    if (catchProgress >= 100) {
        endFishingGame(true);
    } else if (catchProgress <= 0 && gameTimeLeft < 13) {
        // Ch·ªâ thua n·∫øu thanh tu·ªôt v·ªÅ 0 SAU 2 gi√¢y ƒë·∫ßu ti√™n (ƒë·ªÉ tr√°nh v·ª´a v√†o game ƒë√£ thua)
        endFishingGame(false);
    }
}

// 4. K·∫øt th√∫c game
function endFishingGame(isWin) {
    clearInterval(fishingInterval);
    clearInterval(fishingTimerInterval);
    document.removeEventListener('mousedown', fishingTap);
    document.removeEventListener('touchstart', fishingTap);
    
    const gameArea = document.getElementById('fishing-game-area');
    const guideText = document.getElementById('fishing-guide-text');
    if(guideText) guideText.style.display = 'none';

    if (isWin) {
        // Random c√° (T·ªâ l·ªá x·ªãn h∆°n)
        const rand = Math.random();
        let fish = null;
        let starRating = "";
        
        if (rand < 0.5) { fish = FISH_TYPES[0]; starRating = "‚≠ê"; }      
        else if (rand < 0.85) { fish = FISH_TYPES[1]; starRating = "‚≠ê‚≠ê"; } 
        else { fish = FISH_TYPES[2]; starRating = "‚≠ê‚≠ê‚≠ê"; }                
        
        if (!ownedArtifacts[fish.id]) ownedArtifacts[fish.id] = 0;
        ownedArtifacts[fish.id]++;
        saveGame();
        
        gameArea.innerHTML = `
            <div style="text-align:center; animation:popInReward 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                <div style="font-size:3em; margin-bottom:5px;">üé£</div>
                <h2 style="color:#2E7D32; margin:0; text-transform:uppercase;">D√≠nh c√° r·ªìi!</h2>
                <div style="background:radial-gradient(circle, #fff, #B2DFDB); padding:10px; border-radius:50%; width:100px; height:100px; display:flex; align-items:center; justify-content:center; margin:10px auto; border:3px solid #009688;">
                    <img src="${fish.img}" style="width:80%; height:auto; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.3));">
                </div>
                <div style="font-size:1.3em; font-weight:900; color:#006064;">${fish.name}</div>
                <div style="color:#FFC107; font-size:1.2em; letter-spacing:2px; margin-bottom:5px;">${starRating}</div>
                <button onclick="showFishingPrePopup()" class="btn-buy" style="margin-top:10px; width:auto; padding:10px 25px; box-shadow:0 4px 0 rgba(0,0,0,0.2);">C√¢u Ti·∫øp</button>
            </div>
        `;
    } else {
        gameArea.innerHTML = `
            <div style="text-align:center; animation:shake 0.5s;">
                <div style="font-size:4em; margin:10px 0; opacity:0.7;">üåä</div>
                <h2 style="color:#c62828; margin:0;">S·∫®Y M·∫§T R·ªíI!</h2>
                <p style="color:#546E7A; font-weight:bold;">C√° qu√° m·∫°nh...</p>
                <div style="width:100%; height:2px; background:#cfd8dc; margin:15px 0;"></div>
                <button onclick="showFishingPrePopup()" class="btn-buy" style="width:auto; padding:10px 25px; background:#FF5722; box-shadow:0 4px 0 #D84315;">Th·ª≠ L·∫°i Ngay</button>
            </div>
            <style>@keyframes shake {0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); }}</style>
        `;
    }
}

function initializeGame(){
    // 1. T·∫£i d·ªØ li·ªáu
    loadGame(); 
    
    // 2. C√†i ƒë·∫∑t giao di·ªán
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if(isDarkMode) document.body.classList.add('dark-mode');
    adjustAppWrapperScale(); 
    
    // 3. C·∫≠p nh·∫≠t logic game
    updateFarmState(); 
    checkGlobalCrafting();
    checkIncubationState();

    // 4. Hi·ªÉn th·ªã
    updateDisplay(); 
    updateControlButtons(); 
    updateShop(); 
    updateBlacksmithVisuals(); 
    
    // 5. Kh·ªüi t·∫°o s·ª± ki·ªán
    initVineEvents();        
    initGrasshopperEvents(); 
    
    // 6. KI·ªÇM TRA S·ª∞ KI·ªÜN ƒê·∫∂C BI·ªÜT (QUAN TR·ªåNG)
    updateGiftcodeBoxState(); // Ki·ªÉm tra h√≤m th√≠nh
    checkBeeHiveSpawn();      // <--- B·ªî SUNG: G·ªçi ong ngay khi v√†o game
    
    // B·∫≠t kh√≥i n·∫øu h√≤m th√≠nh ƒëang hi·ªán
    const giftBox = document.getElementById('giftcode-supply-drop');
    if(giftBox && giftBox.style.display !== 'none') {
        startSmokeEffect();
    }
}

// --- V√íNG L·∫∂P GAME (Ch·∫°y m·ªói gi√¢y) ---
setInterval(() => {
    updateFarmState();        // C√¢y l·ªõn
    checkGlobalCrafting();    // Th·ª£ r√®n
    checkIncubationState();   // Tr·ª©ng n·ªü
    checkBeeHiveSpawn();      // <--- B·ªî SUNG: Ki·ªÉm tra ong li√™n t·ª•c m·ªói gi√¢y
}, 1000);

// --- T·ª∞ ƒê·ªòNG L∆ØU (M·ªói 60 gi√¢y) ---
setInterval(autoSave, 60000);
window.onload = initializeGame;
</script>
</body>
</html>
