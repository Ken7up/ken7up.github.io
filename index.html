<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Farm LOL - Pet Daily Reward</title>

<link rel="manifest" href="manifest.json"> 

<link rel="icon" type="image/png" href="1000000109.png">
<link rel="apple-touch-icon" href="1000000109.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root { 
    /* Palette m√†u t∆∞∆°i s√°ng */
    --bg-gradient: linear-gradient(180deg, #a1ffce 0%, #faffd1 100%);
    --primary: #4CAF50; 
    --primary-dark: #388E3C;
    --accent: #FF9800;
    --accent-dark: #F57C00;
    --text-main: #3e2723;
    --text-muted: #795548;
    
    /* UI Variables */
    --card-bg: rgba(255, 255, 255, 0.95);
    --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
    --btn-shadow: 0 4px 0px;
    --radius-lg: 20px;
    --radius-md: 12px;
    --radius-sm: 8px;
    
    /* Dark Mode Palette */
    --dark-bg-gradient: linear-gradient(180deg, #1a237e 0%, #311b92 100%);
    --dark-card-bg: rgba(30, 30, 40, 0.95);
    --dark-text: #e0e0e0;
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; 
    font-family: 'Fredoka', sans-serif; 
    background: #333; 
    color: var(--text-main); 
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    overflow: hidden;
    transition: background 0.3s;

    -webkit-user-select: none; 
    -moz-user-select: none;    
    -ms-user-select: none;     
    user-select: none;
  }

  /* --- APP CONTAINER (FIXED RATIO SCALING) --- */
  .app-wrapper {
    width: 400px; 
    height: 750px; 
    background: var(--bg-gradient);
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 50px rgba(0,0,0,0.5); 
    position: relative; 
    text-align: left; 
    
    /* Quan tr·ªçng cho vi·ªác Scale */
    transform-origin: top center; 
    transform: scale(1); 
    transition: transform 0.1s ease-out, background 0.3s;
    flex-shrink: 0;
    overflow: hidden; /* C·∫Øt ph·∫ßn th·ª´a n·∫øu c√≥ */
  }

  /* --- DARK MODE --- */
  body.dark-mode .app-wrapper {
    background: var(--dark-bg-gradient);
    color: var(--dark-text);
  }
  body.dark-mode .card-panel, 
  body.dark-mode #shop-box, 
  body.dark-mode #online-box, 
  body.dark-mode #pet-house-box, 
  body.dark-mode #interaction-popup, 
  body.dark-mode #seed-box {
      background: var(--dark-card-bg);
      color: var(--dark-text);
      border: 1px solid rgba(255,255,255,0.1);
  }

  /* --- MENU TOGGLE BTN --- */
  #menu-btn {
      position: absolute;
      top: 15px; left: 15px;
      width: 46px; height: 46px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-dark);
      font-size: 20px;
      cursor: pointer;
      z-index: 101; 
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  #menu-btn:active { transform: scale(0.9); }
  body.dark-mode #menu-btn { background: #311b92; color: white; border-color: #5c6bc0; }

  /* --- HEADER --- */
  header { 
      position: absolute;
      top: 15px; 
      left: 70px; 
      right: 15px;
      display: flex; 
      flex-direction: column; 
      align-items: center;    
      padding: 8px 15px; 
      background: rgba(255, 255, 255, 0.65); 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 20px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      z-index: 100; 
      border: 1px solid rgba(255,255,255,0.4);
      
      /* Animation */
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      transform-origin: left center;
      opacity: 1;
      transform: scaleX(1);
  }

  header.collapsed {
      opacity: 0;
      transform: scaleX(0) translateX(-20px);
      pointer-events: none;
  }

  .dark-mode header {
      background: rgba(20, 20, 30, 0.7);
      border-color: rgba(255,255,255,0.1);
      color: white;
  }

  .brand {
      display: flex; 
      flex-direction: column; 
      align-items: center;
      width: 100%;
      cursor: pointer;
      margin-bottom: 5px;
  }
  
  #player-level-display {
      font-size: 15px; font-weight: 700; color: var(--primary-dark);
      text-shadow: 0 1px 0 rgba(255,255,255,0.5);
  }
  .dark-mode #player-level-display { color: #81c784; text-shadow: none; }

  /* EXP BAR */
  #exp-bar-container {
    width: 120px; 
    height: 14px; /* TƒÉng chi·ªÅu cao l√™n 1 ch√∫t ƒë·ªÉ ch·ªØ d·ªÖ ƒë·ªçc h∆°n (c≈© l√† 6px) */
    background: rgba(0,0,0,0.2); 
    border-radius: 10px; 
    margin-top: 4px; 
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);

    /* QUAN TR·ªåNG: ƒê·ªÉ ƒë·ªãnh v·ªã d√≤ng ch·ªØ n·∫±m ƒë√® l√™n tr√™n */
    position: relative; 
}

/* CSS cho d√≤ng ch·ªØ hi·ªÉn th·ªã s·ªë EXP */
#exp-text-overlay {
    position: absolute;
    top: 0; left: 0; 
    width: 100%; height: 100%;
    display: flex; 
    align-items: center; 
    justify-content: center;

    /* Ch·ªânh font ch·ªØ cho ƒë·∫πp v√† r√µ */
    font-size: 9px; 
    font-weight: 800; 
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0,0,0,1); /* Vi·ªÅn ƒëen quanh ch·ªØ ƒë·ªÉ n·ªïi b·∫≠t */
    z-index: 2; /* ƒê·∫£m b·∫£o ch·ªØ n·∫±m tr√™n thanh m√†u xanh */
    pointer-events: none;
}
  #exp-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #66bb6a, #43a047);
      border-radius: 10px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* --- BUTTONS --- */
  button { font-family: 'Fredoka', sans-serif; }
  
  .controls { 
      display: flex; 
      flex-wrap: nowrap; 
      justify-content: center;
      width: 100%;
      gap: 6px;
  } 
  
  .controls button {
      font-size: 10px; font-weight: 700;
      padding: 5px 10px;
      margin: 0;
      border: none; border-radius: 20px;
      cursor: pointer;
      color: white;
      text-transform: uppercase;
      transition: transform 0.1s;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      white-space: nowrap;
  }
  
  .controls button:active { transform: translateY(2px); box-shadow: none; }

  #btn-new { background: #29b6f6; box-shadow: 0 2px 0 #0288d1; }
  #btn-delete { background: #ef5350; box-shadow: 0 2px 0 #d32f2f; }
  
  button:disabled { background: #bdbdbd !important; box-shadow: none !important; color: #757575 !important; cursor: not-allowed; transform: none !important; }

  /* --- MAIN GAME AREA --- */
  main { 
        flex: 1; display:flex; justify-content:center; 
        align-items:flex-start; 
        padding:0; 
        overflow: hidden;
        position: relative;
  }
  
  #beanstalk-bg {
    position: absolute; 
    top: 0; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 100%; 
    height: 100%;
    z-index: 3; 
    object-fit: cover;
  }

  /* UI Game Object Animations */
  @keyframes float { 0% { transform: translate(-50%, 0px); } 50% { transform: translate(-50%, -10px); } 100% { transform: translate(-50%, 0px); } }
  
  /* --- ANIMATION TH·ªû CHO PET (SQUASH & STRETCH) --- */
  @keyframes pet-breathing {
      0%, 100% { 
          /* Tr·∫°ng th√°i b√¨nh th∆∞·ªùng */
          transform: scale(1, 1); 
      }
      50% { 
          /* Hi·ªáu ·ª©ng x·∫πp ph·ªìng: B√® ngang (1.06) v√† th·∫•p xu·ªëng (0.94) */
          transform: scale(1.06, 0.94); 
      } 
  }

  /* --- ANIMATION THI√äN TH·∫¶N / TH·∫¶N CH·∫æT / BI GAI BAY THU HO·∫†CH --- */
  @keyframes angel-fly-harvest {
      0% { transform: translateX(0) scaleX(1); }
      45% { transform: translateX(340px) scaleX(1); } /* Bay sang ph·∫£i */
      50% { transform: translateX(340px) scaleX(-1); } /* Quay ƒë·∫ßu */
      95% { transform: translateX(0) scaleX(-1); } /* Bay v·ªÅ */
      100% { transform: translateX(0) scaleX(1); } /* Quay l·∫°i */
  }

.angel-harvesting {
    /* Th√™m !important ƒë·ªÉ b·∫Øt bu·ªôc ch·∫°y animation b·∫•t ch·∫•p m·ªçi th·ª© */
    animation: angel-fly-harvest 2s ease-in-out forwards !important;
    
    z-index: 100 !important;
    
    /* Gi·ªØ v·ªã tr√≠ absolute ƒë·ªÉ Pet c√≥ th·ªÉ bay ra kh·ªèi ch·∫≠u */
    position: absolute !important; 
    
    pointer-events: none; 
}

  /* --- CLASS M·ªöI ƒê·ªÇ K√çCH HO·∫†T HI·ªÜU ·ª®NG TH·ªû --- */
  .pet-breathing-effect {
      animation: pet-breathing 2s ease-in-out infinite;
  }

  #kinto-cloud {
      position: absolute; top: 30px; left: calc(60% + 15px); transform: translateX(-50%); 
      width: 45px;   /* TƒÉng t·ª´ 30px l√™n 45px cho d√†i ra */
      height: auto;  /* ƒê·ªïi th√†nh auto ƒë·ªÉ ·∫£nh kh√¥ng b·ªã m√©o */
      /* ---------------- */
      
      z-index: 10; cursor: pointer; 
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
  }
    /* --- CSS CHO M√ÇY S·ª∞ KI·ªÜN (M·ªöI) --- */
  #event-cloud {
      position: absolute; 
      top: 30px;               /* ƒê·∫∑t c√πng ƒë·ªô cao v·ªõi C√¢n ƒê·∫©u V√¢n */
      left: calc(60% + 75px);  /* ƒê·∫©y sang ph·∫£i m·ªôt ch√∫t ƒë·ªÉ kh√¥ng b·ªã che */
      transform: translateX(-50%); 
      
      width: 45px;             /* K√≠ch th∆∞·ªõc ·∫£nh */
      height: auto; 
      z-index: 10;             /* L·ªõp hi·ªÉn th·ªã cao ƒë·ªÉ b·∫•m ƒë∆∞·ª£c */
      cursor: pointer; 
      
      /* Hi·ªáu ·ª©ng bay (float) gi·ªëng h·ªát m√¢y shop */
      animation: float 3s ease-in-out infinite; 
      animation-delay: 1.5s;   /* Tr·ªÖ 1.5s ƒë·ªÉ 2 ƒë√°m m√¢y bay l·ªách nh·ªãp cho ƒë·∫πp */
      
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); /* T·∫°o b√≥ng ƒë·ªï nh·∫π */
  }
  
  /* Hi·ªáu ·ª©ng khi b·∫•m v√†o m√¢y (nh√∫n nh·∫π) */
  #event-cloud:active {
      transform: translateX(-50%) scale(0.9);
  }
  
  #light-bulb {
      position: absolute; 
      top: 15px; 
      left: calc(30% - 10px); 
      transform: translateX(-50%);
      z-index: 8; 
      cursor: pointer; 
      width: 60px; 
      height: auto;
      filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
  }

  #pet-house {
      position: absolute; bottom: 210px; left: 50%; transform: translateX(calc(-50% + 100px)); 
      width: 150px; height: auto; z-index: 7; cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #chaos-blacksmith {
      position: absolute; bottom: 260px; left: 50%; transform: translateX(calc(-50% - 130px));
      width: 90px; height: auto; z-index: 7; cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #chaos-blacksmith-working {
      position: absolute; 
      bottom: 270px; 
      left: 50%; 
      transform: translateX(calc(-50% - 130px));
      width: 60px; 
      height: auto; 
      z-index: 7; 
      cursor: pointer;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }
  
  #pug-pet {
      position: absolute; 
      bottom: 35px; 
      left: 50%; 
      transform: translateX(calc(-50% - 50px)); 
      width: 120px; 
      height: auto; 
      z-index: 7; 
      cursor: pointer;
      transform-origin: bottom center; 
      will-change: transform;
  }
  
  #bone-bowl {
      position: absolute; bottom: 130px; left: 50%; transform: translateX(calc(-50% + 110px)); 
      width: 50px; height: auto; z-index: 7; cursor: pointer; 
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
  }

  #pot-container {
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 100%; height: 100%; z-index: 5; display: flex; justify-content: center; pointer-events: none; 
  }

  .pot-slot {
      position: absolute; width: 50px; height: 50px; background: transparent; border: none; 
      display: flex; align-items: center; justify-content: center; 
      cursor: pointer; transition: transform 0.1s; pointer-events: auto; 
  }
  .pot-slot:hover { transform: scale(1.1); filter: brightness(1.1); }
  .pot-slot:active { transform: scale(0.95); }

  .pot-slot img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
  }
  
  .pot-base-img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
      transition: opacity 0.3s;
  }

  /* --- SLOT POSITIONS --- */
  /* Ch·ªânh v·ªã tr√≠ √¥ Slot 1 (gi·ªØ nguy√™n v·ªã tr√≠ √¥) */
  #slot-1 { 
      width: 50px; 
      height: 50px; 
      top: 140px; 
      left: calc(50% - 160px); 
  }

  /* --- V·ªä TR√ç ·∫¢NH PET ·ªû SLOT 1 (ƒê√É S·ª¨A C√ÇN ƒê·ªêI) --- */
  
  /* 1. C·∫•u h√¨nh chung m·∫∑c ƒë·ªãnh */
  #slot-1 img { 
      position: absolute;       
      z-index: 5;
      object-fit: contain; 
      transition: none !important;
      
      /* M·∫∑c ƒë·ªãnh an to√†n n·∫øu ch∆∞a load class */
      width: 100%; height: 100%; top: 0; left: 0;
  }

  /* 2. Class ri√™ng cho QU·∫¢ TR·ª®NG (To, n·∫±m tr·ªçn trong ch·∫≠u) */
  .fix-egg {
      width: 150% !important;
      height: 120% !important;
      top: -18% !important;    /* ƒê·∫©y l√™n m·ªôt ch√∫t */
      left: -35% !important;    /* CƒÉn gi·ªØa */
  }

  /* 3. Class ri√™ng cho THI√äN TH·∫¶N (C·∫ßn to v√† bay cao h∆°n) */
  .fix-angel {
      width: 145% !important;   /* To h∆°n ƒë·ªÉ th·∫•y r√µ c√°nh */
      height: 145% !important;
      top: -35% !important;     /* Bay cao h·∫≥n l√™n */
      left: -35% !important;
  }

  /* 4. Class ri√™ng cho TH·∫¶N CH·∫æT (D√°ng cao, g·∫ßy) */
  .fix-reaper {
      width: 290% !important;
      height: 150% !important;
      top: -40% !important;
      left: -100% !important;
  }

  /* 5. Class ri√™ng cho BI GAI (Nh·ªè, tr√≤n, c·∫ßn n·∫±m th·∫•p) */
  .fix-bigai {
      width: 120% !important;   /* K√≠ch th∆∞·ªõc v·ª´a v·∫∑n */
      height: 110% !important;
      top: -30% !important;      /* N·∫±m g·∫ßn mi·ªáng ch·∫≠u */
      left: -20% !important;      /* CƒÉn gi·ªØa tuy·ªát ƒë·ªëi */
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.6)); /* Th√™m h√†o quang nh·∫π */
  }
  
  #slot-6 { width: 50px; height: 35px; top: 335px; left: calc(50% - 30px + 10px + 15px); }
  #slot-6 img { width: 130%; height: 130%; top: -15px; left: -10px; }
  
  #slot-2, #slot-3, #slot-4, #slot-5, #slot-7 { width: 35px; height: 35px; }
  #slot-2 img, #slot-3 img, #slot-4 img, #slot-5 img, #slot-7 img { width: 130%; height: 130%; top: -5px; left: -5px; }
  
  .seed-image {
      width: 140% !important; 
      height: auto !important; 
      max-height: 120px !important; 
      object-fit: contain; 
      position: absolute; 
      bottom: 27px !important;  
      top: auto !important;     
      left: 50% !important;
      transform: translateX(-50%) !important; 
      z-index: 6;
      pointer-events: none;
      transition: all 0.3s ease; 
  }

  /* --- V·ªä TR√ç C√ÅC √î ƒê·∫§T --- */
  #slot-2 { top: 155px; left: calc(50% - 90px - 10px); }
  #slot-3 { top: 155px; left: calc(50% - 30px - 10px); } 
  #slot-4 { top: 155px; left: calc(50% + 30px - 10px); }
  #slot-5 { top: 155px; left: calc(50% + 90px - 10px); }
  #slot-7 { top: 155px; left: calc(50% + 150px - 10px); }


  /* --- POPUPS (MODALS) --- */
  .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); backdrop-filter: blur(3px);
      
      z-index: 990; /* T·∫ßng 1: N·∫±m ngay d∆∞·ªõi c√°c c·ª≠a s·ªï Popup */
      
      display: none;
  }

  /* Danh s√°ch t·∫•t c·∫£ c√°c Popup trong game */
  #shop-box, #online-box, #pet-house-box, #interaction-popup, 
  #seed-box, #name-box, #inventory-box, #fishing-popup {
    position: fixed; top: 50%; left: 50%; 
    transform: translate(-50%, -50%) scale(0.9); 
    background: var(--card-bg);
    width: 90%; max-width: 320px;
    padding: 20px; 
    border-radius: var(--radius-lg); 
    box-shadow: var(--card-shadow); 
    
    z-index: 1000; /* T·∫ßng 2: Cao h∆°n n·ªÅn game v√† l·ªõp m·ªù */
    
    text-align: center; 
    border: 4px solid white;
    opacity: 0; pointer-events: none; 
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .popup-active {
      transform: translate(-50%, -50%) scale(1) !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      display: block !important;
  }

  h3 { 
      margin: 0 0 15px 0; color: var(--primary-dark); font-size: 1.2em; 
      text-transform: uppercase; letter-spacing: 1px;
  }
  .dark-mode h3 { color: #81c784; }

  hr { border: 0; border-top: 2px dashed #ddd; margin: 15px 0; }

  .btn-close, button[onclick*="none"] {
      margin-top: 15px;
      padding: 8px 25px;
      background: #f44336;
      color: white;
      border: none; border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 3px 0 #d32f2f;
      cursor: pointer;
      width: 100%;
      font-size: 0.9em;
  }
  .btn-close:active, button[onclick*="none"]:active { transform: translateY(4px); box-shadow: none; }
  .btn-remove-vines {
    width: 100%;
    margin-top: 10px;
    padding: 8px;
    background: #ff5252; /* M√†u ƒë·ªè */
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 0 #d32f2f;
    transition: all 0.1s;
}
.btn-remove-vines:active {
    transform: translateY(3px);
    box-shadow: none;
}

  /* --- SHOP ITEMS (GRID) --- */
  .shop-item, .pet-shop-item {
      background: white;
      border: 1px solid #eee;
      border-radius: var(--radius-md);
      padding: 10px;
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;
  }
  .dark-mode .shop-item, .dark-mode .pet-shop-item { background: #2c2c35; border-color: #444; }

  .shop-item:hover, .pet-shop-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

  .btn-buy, .btn-buy-pet, .btn-plant-now, .btn-equip-pot, .btn-crafting {
      width: 100%; border: none; border-radius: 8px;
      padding: 6px; margin-top: 8px;
      font-weight: 700; font-size: 11px;
      color: white; cursor: pointer;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      transition: all 0.1s;
  }
  .btn-buy:active, .btn-plant-now:active { transform: translateY(2px); box-shadow: none; }
  
  .btn-buy, .btn-plant-now { background: var(--accent); box-shadow: 0 2px 0 var(--accent-dark); }
  /* Override btn-plant-now specific color if needed, but keeping accent is fine */

  /* --- TABS --- */
  .tab-container {
      background: #f5f5f5; padding: 4px; border-radius: 12px;
      display: flex; gap: 5px; margin-bottom: 15px; border: none;
  }
  .dark-mode .tab-container { background: #2a2a35; }

  .tab-btn {
      flex: 1; padding: 8px; border-radius: 8px; border: none;
      background: transparent; color: #777; font-weight: 600; font-size: 0.9em;
      transition: all 0.2s; cursor: pointer;
  }
  .tab-btn.active {
      background: white; color: var(--primary);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .dark-mode .tab-btn.active { background: #4caf50; color: white; }

  /* --- BLACKSMITH TABLE --- */
  .blacksmith-table { display: block; width: 100%; }
  .blacksmith-table thead { display: none; } 
  .blacksmith-table tbody { display: flex; flex-direction: column; gap: 10px; }
  .blacksmith-table tr {
      display: flex; align-items: center; justify-content: space-between;
      background: #fff; padding: 8px; border-radius: 12px;
      border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .dark-mode .blacksmith-table tr { background: #2c2c35; border-color: #444; }

  .blacksmith-table td { border: none !important; padding: 0 5px !important; display: block; }
  
  .blacksmith-table td:first-child { flex: 1; }
  .blacksmith-recipe { display: flex; align-items: center; gap: 10px; }
  
  .blacksmith-table td:nth-child(2) { flex: 2; font-size: 0.8em; }
  
  .blacksmith-table td:last-child { flex: 1; text-align: right; }

  .req-status-ok { color: var(--primary); font-weight: 700; }
  .req-status-fail { color: #f44336; }

  /* --- INPUT NAME BOX --- */
  #name-box input {
      width: 100%; padding: 10px; margin: 15px 0;
      border: 2px solid #ddd; border-radius: 10px;
      font-family: inherit; font-size: 14px; text-align: center;
      outline: none; transition: border 0.3s;
  }
  #name-box input:focus { border-color: var(--primary); }
  #btn-next {
      background: var(--primary); color: white;
      padding: 10px 30px; border-radius: 30px;
      font-size: 14px; font-weight: bold; border: none;
      box-shadow: 0 3px 0 var(--primary-dark);
  }
  #btn-next:active { transform: translateY(3px); box-shadow: none; }

  /* --- SCROLLBAR --- */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: #aaa; }

    /* --- CSS CHO C√ÇY TO --- */
  .seed-image.big-plant {
      width: 220% !important;        
      max-height: 250px !important;  
      bottom: 27px !important;       
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); 
      z-index: 10;                   
  }
    /* --- CSS FIX RI√äNG CHO C√ÇY T√åNH Y√äU --- */
  .seed-image.big-plant.love-fix {
      width: 120% !important;        
      max-height: 160px !important;  
      bottom: 26px !important;       
      /* ƒê√É S·ª¨A: ƒê·ªïi sang m√†u h·ªìng ƒë·∫≠m (DeepPink) v√† tƒÉng ƒë·ªô r√µ n√©t */
      filter: drop-shadow(0 5px 10px rgba(255, 20, 147, 0.85)); 
      z-index: 10;
  }
    /* --- CSS M·ªöI: C√¢y T√¨nh Y√™u giai ƒëo·∫°n v·ª´a (Stage 1) --- */
  /* Class n√†y s·∫Ω gi√∫p c√¢y nh·ªè h∆°n v√† b√≥ng g·ªçn h∆°n so v·ªõi giai ƒëo·∫°n thu ho·∫°ch */
  .seed-image.medium-plant.love-fix {
      width: 100% !important;        /* Nh·ªè h∆°n m·ª©c 120% c·ªßa giai ƒëo·∫°n l·ªõn */
      max-height: 130px !important;  /* Gi·ªõi h·∫°n chi·ªÅu cao th·∫•p h∆°n (g·ªëc l√† 160px) */
      bottom: 27px !important;
      /* B√≥ng m√†u h·ªìng nh∆∞ng nh·ªè h∆°n, g·∫ßn g·ªëc h∆°n */
      filter: drop-shadow(0 3px 7px rgba(255, 20, 147, 0.8)) !important;
      z-index: 9;
  }
    /* --- CSS CHO C√ÇY GIAI ƒêO·∫†N TR∆Ø·ªûNG TH√ÄNH (STAGE 1 - SIZE V·ª™A) --- */
  .seed-image.medium-plant {
      width: 160% !important;        /* Nh·ªè h∆°n 220% c·ªßa big-plant */
      max-height: 180px !important;  
      bottom: 27px !important;       
      z-index: 9;                   
      transition: all 0.3s ease;
  }

  /* Ch·ªânh b√≥ng ri√™ng cho C√¢y Kim Lo·∫°i giai ƒëo·∫°n v·ª´a (nh·∫°t h∆°n v√† nh·ªè h∆°n) */
  .seed-image.medium-plant.shadow-metal {
      filter: drop-shadow(0 3px 5px rgba(60, 60, 60, 0.8)) !important;
  }

  /* Ch·ªânh b√≥ng ri√™ng cho C√¢y Nguy√™n T·ªë giai ƒëo·∫°n v·ª´a (nh·∫°t h∆°n v√† nh·ªè h∆°n) */
  .seed-image.medium-plant.shadow-element {
      filter: drop-shadow(0 3px 5px rgba(171, 71, 188, 0.7)) !important;
  }
    /* --- CSS B√ìNG CHO C√ÇY (M·ªöI TH√äM) --- */
  
  /* 1. B√≥ng xanh l√° cho M·∫ßm Nh·ªè (Giai ƒëo·∫°n 0) */
  .seed-image.shadow-green {
      filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.8)) !important;
  }

  /* 2. B√≥ng x√°m cho C√¢y Kim Lo·∫°i (Giai ƒëo·∫°n l·ªõn) */
  .seed-image.big-plant.shadow-metal {
      /* ƒê√É S·ª¨A: ƒê·ªïi sang m√†u x√°m ƒëen ƒë·∫≠m ƒë·∫∑c h∆°n */
      filter: drop-shadow(0 5px 10px rgba(60, 60, 60, 1.0)) !important;
  }

  /* 3. B√≥ng t√≠m cho C√¢y Nguy√™n T·ªë (Giai ƒëo·∫°n l·ªõn) */
  .seed-image.big-plant.shadow-element {
      filter: drop-shadow(0 5px 10px rgba(171, 71, 188, 0.8)) !important;
  }

  /* --- [M·ªöI] B√≥ng V√†ng Cam cho C√¢y M·∫≠t Ong --- */
  
  /* Giai ƒëo·∫°n 1 (C√¢y v·ª´a): B√≥ng v√†ng nh·∫π */
  .seed-image.medium-plant.shadow-honey {
      filter: drop-shadow(0 3px 6px rgba(255, 179, 0, 0.8)) !important;
  }

  /* Giai ƒëo·∫°n 2 (Thu ho·∫°ch): B√≥ng cam ƒë·∫≠m, to */
  .seed-image.big-plant.shadow-honey {
      filter: drop-shadow(0 5px 12px rgba(255, 111, 0, 1.0)) !important; 
  }

  /* --- CSS CHO QU√Ä T·∫∂NG H√ÄNG NG√ÄY (Daily Reward) --- */
  .daily-reward-bubble {
    position: absolute;
    width: 300px; /* K√≠ch th∆∞·ªõc ·∫£nh qu·∫£ ƒë√†o */
    height: 30px;
    z-index: 90; /* Cao h∆°n pet, th·∫•p h∆°n popup */
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: popInReward 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); /* Hi·ªáu ·ª©ng ph√°t s√°ng nh·∫π */
}

/* Hi·ªáu ·ª©ng xu·∫•t hi·ªán */
@keyframes popInReward {
    0% { transform: scale(0) translateY(20px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

/* Hi·ªáu ·ª©ng bay l√™n khi nh·∫≠n xong */
@keyframes flyUpReward {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
}
/* --- CSS CHO ICON ·∫§P TR·ª®NG (ü¶¢) --- */
  #incubator-icon {
      position: absolute;
      
      /* CƒÉn ch·ªânh v·ªã tr√≠: ƒê·∫∑t l·∫°i top cho ph√π h·ª£p v·ªõi k√≠ch th∆∞·ªõc m·ªõi */
      top: -18px;                   /* ƒê√£ s·ª≠a: ƒê·∫©y th·∫•p xu·ªëng m·ªôt ch√∫t cho g·∫ßn tr·ª©ng h∆°n (c≈© l√† -35px) */
      left: 40%;
      transform: translateX(-50%);  /* CƒÉn gi·ªØa ngang */
      
      /* Giao di·ªán: K√≠ch th∆∞·ªõc nh·ªè l·∫°i */
      font-size: 10px;              /* ƒê√£ s·ª≠a: Nh·ªè l·∫°i (c≈© l√† 40px) */
      z-index: 20;
      
      /* Hi·ªáu ·ª©ng: C·ªë ƒë·ªãnh (B·ªè animation float) */
      /* animation: float 2s ease-in-out infinite; */ /* <-- ƒê√£ comment d√≤ng n√†y ƒë·ªÉ t·∫Øt hi·ªáu ·ª©ng bay */
      
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
      pointer-events: none;
  }
/* --- CODE M·ªöI CHO 3 L√î (BALO) --- */
#backpack-slot {
    position: absolute;
    width: 20px;       /* K√≠ch th∆∞·ªõc t√∫i */
    height: 60px;
    top: 320px;        /* ƒê·ªô cao (ngang t·∫ßm v·ªõi em b√© c√¢u c√°) */
    left: 175px;        /* N·∫±m b√™n tr√°i m√†n h√¨nh (ho·∫∑c ch·ªânh s·ªë n√†y ƒë·ªÉ d·ªùi v·ªã tr√≠) */
    z-index: 10;
    cursor: pointer;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); /* ƒê·ªï b√≥ng cho ƒë·∫πp */
    transition: transform 0.2s;
}
#backpack-slot:hover { transform: scale(1.1); } /* Ph√≥ng to khi di chu·ªôt v√†o */
#backpack-slot img { width: 100%; height: 100%; object-fit: contain; }

/* T√πy ch·ªânh danh s√°ch v·∫≠t ph·∫©m trong kho */
.inventory-item {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #eee;
    margin-bottom: 8px;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 2px rgba(0,0,0,0.05);
}
/* --- CSS CHO TOAST NOTIFICATION (PHI√äN B·∫¢N PRO) --- */
  #toast-notification {
      position: fixed;
      bottom: 140px;           
      left: 50%;
      transform: translateX(-50%) scale(0.8);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(76, 175, 80, 0.3); 
      border-left: 6px solid #4CAF50; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
      backdrop-filter: blur(5px); 
      
      display: flex;
      align-items: center;
      gap: 15px;
      
      z-index: 3000 !important; /* T·∫ßng 5 (Cao nh·∫•t): Lu√¥n nh√¨n th·∫•y th√¥ng b√°o */
      
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      white-space: nowrap;
  }

#toast-notification .toast-icon {
    font-size: 24px;
    background: #e8f5e9;
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
}

#toast-notification .toast-content {
    display: flex;
    flex-direction: column;
    text-align: left;
}

#toast-notification .toast-title {
    font-weight: 800;
    font-size: 0.9em;
    text-transform: uppercase;
    color: #4CAF50;
    letter-spacing: 1px;
}

#toast-notification .toast-message {
    font-size: 1em;
    font-weight: 600;
    color: #333;
}

/* Class k√≠ch ho·∫°t hi·ªáu ·ª©ng */
#toast-notification.show {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    animation: toastBounce 3s forwards;
}

@keyframes toastBounce {
    0%   { transform: translate(-50%, 20px) scale(0.8); opacity: 0; }
    10%  { transform: translate(-50%, 0px) scale(1); opacity: 1; }
    90%  { transform: translate(-50%, 0px) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -50px) scale(0.9); opacity: 0; }
}
/* --- HI·ªÜU ·ª®NG V·∫¨T PH·∫®M BAY L√äN (FLOATING REWARDS) --- */
  .floating-reward {
      position: absolute;
      
      z-index: 1500; /* T·∫ßng 3: Bay l∆° l·ª≠ng tr√™n c√°c Popup */
      
      font-weight: 900;
      font-size: 15px;
      pointer-events: none; 
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
      animation: floatUpFade 1.2s ease-out forwards;
  }

/* Animation: Ph√≥ng to nh·∫π -> Bay l√™n -> M·ªù d·∫ßn */
@keyframes floatUpFade {
    0% { transform: translateY(0) scale(0.8); opacity: 0; }
    20% { transform: translateY(-15px) scale(1.2); opacity: 1; }
    80% { opacity: 1; }
    100% { transform: translateY(-80px) scale(1); opacity: 0; }
}

/* M√†u s·∫Øc ri√™ng cho t·ª´ng lo·∫°i */
.float-exp { color: #2E7D32; } /* Xanh l√° ƒë·∫≠m */
.float-item { color: #E65100; } /* Cam ƒë·∫≠m */
/* --- CSS CHO H√íM TH√çNH GIFTCODE (ƒê√É S·ª¨A TO H∆†N) --- */
#giftcode-supply-drop {
    position: absolute;
    width: 40px; /* ƒê√£ tƒÉng t·ª´ 40px l√™n 50px cho ho√†nh tr√°ng */
    height: auto;
    
    /* CƒÉn ch·ªânh l·∫°i v·ªã tr√≠ m·ªôt ch√∫t cho c√¢n ƒë·ªëi v·ªõi k√≠ch th∆∞·ªõc m·ªõi */
    top: 400px; 
    left: 340px; 
    
    z-index: 12; /* N·ªïi l√™n tr√™n m·∫∑t n∆∞·ªõc */
    cursor: pointer;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
}

/* Giao di·ªán √¥ nh·∫≠p Giftcode */
#giftcode-input {
    width: 100%;
    padding: 12px;
    margin: 15px 0;
    border: 2px dashed #FF9800;
    border-radius: 10px;
    font-size: 16px;
    text-align: center;
    color: #E65100;
    font-weight: bold;
    text-transform: uppercase; /* T·ª± ƒë·ªông vi·∫øt hoa */
    outline: none;
    background: #FFF3E0;
}
#giftcode-input:focus {
    border-color: #E65100;
    background: #fff;
}
/* --- HI·ªÜU ·ª®NG KH√ìI ƒê·ªé SIGNAL (REALISTIC & R√ï N√âT) --- */
.smoke-particle {
    position: absolute;
    width: 16px;  /* K√≠ch th∆∞·ªõc c∆° b·∫£n to h∆°n x√≠u */
    height: 16px;
    
    /* Gradient 3 l·ªõp: T√¢m cam s√°ng -> ƒê·ªè ƒë·∫≠m -> Vi·ªÅn trong su·ªët */
    background: radial-gradient(circle, #ff5722 10%, #d50000 45%, rgba(255,0,0,0) 70%);
    
    border-radius: 50%;
    pointer-events: none;
    z-index: 11;
    opacity: 0;
    
    /* B·∫Øt ƒë·∫ßu √≠t blur ƒë·ªÉ r√µ n√©t, sau ƒë√≥ s·∫Ω blur d·∫ßn trong keyframes */
    filter: blur(2px); 
    
    /* Th·ªùi gian bay l√¢u h∆°n (2.5s) ƒë·ªÉ c·ªôt kh√≥i cao h∆°n */
    animation: smokeRise 2.5s ease-out forwards; 
}

@keyframes smokeRise {
    0% {
        transform: translate(0, 0) scale(0.5);
        opacity: 0;
    }
    10% {
        /* Hi·ªán ra nhanh v√† r√µ */
        opacity: 1; 
        transform: translate(0, -20px) scale(1);
    }
    100% {
        /* Bay l√™n r·∫•t cao (-220px), ph√¨nh to g·∫•p 6 l·∫ßn, v√† t·∫£n ra theo gi√≥ (var --dx) */
        transform: translate(var(--dx), -220px) scale(6); 
        opacity: 0;
        filter: blur(12px); /* L√™n cao th√¨ nh√≤e ƒëi nh∆∞ kh√≥i th·∫≠t */
    }
}
#bee-guard {
    position: absolute;
    width: 15px;              
    height: auto;
    top: 233px;               
    left: calc(50% - 166px);  
    z-index: 15;
    cursor: pointer;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
}

/* V·∫´n gi·ªØ hi·ªáu ·ª©ng nh√∫n khi b·∫•m v√†o */
#bee-guard:active {
    transform: scale(0.9);
}

/* Hi·ªáu ·ª©ng khi b·∫•m v√†o th√¨ nh√∫n nh·∫π */
#bee-guard:active {
    transform: scale(0.9);
}
/* --- CSS CHO MINIGAME C√ÇU C√Å (PRO VERSION) --- */
#fishing-popup {
    background: #E0F7FA;
    border: 4px solid #0277BD;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    font-family: 'Fredoka', sans-serif;
}

/* Khu v·ª±c ch·ªù c√° c·∫Øn */
#fishing-waiting { text-align: center; padding: 20px; }

@keyframes float-bobber { 
    0%, 100% { transform: translateY(0) rotate(-5deg); } 
    50% { transform: translateY(-10px) rotate(5deg); } 
}

.fishing-float-anim { 
    font-size: 60px; 
    margin-bottom: 15px;
    display: flex;             
    justify-content: center;   
    align-items: center;       
    animation: float-bobber 2s ease-in-out infinite;
    filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2));
}

/* Khu v·ª±c ch∆°i game */
#fishing-game-area {
    display: none; 
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 20px;
    height: 340px;
    position: relative;
    margin-top: 10px;
    background: #B3E5FC;
    border-radius: 15px;
    padding: 10px;
    border: 2px solid #81D4FA;
}

/* C·ªôt n∆∞·ªõc ch√≠nh (Thanh Bar) */
#fishing-bar-container {
    width: 50px;
    height: 300px;
    background: linear-gradient(to right, #2c3e50, #4ca1af); /* M√†u n∆∞·ªõc s√¢u */
    border-radius: 25px;
    position: relative;
    overflow: hidden;
    border: 4px solid #37474F;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
}

/* V√πng Xanh (M·ª•c ti√™u - S·∫Ω di chuy·ªÉn) */
#zone-green {
    position: absolute; 
    left: 2px; 
    width: calc(100% - 4px); 
    height: 80px; /* Chi·ªÅu cao v√πng an to√†n */
    background: rgba(118, 255, 3, 0.5);
    border-top: 2px solid #76FF03;
    border-bottom: 2px solid #76FF03;
    z-index: 1;
    border-radius: 4px;
    box-shadow: 0 0 10px rgba(118, 255, 3, 0.4);
    transition: bottom 0.1s linear; /* Di chuy·ªÉn m∆∞·ª£t */
}

/* Thanh tr∆∞·ª£t (Bobber - Ng∆∞·ªùi ch∆°i ƒëi·ªÅu khi·ªÉn) */
#fishing-bobber {
    position: absolute; 
    left: 50%; 
    transform: translateX(-50%);
    bottom: 10%;
    width: 36px; 
    height: 20px;
    background: #FF5722; /* M√†u cam n·ªïi b·∫≠t */
    border: 2px solid #fff;
    border-radius: 10px;
    z-index: 10;
    transition: bottom 0.05s linear; 
    box-shadow: 0 0 8px rgba(255, 87, 34, 0.8);
}
/* Th√™m thanh ngang nh·ªè gi·ªØa bobber cho gi·ªëng th·∫≠t */
#fishing-bobber::after {
    content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(0,0,0,0.2);
}

/* Thanh ti·∫øn ƒë·ªô b·∫Øt c√° (B√™n ph·∫£i) */
#catch-progress-container {
    width: 25px; height: 300px;
    background: #eceff1; 
    border-radius: 15px;
    position: relative; 
    overflow: hidden; 
    border: 2px solid #cfd8dc;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

#catch-progress-fill {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
    background: linear-gradient(0deg, #FFEB3B, #FFC107, #FF9800, #4CAF50);
    transition: height 0.1s;
}

/* Hi·ªáu ·ª©ng khi thanh ƒë·∫ßy (chi·∫øn th·∫Øng) */
.progress-full {
    filter: drop-shadow(0 0 5px #4CAF50);
}

#fishing-timer {
    position: absolute; top: 15px; right: 20px;
    font-size: 1.8em; font-weight: 900; color: #0277BD;
    text-shadow: 2px 2px 0px white;
}
/* --- C·∫§U H√åNH V·ªä TR√ç & K√çCH TH∆Ø·ªöC RI√äNG CHO C√ÇY M·∫¨T ONG --- */
  /* ====================================================== */

  /* 1. GIAI ƒêO·∫†N ƒêANG L·ªöN (STAGE 1) */
  .seed-image.medium-plant.shadow-honey {
      /* --- CH·ªàNH TO / NH·ªé --- */
      width: 80% !important;        /* TƒÉng s·ªë n√†y ƒë·ªÉ c√¢y TO h∆°n, gi·∫£m ƒë·ªÉ NH·ªé ƒëi (M·∫∑c ƒë·ªãnh kho·∫£ng 160%) */
      
      /* --- CH·ªàNH L√äN / XU·ªêNG --- */
      bottom: 26px !important;       /* TƒÉng s·ªë n√†y ƒë·ªÉ c√¢y bay CAO h∆°n, gi·∫£m ƒë·ªÉ TH·∫§P xu·ªëng */
      
      /* --- CH·ªàNH TR√ÅI / PH·∫¢I --- */
      left: 50% !important;          /* Gi·ªØ nguy√™n d√≤ng n√†y (Tim ch·∫≠u) */
      transform: translateX(-50%) !important; /* Gi·ªØ nguy√™n d√≤ng n√†y (CƒÉn gi·ªØa) */
      
      margin-left: 0px !important;   /* S·ª≠a s·ªë n√†y: 
                                        - S·ªë d∆∞∆°ng (v√≠ d·ª• 10px) ƒë·ªÉ d·ªãch sang PH·∫¢I 
                                        - S·ªë √¢m (v√≠ d·ª• -10px) ƒë·ªÉ d·ªãch sang TR√ÅI */
  }

  /* 2. GIAI ƒêO·∫†N CH√çN / THU HO·∫†CH (STAGE 2) */
  .seed-image.big-plant.shadow-honey {
      /* --- CH·ªàNH TO / NH·ªé --- */
      width: 100% !important;        /* TƒÉng s·ªë n√†y ƒë·ªÉ c√¢y TO h∆°n (M·∫∑c ƒë·ªãnh kho·∫£ng 220%) */
      max-height: 300px !important;  /* Gi·ªõi h·∫°n chi·ªÅu cao ƒë·ªÉ kh√¥ng b·ªã v·ª° h√¨nh */
      
      /* --- CH·ªàNH L√äN / XU·ªêNG --- */
      bottom: 26px !important;       /* TƒÉng ƒë·ªÉ c√¢y CAO h∆°n so v·ªõi ƒë√°y ch·∫≠u */
      
      /* --- CH·ªàNH TR√ÅI / PH·∫¢I --- */
      left: 50% !important;          
      transform: translateX(-50%) !important;
      
      margin-left: 0px !important;   /* S·ª≠a s·ªë n√†y:
                                        - V√≠ d·ª•: 15px (Sang ph·∫£i)
                                        - V√≠ d·ª•: -15px (Sang tr√°i) */
      
      /* Gi·ªØ nguy√™n hi·ªáu ·ª©ng b√≥ng ƒë·ªï m√†u cam m·∫≠t ong */
      filter: drop-shadow(0 5px 12px rgba(255, 111, 0, 1.0)) !important; 
  }
/* --- CSS CHO NPC B√ÅNH BAO --- */
#banh-bao-npc {
    position: absolute;
    
    /* 1. CH·ªàNH TO / NH·ªé */
    width: 50px;              /* TƒÉng s·ªë n√†y (v√≠ d·ª•: 80px) ƒë·ªÉ NPC TO h∆°n. Gi·∫£m (v√≠ d·ª•: 40px) ƒë·ªÉ NH·ªé ƒëi */
    height: auto;             /* Gi·ªØ nguy√™n d√≤ng n√†y ƒë·ªÉ ·∫£nh kh√¥ng b·ªã m√©o */
    
    /* 2. CH·ªàNH L√äN / XU·ªêNG */
    top: 360px;               /* Gi·∫£m s·ªë n√†y (v√≠ d·ª•: 300px) ƒë·ªÉ D·ªäCH L√äN. TƒÉng s·ªë n√†y (v√≠ d·ª•: 450px) ƒë·ªÉ D·ªäCH XU·ªêNG */
    
    /* 3. CH·ªàNH TR√ÅI / PH·∫¢I (T√≠nh t·ª´ gi·ªØa m√†n h√¨nh) */
    /* Hi·ªán t·∫°i ƒëang l·ªách ph·∫£i 65px so v·ªõi tim m√†n h√¨nh */
    left: calc(50% + 65px);   
    /* - Mu·ªën sang PH·∫¢I nhi·ªÅu h∆°n: TƒÉng s·ªë 65px l√™n (v√≠ d·ª•: calc(50% + 100px)) */
    /* - Mu·ªën sang TR√ÅI: ƒê·ªïi d·∫•u c·ªông th√†nh tr·ª´ (v√≠ d·ª•: calc(50% - 100px)) */
    
    z-index: 15;              
    cursor: pointer;          
    
    /* Hi·ªáu ·ª©ng b√≥ng ƒë·ªï */
    filter: drop-shadow(0 3px 5px rgba(0,0,0,0.2));
    
    animation: none; 
    
    transition: transform 0.1s;
}

/* Hi·ªáu ·ª©ng nh√∫n khi b·∫•m v√†o */
#banh-bao-npc:active {
    transform: scale(0.9);
}
/* --- LOADING SCREEN CSS --- */
  #loading-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #1a1a1a; 
      
      z-index: 2000; /* T·∫ßng 4: Che ph·ªß to√†n b·ªô game khi ƒëang t·∫£i */
      
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease-out, visibility 0.5s;
      font-family: 'Fredoka', sans-serif;
  }

.loading-content {
    text-align: center;
    width: 80%;
    max-width: 300px;
}

#loading-moon-icon {
    font-size: 60px;
    margin-bottom: 15px;
    animation: bounce 2s infinite;
}

#loading-text {
    color: #fff;
    font-size: 1.2em;
    margin-bottom: 10px;
    font-weight: bold;
}

.loading-bar-bg {
    width: 100%;
    height: 12px;
    background: #333;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid #555;
}

#loading-bar-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    
    /* Hi·ªáu ·ª©ng tr∆∞·ª£t m∆∞·ª£t (nhanh ·ªü ƒë·∫ßu, ch·∫≠m d·∫ßn ·ªü cu·ªëi) */
    transition: width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    
    /* B√≥ng ƒë·ªï ph√°t s√°ng m√†u xanh l√° gi√∫p thanh loading ƒë·∫πp h∆°n */
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
}

/* ·∫®n m√†n h√¨nh ch·ªù khi t·∫£i xong */
.loading-done {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}
/* --- CSS KHUNG CH·ª®A ·∫¢NH CHU·∫®N (ITEM FRAME) --- */
.item-frame {
    width: 54px;            /* K√≠ch th∆∞·ªõc khung c·ªë ƒë·ªãnh */
    height: 54px;
    background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%); /* N·ªÅn tr·∫Øng xanh nh·∫π */
    border: 1px solid #c5e1a5; /* Vi·ªÅn xanh l√° nh·∫°t */
    border-radius: 14px;    /* Bo g√≥c m·ªÅm m·∫°i */
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.03), 0 2px 5px rgba(0,0,0,0.05);
    flex-shrink: 0;         /* Kh√¥ng b·ªã co l·∫°i khi m√†n h√¨nh nh·ªè */
    overflow: hidden;
    position: relative;
}

/* ·∫¢nh b√™n trong khung */
.item-frame img {
    width: 85% !important;  /* ·∫¢nh chi·∫øm 85% khung */
    height: 85% !important;
    object-fit: contain;    /* Gi·ªØ nguy√™n t·ª∑ l·ªá ·∫£nh */
    filter: drop-shadow(0 3px 3px rgba(0,0,0,0.15)); /* B√≥ng ƒë·ªï nh·∫π cho v·∫≠t ph·∫©m */
    margin: 0 !important;   /* X√≥a margin th·ª´a */
    top: 0 !important; left: 0 !important; /* Reset v·ªã tr√≠ tuy·ªát ƒë·ªëi n·∫øu c√≥ */
}

/* Ch·∫ø ƒë·ªô t·ªëi (Dark Mode) */
body.dark-mode .item-frame {
    background: linear-gradient(135deg, #424242 0%, #303030 100%);
    border-color: #555;
}
</style>
</head>
<body>
<div id="loading-screen">
    <div class="loading-content">
        <div id="loading-moon-icon">üåë</div>
        <div id="loading-text">ƒêang t·∫£i t√†i nguy√™n... 0%</div>
        <div class="loading-bar-bg">
            <div id="loading-bar-fill"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="global-overlay"></div> 

<div class="app-wrapper"> 

<button id="menu-btn" onclick="toggleHeader()">‚óÄ</button>

<header id="main-header">
  <div class="brand">
    <div id="player-level-display">üåæ Farm LOL üåæ</div>
    <div id="exp-bar-container">
    <div id="exp-fill"></div>
    <div id="exp-text-overlay">0 / 0</div>
</div>
  </div>
  <div class="controls">
  <button id="btn-new">üÜï T·∫°o</button>
  <button id="btn-delete" disabled>üóëÔ∏è Xo√°</button>
</div>
</header>

<main>
  <img id="beanstalk-bg" src="1000000105.png" alt="Khu v∆∞·ªùn b√™n h·ªì" />
  
  <img id="bee-guard" src="1000000144.gif" alt="Ong N√πi Gi·∫ª" onclick="showBeePopup()" />
  <img id="light-bulb" src="1000000123.gif" alt="B√≥ng ƒë√®n" />
  
  <div id="pot-container">
        <div class="pot-slot" id="slot-1" data-slot="1">
        <img id="ice-egg-img" src="" alt="Tr·ª©ng Ng≈© S·∫Øc" style="display:none;" />
        
        <div id="incubator-icon" style="display:none;">ü¶¢</div>
    </div>
    
    <div class="pot-slot" id="slot-2" data-slot="2">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" /> 
        <img id="seed-img-2" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-3" data-slot="3">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-3" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-6" data-slot="6" onclick="showFishingPrePopup()">
    <img src="1000000116.gif" alt="Em b√© c√¢u c√°" style="pointer-events: none;" />
</div>
    
    <div class="pot-slot" id="slot-4" data-slot="4">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-4" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-5" data-slot="5">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-5" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-7" data-slot="7">
        <img class="pot-base-img" src="1000000112.png" alt="Ch·∫≠u ƒë·∫•t" />
        <img id="seed-img-7" class="seed-image" src="" alt="V·∫≠t ph·∫©m tr·ªìng" style="display:none;" />
    </div>
    <style>
  /* --- C·∫¨P NH·∫¨T CSS D√ÇY LEO V√Ä CH√ÇU CH·∫§U --- */
  .vine-deco {
      position: absolute;
      width: 10px;       /* TƒÉng v√πng click l√™n m·ªôt ch√∫t cho d·ªÖ b·∫•m */
      height: auto;
      top: 195px;
      z-index: 4;
      cursor: pointer;   /* Hi·ªÉn th·ªã b√†n tay khi tr·ªè v√†o */
      pointer-events: auto; /* QUAN TR·ªåNG: Cho ph√©p click */
      opacity: 0.9;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
      transition: transform 0.1s;
  }
  .vine-deco:active { transform: scale(0.9); }
    /* --- CODE M·ªöI: Hi·ªáu ·ª©ng Combo d√¢y leo --- */
  @keyframes gold-glow-blink {
      0% { filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5)); }
      50% { filter: drop-shadow(0 0 5px rgba(255, 215, 0, 1)) brightness(1.2); }
      100% { filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5)); }
  }

  .vine-glowing {
      animation: gold-glow-blink 1.5s infinite ease-in-out !important;
      z-index: 5 !important; 
  }
  /* ---------------------------------------- */

  /* Class cho Ch√¢u Ch·∫•u */
  .hanging-grasshopper {
      position: absolute;
      width: 70px;       /* K√≠ch th∆∞·ªõc ch√¢u ch·∫•u */
      height: auto;
      top: 205px;        /* N·∫±m ngay d∆∞·ªõi d√¢y leo */
      z-index: 5;        /* N·∫±m sau d√¢y leo m·ªôt x√≠u cho t·ª± nhi√™n */
      pointer-events: auto; /* Cho ph√©p click v√†o con ch√¢u ch·∫•u */
      cursor: pointer;      /* Hi·ªán b√†n tay khi tr·ªè v√†o */
      /* ----------------------------------- */
      transform-origin: top center;
      animation: swing-grasshopper 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
      display: none;
  }

  @keyframes swing-grasshopper {
      0% { transform: rotate(3deg); }
      50% { transform: rotate(-3deg); }
      100% { transform: rotate(3deg); }
  }
  
/* --- C·∫§U H√åNH DARK MODE M·ªöI (COPY V√ÄO ƒê√ÇY) --- */
/* 1. X·ª≠ l√Ω n·ªÅn Game: L√†m t·ªëi ·∫£nh n·ªÅn ch√≠nh nh∆∞ng v·∫´n gi·ªØ chi ti·∫øt */
body.dark-mode #beanstalk-bg {
    filter: brightness(0.4) contrast(1.1) grayscale(0.2) hue-rotate(-10deg);
    transition: filter 0.5s ease; /* Chuy·ªÉn ƒë·ªïi m∆∞·ª£t m√† */
}

/* 2. Hi·ªáu ·ª©ng B√≥ng ƒê√®n: Khi t·ªëi th√¨ ƒë√®n ph·∫£i s√°ng (Glow v√†ng) */
body.dark-mode #light-bulb {
    filter: drop-shadow(0 0 15px rgba(255, 235, 59, 1)) brightness(1.3);
    transform: translateX(-50%) scale(1.1); /* Ph√≥ng to nh·∫π nh∆∞ ƒëang t·ªèa nhi·ªát */
}

/* 3. T·ªïng th·ªÉ Body: M√†u n·ªÅn ƒëen s√¢u */
body.dark-mode {
    background: #121212 !important; 
    color: #e0e0e0;
}

/* 4. Khung bao quanh App: Gradient t·ªëi */
body.dark-mode .app-wrapper {
    background: linear-gradient(180deg, #1a237e 0%, #000000 100%);
}

/* 5. C√°c Popup/H·ªôp tho·∫°i: N·ªÅn t·ªëi k√≠nh m·ªù & Vi·ªÅn d·∫° quang */
body.dark-mode #shop-box, 
body.dark-mode #online-box, 
body.dark-mode #pet-house-box, 
body.dark-mode #interaction-popup, 
body.dark-mode #seed-box, 
body.dark-mode #inventory-box,
body.dark-mode #fishing-popup,
body.dark-mode #name-box {
    background: rgba(30, 30, 40, 0.98);
    border: 2px solid #5c6bc0;
    color: #e0e0e0;
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
}

/* 6. C√°c th·∫ª Item (Shop/Kho): M√†u x√°m xanh ƒë·∫≠m, kh√¥ng b·ªã ch√≥i */
body.dark-mode .shop-item, 
body.dark-mode .pet-shop-item,
body.dark-mode .inventory-item {
    background: #263238 !important;
    border-color: #37474F !important;
    color: #ECEFF1;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
}

/* 7. Khung ·∫¢nh Item (Item Frame): Sang tr·ªçng h∆°n */
body.dark-mode .item-frame {
    background: linear-gradient(135deg, #455A64 0%, #263238 100%) !important;
    border: 1px solid #546E7A !important;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.5), 0 0 5px rgba(255,255,255,0.05) !important;
}

/* 8. Ch·ªânh m√†u ch·ªØ ti√™u ƒë·ªÅ cho d·ªÖ ƒë·ªçc */
body.dark-mode h3 {
    color: #90CAF9 !important; 
    text-shadow: 0 0 5px rgba(33, 150, 243, 0.4);
}
body.dark-mode b, 
body.dark-mode strong {
    color: #fff !important;
}

/* 9. N√∫t ƒê√≥ng (M√†u ƒë·ªè tr·∫ßm h∆°n cho ƒë·ª° g·∫Øt) */
body.dark-mode .btn-close, 
body.dark-mode button[onclick*="none"] {
    background: #c62828 !important; 
    box-shadow: 0 3px 0 #8e0000 !important;
}
/* --- CSS S·ª¨A L·ªñI N·ªÄN TR·∫ÆNG KHI B√ÅN C√Å --- */

/* 1. C·∫•u h√¨nh m·∫∑c ƒë·ªãnh (S√°ng) */
.fish-sell-item {
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    background: white;             /* N·ªÅn tr·∫Øng */
    padding: 8px; 
    border-radius: 12px; 
    border: 1px solid #eee; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s ease;     /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u m∆∞·ª£t */
}

/* 2. C·∫•u h√¨nh khi T·∫Øt ƒê√®n (T·ªëi) */
body.dark-mode .fish-sell-item {
    background: #263238 !important; /* ƒê·ªïi sang m√†u x√°m ƒëen */
    border-color: #37474F !important;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
}

/* 3. ƒê·ªïi m√†u ch·ªØ T√™n C√° khi t·ªëi */
body.dark-mode .fish-name-text {
    color: #ECEFF1 !important;      /* Ch·ªØ m√†u tr·∫Øng s√°ng */
}
/* --- CSS CHO D√ÇY LEO (FIX DARK MODE) --- */
.vine-item {
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    background: white;          /* N·ªÅn s√°ng m·∫∑c ƒë·ªãnh */
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    transition: all 0.2s;
}

/* Tr·∫°ng th√°i ƒëang trang b·ªã (S√°ng) */
.vine-item.equipped {
    background: #e8f5e9;        /* Xanh nh·∫°t */
    border-color: #4CAF50;
}

/* --- DARK MODE CHO D√ÇY LEO --- */
body.dark-mode .vine-item {
    background: #263238 !important; /* X√°m ƒëen */
    border-color: #37474F !important;
}
body.dark-mode .vine-item.equipped {
    background: #1b5e20 !important; /* Xanh l√° ƒë·∫≠m */
    border-color: #66bb6a !important;
}

/* --- CSS CHO SHOP S·ª∞ KI·ªÜN (FIX DARK MODE) --- */
.event-shop-item {
    background: white;
    border: 1px solid #f8bbd0;  /* Vi·ªÅn h·ªìng ph·∫•n */
    border-radius: 12px;
    padding: 10px;
    display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
    transition: transform 0.1s;
}

/* --- DARK MODE CHO SHOP S·ª∞ KI·ªÜN --- */
body.dark-mode .event-shop-item {
    background: #263238 !important;
    border-color: #880E4F !important; /* Vi·ªÅn h·ªìng ƒë·∫≠m */
}

/* Class ƒë·ªïi m√†u ch·ªØ ti√™u ƒë·ªÅ chung cho c·∫£ 2 b·∫£ng */
.item-title-text {
    font-weight: 700; 
    color: #3e2723; /* M√†u n√¢u ƒë·∫•t m·∫∑c ƒë·ªãnh */
    font-size: 0.95em;
}
body.dark-mode .item-title-text {
    color: #ECEFF1 !important; /* M√†u tr·∫Øng s√°ng khi t·∫Øt ƒë√®n */
}
/* --- B·ªî SUNG: CSS FIX DARK MODE CHO D√ÇY LEO & SHOP S·ª∞ KI·ªÜN --- */

/* 1. Item D√¢y Leo (M·∫∑c ƒë·ªãnh s√°ng) */
.vine-item {
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    background: white;          
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    transition: all 0.2s;
    margin-bottom: 8px; /* Kho·∫£ng c√°ch gi·ªØa c√°c d√≤ng */
}

/* D√¢y leo ƒëang ƒëeo (S√°ng) */
.vine-item.equipped {
    background: #e8f5e9;        
    border-color: #4CAF50;
}

/* 2. Item Shop S·ª± Ki·ªán (M·∫∑c ƒë·ªãnh s√°ng) */
.event-shop-item {
    background: white;
    border: 1px solid #f8bbd0;  
    border-radius: 12px;
    padding: 10px;
    display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
    transition: transform 0.1s;
}

/* 3. T√™n v·∫≠t ph·∫©m (Chung) */
.item-title-text {
    font-weight: 700; 
    color: #3e2723; 
    font-size: 0.95em;
}

/* --- CH·∫æ ƒê·ªò T·ªêI (DARK MODE) --- */
body.dark-mode .vine-item {
    background: #263238 !important; /* X√°m ƒëen */
    border-color: #37474F !important;
}
body.dark-mode .vine-item.equipped {
    background: #1b5e20 !important; /* Xanh r√™u ƒë·∫≠m */
    border-color: #66bb6a !important;
}

body.dark-mode .event-shop-item {
    background: #263238 !important;
    border-color: #880E4F !important; /* Vi·ªÅn h·ªìng ƒë·∫≠m */
}

body.dark-mode .item-title-text {
    color: #ECEFF1 !important; /* Ch·ªØ tr·∫Øng s√°ng */
}
/* --- CSS S·ª¨A L·ªñI DARK MODE C√ÇU C√Å --- */
#fishing-popup {
    background: #E3F2FD; /* M√†u s√°ng m·∫∑c ƒë·ªãnh */
}
#fishing-game-area {
    background: #B3E5FC; /* M√†u n∆∞·ªõc s√°ng m·∫∑c ƒë·ªãnh */
}

/* Giao di·ªán khi T·∫Øt ƒê√®n */
body.dark-mode #fishing-popup {
    background: #102027 !important; /* N·ªÅn xanh ƒëen */
    border-color: #37474F !important;
    color: #ECEFF1;
}
body.dark-mode #fishing-game-area {
    background: #006064 !important; /* N∆∞·ªõc h·ªì t·ªëi h∆°n */
    border-color: #00838F !important;
}
body.dark-mode #fishing-waiting-anim {
    color: #81D4FA !important;
}
</style>

                <img src="1000000129.png" class="vine-deco" style="left: calc(50% - 87.5px);" data-index="0" />
    <img id="grasshopper-0" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% - 115px);" /> 

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% - 27.5px);" data-index="1" />
    <img id="grasshopper-1" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% - 55px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 32.5px);" data-index="2" />
    <img id="grasshopper-2" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 5px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 92.5px);" data-index="3" />
    <img id="grasshopper-3" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 65px);" />

    <img src="1000000129.png" class="vine-deco" style="left: calc(50% + 152.5px);" data-index="4" />
    <img id="grasshopper-4" src="1000000130.gif" class="hanging-grasshopper" style="left: calc(50% + 125px);" />
  </div>
  
    <div id="backpack-slot" onclick="openInventory()">
      <img src="1000000138.png" alt="3 L√¥" />
  </div>

  <img id="giftcode-supply-drop" src="1000000143.png" alt="H√≤m Th√≠nh" onclick="showGiftcodePopup()" />
  <img id="banh-bao-npc" src="1000000154.gif" alt="B√°nh Bao" onclick="showFishBuyerPopup()" />
  <img id="kinto-cloud" src="1000000103.png" alt="C√¢n ƒê·∫©u V√¢n" data-slot="0" />
  <img id="event-cloud" src="1000000131.png" alt="S·ª± Ki·ªán" />
  <img id="pet-house" src="1000000100.png" alt="Nh√† Pet" />
  
  <img id="chaos-blacksmith" src="1000000107.png" alt="Th·ª£ R√®n Chaos" />
  <img id="chaos-blacksmith-working" src="1000000101.gif" alt="Th·ª£ R√®n ƒêang L√†m" style="display:none;" />
  
<div id="pet-container" style="position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); z-index: 7; pointer-events: none; width: 120px; height: 120px; display: flex; align-items: flex-end; justify-content: center;">
    <img id="pug-pet" src="" alt="Ch√∫ ch√≥ Pug" style="display:none; width: 100%; height: auto; cursor: pointer; transform-origin: bottom center; pointer-events: auto;" />
</div>
  <img id="bone-bowl" src="1000000115.png" alt="B√°t ƒë·ª±ng x∆∞∆°ng" />
</main>

</div> 

<div id="name-box" style="display:none;">
    <h3>Xin ch√†o n√¥ng d√¢n!</h3>
    <p style="color:var(--text-muted);">H√£y ƒë·∫∑t m·ªôt c√°i t√™n th·∫≠t ng·∫ßu nh√©:</p>
    <input type="text" id="player-name" placeholder="V√≠ d·ª•: Alice" maxlength="12"/>
    <button id="btn-next">B·∫Øt ƒë·∫ßu ngay &rarr;</button>
</div>

<div id="shop-box">
  <h3>‚òÅÔ∏è Shop M√¢y</h3> 
  <div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
    <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-shop">0</b> &nbsp;|&nbsp; 
    <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-shop">0</b>
  </div>
  
  <div id="shop-tab-container-wrapper"></div>
  
  <button onclick="hidePopup('shop-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="seed-box">
<h3>üå± Shop H·∫°t Gi·ªëng</h3> 
<div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
  <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-seed">0</b> &nbsp;|&nbsp; 
  <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-seed">0</b>
</div>

<div id="seed-items" style="display:grid; grid-template-columns: 1fr; gap:10px; max-height: 400px; overflow-y: auto;"></div>
<button onclick="hidePopup('seed-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="online-box">
  <h3 style="color:#E64A19;">üéÅ H√≤m Th√≠nh</h3>
  <p style="color:#795548; font-size:0.9em; margin-bottom:5px;">
      Nh·∫≠p m√£ <b>Giftcode</b> ƒë·ªÉ nh·∫≠n qu√† b√≠ m·∫≠t:
  </p>
  
  <input type="text" id="giftcode-input" placeholder="NH·∫¨P M√É T·∫†I ƒê√ÇY" maxlength="15">
  
  <button onclick="handleGiftcode()" class="btn-buy" style="
      background: linear-gradient(45deg, #FF5722, #F4511E); 
      font-size: 1.1em; 
      padding: 10px; 
      margin-bottom: 10px;
      box-shadow: 0 4px 0 #D84315;">
    M·ªü Qu√† Ngay
  </button>

  <button onclick="hidePopup('online-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="pet-house-box">
  <h3 id="pet-house-title">üêæ Nh√† Pet</h3> 
  <div style="font-size:0.9em; margin-bottom:12px; color:var(--text-muted); background:rgba(0,0,0,0.05); padding:5px; border-radius:8px;">
      <span style="font-size:1.1em; color:#795548;">ü´ò</span> <b id="coin-dau-pet">0</b> &nbsp;|&nbsp; 
      <span style="font-size:1.1em; color:#E65100;">üçÇ</span> <b id="coin-la-pet">0</b>
  </div>
  <div id="pet-shop-items"></div>
  <button onclick="hidePopup('pet-house-box')" class="btn-close">ƒê√≥ng</button>
</div>

<div id="interaction-popup">
    <h3 id="interaction-title"></h3> 
    <div id="interaction-text" style="min-height: 50px; font-size: 0.95em; line-height: 1.5;"></div>
    <div id="interaction-controls" style="margin-top: 15px;"></div>
    <button onclick="closeInteractionPopup()" class="btn-close" style="margin-top: 20px;">ƒê√≥ng</button>
</div>

<div id="inventory-box">
    <h3 style="text-align:center; color:#5D4037; margin-top:0; border-bottom: 2px dashed #ddd; padding-bottom: 10px;">
        üéí 3 L√¥
    </h3>
    
    <div style="background: #FFF3E0; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; border: 1px solid #FFE0B2;">
        <div style="color:#795548; font-weight:bold;">
            ü´ò ƒê·∫≠u: <span id="inv-dau" style="color:#D84315; font-size:1.1em;">0</span>
        </div>
        <div style="border-left: 2px solid #ccc; height: 20px;"></div>
        <div style="color:#E65100; font-weight:bold;">
            üçÇ L√°: <span id="inv-la" style="color:#D84315; font-size:1.1em;">0</span>
        </div>
    </div>

    <div id="inventory-list" style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
        <div style="text-align:center; color:#999; margin-top:20px;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <button onclick="hidePopup('inventory-box')" class="btn-close" style="width:100%; margin-top:15px; background:#f44336; color:white; border:none; padding:10px; border-radius:20px; font-weight:bold; cursor:pointer;">
        ƒê√≥ng
    </button>
</div>
<div id="fishing-popup" style="background: #E0F7FA; border: 4px solid #0277BD; font-family: 'Fredoka', sans-serif;">
    
    <h3 style="color:#1565C0; margin: 0 0 10px 0;">üé£ ƒê√¨a C√° D·ªì</h3>
    
    <div id="fishing-waiting">
        <div id="fishing-start-ui">
            <p style="color:#555; font-size:0.9em;">D√πng <b>x1 Nh·ªông Ong</b> <img src="1000000145.png" width="15" style="vertical-align:middle;"> ƒë·ªÉ c√¢u.</p>
            <div style="background:rgba(255,255,255,0.5); padding:10px; border-radius:10px; margin:10px 0; font-size:0.85em; color:#37474F;">
                üêü C√° Tr√™ (50%)<br>ü¶à C√° D·ªì (30%)<br>üê† C√° Tai T∆∞·ª£ng (20%)
            </div>
            <button id="btn-start-fishing" style="background:#29B6F6; color:white; border:none; padding:12px 20px; border-radius:25px; font-weight:bold; font-size:1em; cursor:pointer; box-shadow: 0 4px 0 #0288D1; width:100%;">
                QuƒÉng C·∫ßn Ngay!
            </button>
        </div>
        
        <div id="fishing-waiting-anim" style="display:none;">
            <div class="fishing-float-anim">üåäüé£üåä</div>
            <p style="color:#0277BD; font-weight:bold;">ƒêang ƒë·ª£i c√° c·∫Øn c√¢u...</p>
            <div id="fishing-countdown" style="font-size:3em; font-weight:900; color:#FF9800;">5</div>
        </div>
    </div>

    <div id="fishing-game-area">
        <div id="fishing-bar-container">
            <div id="zone-green"></div> 
            <div id="fishing-bobber"></div> 
        </div>
        
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div style="font-size:0.7em; font-weight:bold; color:#E65100; margin-bottom:5px;">B·∫ÆT!</div>
            <div id="catch-progress-container">
                <div id="catch-progress-fill"></div>
            </div>
        </div>
        
        <div id="fishing-timer">15s</div>
    </div>
    
    <div id="fishing-guide-text" style="font-size:0.85em; color:#555; margin-top:10px; display:none;">
        üëÜ <b>NH·∫§P LI√äN T·ª§C</b> ƒë·ªÉ gi·ªØ thanh x√°m ·ªü v√πng Xanh!
    </div>

    <button onclick="closeFishingPopup()" style="margin-top:15px; background:#ef5350; color:white; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; width:100%; cursor:pointer;">Tho√°t</button>
</div>
<script>
// --- C·∫§U H√åNH TH·ªúI GIAN GAME (CH·ªàNH S·ª¨A T·∫§T C·∫¢ T·∫†I ƒê√ÇY) ---
const GAME_CONFIG = {
    // 1. Th·ªùi gian ·∫•p tr·ª©ng kh·ªüi ƒë·∫ßu (L√∫c t·∫°o nick m·ªõi nh·∫≠n Bi Gai)
    // M·∫∑c ƒë·ªãnh: 10 gi√¢y
    TIME_STARTER: 60 * 1000, 
    
    // 2. Th·ªùi gian ·∫•p tr·ª©ng mua t·ª´ Shop ho·∫∑c ƒê·∫≠p tr·ª©ng (Thi√™n Th·∫ßn/Th·∫ßn Ch·∫øt/Bi Gai)
    // ƒê·ªÉ 24 gi·ªù th√¨ d√πng: 24 * 60 * 60 * 1000
    // Hi·ªán t·∫°i ƒë·ªÉ 24 gi·ªù:
    TIME_HATCH: 60 * 1000,

    // 3. Th·ªùi gian N√¢ng c·∫•p sao cho Pet
    // Hi·ªán t·∫°i ƒë·ªÉ 24 gi·ªù:
    TIME_UPGRADE: 60 * 1000
};
// --- DANH S√ÅCH ·∫¢NH C·∫¶N T·∫¢I TR∆Ø·ªöC (Preload) ---
// ƒê√¢y l√† danh s√°ch c√°c ·∫£nh l·∫•y t·ª´ code game c·ªßa b·∫°n
const ASSETS_TO_LOAD = [
    "1000000109.png", "1000000105.png", "1000000144.gif", "1000000123.gif", 
    "1000000112.png", "1000000116.gif", "1000000129.png", "1000000130.gif", 
    "1000000138.png", "1000000143.png", "1000000154.gif", "1000000103.png", 
    "1000000131.png", "1000000100.png", "1000000107.png", "1000000101.gif", 
    "1000000115.png", "1000000102.png", "1000000127.gif", "1000000104.gif", 
    "1000000149.gif", "1000000110.gif", "1000000111.gif", "1000000113.gif", 
    "1000000133.gif", "1000000151.gif", "1000000124.gif", "1000000114.gif", 
    "1000000134.gif", "1000000152.gif", "1000000128.gif", "1000000106.png", 
    "1000000108.gif", "1000000125.png", "1000000126.png", "1000000132.png", 
    "1000000150.png", "1000000139.gif", "1000000140.gif", "1000000141.gif", 
    "1000000142.gif", "1000000135.png", "1000000136.png", "1000000137.png", 
    "1000000153.png", "1000000117.png", "1000000118.png", "1000000119.png",
    "1000000120.png", "1000000121.png", "1000000122.png", "1000000145.png",
    "1000000148.png", "1000000146.png", "1000000147.png", 
    "1000000155.gif"
];

let assetsLoaded = 0;
const totalAssets = ASSETS_TO_LOAD.length;

function updateLoadingProgress() {
    assetsLoaded++;
    
    // 1. AN TO√ÄN: N·∫øu danh s√°ch ·∫£nh r·ªóng th√¨ v√†o game lu√¥n, tr√°nh chia cho 0
    if (totalAssets === 0) {
        finishLoading();
        return;
    }
    
    const percent = Math.floor((assetsLoaded / totalAssets) * 100);
    
    // C·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô
    const bar = document.getElementById('loading-bar-fill');
    const text = document.getElementById('loading-text');
    const moon = document.getElementById('loading-moon-icon');
    
    // CSS transition s·∫Ω t·ª± l√†m m∆∞·ª£t chuy·ªÉn ƒë·ªông chi·ªÅu r·ªông n√†y
    if (bar) bar.style.width = percent + "%";
    
    // X·ª≠ l√Ω icon m·∫∑t trƒÉng theo % (Gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n)
    let icon = "üåë";
    if (percent <= 10) icon = "üåë";
    else if (percent <= 20) icon = "üåí";
    else if (percent <= 30) icon = "üåì";
    else if (percent <= 40) icon = "üåî";
    else if (percent <= 50) icon = "üåï";
    else if (percent <= 60) icon = "üåñ";
    else if (percent <= 70) icon = "üåó";
    else if (percent <= 80) icon = "üåò";
    else if (percent <= 90) icon = "üåë";
    else icon = "üåö"; 

    if (moon) moon.innerText = icon;
    if (text) text.innerText = `ƒêang t·∫£i t√†i nguy√™n... ${percent}%`;

    // 2. KHI T·∫¢I XONG
    if (assetsLoaded >= totalAssets) {
        // Delay 800ms ƒë·ªÉ ng∆∞·ªùi ch∆°i k·ªãp nh√¨n th·∫•y con s·ªë 100% cho th·ªèa m√£n
        setTimeout(finishLoading, 800); 
    }
}

// 3. H√ÄM K·∫æT TH√öC LOADING (T√°ch ri√™ng ƒë·ªÉ g·ªçn code)
function finishLoading() {
    const screen = document.getElementById('loading-screen');
    if(screen) {
        // M·ªù d·∫ßn (Fade out)
        screen.style.opacity = '0'; 
        
        // ƒê·ª£i 0.5s cho hi·ªáu ·ª©ng m·ªù ch·∫°y xong r·ªìi m·ªõi ·∫©n h·∫≥n (display: none)
        setTimeout(() => {
            screen.style.display = 'none';
            screen.classList.add('loading-done');
        }, 500); 
    }
}

// H√†m t·∫£i h√¨nh ·∫£nh
function preloadGameAssets() {
    if (totalAssets === 0) {
        finishLoading();
        return;
    }

    ASSETS_TO_LOAD.forEach(src => {
        const img = new Image();
        img.src = src;
        // D√π t·∫£i th√†nh c√¥ng hay l·ªói ƒë·ªÅu t√≠nh l√† ƒë√£ xong ƒë·ªÉ kh√¥ng b·ªã k·∫πt ·ªü 99%
        img.onload = updateLoadingProgress;
        img.onerror = updateLoadingProgress;
    });
}

// G·ªçi h√†m t·∫£i ngay l·∫≠p t·ª©c
preloadGameAssets();
// --- LOGIC SCALING ---
function adjustAppWrapperScale() {
    const appWrapper = document.querySelector(".app-wrapper");
    if (!appWrapper) return;
    const designWidth = 400; const designHeight = 750; 
    const viewportWidth = window.innerWidth; const viewportHeight = window.innerHeight;
    
    const scaleX = viewportWidth / designWidth; 
    const scaleY = viewportHeight / designHeight;
    let scale = Math.min(scaleX, scaleY);
    const MAX_SCALE = 1.1; 
    scale = Math.min(scale, MAX_SCALE);
    
    appWrapper.style.transform = `scale(${scale})`;
    
    if (viewportHeight > designHeight * scale) { 
        const scaledHeight = designHeight * scale;
        const marginTop = (viewportHeight - scaledHeight) / 2;
        appWrapper.style.marginTop = `${marginTop}px`; appWrapper.style.marginBottom = `${marginTop}px`;
    } else { appWrapper.style.marginTop = '0'; appWrapper.style.marginBottom = '0'; }
}
window.addEventListener('resize', adjustAppWrapperScale);

function toggleHeader() {
    const header = document.getElementById('main-header');
    const btn = document.getElementById('menu-btn');
    header.classList.toggle('collapsed');
    if (header.classList.contains('collapsed')) { btn.innerHTML = '‚öôÔ∏è'; } else { btn.innerHTML = '‚óÄ'; }
}

let playerName = "N√¥ng d√¢n";
let farmIcon = "üåæ";
let level = 0;
let exp = 0;
let dau = 0; 
let la = 0;
let usedGiftcodes = []; // L∆∞u danh s√°ch m√£ ƒë√£ d√πng
// --- C·∫§U H√åNH H·ªÜ TH·ªêNG GIFTCODE T·∫¨P TRUNG (DATABASE) ---
const GIFTCODE_DATABASE = {
    "FARMLOL": {
        dau: 99999,
        la: 99999,
        items: { 
            'manh_nguyen_to': 99999, 
            'manh_kim_loai': 99999, 
            'vuong_mien': 99999, 
            'tui_mat': 99999 
        }
}
};
// --- BI·∫æN QU·∫¢N L√ù TRANG TR√ç ---
let vineDecorations = [null, null, null, null, null]; // 5 v·ªã tr√≠ d√¢y leo, null = tr·ªëng
let tool = { name: "X·∫ªng G·ªó", power: 1, maxHP: 100, currentHP: 100 };
let ownedDecorations = { 'chau_chau': 0 }; // Kho ch·ª©a ƒë·ªì trang tr√≠
let hasIceEgg = false; 
let isIceDragonHatched = false; 
let isIceDragonEvolved = false; 
let hatchedPetType = "thien_than"; // BI·∫æN M·ªöI: L∆ØU LO·∫†I PET ƒê√É ·∫§P (thien_than HO·∫∂C than_chet)
let activePet = null;
let incubationFinishTime = 0; // Th·ªùi gian k·∫øt th√∫c ·∫•p tr·ª©ng
let ownedPets = []; 
let ownedSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0, 'hat_tinh_yeu': 0 };
let globalPetAge = 0;
let petLevels = { 'thien_than': 1, 'than_chet': 1 }; // L∆∞u c·∫•p sao ri√™ng
// --- KHAI B√ÅO KHO V·∫¨T PH·∫®M ƒê·∫∂C BI·ªÜT (M·ªöI) ---
let petStarLevel = 1; // Bi·∫øn l∆∞u c·∫•p ƒë·ªô sao c·ªßa Pet
let ownedArtifacts = { 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0 };
let grasshopperExchanged = 0; // Bi·∫øn theo d√µi s·ªë l·∫ßn ƒë√£ ƒë·ªïi (T·ªëi ƒëa 5)
let isHarvesting = false; // Bi·∫øn ch·ªëng click ƒë√∫p khi thu ho·∫°ch
let isUpgrading = false; // Bi·∫øn ƒë√°nh d·∫•u: True = ƒëang n√¢ng c·∫•p, False = ƒëang ·∫•p m·ªõi
// --- TH√äM: C·∫§U H√åNH DANH S√ÅCH V·∫¨T PH·∫®M TREO ---
// ƒê√¢y l√† danh s√°ch ƒë·ªãnh nghƒ©a t√™n, ·∫£nh v√† gi√° c·ªßa c√°c m√≥n ƒë·ªì treo
const HANGING_ITEMS_CONFIG = [
    { 
        id: 'chau_chau', name: 'Ch√¢u Ch·∫•u', img: '1000000130.gif', price: 100,
        style: { width: '50px', top: '205px', marginLeft: '7px' } 
    },
    { 
        id: 'treo_con_ca', name: 'Con C√°', img: '1000000139.gif', price: 100,
        style: { width: '50px', top: '205px', marginLeft: '8px' }
    },
    { 
        id: 'treo_long_den', name: 'L·ªìng ƒê√®n', img: '1000000140.gif', price: 100,
        style: { width: '45px', top: '202px', marginLeft: '7px' }
    },
    { 
        id: 'treo_trai_chau', name: 'Tr√°i Ch√¢u', img: '1000000141.gif', price: 100,
        style: { width: '45px', top: '210px', marginLeft: '9px' }
    },
    { 
        id: 'treo_chong_chong', name: 'Chong Ch√≥ng', img: '1000000142.gif', price: 100,
        style: { width: '130px', top: '200px', marginLeft: '-32px' }
    }
];
// C·∫•u h√¨nh v·∫≠t ph·∫©m r·ªõt khi thu ho·∫°ch
const HARVEST_DROPS = {
    'hat_nguyen_to': { id: 'manh_nguyen_to', name: 'M·∫£nh Nguy√™n T·ªë', img: '1000000135.png' },
    'hat_kim_loai': { id: 'manh_kim_loai', name: 'M·∫£nh Kim Lo·∫°i', img: '1000000136.png' },
    'hat_tinh_yeu': { id: 'vuong_mien', name: 'V∆∞∆°ng Mi·ªán', img: '1000000137.png' },
    'hat_mat_ong': { id: 'tui_mat', name: 'T√∫i M·∫≠t', img: '1000000153.png' }
};
let lastFedTime = 0;
let lastBeePokeTime = 0; // Bi·∫øn l∆∞u th·ªùi gian l·∫ßn cu·ªëi th·ªçc ong
let activePopupInterval = null;

// --- 1. C·∫¨P NH·∫¨T DANH S√ÅCH CH·∫¨U ---
let ownedPots = { 
    'so_dua': 0, 'chau_dong': 0, 
    'chau_bac': 0, 'chau_vang': 0, 
    'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 
}; 
let craftingQueue = []; 

const POT_DEFINITIONS = {
    'so_dua': { name: "S·ªç D·ª´a", img: "1000000112.png", expBonus: 0 },
    'chau_dong': { name: "Ch·∫≠u ƒê·ªìng", img: "1000000117.png", expBonus: 1 },
    'chau_bac': { name: "Ch·∫≠u B·∫°c", img: "1000000118.png", expBonus: 2 },
    'chau_vang': { name: "Ch·∫≠u V√†ng", img: "1000000119.png", expBonus: 3 },
    'chau_bach_kim': { name: "Ch·∫≠u B·∫°ch Kim", img: "1000000120.png", expBonus: 4 },
    'chau_kim_cuong': { name: "Ch·∫≠u Kim C∆∞∆°ng", img: "1000000121.png", expBonus: 5 },
    'chau_kim_cuong_do': { name: "Ch·∫≠u K.C∆∞∆°ng ƒê·ªè", img: "1000000122.png", expBonus: 6 }
};

// --- 2. C·∫¨P NH·∫¨T C√îNG TH·ª®C R√àN (ƒê√É CH·ªàNH S·ª¨A: D√ôNG M·∫¢NH KIM LO·∫†I) ---
const CRAFTING_RECIPES = [
    {
        id: 'craft_so_dua',
        output: 'so_dua',
        name: 'S·ªç D·ª´a',
        icon: '1000000112.png',
        duration: 0,
        cost: { dau: 1000 }, 
        materials: {} 
    },
    {
        id: 'craft_chau_dong',
        output: 'chau_dong',
        name: 'Ch·∫≠u ƒê·ªìng',
        icon: '1000000117.png',
        duration: 2 * 60 * 60 * 1000, 
        cost: { dau: 2000 },
        // S·ª≠a: hat_kim_loai -> manh_kim_loai
        materials: { 'so_dua': 1, 'manh_kim_loai': 20 }
    },
    {
        id: 'craft_chau_bac',
        output: 'chau_bac',
        name: 'Ch·∫≠u B·∫°c',
        icon: '1000000118.png',
        duration: 3 * 60 * 60 * 1000, 
        cost: { dau: 3000 },
        materials: { 'chau_dong': 1, 'manh_kim_loai': 30 }
    },
    {
        id: 'craft_chau_vang',
        output: 'chau_vang',
        name: 'Ch·∫≠u V√†ng',
        icon: '1000000119.png',
        duration: 4 * 60 * 60 * 1000, 
        cost: { dau: 4000 },
        materials: { 'chau_bac': 1, 'manh_kim_loai': 40 }
    },
    {
        id: 'craft_chau_bach_kim',
        output: 'chau_bach_kim',
        name: 'Ch·∫≠u B·∫°ch Kim',
        icon: '1000000120.png',
        duration: 5 * 60 * 60 * 1000, 
        cost: { dau: 5000 },
        materials: { 'chau_vang': 1, 'manh_kim_loai': 50 }
    },
    {
        id: 'craft_chau_kim_cuong',
        output: 'chau_kim_cuong',
        name: 'Ch·∫≠u Kim C∆∞∆°ng',
        icon: '1000000121.png',
        duration: 6 * 60 * 60 * 1000, 
        cost: { dau: 6000 },
        materials: { 'chau_bach_kim': 1, 'manh_kim_loai': 60 }
    },
    {
        id: 'craft_chau_kim_cuong_do',
        output: 'chau_kim_cuong_do',
        name: 'Ch·∫≠u K.C∆∞∆°ng ƒê·ªè',
        icon: '1000000122.png',
        duration: 7 * 60 * 60 * 1000, 
        cost: { dau: 7000 },
        materials: { 'chau_kim_cuong': 1, 'manh_kim_loai': 70 }
    }
];

const FARM_IDS = [2, 3, 4, 5, 7]; 
let farmSlots = Array(5).fill(null); 
let equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua']; 

// --- CH·ªàNH S·ª¨A V·ªä TR√ç PET ---
let petShopItems = [
    // 1. Choco: Size nh·ªè (50px) -> CƒÉn gi·ªØa (-25px) -> ƒê·ª©ng cao h∆°n x√≠u (50px)
    { 
        id: 100, 
        name: "Choco", 
        price: 0, 
        currency: "dau", 
        type: "pet", 
        icon: "1000000128.gif", 
        value: "1000000128.gif", 
        customWidth: "50px", 
        position: { bottom: '50px', left: 'calc(50% - 25px)' }, 
    },
    
    // 2. Pug P√©o: Size v·ª´a (80px) -> CƒÉn gi·ªØa (-40px) -> ƒê·ª©ng chu·∫©n (40px)
    { 
        id: 101, 
        name: "Pug P√©o", 
        price: 100, 
        currency: "la", 
        type: "pet", 
        icon: "1000000106.png", 
        value: "1000000106.png", 
        customWidth: "80px", 
        position: { bottom: '40px', left: 'calc(50% - 40px)' }, 
    },

    // 3. Mr. Gold: Size to (100px) -> CƒÉn gi·ªØa (-50px) -> ƒê·ª©ng th·∫•p do ch√¢n to (35px)
    { 
        id: 102, 
        name: "Mr. Gold", 
        price: 100, 
        currency: "la", 
        type: "pet", 
        icon: "1000000108.gif", 
        value: "1000000108.gif", 
        customWidth: "100px", 
        position: { bottom: '35px', left: 'calc(50% - 50px)' }, 
    },
];

// --- DANH S√ÅCH SHOP ---
let shopItems = [
    // 1. Th√™m BI GAI v√†o ƒë·∫ßu danh s√°ch (Gi√° 0 ƒë·ªÉ ƒë√°nh d·∫•u l√† Pet kh·ªüi ƒë·∫ßu)
    { id: 201, name: "Bi Gai", price: 0, currency: "dau", type: "pet", icon: "1000000149.gif", value: "1000000149.gif", category: "pet_may" },

    // 2. Gi·ªØ nguy√™n Thi√™n Th·∫ßn v√† Th·∫ßn Ch·∫øt (V·∫´n b√°n trong Shop)
    { id: 202, name: "Thi√™n Th·∫ßn", price: 100, currency: "la", type: "pet", icon: "1000000127.gif", value: "1000000127.gif", category: "pet_may" },
    { id: 203, name: "Th·∫ßn Ch·∫øt",  price: 100, currency: "la", type: "pet", icon: "1000000104.gif", value: "1000000104.gif", category: "pet_may" },
    
    // C√°c lo·∫°i h·∫°t gi·ªëng gi·ªØ nguy√™n
    { id: 204, name: "H·∫°t Nguy√™n T·ªë", price: 100, currency: "dau", type: "seed", icon: "1000000125.png", value: "hat_nguyen_to", category: "hat_may" }, 
    { id: 205, name: "H·∫°t Kim Lo·∫°i",  price: 100, currency: "dau", type: "seed", icon: "1000000126.png", value: "hat_kim_loai", category: "hat_may" },
    { id: 206, name: "H·∫°t T√¨nh Y√™u",  price: 100, currency: "dau", type: "seed", icon: "1000000132.png", value: "hat_tinh_yeu", category: "hat_may" },
    { id: 207, name: "H·∫°t M·∫≠t Ong", price: 100, currency: "dau", type: "seed", icon: "1000000150.png", value: "hat_mat_ong", category: "hat_may" },
];

// --- C·∫¨P NH·∫¨T TH·ªúI GIAN TR·ªíNG C√ÇY (10s - 10s) ---
const PLANT_STAGES = [
    { 
        name: "M·∫ßm Nh·ªè", 
        icon: "1000000110.gif", 
        duration: 0, 
    }, 
    { 
        name: "C√¢y Tr∆∞·ªüng Th√†nh", 
        icon: "1000000130.gif", 
        // Giai ƒëo·∫°n M·∫ßm Nh·ªè k√©o d√†i 10 gi√¢y
        duration: 10 * 1000, 
    }, 
    { 
        name: "S·∫µn S√†ng Thu Ho·∫°ch", 
        icon: "1000000130.gif", 
        // Giai ƒëo·∫°n Tr∆∞·ªüng Th√†nh k√©o d√†i th√™m 10 gi√¢y
        // (T·ªïng th·ªùi gian t·ª´ l√∫c tr·ªìng = 10s + 10s = 20s)
        duration: 20 * 1000, 
    }, 
];

function showPopup(id) {
    document.getElementById('global-overlay').style.display = 'block';
    const el = document.getElementById(id);
    if(el) el.classList.add('popup-active');
}
function hidePopup(id) {
    const el = document.getElementById(id);
    if(el) el.classList.remove('popup-active');

    // --- X√≥a b·ªô ƒë·∫øm gi·ªù khi ƒë√≥ng b·∫•t k·ª≥ b·∫£ng n√†o ---
    if (activePopupInterval) {
        clearInterval(activePopupInterval);
        activePopupInterval = null;
    }

    setTimeout(() => {
        // Ch·ªâ ·∫©n l·ªõp ph·ªß m·ªù khi kh√¥ng c√≤n b·∫£ng n√†o m·ªü
        if(!document.querySelector('.popup-active')) {
            const overlay = document.getElementById('global-overlay');
            if (overlay) overlay.style.display = 'none';
        }
    }, 100); 
}
// --- H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO TOAST (B·∫¢N PRO) ---
function showToast(message, icon = "‚úÖ", title = "Th√¥ng b√°o") {
    let toast = document.getElementById('toast-notification');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        document.body.appendChild(toast);
    }

    // C·∫•u tr√∫c HTML m·ªõi: Icon + Ti√™u ƒë·ªÅ + N·ªôi dung
    toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
    `;

    toast.classList.remove('show');
    void toast.offsetWidth; // Reset animation
    toast.classList.add('show');

    setTimeout(() => {
        if (toast.classList.contains('show')) {
            toast.classList.remove('show');
        }
    }, 3500); // Hi·ªán l√¢u h∆°n x√≠u (3.5s) ƒë·ªÉ k·ªãp ƒë·ªçc
}

// --- H√ÄM C·∫¨P NH·∫¨T H√åNH ·∫¢NH TH·ª¢ R√àN (M·ªöI) ---
function updateBlacksmithVisuals() {
    const idleImg = document.getElementById('chaos-blacksmith');
    const workingImg = document.getElementById('chaos-blacksmith-working');
    
    // Ki·ªÉm tra bi·∫øn craftingQueue (h√†ng ch·ªù r√®n)
    if (craftingQueue && craftingQueue.length > 0) {
        // ƒêang b·∫≠n: ·∫®n ·∫£nh tƒ©nh, Hi·ªán ·∫£nh ƒë·ªông
        if(idleImg) idleImg.style.display = 'none';
        if(workingImg) workingImg.style.display = 'block';
    } else {
        // ƒêang r·∫£nh: Hi·ªán ·∫£nh tƒ©nh, ·∫®n ·∫£nh ƒë·ªông
        if(idleImg) idleImg.style.display = 'block';
        if(workingImg) workingImg.style.display = 'none';
    }
}

const body = document.body; 
const btnNew = document.getElementById("btn-new");
const btnDelete = document.getElementById("btn-delete");
const lightBulb = document.getElementById("light-bulb"); 
const nameBox = document.getElementById("name-box");
const btnNext = document.getElementById("btn-next");
const nameInput = document.getElementById("player-name");
const shopBox = document.getElementById("shop-box");
const playerLevelDisplay = document.getElementById("player-level-display");
const expBarContainer = document.getElementById("exp-bar-container");
const expFill = document.getElementById("exp-fill");
const coinDauShop = document.getElementById("coin-dau-shop"); 
const coinLaShop = document.getElementById("coin-la-shop");   
const coinDauPet = document.getElementById("coin-dau-pet");   
const coinLaPet = document.getElementById("coin-la-pet");     
const seedBox = document.getElementById("seed-box"); 
const coinDauSeed = document.getElementById("coin-dau-seed"); 
const coinLaSeed = document.getElementById("coin-la-seed");   
const seedItemsContainer = document.getElementById("seed-items"); 
const onlineBox = document.getElementById("online-box");
const petHouseBox = document.getElementById("pet-house-box");
const petHouseTitle = document.getElementById("pet-house-title"); 
const petShopItemsContainer = document.getElementById("pet-shop-items"); 
const interactionPopup = document.getElementById("interaction-popup"); 
const interactionTitle = document.getElementById("interaction-title"); 
const interactionText = document.getElementById("interaction-text"); 
const interactionControls = document.getElementById("interaction-controls"); 
const pugPetImg = document.getElementById("pug-pet"); 
const iceEggImg = document.getElementById("ice-egg-img"); 

let currentShopTab = 'pet_may';
let currentPetTab = 'cloud';

function expNeeded(lv){ 
    // N·∫øu lv = 0 ho·∫∑c l·ªói √¢m, tr·∫£ v·ªÅ m·ª©c c∆° b·∫£n l√† 100 ƒë·ªÉ tr√°nh l·ªói chia cho 0 ho·∫∑c v√≤ng l·∫∑p
    if (lv <= 0) return 100; 
    return lv * 100; 
}

function checkLevelUp() {
    let leveledUp = false;
    // V√≤ng l·∫∑p ki·ªÉm tra n·∫øu EXP d∆∞ nhi·ªÅu th√¨ l√™n nhi·ªÅu c·∫•p
    while (level > 0 && exp >= expNeeded(level)) {
        exp -= expNeeded(level);
        level += 1;
        leveledUp = true;
    }
    
    if (leveledUp) { 
        updateDisplay(); 
        updateControlButtons(); 
        
        // --- L∆ØU GAME NGAY KHI L√äN C·∫§P ---
        saveGame(); 
        
        // Hi·ªán th√¥ng b√°o ch√∫c m·ª´ng (n·∫øu c√≥ Toast)
        if(typeof showToast === 'function') {
            showToast(`L√™n c·∫•p ${level} th√†nh c√¥ng!`, "üÜô", "Level Up");
        }
    }
}

function updateControlButtons(){
    const gameCreated = level > 0;
    
    btnNew.disabled = gameCreated;     // Kh√≥a n√∫t "T·∫°o" n·∫øu ƒëang ch∆°i
    btnDelete.disabled = !gameCreated; // M·ªü n√∫t "X√≥a" n·∫øu ƒëang ch∆°i
    
    if (playerLevelDisplay) playerLevelDisplay.innerHTML = gameCreated ? `${playerName} <span style="font-size:0.8em; color:#888;">|</span> Lv.${level}` : `üåæ Farm LOL üåæ`;
    if (expBarContainer) expBarContainer.style.visibility = gameCreated ? 'visible' : 'hidden';
}

function isPetOwned(petValue) { return ownedPets.includes(petValue); }

function activatePet(petValue) {
    const angelData = shopItems.find(i => i.name === "Thi√™n Th·∫ßn");
    const reaperData = shopItems.find(i => i.name === "Th·∫ßn Ch·∫øt");

    if((angelData && petValue === angelData.value) || (reaperData && petValue === reaperData.value)) {
        alert("Pet n√†y kh√¥ng th·ªÉ l√†m Pet ch√≠nh. N√≥ s·∫Ω ·ªü l·∫°i √î s·ªë 1 ƒë·ªÉ b·∫£o v·ªá n√¥ng tr·∫°i!");
        return;
    }
    
    activePet = petValue; 
    
    // üî• L∆ØU GAME NGAY T·∫†I ƒê√ÇY üî•
    saveGame(); 
    
    updateDisplay(); 
    alert(`ƒê√£ k√≠ch ho·∫°t Pet m·ªõi!`);
}

function updateDisplay(){
  if(level > 0 && expFill){
    const needed = expNeeded(level);
    const percent = Math.min(100, (exp / needed) * 100);

    // 1. C·∫≠p nh·∫≠t thanh m√†u xanh (nh∆∞ c≈©)
    expFill.style.width = percent + "%";

    // 2. C·∫≠p nh·∫≠t con s·ªë hi·ªÉn th·ªã (M·ªöI TH√äM)
    const expText = document.getElementById('exp-text-overlay');
    if(expText) {
        // Hi·ªÉn th·ªã d·∫°ng: EXP Hi·ªán T·∫°i / EXP C·∫ßn Thi·∫øt
        expText.innerText = `${Math.floor(exp)} / ${needed}`;
    }
}
  // --- LOGIC M·ªöI: HI·ªÜN THI√äN NGA (KHI ·∫§P) HO·∫∂C B√öA 1000 T·∫§N (KHI N√ÇNG C·∫§P) ---
  const incubatorIcon = document.getElementById("incubator-icon");
  if (incubatorIcon) {
      // Ch·ªâ hi·ªán khi th·ªùi gian ƒë·∫øm ng∆∞·ª£c ƒëang ch·∫°y (> 0)
      if (incubationFinishTime > 0) {
          incubatorIcon.style.display = 'block';

          // KI·ªÇM TRA: ƒêang l√† N√¢ng C·∫•p (isUpgrading = true) hay ·∫§p M·ªõi (isUpgrading = false)?
          if (isUpgrading) {
              // === TR∆Ø·ªúNG H·ª¢P N√ÇNG C·∫§P: HI·ªÜN C√ÅI B√öA 1000 T·∫§N ===
              
              // 1. CH·ªàNH TO / NH·ªé (Size)
              // - TƒÉng s·ªë 60px l√™n (v√≠ d·ª• 80px) ƒë·ªÉ B√öA TO H∆†N
              // - Gi·∫£m xu·ªëng (v√≠ d·ª• 40px) ƒë·ªÉ B√öA NH·ªé ƒêI
              incubatorIcon.innerHTML = '<img src="1000000155.gif" style="width: 50px; height: auto;">';
              
              incubatorIcon.style.fontSize = "50px"; 

              // 2. CH·ªàNH L√äN / XU·ªêNG (Top)
              // - S·ªë √¢m c√†ng L·ªöN (v√≠ d·ª• -80px) -> Bay c√†ng CAO
              // - S·ªë √¢m c√†ng NH·ªé (v√≠ d·ª• -20px) -> Bay c√†ng TH·∫§P (G·∫ßn tr·ª©ng)
              incubatorIcon.style.top = "-60px";    

              // 3. CH·ªàNH TR√ÅI / PH·∫¢I (Margin Left)
              incubatorIcon.style.left = "50%"; // Gi·ªØ nguy√™n d√≤ng n√†y (Tim ch·∫≠u)
              
              // - ƒêi·ªÅn s·ªë D∆Ø∆†NG (v√≠ d·ª• "20px") -> D·ªãch sang PH·∫¢I
              // - ƒêi·ªÅn s·ªë √ÇM (v√≠ d·ª• "-20px") -> D·ªãch sang TR√ÅI
              incubatorIcon.style.marginLeft = "-50px"; 
              
              // 4. Hi·ªáu ·ª©ng xoay v√† b√≥ng ƒë·ªï (Gi·ªØ nguy√™n cho ƒë·∫πp)
              const hammerImg = incubatorIcon.querySelector('img');
              if(hammerImg) {
                  hammerImg.style.transform = "rotate(-20deg)"; // G√≥c nghi√™ng c·ªßa b√∫a
                  hammerImg.style.filter = "drop-shadow(0 5px 5px rgba(0,0,0,0.3))";
              }
          } 
          else {
              // === TR∆Ø·ªúNG H·ª¢P ·∫§P TR·ª®NG M·ªöI: HI·ªÜN THI√äN NGA ===
              incubatorIcon.innerHTML = 'ü¶¢'; // Icon con thi√™n nga
              
              // --- [KHU V·ª∞C CH·ªàNH S·ª¨A] ---

              // 1. TO / NH·ªé (Font Size)
              // - 30px: Nh·ªè xinh
              // - 45px: V·ª´a v·∫∑n (Khuy√™n d√πng)
              // - 60px: Kh·ªïng l·ªì
              incubatorIcon.style.fontSize = "10px"; 

              // 2. L√äN / XU·ªêNG (Top)
              // - S·ªë √¢m c√†ng L·ªöN (v√≠ d·ª• -60px) -> Bay c√†ng CAO
              // - S·ªë √¢m c√†ng NH·ªé (v√≠ d·ª• -10px) -> ƒê·ª©ng c√†ng TH·∫§P (g·∫ßn tr·ª©ng)
              incubatorIcon.style.top = "-18px";     

              // 3. TR√ÅI / PH·∫¢I (Left)
              // - 50%: L√† v·ªã tr√≠ ch√≠nh gi·ªØa (Tim ch·∫≠u)
              // - Nh·ªè h∆°n 50% (v√≠ d·ª• 40%): D·ªãch sang TR√ÅI
              // - L·ªõn h∆°n 50% (v√≠ d·ª• 60%): D·ªãch sang PH·∫¢I
              incubatorIcon.style.left = "40%";
              
              // 4. CƒÇN GI·ªÆA TUY·ªÜT ƒê·ªêI (Quan tr·ªçng)
              // D√≤ng n√†y gi√∫p icon lu√¥n n·∫±m ch√≠nh gi·ªØa, b·∫•t k·ªÉ b·∫°n ch·ªânh size to hay nh·ªè
              // N·∫øu mu·ªën Thi√™n Nga l·ªách h·∫≥n sang tr√°i/ph·∫£i th√¨ x√≥a d√≤ng n√†y ƒëi
              incubatorIcon.style.transform = "translateX(-50%)";
          }
      } else {
          // N·∫øu kh√¥ng l√†m g√¨ th√¨ ·∫©n ƒëi
          incubatorIcon.style.display = 'none';
      }
  }
  const dauStr = dau.toLocaleString('vi-VN');
  const laStr = la.toLocaleString('vi-VN');

  if (coinDauShop) coinDauShop.textContent = dauStr;
  if (coinLaShop) coinLaShop.textContent = laStr;
  if (coinDauPet) coinDauPet.textContent = dauStr;
  if (coinLaPet) coinLaPet.textContent = laStr;
  if (coinDauSeed) coinDauSeed.textContent = dauStr;
  if (coinLaSeed) coinLaSeed.textContent = laStr;
  
  const angelData = shopItems.find(i => i.name === "Thi√™n Th·∫ßn");
  const reaperData = shopItems.find(i => i.name === "Th·∫ßn Ch·∫øt");
  const biGaiData = shopItems.find(i => i.name === "Bi Gai"); // <--- M·ªöI: L·∫•y th√¥ng tin Bi Gai
  
  // ... (gi·ªØ nguy√™n ph·∫ßn code hi·ªÉn th·ªã Slot 1 ·ªü gi·ªØa n·∫øu c√≥) ...

    // --- S·ª¨A L·ªñI PET: D√πng container ƒë·ªÉ ƒë·ªãnh v·ªã ---
    const petContainer = document.getElementById("pet-container");
    
    if (pugPetImg && petContainer) {
      // D∆∞·ªõi ƒë√¢y l√† c√¢u l·ªánh ki·ªÉm tra: N·∫øu KH√îNG PH·∫¢I Thi√™n Th·∫ßn, KH√îNG PH·∫¢I Th·∫ßn Ch·∫øt, v√† KH√îNG PH·∫¢I Bi Gai th√¨ m·ªõi hi·ªán d∆∞·ªõi ƒë·∫•t
      if (activePet && 
          !(angelData && activePet === angelData.value) && 
          !(reaperData && activePet === reaperData.value) &&
          !(biGaiData && activePet === biGaiData.value) // <--- M·ªöI: Ch·∫∑n Bi Gai hi·ªán d∆∞·ªõi ƒë·∫•t
      ) { 
          pugPetImg.src = activePet;
          pugPetImg.style.display = 'block'; 
          
          // 1. X·ª≠ l√Ω hi·ªáu ·ª©ng th·ªü
          if (activePet.includes("1000000106.png")) {
              pugPetImg.classList.add("pet-breathing-effect");
          } else {
              pugPetImg.classList.remove("pet-breathing-effect");
          }

          let petData = petShopItems.find(p => p.value === activePet);
          if (!petData) petData = shopItems.find(p => p.value === activePet);
          
          // 2. X·ª≠ l√Ω k√≠ch th∆∞·ªõc (Set v√†o container)
          if (petData && petData.customWidth) {
              petContainer.style.width = petData.customWidth;
          } else {
              petContainer.style.width = "120px"; // Size m·∫∑c ƒë·ªãnh
          }

          // 3. X·ª≠ l√Ω v·ªã tr√≠ (Set v√†o container)
          if (petData && petData.position) {
              petContainer.style.bottom = petData.position.bottom;
              petContainer.style.left = petData.position.left;
              petContainer.style.transform = 'none'; // B·ªè cƒÉn gi·ªØa n·∫øu ƒë√£ c√≥ v·ªã tr√≠ c·ª• th·ªÉ
          } else {
              petContainer.style.bottom = '35px';
              petContainer.style.left = '50%';
              petContainer.style.transform = 'translateX(-50%)'; // CƒÉn gi·ªØa
          }
      } else {
          pugPetImg.src = "";
          pugPetImg.style.display = 'none';
          pugPetImg.classList.remove("pet-breathing-effect"); 
      }
  }
  // --- S·ª¨A L·ªñI SLOT 1: C·∫¨P NH·∫¨T H√åNH ·∫¢NH & K√çCH TH∆Ø·ªöC CHU·∫®N ---
  const slot1Img = document.getElementById("ice-egg-img");
  
  if (slot1Img && !isHarvesting) {
      // X√≥a s·∫°ch c√°c class c≈©
      slot1Img.classList.remove('fix-egg', 'fix-angel', 'fix-reaper', 'fix-bigai');

      // 1. TR∆Ø·ªúNG H·ª¢P: TR·ª®NG ƒê√É N·ªû (ƒê√£ ho√†n th√†nh ·∫•p)
      if (isIceDragonHatched) {
          slot1Img.style.display = 'block';
          slot1Img.style.animation = "none"; 
          slot1Img.style.transform = "none"; 
          
          // [QUAN TR·ªåNG] Ki·ªÉm tra lo·∫°i Pet ƒë·ªÉ g√°n ·∫£nh ƒë√∫ng
          if (hatchedPetType === 'than_chet') {
              slot1Img.src = "1000000104.gif";
              slot1Img.classList.add('fix-reaper'); 
          }
          else if (hatchedPetType === 'bi_gai') {
              // G√°n ·∫£nh Bi Gai v√† class fix v·ªã tr√≠
              slot1Img.src = "1000000149.gif";
              slot1Img.classList.add('fix-bigai');  
          }
          else {
              // M·∫∑c ƒë·ªãnh l√† Thi√™n Th·∫ßn
              slot1Img.src = "1000000127.gif"; 
              slot1Img.classList.add('fix-angel');  
          }
      }
      
      // 2. TR∆Ø·ªúNG H·ª¢P: ƒêANG L√Ä QU·∫¢ TR·ª®NG (Ch∆∞a n·ªü)
      else if (hasIceEgg) {
          slot1Img.style.display = 'block';
          slot1Img.src = "1000000102.png"; 
          slot1Img.classList.add('fix-egg'); 

          // N·∫øu ƒëang c√≥ th·ªùi gian ƒë·∫øm ng∆∞·ª£c th√¨ rung l·∫Øc
          if (incubationFinishTime > 0) {
             slot1Img.style.animation = "shake-egg 0.5s infinite"; 
          } else {
             slot1Img.style.animation = "none"; 
             slot1Img.style.transform = "none"; 
          }
      } 
      else {
          slot1Img.style.display = 'none';
          slot1Img.src = "";
      }
  }

  FARM_IDS.forEach((slotId, index) => {
      const seedImg = document.getElementById(`seed-img-${slotId}`);
      const baseImg = document.querySelector(`#slot-${slotId} .pot-base-img`);
      const slotData = farmSlots[index];

      let potType = equippedPots[index] || 'so_dua';
      let potImgSrc = POT_DEFINITIONS[potType] ? POT_DEFINITIONS[potType].img : "1000000112.png";
      
      if (baseImg) baseImg.src = potImgSrc;

      if(seedImg && baseImg) {
          if(slotData) {
              let currentStage = PLANT_STAGES[slotData.stage];
              let useIcon = currentStage.icon; 
              
              // --- X·ª¨ L√ù ICON CHO GIAI ƒêO·∫†N 1 & 2 ---
              if (slotData.stage === 1) { 
                  if (slotData.value === 'hat_kim_loai') useIcon = "1000000111.gif"; 
                  else if (slotData.value === 'hat_nguyen_to') useIcon = "1000000113.gif";
                  else if (slotData.value === 'hat_tinh_yeu') useIcon = "1000000133.gif";
                  else if (slotData.value === 'hat_mat_ong') useIcon = "1000000151.gif";
              }
              else if (slotData.stage === 2) {
                   if (slotData.value === 'hat_kim_loai') useIcon = "1000000124.gif"; 
                   else if (slotData.value === 'hat_nguyen_to') useIcon = "1000000114.gif";
                   else if (slotData.value === 'hat_tinh_yeu') useIcon = "1000000134.gif";
                   else if (slotData.value === 'hat_mat_ong') useIcon = "1000000152.gif";
              }

              // --- [ƒêO·∫†N CODE ƒê√É ƒê∆Ø·ª¢C G·ªòP G·ªåN G√ÄNG T·∫†I ƒê√ÇY] ---
              
              // 1. Reset s·∫°ch s·∫Ω c√°c class c≈© tr∆∞·ªõc khi g√°n m·ªõi
              seedImg.classList.remove('big-plant', 'medium-plant', 'love-fix', 'shadow-green', 'shadow-metal', 'shadow-element', 'shadow-honey');

              // 2. X·ª≠ l√Ω Giai ƒëo·∫°n M·∫ßm (Stage 0)
              if (slotData.stage === 0) {
                  seedImg.classList.add('shadow-green');
              } 
              // 3. X·ª≠ l√Ω Giai ƒëo·∫°n C√¢y l·ªõn (Stage 1 & 2)
              else if (slotData.stage >= 1) {
                  
                  // A. X·ª≠ l√Ω K√≠ch th∆∞·ªõc (Size)
                  if (slotData.value === 'hat_tinh_yeu') {
                      // C√¢y T√¨nh Y√™u c√≥ logic ri√™ng (Love Fix)
                      seedImg.classList.add('love-fix'); 
                      if (slotData.stage === 1) seedImg.classList.add('medium-plant'); 
                      else seedImg.classList.add('big-plant');
                  }
                  else {
                      // C√°c c√¢y c√≤n l·∫°i (Kim Lo·∫°i, Nguy√™n T·ªë, M·∫≠t Ong...)
                      if (slotData.stage === 1) seedImg.classList.add('medium-plant');
                      else seedImg.classList.add('big-plant');
                  }

                  // B. X·ª≠ l√Ω B√≥ng ƒë·ªï (Shadow) cho t·ª´ng lo·∫°i
                  if (slotData.value === 'hat_kim_loai') {
                      seedImg.classList.add('shadow-metal');
                  }
                  else if (slotData.value === 'hat_nguyen_to') {
                      seedImg.classList.add('shadow-element');
                  }
                  else if (slotData.value === 'hat_mat_ong') {
                      seedImg.classList.add('shadow-honey');
                  }
              }

              // --- K·∫æT TH√öC ƒêO·∫†N G·ªòP ---

              seedImg.src = useIcon;
              seedImg.alt = slotData.name;
              seedImg.style.display = 'block';
              baseImg.style.opacity = '1';
          } else {
              seedImg.style.display = 'none';
              seedImg.src = "";
              seedImg.classList.remove('big-plant', 'medium-plant', 'love-fix', 'shadow-green', 'shadow-metal', 'shadow-element', 'shadow-honey');
              baseImg.style.opacity = '1';
          }
      }
  });
// --- C·∫¨P NH·∫¨T HI·ªÇN TH·ªä V·∫¨T PH·∫®M TREO (ƒê√É T·ªêI ∆ØU) ---
vineDecorations.forEach((itemId, index) => {
  const hangingEl = document.getElementById(`grasshopper-${index}`);
  if (hangingEl) {
      if (itemId) {
          const itemConfig = HANGING_ITEMS_CONFIG.find(i => i.id === itemId);
          if (itemConfig) {
              hangingEl.src = itemConfig.img;
              hangingEl.style.display = 'block';
              
              // √Åp d·ª•ng style t·ª´ config (Code g·ªçn h∆°n r·∫•t nhi·ªÅu)
              if (itemConfig.style) {
                  hangingEl.style.width = itemConfig.style.width || '50px';
                  hangingEl.style.top = itemConfig.style.top || '205px';
                  hangingEl.style.marginLeft = itemConfig.style.marginLeft || '0px';
              }
              
              // Hi·ªáu ·ª©ng l·∫Øc l∆∞
              hangingEl.style.animation = 'swing-grasshopper 3s ease-in-out infinite';
          }
      } else {
          hangingEl.style.display = 'none';
      }
  }
});

  // --- CODE M·ªöI: B·∫≠t s√°ng d√¢y leo khi ƒë·ªß 5 m√≥n ---
  const isFullSet = vineDecorations.every(item => item !== null);
  const vineElements = document.querySelectorAll('.vine-deco');
  
  vineElements.forEach(vine => {
      if (isFullSet) {
          vine.classList.add('vine-glowing');
      } else {
          vine.classList.remove('vine-glowing');
      }
  });
  // ----------------------------------------------
}
// --- ƒê√É S·ª¨A: HI·ªÇN TH·ªä KHO PET ƒê·ªÇ ƒê·ªîI V√Ä C·∫¨P NH·∫¨T NGAY ---
function showCloudPetInventory() {
    interactionTitle.innerHTML = "üêæ Kho Pet M√¢y";
    interactionText.innerHTML = "Ch·ªçn Pet b·∫°n mu·ªën ƒë∆∞a ra b·∫£o v·ªá n√¥ng tr·∫°i:";
    interactionControls.innerHTML = "";

    const container = document.createElement('div');
    container.style.cssText = "display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;";

    const guardianPets = [
        // Th√™m d√≤ng n√†y v√†o ƒë·∫ßu m·∫£ng:
        { type: 'bi_gai',     name: 'Bi Gai',     icon: '1000000149.gif', value: '1000000149.gif' },
        
        // C√°c d√≤ng c≈© gi·ªØ nguy√™n
        { type: 'thien_than', name: 'Thi√™n Th·∫ßn', icon: '1000000127.gif', value: '1000000127.gif' },
        { type: 'than_chet',  name: 'Th·∫ßn Ch·∫øt',  icon: '1000000104.gif', value: '1000000104.gif' }
    ];

    let hasAny = false;

    guardianPets.forEach(p => {
        // Ch·ªâ hi·ªán nh·ªØng con ƒë√£ s·ªü h·ªØu
        if (isPetOwned(p.value)) {
            hasAny = true;
            // Ki·ªÉm tra xem con n√†y c√≥ ph·∫£i con ƒëang n·ªü (active ·ªü slot 1) kh√¥ng
            const isCurrent = (hatchedPetType === p.type);
            
            // L·∫•y level ri√™ng c·ªßa con n√†y
            const pLevel = petLevels[p.type] || 1;
            let stars = "";
            for(let i=0; i<pLevel; i++) stars += "‚≠ê";

            const itemDiv = document.createElement('div');
            itemDiv.className = "shop-item";
            itemDiv.style.borderColor = isCurrent ? "#4CAF50" : "#eee";
            itemDiv.style.background = isCurrent ? "#E8F5E9" : "#fff";

            itemDiv.innerHTML = `
                <img src="${p.icon}" style="width:50px; height:50px; object-fit:contain;">
                <div style="font-weight:bold; margin-top:5px; color:${isCurrent ? '#2E7D32' : '#333'}">${p.name}</div>
                <div style="font-size:0.8em; color:#FF9800;">${stars}</div>
                <button class="btn-select-pet" style="
                    margin-top:8px; width:100%; border:none; border-radius:15px; padding:5px;
                    background: ${isCurrent ? '#ccc' : 'var(--primary)'};
                    color: white; font-size: 0.8em; cursor: ${isCurrent ? 'default' : 'pointer'};
                ">
                    ${isCurrent ? 'ƒêang Ch·ªçn' : 'Ch·ªçn'}
                </button>
            `;

            if (!isCurrent) {
                itemDiv.querySelector('.btn-select-pet').onclick = () => {
                    
                    // --- üî• TH√äM ƒêI·ªÄU KI·ªÜN CH·∫∂N T·∫†I ƒê√ÇY üî• ---
                    if (incubationFinishTime > 0) {
                        alert("‚ö†Ô∏è Slot 1 ƒëang b·∫≠n (·∫§p tr·ª©ng/N√¢ng c·∫•p)!\nKh√¥ng th·ªÉ ƒë·ªïi Pet H·ªô V·ªá l√∫c n√†y.");
                        return;
                    }
                    // ------------------------------------------

                    // Logic ƒë·ªïi Pet
                    hatchedPetType = p.type;
                    petStarLevel = petLevels[p.type] || 1; 

                    // QUAN TR·ªåNG: L∆∞u v√† C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
                    saveGame();
                    updateDisplay(); 
                    
                    if(typeof showToast === 'function') {
                        showToast(`ƒê√£ ƒë·ªïi sang ${p.name}`, "üîÑ", "Th√†nh C√¥ng");
                    } else {
                        alert(`ƒê√£ ƒë·ªïi sang ${p.name}!`);
                    }
                    
                    closeInteractionPopup();

                    // M·ªü l·∫°i popup Slot 1 ƒë·ªÉ th·∫•y th√¥ng tin m·ªõi
                    setTimeout(() => { document.querySelector('#slot-1').click(); }, 300);
                };
            }
            container.appendChild(itemDiv);
        }
    });

    if(!hasAny) {
        container.innerHTML = "<div>B·∫°n ch∆∞a c√≥ Pet n√†o.</div>";
    }

    interactionControls.appendChild(container);
    showPopup('interaction-popup');
}
// --- CODE M·ªöI: showShopPopup ---
function showShopPopup() {
    const wrapper = document.getElementById('shop-tab-container-wrapper');
    if (!wrapper) return;
    wrapper.innerHTML = '';
    
    // ƒê·∫∑t m·∫∑c ƒë·ªãnh l√† h·∫°t m√¢y ƒë·ªÉ hi·ªÉn th·ªã lu√¥n
    currentShopTab = 'hat_may'; 

    // T·∫°o ti√™u ƒë·ªÅ thay v√¨ Tab ch·ªçn
    const title = document.createElement('div');
    title.style.cssText = "font-weight:bold; color:#795548; margin-bottom:10px; text-align:left; border-bottom:1px solid #eee; padding-bottom:5px;";
    title.innerHTML = "üå± Danh s√°ch H·∫°t Gi·ªëng";
    wrapper.appendChild(title);

    const contentContainer = document.createElement('div');
    contentContainer.id = 'shop-content-grid';
    contentContainer.style.cssText = 'max-height: 300px; overflow-y: auto; padding-right:5px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';
    wrapper.appendChild(contentContainer);

    renderShopItems(contentContainer);
    showPopup('shop-box');
}

function switchShopTab(tabName) {
    currentShopTab = tabName;
    showShopPopup();
}

// --- CODE M·ªöI: renderShopItems ---
function renderShopItems(container) {
  container.innerHTML = "";
  // L·ªçc l·∫•y danh s√°ch h·∫°t gi·ªëng
  const itemsToRender = shopItems.filter(item => item.category === 'hat_may');

  itemsToRender.forEach(item => { 
      const itemDiv = document.createElement("div");
      itemDiv.className = "shop-item";
      
      const currencyIcon = item.currency === "dau" ? 'ü´ò' : 'üçÇ';
      const currencyColor = item.currency === "dau" ? '#795548' : '#E65100'; 
      
      // --- THAY ƒê·ªîI: D√πng item-frame ---
      itemDiv.innerHTML = `
        <div class="item-frame" style="margin: 0 auto 8px auto;">
            <img src="${item.icon}" alt="${item.name}" />
        </div>
        <div style="font-weight:700; font-size:0.9em; color: var(--text-main); margin-bottom: 2px;">${item.name}</div>
        <div style="font-size:0.8em; color:var(--text-muted); margin-bottom: 5px;">
          <span style="color:${currencyColor};">${currencyIcon}</span> <b>${item.price.toLocaleString('vi-VN')}</b>
        </div>
        <button class="btn-buy" data-id="${item.id}" data-type="general">Mua</button>
      `;
      container.appendChild(itemDiv);
  });
  
  container.querySelectorAll(".btn-buy").forEach(btn => { 
      btn.addEventListener("click", handleBuy); 
  });
}

function updateShop(){
    // [FIX] Ki·ªÉm tra: Ch·ªâ ch·∫°y khi Shop Box ƒëang c√≥ class 'popup-active' (ƒëang m·ªü)
    const shopBox = document.getElementById('shop-box');
    if(shopBox && shopBox.classList.contains('popup-active')) {
        
        const container = document.getElementById('shop-content-grid');
        // Ch·ªâ v·∫Ω l·∫°i n·∫øu t√¨m th·∫•y khung ch·ª©a n·ªôi dung
        if(container) {
            renderShopItems(container);
        }
    }
}

// --- S·ª¨A L·ªñI: updatePetShop (ƒê√É FIX N√öT MUA KHI ƒêANG ·∫§P) ---
function updatePetShop() {
    if (!petShopItemsContainer) return;
    petShopItemsContainer.innerHTML = "";
    petShopItemsContainer.style.display = "block"; 

    // 1. Ph√¢n lo·∫°i Pet
    const cloudPets = shopItems.filter(i => i.name === "Thi√™n Th·∫ßn" || i.name === "Th·∫ßn Ch·∫øt" || i.name === "Bi Gai");
    const lamePets = petShopItems; 

    // 2. T·∫°o Tab
    const tabContainer = document.createElement("div");
    tabContainer.className = "tab-container"; 
    tabContainer.innerHTML = `
        <button class="tab-btn ${currentPetTab === 'cloud' ? 'active' : ''}" id="btn-tab-cloud">‚òÅÔ∏è Pet M√¢y</button>
        <button class="tab-btn ${currentPetTab === 'lame' ? 'active' : ''}" id="btn-tab-lame">üêï Pet L·ªè</button>
    `;
    petShopItemsContainer.appendChild(tabContainer);

    tabContainer.querySelector("#btn-tab-cloud").onclick = () => { currentPetTab = 'cloud'; updatePetShop(); };
    tabContainer.querySelector("#btn-tab-lame").onclick = () => { currentPetTab = 'lame'; updatePetShop(); };

    // 3. H√†m t·∫°o HTML cho Pet (ƒê√£ s·ª≠a l·ªói hi·ªÉn th·ªã n√∫t "ƒêang ·∫§p")
    const createPetHTML = (item, isCloudPet) => {
        const owned = isPetOwned(item.value); 
        let isActive = false;
        let starDisplay = "";
        let guardianType = "";
        
        // Bi·∫øn ki·ªÉm tra xem Pet n√†y c√≥ ƒëang ƒë∆∞·ª£c ·∫•p kh√¥ng (d√π ch∆∞a s·ªü h·ªØu)
        let isBeingHatched = false; 

        if (isCloudPet) {
            // X√°c ƒë·ªãnh lo·∫°i Guardian d·ª±a tr√™n t√™n
            if (item.name === "Thi√™n Th·∫ßn") guardianType = 'thien_than';
            else if (item.name === "Th·∫ßn Ch·∫øt") guardianType = 'than_chet';
            else if (item.name === "Bi Gai") guardianType = 'bi_gai';
            
            isActive = (hatchedPetType === guardianType);
            
            // Ki·ªÉm tra: N·∫øu lo·∫°i Pet trong Shop tr√πng v·ªõi lo·∫°i ƒëang ·∫•p V√Ä (ƒëang c√≥ tr·ª©ng ho·∫∑c ƒëang ƒë·∫øm ng∆∞·ª£c)
            // Th√¨ ƒë√°nh d·∫•u l√† ƒëang ·∫•p ƒë·ªÉ kh√≥a n√∫t Mua
            if (hatchedPetType === guardianType && (hasIceEgg || incubationFinishTime > 0)) {
                isBeingHatched = true;
            }
            // --------------------------------

            if (owned) {
                // N·∫øu ƒë√£ s·ªü h·ªØu nh∆∞ng ƒëang trong qu√° tr√¨nh n√¢ng c·∫•p/·∫•p l·∫°i
                const isHatching = (isActive && incubationFinishTime > 0);
                
                if (isHatching) {
                    starDisplay = `<div style="color:#795548; font-size:0.7em; margin-bottom:3px; font-weight:bold; font-style:italic;">ü•ö ƒêang ·∫•p...</div>`;
                } else {
                    const pLevel = petLevels[guardianType] || 1;
                    for(let i=0; i<pLevel; i++) starDisplay += "‚≠ê";
                    starDisplay = `<div style="color:#FF9800; font-size:0.7em; margin-bottom:3px;">${starDisplay}</div>`;
                }
            }
        } else {
            // Pet th∆∞·ªùng (ƒëi d·∫°o)
            isActive = (item.value === activePet);
        }

        const currencyIcon = item.currency === "la" ? 'üçÇ' : 'ü´ò';
        const currencyColor = item.currency === "la" ? '#E65100' : '#795548';
        const priceDisplay = `<span style="font-size:0.8em; color:${currencyColor};">${currencyIcon}</span> ${item.price.toLocaleString('vi-VN')}`;

        let buttonHTML = '';
        
        // --- ∆ØU TI√äN 1: N·∫øu Pet n√†y ƒëang ƒë∆∞·ª£c ·∫•p (k·ªÉ c·∫£ ch∆∞a s·ªü h·ªØu) -> Hi·ªán n√∫t ƒêang ·∫§p ---
        if (isCloudPet && isBeingHatched) {
             buttonHTML = `<button disabled style="background:#FF9800; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%; opacity:0.9; cursor: not-allowed;">‚è≥ ƒêang ·∫§p</button>`;
        }
        // --- ∆ØU TI√äN 2: N·∫øu ch∆∞a s·ªü h·ªØu -> Hi·ªán n√∫t Mua ---
        else if (!owned) {
            let buyType = isCloudPet ? "general" : "pet-shop-internal";
            buttonHTML = `<button class="btn-buy-pet" data-id="${item.id}" data-type="${buyType}" style="background:var(--primary);">Mua</button>`;
        } 
        // --- ∆ØU TI√äN 3: ƒê√£ s·ªü h·ªØu ---
        else if (isActive) {
            // Tr∆∞·ªùng h·ª£p n√†y d√†nh cho Pet ƒëang ho·∫°t ƒë·ªông
            buttonHTML = `<button disabled style="background:#4CAF50; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%; opacity:0.8;">‚úÖ ƒêang D√πng</button>`;
        } else {
            // ƒê√£ s·ªü h·ªØu nh∆∞ng ch∆∞a ch·ªçn
            buttonHTML = `<button class="btn-activate-pet" data-value="${item.value}" data-guardian="${isCloudPet ? guardianType : ''}" style="background:#2196F3; color:white; border:none; border-radius:8px; padding:5px; font-size:11px; width:100%; cursor:pointer;">Ch·ªçn</button>`;
        }

        const itemDiv = document.createElement("div");
        itemDiv.className = "pet-shop-item";
        
        // --- Code hi·ªÉn th·ªã item-frame ---
        itemDiv.innerHTML = `
            <div class="item-frame" style="margin-bottom:8px;">
                <img src="${item.icon}" alt="${item.name}" />
            </div>
            <div style="font-weight:700; font-size:0.9em; margin: 0 0 4px 0; color:var(--text-main);">${item.name}</div>
            ${starDisplay}
            <div style="font-size:0.8em; margin-bottom:5px;">${owned ? '<span style="color:#4CAF50; font-weight:bold;">ƒê√£ s·ªü h·ªØu</span>' : priceDisplay}</div>
            <div style="width:100%;">${buttonHTML}</div>
        `;
        return itemDiv;
    };

    // 4. V·∫Ω danh s√°ch
    const gridContainer = document.createElement("div");
    gridContainer.style.cssText = "display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;";

    if (currentPetTab === 'cloud') {
        const note = document.createElement("div");
        note.innerHTML = "(H·ªô V·ªá: B·∫£o v·ªá n√¥ng tr·∫°i & Auto thu ho·∫°ch)";
        note.style.cssText = "grid-column: span 2; font-size: 0.8em; color: #1976D2; text-align: center; margin-bottom: 5px;";
        gridContainer.appendChild(note);
        cloudPets.forEach(pet => gridContainer.appendChild(createPetHTML(pet, true)));
    } else {
        const note = document.createElement("div");
        note.innerHTML = "(ƒêi D·∫°o: Ch·∫°y lon ton cho vui & T·∫∑ng qu√†)";
        note.style.cssText = "grid-column: span 2; font-size: 0.8em; color: #E65100; text-align: center; margin-bottom: 5px;";
        gridContainer.appendChild(note);
        lamePets.forEach(pet => gridContainer.appendChild(createPetHTML(pet, false)));
    }

    petShopItemsContainer.appendChild(gridContainer);

    // 5. S·ª± ki·ªán
    petShopItemsContainer.querySelectorAll(".btn-buy-pet").forEach(btn => { btn.addEventListener("click", handleBuy); });
    
    petShopItemsContainer.querySelectorAll(".btn-activate-pet").forEach(btn => {
        btn.addEventListener("click", (e) => { 
            const val = e.target.getAttribute("data-value");
            const gType = e.target.getAttribute("data-guardian");
            if (gType) {
                if (incubationFinishTime > 0) { alert("‚ö†Ô∏è ƒêang b·∫≠n!"); return; }
                hatchedPetType = gType;
                petStarLevel = petLevels[gType] || 1; 
                saveGame(); updateDisplay(); updatePetShop(); 
            } else {
                activatePet(val); updatePetShop(); 
            }
        });
    });
}

function updateSeedShop() {
    if (!seedItemsContainer) return;
    seedItemsContainer.innerHTML = "";
    const seedShopMap = new Map();
    shopItems.filter(item => item.type === 'seed').forEach(item => seedShopMap.set(item.value, item));
    const ownedSeedValues = Object.keys(ownedSeeds).filter(key => seedShopMap.has(key));

    if(ownedSeedValues.length === 0 || Object.values(ownedSeeds).every(v => v === 0)) {
        seedItemsContainer.innerHTML = `<div style="text-align: center; color: var(--text-muted); margin: 20px 0;">Kho h·∫°t gi·ªëng tr·ªëng.</div>`;
    }
    ownedSeedValues.forEach(seedValue => {
        const item = seedShopMap.get(seedValue);
        const ownedAmount = ownedSeeds[seedValue] || 0;
        if(ownedAmount === 0) return;
        
        const itemDiv = document.createElement("div");
        itemDiv.className = "shop-item";
        itemDiv.style.flexDirection = "row"; 
        
        const priceDisplay = `<span style="font-size:1em; color:#795548;">ü´ò</span> ${item.price}`;
        
        itemDiv.innerHTML = `
            <div style="display:flex; align-items:center;">
                <img src="${item.icon}" style="width:50px; height:50px; margin-right:10px;" />
                <div style="text-align:left;">
                    <div style="font-weight:700;">${item.name}</div>
                    <div style="font-size:0.85em; color:var(--text-muted);">ƒêang c√≥: <b>${ownedAmount}</b></div>
                </div>
            </div>
            <div style="text-align:right;">
                <button class="btn-buy" data-id="${item.id}" data-type="seed-shop-internal" style="width:auto; padding:6px 15px;">Mua th√™m</button>
            </div>
        `;
        seedItemsContainer.appendChild(itemDiv);
    });
    document.querySelectorAll(".btn-buy[data-type='seed-shop-internal']").forEach(btn => { btn.addEventListener("click", handleBuy); });
    updateDisplay();
}

// --- H√ÄM MUA H√ÄNG HO√ÄN CH·ªàNH (ƒê√É T·ªêI ∆ØU GIAO D·ªäCH) ---
function handleBuy(event) {
  const itemId = parseInt(event.target.getAttribute("data-id"));
  const itemType = event.target.getAttribute("data-type");
  let item = null;
  
  // T√¨m item trong c√°c danh s√°ch
  if (itemType === "general") item = shopItems.find(i => i.id === itemId);
  if (!item && itemType === "pet-shop-internal") item = petShopItems.find(i => i.id === itemId);
  if (!item && itemType === "seed-shop-internal") {
      item = shopItems.find(i => i.id === itemId && i.type === 'seed');
  }
  
  if (!item) return;

  // ============================================================
  // [1. KI·ªÇM TRA AN TO√ÄN: VALIDATION TR∆Ø·ªöC KHI TR·ª™ TI·ªÄN]
  // ============================================================
  // N·∫øu ng∆∞·ªùi ch∆°i ƒë·ªãnh mua Pet H·ªô V·ªá (Bi Gai/Thi√™n Th·∫ßn/Th·∫ßn Ch·∫øt)
  if (item.name === "Thi√™n Th·∫ßn" || item.name === "Th·∫ßn Ch·∫øt" || item.name === "Bi Gai") {
      // Ki·ªÉm tra ngay l·∫≠p t·ª©c: Slot 1 c√≥ ƒëang b·∫≠n kh√¥ng?
      if (hasIceEgg || incubationFinishTime > 0) {
          alert("‚ö†Ô∏è Slot 1 ƒëang b·∫≠n (C√≥ tr·ª©ng ho·∫∑c ƒëang ·∫•p)!\nH√£y ch·ªù qu√° tr√¨nh hi·ªán t·∫°i ho√†n t·∫•t.");
          return; // D·ª´ng l·∫°i ngay, KH√îNG tr·ª´ ti·ªÅn, KH√îNG c·∫ßn ho√†n ti·ªÅn
      }
  }
  // ============================================================
  
  // 1. MUA H·∫†T GI·ªêNG (Logic gi·ªØ nguy√™n)
  if (item.type === 'seed') {
      const currencyName = item.currency === 'la' ? 'L√°' : 'ƒê·∫≠u';
      let quantityStr = prompt(`B·∫°n mu·ªën mua bao nhi√™u ${item.name}?\n(Gi√°: ${item.price} ${currencyName}/h·∫°t)`, "1");
      
      if (quantityStr === null) return;
      let quantity = parseInt(quantityStr);
      
      if (isNaN(quantity) || quantity <= 0) {
          alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!"); return;
      }
      
      let totalCost = item.price * quantity;
      let userMoney = (item.currency === 'la') ? la : dau;

      if (userMoney >= totalCost) {
          if (confirm(`T·ªïng ti·ªÅn l√† ${totalCost.toLocaleString('vi-VN')} ${currencyName}. B·∫°n ch·∫Øc ch·∫Øn mu·ªën mua ${quantity} h·∫°t ch·ª©?`)) {
              if (item.currency === 'la') la -= totalCost;
              else dau -= totalCost;

              if (ownedSeeds[item.value] !== undefined) ownedSeeds[item.value] += quantity;
              else ownedSeeds[item.value] = quantity;
              
              alert(`ƒê√£ mua th√†nh c√¥ng ${quantity}x ${item.name}!`);
              saveGame(); 
              updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
          }
      } else {
          alert(`B·∫°n kh√¥ng ƒë·ªß ${currencyName}! C·∫ßn ${totalCost.toLocaleString('vi-VN')} ${currencyName}.`);
      }
      return; 
  }
  
  // 2. KI·ªÇM TRA ƒê√É C√ì PET CH∆ØA (Logic gi·ªØ nguy√™n)
  if (item.type === "pet" && isPetOwned(item.value)) { 
      alert(`${item.name} ƒë√£ ƒë∆∞·ª£c s·ªü h·ªØu!`); return; 
  }

  // 3. LOGIC MUA PET/ITEM KH√ÅC (B·∫Øt ƒë·∫ßu giao d·ªãch)
  let canBuy = false;
  // Ki·ªÉm tra ƒë·ªß ti·ªÅn th√¨ tr·ª´ ti·ªÅn
  if (item.currency === "dau" && dau >= item.price) { dau -= item.price; canBuy = true; } 
  else if (item.currency === "la" && la >= item.price) { la -= item.price; canBuy = true; }

  if (canBuy) {
    if (item.type === "tool") { 
        tool = item.value; alert(`B·∫°n ƒë√£ trang b·ªã ${item.name}!`); 
    } 
    
    // === [LOGIC MUA PET M·ªöI - ƒê√É ƒê∆Ø·ª¢C L√ÄM S·∫†CH] ===
    else if (item.type === "pet") { 
        // Ki·ªÉm tra Pet H·ªô V·ªá
        if (item.name === "Thi√™n Th·∫ßn" || item.name === "Th·∫ßn Ch·∫øt" || item.name === "Bi Gai") {
             
             // L∆∞u √Ω: Kh√¥ng c·∫ßn ki·ªÉm tra Slot 1 ·ªü ƒë√¢y n·ªØa v√¨ ƒë√£ ki·ªÉm tra ·ªü ƒë·∫ßu h√†m r·ªìi.
             // Ch·∫Øc ch·∫Øn Slot 1 ƒëang tr·ªëng th√¨ code m·ªõi ch·∫°y ƒë·∫øn d√≤ng n√†y.

             // THI·∫æT L·∫¨P TR·∫†NG TH√ÅI TR·ª®NG
             hasIceEgg = true; 
             isIceDragonHatched = false; 
             isIceDragonEvolved = false; 
             isUpgrading = false; // ƒê√°nh d·∫•u l√† ·∫§p M·ªõi

             // G√ÅN ƒê√öNG LO·∫†I PET V·ª™A MUA
             if (item.name === "Thi√™n Th·∫ßn") hatchedPetType = "thien_than";
             else if (item.name === "Th·∫ßn Ch·∫øt") hatchedPetType = "than_chet";
             else if (item.name === "Bi Gai") hatchedPetType = "bi_gai"; 
             
             // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
             incubationFinishTime = Date.now() + GAME_CONFIG.TIME_HATCH; 
             
             alert(`Mua th√†nh c√¥ng Tr·ª©ng ${item.name}!\nQu√° tr√¨nh ·∫•p (24h) ƒë√£ T·ª∞ ƒê·ªòNG b·∫Øt ƒë·∫ßu t·∫°i Slot 1.`);
             
             hidePopup('shop-box'); 
             updateDisplay();
        } 
        // Pet ƒëi d·∫°o th∆∞·ªùng
        else {
             if (!ownedPets.includes(item.value)) ownedPets.push(item.value);
             activePet = item.value; 
             alert(`B·∫°n ƒë√£ mua Pet ${item.name}! Pet ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!`);
             if(itemType === "general") hidePopup('shop-box');
        }
    }

    else if (item.type === "pot_base") {
        if (ownedPots[item.value] !== undefined) ownedPots[item.value] += 1;
        else ownedPots[item.value] = 1;
        alert(`B·∫°n ƒë√£ mua 1x ${item.name}!`);
    }

    // üî• L∆ØU GAME NGAY SAU KHI GIAO D·ªäCH TH√ÄNH C√îNG üî•
    saveGame(); 

    // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
    updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
    
  } else { alert("Kh√¥ng ƒë·ªß ƒê·∫≠u ho·∫∑c L√°!"); }
}

function handleNewGame(){
    closeFishingPopup(); // D·ª´ng c√¢u c√° ngay l·∫≠p t·ª©c
    
    showPopup('name-box');
    hidePopup('shop-box');
    hidePopup('online-box');
    hidePopup('pet-house-box'); 
    hidePopup('interaction-popup'); 
    hidePopup('seed-box'); 
}
btnNew.addEventListener('click', handleNewGame);

// --- N√öT TI·∫æP THEO (T·∫†O GAME) ---
btnNext.addEventListener('click', () => {
    let inputName = nameInput.value.trim();
    const nameRegex = new RegExp(/^[\p{L}\p{N}]{2,12}$/u); 
    
    if (inputName.length < 2 || inputName.length > 12) {
        alert("T√™n ng∆∞·ªùi ch∆°i ph·∫£i t·ª´ 2 ƒë·∫øn 12 k√Ω t·ª±!"); return;
    }
    if (!nameRegex.test(inputName)) {
        alert("T√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i v√† s·ªë!"); return;
    }
    
    playerName = inputName;
    hidePopup('name-box');
    
    // --- RESET C√ÅC CH·ªà S·ªê C∆† B·∫¢N ---
    farmIcon = "üè†"; 
    level = 1; exp = 0; 
    dau = 1000; la = 100; 
    
    // Reset Pet ƒëi d·∫°o
    activePet = "1000000128.gif"; 
    ownedPets = ["1000000128.gif"]; 

    // --- C·∫§U H√åNH PET KH·ªûI ƒê·∫¶U (BI GAI) ---
    hasIceEgg = true; 
    hatchedPetType = "bi_gai"; // M·∫∑c ƒë·ªãnh l√† Bi Gai
    
    // Th√™m Bi Gai v√†o kho ngay ƒë·ªÉ tr√°nh l·ªói Shop
    ownedPets.push("1000000149.gif");

    // B·∫Øt ƒë·∫ßu ·∫•p tr·ª©ng (Th·ªùi gian ch·ªù m·∫∑c ƒë·ªãnh)
    incubationFinishTime = Date.now() + GAME_CONFIG.TIME_STARTER; 

    isIceDragonHatched = false; 
    isIceDragonEvolved = false;

    // --- RESET LEVEL PET V·ªÄ 1 ---
    petLevels = { 'thien_than': 1, 'than_chet': 1, 'bi_gai': 1 };
    petStarLevel = 1;

    // Reset kho h·∫°t gi·ªëng & ch·∫≠u
    ownedSeeds = { 'hat_nguyen_to': 1, 'hat_kim_loai': 1, 'hat_tinh_yeu': 1, 'hat_mat_ong': 1 };
    ownedPots = { 'so_dua': 0, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 }; 
    equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua']; 
    
    // Reset c√°c bi·∫øn ph·ª•
    lastFedTime = 0; 
    lastBeePokeTime = 0; 
    farmSlots = Array(5).fill(null); 
    globalPetAge = 0;
    vineDecorations = [null, null, null, null, null]; 
    ownedDecorations = { 'chau_chau': 0 };
    ownedArtifacts = { 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0, 'tui_mat': 0 };
    grasshopperExchanged = 0;  
    usedGiftcodes = [];        

    // C·∫≠p nh·∫≠t giao di·ªán
    checkBeeHiveSpawn();      
    updateGiftcodeBoxState(); 
    updateDisplay(); 
    updateControlButtons();
    
    // L∆∞u game ngay l·∫≠p t·ª©c
    saveGame(); 

    alert(`Ch√†o m·ª´ng ${playerName}!\nB·∫°n nh·∫≠n ƒë∆∞·ª£c TR·ª®NG BI GAI ƒëang ·∫•p ·ªü Slot 1!`);
});

function loadGame(){
    const savedGame = localStorage.getItem('farmLolGame');
    if(savedGame){
        try {
            // Th·ª≠ gi·∫£i m√£ d·ªØ li·ªáu save
            const gameData = JSON.parse(savedGame);
            
            // 1. T·∫£i c√°c ch·ªâ s·ªë c∆° b·∫£n
            playerName = gameData.playerName || "N√¥ng d√¢n"; 
            farmIcon = gameData.farmIcon || "üåæ"; 
            level = gameData.level || 0; 
            exp = gameData.exp || 0;
            dau = gameData.dau !== undefined ? gameData.dau : (gameData.xu !== undefined ? gameData.xu : 0);
            la = gameData.la !== undefined ? gameData.la : (gameData.usd !== undefined ? gameData.usd : 0);
            
            // 2. T·∫£i c√¥ng c·ª• & √î ƒë·∫•t
            tool = gameData.tool;
            farmSlots = Array.isArray(gameData.farmSlots) ? gameData.farmSlots : Array(5).fill(null);
            while(farmSlots.length < 5) farmSlots.push(null);
            
            // 3. T·∫£i Pet & Tr·∫°ng th√°i Tr·ª©ng
            activePet = gameData.activePet || null; 
            ownedPets = Array.isArray(gameData.ownedPets) ? gameData.ownedPets : []; 
            hasIceEgg = gameData.hasIceEgg || false; 
            isIceDragonHatched = gameData.isIceDragonHatched || false; 
            isIceDragonEvolved = gameData.isIceDragonEvolved || false;
            hatchedPetType = gameData.hatchedPetType || "thien_than"; 
            incubationFinishTime = gameData.incubationFinishTime || 0; 
            
            // T·∫£i Level Pet (ƒê√£ fix l·ªói Bi Gai)
            if (gameData.petLevels) {
                petLevels = gameData.petLevels;
                if (typeof petLevels['bi_gai'] === 'undefined') petLevels['bi_gai'] = 1;
            } else {
                petLevels = { 'thien_than': 1, 'than_chet': 1, 'bi_gai': 1 };
                if (gameData.petStarLevel) petLevels[hatchedPetType] = gameData.petStarLevel;
            }
            petStarLevel = petLevels[hatchedPetType] || 1;

            // ============================================================
            // --- [S·ª¨A L·ªñI T∆Ø∆†NG TH√çCH] ---
            // ƒê·ªãnh nghƒ©a danh s√°ch m·∫∑c ƒë·ªãnh ƒê·∫¶Y ƒê·ª¶ c√°c m√≥n ƒë·ªì m·ªõi nh·∫•t
            // Sau ƒë√≥ merge file save c≈© v√†o. C√°i n√†o thi·∫øu s·∫Ω l·∫•y m·∫∑c ƒë·ªãnh = 0.
            // ============================================================

            // 4. T·∫£i H·∫°t gi·ªëng
            const defaultSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0, 'hat_tinh_yeu': 0, 'hat_mat_ong': 0 };
            ownedSeeds = Object.assign({}, defaultSeeds, gameData.ownedSeeds || {}); 
            
            // 5. T·∫£i Ch·∫≠u
            const defaultPots = { 'so_dua': 5, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 };
            ownedPots = Object.assign({}, defaultPots, gameData.ownedPots || {});

            // T·∫£i h√†ng ch·ªù r√®n & ch·∫≠u ƒëang ƒëeo
            craftingQueue = Array.isArray(gameData.craftingQueue) ? gameData.craftingQueue : [];
            equippedPots = Array.isArray(gameData.equippedPots) ? gameData.equippedPots : ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua'];
            
            // 6. T·∫£i ch·ªâ s·ªë ph·ª• & Kho nguy√™n li·ªáu (Artifacts)
            lastFedTime = gameData.lastFedTime || 0;
            lastBeePokeTime = gameData.lastBeePokeTime || 0;
            globalPetAge = gameData.globalPetAge || 0;
            vineDecorations = Array.isArray(gameData.vineDecorations) ? gameData.vineDecorations : [null, null, null, null, null];
            ownedDecorations = gameData.ownedDecorations || { 'chau_chau': 0 };

            // [FIX QUAN TR·ªåNG] Th√™m c√°c item m·ªõi (nh·ªông, t√∫i m·∫≠t, c√°...) v√†o danh s√°ch m·∫∑c ƒë·ªãnh
            const defaultArtifacts = { 
                'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0, 
                'nhong_ong': 0, 'tui_mat': 0, 
                'ca_tre': 0, 'ca_do': 0, 'ca_tai_tuong': 0 
            };
            ownedArtifacts = Object.assign({}, defaultArtifacts, gameData.ownedArtifacts || {});

            grasshopperExchanged = gameData.grasshopperExchanged || 0;
            usedGiftcodes = Array.isArray(gameData.usedGiftcodes) ? gameData.usedGiftcodes : [];
            isUpgrading = gameData.isUpgrading || false;

        } catch (e) {
            console.error("File save b·ªã l·ªói:", e);
            alert("‚ö†Ô∏è D·ªØ li·ªáu c≈© b·ªã l·ªói c·∫•u tr√∫c. Game s·∫Ω t·ª± ƒë·ªông s·ª≠a ch·ªØa ƒë·ªÉ b·∫°n ti·∫øp t·ª•c ch∆°i.");
            // Kh√¥ng x√≥a localStorage ƒë·ªÉ ng∆∞·ªùi ch∆°i c√≥ c∆° h·ªôi c·ª©u v√£n d·ªØ li·ªáu n·∫øu c·∫ßn
        }
    }
}

function deleteGame(){
    if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a n√¥ng tr·∫°i hi·ªán t·∫°i?")){
        closeFishingPopup();
        localStorage.removeItem('farmLolGame');
        
        // 1. Reset ch·ªâ s·ªë ng∆∞·ªùi ch∆°i
        playerName = "N√¥ng d√¢n"; farmIcon = "üåæ"; level = 0; exp = 0; 
        dau = 0; la = 0; 
        
        // 2. Reset c√¢y tr·ªìng v√† pet
        farmSlots = Array(5).fill(null); 
        activePet = null; ownedPets = []; 
        hasIceEgg = false; 
        isIceDragonHatched = false; 
        isIceDragonEvolved = false; 
        hatchedPetType = "thien_than";
        incubationFinishTime = 0;
        
        // --- RESET LEVEL PET ---
        // X√≥a d·ªØ li·ªáu c·∫•p sao c≈©
        petLevels = { 'thien_than': 1, 'than_chet': 1, 'bi_gai': 1 };
        petStarLevel = 1;
        // ----------------------------------------
        
        // 3. Reset kho v√† ch·∫≠u
        ownedSeeds = { 'hat_nguyen_to': 0, 'hat_kim_loai': 0, 'hat_tinh_yeu': 0, 'hat_mat_ong': 0 };
        ownedPots = { 'so_dua': 0, 'chau_dong': 0, 'chau_bac': 0, 'chau_vang': 0, 'chau_bach_kim': 0, 'chau_kim_cuong': 0, 'chau_kim_cuong_do': 0 };
        equippedPots = ['so_dua', 'so_dua', 'so_dua', 'so_dua', 'so_dua'];
        
        // Reset h√†ng ch·ªù r√®n
        craftingQueue = []; 
        
        // Reset bi·∫øn ph·ª•
        lastFedTime = 0; globalPetAge = 0;
        vineDecorations = [null, null, null, null, null];
        ownedDecorations = { 'chau_chau': 0 };
        ownedArtifacts = { 'manh_nguyen_to': 0, 'manh_kim_loai': 0, 'vuong_mien': 0 }; 
        grasshopperExchanged = 0;  
        usedGiftcodes = [];        

        // X√≥a qu·∫£ ƒë√†o (n·∫øu ƒëang hi·ªán)
        const rewardIcon = document.getElementById('daily-reward-icon');
        if(rewardIcon) rewardIcon.remove();

        // C·∫≠p nh·∫≠t giao di·ªán v·ªÅ m√†n h√¨nh ch√†o
        checkBeeHiveSpawn();      
        updateGiftcodeBoxState(); 
        updateDisplay(); 
        updateControlButtons();
        
        // Th·ª£ R√®n tr·∫°ng th√°i tƒ©nh
        updateBlacksmithVisuals(); 

        alert("ƒê√£ x√≥a n√¥ng tr·∫°i!");
    }
}
btnDelete.addEventListener('click', deleteGame);

const kintoCloud = document.getElementById("kinto-cloud");
if (kintoCloud) {
    kintoCloud.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showShopPopup();
    });
}
// --- LOGIC B·∫¨T/T·∫ÆT ƒê√àN (C·∫¨P NH·∫¨T M·ªöI) ---
if (lightBulb) {
    lightBulb.addEventListener("click", () => {
        // 1. B·∫≠t/T·∫Øt class dark-mode
        body.classList.toggle('dark-mode');
        
        // 2. Ki·ªÉm tra xem ƒëang T·ªëi hay S√°ng
        const isDark = body.classList.contains('dark-mode');
        
        // 3. L∆∞u tr·∫°ng th√°i v√†o tr√¨nh duy·ªát (ƒë·ªÉ F5 kh√¥ng b·ªã m·∫•t)
        localStorage.setItem('darkMode', isDark);
        
        // 4. Rung nh·∫π ƒëi·ªán tho·∫°i (n·∫øu h·ªó tr·ª£) cho c·∫£m gi√°c th·∫≠t
        if(navigator.vibrate) navigator.vibrate(20); 

        // 5. Hi·ªán th√¥ng b√°o vui nh·ªôn (s·ª≠ d·ª•ng h√†m showToast c√≥ s·∫µn c·ªßa b·∫°n)
        if(typeof showToast === 'function') {
            if(isDark) {
                // Khi t·∫Øt ƒë√®n
                showToast("ƒê√£ t·∫Øt ƒë√®n! Ch√∫c ng·ªß ngon üåô", "üí°", "Ch·∫ø ƒë·ªô t·ªëi");
            } else {
                // Khi b·∫≠t ƒë√®n
                showToast("ƒê√£ b·∫≠t ƒë√®n! S√°ng qu√° ‚òÄÔ∏è", "üí°", "Ch·∫ø ƒë·ªô s√°ng");
            }
        }
    });
}

function closeInteractionPopup() {
    if (activePopupInterval) { clearInterval(activePopupInterval); activePopupInterval = null; }
    if (window.feedInterval) { clearInterval(window.feedInterval); window.feedInterval = null; }
    hidePopup('interaction-popup');
    const iText = document.getElementById('interaction-text');
    const iControls = document.getElementById('interaction-controls');
    if(iText) { iText.style.display = 'block'; iText.innerHTML = ''; }
    if(iControls) { iControls.innerHTML = ''; }
}

// --- H√ÄM X·ª¨ L√ù ·∫§P TR·ª®NG M·ªöI (C√ì H·∫∏N GI·ªú 24H) ---
function handleIceDragonInteraction(action, selectedType = 'thien_than') {
    // D√πng c·∫•u h√¨nh th·ªùi gian ·∫•p chu·∫©n
    const HATCH_DURATION = GAME_CONFIG.TIME_HATCH; 

    let petName = "Bi Gai";
    if (selectedType === 'than_chet') petName = "Th·∫ßn Ch·∫øt";
    else if (selectedType === 'thien_than') petName = "Thi√™n Th·∫ßn";

    if (action === 'hatch') {
        if (confirm(`Qu√° tr√¨nh ·∫•p ${petName} s·∫Ω m·∫•t th·ªùi gian.\nB·∫°n ch·∫Øc ch·∫Øn ch·ª©?`)) {
            // 1. L∆∞u lo·∫°i pet ƒëang ·∫•p
            hatchedPetType = selectedType;

            // 2. T√≠nh th·ªùi gian xong
            incubationFinishTime = Date.now() + HATCH_DURATION;
            
            isUpgrading = false; // ƒê√°nh d·∫•u ƒë√¢y l√† ·∫§p M·ªõi
            
            // 3. ƒê√≥ng popup & L∆∞u
            interactionControls.innerHTML = '';
            closeInteractionPopup();
            
            if(typeof showToast === 'function') {
                showToast(`ƒêang ·∫•p ${petName}...`, "ü•ö");
            } else {
                alert(`ƒê√£ b·∫Øt ƒë·∫ßu ·∫•p tr·ª©ng! Quay l·∫°i sau khi h·∫øt gi·ªù nh√©.`);
            }

            updateDisplay();
            saveGame(); 
        }
    }
}

let currentSeedTab = 'seeds';
function showSeedSelectionPopup(slotNum, slotIndex) {
    interactionTitle.innerHTML = `üì¶ Kho ƒê·ªì`; 
    interactionText.style.display = 'none'; 
    interactionControls.innerHTML = '';

    const tabs = document.createElement('div');
    tabs.className = 'tab-container';
    tabs.innerHTML = `
        <button class="tab-btn ${currentSeedTab==='seeds'?'active':''}" onclick="switchTab('seeds', ${slotNum}, ${slotIndex})">üå± H·∫°t Gi·ªëng</button>
        <button class="tab-btn ${currentSeedTab==='pots'?'active':''}" onclick="switchTab('pots', ${slotNum}, ${slotIndex})">üè∫ Ch·∫≠u</button>
    `;
    interactionControls.appendChild(tabs);

    const contentContainer = document.createElement('div');
    contentContainer.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 250px; overflow-y: auto; padding: 5px;';
    interactionControls.appendChild(contentContainer);

    if (currentSeedTab === 'seeds') {
        renderSeedList(contentContainer, slotNum, slotIndex);
    } else {
        renderPotList(contentContainer, slotNum, slotIndex);
    }

    showPopup('interaction-popup');
}

function switchTab(tabName, slotNum, slotIndex) {
    currentSeedTab = tabName;
    showSeedSelectionPopup(slotNum, slotIndex);
}

// --- 3. C·∫¨P NH·∫¨T RENDER POT LIST (ƒê√É T·ªêI ∆ØU: CH·∫∂N THAY CH·∫¨U KHI C√ì C√ÇY) ---
function renderPotList(container, slotNum, slotIndex) {
    let hasItem = false;
    const currentSlotPot = equippedPots[slotIndex] || 'so_dua';
    
    // [M·ªöI] Ki·ªÉm tra xem √¥ ƒë·∫•t n√†y ƒëang c√≥ c√¢y kh√¥ng
    const hasPlant = farmSlots[slotIndex] !== null;

    Object.keys(ownedPots).forEach(potKey => {
        const amount = ownedPots[potKey] || 0;
        const potDef = POT_DEFINITIONS[potKey];
        const isEquipped = (currentSlotPot === potKey);

        if ((amount > 0 || isEquipped) && potDef) {
            hasItem = true;
            const card = document.createElement('div');
            card.className = "shop-item";

            let bonusText = "";
            if (potDef.expBonus > 0) bonusText = `<div style="color:#4CAF50; font-size:0.8em; font-weight:bold;">+${potDef.expBonus} Exp/l·∫ßn</div>`;

            // HTML hi·ªÉn th·ªã ·∫£nh v√† th√¥ng tin
            let htmlContent = `
                <div class="item-frame" style="margin: 0 auto 5px auto;">
                    <img src="${potDef.img}" />
                </div>
                <div style="font-weight: bold; font-size: 0.9em; margin-top:5px;">${potDef.name}</div>
                ${bonusText}
                <div style="color: var(--text-muted); font-size: 0.8em; margin:3px 0 5px 0;">C√≥: ${amount}</div>
            `;

            // [M·ªöI] X·ª≠ l√Ω tr·∫°ng th√°i n√∫t b·∫•m
            // N·∫øu ƒëang trang b·ªã HO·∫∂C ƒëang c√≥ c√¢y tr·ªìng -> Kh√≥a n√∫t
            const isDisabled = isEquipped || hasPlant;
            
            let btnText = "Thay Ch·∫≠u";
            let btnBg = "#2196F3"; // Xanh d∆∞∆°ng
            let btnCursor = "pointer";

            if (isEquipped) {
                btnText = "ƒêang d√πng";
                btnBg = "#9E9E9E"; // X√°m
                btnCursor = "default";
            } else if (hasPlant) {
                btnText = "‚õî C√≥ C√¢y"; // B√°o hi·ªáu r√µ r√†ng
                btnBg = "#9E9E9E"; // X√°m
                btnCursor = "not-allowed";
            }

            const btnEquipHTML = `
                <button class="btn-equip-pot" 
                    style="background:${btnBg}; border-radius:6px; cursor:${btnCursor}; width: 100%; color: white; border: none; padding: 6px;"
                    ${isDisabled ? 'disabled' : ''}>
                    ${btnText}
                </button>`;

            // Gh√©p n√∫t v√†o th·∫ª
            if (potKey === 'so_dua') {
                htmlContent += `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%; margin-top:5px;">${btnEquipHTML}<button class="btn-sell-pot" style="width:100%; border:none; border-radius:6px; padding:6px; font-weight:700; font-size:11px; color:white; cursor:pointer; background:#FF5722; box-shadow: 0 2px 0 #E64A19;">üí∞ B√°n</button></div>`;
            } else {
                htmlContent += `<div style="width:100%; margin-top:5px;">${btnEquipHTML}</div>`;
            }

            card.innerHTML = htmlContent;

            // Logic click n√∫t Thay Ch·∫≠u
            const btnEquip = card.querySelector('.btn-equip-pot');
            if (btnEquip) {
                btnEquip.onclick = () => {
                    // Ki·ªÉm tra an to√†n l·∫ßn 2 (D√π n√∫t ƒë√£ disabled nh∆∞ng v·∫´n gi·ªØ logic n√†y cho ch·∫Øc ch·∫Øn)
                    if (isEquipped) return;
                    if (hasPlant) { alert("H√£y thu ho·∫°ch c√¢y tr∆∞·ªõc khi thay ch·∫≠u!"); return; }
                    
                    if (ownedPots[potKey] > 0) {
                        // Tr·∫£ ch·∫≠u c≈© v·ªÅ kho
                        if(currentSlotPot !== 'so_dua') { // S·ªç d·ª´a m·∫∑c ƒë·ªãnh kh√¥ng t√≠nh v√†o kho theo c√°ch c·ªông d·ªìn th√¥ng th∆∞·ªùng n·∫øu mu·ªën logic ch·∫∑t ch·∫Ω, nh∆∞ng ·ªü ƒë√¢y c·ª© c·ªông cho ƒë∆°n gi·∫£n ho·∫∑c t√πy logic game c·ªßa b·∫°n.
                             // Tuy nhi√™n logic c≈© c·ªßa b·∫°n: ownedPots[currentSlotPot] = (ownedPots[currentSlotPot] || 0) + 1;
                             ownedPots[currentSlotPot] = (ownedPots[currentSlotPot] || 0) + 1;
                        } else {
                             // N·∫øu th√°o s·ªç d·ª´a ra th√¨ c≈©ng c·ªông l·∫°i v√†o kho
                             ownedPots['so_dua'] = (ownedPots['so_dua'] || 0) + 1;
                        }

                        // Tr·ª´ ch·∫≠u m·ªõi
                        ownedPots[potKey]--; 
                        
                        // ƒêeo ch·∫≠u m·ªõi
                        equippedPots[slotIndex] = potKey;
                        
                        saveGame(); 
                        updateDisplay(); 
                        closeInteractionPopup();
                        
                        // Reload l·∫°i popup ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c (Optional)
                        // showSeedSelectionPopup(slotNum, slotIndex); 
                        // Nh∆∞ng th∆∞·ªùng thay xong th√¨ ƒë√≥ng popup lu√¥n l√† h·ª£p l√Ω.
                        
                        if(typeof showToast === 'function') showToast(`ƒê√£ thay sang ${potDef.name}`, "üè∫", "Th√†nh c√¥ng");
                        else alert(`ƒê√£ thay sang ${potDef.name}!`);
                    }
                };
            }

            // Logic b√°n s·ªç d·ª´a (Gi·ªØ nguy√™n)
            const btnSell = card.querySelector('.btn-sell-pot');
            if (btnSell && potKey === 'so_dua') {
                btnSell.onclick = () => {
                    if (amount <= 0) { alert("H·∫øt S·ªç D·ª´a trong kho!"); return; }
                    if (confirm(`B√°n 1 S·ªç D·ª´a l·∫•y 500 ƒê·∫≠u?`)) {
                        ownedPots['so_dua']--; dau += 500;
                        saveGame(); updateDisplay(); 
                        container.innerHTML = ""; renderPotList(container, slotNum, slotIndex);
                    }
                };
            }
            container.appendChild(card);
        }
    });

    // Th√¥ng b√°o n·∫øu kh√¥ng c√≥ item n√†o
    if (!hasItem) container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding:10px; color:var(--text-muted);">Kh√¥ng c√≥ ch·∫≠u n√†o kh√°c!</div>`;
    
    // Th√™m d√≤ng c·∫£nh b√°o ph√≠a tr√™n c√πng n·∫øu ƒëang c√≥ c√¢y (ƒê·ªÉ gi·∫£i th√≠ch t·∫°i sao n√∫t b·ªã x√°m)
    if (hasPlant) {
        const warning = document.createElement('div');
        warning.style.gridColumn = "span 2";
        warning.style.textAlign = "center";
        warning.style.padding = "5px";
        warning.style.color = "#ef5350";
        warning.style.fontWeight = "bold";
        warning.style.fontSize = "0.9em";
        warning.style.marginBottom = "5px";
        warning.innerHTML = "‚ö†Ô∏è C·∫ßn thu ho·∫°ch c√¢y tr∆∞·ªõc khi thay ch·∫≠u!";
        container.prepend(warning);
    }
}

// --- KHO H·∫†T GI·ªêNG (ƒê√É S·ª¨A: AUTO C√ì BAY, TR·ªíNG L·∫∫ KH√îNG BAY) ---
function renderSeedList(container, slotNum, slotIndex) {
    const seedMap = new Map();
    shopItems.filter(item => item.type === 'seed').forEach(item => seedMap.set(item.value, item));
    let seedFound = false;
    
    seedMap.forEach((seedData, seedValue) => {
        const amount = ownedSeeds[seedValue] || 0;
        
        if (amount > 0 && seedData) {
            seedFound = true;
            const card = document.createElement('div');
            card.className = "shop-item";
            
            // Giao di·ªán th·∫ª h·∫°t gi·ªëng
            card.innerHTML = `
                <div class="item-frame" style="margin: 0 auto 5px auto;">
                    <img src="${seedData.icon}" />
                </div>
                <div style="font-size: 0.85em; font-weight: 700; margin:5px 0;">${seedData.name}</div>
                <div style="font-size: 0.75em; color: var(--text-muted);">SL: <b>${amount}</b></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%; margin-top:5px;">
                    <button class="btn-plant-now" style="width:100%; margin-top:0;">üå± Tr·ªìng</button>
                    <button class="btn-sell-seed" style="width:100%; border:none; border-radius:8px; padding:6px; font-weight:700; font-size:11px; color:white; cursor:pointer; background:#FF5722; box-shadow: 0 2px 0 #E64A19;">üí∞ B√°n</button>
                </div>
                <button class="btn-auto-plant-all" style="width:100%; margin-top:5px; border:none; border-radius:8px; padding:8px; font-weight:700; font-size:11px; color:white; cursor:pointer; background: linear-gradient(45deg, #9C27B0, #BA68C8); box-shadow: 0 2px 0 #7B1FA2;">
                    ‚ú® Auto Tr·ªìng H·∫øt
                </button>
            `;
            
// --- 1. S·ª∞ KI·ªÜN AUTO TR·ªíNG H·∫æT (C√ì HI·ªÜU ·ª®NG BAY & KH√ìA UI) ---
card.querySelector('.btn-auto-plant-all').onclick = () => {
    // A. C√ÅC ƒêI·ªÄU KI·ªÜN KI·ªÇM TRA (VALIDATION)
    
    // 1. Ki·ªÉm tra Pet c√≥ ƒë·ªß ƒëi·ªÅu ki·ªán kh√¥ng (ƒê√£ n·ªü & Level >= 1)
    if (!isIceDragonEvolved || petStarLevel < 1) {
        alert("C·∫ßn c√≥ Pet H·ªô V·ªá (C·∫•p 1 tr·ªü l√™n) ƒë·ªÉ d√πng Auto!"); return;
    }
    
    // 2. Ki·ªÉm tra Pet c√≥ ƒëang b·∫≠n (·∫§p tr·ª©ng/N√¢ng c·∫•p) kh√¥ng
    if (incubationFinishTime > 0) {
        alert("Pet ƒëang b·∫≠n (·∫§p/N√¢ng c·∫•p), kh√¥ng th·ªÉ Auto!"); return;
    }
    
    // 3. Ki·ªÉm tra Game c√≥ ƒëang x·ª≠ l√Ω t√°c v·ª• kh√°c kh√¥ng (ƒë·ªÉ tr√°nh l·ªói click ƒë√∫p)
    if (isHarvesting) return; 

    // B. T√çNH TO√ÅN S·ªê L∆Ø·ª¢NG TR·ªíNG
    
    // T√¨m t·∫•t c·∫£ c√°c √¥ ƒë·∫•t TR·ªêNG
    const emptyIndices = [];
    FARM_IDS.forEach((id, idx) => {
        if (farmSlots[idx] === null) emptyIndices.push(idx);
    });

    if (emptyIndices.length === 0) {
        alert("Kh√¥ng c√≤n √¥ ƒë·∫•t n√†o tr·ªëng!"); return;
    }

    // T√≠nh to√°n s·ªë l∆∞·ª£ng tr·ªìng: Min(S·ªë √¥ tr·ªëng, S·ªë h·∫°t ƒëang c√≥)
    const seedsAvailable = ownedSeeds[seedValue] || 0;
    const countToPlant = Math.min(emptyIndices.length, seedsAvailable);

    if (countToPlant <= 0) {
        alert("B·∫°n ƒë√£ h·∫øt h·∫°t gi·ªëng n√†y!"); return;
    }

    // C. B·∫ÆT ƒê·∫¶U HI·ªÜU ·ª®NG V√Ä KH√ìA GIAO DI·ªÜN (UX FIX)
    
    // 1. Kh√≥a thao t√°c ngay l·∫≠p t·ª©c
    isHarvesting = true; 
    
    // 2. [QUAN TR·ªåNG] ƒê√≥ng Popup ngay ƒë·ªÉ ng∆∞·ªùi ch∆°i kh√¥ng b·∫•m lung tung v√†o n√∫t kh√°c
    closeInteractionPopup(); 

    // 3. K√≠ch ho·∫°t hi·ªáu ·ª©ng Pet bay (gi·ªëng l√∫c thu ho·∫°ch)
    const angelImg = document.getElementById('ice-egg-img');
    if (angelImg) {
        angelImg.style.transform = '';
        angelImg.classList.add('angel-harvesting');
    }

    // D. TH·ª∞C HI·ªÜN TR·ªíNG C√ÇY (SAU KHI BAY XONG)
    // Ch·ªù 2 gi√¢y (2000ms) kh·ªõp v·ªõi th·ªùi gian animation bay
    setTimeout(() => {
        for (let i = 0; i < countToPlant; i++) {
            const targetSlotIndex = emptyIndices[i];
            const currentPot = equippedPots[targetSlotIndex] || 'so_dua';
            
            // Tr·ª´ h·∫°t trong kho
            ownedSeeds[seedValue]--;
            
            // G√°n d·ªØ li·ªáu c√¢y v√†o √¥ ƒë·∫•t
            farmSlots[targetSlotIndex] = { 
                name: seedData.name, 
                icon: PLANT_STAGES[0].icon, 
                value: seedValue, 
                stage: 0, 
                plantedAt: Date.now(), 
                potType: currentPot 
            };
        }

        // L∆∞u game v√† c·∫≠p nh·∫≠t hi·ªÉn th·ªã
        saveGame();
        updateDisplay();
        updateSeedShop(); // C·∫≠p nh·∫≠t l·∫°i s·ªë l∆∞·ª£ng trong shop (n·∫øu m·ªü l·∫°i)

        // K·∫øt th√∫c hi·ªáu ·ª©ng: X√≥a class bay
        if (angelImg) {
            angelImg.classList.remove('angel-harvesting');
            angelImg.style.transform = 'none';
        }
        
        // M·ªü kh√≥a thao t√°c
        isHarvesting = false;

        // Th√¥ng b√°o k·∫øt qu·∫£ (Toast)
        if(typeof showToast === 'function') {
            showToast(`ƒê√£ tr·ªìng ${countToPlant} c√¢y ${seedData.name}!`, "‚ú®", "Auto Th√†nh C√¥ng");
        }
    }, 2000);
};

            // --- 2. S·ª∞ KI·ªÜN TR·ªíNG L·∫∫ 1 C√ÇY (ƒê√É S·ª¨A: KH√ìA N√öT ƒê·ªÇ CH·∫∂N CLICK LI√äN T·ª§C) ---
            card.querySelector('.btn-plant-now').onclick = (e) => {
                // Ki·ªÉm tra n·∫øu game ƒëang b·∫≠n (thu ho·∫°ch/auto) th√¨ ch·∫∑n lu√¥n
                if (isHarvesting) return; 

                // --- [CODE M·ªöI] KH√ìA N√öT NGAY L·∫¨P T·ª®C ---
                // V√¥ hi·ªáu h√≥a n√∫t b·∫•m ƒë·ªÉ ng∆∞·ªùi ch∆°i kh√¥ng th·ªÉ b·∫•m l·∫ßn 2
                if (e && e.target) {
                    e.target.disabled = true;
                    e.target.innerHTML = "‚è≥..."; 
                    e.target.style.cursor = "not-allowed";
                    e.target.style.opacity = "0.7";
                }
                // ----------------------------------------

                // Th·ª±c hi·ªán tr·ªìng ngay l·∫≠p t·ª©c (b·ªè qua ki·ªÉm tra Pet v√† Animation)
                ownedSeeds[seedValue] -= 1;
                const currentPot = equippedPots[slotIndex] || 'so_dua';
                
                farmSlots[slotIndex] = { 
                    name: seedData.name, 
                    icon: PLANT_STAGES[0].icon, 
                    value: seedValue, 
                    stage: 0, 
                    plantedAt: Date.now(), 
                    potType: currentPot 
                };
                
                saveGame(); 
                updateDisplay(); 
                updateSeedShop(); 
                closeInteractionPopup();
                
                // Hi·ªÉn th·ªã th√¥ng b√°o nh·∫π
                if(typeof showToast === 'function') showToast(`ƒê√£ tr·ªìng ${seedData.name}`, "üå±", "Th√†nh C√¥ng");
            };

            // --- 3. S·ª∞ KI·ªÜN B√ÅN H·∫†T (GI·ªÆ NGUY√äN) ---
            card.querySelector('.btn-sell-seed').onclick = () => {
                let sellQtyStr = prompt(`B√°n l·∫°i ${seedData.name} (${seedData.price} ƒê·∫≠u/h·∫°t)?`, "1");
                if (sellQtyStr === null) return;
                let sellQty = Number(sellQtyStr);
                if (!Number.isInteger(sellQty) || sellQty <= 0) return;
                if (sellQty > amount) return;
                
                const totalValue = sellQty * seedData.price;
                if(confirm(`B√°n ${sellQty} h·∫°t nh·∫≠n ${totalValue} ƒê·∫≠u?`)) {
                    ownedSeeds[seedValue] -= sellQty; dau += totalValue;
                    saveGame(); updateDisplay(); updateSeedShop(); 
                    container.innerHTML = ""; renderSeedList(container, slotNum, slotIndex);
                }
            };
            container.appendChild(card);
        }
    });
    if (!seedFound) container.innerHTML = `<div style="grid-column: span 2; text-align: center; margin: 15px 0; color: #666;">H·∫øt h·∫°t gi·ªëng.</div>`;
}

// --- H√ÄM T·∫†O HI·ªÜU ·ª®NG BAY ---
function spawnFloatingReward(slotId, htmlContent, delay = 0, typeClass = "float-exp") {
    // 1. T√¨m v·ªã tr√≠ c·ªßa √¥ ƒë·∫•t (slot) trong giao di·ªán
    const slotEl = document.getElementById(`slot-${slotId}`);
    if (!slotEl) return;

    // 2. T·∫°o ph·∫ßn t·ª≠ bay
    setTimeout(() => {
        const floater = document.createElement("div");
        floater.className = `floating-reward ${typeClass}`;
        floater.innerHTML = htmlContent;

        // 3. L·∫•y v·ªã tr√≠ top/left hi·ªán t·∫°i c·ªßa slot ƒë·ªÉ ƒë·∫∑t floater

        // L∆∞u √Ω: Do d√πng calc() trong CSS, l·∫•y offsetLeft/Top t·ª´ DOM chu·∫©n h∆°n
        floater.style.top = (slotEl.offsetTop - 20) + "px"; 
        floater.style.left = (slotEl.offsetLeft + 10) + "px";

        // Th√™m ng·∫´u nhi√™n v·ªã tr√≠ X m·ªôt ch√∫t ƒë·ªÉ kh√¥ng b·ªã ch·ªìng ch√©o n·∫øu r·ªõt nhi·ªÅu m√≥n
        const randomX = Math.floor(Math.random() * 20) - 10; 
        floater.style.left = (slotEl.offsetLeft + 10 + randomX) + "px";

        // 4. G·∫Øn v√†o main (n∆°i ch·ª©a c√°c slot)
        document.querySelector("main").appendChild(floater);

        // 5. T·ª± x√≥a sau khi animation k·∫øt th√∫c (1.2s)
        setTimeout(() => { floater.remove(); }, 1200);

    }, delay);
}
function updateFarmState() {
    const now = Date.now();
    let changed = false; 

    // --- LOGIC COMBO M·ªöI: KI·ªÇM TRA ƒê·ª¶ 5 M√ìN ---
    // H√†m .every() s·∫Ω tr·∫£ v·ªÅ true n·∫øu t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ trong m·∫£ng vineDecorations ƒë·ªÅu kh√°c null (t·ª©c l√† ƒë√£ treo ƒë·ªì)
    const isFullSet = vineDecorations.every(item => item !== null);

    // N·∫øu ƒë·ªß 5 m√≥n b·∫•t k·ª≥: Gi·∫£m 2 gi·ªù (7200000 ms)
    // N·∫øu ch∆∞a ƒë·ªß: Gi·∫£m 1 gi·ªù (3600000 ms) nh∆∞ c≈©
    const reductionAmount = isFullSet ? 7200000 : 3600000;
    
    // N·∫øu mu·ªën hi·ªán th√¥ng b√°o Combo (tu·ª≥ ch·ªçn, m·ªü console ƒë·ªÉ xem)
    // if(isFullSet) console.log("Combo k√≠ch ho·∫°t: Gi·∫£m 2h!");
    // ------------------------------------------

    farmSlots.forEach((slotData, index) => {
        if (slotData && slotData.stage < PLANT_STAGES.length - 1) { 
            const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
            
            let requiredDuration = nextStageInfo.duration;
            
            // Danh s√°ch c√°c v·∫≠t ph·∫©m h·ªó tr·ª£ gi·∫£m th·ªùi gian
            const fastGrowthItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];

            // Ki·ªÉm tra xem v·ªã tr√≠ n√†y c√≥ treo v·∫≠t ph·∫©m n·∫±m trong danh s√°ch tr√™n kh√¥ng
            if (fastGrowthItems.includes(vineDecorations[index])) {
                // √ÅP D·ª§NG TH·ªúI GIAN GI·∫¢M ƒê√É T√çNH ·ªû TR√äN
                requiredDuration -= reductionAmount; 
                
                if (requiredDuration < 0) requiredDuration = 0; // Kh√¥ng ƒë·ªÉ th·ªùi gian √¢m
            }

            if (now >= slotData.plantedAt + requiredDuration) { 
                slotData.stage += 1; 
                changed = true; 
            }
        }
    });
    if (changed) {
        updateDisplay();
        // üî• L∆∞u l·∫°i tr·∫°ng th√°i c√¢y v·ª´a l·ªõn üî•
        saveGame(); 
    }
}

function getCountdownTimePlant(timeToNext) {
    if (timeToNext <= 0) return "0s";
    
    // Logic t√≠nh to√°n gi·ªëng h·ªát Th·ª£ R√®n (renderCraftingQueue)
    let seconds = Math.floor((timeToNext / 1000) % 60);
    let minutes = Math.floor((timeToNext / (1000 * 60)) % 60);
    let hours = Math.floor((timeToNext / (1000 * 60 * 60)));
    
    let timeString = "";
    if(hours > 0) timeString += `${hours}h `;
    if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
    timeString += `${seconds}s`;
    
    return timeString;
}

const potSlots = document.querySelectorAll(".pot-slot");
potSlots.forEach(slot => {
    slot.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        
        const slotNum = slot.getAttribute('data-slot');
        if (slotNum === "6") return; 

        interactionText.style.display = 'block';
        interactionControls.innerHTML = ''; 
        if (activePopupInterval) clearInterval(activePopupInterval);

        const slotNumInt = parseInt(slotNum);

        const renderSlotStatus = () => {
            interactionControls.innerHTML = '';
            
        if (slotNum === "1") {
            // --- TR∆Ø·ªúNG H·ª¢P 1: ƒêANG ·∫§P HO·∫∂C N√ÇNG C·∫§P ---
            if (incubationFinishTime > 0) {
                let isHatchingNew = hasIceEgg; 
                let actionText = isHatchingNew ? "ƒêang ·∫§p N·ªü" : "ƒêang N√¢ng C·∫•p";
                let currentLv = petLevels[hatchedPetType] || 1;
                let targetLevel = isHatchingNew ? 1 : (currentLv + 1);

                interactionTitle.innerHTML = `‚è≥ ${actionText}`;

                const updateTimer = () => {
                    const now = Date.now();
                    const timeLeft = incubationFinishTime - now;

                    if (timeLeft <= 0) {
                        interactionText.innerHTML = "ƒêang ho√†n t·∫•t qu√° tr√¨nh...";
                        return;
                    }

                    let seconds = Math.floor((timeLeft / 1000) % 60);
                    let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
                    let hours = Math.floor((timeLeft / (1000 * 60 * 60)));
                    let timeString = "";
                    if (hours > 0) timeString += `${hours}h `;
                    if (minutes > 0 || hours > 0) timeString += `${minutes}m `;
                    timeString += `${seconds}s`;

                    const starConfig = {
                        1: { color: '#9E9E9E', stars: '‚≠ê' },
                        2: { color: '#4CAF50', stars: '‚≠ê‚≠ê' },
                        3: { color: '#2196F3', stars: '‚≠ê‚≠ê‚≠ê' },
                        4: { color: '#9C27B0', stars: '‚≠ê‚≠ê‚≠ê‚≠ê' },
                        5: { color: '#FF6F00', stars: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê' }
                    };
                    const style = starConfig[targetLevel] || starConfig[1];

                    let petName = "üëº Thi√™n Th·∫ßn"; 
                    if (hatchedPetType === 'than_chet') petName = "üíÄ Th·∫ßn Ch·∫øt";
                    if (hatchedPetType === 'bi_gai') petName = "üü¢ Bi Gai"; 

                    interactionText.innerHTML = `
                        <div style="text-align:center;">
                            <div style="font-size:0.85em; font-weight:bold; color:#795548; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">${actionText}</div>
                            <img src="1000000102.png" style="width:80px; display:block; margin: 0 auto 10px auto; filter: drop-shadow(0 0 5px ${style.color});">
                            <div style="font-size:1.3em; font-weight:900; color:${style.color}; margin-bottom:4px; text-shadow: 1px 1px 0 #fff;">${petName}</div>
                            <div style="font-size: 1.1em; color: ${style.color}; font-weight: bold; margin-bottom: 15px; display: inline-block; padding: 5px 15px; border: 2px solid ${style.color}; border-radius: 20px; background: rgba(255,255,255,0.8);">M·ª•c ti√™u: ${style.stars}</div>
                            <div style="margin-top:10px; font-size:1.4em; color:#E65100; font-weight:900; background:#FFF3E0; padding:10px; border-radius:10px; border: 1px dashed #FF9800;">${timeString}</div>
                        </div>`;
                };

                updateTimer();
                if (activePopupInterval) clearInterval(activePopupInterval);
                activePopupInterval = setInterval(updateTimer, 1000);
            }
            
            // --- TR∆Ø·ªúNG H·ª¢P 2: ƒê√É C√ì PET (HI·ªÇN TH·ªä TH√îNG TIN & N√ÇNG C·∫§P) ---
            else if (isIceDragonHatched) {
                petStarLevel = petLevels[hatchedPetType] || 1;

                const starConfig = {
                    1: { color: '#757575', colorName: 'X√°m' },
                    2: { color: '#4CAF50', colorName: 'Xanh L√°' },
                    3: { color: '#2196F3', colorName: 'Xanh D∆∞∆°ng' },
                    4: { color: '#9C27B0', colorName: 'T√≠m' },
                    5: { color: '#FF6F00', colorName: 'Cam' }
                };
                const currentConfig = starConfig[petStarLevel] || starConfig[1];
                
                let baseName = "Thi√™n Th·∫ßn"; 
                if (hatchedPetType === 'than_chet') baseName = "Th·∫ßn Ch·∫øt";
                if (hatchedPetType === 'bi_gai') baseName = "Bi Gai"; 
                
                let starsStr = "";
                for(let i=0; i<petStarLevel; i++) starsStr += "‚≠ê";

                interactionTitle.innerHTML = `
                    <span style="color:${currentConfig.color}; font-weight:900; font-size:1.1em; text-shadow: 1px 1px 0 #fff; display:block; margin-bottom:5px;">
                        ${baseName}
                    </span>
                    <span style="font-size:0.8em; color:#555;">${starsStr}</span>
                `;
                
                // --- C·∫¨P NH·∫¨T M√î T·∫¢ HI·ªÜU ·ª®NG THEO LEVEL ---
                let effectDesc = "Auto Tr·ªìng c√¢y (C·∫•p 1)";
                if (petStarLevel >= 2) effectDesc = "Auto Tr·ªìng & Thu ho·∫°ch (C·∫•p 2+)";

                interactionText.innerHTML = `<div style="margin-bottom:15px; font-size:0.9em; color:#555; background:#f5f5f5; padding:8px; border-radius:8px;">
                    ‚ö° <b>Hi·ªáu ·ª©ng:</b> ${effectDesc}
                </div>`;

                // Logic N√¢ng C·∫•p (Gi·ªØ nguy√™n)
                if (petStarLevel < 5) {
                    const nextLevel = petStarLevel + 1;
                    const costManh = nextLevel * 100;
                    const costLa = nextLevel * 10;
                    const currentManh = ownedArtifacts['manh_nguyen_to'] || 0;
                    
                    const upgradeDiv = document.createElement('div');
                    upgradeDiv.style.cssText = "background: #FFF8E1; border: 2px dashed #FFCA28; border-radius: 12px; padding: 12px; margin-bottom: 15px;";
                    
                    upgradeDiv.innerHTML = `
                        <div style="font-weight:bold; color:#FF6F00; margin-bottom:8px; text-transform:uppercase;">üîº N√¢ng C·∫•p L√™n ${nextLevel} Sao</div>
                        <div style="font-size:0.9em; color:#4E342E; text-align:left; line-height:1.6;">
                            üî∏ M·∫£nh Nguy√™n T·ªë: <b>${currentManh}/${costManh}</b><br>
                            üî∏ L√°: <b>${la}/${costLa}</b>
                        </div>
                    `;
                    
                    const btnUpgrade = document.createElement('button');
                    btnUpgrade.className = "btn-buy";
                    btnUpgrade.style.marginTop = "10px";
                    btnUpgrade.style.width = "100%";
                    btnUpgrade.textContent = "N√¢ng C·∫•p (24h)";
                    btnUpgrade.onclick = () => {
                        if (currentManh >= costManh && la >= costLa) {
                            if (confirm(`N√¢ng c·∫•p Pet l√™n ${nextLevel} Sao s·∫Ω m·∫•t 24 GI·ªú?\nTrong l√∫c n√¢ng c·∫•p, Pet s·∫Ω kh√¥ng th·ªÉ h·ªó tr·ª£ b·∫°n.`)) {
                                ownedArtifacts['manh_nguyen_to'] -= costManh;
                                la -= costLa;
                                isUpgrading = true; 
                                incubationFinishTime = Date.now() + GAME_CONFIG.TIME_UPGRADE;
                                saveGame(); updateDisplay(); closeInteractionPopup();
                                alert(`ƒê√£ b·∫Øt ƒë·∫ßu n√¢ng c·∫•p!`);
                            }
                        } else {
                            alert(`B·∫°n kh√¥ng ƒë·ªß t√†i nguy√™n!\nC·∫ßn: ${costManh} M·∫£nh v√† ${costLa} L√°.`);
                        }
                    };
                    upgradeDiv.appendChild(btnUpgrade);
                    interactionControls.appendChild(upgradeDiv);
                } else {
                    interactionControls.innerHTML += `<div style="text-align:center; color:#FF6F00; font-weight:bold; margin-bottom:10px;">üëë ƒê√É MAX C·∫§P</div>`;
                }

                // Logic ·∫§p tr·ª©ng m·ªõi (Gi·ªØ nguy√™n)
                if (hasIceEgg) {
                    const hatchContainer = document.createElement('div');
                    hatchContainer.style.cssText = "margin-top:15px; background:#E0F2F1; padding:10px; border-radius:10px; border:2px dashed #009688;";
                    let optionsHTML = "";
                    if (!isPetOwned('1000000127.gif')) optionsHTML += `<label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="radio" name="new_hatch_choice" value="thien_than" checked> üëº Thi√™n Th·∫ßn</label>`;
                    if (!isPetOwned('1000000104.gif')) optionsHTML += `<label style="display:block; cursor:pointer;"><input type="radio" name="new_hatch_choice" value="than_chet"> üíÄ Th·∫ßn Ch·∫øt</label>`;

                    hatchContainer.innerHTML = `
                        <div style="font-weight:bold; color:#00796B; margin-bottom:8px;">ü•ö PH√ÅT HI·ªÜN TR·ª®NG M·ªöI!</div>
                        <div style="font-size:0.9em; margin-bottom:8px; color:#555;">·∫§p th√™m Pet H·ªô V·ªá:</div>
                        <div style="margin-bottom:10px; font-weight:bold;">${optionsHTML}</div>
                    `;

                    const btnHatchNew = document.createElement('button');
                    btnHatchNew.className = "btn-buy";
                    btnHatchNew.innerHTML = "·∫§p Ngay (24h)";
                    btnHatchNew.style.background = "#FF5722";
                    btnHatchNew.onclick = () => {
                        const choices = document.getElementsByName('new_hatch_choice');
                        let selected = null;
                        for(const c of choices) { if(c.checked) selected = c.value; }
                        if(selected && confirm("B·∫Øt ƒë·∫ßu ·∫•p tr·ª©ng m·ªõi?")) {
                            handleIceDragonInteraction('hatch', selected);
                        }
                    };
                    hatchContainer.appendChild(btnHatchNew);
                    interactionControls.appendChild(hatchContainer);
                }
            }
            // --- TR∆Ø·ªúNG H·ª¢P 3: MUA TR·ª®NG ---
            else if (hasIceEgg) {
                interactionTitle.innerHTML = `Tr·ª©ng Ng≈© S·∫Øc`;
                interactionText.innerHTML = "Qu·∫£ tr·ª©ng ƒëang rung l·∫Øc d·ªØ d·ªôi...";
                let previewName = "Bi Gai";
                let previewImg = "1000000149.gif";
                if (hatchedPetType === 'thien_than') { previewName = "Thi√™n Th·∫ßn"; previewImg = "1000000127.gif"; }
                else if (hatchedPetType === 'than_chet') { previewName = "Th·∫ßn Ch·∫øt"; previewImg = "1000000104.gif"; }
                
                interactionControls.appendChild(document.createElement('div')).innerHTML = `
                    <div style="margin:15px 0; background:#E8F5E9; padding:15px; border-radius:15px; border:2px dashed #4CAF50; text-align:center;">
                        <img src="${previewImg}" style="width:70px; height:auto; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.2)); margin-bottom:10px;">
                        <div style="font-weight:900; color:#2E7D32; font-size:1.2em;">${previewName}</div>
                    </div>`;
                
                const btnHatch = document.createElement('button');
                btnHatch.innerHTML = `üî® ƒê·∫≠p Tr·ª©ng (24h)`;
                btnHatch.className = "btn-buy";
                btnHatch.onclick = () => { handleIceDragonInteraction('hatch', hatchedPetType); };
                interactionControls.appendChild(btnHatch);
            }
            else { 
                interactionTitle.innerHTML = "üêæ Pet M√¢y";
                interactionText.innerHTML = "Ch∆∞a c√≥ pet n√†o b·∫£o v·ªá n√¥ng tr·∫°i!<br>H√£y v√†o <b>Shop M√¢y</b> mua <b>Tr·ª©ng Ng≈© S·∫Øc</b>.";
            }
        }
            // --- LOGIC C√ÅC √î ƒê·∫§T TR·ªíNG C√ÇY (SLOT 2-5, 7) ---
            else if (FARM_IDS.includes(slotNumInt)) {
                 interactionTitle.innerHTML = "üå± Tr·ªìng Tr·ªçt"; 
                 const slotIndex = FARM_IDS.indexOf(slotNumInt); 
                 const slotData = farmSlots[slotIndex];
                 
                 // 1. √î ƒê·∫§T TR·ªêNG -> M·ªü kho h·∫°t gi·ªëng (C√≥ n√∫t Auto Tr·ªìng)
                 if (slotData === null) {
                     if(activePopupInterval) clearInterval(activePopupInterval);
                     showSeedSelectionPopup(slotNum, slotIndex); 
                     return; 
                 } 
                 
                 // 2. C√ì C√ÇY -> Hi·ªÉn th·ªã tr·∫°ng th√°i
                 else {
                     updateFarmState(); 
                     const currentStage = PLANT_STAGES[slotData.stage];
                     const isReadyForHarvest = slotData.stage === PLANT_STAGES.length - 1;
                     
                     let statusMessage = `B·∫°n ƒëang tr·ªìng <b style="color:#4CAF50; font-size:1.1em;">${slotData.name}</b><br>`;
                     statusMessage += `<span style="color:#795548; font-size:0.9em;">Giai ƒëo·∫°n: ${currentStage.name}</span><br>`;

                     // TR∆Ø·ªúNG H·ª¢P A: ƒê√É CH√çN (THU HO·∫†CH)
                     if (isReadyForHarvest) {
                         interactionText.innerHTML = statusMessage + `<div style="margin-top:10px; color:#E65100; font-weight:bold;">‚ú® C√¢y ƒë√£ ch√≠n! Thu ho·∫°ch ngay.</div>`;
                         
                         const btnHarvest = document.createElement('button');
                         const currentPotType = slotData.potType || 'so_dua';
                         const potDef = POT_DEFINITIONS[currentPotType];
                         const potBonus = potDef ? (potDef.expBonus || 0) : 0;

                         // --- ƒêI·ªÄU KI·ªÜN AUTO THU HO·∫†CH: Level >= 2 ---
                         if (isIceDragonEvolved && incubationFinishTime === 0 && petStarLevel >= 2) {
                             
                             let harvesterName = "üëº Thi√™n Th·∫ßn";
                             if (hatchedPetType === 'than_chet') harvesterName = "üíÄ Th·∫ßn Ch·∫øt";
                             if (hatchedPetType === 'bi_gai') harvesterName = "üü¢ Bi Gai";

                             btnHarvest.innerHTML = `${harvesterName} Thu Ho·∫°ch (Auto)`;
                             btnHarvest.className = "btn-buy";
                             btnHarvest.style.background = 'linear-gradient(45deg, #2196F3, #00BCD4)';
                             btnHarvest.style.boxShadow = '0 4px 0 #0097A7';
                             
                             btnHarvest.onclick = () => {
                                if (isHarvesting) return; 
                                isHarvesting = true; 
                                closeInteractionPopup(); 
                                
                                const angelImg = document.getElementById('ice-egg-img');
                                if (angelImg) { 
                                    angelImg.style.transform = ''; 
                                    angelImg.classList.add('angel-harvesting'); 
                                }
                                
                                setTimeout(() => {
                                    let hasHarvested = false; 
                                    farmSlots.forEach((sData, sIdx) => {
                                        if (sData && sData.stage === PLANT_STAGES.length - 1) {
                                            const hSeedValue = sData.value; 
                                            const slotId = FARM_IDS[sIdx];
                                            const sPotType = sData.potType || 'so_dua'; 
                                            const sPotDef = POT_DEFINITIONS[sPotType];
                                            const sBonus = sPotDef ? (sPotDef.expBonus || 0) : 0; 
                                            
                                            const hExp = 10 + sBonus; 
                                            exp += hExp; 
                                            spawnFloatingReward(slotId, `+${hExp} XP`, 0, "float-exp");
                                            
                                            const hReturnAmount = 2; 
                                            if (ownedSeeds[hSeedValue] === undefined) ownedSeeds[hSeedValue] = 0;
                                            ownedSeeds[hSeedValue] += hReturnAmount;
                                            
                                            if (HARVEST_DROPS[hSeedValue]) {
                                                const dropInfo = HARVEST_DROPS[hSeedValue];
                                                if (!ownedArtifacts[dropInfo.id]) ownedArtifacts[dropInfo.id] = 0;
                                                ownedArtifacts[dropInfo.id]++;
                                                spawnFloatingReward(slotId, `<img src="${dropInfo.img}" style="width:25px; height:25px; object-fit:contain;"> +1`, 200, "float-item");
                                            }
                                            farmSlots[sIdx] = null; 
                                            hasHarvested = true;
                                        }
                                    });

                                    if (angelImg) {
                                        angelImg.classList.remove('angel-harvesting');
                                        angelImg.style.transform = 'none';
                                    }
                                    
                                    isHarvesting = false; 

                                    if (hasHarvested) {
                                        updateDisplay(); checkLevelUp(); updateSeedShop(); saveGame(); 
                                        if(typeof showToast === 'function') showToast("ƒê√£ thu ho·∫°ch xong!", "üåæ", harvesterName);
                                    } else { 
                                        showToast("Ch∆∞a c√≥ c√¢y n√†o ch√≠n c·∫£!", "‚ö†Ô∏è", "Pet B√°o C√°o");
                                    }
                                    
                                }, 2000); 
                             };
                         } 
                         // --- THU HO·∫†CH TH·ª¶ C√îNG (Level 1 ho·∫∑c kh√¥ng c√≥ Pet) ---
                         else {
                             if (isIceDragonEvolved && incubationFinishTime === 0 && petStarLevel < 2) {
                                interactionText.innerHTML += `<div style="font-size:0.85em; color:#E65100; margin-top:5px; font-weight:bold;">(Auto Thu ho·∫°ch m·ªü kh√≥a ·ªü C·∫•p 2)</div>`;
                             }
                             if (isIceDragonEvolved && incubationFinishTime > 0) {
                                interactionText.innerHTML += `<div style="font-size:0.85em; color:#d32f2f; margin-top:5px; font-weight:bold;">(Pet ƒëang b·∫≠n, h√£y t·ª± thu ho·∫°ch!)</div>`;
                             }

                             const harvestedSeedValue = slotData.value; const returnAmount = 2; 
                             let baseExp = 10; let finalExp = baseExp + potBonus;
                             btnHarvest.innerHTML = `üåæ Thu ho·∫°ch (Nh·∫≠n ${returnAmount} H·∫°t + ${finalExp} Exp)`;
                             btnHarvest.className = "btn-buy";
                             btnHarvest.style.background = '#FF9800';
                             
                             btnHarvest.onclick = () => {
                                 const slotId = FARM_IDS[slotIndex]; 
                                 exp += finalExp; 
                                 spawnFloatingReward(slotId, `+${finalExp} XP`, 0, "float-exp");
                                 if (ownedSeeds[harvestedSeedValue] !== undefined) ownedSeeds[harvestedSeedValue] += returnAmount;
                                 else ownedSeeds[harvestedSeedValue] = returnAmount;
                                 if (HARVEST_DROPS[harvestedSeedValue]) {
                                     const dropInfo = HARVEST_DROPS[harvestedSeedValue];
                                     if (!ownedArtifacts[dropInfo.id]) ownedArtifacts[dropInfo.id] = 0;
                                     ownedArtifacts[dropInfo.id]++;
                                     spawnFloatingReward(slotId, `<img src="${dropInfo.img}" style="width:25px; height:25px; object-fit:contain;"> +1`, 200, "float-item");
                                 }
                                 farmSlots[slotIndex] = null; 
                                 closeInteractionPopup(); 
                                 updateDisplay(); checkLevelUp(); updateSeedShop(); saveGame(); 
                             };
                         }
                         interactionControls.appendChild(btnHarvest);
                     }
                     // TR∆Ø·ªúNG H·ª¢P B: ƒêANG L·ªöN
                     else {
                         const updatePlantTimer = () => {
                             if (!farmSlots[slotIndex]) return;
                             const now = Date.now();
                             const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
                             let requiredDuration = nextStageInfo.duration;
                             
                             const isFullSet = vineDecorations.every(item => item !== null);
                             const reductionAmount = isFullSet ? 7200000 : 3600000;
                             
                             const fastGrowthItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
                             if (fastGrowthItems.includes(vineDecorations[slotIndex])) {
                                 requiredDuration -= reductionAmount;
                                 if (requiredDuration < 0) requiredDuration = 0;
                             }

                             const finishTime = slotData.plantedAt + requiredDuration;
                             const timeLeft = finishTime - now;

                             if (timeLeft <= 0) {
                                 if(activePopupInterval) clearInterval(activePopupInterval);
                                 updateFarmState(); 
                                 renderSlotStatus(); 
                                 return;
                             }
                             
                             interactionText.innerHTML = statusMessage + `
                                <div style="margin-top:10px; background:#f5f5f5; padding:8px; border-radius:5px;">
                                    ‚è≥ L·ªõn sau: <b style="color:#2196F3;">${getCountdownTimePlant(timeLeft)}</b>
                                </div>`;
                         };
                         updatePlantTimer(); 
                         if(activePopupInterval) clearInterval(activePopupInterval);
                         activePopupInterval = setInterval(updatePlantTimer, 1000);
                     }
                 }
            } else { 
                interactionTitle.innerHTML = "Th√¥ng B√°o"; 
                interactionText.innerHTML = `√î ƒë·∫•t n√†y ch∆∞a m·ªü kh√≥a!`; 
            }
        };
        renderSlotStatus();
        showPopup('interaction-popup');
    });
});

const petHouse = document.getElementById("pet-house");
if (petHouse) {
    petHouse.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        updatePetShop(); showPopup('pet-house-box'); 
    });
}

const pugPet = document.getElementById("pug-pet");
if (pugPet) {
    pugPet.addEventListener("click", () => {
        if (level === 0) return;
        interactionControls.innerHTML = '';
        if (!activePet) return;
        
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet")); 
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet";
        
        interactionTitle.innerHTML = `üêæ ${petName}`; 
        interactionText.innerHTML = `
            ${petName} ƒëang r·∫•t vui v·∫ª.<br>
            üéÇ Tu·ªïi: <b>${globalPetAge} ng√†y</b>
        `;
        showPopup('interaction-popup');
    });
}

// --- ƒêO·∫†N 1: S·ª¨A S·ª∞ KI·ªÜN CLICK B√ÅT X∆Ø∆†NG ---
const boneBowl = document.getElementById("bone-bowl");
if (boneBowl) {
    boneBowl.addEventListener("click", () => {
        if (level === 0) return;
        
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet";
        
        interactionControls.innerHTML = ''; 
        interactionTitle.innerHTML = `ü¶¥ Cho ƒÉn`; 
        
        if (!activePet) { interactionText.innerHTML = `Ch∆∞a c√≥ Pet n√†o!`; } 
        else if(petData && (petData.name.includes("Th·∫ßn Ch·∫øt") || petData.name.includes("Thi√™n Th·∫ßn"))) {
            interactionText.innerHTML = `${petName} t·ª± ki·∫øm ƒÉn, kh√¥ng ƒÉn x∆∞∆°ng!`;
        } else {
            const now = new Date(); const last = new Date(lastFedTime);
            const isSameDay = now.getDate() === last.getDate() && now.getMonth() === last.getMonth() && now.getFullYear() === last.getFullYear();
            
            if (!isSameDay) {
                interactionText.innerHTML = `Pet ƒëang ƒë√≥i b·ª•ng...`;
                const btnFeed = document.createElement('button');
                btnFeed.innerHTML = "ü¶¥ Cho ƒÉn ngay (Mi·ªÖn ph√≠)"; 
                btnFeed.className = "btn-buy";
                
                // --- S·ª¨A ·ªû ƒê√ÇY: KH√îNG L∆ØU GAME NGAY L·∫¨P T·ª®C ---
                btnFeed.onclick = () => {
                    // Ch·ªâ ƒë√≥ng popup v√† hi·ªán qu·∫£ ƒë√†o. 
                    // Ch∆∞a l∆∞u lastFedTime v·ªôi ƒë·ªÉ ph√≤ng tr∆∞·ªùng h·ª£p l·ª° tay t·∫Øt m·∫•t.
                    hidePopup('interaction-popup');
                    spawnDailyReward();
                };
                // ----------------------------------------------
                
                interactionControls.appendChild(btnFeed);
            } else {
                interactionText.innerHTML = `${petName} ƒë√£ no r·ªìi! üê∂`;
            }
        }
        showPopup('interaction-popup');
    });
}

// --- ƒêO·∫†N 2: H√ÄM HI·ªÜN QU√Ä V√Ä L∆ØU D·ªÆ LI·ªÜU ---
function spawnDailyReward() {
    // X√≥a qu√† c≈© n·∫øu ch∆∞a nh·∫≠n
    const existingReward = document.getElementById('daily-reward-icon');
    if(existingReward) existingReward.remove();

    const petImg = document.getElementById('pug-pet');
    if(!petImg || petImg.style.display === 'none') return;

    // T·∫°o container qu√†
    const wrapper = document.createElement('div');
    wrapper.id = 'daily-reward-icon';
    wrapper.className = 'daily-reward-bubble';

    // === [PH·∫¶N CH·ªàNH S·ª¨A V·ªä TR√ç] ===
    
    // 1. L·∫•y v·ªã tr√≠ Pet l√†m g·ªëc
    wrapper.style.left = petImg.style.left;
    wrapper.style.transform = petImg.style.transform; 
    
    // 2. CH·ªàNH TR√ÅI / PH·∫¢I
    wrapper.style.marginLeft = "20px"; 

// 3. CH·ªàNH L√äN / XU·ªêNG (S·ª≠a l·ªói l·∫•y v·ªã tr√≠ th·ª±c t·∫ø)
const computedStyle = window.getComputedStyle(petImg);
let currentBottom = parseInt(computedStyle.bottom); 
if (isNaN(currentBottom)) currentBottom = 35; // Gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng t√¨m th·∫•y
wrapper.style.bottom = (currentBottom + 110) + 'px'; 

    // ================================

    // 1. Ch·ªâ t·∫°o ·∫¢nh Qu·∫£ ƒê√†o (1000000109.png)
    const img = document.createElement('img');
    img.src = '1000000109.png';
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'contain';

    wrapper.appendChild(img);

    // --- S·ª∞ KI·ªÜN NH·∫¨N QU√Ä (ƒê√É N√ÇNG C·∫§P) ---
    wrapper.onclick = () => {
        // 1. C·∫≠p nh·∫≠t d·ªØ li·ªáu game
        dau += 100;             
        la += 5;                
        
        lastFedTime = Date.now(); 
        globalPetAge += 1;      
        
        // --- T√¨m t√™n Pet hi·ªán t·∫°i ---
        let petName = "Pet";
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const currentPetData = allPets.find(p => p.value === activePet);
        if (currentPetData) {
            petName = currentPetData.name; 
        }

        // N·∫øu h√†m showToast t·ªìn t·∫°i th√¨ d√πng, kh√¥ng th√¨ m·ªõi d√πng alert
        if(typeof showToast === 'function') {
            showToast(`+100 ƒê·∫≠u & +5 L√°`, "üéÅ", `Qu√† t·ª´ ${petName}`);
        } else {
            alert(`B·∫°n nh·∫≠n ƒë∆∞·ª£c 100 ƒê·∫≠u & 5 L√° t·ª´ ${petName}! ü´òüçÇ`);
        }
        
        // Hi·ªáu ·ª©ng bay l√™n
        wrapper.style.animation = 'flyUpReward 0.5s ease-out forwards';
        
        // L∆∞u game ngay l·∫≠p t·ª©c
        updateDisplay();
        saveGame();

        setTimeout(() => {
            wrapper.remove();
        }, 500);
    };

    document.querySelector('main').appendChild(wrapper);
}

const chaosBlacksmith = document.getElementById("chaos-blacksmith");
if (chaosBlacksmith) {
    chaosBlacksmith.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showBlacksmithPopup();
    });
}
// --- S·ª∞ KI·ªÜN CLICK CHO ·∫¢NH ƒê·ªòNG (M·ªöI) ---
const chaosBlacksmithWorking = document.getElementById("chaos-blacksmith-working");
if (chaosBlacksmithWorking) {
    chaosBlacksmithWorking.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        showBlacksmithPopup();
    });
}

// --- Th·ª£ R√®n Chaos ---
function showBlacksmithPopup() {
    interactionTitle.innerHTML = "üî® Th·ª£ R√®n Chaos";
    interactionText.style.display = 'none';
    interactionControls.innerHTML = "";
    
    const resourceHeader = document.createElement("div");
    resourceHeader.style.cssText = "display:flex; justify-content:space-around; background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:10px; font-size:0.9em; border:1px solid #ffe0b2;";
    resourceHeader.innerHTML = `
        <div>ü´ò ƒê·∫≠u: <b style="color:#795548">${dau.toLocaleString()}</b></div>
        <div>üß© M·∫£nh Kim Lo·∫°i: <b style="color:#546E7A">${(ownedArtifacts['manh_kim_loai']||0).toLocaleString()}</b></div>
    `;
    interactionControls.appendChild(resourceHeader);
    
    const container = document.createElement("div");
    container.style.cssText = 'max-height: 400px; overflow-y: auto; padding: 2px;';
    
    const queueContainer = document.createElement("div");
    queueContainer.id = "crafting-queue-list";
    container.appendChild(queueContainer);
    
    const table = document.createElement('table');
    table.className = 'blacksmith-table';
    table.innerHTML = `<tbody id="blacksmith-recipes-body"></tbody>`;
    container.appendChild(table);
    
    const tbody = table.querySelector('#blacksmith-recipes-body');
    const isSmithBusy = craftingQueue.length > 0;

    CRAFTING_RECIPES.forEach(recipe => {
        const hasDau = dau >= (recipe.cost.dau || 0);
        let materialsHtml = '';
        let canCraftMaterials = true;

        Object.keys(recipe.materials).forEach(matKey => {
            const reqQty = recipe.materials[matKey];
            let hasItem = false;
            let currentAmt = 0;
            let matName = matKey;
            if (matKey === 'manh_kim_loai') { currentAmt = ownedArtifacts['manh_kim_loai'] || 0; matName = "M·∫£nh Kim Lo·∫°i"; } 
            else if (POT_DEFINITIONS[matKey]) { currentAmt = ownedPots[matKey] || 0; matName = POT_DEFINITIONS[matKey].name; }

            hasItem = currentAmt >= reqQty;
            if (!hasItem) canCraftMaterials = false;
            materialsHtml += `<div class="${hasItem?'req-status-ok':'req-status-fail'}">${hasItem?'‚úì':'‚úó'} ${matName}: ${reqQty}</div>`;
        });
        
        materialsHtml += `<div class="${hasDau?'req-status-ok':'req-status-fail'}">${hasDau?'‚úì':'‚úó'} ƒê·∫≠u: ${recipe.cost.dau}</div>`;

        let isBlockedByBusy = (recipe.duration > 0 && isSmithBusy);
        const canCraft = hasDau && canCraftMaterials && !isBlockedByBusy;
        const btnText = recipe.duration === 0 ? "Mua" : (isBlockedByBusy ? "ƒêang B·∫≠n" : "R√®n");
        
        const newRow = tbody.insertRow();
        
        newRow.innerHTML = `
            <td>
                <div class="blacksmith-recipe" style="display:flex; align-items:center; gap:8px;">
                    <div class="item-frame" style="width:40px; height:40px; margin:0;">
                        <img src="${recipe.icon}" />
                    </div>
                    <div style="font-weight:bold;">${recipe.name}</div>
                </div>
            </td>
            <td>${materialsHtml}</td>
            <td>
                <button id="btn-craft-${recipe.id}" class="btn-crafting" style="width:auto; padding:8px 15px; background:${canCraft?'var(--accent)':'#999'};" ${canCraft?'':'disabled'}>
                    ${btnText}
                </button>
            </td>
        `;
        setTimeout(() => {
            const btn = document.getElementById(`btn-craft-${recipe.id}`);
            if(btn) btn.onclick = () => startCrafting(recipe);
        }, 0);
    });

    interactionControls.appendChild(container); 
    renderCraftingQueue();
    showPopup('interaction-popup');

    // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c h√¨nh ·∫£nh th·ª£ r√®n (Tƒ©nh/ƒê·ªông) d·ª±a v√†o h√†ng ch·ªù
    updateBlacksmithVisuals();

    if (activePopupInterval) clearInterval(activePopupInterval);
    activePopupInterval = setInterval(renderCraftingQueue, 1000);
}

function startCrafting(recipe) {
    // 1. Ki·ªÉm tra xem th·ª£ r√®n c√≥ ƒëang b·∫≠n kh√¥ng (ch·ªâ √°p d·ª•ng cho m√≥n c·∫ßn th·ªùi gian)
    if (craftingQueue.length > 0 && recipe.duration > 0) {
        alert("Th·ª£ r√®n ƒëang b·∫≠n! Vui l√≤ng ƒë·ª£i r√®n xong m√≥n hi·ªán t·∫°i.");
        return;
    }

    // 2. Ki·ªÉm tra ƒë·ªß ti·ªÅn (ƒê·∫≠u) kh√¥ng
    if (dau < (recipe.cost.dau || 0)) return;
    
    // 3. Ki·ªÉm tra ƒë·ªß nguy√™n li·ªáu kh√¥ng
    for (const [matKey, matQty] of Object.entries(recipe.materials)) {
        let currentAmt = 0;
        // Ki·ªÉm tra kho M·∫£nh Kim Lo·∫°i ho·∫∑c kho Ch·∫≠u c≈©
        if (matKey === 'manh_kim_loai') currentAmt = ownedArtifacts['manh_kim_loai'] || 0;
        else if (ownedPots[matKey] !== undefined) currentAmt = ownedPots[matKey] || 0;
        
        if (currentAmt < matQty) {
            alert("Kh√¥ng ƒë·ªß nguy√™n li·ªáu!");
            return;
        }
    }

    const actionName = recipe.duration === 0 ? "Mua" : "R√®n";

    // 4. X√°c nh·∫≠n h√†nh ƒë·ªông
    if(confirm(`B·∫°n mu·ªën ${actionName} ${recipe.name}?`)) {
        // Tr·ª´ ti·ªÅn
        dau -= (recipe.cost.dau || 0);
        
        // Tr·ª´ nguy√™n li·ªáu
        for (const [matKey, matQty] of Object.entries(recipe.materials)) {
            if (matKey === 'manh_kim_loai') {
                 ownedArtifacts['manh_kim_loai'] -= matQty;
            } else if (ownedPots[matKey] !== undefined) {
                 ownedPots[matKey] -= matQty;
            }
        }

        // TR∆Ø·ªúNG H·ª¢P A: MUA NGAY (Duration = 0, v√≠ d·ª• S·ªç D·ª´a)
        if (recipe.duration === 0) {
             if (!ownedPots[recipe.output]) ownedPots[recipe.output] = 0;
             ownedPots[recipe.output]++;
             
             // üî• L∆ØU GAME NGAY SAU KHI MUA üî•
             saveGame();
             
             alert(`ƒê√£ mua th√†nh c√¥ng ${recipe.name}!`);
             updateDisplay();
             showBlacksmithPopup(); 
        } 
        // TR∆Ø·ªúNG H·ª¢P B: R√àN (C√≥ th·ªùi gian ch·ªù)
        else {
            craftingQueue.push({ 
                output: recipe.output, 
                name: recipe.name, 
                startTime: Date.now(), 
                finishTime: Date.now() + recipe.duration 
            });
            
            // üî• L∆ØU GAME NGAY SAU KHI B·∫ÆT ƒê·∫¶U R√àN üî•
            saveGame();

            alert("ƒê√£ b·∫Øt ƒë·∫ßu r√®n!");
            updateDisplay();
            showBlacksmithPopup();
            updateBlacksmithVisuals(); 
        }
    }
}

function renderCraftingQueue() {
    const container = document.getElementById("crafting-queue-list");
    if (!container) return;
    
    container.innerHTML = "";
    if (craftingQueue.length === 0) return;
    
    const queueList = document.createElement('div');
    queueList.style.cssText = 'border: 2px dashed #FF9800; padding: 10px; border-radius: 8px; margin-bottom: 15px; background: rgba(255, 236, 179, 0.5);';
    container.appendChild(queueList);

    const now = Date.now();
    let updated = false;

    for (let i = craftingQueue.length - 1; i >= 0; i--) {
        const item = craftingQueue[i];
        const timeLeft = item.finishTime - now;
        
        if (timeLeft <= 0) {
            craftingQueue.splice(i, 1);
            if (!ownedPots[item.output]) ownedPots[item.output] = 0;
            ownedPots[item.output]++;
            alert(`‚úÖ R√®n th√†nh c√¥ng: ${item.name}!`);
            updated = true;
        } else {
            const div = document.createElement("div");
            
            // --- C·∫¨P NH·∫¨T HI·ªÇN TH·ªä TH·ªúI GIAN ƒê·∫∏P H∆†N ---
            let seconds = Math.floor((timeLeft / 1000) % 60);
            let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
            let hours = Math.floor((timeLeft / (1000 * 60 * 60)));
            
            let timeString = "";
            if(hours > 0) timeString += `${hours}h `;
            if(minutes > 0 || hours > 0) timeString += `${minutes}m `;
            timeString += `${seconds}s`;

            div.style.fontWeight = "bold";
            div.innerHTML = `üî• ${item.name}: <span style="color:#E65100">${timeString}</span>`;
            queueList.appendChild(div);
        }
    }
    
    if (updated) {
        updateDisplay();
        if (document.getElementById('interaction-popup').classList.contains('popup-active')) showBlacksmithPopup();
    }
}

function checkGlobalCrafting() {
    if(craftingQueue.length > 0) {
        const now = Date.now();
        let updated = false;
        for (let i = craftingQueue.length - 1; i >= 0; i--) {
            if (now >= craftingQueue[i].finishTime) {
                const item = craftingQueue[i];
                craftingQueue.splice(i, 1);
                if (!ownedPots[item.output]) ownedPots[item.output] = 0;
                ownedPots[item.output]++;
                alert(`‚úÖ R√®n th√†nh c√¥ng: ${item.name}!`);
                updated = true;
            }
        }
        if (updated) {
            updateDisplay();
            // üî• L∆ØU GAME KHI C√ì ƒê·ªí R√àN XONG üî•
            saveGame(); 
        }
        updateBlacksmithVisuals(); 
    }
}

const brandContainer = document.querySelector(".brand");
if (brandContainer) {
    brandContainer.addEventListener("click", () => {
        if (level === 0) return;
        const maxExp = expNeeded(level);
        const percent = ((exp / maxExp) * 100).toFixed(1);
        
        interactionTitle.innerHTML = `üìä C·∫•p ƒë·ªô ${level}`;
        interactionText.style.display = 'block';
        interactionText.innerHTML = `
            <div style="text-align:left; background:#f5f5f5; padding:15px; border-radius:10px;">
                üå± <b>Kinh nghi·ªám:</b> ${exp.toLocaleString()} / ${maxExp.toLocaleString()}<br>
                üìà <b>Ti·∫øn ƒë·ªô:</b> ${percent}%
            </div>
        `;
        interactionControls.innerHTML = '';
        showPopup('interaction-popup');
    });
}

// --- B·ªî SUNG H√ÄM G√ÅN S·ª∞ KI·ªÜN CHO V·∫¨T PH·∫®M TREO (CH√ÇU CH·∫§U...) ---
function initGrasshopperEvents() {
    // L·∫•y t·∫•t c·∫£ c√°c th·∫ª img d√πng ƒë·ªÉ hi·ªÉn th·ªã v·∫≠t ph·∫©m treo
    // ID c·ªßa ch√∫ng l√† grasshopper-0, grasshopper-1, ...
    for (let i = 0; i < 5; i++) {
        const itemEl = document.getElementById(`grasshopper-${i}`);
        if (itemEl) {
            // Clone ƒë·ªÉ x√≥a s·ª± ki·ªán c≈© (n·∫øu c√≥)
            const newItemEl = itemEl.cloneNode(true);
            itemEl.parentNode.replaceChild(newItemEl, itemEl);

            newItemEl.addEventListener('click', () => {
                if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
                // M·ªü popup d√¢y leo t·∫°i v·ªã tr√≠ t∆∞∆°ng ·ª©ng
                showVinePopup(i);
            });
        }
    }
}
// --- LOGIC KI·ªÇM TRA TR·ª®NG N·ªû ---
function checkIncubationState() {
    // Ch·ªâ ch·∫°y khi ƒëang c√≥ th·ªùi gian ƒë·∫øm ng∆∞·ª£c
    if (incubationFinishTime > 0) {
        const now = Date.now();
        
        // Ki·ªÉm tra xem ƒë√£ h·∫øt gi·ªù ch∆∞a
        if (now >= incubationFinishTime) {
            incubationFinishTime = 0; // X√≥a th·ªùi gian ch·ªù

            // --- TR∆Ø·ªúNG H·ª¢P A: ·∫§P QU·∫¢ TR·ª®NG ƒê·∫¶U TI√äN HO·∫∂C MUA M·ªöI ---
            if (hasIceEgg) {
                hasIceEgg = false; 
                isIceDragonHatched = true; 
                isIceDragonEvolved = true; 
                
                // ƒê·∫∑t level v·ªÅ 1
                petLevels[hatchedPetType] = 1;
                petStarLevel = 1; 

                // X√°c ƒë·ªãnh th√¥ng tin Pet ƒë·ªÉ th√™m v√†o kho
                let petName = "Bi Gai";
                let petValue = "1000000149.gif"; // M·∫∑c ƒë·ªãnh Bi Gai

                if (hatchedPetType === 'thien_than') {
                    petName = "Thi√™n Th·∫ßn";
                    petValue = "1000000127.gif";
                }
                else if (hatchedPetType === 'than_chet') {
                    petName = "Th·∫ßn Ch·∫øt";
                    petValue = "1000000104.gif";
                }

                // === [LOGIC M·ªöI] TH√äM V√ÄO KHO ===
                if (!ownedPets.includes(petValue)) {
                    ownedPets.push(petValue);
                }
                // =======================================

                if(typeof showToast === 'function') showToast(`N·ªü th√†nh c√¥ng: ${petName}`, "üê£", "Ch√∫c M·ª´ng");
                else alert(`üéâ CH√öC M·ª™NG! Tr·ª©ng ƒë√£ n·ªü th√†nh: ${petName}!`);
            } 
            
            // --- TR∆Ø·ªúNG H·ª¢P B: ƒê√É C√ì PET T·ª™ TR∆Ø·ªöC (N√ÇNG C·∫§P) ---
            else if (isIceDragonHatched) {
                
                // 1. N·∫æU L√Ä N√ÇNG C·∫§P
                if (isUpgrading) {
                    if (!petLevels[hatchedPetType]) petLevels[hatchedPetType] = 1;
                    if (petLevels[hatchedPetType] < 5) {
                        petLevels[hatchedPetType]++; 
                        petStarLevel = petLevels[hatchedPetType]; 
                        
                        if(typeof showToast === 'function') showToast(`L√™n c·∫•p th√†nh c√¥ng!`, "üåü");
                        else alert("L√™n c·∫•p th√†nh c√¥ng!");
                    }
                    isUpgrading = false; 
                }
                
                // 2. N·∫æU L√Ä ·∫§P PET M·ªöI T·ª™ H·ªòP "PH√ÅT HI·ªÜN TR·ª®NG M·ªöI"
                else {
                    petLevels[hatchedPetType] = 1;
                    petStarLevel = 1; 

                    let petName = "Bi Gai";
                    let petValue = "1000000149.gif";

                    // D√πng switch case ƒë·ªÉ ƒë·∫£m b·∫£o t√™n v√† ·∫£nh ch√≠nh x√°c tuy·ªát ƒë·ªëi
                    switch(hatchedPetType) {
                        case 'thien_than': 
                            petName = "Thi√™n Th·∫ßn"; 
                            petValue = "1000000127.gif"; 
                            break;
                        case 'than_chet': 
                            petName = "Th·∫ßn Ch·∫øt"; 
                            petValue = "1000000104.gif"; 
                            break;
                        case 'bi_gai':
                            petName = "Bi Gai";
                            petValue = "1000000149.gif";
                            break;
                    }

                    // === [LOGIC M·ªöI] TH√äM V√ÄO KHO (QUAN TR·ªåNG) ===
                    // ƒê·∫£m b·∫£o Pet v·ª´a n·ªü ƒë∆∞·ª£c th√™m v√†o danh s√°ch s·ªü h·ªØu
                    if (!ownedPets.includes(petValue)) {
                        ownedPets.push(petValue);
                    }
                    // =======================================

                    if(typeof showToast === 'function') showToast(`N·ªü th√†nh c√¥ng: ${petName}`, "üê£", "Ch√∫c M·ª´ng");
                    else alert(`üéâ CH√öC M·ª™NG! Tr·ª©ng ƒë√£ n·ªü th√†nh: ${petName}!`);
                }
            } 

            // C·∫≠p nh·∫≠t giao di·ªán v√† l∆∞u game ngay l·∫≠p t·ª©c
            updateDisplay();
            updatePetShop(); // C·∫≠p nh·∫≠t l·∫°i shop ƒë·ªÉ n√∫t "Mua" chuy·ªÉn th√†nh "ƒê√£ s·ªü h·ªØu"
            saveGame();
            
            // T·ª± ƒë·ªông m·ªü l·∫°i Slot 1 ƒë·ªÉ th·∫•y k·∫øt qu·∫£
            if(document.getElementById('interaction-popup').classList.contains('popup-active')) {
                hidePopup('interaction-popup');
                setTimeout(() => {
                    const slot1 = document.getElementById('slot-1');
                    if(slot1) slot1.click();
                }, 500);
            }
        }
    }
}
// --- LOGIC T∆Ø∆†NG T√ÅC D√ÇY LEO & CH√ÇU CH·∫§U (M·ªöI) ---

// 1. G√°n s·ª± ki·ªán click cho c√°c d√¢y leo ngay khi ch·∫°y game
// L∆∞u √Ω: H√†m n√†y s·∫Ω t·ª± ch·∫°y nh·ªù logic b√™n d∆∞·ªõi, b·∫°n kh√¥ng c·∫ßn g·ªçi th·ªß c√¥ng
function initVineEvents() {
    const vines = document.querySelectorAll('.vine-deco');
    vines.forEach(vine => {
        // X√≥a s·ª± ki·ªán c≈© ƒë·ªÉ tr√°nh b·ªã double click (n·∫øu c√≥)
        const newVine = vine.cloneNode(true); 
        vine.parentNode.replaceChild(newVine, vine);
        
        newVine.addEventListener('click', (e) => {
            if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
            
            // L·∫•y v·ªã tr√≠ d√¢y leo (0-4) t·ª´ HTML
            const index = parseInt(e.target.getAttribute('data-index'));
            showVinePopup(index);
        });
    });
}

// G·ªçi h√†m g√°n s·ª± ki·ªán n√†y m·ªói khi kh·ªüi t·∫°o
// (B·∫°n h√£y t√¨m d√≤ng initializeGame v√† th√™m initVineEvents() v√†o trong ƒë√≥ n·∫øu mu·ªën ch·∫Øc ch·∫Øn,
// ho·∫∑c d√°n d√≤ng n√†y v√†o cu·ªëi file script: setTimeout(initVineEvents, 1000); )


// --- 2. H√†m hi·ªÉn th·ªã Popup khi click v√†o d√¢y leo (ƒê√É C·∫¨P NH·∫¨T ITEM-FRAME) ---
function showVinePopup(index) {
    // Reset ti√™u ƒë·ªÅ
    interactionTitle.innerHTML = `üåø D√¢y Leo (V·ªã tr√≠ ${index + 1})`;

    // 1. KI·ªÇM TRA & HI·ªÇN TH·ªä COMBO
    const isFullSet = vineDecorations.every(item => item !== null);
    let comboHTML = "";
    
    if (isFullSet) {
        comboHTML = `
        <div style="
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
            border: 2px solid #fbc02d;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        ">
            <div style="font-size:1.2em; margin-bottom:5px;">‚ö°‚ö°‚ö°</div>
            <strong style="color:#f57f17; font-size:1em;">ƒê√É K√çCH HO·∫†T COMBO!</strong>
            <div style="font-size:0.85em; color:#5d4037; margin-top:2px;">To√†n b·ªô c√¢y tr·ªìng ƒë∆∞·ª£c gi·∫£m <b>2 gi·ªù</b> tr∆∞·ªüng th√†nh.</div>
        </div>`;
    } else {
        const missingCount = vineDecorations.filter(x => x === null).length;
        comboHTML = `
        <div style="
            background: #f5f5f5;
            border: 1px dashed #bdbdbd;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        ">
            <strong style="color:#757575;">Ch∆∞a k√≠ch ho·∫°t Combo</strong>
            <div style="font-size:0.85em; color:#9e9e9e; margin-top:2px;">
                C·∫ßn treo th√™m <b>${missingCount}</b> m√≥n n·ªØa ƒë·ªÉ gi·∫£m <b>2 gi·ªù</b>.
            </div>
        </div>`;
    }

    interactionText.innerHTML = comboHTML;
    interactionControls.innerHTML = '';

    // 2. T·∫†O DANH S√ÅCH V·∫¨T PH·∫®M
    const listContainer = document.createElement('div');
    listContainer.style.cssText = `
        max-height: 280px; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        padding: 5px;
    `;

    const currentDecoID = vineDecorations[index];

    // Duy·ªát qua t·∫•t c·∫£ v·∫≠t ph·∫©m c·∫•u h√¨nh ƒë·ªÉ hi·ªÉn th·ªã
    HANGING_ITEMS_CONFIG.forEach(item => {
        const ownedAmount = ownedDecorations[item.id] || 0;
        const isEquippedHere = (currentDecoID === item.id);
        
        const itemRow = document.createElement('div');
        
        // S·ª¨A: D√πng Class CSS thay v√¨ style c·ª©ng
        // N·∫øu ƒëang trang b·ªã (isEquippedHere = true) th√¨ th√™m class 'equipped'
        itemRow.className = isEquippedHere ? "vine-item equipped" : "vine-item";

        // Logic Badge (Gi·ªØ nguy√™n)
        const speedUpItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
        let effectBadge = "";
        if (speedUpItems.includes(item.id)) {
            effectBadge = `<span style="background:#E3F2FD; color:#1565C0; font-size:0.7em; padding:2px 6px; border-radius:4px; font-weight:bold;">‚ö° -1 Gi·ªù</span>`;
        }

        // Logic N√∫t B·∫•m (Gi·ªØ nguy√™n)
        let btnHtml = '';
        if (isEquippedHere) {
            btnHtml = `<button disabled style="background:transparent; color:#2E7D32; border: 2px solid #2E7D32; border-radius:20px; padding:5px 10px; font-weight:bold; font-size: 0.8em; opacity: 0.7;">‚úî ƒêang d√πng</button>`;
        } else if (ownedAmount > 0) {
            btnHtml = `<button class="btn-equip-item" data-id="${item.id}" style="background:var(--primary); color:white; border:none; border-radius:20px; padding:6px 15px; cursor:pointer; font-weight:bold; font-size: 0.85em; box-shadow: 0 2px 0 var(--primary-dark);">Treo</button>`;
        } else {
            btnHtml = `<button onclick="document.getElementById('event-cloud').click()" style="background:#f5f5f5; color:#999; border:1px solid #ddd; border-radius:20px; padding:5px 10px; cursor:pointer; font-size: 0.8em;">üîç T√¨m</button>`;
        }

        // --- C·∫¨P NH·∫¨T GIAO DI·ªÜN (ITEM FRAME) ---
        itemRow.innerHTML = `
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="item-frame" style="width:50px; height:50px; margin:0;">
                    <img src="${item.img}" style="object-fit:contain;">
                </div>
                <div style="text-align:left;">
                    <div class="item-title-text">${item.name}</div>
                    
                    <div style="display:flex; align-items:center; gap:5px; margin-top:2px;">
                        ${effectBadge}
                        <span style="font-size:0.75em; color:#999;">Kho: <b>${ownedAmount}</b></span>
                    </div>
                </div>
            </div>
            <div>${btnHtml}</div>
        `;
        
        listContainer.appendChild(itemRow);
    });

    interactionControls.appendChild(listContainer);

    // 3. N√öT G·ª† B·ªé
    if (currentDecoID !== null) {
        const removeContainer = document.createElement('div');
        removeContainer.style.marginTop = "15px";
        removeContainer.style.borderTop = "1px dashed #ddd";
        removeContainer.style.paddingTop = "10px";

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = "‚ùå G·ª° v·∫≠t ph·∫©m n√†y xu·ªëng";
        removeBtn.className = "btn-remove-vines"; 
        
        removeBtn.onclick = () => {
            if(confirm("B·∫°n mu·ªën g·ª° v·∫≠t ph·∫©m n√†y v·ªÅ kho?")) {
                if (!ownedDecorations[currentDecoID]) ownedDecorations[currentDecoID] = 0;
                ownedDecorations[currentDecoID]++;
                vineDecorations[index] = null;
                saveGame(); updateDisplay(); closeInteractionPopup();
            }
        };
        removeContainer.appendChild(removeBtn);
        interactionControls.appendChild(removeContainer);
    }

    // 4. G√ÅN S·ª∞ KI·ªÜN CHO N√öT TREO
    const equipBtns = listContainer.querySelectorAll('.btn-equip-item');
    equipBtns.forEach(btn => {
        btn.onclick = (e) => {
            const itemId = e.target.getAttribute('data-id');
            if (currentDecoID) {
                if (!ownedDecorations[currentDecoID]) ownedDecorations[currentDecoID] = 0;
                ownedDecorations[currentDecoID]++;
            }
            if (ownedDecorations[itemId] > 0) {
                ownedDecorations[itemId]--;
                vineDecorations[index] = itemId;
                saveGame(); updateDisplay(); closeInteractionPopup();
            }
        };
    });

    showPopup('interaction-popup');
}
// --- S·ª∞ KI·ªÜN CLICK M√ÇY ƒêEN (SHOP ƒê·ªîI ƒê·ªí TREO) ---
const eventCloud = document.getElementById("event-cloud");
if (eventCloud) {
    eventCloud.addEventListener("click", () => {
        if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
        
        const myCrowns = ownedArtifacts['vuong_mien'] || 0;
        const MAX_EXCHANGE = 5; // Gi·ªõi h·∫°n t·ªëi ƒëa 5 c√°i m·ªói lo·∫°i

        // --- 1. HEADER S·ª∞ KI·ªÜN ƒê·∫∏P M·∫ÆT ---
        interactionTitle.innerHTML = "üéâ Shop S·ª± Ki·ªán";
        interactionText.style.display = 'block';
        interactionText.innerHTML = `
            <div style="
                background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); 
                padding: 12px; 
                border-radius: 15px; 
                margin-bottom: 15px; 
                text-align: center; 
                border: 2px solid #f48fb1;
                box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            ">
                <div style="color: #880E4F; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; font-weight:bold;">
                    üëë V∆∞∆°ng Mi·ªán C·ªßa B·∫°n
                </div>
                <div style="font-size: 2em; font-weight: 800; color: #C2185B; text-shadow: 1px 1px 0px rgba(255,255,255,0.5);">
                    ${myCrowns.toLocaleString('vi-VN')}
                </div>
            </div>
        `;
        
        interactionControls.innerHTML = '';
        
        // --- 2. CONTAINER D·∫†NG L∆Ø·ªöI (GRID 2 C·ªòT) ---
        const shopContainer = document.createElement('div');
        shopContainer.style.cssText = `
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            max-height: 380px; 
            overflow-y: auto; 
            padding: 4px;
        `;

        HANGING_ITEMS_CONFIG.forEach(item => {
            const currentOwned = ownedDecorations[item.id] || 0;
            const isMaxed = currentOwned >= MAX_EXCHANGE; // ƒê√£ ƒë·ªïi t·ªëi ƒëa
            const canAfford = myCrowns >= item.price;     // ƒê·ªß ti·ªÅn

            // T·∫°o Card cho t·ª´ng m√≥n
            const itemCard = document.createElement('div');
            
            // S·ª¨A: G√°n class CSS 'event-shop-item' (ƒë√£ t·∫°o ·ªü b∆∞·ªõc 1)
            // Class n√†y s·∫Ω t·ª± ƒë·ªông chuy·ªÉn m√†u n·ªÅn ƒëen khi body c√≥ class 'dark-mode'
            itemCard.className = "event-shop-item";

            // Gi·ªØ l·∫°i logic l√†m m·ªù n·∫øu ƒë√£ mua max
            if(isMaxed) itemCard.style.opacity = "0.7";

            // Hi·ªáu ·ª©ng gi·∫£m gi·ªù (Badge) - GI·ªÆ NGUY√äN
            const speedUpItems = ['chau_chau', 'treo_con_ca', 'treo_long_den', 'treo_trai_chau', 'treo_chong_chong'];
            let badgeHTML = "";
            if (speedUpItems.includes(item.id)) {
                badgeHTML = `<div style="
                    position: absolute; top: 0; left: 0; 
                    background: #E3F2FD; color: #1565C0; 
                    font-size: 0.65em; font-weight: bold; 
                    padding: 3px 8px; border-bottom-right-radius: 8px;
                    z-index: 2;
                ">‚ö° -1 Gi·ªù</div>`;
            }

            // Tr·∫°ng th√°i n√∫t b·∫•m & M√†u s·∫Øc - GI·ªÆ NGUY√äN
            let btnText = "ƒê·ªïi Ngay";
            let btnBg = "linear-gradient(45deg, #EC407A, #D81B60)"; 
            let btnCursor = "pointer";
            let btnDisabled = false;

            if (isMaxed) {
                btnText = "ƒê√£ Max";
                btnBg = "#9E9E9E"; 
                btnCursor = "default";
                btnDisabled = true;
            } else if (!canAfford) {
                btnText = "Thi·∫øu Ti·ªÅn";
                btnBg = "#cfd8dc"; 
                btnCursor = "not-allowed";
                btnDisabled = true;
            }

            // N·ªôi dung Card
            itemCard.innerHTML = `
                ${badgeHTML}
                
                <div class="item-frame" style="width:64px; height:64px; margin-top:12px; border-color: #f8bbd0;">
                    <img src="${item.img}" alt="${item.name}" />
                </div>
                
                <div style="text-align: center; width: 100%; margin: 8px 0;">
                    <div class="item-title-text" style="margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${item.name}
                    </div>

                    <div style="color: #C2185B; font-weight: bold; font-size: 0.95em;">
                        üëë ${item.price}
                    </div>
                    <div style="font-size: 0.75em; color: #999; margin-top: 2px;">
                        ƒê√£ c√≥: <b>${currentOwned}/${MAX_EXCHANGE}</b>
                    </div>
                </div>

                <button class="btn-exchange-event" data-id="${item.id}" ${btnDisabled ? 'disabled' : ''}
                    style="
                        width: 100%;
                        background: ${btnBg}; 
                        color: white; 
                        border: none; 
                        padding: 8px 0; 
                        border-radius: 8px; 
                        font-weight: bold; 
                        font-size: 0.85em;
                        cursor: ${btnCursor};
                        box-shadow: ${btnDisabled ? 'none' : '0 3px 0 #880E4F'};
                        transition: transform 0.1s;
                    ">
                    ${btnText}
                </button>
            `;
            
            shopContainer.appendChild(itemCard);
        });

        interactionControls.appendChild(shopContainer);
        
        // --- 3. X·ª¨ L√ù CLICK ƒê·ªîI ƒê·ªí ---
        const buttons = shopContainer.querySelectorAll('.btn-exchange-event');
        buttons.forEach(btn => {
            btn.onclick = (e) => {
                const itemId = e.target.getAttribute('data-id');
                const itemData = HANGING_ITEMS_CONFIG.find(i => i.id === itemId);
                const currentOwned = ownedDecorations[itemId] || 0;

                // 1. Ki·ªÉm tra gi·ªõi h·∫°n
                if (currentOwned >= MAX_EXCHANGE) return; 

                // 2. Ki·ªÉm tra ti·ªÅn
                if (ownedArtifacts['vuong_mien'] >= itemData.price) {
                    // Hi·ªáu ·ª©ng b·∫•m n√∫t
                    e.target.style.transform = "translateY(3px)";
                    e.target.style.boxShadow = "none";
                    setTimeout(() => {
                         if (confirm(`ƒê·ªïi ${itemData.price} V∆∞∆°ng Mi·ªán l·∫•y 1 ${itemData.name}?`)) {
                            // Tr·ª´ ti·ªÅn
                            ownedArtifacts['vuong_mien'] -= itemData.price;
                            
                            // C·ªông ƒë·ªì
                            if (!ownedDecorations[itemId]) ownedDecorations[itemId] = 0;
                            ownedDecorations[itemId]++;
                            
                            // L∆∞u game
                            saveGame();
                            updateDisplay();
                            
                            // Reload l·∫°i popup ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán (s·ªë l∆∞·ª£ng, n√∫t b·∫•m...)
                            eventCloud.click(); 
                        } else {
                            // N·∫øu h·ªßy th√¨ tr·∫£ l·∫°i hi·ªáu ·ª©ng n√∫t
                            e.target.style.transform = "translateY(0)";
                            e.target.style.boxShadow = "0 3px 0 #880E4F";
                        }
                    }, 100);
                }
            };
        });

        showPopup('interaction-popup');
    });
}
// --- CH·ª®C NƒÇNG 3 L√î (INVENTORY) ---
// H√†m m·ªü kho ƒë·ªì
function openInventory() {
    if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }

    const invDauEl = document.getElementById('inv-dau');
    const invLaEl = document.getElementById('inv-la');
    if (invDauEl) invDauEl.innerText = dau.toLocaleString('vi-VN');
    if (invLaEl) invLaEl.innerText = la.toLocaleString('vi-VN');

    if (typeof ownedArtifacts === 'undefined') { window.ownedArtifacts = {}; }

    const itemsToShow = [
        { id: 'manh_nguyen_to', name: 'M·∫£nh Nguy√™n T·ªë', img: '1000000135.png' },
        { id: 'manh_kim_loai', name: 'M·∫£nh Kim Lo·∫°i', img: '1000000136.png' },
        { id: 'vuong_mien',    name: 'V∆∞∆°ng Mi·ªán',    img: '1000000137.png' },
        { id: 'nhong_ong',     name: 'Nh·ªông Ong',     img: '1000000145.png' },
        { id: 'tui_mat',       name: 'T√∫i M·∫≠t',       img: '1000000153.png' },
        { id: 'ca_tre',        name: 'C√° Tr√™',        img: '1000000148.png' },
        { id: 'ca_do',         name: 'C√° D·ªì',         img: '1000000146.png' },
        { id: 'ca_tai_tuong',  name: 'C√° Tai T∆∞·ª£ng',  img: '1000000147.png' }
    ];

    const listContainer = document.getElementById('inventory-list');
    if (listContainer) {
        listContainer.innerHTML = ''; 
        let hasItem = false; 

        itemsToShow.forEach(item => {
            let qty = ownedArtifacts[item.id] || 0;
            if (qty > 0) {
                hasItem = true;
                let div = document.createElement('div');
                div.className = 'inventory-item';
                // --- THAY ƒê·ªîI: item-frame nh·ªè h∆°n m·ªôt ch√∫t (45px) ---
                div.innerHTML = `
                    <div class="item-frame" style="width:45px; height:45px; margin-right:10px;">
                        <img src="${item.img}" />
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:#3e2723;">${item.name}</div>
                        <div style="font-size:12px; color:#795548;">S·ªë l∆∞·ª£ng: <b style="color:#D84315;">${qty}</b></div>
                    </div>
                `;
                listContainer.appendChild(div);
            }
        });

        if (!hasItem) {
            listContainer.innerHTML = `<div style="text-align:center; padding:20px; color:#999; font-style:italic;">T√∫i ƒë·ªì ƒëang tr·ªëng tr∆°n...</div>`;
        }
    }
    showPopup('inventory-box');
}
// --- CH·ª®C NƒÇNG GIFTCODE (ƒê√É T·ªêI ∆ØU) ---
function stopSmokeEffect() {
    if (window.smokeInterval) {
        clearInterval(window.smokeInterval);
        window.smokeInterval = null;
    }
    // X√≥a ngay c√°c h·∫°t kh√≥i c√≤n s√≥t l·∫°i tr√™n m√†n h√¨nh
    document.querySelectorAll('.smoke-particle').forEach(el => el.remove());
}

// --- H√ÄM M·ªöI: Ki·ªÉm tra xem c√≥ n√™n hi·ªán H√≤m Th√≠nh kh√¥ng ---
function updateGiftcodeBoxState() {
    const box = document.getElementById('giftcode-supply-drop');
    if (!box) return;

    // L·∫•y danh s√°ch t·∫•t c·∫£ m√£ ƒëang k√≠ch ho·∫°t t·ª´ Database
    const activeCodes = Object.keys(GIFTCODE_DATABASE);

    // Ki·ªÉm tra: C√≥ m√£ n√†o trong danh s√°ch ACTIVE m√† user ch∆∞a d√πng kh√¥ng?
    const hasUnusedCode = activeCodes.some(code => !usedGiftcodes.includes(code));

    if (hasUnusedCode) {
        // N·∫øu c√≤n m√£ ch∆∞a d√πng -> Hi·ªán h√≤m v√† B·∫≠t kh√≥i
        box.style.display = 'block';
        startSmokeEffect(); 
    } else {
        // N·∫øu ƒë√£ d√πng h·∫øt s·∫°ch m√£ -> ·∫®n h√≤m v√† T·∫Øt kh√≥i ngay l·∫≠p t·ª©c
        box.style.display = 'none';
        stopSmokeEffect();
    }
}
function showGiftcodePopup() {
    if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
    const inputEl = document.getElementById('giftcode-input');
    if(inputEl) inputEl.value = ''; 
    showPopup('online-box');
}

function handleGiftcode() {
    const inputEl = document.getElementById('giftcode-input');
    const code = inputEl.value.trim().toUpperCase(); 

    if (!code) { alert("Vui l√≤ng nh·∫≠p m√£!"); return; }

    // 1. Ki·ªÉm tra m√£ c√≥ t·ªìn t·∫°i trong Database kh√¥ng
    if (GIFTCODE_DATABASE.hasOwnProperty(code)) {
        
        // 2. Ki·ªÉm tra m√£ ƒë√£ d√πng ch∆∞a
        if (usedGiftcodes.includes(code)) {
            // D√πng showToast thay cho alert n·∫øu c√≥ th·ªÉ
            if(typeof showToast === "function") showToast("M√£ n√†y ƒë√£ s·ª≠ d·ª•ng r·ªìi!", "‚ùå", "L·ªói");
            else alert("‚ùå B·∫°n ƒë√£ s·ª≠ d·ª•ng m√£ n√†y r·ªìi!");
        } else {
            // --- X·ª¨ L√ù NH·∫¨N QU√Ä T·ª∞ ƒê·ªòNG ---
            const reward = GIFTCODE_DATABASE[code];
            let msgDetails = [];

            // C·ªông ti·ªÅn t·ªá
            if (reward.dau > 0) {
                dau += reward.dau;
                msgDetails.push(`+${reward.dau.toLocaleString()} ƒê·∫≠u`);
            }
            if (reward.la > 0) {
                la += reward.la;
                msgDetails.push(`+${reward.la.toLocaleString()} L√°`);
            }

            // C·ªông v·∫≠t ph·∫©m
            if (reward.items) {
                for (const [itemId, quantity] of Object.entries(reward.items)) {
                    if (quantity > 0) {
                        if (!ownedArtifacts[itemId]) ownedArtifacts[itemId] = 0;
                        ownedArtifacts[itemId] += quantity;
                        
                        // L·∫•y t√™n v·∫≠t ph·∫©m ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o
                        let itemName = itemId;
                        if(itemId === 'manh_nguyen_to') itemName = "M·∫£nh Nguy√™n T·ªë";
                        else if(itemId === 'manh_kim_loai') itemName = "M·∫£nh Kim Lo·∫°i";
                        else if(itemId === 'vuong_mien') itemName = "V∆∞∆°ng Mi·ªán";
                        else if(itemId === 'tui_mat') itemName = "T√∫i M·∫≠t";
                        else if(itemId === 'hat_tinh_yeu') itemName = "H·∫°t T√¨nh Y√™u";
                        
                        msgDetails.push(`+${quantity} ${itemName}`);
                    }
                }
            }

            // L∆∞u m√£ ƒë√£ d√πng
            usedGiftcodes.push(code);
            
            // L∆∞u game v√† c·∫≠p nh·∫≠t giao di·ªán
            saveGame();
            updateDisplay();
            hidePopup('online-box');
            
            // C·∫≠p nh·∫≠t l·∫°i kho n·∫øu ƒëang m·ªü
            if(document.getElementById('inventory-box').classList.contains('popup-active')){
                openInventory();
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i h√≤m th√≠nh (·∫©n ƒëi n·∫øu h·∫øt code)
            updateGiftcodeBoxState();

            // Th√¥ng b√°o k·∫øt qu·∫£
            const finalMsg = msgDetails.join("\n");
            
            if(typeof showToast === "function") {
                // --- CH·ªàNH S·ª¨A T·∫†I ƒê√ÇY: CH·ªà HI·ªÜN TOAST, KH√îNG HI·ªÜN ALERT ---
                showToast("Nh·∫≠p Giftcode th√†nh c√¥ng! Ki·ªÉm tra kho ƒë·ªì nh√©.", "üéÅ", "H·ªá Th·ªëng");
                
                // ƒê√£ x√≥a d√≤ng: setTimeout(() => alert(...), 300); 
                // Code FARMLOL gi·ªù s·∫Ω ch·ªâ hi·ªán th√¥ng b√°o nh·ªè ph√≠a tr√™n, kh√¥ng hi·ªán b·∫£ng tr·∫Øng n·ªØa.
            } else {
                // Fallback: Ch·ªâ hi·ªán b·∫£ng tr·∫Øng n·∫øu l·ªói kh√¥ng hi·ªán ƒë∆∞·ª£c Toast
                alert(`üéâ CH√öC M·ª™NG! B·∫°n nh·∫≠n ƒë∆∞·ª£c:\n\n${finalMsg}`);
            }
        }
    } else {
        if(typeof showToast === "function") showToast("M√£ kh√¥ng ƒë√∫ng ho·∫∑c h·∫øt h·∫°n!", "‚ùå", "L·ªói");
        else alert("‚ùå M√£ Giftcode kh√¥ng ƒë√∫ng ho·∫∑c ƒë√£ h·∫øt h·∫°n!");
    }
}

// --- H·ªÜ TH·ªêNG KH√ìI & KH·ªûI T·∫†O GAME (ƒê√É S·ª¨A L·ªñI TH·ª™A CODE) ---

function spawnRedSmoke() {
    const box = document.getElementById('giftcode-supply-drop');
    if (!box) return; 

    const startTop = box.offsetTop; 
    const startLeft = box.offsetLeft; 
    const boxWidth = box.offsetWidth; 

    const smoke = document.createElement('div');
    smoke.className = 'smoke-particle';
    const randomDX = Math.floor(Math.random() * 50) - 25; 
    smoke.style.setProperty('--dx', `${randomDX}px`);
    const randomX = Math.random() * 14 - 7; 
    
    smoke.style.left = (startLeft + (boxWidth / 2) - 8 + randomX) + 'px'; 
    smoke.style.top = (startTop + 10) + 'px'; 

    document.querySelector('main').appendChild(smoke);
    setTimeout(() => { smoke.remove(); }, 2500);
}

function startSmokeEffect() {
    // N·∫øu ƒëang ch·∫°y r·ªìi th√¨ th√¥i, kh√¥ng t·∫°o th√™m v√≤ng l·∫∑p m·ªõi
    if (window.smokeInterval) return;
    
    window.smokeInterval = setInterval(() => {
        const box = document.getElementById('giftcode-supply-drop');
        // Ch·ªâ t·∫°o kh√≥i khi tab ƒëang hi·ªÉn th·ªã V√Ä H√≤m th√≠nh ƒëang hi·ªán (display != none)
        if(!document.hidden && box && box.style.display !== 'none') {
            spawnRedSmoke();
        }
    }, 150);
}

// ======================================================
// --- C·∫¨P NH·∫¨T M·ªöI: T·ªî ONG & ƒê·ªîI T√öI M·∫¨T ---
// ======================================================

// 1. H√†m ki·ªÉm tra: Lu√¥n lu√¥n hi·ªÉn th·ªã T·ªï Ong
function checkBeeHiveSpawn() {
    const beeGuard = document.getElementById('bee-guard');
    if (!beeGuard) return;

    // N·∫øu ch∆∞a t·∫°o game (level 0) th√¨ ·∫©n, c√≤n l·∫°i lu√¥n hi·ªán
    if (level === 0) {
        beeGuard.style.display = 'none';
    } else {
        beeGuard.style.display = 'block';
    }
}

// 2. H√†m hi·ªÉn th·ªã Popup ƒê·ªïi T√∫i M·∫≠t l·∫•y Nh·ªçng Ong
function showBeePopup() {
    if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }

    interactionTitle.innerHTML = "üêù T·ªï Ong N√πi Gi·∫ª";
    interactionText.style.display = 'block';
    
    // Ki·ªÉm tra s·ªë l∆∞·ª£ng T√∫i M·∫≠t ƒëang c√≥ trong kho
    const tuiMatCount = ownedArtifacts['tui_mat'] || 0;

    // N·ªôi dung giao di·ªán ƒë·ªïi
    interactionText.innerHTML = `
        <div style="text-align:center;">
            <img src="1000000144.gif" style="width:80px; height:auto; margin-bottom:10px;">
            <div style="color:#E65100; font-weight:bold; font-size:1.1em;">Th∆∞∆°ng nh√¢n Ong</div>
            <div style="font-size:0.9em; color:#5D4037; margin: 10px 0;">
                "Ta r·∫•t th√®m <b>T√∫i M·∫≠t</b> ng·ªçt ng√†o.<br>
                Ng∆∞∆°i c√≥ mu·ªën ƒë·ªïi kh√¥ng?"
            </div>
            
            <div style="background:#FFF8E1; padding:10px; border-radius:10px; border:1px dashed #FFB300; display:inline-block; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
                    <div style="text-align:center;">
                        <img src="1000000153.png" style="width:40px;">
                        <div style="font-size:0.8em; font-weight:bold;">1 T√∫i M·∫≠t</div>
                    </div>
                    <div style="font-size:1.5em; color:#FF9800;">‚Æï</div>
                    <div style="text-align:center;">
                        <img src="1000000145.png" style="width:40px;">
                        <div style="font-size:0.8em; font-weight:bold;">1 Nh·ªçng Ong</div>
                    </div>
                </div>
            </div>

            <div style="font-size:0.9em; color:#795548;">
                (Hi·ªán c√≥: <b style="color:#D84315">${tuiMatCount}</b> T√∫i M·∫≠t)
            </div>
        </div>
    `;

    interactionControls.innerHTML = '';

    // T·∫°o n√∫t ƒê·ªïi
    const btnExchange = document.createElement('button');
    btnExchange.className = 'btn-buy'; 
    btnExchange.style.marginTop = '15px';
    btnExchange.style.fontSize = '1.1em';
    btnExchange.style.padding = '10px';

    if (tuiMatCount >= 1) {
        // N·∫øu ƒë·ªß T√∫i M·∫≠t -> Cho ph√©p ƒë·ªïi
        btnExchange.innerHTML = "üçØ ƒê·ªïi Ngay";
        btnExchange.style.background = 'linear-gradient(45deg, #FFC107, #FF9800)';
        btnExchange.style.boxShadow = '0 4px 0 #F57C00';
        btnExchange.onclick = () => {
            // 1. Tr·ª´ T√∫i M·∫≠t
            ownedArtifacts['tui_mat']--;
            
            // 2. C·ªông Nh·ªông Ong
            if (!ownedArtifacts['nhong_ong']) ownedArtifacts['nhong_ong'] = 0;
            ownedArtifacts['nhong_ong']++;

            // 3. Hi·ªáu ·ª©ng bay l√™n
            const beeGuard = document.getElementById('bee-guard');
            if(beeGuard) {
                 const floater = document.createElement("div");
                 floater.className = "floating-reward float-item";
                 floater.innerHTML = `<img src="1000000145.png" style="width:30px;"> +1`;
                 floater.style.top = (beeGuard.offsetTop) + "px";
                 floater.style.left = (beeGuard.offsetLeft) + "px";
                 floater.style.zIndex = "2000";
                 document.querySelector("main").appendChild(floater);
                 setTimeout(() => floater.remove(), 1200);
            }

            // 4. L∆∞u game & C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            saveGame();
            updateDisplay();

            // 5. C·∫≠p nh·∫≠t l·∫°i popup ƒë·ªÉ s·ªë l∆∞·ª£ng gi·∫£m ƒëi
            showBeePopup(); 

            // 6. Th√¥ng b√°o Toast
            if(typeof showToast === 'function') {
                showToast("ƒê·ªïi th√†nh c√¥ng: +1 Nh·ªçng Ong", "üêõ");
            }
        };
    } else {
        // N·∫øu kh√¥ng ƒë·ªß -> N√∫t x√°m
        btnExchange.innerHTML = "‚ùå Thi·∫øu T√∫i M·∫≠t";
        btnExchange.style.background = '#ccc';
        btnExchange.style.boxShadow = 'none';
        btnExchange.style.cursor = 'not-allowed';
        btnExchange.onclick = () => {
            alert("B·∫°n c·∫ßn thu ho·∫°ch C√¢y M·∫≠t Ong ƒë·ªÉ c√≥ T√∫i M·∫≠t!");
        };
    }

    interactionControls.appendChild(btnExchange);
    showPopup('interaction-popup');
}
// --- LOGIC C√ÇU C√Å (PRO VERSION) ---
let fishingInterval = null;
let fishingTimerInterval = null;
let fishingWaitInterval = null;

// Bi·∫øn V·∫≠t L√Ω Ng∆∞·ªùi Ch∆°i (ƒê√É CH·ªàNH D·ªÑ H∆†N)
let bobberPos = 10;      
let bobberVelocity = 0;  
const GRAVITY = 0.15;    // R∆°i ch·∫≠m h∆°n
const JUMP_FORCE = 2.5;  // N·∫£y nh·∫π h∆°n

// Bi·∫øn V·∫≠t L√Ω M·ª•c Ti√™u (ƒê√É C·ªê ƒê·ªäNH)
let targetPos = 35;      // ƒê·ª©ng im ·ªü v·ªã tr√≠ 35%
let targetDirection = 0; 
let targetSpeed = 0;     
let changeDirCounter = 0; 

let catchProgress = 30;   // Ti·∫øn ƒë·ªô b·∫Øt (30% kh·ªüi ƒëi·ªÉm)
let gameTimeLeft = 15;    // Th·ªùi gian ch∆°i tƒÉng l√™n 15s

// Danh s√°ch C√° & T·ªâ l·ªá (Gi·ªØ nguy√™n)
const FISH_TYPES = [
    { id: 'ca_tre', name: 'C√° Tr√™', img: '1000000148.png', rate: 0.5 },
    { id: 'ca_do', name: 'C√° D·ªì', img: '1000000146.png', rate: 0.8 }, 
    { id: 'ca_tai_tuong', name: 'C√° Tai T∆∞·ª£ng', img: '1000000147.png', rate: 1.0 }
];

// 1. M·ªü b·∫£ng chu·∫©n b·ªã
function showFishingPrePopup() {
    if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }
    
    // Reset HTML s·∫°ch s·∫Ω cho l·∫ßn ch∆°i m·ªõi
    document.getElementById('fishing-game-area').innerHTML = `
        <div id="fishing-bar-container">
            <div id="zone-green"></div>
            <div id="fishing-bobber"></div>
        </div>
        
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div style="font-size:0.7em; font-weight:bold; color:#0277BD; margin-bottom:5px;">TI·∫æN ƒê·ªò</div>
            <div id="catch-progress-container">
                <div id="catch-progress-fill"></div>
            </div>
        </div>
        
        <div id="fishing-timer">15s</div>
    `;

    document.getElementById('fishing-waiting').style.display = 'block';
    document.getElementById('fishing-start-ui').style.display = 'block';
    document.getElementById('fishing-waiting-anim').style.display = 'none';
    document.getElementById('fishing-game-area').style.display = 'none';
    document.getElementById('fishing-guide-text').style.display = 'none';
    
    const btnStart = document.getElementById('btn-start-fishing');
    if (typeof ownedArtifacts === 'undefined') ownedArtifacts = {};
    const nhongQty = ownedArtifacts['nhong_ong'] || 0;
    
    if (nhongQty > 0) {
        btnStart.innerHTML = `QuƒÉng C·∫ßn (C√≥: ${nhongQty})`;
        btnStart.disabled = false;
        btnStart.style.background = "#29B6F6";
        btnStart.style.cursor = "pointer";
        btnStart.onclick = startFishingWait;
    } else {
        btnStart.innerHTML = `Thi·∫øu Nh·ªông Ong!`;
        btnStart.disabled = true;
        btnStart.style.background = "#bdbdbd";
        btnStart.style.cursor = "not-allowed";
    }

    showPopup('fishing-popup');
}
// --- N√öT THO√ÅT C√ÇU C√Å ---
function closeFishingPopup() {
    // 1. D·ª´ng m·ªçi b·ªô ƒë·∫øm gi·ªù c·ªßa game c√¢u c√°
    if (fishingInterval) clearInterval(fishingInterval);
    if (fishingTimerInterval) clearInterval(fishingTimerInterval);
    if (fishingWaitInterval) clearInterval(fishingWaitInterval);

    // 2. G·ª° b·ªè s·ª± ki·ªán b·∫•m chu·ªôt/m√†n h√¨nh
    document.removeEventListener('mousedown', fishingTap);
    document.removeEventListener('touchstart', fishingTap);

    // 3. ƒê√≥ng Popup
    hidePopup('fishing-popup');

    // 4. ·∫®n h∆∞·ªõng d·∫´n ch∆°i ƒë·ªÉ l·∫ßn sau m·ªü l·∫°i ƒë·∫πp h∆°n
    const guideText = document.getElementById('fishing-guide-text');
    if(guideText) guideText.style.display = 'none';
}
// 2. Giai ƒëo·∫°n ƒë·ª£i 3 gi√¢y (Gi·∫£m xu·ªëng 3s cho nhanh)
function startFishingWait() {
    if ((ownedArtifacts['nhong_ong'] || 0) <= 0) {
        alert("B·∫°n ƒë√£ h·∫øt Nh·ªông Ong!");
        return; 
    }

    if (!ownedArtifacts['nhong_ong']) ownedArtifacts['nhong_ong'] = 0;
    ownedArtifacts['nhong_ong']--;
    
    saveGame();
    
    document.getElementById('fishing-start-ui').style.display = 'none';
    document.getElementById('fishing-waiting-anim').style.display = 'block';
    
    let count = 3; // Gi·∫£m th·ªùi gian ch·ªù
    const countEl = document.getElementById('fishing-countdown');
    countEl.innerText = count;
    
    if (fishingWaitInterval) clearInterval(fishingWaitInterval);

    fishingWaitInterval = setInterval(() => {
        count--;
        countEl.innerText = count;
        if (count <= 0) {
            clearInterval(fishingWaitInterval);
            fishingWaitInterval = null;
            startFishingMinigame();
        }
    }, 1000);
}

// 3. B·∫Øt ƒë·∫ßu Minigame
function startFishingMinigame() {
    document.getElementById('fishing-waiting').style.display = 'none';
    document.getElementById('fishing-game-area').style.display = 'flex';
    document.getElementById('fishing-guide-text').style.display = 'block';
    document.getElementById('fishing-guide-text').innerHTML = "üëÜ <b>NH·∫§P LI√äN T·ª§C</b> ƒë·ªÉ gi·ªØ thanh cam n·∫±m trong v√πng xanh!";
    
    // Reset th√¥ng s·ªë game
    bobberPos = 20;
    bobberVelocity = 0;
    targetPos = 40; // V√πng xanh b·∫Øt ƒë·∫ßu ·ªü gi·ªØa
    catchProgress = 25; // Thanh ti·∫øn ƒë·ªô b·∫Øt ƒë·∫ßu th·∫•p
    gameTimeLeft = 15;
    
    document.addEventListener('mousedown', fishingTap);
    document.addEventListener('touchstart', fishingTap, {passive: false});
    
    if (fishingInterval) clearInterval(fishingInterval);
    fishingInterval = setInterval(gameLoop, 16); // 60 FPS
    
    if (fishingTimerInterval) clearInterval(fishingTimerInterval);
    fishingTimerInterval = setInterval(() => {
        gameTimeLeft--;
        const timerEl = document.getElementById('fishing-timer');
        if(timerEl) timerEl.innerText = gameTimeLeft + "s";
        
        if (gameTimeLeft <= 0) {
            endFishingGame(false); // H·∫øt gi·ªù m√† ch∆∞a ƒë·∫ßy thanh -> Thua
        }
    }, 1000);
}

// X·ª≠ l√Ω c√∫ ƒë·∫©y (Tap)
function fishingTap(e) {
    if(e.type === 'touchstart') e.preventDefault();
    // M·ªói l·∫ßn tap, v·∫≠n t·ªëc tƒÉng l√™n (bay l√™n)
    bobberVelocity = JUMP_FORCE; 
}

// Logic di chuy·ªÉn V√πng Xanh (ƒê√É C·ªê ƒê·ªäNH)
function updateTargetPosition() {
    // Lu√¥n gi·ªØ v√πng xanh ·ªü v·ªã tr√≠ 35%
    targetPos = 35; 

    const zoneEl = document.getElementById('zone-green');
    if(zoneEl) zoneEl.style.bottom = targetPos + "%";
}

// V√≤ng l·∫∑p ch√≠nh x·ª≠ l√Ω v·∫≠t l√Ω
function gameLoop() {
    // A. X·ª≠ l√Ω V√πng Xanh (C√° ch·∫°y)
    updateTargetPosition();

    // B. X·ª≠ l√Ω Thanh Cam (Ng∆∞·ªùi ch∆°i)
    bobberVelocity -= GRAVITY; // Tr·ªçng l·ª±c k√©o xu·ªëng
    bobberPos += bobberVelocity;
    
    // Gi·ªõi h·∫°n thanh cam trong ·ªëng
    if (bobberPos < 0) { bobberPos = 0; bobberVelocity = 0; } // Ch·∫°m ƒë√°y n·∫£y nh·∫π ho·∫∑c d·ª´ng
    if (bobberPos > 92) { bobberPos = 92; bobberVelocity = 0; } // Ch·∫°m ƒë·ªânh
    
    const bobberEl = document.getElementById('fishing-bobber');
    if(bobberEl) bobberEl.style.bottom = bobberPos + "%";
    
    // C. Ki·ªÉm tra va ch·∫°m (Thanh Cam c√≥ n·∫±m trong V√πng Xanh kh√¥ng?)
    // V√πng xanh cao kho·∫£ng 25% (80px/300px), Bobber cao kho·∫£ng 6%
    // Logic: Ki·ªÉm tra bottom c·ªßa 2 th·∫±ng
    // targetPos l√† bottom c·ªßa v√πng xanh. V√πng xanh cao ~25%.
    // bobberPos l√† bottom c·ªßa thanh cam.
    
    // ƒêi·ªÅu ki·ªán n·∫±m trong v√πng: Bobber cao h∆°n ƒë√°y v√πng xanh V√Ä th·∫•p h∆°n ƒë·ªânh v√πng xanh
    // ƒê·ªânh v√πng xanh = targetPos + 25
    // ƒê√°y bobber = bobberPos
    // ƒê·ªânh bobber = bobberPos + 6
    
    const zoneBottom = targetPos;
    const zoneTop = targetPos + 25;
    const bobberBottom = bobberPos;
    const bobberTop = bobberPos + 6;

    // Ki·ªÉm tra giao nhau
    const isOverlapping = (bobberTop > zoneBottom && bobberBottom < zoneTop);
    
    if (isOverlapping) {
        // TR√öNG: Thanh xanh s√°ng l√™n, tƒÉng ti·∫øn ƒë·ªô
        const zoneEl = document.getElementById('zone-green');
        if(zoneEl) {
            zoneEl.style.background = "rgba(118, 255, 3, 0.8)";
            zoneEl.style.boxShadow = "0 0 15px #76FF03";
        }
        catchProgress += 0.4; // TƒÉng ch·∫≠m ƒë·ªÉ game d√†i h∆°n x√≠u
    } else {
        // TR∆Ø·ª¢T: Thanh xanh m·ªù ƒëi, gi·∫£m ti·∫øn ƒë·ªô
        const zoneEl = document.getElementById('zone-green');
        if(zoneEl) {
            zoneEl.style.background = "rgba(118, 255, 3, 0.3)";
            zoneEl.style.boxShadow = "none";
        }
        catchProgress -= 0.3; // Gi·∫£m ph·∫°t
    }
    
    // Gi·ªõi h·∫°n thanh ti·∫øn ƒë·ªô
    if (catchProgress < 0) catchProgress = 0;
    if (catchProgress > 100) catchProgress = 100;
    
    // C·∫≠p nh·∫≠t giao di·ªán thanh ti·∫øn ƒë·ªô
    const progressFill = document.getElementById('catch-progress-fill');
    if(progressFill) {
        progressFill.style.height = catchProgress + "%";
        
        // ƒê·ªïi m√†u theo m·ª©c ƒë·ªô nguy hi·ªÉm
        if(catchProgress < 30) progressFill.style.background = "#F44336"; // ƒê·ªè (Nguy hi·ªÉm)
        else if(catchProgress < 70) progressFill.style.background = "#FF9800"; // Cam
        else progressFill.style.background = "#4CAF50"; // Xanh (T·ªët)
    }

    // D. Ki·ªÉm tra Th·∫Øng/Thua
    if (catchProgress >= 100) {
        endFishingGame(true);
    } else if (catchProgress <= 0 && gameTimeLeft < 13) {
        // Ch·ªâ thua n·∫øu thanh tu·ªôt v·ªÅ 0 SAU 2 gi√¢y ƒë·∫ßu ti√™n (ƒë·ªÉ tr√°nh v·ª´a v√†o game ƒë√£ thua)
        endFishingGame(false);
    }
}

// 4. K·∫øt th√∫c game
function endFishingGame(isWin) {
    clearInterval(fishingInterval);
    clearInterval(fishingTimerInterval);
    document.removeEventListener('mousedown', fishingTap);
    document.removeEventListener('touchstart', fishingTap);
    
    const gameArea = document.getElementById('fishing-game-area');
    const guideText = document.getElementById('fishing-guide-text');
    if(guideText) guideText.style.display = 'none';

    if (isWin) {
        // Random c√° (T·ªâ l·ªá x·ªãn h∆°n)
        const rand = Math.random();
        let fish = null;
        let starRating = "";
        
        if (rand < 0.5) { fish = FISH_TYPES[0]; starRating = "‚≠ê"; }      
        else if (rand < 0.85) { fish = FISH_TYPES[1]; starRating = "‚≠ê‚≠ê"; } 
        else { fish = FISH_TYPES[2]; starRating = "‚≠ê‚≠ê‚≠ê"; }                
        
        if (!ownedArtifacts[fish.id]) ownedArtifacts[fish.id] = 0;
        ownedArtifacts[fish.id]++;
        saveGame();
        
        gameArea.innerHTML = `
            <div style="text-align:center; animation:popInReward 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                <div style="font-size:3em; margin-bottom:5px;">üé£</div>
                <h2 style="color:#2E7D32; margin:0; text-transform:uppercase;">D√≠nh c√° r·ªìi!</h2>
                <div style="background:radial-gradient(circle, #fff, #B2DFDB); padding:10px; border-radius:50%; width:100px; height:100px; display:flex; align-items:center; justify-content:center; margin:10px auto; border:3px solid #009688;">
                    <img src="${fish.img}" style="width:80%; height:auto; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.3));">
                </div>
                <div style="font-size:1.3em; font-weight:900; color:#006064;">${fish.name}</div>
                <div style="color:#FFC107; font-size:1.2em; letter-spacing:2px; margin-bottom:5px;">${starRating}</div>
                <button onclick="showFishingPrePopup()" class="btn-buy" style="margin-top:10px; width:auto; padding:10px 25px; box-shadow:0 4px 0 rgba(0,0,0,0.2);">C√¢u Ti·∫øp</button>
            </div>
        `;
    } else {
        // --- L∆ØU GAME KHI C√ÇU THUA ---
        saveGame(); 

        gameArea.innerHTML = `
            <div style="text-align:center; animation:shake 0.5s;">
                <div style="font-size:4em; margin:10px 0; opacity:0.7;">üåä</div>
                <h2 style="color:#c62828; margin:0;">S·∫®Y M·∫§T R·ªíI!</h2>
                <p style="color:#546E7A; font-weight:bold;">C√° qu√° m·∫°nh...</p>
                <div style="width:100%; height:2px; background:#cfd8dc; margin:15px 0;"></div>
                <button onclick="showFishingPrePopup()" class="btn-buy" style="width:auto; padding:10px 25px; background:#FF5722; box-shadow:0 4px 0 #D84315;">Th·ª≠ L·∫°i Ngay</button>
            </div>
            <style>@keyframes shake {0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); }}</style>
        `;
    }
}

function initializeGame(){
    // 1. T·∫£i d·ªØ li·ªáu
    loadGame(); 
    
    // 2. C√†i ƒë·∫∑t giao di·ªán
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if(isDarkMode) document.body.classList.add('dark-mode');
    adjustAppWrapperScale(); 
    
    // 3. C·∫≠p nh·∫≠t logic game
    updateFarmState(); 
    checkGlobalCrafting();
    checkIncubationState();

    // 4. Hi·ªÉn th·ªã
    updateDisplay(); 
    updateControlButtons(); 
    updateShop(); 
    updateBlacksmithVisuals(); 
    
    // 5. Kh·ªüi t·∫°o s·ª± ki·ªán
    initVineEvents();        
    initGrasshopperEvents(); 
    
    // 6. KI·ªÇM TRA S·ª∞ KI·ªÜN ƒê·∫∂C BI·ªÜT (QUAN TR·ªåNG)
    updateGiftcodeBoxState(); // Ki·ªÉm tra h√≤m th√≠nh
    checkBeeHiveSpawn();      // <--- B·ªî SUNG: G·ªçi ong ngay khi v√†o game
    
    // B·∫≠t kh√≥i n·∫øu h√≤m th√≠nh ƒëang hi·ªán
    const giftBox = document.getElementById('giftcode-supply-drop');
    if(giftBox && giftBox.style.display !== 'none') {
        startSmokeEffect();
    }
}

// --- V√íNG L·∫∂P GAME (Ch·∫°y m·ªói gi√¢y) ---
setInterval(() => {
    updateFarmState();        // C√¢y l·ªõn
    checkGlobalCrafting();    // Th·ª£ r√®n
    checkIncubationState();   // Tr·ª©ng n·ªü
    checkBeeHiveSpawn();      // <--- B·ªî SUNG: Ki·ªÉm tra ong li√™n t·ª•c m·ªói gi√¢y
}, 1000);

// --- LOGIC NPC B√ÅNH BAO (THU MUA C√Å) ---
// C·∫•u h√¨nh gi√° b√°n c√°
const FISH_PRICES = {
    'ca_tre':       { name: 'C√° Tr√™',       price: 50, img: '1000000148.png' },
    'ca_do':        { name: 'C√° D·ªì',        price: 70, img: '1000000146.png' },
    'ca_tai_tuong': { name: 'C√° Tai T∆∞·ª£ng', price: 80, img: '1000000147.png' }
};

// --- LOGIC NPC B√ÅNH BAO (THU MUA C√Å - ƒê√É C·∫¨P NH·∫¨T ITEM-FRAME) ---
function showFishBuyerPopup() {
    if (level === 0) { alert("B·∫°n c·∫ßn t·∫°o n√¥ng tr·∫°i tr∆∞·ªõc!"); return; }

    // 1. C√†i ƒë·∫∑t ti√™u ƒë·ªÅ
    interactionTitle.innerHTML = "üê± B√°nh Bao";
    interactionText.style.display = 'block';
    interactionText.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; background:#FFF3E0; padding:10px; border-radius:10px; border:2px dashed #FFB74D;">
            <img src="1000000154.gif" style="width:60px; height:auto; object-fit:contain;">
            <div style="text-align:left; font-size:0.9em; color:#E65100; font-weight:600;">
                "Meow! C·∫≠u c√¢u ƒë∆∞·ª£c c√° kh√¥ng?<br>
                T·ªõ mua gi√° cao b·∫±ng <b>ƒê·∫≠u</b> n√®!"
            </div>
        </div>
        <div style="margin-top:8px; font-size:0.85em; color:#795548; text-align:center;">
            (T√†i s·∫£n hi·ªán t·∫°i: <b style="color:#795548;">${dau.toLocaleString()}</b> ü´ò)
        </div>
    `;

    interactionControls.innerHTML = '';

    // 2. T·∫°o danh s√°ch c√°
    const container = document.createElement('div');
    container.style.cssText = "display:flex; flex-direction:column; gap:8px; max-height:280px; overflow-y:auto; margin-top:15px; padding:2px;";

    let hasFishToSell = false;

    Object.keys(FISH_PRICES).forEach(fishKey => {
        const fishData = FISH_PRICES[fishKey];
        const qty = ownedArtifacts[fishKey] || 0;

        if (qty > 0) {
            hasFishToSell = true;
                        // 1. T·∫°o th·∫ª div cho d√≤ng b√°n c√°
            const row = document.createElement('div');
            
            // QUAN TR·ªåNG: G√°n class CSS v·ª´a t·∫°o ·ªü B∆∞·ªõc 1
            row.className = "fish-sell-item"; 

            // 2. N·ªôi dung b√™n trong (ƒê√£ th√™m class fish-name-text ƒë·ªÉ ƒë·ªïi m√†u ch·ªØ)
            row.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="item-frame" style="width:50px; height:50px; margin:0;">
                        <img src="${fishData.img}" style="object-fit:contain;">
                    </div>
                    <div style="text-align:left;">
                        <div class="fish-name-text" style="font-weight:bold; color:#37474F;">${fishData.name}</div>
                        <div style="font-size:0.8em; color:#009688;">Gi√°: <b>${fishData.price}</b> ü´ò</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:0.75em; color:#999; margin-bottom:4px;">Kho: ${qty}</div>
                </div>
            `;

            // T·∫°o n√∫t "B√°n H·∫øt"
            const btnSell = document.createElement('button');
            btnSell.innerText = "B√°n H·∫øt";
            btnSell.style.cssText = "background: linear-gradient(45deg, #FFCA28, #FF6F00); color: white; border: none; border-radius: 20px; padding: 6px 12px; font-weight: bold; font-size: 0.8em; cursor: pointer; box-shadow: 0 2px 0 #E65100;";
            
            btnSell.onclick = () => {
                const totalEarned = qty * fishData.price; 
                if(confirm(`B√°n ${qty} con ${fishData.name} ƒë·ªÉ nh·∫≠n ${totalEarned.toLocaleString()} ƒê·∫≠u?`)) {
                    ownedArtifacts[fishKey] = 0;
                    dau += totalEarned;
                    saveGame();
                    updateDisplay();
                    
                    if(typeof showToast === 'function') showToast(`+${totalEarned.toLocaleString()} ƒê·∫≠u`, "üí∞", "ƒê√£ B√°n");
                    else alert(`B√°n th√†nh c√¥ng! Nh·∫≠n ƒë∆∞·ª£c ${totalEarned} ƒê·∫≠u.`);

                    showFishBuyerPopup();
                }
            };

            row.querySelector('div[style*="text-align:right"]').appendChild(btnSell);
            container.appendChild(row);
        }
    });

    if (!hasFishToSell) {
        container.innerHTML = `
            <div style="text-align:center; padding:30px; color:#B0BEC5;">
                <div style="font-size:3em; opacity:0.5; margin-bottom:10px;">üêü</div>
                <div>T√∫i c√° tr·ªëng tr∆°n...</div>
                <div style="font-size:0.85em; margin-top:5px;">(H√£y sang ao b√™n c·∫°nh c√¢u c√° nh√©!)</div>
            </div>
        `;
    }

    interactionControls.appendChild(container);
    showPopup('interaction-popup');
}
// ======================================================
// --- H·ªÜ TH·ªêNG L∆ØU GAME T·ª∞ ƒê·ªòNG (OPTIMIZED V2) ---
// ======================================================

function _saveGame(showAlert = false) {
    // 1. C·∫≠p nh·∫≠t d·ªØ li·ªáu quan tr·ªçng tr∆∞·ªõc khi ƒë√≥ng g√≥i
    // ƒê·∫£m b·∫£o c·∫•p ƒë·ªô sao c·ªßa Pet hi·ªán t·∫°i ƒë∆∞·ª£c ghi nh·ªõ v√†o danh s√°ch chung
    if (typeof hatchedPetType !== 'undefined' && hatchedPetType && typeof petLevels !== 'undefined') {
        petLevels[hatchedPetType] = petStarLevel;
    }

    // 2. Gom t·∫•t c·∫£ d·ªØ li·ªáu v√†o m·ªôt object
    const gameData = {
        playerName, farmIcon, level, exp, dau, la, tool, farmSlots,
        activePet, ownedPets, hasIceEgg, isIceDragonHatched, isIceDragonEvolved,
        hatchedPetType,
        ownedSeeds, lastFedTime, globalPetAge, lastBeePokeTime,
        petStarLevel,
        petLevels, // <-- Quan tr·ªçng: L∆∞u level t·ª´ng con Pet
        ownedPots, craftingQueue, equippedPots,
        incubationFinishTime, vineDecorations, ownedDecorations, ownedArtifacts,
        grasshopperExchanged,
        usedGiftcodes,
        isUpgrading
    };

    // 3. Th·ª±c hi·ªán l∆∞u v√†o b·ªô nh·ªõ tr√¨nh duy·ªát
    try {
        localStorage.setItem('farmLolGame', JSON.stringify(gameData));
        
        if (showAlert) {
            alert("ƒê√£ l∆∞u tr√≤ ch∆°i th√†nh c√¥ng!");
        }
        // L∆∞u √Ω: ƒê√£ b·ªè console.log ƒë·ªÉ tr√°nh l√†m ch·∫≠m tr√¨nh duy·ªát khi ch∆°i l√¢u
    } catch (e) {
        // 4. X·ª≠ l√Ω l·ªói n·∫øu b·ªô nh·ªõ ƒë·∫ßy (QuotaExceededError)
        console.error("L·ªói l∆∞u game (Memory Full): ", e);
        if (showAlert) {
            alert("‚ö†Ô∏è C·∫¢NH B√ÅO: Kh√¥ng th·ªÉ l∆∞u game!\nB·ªô nh·ªõ tr√¨nh duy·ªát ƒë√£ ƒë·∫ßy. H√£y x√≥a b·ªõt d·ªØ li·ªáu web c≈©.");
        }
    }
}

// H√†m g·ªçi t·∫Øt ƒë·ªÉ l∆∞u ng·∫ßm (Kh√¥ng hi·ªán th√¥ng b√°o l√†m phi·ªÅn)
function saveGame() {
    // Ch·ªâ l∆∞u khi ng∆∞·ªùi ch∆°i ƒë√£ t·∫°o nh√¢n v·∫≠t (Level > 0)
    if (typeof level !== 'undefined' && level > 0) {
        _saveGame(false);
    }
}

// --- C√ÅC S·ª∞ KI·ªÜN K√çCH HO·∫†T L∆ØU ---

// 1. L∆∞u ƒë·ªãnh k·ª≥: M·ªói 60 gi√¢y (1 ph√∫t) t·ª± l∆∞u 1 l·∫ßn
setInterval(saveGame, 60000);

// 2. L∆∞u khi ng∆∞·ªùi ch∆°i ·∫©n Tab (V√≠ d·ª•: Chuy·ªÉn sang xem YouTube, Facebook...)
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
        saveGame();
    }
});

// 3. L∆∞u khi ng∆∞·ªùi ch∆°i vu·ªët tho√°t ·ª©ng d·ª•ng tr√™n ƒêI·ªÜN THO·∫†I (ƒê·∫∑c bi·ªát l√† iPhone/Safari)
// S·ª± ki·ªán 'pagehide' tin c·∫≠y h∆°n 'beforeunload' tr√™n mobile
window.addEventListener("pagehide", () => {
    saveGame();
});

// 4. L∆∞u khi t·∫Øt tr√¨nh duy·ªát ho·∫∑c t·∫£i l·∫°i trang tr√™n M√ÅY T√çNH
window.addEventListener("beforeunload", () => {
    saveGame();
});

// --- KH·ªûI ƒê·ªòNG GAME ---
// ƒê·∫£m b·∫£o h√†m n√†y n·∫±m cu·ªëi c√πng ƒë·ªÉ ch·∫°y sau khi m·ªçi th·ª© ƒë√£ s·∫µn s√†ng
window.onload = initializeGame;
</script>
</body>
</html>
