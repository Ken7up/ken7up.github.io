<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Farm lol</title>
<style>
  :root{ 
    --bg:#e1f5d3; 
    --card:#ffffffcc; 
    --muted:#5f6f52; 
    --accent:#4caf50; 
    
    --dark-bg: #1c1c1c; 
    --dark-main-text: #e0e0e0; 
    --dark-muted-text: #a0a0a0; 
    --dark-card: #2c2c2ccc; 
  }
  
  *{box-sizing:border-box}
  
  body{ 
    margin:0; 
    font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;
    background: var(--bg);
    color:#2b3a1f; 
    min-height:100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    transition: background 0.3s, color 0.3s; 
  }

  body.dark-mode {
    background: var(--dark-bg);
    color: var(--dark-main-text);
  }

  .app-wrapper {
    width: 400px; 
    height: 750px; 
    margin: 0; 
    background: var(--bg);
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 10px rgba(0,0,0,0.1); 
    position: relative; 
    text-align: left; 
    transform-origin: top center; 
    transform: scale(1); 
    transition: transform 0.1s ease-out, background 0.3s;
    flex-shrink: 0;
  }
  
  .dark-mode .app-wrapper {
      background: var(--dark-bg);
      box-shadow: 0 0 10px rgba(255,255,255,0.1); 
  }

  header{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between;
      padding: 6px 12px; 
      border-bottom:1px solid rgba(0,0,0,0.05);
      backdrop-filter:blur(4px); 
      background: rgba(255, 255, 255, 0.5); 
      white-space:nowrap; 
      z-index: 20; 
      transition: background 0.3s, border-color 0.3s;
      height: 46px;
  }

  .controls button {
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
      margin-left: 3px;
  }
  
  #player-level-display {
      font-size: 14px;
  }

  .dark-mode header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(44, 44, 44, 0.6); 
      color: var(--dark-main-text);
  }

  .brand {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      cursor: pointer; 
      user-select: none; 
  }
  
  #exp-bar-container {
      width: 80px; 
      height: 4px; 
      background: rgba(0,0,0,0.1); 
      border-radius: 3px;
      margin-top: 3px;
      overflow: hidden;
      display: none; 
  }

  .dark-mode #exp-bar-container {
      background: rgba(255,255,255,0.2); 
  }

  #exp-fill {
      height: 100%;
      width: 0%;
      background: var(--accent);
      transition: width 0.3s ease;
      border-radius: 3px;
  }
  
  main{ flex:1; display:flex; justify-content:center; 
        align-items:flex-start; 
        padding:0; 
        overflow: hidden;
        position: relative;
  }
  main > div {
    display: none; 
  }
  
  #beanstalk-bg {
    position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100%; height: auto;
    z-index: 3; max-height: 100%; object-fit: cover; mix-blend-mode: normal;
  }

  #light-bulb {
      position: absolute; 
      top: 8px; 
      left: calc(30% - 5px); 
      transform: translateX(-50%);
      z-index: 8; 
      cursor: pointer; 
      width: 30px; 
      height: auto;
  }

  #kinto-cloud {
      position: absolute; top: 30px; left: calc(60% + 15px); transform: translateX(-50%); 
      width: 30px; height: 30px; z-index: 10; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; 
  }

  #pot-container {
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 100%; height: 100%; z-index: 5; display: flex; justify-content: center; pointer-events: none; 
  }

  .pot-slot {
      position: absolute; width: 50px; height: 50px; background: transparent; border: none; 
      display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1em; 
      color: white; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; pointer-events: auto; 
  }

  .pot-slot img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
  }
  
  .pot-base-img {
      width: 120%; height: 120%; object-fit: contain; position: absolute; top: -10px; left: -10px;
      transition: opacity 0.3s;
  }

  /* --- SLOT 1 (Rá»’NG) --- */
  #slot-1 { width: 50px; height: 50px; top: 125px; left: calc(50% - 160px); }
  #slot-1 img { width: 120%; height: 120%; top: -10px; left: -10px; }
  
  /* --- SLOT 6 (NPC) --- */
  #slot-6 { width: 35px; height: 35px; top: 315px; left: calc(50% - 30px + 10px + 15px); }
  #slot-6 img { width: 130%; height: 130%; top: -15px; left: -5px; }
  
  /* --- CÃC SLOT TRá»’NG CÃ‚Y (2, 3, 4, 5, 7) --- */
  #slot-2, #slot-3, #slot-4, #slot-5, #slot-7 { width: 35px; height: 35px; }
  #slot-2 img, #slot-3 img, #slot-4 img, #slot-5 img, #slot-7 img { width: 130%; height: 130%; top: -5px; left: -5px; }
  
  .seed-image {
      width: 140% !important; 
      height: auto !important; 
      max-height: 120px !important; 
      object-fit: contain; 
      position: absolute; 
      bottom: 27px !important;  
      top: auto !important;     
      left: 50% !important;
      transform: translateX(-50%) !important; 
      z-index: 6;
      pointer-events: none;
  }

  /* Vá»Š TRÃ CÃC Ã” Äáº¤T */
  #slot-2 { top: 135px; left: calc(50% - 90px - 10px); }
  #slot-3 { top: 135px; left: calc(50% - 30px - 10px); } 
  #slot-4 { top: 135px; left: calc(50% + 30px - 10px); }
  #slot-5 { top: 135px; left: calc(50% + 90px - 10px); }
  #slot-7 { top: 135px; left: calc(50% + 150px - 10px); }
  
  #slot-2, #slot-3, #slot-4, #slot-5, #slot-7, #slot-1, #slot-6 { background: transparent; border: none; }

  #pet-house {
      position: absolute; bottom: 210px; left: 50%; transform: translateX(calc(-50% + 100px)); 
      width: 150px; height: auto; z-index: 7; cursor: pointer;
  }
  
  #pug-pet {
      position: absolute; bottom: 50px; left: 50%; transform: translateX(calc(-50% - 50px)); 
      width: 120px; height: auto; z-index: 7; cursor: pointer;
  }
  
  #bone-bowl {
      position: absolute; bottom: 130px; left: 50%; transform: translateX(calc(-50% + 110px)); 
      width: 50px; height: auto; z-index: 7; cursor: pointer; 
  }
  
  #shop-box, #online-box, #pet-house-box, #interaction-popup, #seed-box { 
    position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
    background:white; padding:20px; border-radius:12px; box-shadow:0 4px 18px rgba(0,0,0,0.25); 
    display:none; z-index:999; text-align:center; min-width:240px; 
    transition: background 0.3s, color 0.3s, box-shadow 0.3s;
  }

  #seed-box { min-width: 200px; }
  
  #pet-shop-items { 
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; padding: 5px; 
  }

  .pet-shop-item {
      border: 1px solid var(--muted); border-radius: 8px; padding: 6px; text-align: center;
      transition: background 0.1s; cursor: pointer;
  }
  .pet-shop-item:hover { background: rgba(0, 0, 0, 0.05); }
  .pet-shop-item img { width: 40px; height: 40px; margin-bottom: 3px; object-fit: contain; }

  .shop-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
  .shop-item img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 5px; }
  
  #seed-items .shop-item {
      display: flex; flex-direction: row; justify-content: space-between; align-items: center;
      padding: 8px 10px; border: 1px solid var(--muted); border-radius: 8px; margin-bottom: 5px;
  }
  
  #seed-items .shop-item img { width: 80px; height: 80px; margin: 0 10px 0 0; }
  #seed-items .shop-item > div:first-of-type { text-align: left; flex-grow: 1; }

  .dark-mode #shop-box, .dark-mode #online-box, .dark-mode #pet-house-box, .dark-mode #interaction-popup, .dark-mode #seed-box {
    background: var(--dark-card); color: var(--dark-main-text); box-shadow: 0 4px 18px rgba(255,255,255,0.1); 
  }
  
  .dark-mode #tool-desc { color: var(--dark-muted-text); }
  .dark-mode input[type="text"] { background: #3c3c3c; border: 1px solid #555; color: var(--dark-main-text); }
  
  #pet-may-items, #hat-may-items {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; overflow: hidden;
      max-height: 0; opacity: 0; transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out; 
  }
  
  .shop-items-visible { max-height: 500px !important; opacity: 1 !important; padding-top: 10px; }

  .shop-collapsible-header { cursor: pointer; user-select: none; transition: color 0.2s; }
  .shop-collapsible-header:hover { color: #388e3c; }

  @keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
  }

  .pet-rarity-white { color: #ffffff; text-shadow: 0 0 3px rgba(0, 0, 0, 0.5); }
  .pet-rarity-green { color: #4CAF50; text-shadow: 0 0 3px rgba(0, 0, 0, 0.5); }
  .pet-rarity-blue { color: #2196F3; text-shadow: 0 0 3px rgba(0, 0, 0, 0.5); }
  .pet-rarity-stars { 
      display: block; 
      text-align: center; 
      font-size: 1.2em; 
      margin-top: 5px; 
      color: gold; 
      text-shadow: 0 0 2px rgba(0, 0, 0, 0.5); 
  }

  .dark-mode .pet-rarity-white { color: #f0f0f0; }
  .dark-mode .pet-rarity-green { color: #66BB6A; }
  .dark-mode .pet-rarity-blue { color: #64B5F6; }

</style>
</head>
<body>
<div class="app-wrapper"> 

<header>
  <div class="brand">
    <div id="player-level-display" style="font-weight:700">ğŸŒ¾ Farm LOL ğŸŒ¾</div>
    <div id="exp-bar-container">
        <div id="exp-fill"></div>
    </div>
  </div>
  <div class="controls">
    <button id="btn-new">ğŸ†• Táº¡o</button>
    <button id="btn-delete" disabled>ğŸ—‘ï¸ XoÃ¡</button>
    <button id="btn-save" disabled>ğŸ’¾ LÆ°u</button>
  </div>
</header>

<div id="name-box" style="display:none; text-align:center; padding:15px; font-size:22px;">
<div style="font-weight:600; margin-bottom:10px;">Xin chÃ o nÃ´ng dÃ¢n!</div>
TÃªn báº¡n lÃ  gÃ¬?
<input type="text" id="player-name" placeholder="VÃ­ dá»¥: Alice" style="margin:10px 0; padding:8px; border-radius:6px; border:1px solid #ccc; width:80%; max-width:200px;" />
<br>
<button id="btn-next">Tiáº¿p theo &rarr;</button>
</div>

<div id="shop-box" style="padding: 15px; width: 320px;">
  <h3 style="margin: 0 0 5px 0; font-size: 1.2em;">â˜ï¸ Shop MÃ¢y</h3> 
  <div style="font-size:0.85em; margin-bottom:8px; color:var(--muted);">
    <span style="font-size:1em; color:gold;">ğŸª™</span>: <span id="coin-xu-shop">0</span> Xu | 
    <span style="font-size:1em; color:green;">ğŸ’¸</span>: <span id="coin-usd-shop">0</span> ÄÃ´
  </div>
  <hr style="border:0; border-top:1px solid #eee; margin:5px 0;" />

  <h4 id="header-pet-may" class="shop-collapsible-header" data-target="pet-may-items" style="margin-top:10px; margin-bottom: 5px; text-align:left; color:var(--accent); font-size: 1em;">
    ğŸ¾ Pet MÃ¢y
  </h4>
  <div id="pet-may-items"></div>

  <h4 id="header-hat-may" class="shop-collapsible-header" data-target="hat-may-items" style="margin-top:10px; margin-bottom: 5px; text-align:left; color:var(--accent); font-size: 1em;">
    ğŸ«˜ Háº¡t MÃ¢y
  </h4>
  <div id="hat-may-items"></div>

  <div id="shop-items" style="display:none; grid-template-columns:1fr 1fr; gap:10px;"></div>
  
  <button onclick="shopBox.style.display='none'" style="margin-top:12px; padding: 6px 15px; font-size: 0.9em;">ÄÃ³ng</button>
</div>

<div id="seed-box">
<h3>ğŸŒ± Shop Háº¡t Giá»‘ng</h3> <div style="font-size:0.9em; margin-bottom:10px; color:var(--muted);">
  <span style="font-size:1.1em; color:gold;">ğŸª™</span>: <span id="coin-xu-seed">0</span> Xu | 
  <span style="font-size:1.1em; color:green;">ğŸ’¸</span>: <span id="coin-usd-seed">0</span> ÄÃ´
</div>
<hr style="border:0; border-top:1px solid #eee; margin:10px 0;" />
<div id="seed-items" style="display:grid; grid-template-columns:1fr; gap:10px;"></div>
<button onclick="seedBox.style.display='none'" style="margin-top:15px;">ÄÃ³ng</button>
</div>

<div id="online-box">
<h3>ğŸŒ Online</h3>
<div style="margin-bottom:15px;">Chá»©c nÄƒng nÃ y hiá»‡n chÆ°a kháº£ dá»¥ng.</div>
<button onclick="onlineBox.style.display='none'">ÄÃ³ng</button>
</div>

<div id="pet-house-box" style="padding: 15px;">
  <h3 id="pet-house-title" style="margin-top:0;">ğŸ¾ NhÃ  Pet</h3> 
  <div style="font-size:0.9em; margin-bottom:8px; color:var(--muted);">
      <span style="font-size:1.1em; color:gold;">ğŸª™</span>: <span id="coin-xu-pet">0</span> Xu | 
      <span style="font-size:1.1em; color:green;">ğŸ’¸</span>: <span id="coin-usd-pet">0</span> ÄÃ´
  </div>
  <div id="pet-shop-items"></div>
  <button onclick="document.getElementById('pet-house-box').style.display='none'" style="margin-top: 12px; padding: 6px 15px; font-size: 0.9em;">ÄÃ³ng</button>
</div>
<div id="interaction-popup">
    <h3 id="interaction-title"></h3> 
    <div id="interaction-text" style="min-height: 50px;"></div>
    <br>
    <div id="interaction-controls" style="margin-top: 10px;"></div>
    <button onclick="closeInteractionPopup()">ÄÃ³ng</button>
</div>

<main>
  <img id="beanstalk-bg" src="1000000105.png" alt="Khu vÆ°á»n bÃªn há»“" />
  <img id="light-bulb" src="1000000110.png" alt="BÃ³ng Ä‘Ã¨n sá»£i Ä‘á»‘t" />
  <div id="pot-container">
    <div class="pot-slot" id="slot-1" data-slot="1">
        <img id="ice-egg-img" src="" alt="Trá»©ng BÄƒng Tuyáº¿t" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-2" data-slot="2">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" /> 
        <img id="seed-img-2" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-3" data-slot="3">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" />
        <img id="seed-img-3" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-6" data-slot="6">
        <img src="1000000116.png" alt="Em bÃ© cÃ¢u cÃ¡" />
    </div>
    
    <div class="pot-slot" id="slot-4" data-slot="4">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" />
        <img id="seed-img-4" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    <div class="pot-slot" id="slot-5" data-slot="5">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" />
        <img id="seed-img-5" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    
    <div class="pot-slot" id="slot-7" data-slot="7">
        <img class="pot-base-img" src="1000000112.png" alt="Cháº­u Ä‘áº¥t" />
        <img id="seed-img-7" class="seed-image" src="" alt="Váº­t pháº©m trá»“ng" style="display:none;" />
    </div>
    
    </div>
  
  <img id="kinto-cloud" src="1000000103.png" alt="CÃ¢n Äáº©u VÃ¢n" data-slot="0" />
  <img id="pet-house" src="1000000100.png" alt="NhÃ  Pet" />
  <img id="pug-pet" src="" alt="ChÃº chÃ³ Pug" style="display:none;" />
  <img id="bone-bowl" src="1000000115.png" alt="BÃ¡t Ä‘á»±ng xÆ°Æ¡ng" />
  <div></div>
</main>

</div> 

<script>
let playerName = "NÃ´ng dÃ¢n";
let farmIcon = "ğŸŒ¾";
let level = 0;
let exp = 0;
let xu = 0;
let usd = 0;
let tool = { name: "Xáº»ng Gá»—", power: 1, maxHP: 100, currentHP: 100 };
let hasIceEgg = false; 
let isIceDragonHatched = false; 
let isIceDragonEvolved = false; 
let activePet = null;
let ownedPets = []; 
let ownedSeeds = { 'tinh_hat_suong': 0, 'hat_kim_loai': 0 }; // ÄÃ£ thÃªm háº¡t kim loáº¡i vÃ o tÃºi
let globalPetAge = 0; 
let lastFedTime = 0; 
let activePopupInterval = null;

const FARM_IDS = [2, 3, 4, 5, 7]; 
let farmSlots = Array(5).fill(null); 

let petShopItems = [
    { 
        id: 101, name: "Pug PÃ©o", price: 100, currency: "usd", type: "pet", 
        icon: "1000000106.png", value: "1000000106.png", position: { bottom: '50px', left: 'calc(50% - 50px)' }, 
    },
    { 
        id: 102, name: "Mr. Gold", price: 100, currency: "usd", type: "pet", 
        icon: "1000000104.png", value: "1000000104.png", position: { bottom: '50px', left: 'calc(50% - 50px)' }, 
    },
];

// --- Cáº¬P NHáº¬T DANH SÃCH SHOP ---
let shopItems = [
    { id: 201, name: "Trá»©ng BÄƒng Tuyáº¿t", price: 100, currency: "usd", type: "item", icon: "1000000102.png", value: "trung_bang_tuyet", category: "pet_may" },
    { id: 202, name: "Rá»“ng BÄƒng Tuyáº¿t", price: 0, currency: "xu", type: "pet", icon: "1000000108.png", value: "1000000108.png" },
    { id: 203, name: "Rá»“ng BÄƒng Tuyáº¿t Big", price: 0, currency: "xu", type: "pet", icon: "1000000109.png", value: "1000000109.png" },
    { id: 204, name: "Háº¡t NguyÃªn Tá»‘", price: 100, currency: "xu", type: "seed", icon: "1000000126.png", value: "tinh_hat_suong", category: "hat_may" }, 
    // --- THÃŠM Háº T KIM LOáº I VÃ€O ÄÃ‚Y ---
    { id: 205, name: "Háº¡t Kim Loáº¡i", price: 100, currency: "xu", type: "seed", icon: "1000000123.png", value: "hat_kim_loai", category: "hat_may" },
];

let seedShopItems = [];

const PLANT_STAGES = [
    { name: "Máº§m Nhá»", icon: "1000000114.png", duration: 0, next: 60 * 1000 }, 
    { name: "CÃ¢y TrÆ°á»Ÿng ThÃ nh", icon: "1000000125.png", duration: 60 * 1000, next: 60 * 1000 }, 
    { name: "Sáºµn SÃ ng Thu Hoáº¡ch", icon: "1000000125.png", duration: 120 * 1000, next: 0 }, 
];

const body = document.body; 
const btnNew = document.getElementById("btn-new");
const btnDelete = document.getElementById("btn-delete"); 
const btnSave = document.getElementById("btn-save");  
const lightBulb = document.getElementById("light-bulb"); 
const nameBox = document.getElementById("name-box");
const btnNext = document.getElementById("btn-next");
const nameInput = document.getElementById("player-name");
const shopBox = document.getElementById("shop-box");

const playerLevelDisplay = document.getElementById("player-level-display");
const expBarContainer = document.getElementById("exp-bar-container");
const expFill = document.getElementById("exp-fill");

const coinXuShop = document.getElementById("coin-xu-shop");
const coinUSDShop = document.getElementById("coin-usd-shop");
const coinXuPet = document.getElementById("coin-xu-pet");
const coinUSDPet = document.getElementById("coin-usd-pet");
const seedBox = document.getElementById("seed-box"); 
const coinXuSeed = document.getElementById("coin-xu-seed"); 
const coinUSDSeed = document.getElementById("coin-usd-seed"); 
const seedItemsContainer = document.getElementById("seed-items"); 
const onlineBox = document.getElementById("online-box");
const shopItemsContainer = document.getElementById("shop-items"); 
const headerPetMay = document.getElementById("header-pet-may"); 
const headerHatMay = document.getElementById("header-hat-may");
const petMayItemsContainer = document.getElementById("pet-may-items"); 
const hatMayItemsContainer = document.getElementById("hat-may-items"); 
const petHouseBox = document.getElementById("pet-house-box");
const petHouseTitle = document.getElementById("pet-house-title"); 
const petShopItemsContainer = document.getElementById("pet-shop-items"); 
const interactionPopup = document.getElementById("interaction-popup"); 
const interactionTitle = document.getElementById("interaction-title"); 
const interactionText = document.getElementById("interaction-text"); 
const interactionControls = document.getElementById("interaction-controls"); 
const pugPetImg = document.getElementById("pug-pet"); 
const iceEggImg = document.getElementById("ice-egg-img"); 

function expNeeded(lv){ return lv * 100; }

function checkLevelUp() {
    let leveledUp = false;
    while (level > 0 && exp >= expNeeded(level)) {
        exp -= expNeeded(level);
        level += 1;
        leveledUp = true;
    }
    if (leveledUp) { updateDisplay(); updateControlButtons(); }
}

function updateControlButtons(){
    const gameCreated = level > 0;
    btnNew.disabled = gameCreated;
    btnDelete.disabled = !gameCreated;
    btnSave.disabled = !gameCreated;
    
    if (playerLevelDisplay) playerLevelDisplay.innerHTML = gameCreated ? `${playerName} | Lv.${level}` : `ğŸŒ¾ Farm LOL ğŸŒ¾`;
    if (expBarContainer) expBarContainer.style.display = gameCreated ? 'block' : 'none';
}

function isPetOwned(petValue) { return ownedPets.includes(petValue); }

function activatePet(petValue) {
    const iceDragonData = shopItems.find(i => i.name === "Rá»“ng BÄƒng Tuyáº¿t");
    const iceDragonBigData = shopItems.find(i => i.name === "Rá»“ng BÄƒng Tuyáº¿t Big");
    if((iceDragonData && petValue === iceDragonData.value) || (iceDragonBigData && petValue === iceDragonBigData.value)) {
        alert("Rá»“ng BÄƒng Tuyáº¿t khÃ´ng thá»ƒ lÃ m Pet chÃ­nh. NÃ³ sáº½ á»Ÿ láº¡i Ã” sá»‘ 1 Ä‘á»ƒ báº£o vá»‡ nÃ´ng tráº¡i!");
        return;
    }
    activePet = petValue; updateDisplay(); alert(`ÄÃ£ kÃ­ch hoáº¡t Pet má»›i!`);
}

function updateDisplay(){
  if(level > 0 && expFill){
      const needed = expNeeded(level);
      const percent = Math.min(100, (exp / needed) * 100);
      expFill.style.width = percent + "%";
  }

  const xuStr = xu.toLocaleString('vi-VN');
  const usdStr = usd.toLocaleString('vi-VN');

  if (coinXuShop) coinXuShop.textContent = xuStr;
  if (coinUSDShop) coinUSDShop.textContent = usdStr;
  if (coinXuPet) coinXuPet.textContent = xuStr;
  if (coinUSDPet) coinUSDPet.textContent = usdStr;
  if (coinXuSeed) coinXuSeed.textContent = xuStr;
  if (coinUSDSeed) coinUSDSeed.textContent = usdStr;
  
  const iceDragonData = shopItems.find(i => i.name === "Rá»“ng BÄƒng Tuyáº¿t");
  const iceDragonBigData = shopItems.find(i => i.name === "Rá»“ng BÄƒng Tuyáº¿t Big"); 
  
  if (iceEggImg) {
      if (isIceDragonEvolved && iceDragonBigData) { 
          iceEggImg.src = iceDragonBigData.icon; iceEggImg.alt = iceDragonBigData.name; iceEggImg.style.display = 'block'; 
      } else if (isIceDragonHatched && iceDragonData) {
          iceEggImg.src = iceDragonData.icon; iceEggImg.alt = iceDragonData.name; iceEggImg.style.display = 'block'; 
      } else if (hasIceEgg) {
          iceEggImg.src = "1000000102.png"; iceEggImg.alt = "Trá»©ng BÄƒng Tuyáº¿t"; iceEggImg.style.display = 'block'; 
      } else {
          iceEggImg.src = ""; iceEggImg.alt = ""; iceEggImg.style.display = 'none'; 
      }
  }
  
  if (pugPetImg) {
      if (activePet && !(iceDragonData && activePet === iceDragonData.value) && !(iceDragonBigData && activePet === iceDragonBigData.value)) { 
          pugPetImg.src = activePet;
          pugPetImg.style.display = 'block'; 
          let petData = petShopItems.find(p => p.value === activePet);
          if (!petData) petData = shopItems.find(p => p.value === activePet);
          
          if (petData && petData.position) {
              pugPetImg.style.bottom = petData.position.bottom;
              pugPetImg.style.left = petData.position.left;
              pugPetImg.style.transform = 'none'; 
          } else {
              pugPetImg.style.bottom = '50px';
              pugPetImg.style.left = '50%';
              pugPetImg.style.transform = 'translateX(calc(-50% - 50px))';
          }
      } else {
          pugPetImg.src = "";
          pugPetImg.style.display = 'none';
      }
  }

  // --- LOGIC HIá»‚N THá»Š Má»šI CHO 5 Ã” Äáº¤T (Cáº¬P NHáº¬T áº¢NH THEO Tá»ªNG LOáº I CÃ‚Y) ---
  FARM_IDS.forEach((slotId, index) => {
      const seedImg = document.getElementById(`seed-img-${slotId}`);
      const baseImg = document.querySelector(`#slot-${slotId} .pot-base-img`);
      
      if(seedImg && baseImg) {
          const slotData = farmSlots[index];
          if(slotData) {
              // Máº·c Ä‘á»‹nh láº¥y icon theo giai Ä‘oáº¡n (Máº§m -> CÃ¢y Xanh -> CÃ¢y Xanh)
              let currentStage = PLANT_STAGES[slotData.stage];
              let useIcon = currentStage.icon; 

              // --- LOGIC TÃ™Y CHá»ˆNH áº¢NH CHO Tá»ªNG LOáº I Háº T ---
              // Náº¿u giai Ä‘oáº¡n lÃ  1 (TrÆ°á»Ÿng thÃ nh) hoáº·c 2 (Thu hoáº¡ch) thÃ¬ hiá»ƒn thá»‹ áº£nh riÃªng cá»§a cÃ¢y Ä‘Ã³
              if (slotData.stage >= 1) {
                  if (slotData.value === 'hat_kim_loai') {
                      useIcon = "1000000124.png"; // áº¢nh CÃ¢y Kim Loáº¡i
                  } 
                  // VÃ­ dá»¥: Náº¿u sau nÃ y báº¡n cÃ³ áº£nh riÃªng cho Tinh Háº¡t SÆ°Æ¡ng
                  else if (slotData.value === 'tinh_hat_suong') {
                      useIcon = "1000000125.png"; // Hiá»‡n táº¡i váº«n dÃ¹ng cÃ¢y xanh máº·c Ä‘á»‹nh
                  }
              }
              // -------------------------------------

              seedImg.src = useIcon;
              seedImg.alt = slotData.name;
              seedImg.style.display = 'block';
              baseImg.style.opacity = '1';
          } else {
              seedImg.style.display = 'none';
              seedImg.src = "";
              baseImg.style.opacity = '1';
          }
      }
  });
}

function updateShop(){
  if(!petMayItemsContainer || !hatMayItemsContainer) return;
  petMayItemsContainer.style.gridTemplateColumns = "1fr 1fr 1fr";
  hatMayItemsContainer.style.gridTemplateColumns = "1fr 1fr 1fr";
  petMayItemsContainer.innerHTML = "";
  hatMayItemsContainer.innerHTML = "";
  const petMayItems = shopItems.filter(item => item.category === "pet_may");
  const hatMayItems = shopItems.filter(item => item.category === "hat_may");
  
  function createShopItemHTML(item) {
    if (item.type === "pet" && (item.name === "Rá»“ng BÄƒng Tuyáº¿t" || item.name === "Rá»“ng BÄƒng Tuyáº¿t Big")) return ''; 
    if (item.type === "seed" && item.price === 0) return '';
    let buttonHTML = `<button class="btn-buy" data-id="${item.id}" data-type="general" style="padding:3px 8px; font-size:0.75em; border:none; border-radius:4px; background:var(--accent); color:white; cursor:pointer;">Mua</button>`;
    
    if (item.value === "trung_bang_tuyet" && (hasIceEgg || isIceDragonHatched || isIceDragonEvolved)) { 
        buttonHTML = `<button disabled style="padding:3px 6px; font-size:0.7em; border:none; border-radius:4px; background:#4CAF50; color:white; cursor:default;">ÄÃ£ CÃ³</button>`;
    }

    const currencyIcon = item.currency === "xu" ? 'ğŸª™' : 'ğŸ’¸';
    const currencyColor = item.currency === "xu" ? 'gold' : 'green';
    return `
      <div class="shop-item" style="border:1px solid var(--muted); border-radius:6px; padding:6px; text-align:center; background: rgba(255,255,255,0.5);">
        <img src="${item.icon}" alt="${item.name}" style="width:40px; height:40px; object-fit:contain; margin-bottom:2px;" />
        <div style="font-weight:600; font-size:0.75em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</div>
        <div style="font-size:0.75em; margin:2px 0 5px 0;">
          <span style="color:${currencyColor};">${currencyIcon}</span> ${item.price.toLocaleString('vi-VN')}
        </div>
        ${buttonHTML}
      </div>
    `;
  }
  
  petMayItems.forEach(item => { petMayItemsContainer.insertAdjacentHTML('beforeend', createShopItemHTML(item)); });
  hatMayItems.forEach(item => { hatMayItemsContainer.insertAdjacentHTML('beforeend', createShopItemHTML(item)); });
  
  document.querySelectorAll(".btn-buy[data-type='general']").forEach(btn => { btn.addEventListener("click", handleBuy); });
  updateDisplay();
}

function updatePetShop() {
    if (!petShopItemsContainer) return;
    petShopItemsContainer.innerHTML = "";
    const allPets = petShopItems;
    allPets.forEach(item => {
        const owned = isPetOwned(item.value); 
        const isActive = item.value === activePet; 
        const itemDiv = document.createElement("div");
        itemDiv.className = "pet-shop-item";
        itemDiv.setAttribute("data-id", item.id);
        const currencyIcon = item.currency === "usd" ? 'ğŸ’¸' : 'ğŸª™';
        const currencyColor = item.currency === "usd" ? 'green' : 'gold';
        const currencyDisplay = `<span style="font-size:0.75em; color:${currencyColor};">${currencyIcon}</span> ${item.price.toLocaleString('vi-VN')}`; 
        
        let buttonHTML = '';
        if (!owned) buttonHTML = `<button class="btn-buy-pet" data-id="${item.id}" data-type="pet-shop-internal" style="padding:3px 8px; font-size:0.75em; border:none; border-radius:4px; background:var(--accent); color:white; cursor:pointer; margin-top: 3px;">Mua</button>`;
        else if (isActive) buttonHTML = `<button disabled style="padding:3px 6px; font-size:0.7em; border:none; border-radius:4px; background:#4CAF50; color:white; cursor:default; margin-top: 3px;">Äang DÃ¹ng</button>`;
        else buttonHTML = `<button class="btn-activate-pet" data-value="${item.value}" style="padding:3px 8px; font-size:0.75em; border:none; border-radius:4px; background:#2196F3; color:pointer; color:white; cursor:pointer; margin-top: 3px;">KÃ­ch Hoáº¡t</button>`;

        itemDiv.innerHTML = `
            <img src="${item.icon}" alt="${item.name} icon" />
            <div style="font-weight:600; font-size:0.8em; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</div>
            <div style="font-size:0.8em; color:var(--muted);">${currencyDisplay}</div>
            ${buttonHTML}
        `;
        petShopItemsContainer.appendChild(itemDiv);
    });
    document.querySelectorAll(".btn-buy-pet[data-type='pet-shop-internal']").forEach(btn => { btn.addEventListener("click", handleBuy); });
    document.querySelectorAll(".btn-activate-pet").forEach(btn => {
        btn.addEventListener("click", (e) => { activatePet(e.target.getAttribute("data-value")); updatePetShop(); });
    });
    updateDisplay();
}

function updateSeedShop() {
    if (!seedItemsContainer) return;
    seedItemsContainer.innerHTML = "";
    const seedShopMap = new Map();
    // ÄÃ£ sá»­a Ä‘á»ƒ láº¥y táº¥t cáº£ item loáº¡i 'seed' (Háº¡t NguyÃªn Tá»‘ + Háº¡t Kim Loáº¡i)
    shopItems.filter(item => item.type === 'seed').forEach(item => seedShopMap.set(item.value, item));
    const ownedSeedValues = Object.keys(ownedSeeds).filter(key => seedShopMap.has(key));

    if(ownedSeedValues.length === 0 || Object.values(ownedSeeds).every(v => v === 0)) {
        seedItemsContainer.innerHTML = `<div style="text-align: center; color: var(--muted); margin: 20px 0;">Kho háº¡t giá»‘ng trá»‘ng.</div>`;
    }
    ownedSeedValues.forEach(seedValue => {
        const item = seedShopMap.get(seedValue);
        const ownedAmount = ownedSeeds[seedValue] || 0;
        if(ownedAmount === 0) return;
        const itemDiv = document.createElement("div");
        itemDiv.className = "shop-item";
        const ownedDisplay = `<div style="font-size:0.8em; color:var(--muted);">ÄÃ£ cÃ³: **${ownedAmount.toLocaleString('vi-VN')}**</div>`;
        
        let buttonHTML = '';
        if (item.price > 0) {
            const currencyIcon = item.currency === "xu" ? 'ğŸª™' : 'ğŸ’¸';
            const currencyColor = item.currency === "xu" ? 'gold' : 'green';
            const priceDisplay = `<span style="font-size:1.1em; color:${currencyColor};">${currencyIcon}</span>: ${item.price.toLocaleString('vi-VN')} ${item.currency === "xu" ? 'Xu' : 'ÄÃ´'}`;
            buttonHTML = `
                <div style="text-align: right;">
                    <div style="font-size:0.9em; margin-bottom: 5px;">${priceDisplay}</div>
                    <button class="btn-buy" data-id="${item.id}" data-type="seed-shop-internal" style="padding:5px 10px; border:none; border-radius:5px; background:var(--accent); color:white; cursor:pointer;">Mua</button>
                </div>
            `;
        }
        itemDiv.innerHTML = `<img src="${item.icon}" alt="${item.name}" /><div><div style="font-weight:600; text-align: left;">${item.name}</div>${ownedDisplay}</div>${buttonHTML}`;
        seedItemsContainer.appendChild(itemDiv);
    });
    document.querySelectorAll(".btn-buy[data-type='seed-shop-internal']").forEach(btn => { btn.addEventListener("click", handleBuy); });
    updateDisplay();
}

function handleBuy(event) {
  const itemId = parseInt(event.target.getAttribute("data-id"));
  const itemType = event.target.getAttribute("data-type");
  let item = null;
  // TÃ¬m item tá»« shopItems (dÃ nh cho Cloud Shop)
  if (itemType === "general") item = shopItems.find(i => i.id === itemId);
  // TÃ¬m item tá»« petShopItems (dÃ nh cho Pet House)
  if (!item && itemType === "pet-shop-internal") item = petShopItems.find(i => i.id === itemId);
  // TÃ¬m item tá»« shopItems (dÃ nh cho Seed Shop ná»™i bá»™)
  if (!item && itemType === "seed-shop-internal") {
      item = shopItems.find(i => i.id === itemId && i.type === 'seed');
  }
  if (!item) return;
  
  if (item.type === "item" && item.value === "trung_bang_tuyet" && (hasIceEgg || isIceDragonHatched || isIceDragonEvolved)) {
      alert(`${item.name} Ä‘Ã£ Ä‘Æ°á»£c sá»Ÿ há»¯u!`); 
      return; 
  }
  
  if (item.type === "pet" && isPetOwned(item.value)) { alert(`${item.name} Ä‘Ã£ Ä‘Æ°á»£c sá»Ÿ há»¯u!`); return; }

  let canBuy = false;
  if (item.currency === "xu" && xu >= item.price) { xu -= item.price; canBuy = true; } 
  else if (item.currency === "usd" && usd >= item.price) { usd -= item.price; canBuy = true; }

  if (canBuy) {
    if (item.type === "tool") { tool = item.value; alert(`Báº¡n Ä‘Ã£ trang bá»‹ ${item.name}!`); } 
    else if (item.type === "pet") { 
        ownedPets.push(item.value); activePet = item.value;
        alert(`Báº¡n Ä‘Ã£ mua Pet ${item.name}! Pet Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t!`);
        if(itemType === "general") shopBox.style.display = 'none';
    } else if (item.type === "item") { 
        if (item.value === "trung_bang_tuyet") { hasIceEgg = true; alert(`Báº¡n Ä‘Ã£ mua thÃ nh cÃ´ng ${item.name}!.`); } 
        else { alert(`Báº¡n Ä‘Ã£ mua thÃ nh cÃ´ng ${item.name}!`); }
    } else if (item.type === "seed") { 
        if (ownedSeeds[item.value] !== undefined) ownedSeeds[item.value] += 1;
        else ownedSeeds[item.value] = 1;
        alert(`Báº¡n Ä‘Ã£ mua 1x ${item.name}! ÄÃ£ cÃ³ ${ownedSeeds[item.value].toLocaleString('vi-VN')} háº¡t.`);
    }
    updateDisplay(); updateShop(); updatePetShop(); updateSeedShop(); updateControlButtons();
  } else { alert("KhÃ´ng Ä‘á»§ tiá»n!"); }
}

function handleNewGame(){
    nameBox.style.display = 'block';
    shopBox.style.display = 'none';
    onlineBox.style.display = 'none';
    petHouseBox.style.display = 'none'; 
    interactionPopup.style.display = 'none'; 
    seedBox.style.display = 'none'; 
}
btnNew.addEventListener('click', handleNewGame);

btnNext.addEventListener('click', () => {
    let inputName = nameInput.value.trim();
    
    const nameRegex = new RegExp(/^[\p{L}\p{N}]{2,12}$/u); 
    
    if (inputName.length < 2 || inputName.length > 12) {
        alert("TÃªn ngÆ°á»i chÆ¡i pháº£i tá»« 2 Ä‘áº¿n 12 kÃ½ tá»±!");
        return;
    }
    
    if (!nameRegex.test(inputName)) {
        alert("TÃªn chá»‰ Ä‘Æ°á»£c chá»©a chá»¯ cÃ¡i vÃ  sá»‘. KhÃ´ng Ä‘Æ°á»£c dÃ¹ng icon hay kÃ½ tá»± Ä‘áº·c biá»‡t!");
        return;
    }
    
    playerName = inputName;
    nameBox.style.display = 'none';
    farmIcon = "ğŸ "; 
    level = 1; exp = 0; xu = 10000; usd = 1000; activePet = null;
    ownedPets = []; hasIceEgg = false; isIceDragonHatched = false; isIceDragonEvolved = false; 
    ownedSeeds = { 'tinh_hat_suong': 5, 'hat_kim_loai': 0 }; // Reset háº¡t
    lastFedTime = 0; 
    farmSlots = Array(5).fill(null); 
    globalPetAge = 0; 
    alert(`ChÃ o má»«ng ${playerName} Ä‘áº¿n vá»›i Farm LOL!`);
    updateDisplay(); updateControlButtons();
});

function loadGame(){
    const savedGame = localStorage.getItem('farmLolGame');
    if(savedGame){
        const gameData = JSON.parse(savedGame);
        playerName = gameData.playerName; farmIcon = gameData.farmIcon; level = gameData.level; exp = gameData.exp;
        xu = gameData.xu; usd = gameData.usd; tool = gameData.tool;
        farmSlots = gameData.farmSlots ? (Array.isArray(gameData.farmSlots) ? gameData.farmSlots : Array(5).fill(null)) : Array(5).fill(null);
        if (farmSlots.length < 5) { while(farmSlots.length < 5) farmSlots.push(null); }

        activePet = gameData.activePet || null; ownedPets = gameData.ownedPets || []; 
        hasIceEgg = gameData.hasIceEgg || false; isIceDragonHatched = gameData.isIceDragonHatched || false; isIceDragonEvolved = gameData.isIceDragonEvolved || false;
        const savedSeeds = gameData.ownedSeeds || {};
        // Náº¡p háº¡t Ä‘Ã£ lÆ°u, náº¿u khÃ´ng cÃ³ thÃ¬ gÃ¡n 0
        ownedSeeds = { 
            'tinh_hat_suong': savedSeeds['tinh_hat_suong'] || 0,
            'hat_kim_loai': savedSeeds['hat_kim_loai'] || 0 
        };
        lastFedTime = gameData.lastFedTime || 0;
        globalPetAge = gameData.globalPetAge || 0;
    }
}

function _saveGame(showAlert = false){
    const gameData = { playerName, farmIcon, level, exp, xu, usd, tool, farmSlots, activePet, ownedPets, hasIceEgg, isIceDragonHatched, isIceDragonEvolved, ownedSeeds, lastFedTime, globalPetAge }; 
    localStorage.setItem('farmLolGame', JSON.stringify(gameData));
    if(showAlert) alert("ÄÃ£ lÆ°u trÃ² chÆ¡i!");
}
function saveGame(){ _saveGame(true); }
btnSave.addEventListener('click', saveGame);
function autoSave() { if (level > 0) { _saveGame(false); } }

function deleteGame(){
    if(confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a nÃ´ng tráº¡i hiá»‡n táº¡i?")){
        localStorage.removeItem('farmLolGame');
        playerName = "NÃ´ng dÃ¢n"; farmIcon = "ğŸŒ¾"; level = 0; exp = 0; usd = 0;
        tool = { name: "Xáº»ng Gá»—", power: 1, maxHP: 100, currentHP: 100 };
        farmSlots = Array(5).fill(null); 
        activePet = null; ownedPets = []; 
        hasIceEgg = false; isIceDragonHatched = false; isIceDragonEvolved = false; 
        ownedSeeds = { 'tinh_hat_suong': 0, 'hat_kim_loai': 0 };
        lastFedTime = 0; globalPetAge = 0; 
        alert("ÄÃ£ xÃ³a nÃ´ng tráº¡i!");
        updateDisplay(); updateControlButtons();
    }
}
btnDelete.addEventListener('click', deleteGame);

function initializeShopLogic() {
    const collapsibleHeaders = document.querySelectorAll(".shop-collapsible-header");
    collapsibleHeaders.forEach(header => {
        header.addEventListener("click", function() {
            const targetId = this.getAttribute("data-target");
            const targetContainer = document.getElementById(targetId);
            if (targetContainer) targetContainer.classList.toggle('shop-items-visible');
        });
    });
}

const kintoCloud = document.getElementById("kinto-cloud");
if (kintoCloud) {
    kintoCloud.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c! Vui lÃ²ng nháº¥n nÃºt 'ğŸ†• Táº¡o' á»Ÿ trÃªn."); return; }
        updateShop(); shopBox.style.display = 'block';
    });
}
if (lightBulb) {
    lightBulb.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c! Vui lÃ²ng nháº¥n nÃºt 'ğŸ†• Táº¡o' á»Ÿ trÃªn."); return; }
        body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', body.classList.contains('dark-mode'));
    });
}

function closeInteractionPopup() {
    if (activePopupInterval) { 
        clearInterval(activePopupInterval); 
        activePopupInterval = null; 
    }
    if (window.feedInterval) {
        clearInterval(window.feedInterval);
        window.feedInterval = null;
    }
    document.getElementById('interaction-popup').style.display = 'none';
    const iText = document.getElementById('interaction-text');
    const iControls = document.getElementById('interaction-controls');
    if(iText) { iText.style.display = 'block'; iText.innerHTML = ''; }
    if(iControls) { iControls.style.marginTop = '10px'; iControls.innerHTML = ''; }
}

function handleIceDragonInteraction(action) {
    const requiredXu = action === 'hatch' ? 1000 : 5000;
    const actionText = action === 'hatch' ? 'áº¥p ná»Ÿ' : 'tiáº¿n hÃ³a';
    if (xu >= requiredXu) {
        if(confirm(`Báº¡n cÃ³ cháº¯c muá»‘n ${actionText} vá»›i giÃ¡ ${requiredXu.toLocaleString('vi-VN')} Xu?`)) {
            xu -= requiredXu;
            if (action === 'hatch') {
                hasIceEgg = false; isIceDragonHatched = true;
                const iceDragonData = shopItems.find(i => i.name === "Rá»“ng BÄƒng Tuyáº¿t");
                if(!isPetOwned(iceDragonData.value)) ownedPets.push(iceDragonData.value);
                interactionTitle.innerHTML = `ğŸ‰ ChÃºc Má»«ng!`;
                interactionText.innerHTML = `Trá»©ng BÄƒng Tuyáº¿t Ä‘Ã£ ná»Ÿ ra má»™t chÃº Rá»“ng BÄƒng Tuyáº¿t Mini!`;
            } else if (action === 'evolve') {
                isIceDragonEvolved = true;
                const iceDragonBigData = shopItems.find(i => i.name === "Rá»“ng BÄƒng Tuyáº¿t Big");
                if(!isPetOwned(iceDragonBigData.value)) ownedPets.push(iceDragonBigData.value);
                const iceDragonData = shopItems.find(i => i.name === "Rá»“ng BÄƒng Tuyáº¿t");
                ownedPets = ownedPets.filter(v => v !== iceDragonData.value);
                if(activePet === iceDragonData.value) activePet = iceDragonBigData.value;
                interactionTitle.innerHTML = `âœ¨ TIáº¾N HÃ“A THÃ€NH CÃ”NG!`;
                interactionText.innerHTML = `Rá»“ng BÄƒng Tuyáº¿t Ä‘Ã£ tiáº¿n hÃ³a thÃ nh Rá»“ng BÄƒng Tuyáº¿t Big máº¡nh máº½ hÆ¡n!`;
            }
            updateDisplay(); interactionControls.innerHTML = ''; 
        }
    } else {
        interactionTitle.innerHTML = action === 'hatch' ? `Trá»©ng BÄƒng Tuyáº¿t` : `Tiáº¿n HÃ³a Rá»“ng`;
        interactionText.innerHTML = `Báº¡n khÃ´ng Ä‘á»§ Xu Ä‘á»ƒ ${actionText}! Cáº§n **${requiredXu.toLocaleString('vi-VN')} Xu** Ä‘á»ƒ tiáº¿p tá»¥c.`;
        interactionControls.innerHTML = '';
    }
}

function showSeedSelectionPopup(slotNum, slotIndex) {
    const seedMap = new Map();
    // Lá»c táº¥t cáº£ cÃ¡c loáº¡i háº¡t (type = seed)
    shopItems.filter(item => item.type === 'seed').forEach(item => seedMap.set(item.value, item));
    interactionTitle.innerHTML = `ğŸŒ± Chá»n háº¡t giá»‘ng`; 
    interactionText.innerHTML = ``; interactionText.style.display = 'none'; interactionControls.style.marginTop = '0px';
    interactionControls.innerHTML = '';

    let seedFound = false;
    const seedContainer = document.createElement('div');
    seedContainer.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 0px;'; 
    interactionControls.appendChild(seedContainer); 

    seedMap.forEach((seedData, seedValue) => {
        const amount = ownedSeeds[seedValue] || 0;
        if (amount > 0 && seedData) {
            seedFound = true;
            const btnPlant = document.createElement('button');
            btnPlant.innerHTML = `
                <img src="${seedData.icon}" alt="${seedData.name}" title="${seedData.name}" style="width: 30px; height: 30px; display: block; margin: 0 auto 3px;" />
                <div style="font-size: 0.75em; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${seedData.name}</div>
                <div style="font-size: 0.7em; color: var(--muted); margin-top: 2px;">x${amount.toLocaleString('vi-VN')}</div>
            `; 
            btnPlant.style.cssText = 'padding: 8px 5px; border: 1px solid #ccc; border-radius: 6px; background: #fff; color: black; cursor: pointer; text-align: center; font-size: 0.9em;';
            btnPlant.onclick = () => {
                ownedSeeds[seedValue] -= 1;
                // Náº¿u trá»“ng háº¡t kim loáº¡i, value sáº½ lÃ  'hat_kim_loai', dÃ¹ng icon chung cá»§a Stage 0
                farmSlots[slotIndex] = { name: seedData.name, icon: PLANT_STAGES[0].icon, value: seedValue, stage: 0, plantedAt: Date.now() };
                updateDisplay(); updateSeedShop(); closeInteractionPopup();
            };
            seedContainer.appendChild(btnPlant);
        }
    });

    if (!seedFound) {
         interactionText.style.display = 'block'; 
         interactionText.innerHTML = `<div style="text-align: center; margin: 15px 0;">Báº¡n khÃ´ng cÃ³ háº¡t giá»‘ng nÃ o Ä‘á»ƒ trá»“ng! Vui lÃ²ng mua thÃªm háº¡t giá»‘ng.</div>`;
         interactionControls.removeChild(seedContainer); 
    }
    interactionPopup.style.display = 'block';
}

function updateFarmState() {
    const now = Date.now();
    let changed = false; 
    farmSlots.forEach((slotData, index) => {
        if (slotData && slotData.stage < PLANT_STAGES.length - 1) { 
            const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
            if (now >= slotData.plantedAt + nextStageInfo.duration) { slotData.stage += 1; changed = true; }
        }
    });
    if (changed) updateDisplay();
}

function getCountdownTimePlant(timeToNext) {
    if (timeToNext <= 0) return "00:00";
    const secondsToNext = Math.max(0, Math.ceil(timeToNext / 1000));
    const m = Math.floor(secondsToNext / 60).toString().padStart(2, '0');
    const s = (secondsToNext % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
}

const potSlots = document.querySelectorAll(".pot-slot");
potSlots.forEach(slot => {
    slot.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c! Vui lÃ²ng nháº¥n nÃºt 'ğŸ†• Táº¡o' á»Ÿ trÃªn."); return; }
        interactionText.style.display = 'block';
        interactionControls.style.marginTop = '10px';
        if (activePopupInterval) clearInterval(activePopupInterval);

        const slotNum = slot.getAttribute('data-slot');
        const slotNumInt = parseInt(slotNum);

        const renderSlotStatus = () => {
            interactionControls.innerHTML = '';
            let popupTitle = `ğŸŒ± Trá»“ng trá»t`; 
            
            if (slotNum === "1") {
                let petTitle = `ğŸ¾ Ã” Pet MÃ¢y`;
                let petRarityClass = '';
                let petStars = '';
                let description = '';

                if (isIceDragonEvolved) {
                    petTitle = `Rá»“ng BÄƒng Tuyáº¿t Big`;
                    petRarityClass = 'pet-rarity-blue';
                    petStars = 'â­â­â­';
                    description = `
                        <span style="color: #FF9800; font-weight: bold;">âš¡ HIá»†U á»¨NG KÃCH HOáº T:</span><br>
                        1. x2 Exp khi thu hoáº¡ch.<br>
                        2. Auto thu hoáº¡ch.
                    `;
                } else if (isIceDragonHatched) {
                    petTitle = `Rá»“ng BÄƒng Tuyáº¿t Mini`;
                    petRarityClass = 'pet-rarity-green';
                    petStars = 'â­â­';
                    const requiredXu = 5000; const canEvolve = xu >= requiredXu;
                    description = `<span style="color: #FF9800; font-weight: bold;">âš¡ HIá»†U á»¨NG KÃCH HOáº T:</span><br>
                        1. x2 Exp khi thu hoáº¡ch.
                    `;
                    const btnEvolve = document.createElement('button');
                    btnEvolve.textContent = `ğŸ†™ Tiáº¿n hÃ³a (${requiredXu.toLocaleString('vi-VN')} Xu)`;
                    btnEvolve.style.cssText = `padding: 8px 15px; border: none; border-radius: 5px; margin-top: 10px; color: white; cursor: ${canEvolve ? 'pointer' : 'default'}; background: ${canEvolve ? '#8B008B' : 'grey'};`;
                    btnEvolve.disabled = !canEvolve;
                    btnEvolve.onclick = () => handleIceDragonInteraction('evolve'); 
                    interactionControls.appendChild(btnEvolve);
                } else if (hasIceEgg) {
                    petTitle = `Trá»©ng BÄƒng Tuyáº¿t`;
                    petRarityClass = 'pet-rarity-white';
                    petStars = 'â­';
                    const requiredXu = 1000; const canHatch = xu >= requiredXu;
                    description = `ThuÃª ğŸ¦¢ áº¥p trá»©ng ngay Ä‘á»ƒ nháº­n Rá»“ng con!`;
                    
                    const btnHatch = document.createElement('button');
                    btnHatch.textContent = `áº¤p ná»Ÿ (${requiredXu.toLocaleString('vi-VN')} Xu)`;
                    btnHatch.style.cssText = `padding: 8px 15px; border: none; border-radius: 5px; margin-top: 10px; color: white; cursor: ${canHatch ? 'pointer' : 'default'}; background: ${canHatch ? 'orange' : 'grey'};`;
                    btnHatch.disabled = !canHatch;
                    btnHatch.onclick = () => handleIceDragonInteraction('hatch'); 
                    interactionControls.appendChild(btnHatch);
                } else { 
                    petTitle = `ğŸ¾ Ã” Pet MÃ¢y`;
                    description = `Báº¡n Ä‘Ã£ kiá»ƒm tra.<br>ChÆ°a cÃ³ pet nÃ o á»Ÿ Ä‘Ã¢y!.`; 
                }

                if (petRarityClass) {
                    interactionTitle.innerHTML = `<span class="${petRarityClass}" style="display:block; text-align:center;">${petTitle}</span>`;
                    interactionTitle.innerHTML += `<span class="pet-rarity-stars">${petStars}</span>`;
                } else {
                    interactionTitle.innerHTML = petTitle;
                }
                
                interactionText.innerHTML = description;
            } 
            else if (FARM_IDS.includes(slotNumInt)) {
                 if (interactionTitle) interactionTitle.innerHTML = popupTitle; 
                 const slotIndex = FARM_IDS.indexOf(slotNumInt); 
                 const slotData = farmSlots[slotIndex];
                 const isFree = slotData === null; 
                 
                 if (isFree) {
                     if(activePopupInterval) clearInterval(activePopupInterval);
                     const totalOwnedSeeds = Object.values(ownedSeeds).reduce((sum, current) => sum + current, 0);
                     if (totalOwnedSeeds > 0) { showSeedSelectionPopup(slotNum, slotIndex); return; } 
                     else { interactionText.innerHTML = `Ã” Ä‘ang trá»‘ng.<br>Báº¡n khÃ´ng cÃ³ háº¡t giá»‘ng nÃ o Ä‘á»ƒ trá»“ng! Vui lÃ²ng mua thÃªm háº¡t giá»‘ng.`; }
                 } else {
                     updateFarmState(); 
                     const currentStage = PLANT_STAGES[slotData.stage];
                     const isReadyForHarvest = slotData.stage === PLANT_STAGES.length - 1;
                     let statusMessage = `Báº¡n Ä‘Ã£ trá»“ng <b>${slotData.name}</b>.<br>`;
                     
                     if (isReadyForHarvest) { 
                         if(activePopupInterval) clearInterval(activePopupInterval);
                         statusMessage += `<br><span style="color:#4caf50; font-weight:bold; font-size:1.1em;">âœ¨ Sáº´N SÃ€NG THU HOáº CH!</span>`; 
                     } else {
                         const nextStageInfo = PLANT_STAGES[slotData.stage + 1];
                         const timeToNext = (slotData.plantedAt + nextStageInfo.duration) - Date.now();
                         
                         statusMessage += `Tráº¡ng thÃ¡i: ${currentStage.name}.<br>`;
                         statusMessage += `<div style="margin-top:8px; font-size:1.1em;">â³ CÃ²n láº¡i: <b id="plant-timer" style="color:#d32f2f; font-family:monospace;">${getCountdownTimePlant(timeToNext)}</b></div>`;
                         statusMessage += `<div style="font-size:0.8em; color:#666;">(Tá»± Ä‘á»™ng lá»›n khi háº¿t giá»)</div>`;
                         
                         if(interactionPopup.style.display === 'block') { 
                             if (activePopupInterval) clearInterval(activePopupInterval);
                             activePopupInterval = setInterval(() => {
                                 const timerEl = document.getElementById("plant-timer");
                                 if (timerEl) {
                                     const newTimeToNext = (slotData.plantedAt + nextStageInfo.duration) - Date.now();
                                     if (newTimeToNext <= 0) {
                                         clearInterval(activePopupInterval);
                                         activePopupInterval = null;
                                         renderSlotStatus(); 
                                     } else {
                                         timerEl.textContent = getCountdownTimePlant(newTimeToNext);
                                     }
                                 } else {
                                      clearInterval(activePopupInterval); 
                                      activePopupInterval = null;
                                 }
                             }, 1000);
                         }
                     }
                     interactionText.innerHTML = statusMessage;
                     
                     if (isReadyForHarvest) {
                         const btnHarvest = document.createElement('button');
                         
                         if (isIceDragonEvolved) {
                             btnHarvest.innerHTML = `ğŸŒ¬ï¸ Thu Hoáº¡ch Táº¥t Cáº£ (Auto)`;
                             btnHarvest.style.cssText = 'padding: 10px 20px; border: none; border-radius: 5px; background: linear-gradient(45deg, #2196F3, #00BCD4); color: white; cursor: pointer; font-weight:bold; font-size:1em; box-shadow: 0 0 10px #00BCD4; animation: pulse 1s infinite;';
                             
                             btnHarvest.onclick = () => {
                                 let totalExpReceived = 0;
                                 let hasHarvested = false;

                                 farmSlots.forEach((sData, sIdx) => {
                                     if (sData && sData.stage === PLANT_STAGES.length - 1) {
                                         const hSeedValue = sData.value;
                                         const hReturnAmount = 2;
                                         const hExp = 20; 
                                         
                                         exp += hExp;
                                         totalExpReceived += hExp;
                                         
                                         if (ownedSeeds[hSeedValue] !== undefined) ownedSeeds[hSeedValue] += hReturnAmount;
                                         else ownedSeeds[hSeedValue] = hReturnAmount;

                                         farmSlots[sIdx] = null;
                                         hasHarvested = true;
                                     }
                                 });

                                 if (hasHarvested) {
                                     alert(`ğŸ² Rá»“ng BÄƒng Ä‘Ã£ giÃºp báº¡n thu hoáº¡ch cáº£ vÆ°á»n!\n\nTá»•ng nháº­n: ${totalExpReceived} EXP!`);
                                     closeInteractionPopup(); 
                                     updateDisplay(); 
                                     checkLevelUp(); 
                                     updateSeedShop();
                                 }
                             };
                         } else {
                             const harvestedSeedValue = slotData.value; const returnAmount = 2; 
                             let finalExp = 10; 
                             if (isIceDragonHatched) finalExp = 20; 
                             
                             btnHarvest.textContent = `ğŸŒ¾ Thu hoáº¡ch (${returnAmount} Háº¡t + ${finalExp} Exp)`;
                             btnHarvest.style.cssText = 'padding: 10px 20px; border: none; border-radius: 5px; background: #FF9800; color: white; cursor: pointer; font-weight:bold; font-size:1em; animation: pulse 1s infinite;';
                             
                             btnHarvest.onclick = () => {
                                 exp += finalExp; 
                                 if (ownedSeeds[harvestedSeedValue] !== undefined) ownedSeeds[harvestedSeedValue] += returnAmount;
                                 else ownedSeeds[harvestedSeedValue] = returnAmount;
                                 farmSlots[slotIndex] = null; 
                                 
                                 const seedDataForHarvest = shopItems.find(i => i.value === harvestedSeedValue || (seedShopItems.find(j => j.value === harvestedSeedValue) ? i.value === harvestedSeedValue : false));
                                 const seedName = seedDataForHarvest ? seedDataForHarvest.name : slotData.name;
                                 
                                 alert(`ÄÃ£ thu hoáº¡ch ${slotData.name}! Nháº­n ${returnAmount}x ${seedName} vÃ  ${finalExp} Exp.`);
                                 closeInteractionPopup(); updateDisplay(); checkLevelUp(); updateSeedShop(); 
                             };
                         }

                         interactionControls.appendChild(btnHarvest);
                     }
                 }
            } else { 
                if (interactionTitle) interactionTitle.innerHTML = popupTitle; 
                interactionText.innerHTML = `Báº¡n Ä‘Ã£ kiá»ƒm tra Ã” ${slotNum}.<br>Chá»©c nÄƒng nÃ y sáº½ cÃ³ á»Ÿ phiÃªn báº£n tiáº¿p theo!`; 
            }
        };
        renderSlotStatus();
        interactionPopup.style.display = 'block';
    });
});

const petHouse = document.getElementById("pet-house");
if (petHouse) {
    petHouse.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c! Vui lÃ²ng nháº¥n nÃºt 'ğŸ†• Táº¡o' á»Ÿ trÃªn."); return; }
        if (petHouseTitle) petHouseTitle.innerHTML = `ğŸ¾ NhÃ  Pet`; 
        updatePetShop(); petHouseBox.style.display = 'block'; 
    });
}

const pugPet = document.getElementById("pug-pet");
if (pugPet) {
    pugPet.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c! Vui lÃ²ng nháº¥n nÃºt 'ğŸ†• Táº¡o' á»Ÿ trÃªn."); return; }
        interactionControls.innerHTML = '';
        if (!activePet) { interactionTitle.innerHTML = `ğŸ¾ Pet cá»§a báº¡n`; interactionText.innerHTML = `Báº¡n chÆ°a sá»Ÿ há»¯u Pet nÃ o!`; interactionPopup.style.display = 'block'; return; }
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet")); 
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet cá»§a báº¡n";
        if (interactionTitle) interactionTitle.innerHTML = `ğŸ¾ ${petName}`; 
        let message = `${petName} Ä‘ang náº±m sáº¥p/Ä‘á»©ng báº±ng chÃ¢n sau.<br>ÄÃ¢y lÃ  Pet hiá»‡n táº¡i cá»§a báº¡n!`;
        if (petName === "Pug PÃ©o") message = `Pug cÃ³ pháº£i lÃ  1 con Heo khÃ´ng? hay lÃ  1 con ChÃ³! Tháº­t khÃ³ nháº­n ra khi Ä‘á»©ng tá»« xa...`;
        else if (petName === "Mr. Gold") message = `Cáº­u vÃ ng cá»§a: QuÃ¡n Fá»Ÿ Anh Hight`;
        message += `<br>ğŸ‚: <b>${globalPetAge} NgÃ y tuá»•i</b>`;
        interactionText.innerHTML = message; interactionPopup.style.display = 'block';
    });
}

const boneBowl = document.getElementById("bone-bowl");
if (boneBowl) {
    boneBowl.addEventListener("click", () => {
        if (level === 0) { alert("Báº¡n cáº§n táº¡o nÃ´ng tráº¡i trÆ°á»›c! Vui lÃ²ng nháº¥n nÃºt 'ğŸ†• Táº¡o' á»Ÿ trÃªn."); return; }
        const allPets = petShopItems.concat(shopItems.filter(i => i.type === "pet"));
        const petData = allPets.find(p => p.value === activePet);
        const petName = petData ? petData.name : "Pet cá»§a báº¡n";
        interactionControls.innerHTML = ''; 
        if (interactionTitle) interactionTitle.innerHTML = `ğŸ¦´ Cho ${petName} Äƒn`; 
        if (!activePet) { interactionText.innerHTML = `Báº¡n chÆ°a sá»Ÿ há»¯u Pet nÃ o Ä‘á»ƒ cho Äƒn!`; } 
        else if(petData && (petData.name === "Rá»“ng BÄƒng Tuyáº¿t" || petData.name === "Rá»“ng BÄƒng Tuyáº¿t Big")) {
            interactionText.innerHTML = `${petName} chá»‰ Äƒn cÃ¡c loáº¡i thá»©c Äƒn Ä‘áº·c biá»‡t cá»§a rá»“ng! NÃ³ khÃ´ng Äƒn xÆ°Æ¡ng thÆ°á»ng.`;
        } else {
            const now = new Date(); const last = new Date(lastFedTime);
            const isSameDay = now.getDate() === last.getDate() && now.getMonth() === last.getMonth() && now.getFullYear() === last.getFullYear();
            if (!isSameDay) {
                interactionText.innerHTML = `Pet Ä‘ang Ä‘Ã³i bá»¥ng. Báº¡n cÃ³ muá»‘n cho Äƒn khÃ´ng?<br>(Miá»…n phÃ­ má»—i ngÃ y 1 láº§n)`;
                const btnFeed = document.createElement('button');
                btnFeed.textContent = "ğŸ¦´ Cho Äƒn ngay";
                btnFeed.style.cssText = 'padding: 8px 20px; border: none; border-radius: 5px; background: var(--accent); color: white; cursor: pointer; font-weight: bold; margin-top: 10px;';
                btnFeed.onclick = () => {
                    lastFedTime = Date.now(); globalPetAge += 1; 
                    alert(`Báº¡n Ä‘Ã£ cho ${petName} Äƒn no nÃª! Pet Ä‘Ã£ lá»›n thÃªm 1 ngÃ y tuá»•i! (Tuá»•i hiá»‡n táº¡i: ${globalPetAge})`);
                    saveGame(); interactionPopup.style.display = 'none';
                };
                interactionControls.appendChild(btnFeed);
            } else {
                if (activePopupInterval) clearInterval(activePopupInterval); activePopupInterval = null; 
                
                const getCountdownTime = () => {
                    const now = new Date(); const midnight = new Date(now); midnight.setHours(24, 0, 0, 0); 
                    const diff = midnight - now; if (diff <= 0) return "00:00:00";
                    const h = Math.floor(diff / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    return `${h < 10 ? "0" + h : h}:${m < 10 ? "0" + m : m}:${s < 10 ? "0" + s : s}`;
                };
                interactionText.innerHTML = `${petName} Ä‘Ã£ Äƒn no hÃ´m nay rá»“i! ğŸ¶<br>Reset sau: <b id="feed-timer" style="color:#d32f2f; font-family:monospace; font-size:1.2em;">${getCountdownTime()}</b>`;
                if (window.feedInterval) clearInterval(window.feedInterval);
                window.feedInterval = setInterval(() => {
                    const timerEl = document.getElementById("feed-timer");
                    const popup = document.getElementById('interaction-popup');
                    if (timerEl && popup.style.display === 'block') timerEl.textContent = getCountdownTime();
                    else clearInterval(window.feedInterval);
                }, 1000);
            }
        }
        interactionPopup.style.display = 'block';
    });
}

const brandContainer = document.querySelector(".brand");
if (brandContainer) {
    brandContainer.addEventListener("click", () => {
        if (level === 0) return;
        const maxExp = expNeeded(level);
        const percent = ((exp / maxExp) * 100).toFixed(1);
        if (interactionTitle) interactionTitle.innerHTML = `ğŸ“Š ThÃ´ng tin Cáº¥p Ä‘á»™ ${level}`;
        if (interactionText) {
            interactionText.innerHTML = `
                <div style="text-align:left; margin-top:10px; font-size:1.1em;">
                    ğŸŒ± <b>Kinh nghiá»‡m:</b> <span style="color:var(--accent);">${exp.toLocaleString('vi-VN')}</span> / ${maxExp.toLocaleString('vi-VN')}<br>
                    ğŸ“ˆ <b>Tiáº¿n Ä‘á»™:</b> ${percent}%<br>
                    <div style="width:100%; background:#eee; height:10px; border-radius:5px; margin-top:5px; overflow:hidden;">
                        <div style="width:${percent}%; background:var(--accent); height:100%;"></div>
                    </div>
                </div>
            `;
        }
        if (interactionControls) interactionControls.innerHTML = '';
        if (interactionPopup) interactionPopup.style.display = 'block';
    });
}

function adjustAppWrapperScale() {
    const appWrapper = document.querySelector(".app-wrapper");
    if (!appWrapper) return;
    const designWidth = 400; const designHeight = 750; 
    const viewportWidth = window.innerWidth; const viewportHeight = window.innerHeight;
    const scaleX = viewportWidth / designWidth; const scaleY = viewportHeight / designHeight;
    let scale = Math.min(scaleX, scaleY);
    const MAX_SCALE = 1.0; scale = Math.min(scale, MAX_SCALE);
    appWrapper.style.transform = `scale(${scale})`;
    if (viewportHeight > designHeight * scale) { 
        const scaledHeight = designHeight * scale;
        const marginTop = (viewportHeight - scaledHeight) / 2;
        appWrapper.style.marginTop = `${marginTop}px`; appWrapper.style.marginBottom = `${marginTop}px`;
    } else { appWrapper.style.marginTop = '0'; appWrapper.style.marginBottom = '0'; }
}

function initializeGame(){
    loadGame(); 
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if(isDarkMode) document.body.classList.add('dark-mode');
    updateDisplay(); updateControlButtons(); adjustAppWrapperScale(); updateShop(); initializeShopLogic();
}

setInterval(updateFarmState, 1000); 
setInterval(autoSave, 60000); 
window.onload = initializeGame;
window.addEventListener('resize', adjustAppWrapperScale);
</script>
</body>
</html>
